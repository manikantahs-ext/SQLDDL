-- DDL Export
-- Server: 10.253.50.28
-- Database: BBO_FA
-- Exported: 2026-02-04T11:47:57.710213

USE BBO_FA;
GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL1] ADD CONSTRAINT [VNO_LENGTH] CHECK (len([VNO])=(12))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL1] ADD CONSTRAINT [CK_ACC1_SELL_BUY] CHECK ([SELL_BUY]=(2) OR [SELL_BUY]=(1) OR [SELL_BUY]=(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL1] ADD CONSTRAINT [NON_NEGATIVE_AMOUNT] CHECK ([ENTRY_AMT]>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_DRAMOUNT] CHECK ([DRAMOUNT]>=(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_CRAMOUNT] CHECK ([CRAMOUNT]>=(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NONBLANK_CLTCODE] CHECK ([CLTCODE]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NONBLANK_MAINCLTCODE] CHECK ([MAINLEDGER]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NONBLANK_ACNAME] CHECK ([ACNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NOTNULL_ACNAME] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NOTNULL_MAINNAME] CHECK ([MAINLEDGERNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NOTNULL_CLTCODE] CHECK ([CLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NOTNULL_MAINCLT] CHECK ([MAINLEDGER] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [CK_ACC_TBL2_NONBLANK_MAINNAME] CHECK ([MAINLEDGERNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_CRAMOUNT] CHECK ([CRAMOUNT]>=(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_DRAMOUNT] CHECK ([DRAMOUNT]>=(0))

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NONBLANK_ACNAME] CHECK ([ACNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NONBLANK_CLTCODE] CHECK ([CLTCODE]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NONBLANK_MAINCLT] CHECK ([MAINLEDGER]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NONBLANK_MAINNAME] CHECK ([MAINLEDGERNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NOTNULL_ACNAME] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NOTNULL_CLTCODE] CHECK ([CLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NOTNULL_MAINNAME] CHECK ([MAINLEDGERNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [CK_ACC_TBL3_NOTNULL_MAINCLT] CHECK ([MAINLEDGER] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.ACC_TBL4
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL4] ADD CONSTRAINT [CK_ACC_TBL4_NOTNULL_INSTNO] CHECK ([INSTNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NOTNULL_GRPCODE] CHECK ([GRPCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NONBLANK_BRANCH] CHECK ([BRANCHCODE]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NOTNULL_BRANCH] CHECK ([BRANCHCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NONBLANK_GRPCODE] CHECK ([GRPCODE]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NONBLANK_ACNAME] CHECK ([ACNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NOTNULL_ACNAME] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NONBLANK_LONGNAME] CHECK ([LONGNAME]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NOTNULL_LONGNAME] CHECK ([LONGNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CK_ACMAST_NOTNULL_ACTYPE] CHECK ([ACTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL1] ADD CONSTRAINT [FK_ACC_TBL1_BOOKTYPE] FOREIGN KEY ([VTYPE], [BOOKTYPE]) REFERENCES [dbo].[BOOKTYPE] ([Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [FK_ACC_TBL2_ACCAT] FOREIGN KEY ([ACCAT]) REFERENCES [dbo].[CATMAST] ([Accat])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [FK_ACC_TBL2_MAINACCAT] FOREIGN KEY ([MAINACCAT]) REFERENCES [dbo].[CATMAST] ([Accat])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [FK_LEDGERTRANS_GL_LEDGERMASTER] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [FK_ACC_TBL3_ACCAT] FOREIGN KEY ([ACCAT]) REFERENCES [dbo].[CATMAST] ([Accat])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [FK_ACC_TBL3_MAINACCAT] FOREIGN KEY ([MAINACCAT]) REFERENCES [dbo].[CATMAST] ([Accat])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [FK_LEDGERTRANS_PARTY_LEDGERMASTER] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL4
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL4] ADD CONSTRAINT [FK_LEDGERCHEQUES_LEDGERMASTER] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ACC_TBL5
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL5] ADD CONSTRAINT [FK_COSTBREAKUP_LEDGERMASTER] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ARC_ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ARC_ACC_TBL2] ADD CONSTRAINT [FK_LEDGERTRANS_GL_LEDGERMASTER_ARC] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ARC_ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ARC_ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ARC_ACC_TBL3] ADD CONSTRAINT [FK_LEDGERTRANS_PARTY_LEDGERMASTER_ARC] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ARC_ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ARC_ACC_TBL4
-- --------------------------------------------------
ALTER TABLE [dbo].[ARC_ACC_TBL4] ADD CONSTRAINT [FK_LEDGERCHEQUES_LEDGERMASTER_ARC] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ARC_ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.ARC_ACC_TBL5
-- --------------------------------------------------
ALTER TABLE [dbo].[ARC_ACC_TBL5] ADD CONSTRAINT [FK_COSTBREAKUP_LEDGERMASTER_ARC] FOREIGN KEY ([MASTERSNO]) REFERENCES [dbo].[ARC_ACC_TBL1] ([SNO])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.BOOKTYPE
-- --------------------------------------------------
ALTER TABLE [dbo].[BOOKTYPE] ADD CONSTRAINT [FK_BOOKTYPE_VTYPE] FOREIGN KEY ([Vtyp]) REFERENCES [dbo].[Vmast] ([Vtype])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.USERRIGHTS
-- --------------------------------------------------
ALTER TABLE [dbo].[USERRIGHTS] ADD CONSTRAINT [FK_USERRIGHTS_BOOKTYPE] FOREIGN KEY ([VTYPE], [BOOKTYPE]) REFERENCES [dbo].[BOOKTYPE] ([Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- FUNCTION dbo.BBO_SETT_BALANCE_CLIENTS
-- --------------------------------------------------


CREATE FUNCTION [dbo].[BBO_SETT_BALANCE_CLIENTS]
(
	@VDT			VARCHAR(11),
	@FCLTCODE		VARCHAR(10),
	@TCLTCODE		VARCHAR(10),
	@BALTYPE		VARCHAR(1),
	@BALON			VARCHAR(1),
	@WITHZERO		VARCHAR(1),
	@CLTYPE			VARCHAR(5),
	@STATUSID		VARCHAR(25),
	@STATUSNAME		VARCHAR(25),
	@SEG_EXCH		VARCHAR(MAX)
	
)
RETURNS @BALANCE TABLE
(
	CLTCODE			VARCHAR(10),
	ACNAME			VARCHAR(100),
	AREA			VARCHAR(20),
	REGION			VARCHAR(20),
	BRANCH			VARCHAR(10),
	SUB_BROKER		VARCHAR(10),
	TRADER			VARCHAR(20),
	FAMILY			VARCHAR(10),
	CL_TYPE			VARCHAR(3),
	BALANCE			NUMERIC(18, 2),
	BALTYPE			VARCHAR(1),
	BALANSON_V		VARCHAR(11),
	BALANSON_D		AS (CONVERT(DATETIME, BALANSON_V, 109)),
	BALANCESIDE		AS (CASE WHEN BALANCE <= 0 THEN 'D' ELSE 'C' END),
	UNREALISED		NUMERIC(18, 2),
	EXCHANGE		VARCHAR(10),
	SEGMENT			VARCHAR(10)
	PRIMARY KEY CLUSTERED (CLTCODE, EXCHANGE, SEGMENT)
)
AS
/*
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('MAR 31 2010', '0', 'ZZ', 'O', 'V', 'Y', '', 'BROKER', 'BROKER', 'NSE-MFSS|BSE-CAPITAL','')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'O', 'E', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'V', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'E', 'Y', '', 'BROKER', 'BROKER')
*/
BEGIN
	DECLARE
		@SDTCUR VARCHAR(11),
		@LDTCUR VARCHAR(11)/*,*/
	IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0
		BEGIN
			SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)
		END
	SELECT
		@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),
		@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@VDT BETWEEN SDTCUR AND LDTCUR
	--	DATEADD(DAY,(CASE WHEN (YEAR(@VDT)%4)= '0' THEN -366 ELSE -365 END)* @YEARS,@VDT) BETWEEN SDTCUR AND LDTCUR

	IF @@ROWCOUNT <= 0
		BEGIN
			RETURN
		END
	IF @BALTYPE = 'O'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE  EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C2.PARTY_CODE
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C2
											WHERE
												C2.PARTY_CODE = L.CLTCODE
												AND C2.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C2.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C2.AREA
														WHEN 'REGION' THEN C2.REGION
														WHEN 'BRANCH' THEN C2.BRANCH_CD
														WHEN 'SUBBROKER' THEN C2.SUB_BROKER
														WHEN 'TRADER' THEN C2.TRADER
														WHEN 'FAMILY' THEN C2.FAMILY
														WHEN 'CLIENT' THEN C2.PARTY_CODE
													ELSE 'BROKER' END
											)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE
								AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18*/
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT >= @SDTCUR
								AND L.VDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE
								AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END*/

							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.EDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							/*FOR ACROSS FINANCIAL YEAR*/
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	ELSE IF @BALTYPE = 'C'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT
						PARTY_CODE = L.CLTCODE,
						BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0),
						BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						ACC_LEDGER_PL L
					WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
						AND VDT >= @SDTCUR
						AND VDT <= @VDT + ' 23:59'
						AND L.CLTCODE >= @FCLTCODE
						AND L.CLTCODE <= @TCLTCODE
						AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
						AND EXISTS (SELECT C1.PARTY_CODE 
									FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
									WHERE
										C1.PARTY_CODE = L.CLTCODE
										AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
										AND @STATUSNAME =
											CASE @STATUSID
												WHEN 'AREA' THEN C1.AREA
												WHEN 'REGION' THEN C1.REGION
												WHEN 'BRANCH' THEN C1.BRANCH_CD
												WHEN 'SUBBROKER' THEN C1.SUB_BROKER
												WHEN 'TRADER' THEN C1.TRADER
												WHEN 'FAMILY' THEN C1.FAMILY
												WHEN 'CLIENT' THEN C1.PARTY_CODE
											ELSE 'BROKER' END )
						--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
						--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
					GROUP BY
						L.CLTCODE, EXCHANGE, SEGMENT
					ORDER BY
						L.CLTCODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND EDT < @VDT + ' 23:59'
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
								FROM MSAJAG..CLIENT_DETAILS_VIEW C1
								WHERE
									C1.PARTY_CODE = L.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'BRANCH' THEN C1.BRANCH_CD
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY
											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	--SELECT *, BALTYPE = @BALTYPE, BALANSON_V = @VDT, BALANSON_D = CONVERT(DATETIME, @VDT, 109), BALANCESIDE = CASE WHEN BALANCE >= 0 THEN 'C' ELSE 'D' END FROM #BALANCE
	--DROP TABLE #BALANCE
	INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
	SELECT
		C1.PARTY_CODE,
		BALANCE = 0,
		BALTYPE = @BALTYPE,
		BALANSON_V = @VDT,
		UNREALISED = 0,
		EXCHANGE,
		SEGMENT
	FROM
		(SELECT 
			DISTINCT PARTY_CODE FROM MSAJAG..CLIENT_DETAILS_VIEW 
		WHERE 
			PARTY_CODE >= @FCLTCODE
			AND PARTY_CODE <= @TCLTCODE
			AND CL_TYPE = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
			AND @STATUSNAME =
			CASE @STATUSID
				WHEN 'AREA' THEN AREA
				WHEN 'REGION' THEN REGION
				WHEN 'BRANCH' THEN BRANCH_CD
				WHEN 'SUBBROKER' THEN SUB_BROKER
				WHEN 'TRADER' THEN TRADER
				WHEN 'FAMILY' THEN FAMILY
				WHEN 'CLIENT' THEN PARTY_CODE
			ELSE 'BROKER' END
			) C1, 
		(SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH)) A
	WHERE
	
		 NOT EXISTS (SELECT CLTCODE FROM @BALANCE I WHERE C1.PARTY_CODE = I.CLTCODE AND A.EXCHANGE = I.EXCHANGE AND A.SEGMENT = I.SEGMENT)
		

IF @WITHZERO <> 'Y'
		BEGIN
			DELETE B FROM @BALANCE B WHERE EXISTS(SELECT CLTCODE FROM @BALANCE B1 WHERE B.CLTCODE = B1.CLTCODE 
			GROUP BY B1.CLTCODE HAVING SUM(BALANCE) = 0)  
		END
		

		UPDATE B
		SET UNREALISED = L.BALANCE
		FROM @BALANCE B,
			(
				SELECT
					E.CLTCODE,
					BALANCE = ISNULL(SUM(E.DRAMOUNT - E.CRAMOUNT), 0), EXCHANGE, SEGMENT
				FROM
					ACC_LEDGER_PL E
				WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=E.EXCHANGE AND A.SEGMENT=E.SEGMENT)
					AND E.VDT >= @SDTCUR
					AND E.VDT <= @VDT + ' 23:59'
					AND E.EDT > @VDT + ' 23:59'
					AND E.CLTCODE >= @FCLTCODE
					AND E.CLTCODE <= @TCLTCODE
					AND EXISTS (
					SELECT C1.PARTY_CODE FROM
							MSAJAG..CLIENT_DETAILS_VIEW  C1
						WHERE
									C1.PARTY_CODE = E.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'BRANCH' THEN C1.BRANCH_CD
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY
											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END 
								)
					GROUP BY
						E.CLTCODE, EXCHANGE, SEGMENT
			) L
			WHERE
			B.CLTCODE = L.CLTCODE
			AND B.EXCHANGE = L.EXCHANGE
			AND B.SEGMENT = L.SEGMENT

	UPDATE B
	SET
		ACNAME = UPPER(C.LONG_NAME),
		AREA = UPPER(C.AREA),
		REGION = UPPER(C.REGION),
		BRANCH = UPPER(C.BRANCH_CD),
		SUB_BROKER = UPPER(C.SUB_BROKER),
		TRADER = UPPER(C.TRADER),
		FAMILY = UPPER(C.FAMILY),
		CL_TYPE = UPPER(C.CL_TYPE)
	FROM
		@BALANCE B,
		MSAJAG..CLIENT_DETAILS_VIEW C
	WHERE
		B.CLTCODE = C.PARTY_CODE
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.BBO_SETT_BALANCE_CLIENTS_AUTOJV
-- --------------------------------------------------
CREATE FUNCTION [dbo].[BBO_SETT_BALANCE_CLIENTS_AUTOJV]

(

	@VDT			VARCHAR(11),
	@FCLTCODE		VARCHAR(10),
@TCLTCODE		VARCHAR(10),
	@BALTYPE		VARCHAR(1),
	@BALON			VARCHAR(1),
	@WITHZERO		VARCHAR(1),
	@CLTYPE			VARCHAR(5),
	@STATUSID		VARCHAR(25),
	@STATUSNAME		VARCHAR(25),
	@SEG_EXCH		VARCHAR(MAX)
)

RETURNS @BALANCE TABLE

(

	CLTCODE			VARCHAR(10),
    ACNAME			VARCHAR(100),
	AREA			VARCHAR(20),
	REGION			VARCHAR(20),
	BRANCH			VARCHAR(10),
	SUB_BROKER		VARCHAR(10),
	TRADER			VARCHAR(20),
	FAMILY			VARCHAR(10),
	CL_TYPE			VARCHAR(3),
	BALANCE			NUMERIC(18, 2),
	BALTYPE			VARCHAR(1),
	BALANSON_V		VARCHAR(11),
	BALANSON_D		AS (CONVERT(DATETIME, BALANSON_V, 109)),
    BALANCESIDE		AS (CASE WHEN BALANCE <= 0 THEN 'D' ELSE 'C' END),
	UNREALISED		NUMERIC(18, 2),
	EXCHANGE		VARCHAR(10),
	SEGMENT			VARCHAR(10)
	PRIMARY KEY CLUSTERED (CLTCODE, EXCHANGE, SEGMENT)
)

AS

/*

	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('MAR 31 2010', '0', 'ZZ', 'O', 'V', 'Y', '', 'BROKER', 'BROKER', 'NSE-MFSS|BSE-CAPITAL')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'O', 'E', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'V', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'E', 'Y', '', 'BROKER', 'BROKER')
*/
BEGIN

	DECLARE
		@SDTCUR VARCHAR(11),
		@LDTCUR VARCHAR(11)/*,*/
	IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0
		BEGIN
			SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)
		END
	SELECT
		@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),
		@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@ROWCOUNT <= 0
		BEGIN
			RETURN
		END
	IF @BALTYPE = 'O'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE  EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C2.PARTY_CODE
											FROM anand1.MSAJAG.CLIENT_DETAILS  C2
											WHERE
												C2.PARTY_CODE = L.CLTCODE
												AND C2.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C2.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C2.AREA
														WHEN 'REGION' THEN C2.REGION
														WHEN 'SUBBROKER' THEN C2.SUB_BROKER
														WHEN 'TRADER' THEN C2.TRADER
														WHEN 'FAMILY' THEN C2.FAMILY
														WHEN 'CLIENT' THEN C2.PARTY_CODE
													ELSE 'BROKER' END
											)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE
								AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18*/
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,

							BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT >= @SDTCUR
								AND L.VDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE
											FROM anand1.MSAJAG.dbo.CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =

												CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END

							--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE

							AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END*/

							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(

						SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM anand1.MSAJAG.dbo.CLIENT_DETAILS  C1
											WHERE C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER

													WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.EDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24, 15)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM anand1.MSAJAG.dbo.CLIENT_DETAILS  C1

										WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY

							L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.EDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE = 15 AND L.CRAMOUNT <> 0
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM anand1.MSAJAG.dbo.CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID

													WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT >= @SDTCUR

							AND L.VDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE = 15 AND L.DRAMOUNT <> 0
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM anand1.MSAJAG.dbo.CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							/*FOR ACROSS FINANCIAL YEAR*/
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	ELSE IF @BALTYPE = 'C'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT
						PARTY_CODE = L.CLTCODE,
						BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0),
						BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						ACC_LEDGER_PL L
					WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
						AND VDT >= @SDTCUR
						AND VDT <= @VDT + ' 23:59'
						AND L.CLTCODE >= @FCLTCODE
						AND L.CLTCODE <= @TCLTCODE
						AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
						AND EXISTS (SELECT C1.PARTY_CODE 
									FROM MSAJAG..CLIENT_DETAILS  C1
									WHERE
										C1.PARTY_CODE = L.CLTCODE
										AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
										AND @STATUSNAME =
											CASE @STATUSID
												WHEN 'AREA' THEN C1.AREA

												WHEN 'REGION' THEN C1.REGION
												WHEN 'SUBBROKER' THEN C1.SUB_BROKER
												WHEN 'TRADER' THEN C1.TRADER
												WHEN 'FAMILY' THEN C1.FAMILY
												WHEN 'CLIENT' THEN C1.PARTY_CODE
											ELSE 'BROKER' END )
						--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
						--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
					GROUP BY

					L.CLTCODE, EXCHANGE, SEGMENT
					ORDER BY
						L.CLTCODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(

						SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND EDT < @VDT + ' 23:59'
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24, 15)

							AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
						SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND VDT >= @SDTCUR
								AND VDT < @VDT + ' 23:59'
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE = 15 AND L.DRAMOUNT <> 0
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
						SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND EDT < @VDT + ' 23:59'
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE = 15 AND L.CRAMOUNT <> 0
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)

							AND EDT >= @SDTCUR
								AND VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
								FROM MSAJAG..CLIENT_DETAILS C1
								WHERE
									C1.PARTY_CODE = L.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY

											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	--SELECT *, BALTYPE = @BALTYPE, BALANSON_V = @VDT, BALANSON_D = CONVERT(DATETIME, @VDT, 109), BALANCESIDE = CASE WHEN BALANCE >= 0 THEN 'C' ELSE 'D' END FROM #BALANCE
	--DROP TABLE #BALANCE
	INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
	SELECT
		C1.PARTY_CODE,
		BALANCE = 0,
		BALTYPE = @BALTYPE,
		BALANSON_V = @VDT,
		UNREALISED = 0,
		EXCHANGE,
		SEGMENT
	FROM
		(SELECT 
			DISTINCT PARTY_CODE FROM MSAJAG..CLIENT_DETAILS 
		WHERE 
			PARTY_CODE >= @FCLTCODE
			AND PARTY_CODE <= @TCLTCODE
			AND CL_TYPE = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
			AND @STATUSNAME =
			CASE @STATUSID
				WHEN 'AREA' THEN AREA
				WHEN 'REGION' THEN REGION
				WHEN 'SUBBROKER' THEN SUB_BROKER
				WHEN 'TRADER' THEN TRADER
				WHEN 'FAMILY' THEN FAMILY
				WHEN 'CLIENT' THEN PARTY_CODE
			ELSE 'BROKER' END
			) C1, 
		(SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH)) A
	WHERE
	
		 NOT EXISTS (SELECT CLTCODE FROM @BALANCE I WHERE C1.PARTY_CODE = I.CLTCODE AND A.EXCHANGE = I.EXCHANGE AND A.SEGMENT = I.SEGMENT)
		

IF @WITHZERO <> 'Y'
		BEGIN
			DELETE B FROM @BALANCE B WHERE EXISTS(SELECT CLTCODE FROM @BALANCE B1 WHERE B.CLTCODE = B1.CLTCODE 

		GROUP BY B1.CLTCODE HAVING SUM(BALANCE) = 0)  
		END
		

		UPDATE B
		SET UNREALISED = L.BALANCE
		FROM @BALANCE B,
			(
				SELECT
					E.CLTCODE,
					BALANCE = ISNULL(SUM(E.DRAMOUNT - E.CRAMOUNT), 0), EXCHANGE, SEGMENT
				FROM
					ACC_LEDGER_PL E
				WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=E.EXCHANGE AND A.SEGMENT=E.SEGMENT)
					AND E.VDT >= @SDTCUR
					AND E.VDT <= @VDT + ' 23:59'
					AND E.EDT > @VDT + ' 23:59'
					AND E.CLTCODE >= @FCLTCODE
					AND E.CLTCODE <= @TCLTCODE
					AND EXISTS (
					SELECT C1.PARTY_CODE FROM
							MSAJAG..CLIENT_DETAILS  C1
						WHERE
									C1.PARTY_CODE = E.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY
											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END 
								)
					GROUP BY
						E.CLTCODE, EXCHANGE, SEGMENT
			) L
			WHERE
			B.CLTCODE = L.CLTCODE
			AND B.EXCHANGE = L.EXCHANGE
			AND B.SEGMENT = L.SEGMENT

	UPDATE B
	SET
		ACNAME = UPPER(C.LONG_NAME),
		AREA = UPPER(C.AREA),
		REGION = UPPER(C.REGION),
		BRANCH = UPPER(C.BRANCH_CD),
		SUB_BROKER = UPPER(C.SUB_BROKER),
		TRADER = UPPER(C.TRADER),
		FAMILY = UPPER(C.FAMILY),
	CL_TYPE = UPPER(C.CL_TYPE)
	FROM
		@BALANCE B,
		MSAJAG..CLIENT_DETAILS C
	WHERE
		B.CLTCODE = C.PARTY_CODE
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.BBO_SETT_BALANCE_CLIENTS_MFSS
-- --------------------------------------------------



CREATE FUNCTION [dbo].[BBO_SETT_BALANCE_CLIENTS_MFSS]
(
	@VDT			VARCHAR(11),
	@FCLTCODE		VARCHAR(10),
	@TCLTCODE		VARCHAR(10),
	@BALTYPE		VARCHAR(1),
	@BALON			VARCHAR(1),
	@WITHZERO		VARCHAR(1),
	@CLTYPE			VARCHAR(5),
	@STATUSID		VARCHAR(25),
	@STATUSNAME		VARCHAR(25),
	@SEG_EXCH		VARCHAR(MAX)
	
)
RETURNS @BALANCE TABLE
(
	CLTCODE			VARCHAR(10),
	ACNAME			VARCHAR(100),
	AREA			VARCHAR(20),
	REGION			VARCHAR(20),
	BRANCH			VARCHAR(10),
	SUB_BROKER		VARCHAR(10),
	TRADER			VARCHAR(20),
	FAMILY			VARCHAR(10),
	CL_TYPE			VARCHAR(3),
	BALANCE			NUMERIC(18, 2),
	BALTYPE			VARCHAR(1),
	BALANSON_V		VARCHAR(11),
	BALANSON_D		AS (CONVERT(DATETIME, BALANSON_V, 109)),
	BALANCESIDE		AS (CASE WHEN BALANCE <= 0 THEN 'D' ELSE 'C' END),
	UNREALISED		NUMERIC(18, 2),
	EXCHANGE		VARCHAR(10),
	SEGMENT			VARCHAR(10)
	PRIMARY KEY CLUSTERED (CLTCODE, EXCHANGE, SEGMENT)
)
AS
/*
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('MAR 31 2010', '0', 'ZZ', 'O', 'V', 'Y', '', 'BROKER', 'BROKER', 'NSE-MFSS|BSE-CAPITAL','')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'O', 'E', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'V', 'Y', '', 'BROKER', 'BROKER')
	SELECT * FROM .dbo.BBO_SETT_BALANCE_CLIENTS('JUL 25 2009', '0', 'ZZZZ', 'C', 'E', 'Y', '', 'BROKER', 'BROKER')
*/
BEGIN
	DECLARE
		@SDTCUR VARCHAR(11),
		@LDTCUR VARCHAR(11)/*,*/
	IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0
		BEGIN
			SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)
		END
	SELECT
		@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),
		@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@VDT BETWEEN SDTCUR AND LDTCUR
	--	DATEADD(DAY,(CASE WHEN (YEAR(@VDT)%4)= '0' THEN -366 ELSE -365 END)* @YEARS,@VDT) BETWEEN SDTCUR AND LDTCUR

	IF @@ROWCOUNT <= 0
		BEGIN
			RETURN
		END
	IF @BALTYPE = 'O'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE  EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C2.PARTY_CODE
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C2
											WHERE
												C2.PARTY_CODE = L.CLTCODE
												AND C2.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C2.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C2.AREA
														WHEN 'REGION' THEN C2.REGION
														WHEN 'BRANCH' THEN C2.BRANCH_CD
														WHEN 'SUBBROKER' THEN C2.SUB_BROKER
														WHEN 'TRADER' THEN C2.TRADER
														WHEN 'FAMILY' THEN C2.FAMILY
														WHEN 'CLIENT' THEN C2.PARTY_CODE
													ELSE 'BROKER' END
											)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE
								AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END
								AND L.VDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18*/
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.VDT >= @SDTCUR
								AND L.VDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END

/*								C1.CL_CODE = C2.CL_CODE
								AND C2.PARTY_CODE = L.CLTCODE
								AND C2.PARTY_CODE >= @FCLTCODE
								AND C2.PARTY_CODE <= @TCLTCODE
								AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
								AND @STATUSNAME =
									CASE @STATUSID
										WHEN 'AREA' THEN C1.AREA
										WHEN 'REGION' THEN C1.REGION
										WHEN 'SUBBROKER' THEN C1.SUB_BROKER
										WHEN 'TRADER' THEN C1.TRADER
										WHEN 'FAMILY' THEN C1.FAMILY
										WHEN 'CLIENT' THEN C2.PARTY_CODE
									ELSE 'BROKER' END*/

							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT LIKE @SDTCUR + '%'
								AND L.VTYPE = 18
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.EDT < @VDT
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							/*FOR ACROSS FINANCIAL YEAR*/
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND L.EDT >= @SDTCUR
								AND L.VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE <> 18
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END)
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	ELSE IF @BALTYPE = 'C'
		BEGIN
			IF @BALON = 'V'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT
						PARTY_CODE = L.CLTCODE,
						BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0),
						BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						ACC_LEDGER_PL L
					WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
						AND VDT >= @SDTCUR
						AND VDT <= @VDT + ' 23:59'
						AND L.CLTCODE >= @FCLTCODE
						AND L.CLTCODE <= @TCLTCODE
						AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
						AND EXISTS (SELECT C1.PARTY_CODE 
									FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
									WHERE
										C1.PARTY_CODE = L.CLTCODE
										AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
										AND @STATUSNAME =
											CASE @STATUSID
												WHEN 'AREA' THEN C1.AREA
												WHEN 'REGION' THEN C1.REGION
												WHEN 'BRANCH' THEN C1.BRANCH_CD
												WHEN 'SUBBROKER' THEN C1.SUB_BROKER
												WHEN 'TRADER' THEN C1.TRADER
												WHEN 'FAMILY' THEN C1.FAMILY
												WHEN 'CLIENT' THEN C1.PARTY_CODE
											ELSE 'BROKER' END )
						--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
						--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
					GROUP BY
						L.CLTCODE, EXCHANGE, SEGMENT
					ORDER BY
						L.CLTCODE
				END
			ELSE IF @BALON = 'E'
				BEGIN
					INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
					SELECT PARTY_CODE, BALANCE = SUM(BALANCE), BALTYPE = @BALTYPE, BALANSON_V = @VDT, UNREALISED = 0, EXCHANGE, SEGMENT
					FROM
						(
							SELECT
								PARTY_CODE = L.CLTCODE,
								BALANCE = ISNULL(SUM(L.CRAMOUNT - L.DRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND EDT < @VDT + ' 23:59'
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
											FROM MSAJAG..CLIENT_DETAILS_VIEW  C1
											WHERE
												C1.PARTY_CODE = L.CLTCODE
												AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
												AND @STATUSNAME =
													CASE @STATUSID
														WHEN 'AREA' THEN C1.AREA
														WHEN 'REGION' THEN C1.REGION
														WHEN 'BRANCH' THEN C1.BRANCH_CD
														WHEN 'SUBBROKER' THEN C1.SUB_BROKER
														WHEN 'TRADER' THEN C1.TRADER
														WHEN 'FAMILY' THEN C1.FAMILY
														WHEN 'CLIENT' THEN C1.PARTY_CODE
													ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						UNION ALL
							SELECT
								L.CLTCODE,
								BALANCE = ISNULL(SUM(L.DRAMOUNT - L.CRAMOUNT), 0), EXCHANGE, SEGMENT
							FROM
								ACC_LEDGER_PL L
							WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
								AND EDT >= @SDTCUR
								AND VDT < @SDTCUR
								AND L.CLTCODE >= @FCLTCODE
								AND L.CLTCODE <= @TCLTCODE
								AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
								AND EXISTS (SELECT C1.PARTY_CODE 
								FROM MSAJAG..CLIENT_DETAILS_VIEW C1
								WHERE
									C1.PARTY_CODE = L.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'BRANCH' THEN C1.BRANCH_CD
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY
											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END )
								--AND L.EXCHANGE = CASE WHEN @EXCHANGE = '' THEN L.EXCHANGE ELSE @EXCHANGE END
								--AND L.SEGMENT = CASE WHEN @SEGMENT = '' THEN L.SEGMENT ELSE @SEGMENT END
							GROUP BY
								L.CLTCODE, EXCHANGE, SEGMENT
						) BALANCES
					GROUP BY
						PARTY_CODE, EXCHANGE, SEGMENT
					ORDER BY
						PARTY_CODE
				END
		END
	--SELECT *, BALTYPE = @BALTYPE, BALANSON_V = @VDT, BALANSON_D = CONVERT(DATETIME, @VDT, 109), BALANCESIDE = CASE WHEN BALANCE >= 0 THEN 'C' ELSE 'D' END FROM #BALANCE
	--DROP TABLE #BALANCE
	INSERT INTO @BALANCE (CLTCODE, BALANCE, BALTYPE, BALANSON_V, UNREALISED, EXCHANGE, SEGMENT)
	SELECT
		C1.PARTY_CODE,
		BALANCE = 0,
		BALTYPE = @BALTYPE,
		BALANSON_V = @VDT,
		UNREALISED = 0,
		EXCHANGE,
		SEGMENT
	FROM
		(SELECT 
			DISTINCT PARTY_CODE FROM MSAJAG..CLIENT_DETAILS_VIEW 
		WHERE 
			PARTY_CODE >= @FCLTCODE
			AND PARTY_CODE <= @TCLTCODE
			AND CL_TYPE = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
			AND @STATUSNAME =
			CASE @STATUSID
				WHEN 'AREA' THEN AREA
				WHEN 'REGION' THEN REGION
				WHEN 'BRANCH' THEN BRANCH_CD
				WHEN 'SUBBROKER' THEN SUB_BROKER
				WHEN 'TRADER' THEN TRADER
				WHEN 'FAMILY' THEN FAMILY
				WHEN 'CLIENT' THEN PARTY_CODE
			ELSE 'BROKER' END
			) C1, 
		(SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH)) A
	WHERE
	
		 NOT EXISTS (SELECT CLTCODE FROM @BALANCE I WHERE C1.PARTY_CODE = I.CLTCODE AND A.EXCHANGE = I.EXCHANGE AND A.SEGMENT = I.SEGMENT)
		

IF @WITHZERO <> 'Y'
		BEGIN
			DELETE B FROM @BALANCE B WHERE EXISTS(SELECT CLTCODE FROM @BALANCE B1 WHERE B.CLTCODE = B1.CLTCODE 
			GROUP BY B1.CLTCODE HAVING SUM(BALANCE) = 0)  
		END
		

		UPDATE B
		SET UNREALISED = L.BALANCE
		FROM @BALANCE B,
			(
				SELECT
					E.CLTCODE,
					BALANCE = ISNULL(SUM(E.DRAMOUNT - E.CRAMOUNT), 0), EXCHANGE, SEGMENT
				FROM
					ACC_LEDGER_PL E
				WHERE EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=E.EXCHANGE AND A.SEGMENT=E.SEGMENT)
					AND E.VDT >= @SDTCUR
					AND E.VDT <= @VDT + ' 23:59'
					AND E.EDT > @VDT + ' 23:59'
					AND E.CLTCODE >= @FCLTCODE
					AND E.CLTCODE <= @TCLTCODE
					AND EXISTS (
					SELECT C1.PARTY_CODE FROM
							MSAJAG..CLIENT_DETAILS_VIEW  C1
						WHERE
									C1.PARTY_CODE = E.CLTCODE
									AND C1.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C1.CL_TYPE ELSE @CLTYPE END
									AND @STATUSNAME =
										CASE @STATUSID
											WHEN 'AREA' THEN C1.AREA
											WHEN 'REGION' THEN C1.REGION
											WHEN 'BRANCH' THEN C1.BRANCH_CD
											WHEN 'SUBBROKER' THEN C1.SUB_BROKER
											WHEN 'TRADER' THEN C1.TRADER
											WHEN 'FAMILY' THEN C1.FAMILY
											WHEN 'CLIENT' THEN C1.PARTY_CODE
										ELSE 'BROKER' END 
								)
					GROUP BY
						E.CLTCODE, EXCHANGE, SEGMENT
			) L
			WHERE
			B.CLTCODE = L.CLTCODE
			AND B.EXCHANGE = L.EXCHANGE
			AND B.SEGMENT = L.SEGMENT

	UPDATE B
	SET
		ACNAME = UPPER(C.LONG_NAME),
		AREA = UPPER(C.AREA),
		REGION = UPPER(C.REGION),
		BRANCH = UPPER(C.BRANCH_CD),
		SUB_BROKER = UPPER(C.SUB_BROKER),
		TRADER = UPPER(C.TRADER),
		FAMILY = UPPER(C.FAMILY),
		CL_TYPE = UPPER(C.CL_TYPE)
	FROM
		@BALANCE B,
		MSAJAG..CLIENT_DETAILS_VIEW C
	WHERE
		B.CLTCODE = C.PARTY_CODE
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.BBO_TRANSACTIONS_CLIENTS
-- --------------------------------------------------


CREATE FUNCTION [dbo].[BBO_TRANSACTIONS_CLIENTS]
(
	@FDATE				VARCHAR(11),
	@TDATE				VARCHAR(11),
	@FCLTCODE			VARCHAR(10),
	@TCLTCODE			VARCHAR(10),
	@TRANON				VARCHAR(1),
	@CLTYPE				VARCHAR(3),
	@MASTERSNO			BIGINT,
	@SETT_NO			VARCHAR(7),
	@SETT_TYPE			VARCHAR(3),
	@VTYPE				SMALLINT,
	@BOOKTYPE			VARCHAR(2),
	@STATUSID			VARCHAR(25),
	@STATUSNAME			VARCHAR(25),
	@SEG_EXCH			VARCHAR(MAX),
	@FLAG				VARCHAR(1) = 'S' ------------S FOR SETTLEMENT AND M FOR MARGIN
)
RETURNS @TRANSACTIONS TABLE
(
	EXCHANGE			VARCHAR(10),
	SEGMENT				VARCHAR(10),
	VNO					VARCHAR(12),
	VTYPE				SMALLINT,
	BOOKTYPE			VARCHAR(2),
	VDT					DATETIME,
	EDT					DATETIME,
	MASTERSNO			BIGINT,
	SETT_NO				VARCHAR(7),
	SETT_TYPE			VARCHAR(3),
	DRAMOUNT			NUMERIC(18, 2),
	CRAMOUNT			NUMERIC(18, 2),
	CLTCODE				VARCHAR(10),
	ACNAME				VARCHAR(100),
	ACCAT				VARCHAR(10),
	MARGINLEDGERCODE	VARCHAR(10),
	MARGINLEDGERNAME	VARCHAR(100),
	NARRATION			VARCHAR(234),
	BRANCHCODE			VARCHAR(10),
	OPPACCOUNT			VARCHAR(10),
	BNKNAME				VARCHAR(35),
	BRNNAME				VARCHAR(20),
	CHQDD				VARCHAR(1),
	INSTNO				VARCHAR(15),
	INSTDATE			DATETIME,
	RELDT				DATETIME,
	REFNO				VARCHAR(12),
	MICR				BIGINT,
	CHQINNAME			VARCHAR(100),
	CHQPRINTED			INT,
	CLEARMODE			VARCHAR(1),
	VDESC				VARCHAR(35),
	SHORTDESC			VARCHAR(6),
	--NODAYS				VARCHAR(20),
	POSTED_ON			VARCHAR(50)
)

AS


/*
SELECT * FROM BBO_TRANSACTIONS_CLIENTS ('APR  1 2008','MAR 31 2010','0','ZZ','V','','','','','','','BROKER','BROKER','NSE-MFSS|BSE-MFSS','s')
*/


BEGIN
	IF @FDATE = ''
		BEGIN
			SET @FDATE = CONVERT(VARCHAR(11), GETDATE(), 109)
		END
	IF @TDATE = ''
		BEGIN
			SET @TDATE = CONVERT(VARCHAR(11), GETDATE(), 109)
		END
	IF @FCLTCODE = ''
		BEGIN
			SET @FCLTCODE = '0'
		END
	IF @TCLTCODE = ''
		BEGIN
			SET @TCLTCODE = 'ZZZZZZZZZZ'
		END

	DECLARE
		@SDTCUR VARCHAR(11),
		@LDTCUR VARCHAR(11)
		
	IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
		BEGIN
			SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
		END
	IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
		BEGIN
			SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
		END
	SELECT
		@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),
		@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)
	FROM
		PARAMETER
	WHERE
		@FDATE BETWEEN SDTCUR AND LDTCUR
	IF @@ROWCOUNT <= 0
		BEGIN
			RETURN
		END
	/*IF CONVERT(DATETIME, @TDATE, 109) > CONVERT(DATETIME, @LDTCUR, 109)
		BEGIN
			SET @TDATE = @LDTCUR
		END*/
		
		
		IF @FLAG = 'S'
		BEGIN
	INSERT INTO @TRANSACTIONS (	EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, EDT, MASTERSNO, SETT_NO,
								SETT_TYPE, DRAMOUNT, CRAMOUNT, CLTCODE, ACNAME, ACCAT, MARGINLEDGERCODE,
								MARGINLEDGERNAME, NARRATION, BRANCHCODE, OPPACCOUNT, BNKNAME, BRNNAME,
								CHQDD, INSTNO, INSTDATE, RELDT, REFNO, MICR, CHQINNAME, CHQPRINTED,
								CLEARMODE, VDESC, SHORTDESC,POSTED_ON)
	SELECT
		L.EXCHANGE,
		L.SEGMENT,
		L.VNO,
		L.VTYPE,
		L.BOOKTYPE,
		L.VDT,
		L.EDT,
		L.MASTERSNO,
		L.SETT_NO,
		L.SETT_TYPE,
		L.DRAMOUNT,
		L.CRAMOUNT,
		L.CLTCODE,
		L.ACNAME,
		L.ACCAT,
		L.MAINLEDGER,
		L.MAINLEDGERNAME,
		L.NARRATION,
		L.BRANCHCODE,
		L.OPPACCOUNT,
		L.BNKNAME,
		L.BRNNAME,
		L.CHQDD,
		L.INSTNO,
		L.INSTDATE,
		RELDT = CASE WHEN DRAMOUNT > 0 THEN DR_RELDT ELSE CR_RELDT END,
		REFNO = CASE WHEN DRAMOUNT > 0 THEN DR_REFNO ELSE CR_REFNO END,
		MICR = CASE WHEN DRAMOUNT > 0 THEN DR_MICRNO ELSE CR_MICRNO END,
		L.CHQINNAME,
		L.CHQPRINTED,
		L.CLEARMODE,
		L.VDESC,
		L.SHORTDESC,
		--L.NODAYS,
		L.POSTED_ON
		
	FROM
		ACC_LEDGER_PL L
		
	
		
		
		
	WHERE  EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
		--L.EXCHANGE = @EXCHANGE
		--AND L.SEGMENT = @SEGMENT
		AND @FDATE <= CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END
		AND @TDATE + ' 23:59' >= CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END
		AND L.CLTCODE >= @FCLTCODE
		AND L.CLTCODE <= @TCLTCODE
		AND L.MASTERSNO = CASE WHEN @MASTERSNO <> 0 THEN @MASTERSNO ELSE L.MASTERSNO END
		AND L.SETT_NO = CASE WHEN @SETT_NO = '' THEN L.SETT_NO ELSE @SETT_NO END
		AND L.SETT_TYPE = CASE WHEN @SETT_TYPE = '' THEN L.SETT_TYPE ELSE @SETT_TYPE END
		AND L.VTYPE NOT IN (19, 20, 22, 23, 24)
		AND L.VTYPE = CASE WHEN @VTYPE = 0 THEN L.VTYPE ELSE @VTYPE END
		AND L.BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN L.BOOKTYPE ELSE @BOOKTYPE END
		AND EXISTS
		(SELECT  PARTY_CODE FROM MSAJAG..CLIENT_DETAILS_VIEW C 
		WHERE 
			L.CLTCODE = C.PARTY_CODE
			AND C.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C.CL_TYPE ELSE @CLTYPE END
			AND @STATUSNAME = CASE @STATUSID
							WHEN 'AREA' THEN C.AREA
							WHEN 'REGION' THEN C.REGION
							WHEN 'BRANCH' THEN C.BRANCH_CD
							WHEN 'SUBBROKER' THEN C.SUB_BROKER
							WHEN 'TRADER' THEN C.TRADER
							WHEN 'FAMILY' THEN C.FAMILY
							WHEN 'CLIENT' THEN C.PARTY_CODE
						ELSE 'BROKER' END
		)
	ORDER BY
		L.EXCHANGE,
		L.SEGMENT,
		L.CLTCODE,
		CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END

END

ELSE IF @FLAG = 'M'
  
  BEGIN
	INSERT INTO @TRANSACTIONS (	EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, EDT, MASTERSNO, SETT_NO,
								SETT_TYPE, DRAMOUNT, CRAMOUNT, CLTCODE, ACNAME, ACCAT, MARGINLEDGERCODE,
								MARGINLEDGERNAME, NARRATION, BRANCHCODE, OPPACCOUNT, BNKNAME, BRNNAME,
								CHQDD, INSTNO, INSTDATE, RELDT, REFNO, MICR, CHQINNAME, CHQPRINTED,
								CLEARMODE, VDESC, SHORTDESC, POSTED_ON)
	SELECT
		L.EXCHANGE,
		L.SEGMENT,
		L.VNO,
		L.VTYPE,
		L.BOOKTYPE,
		L.VDT,
		L.EDT,
		L.MASTERSNO,
		L.SETT_NO,
		L.SETT_TYPE,
		L.DRAMOUNT,
		L.CRAMOUNT,
		L.CLTCODE,
		L.ACNAME,
		L.ACCAT,
		L.MAINLEDGER,
		L.MAINLEDGERNAME,
		L.NARRATION,
		L.BRANCHCODE,
		L.OPPACCOUNT,
		L.BNKNAME,
		L.BRNNAME,
		L.CHQDD,
		L.INSTNO,
		L.INSTDATE,
		RELDT = CASE WHEN DRAMOUNT > 0 THEN DR_RELDT ELSE CR_RELDT END,
		REFNO = CASE WHEN DRAMOUNT > 0 THEN DR_REFNO ELSE CR_REFNO END,
		MICR = CASE WHEN DRAMOUNT > 0 THEN DR_MICRNO ELSE CR_MICRNO END,
		L.CHQINNAME,
		L.CHQPRINTED,
		L.CLEARMODE,
		L.VDESC,
		L.SHORTDESC,
		--L.NODAYS,
		POSTED_ON
	FROM
		ACC_LEDGER_PL L
		
	WHERE  EXISTS (SELECT * FROM .dbo.EXCH_SEG_SPLIT(@SEG_EXCH) A WHERE A.EXCHANGE=L.EXCHANGE AND A.SEGMENT=L.SEGMENT)
		--L.EXCHANGE = @EXCHANGE
		--AND L.SEGMENT = @SEGMENT
		AND @FDATE <= CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END
		AND @TDATE + ' 23:59' >= CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END
		AND L.CLTCODE >= @FCLTCODE
		AND L.CLTCODE <= @TCLTCODE
		AND L.MASTERSNO = CASE WHEN @MASTERSNO <> 0 THEN @MASTERSNO ELSE L.MASTERSNO END
		AND L.SETT_NO = CASE WHEN @SETT_NO = '' THEN L.SETT_NO ELSE @SETT_NO END
		AND L.SETT_TYPE = CASE WHEN @SETT_TYPE = '' THEN L.SETT_TYPE ELSE @SETT_TYPE END
		AND L.VTYPE IN (19, 20, 22, 23, 24)
		AND L.BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN L.BOOKTYPE ELSE @BOOKTYPE END
		--AND NOT EXISTS (SELECT CLTCODE FROM @TRANSACTIONS B WHERE L.CLTCODE = B.CLTCODE AND L.EXCHANGE = B.EXCHANGE AND L.SEGMENT = B.SEGMENT ) 
		AND EXISTS
		(SELECT PARTY_CODE FROM MSAJAG..CLIENT_DETAILS_VIEW C 
		WHERE 
			L.CLTCODE = C.PARTY_CODE
			AND C.CL_TYPE = CASE WHEN @CLTYPE = '' THEN C.CL_TYPE ELSE @CLTYPE END
			AND @STATUSNAME = CASE @STATUSID
							WHEN 'AREA' THEN C.AREA
							WHEN 'REGION' THEN C.REGION
							WHEN 'BRANCH' THEN C.BRANCH_CD
							WHEN 'SUBBROKER' THEN C.SUB_BROKER
							WHEN 'TRADER' THEN C.TRADER
							WHEN 'FAMILY' THEN C.FAMILY
							WHEN 'CLIENT' THEN C.PARTY_CODE
						ELSE 'BROKER' END
		)
	ORDER BY
		L.EXCHANGE,
		L.SEGMENT,
		L.CLTCODE,
		CASE WHEN @TRANON = 'V' THEN L.VDT ELSE L.EDT END



END
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_PIECE
-- --------------------------------------------------




CREATE FUNCTION [dbo].[CLS_PIECE] ( @CharacterExpression VARCHAR(8000), @Delimiter CHAR(1), @Position INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	If @Position<1 return null
	if len(@Delimiter)<>1 return null
	declare @Start integer
	set @Start=1
	while @Position>1
		BEGIN
			Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
			IF @Start=0 return null
			set @position= @position-1
			set @Start=@Start+1
		END
	Declare @End INTEGER
	Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
	If @End=0 Set @End=LEN(@CharacterExpression)+1
	RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_REMOVE_SPACE
-- --------------------------------------------------


CREATE FUNCTION [dbo].[CLS_REMOVE_SPACE]
(
	@CLIENTNAME VARCHAR(100)
)
RETURNS VARCHAR(100)
AS
BEGIN

DECLARE @FIRST_NAME VARCHAR(100)
SET @FIRST_NAME =  LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(@CLIENTNAME, CHAR(10), ''), CHAR(13), ''), CHAR(9), '')))

RETURN @FIRST_NAME

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_Split
-- --------------------------------------------------




CREATE FUNCTION [dbo].[CLS_Split]
(
	@RowData nvarchar(2000),
	@SplitOn nvarchar(5)
)  
RETURNS @RtnValue table 
(
	Id int identity(1,1),
	ITEMS nvarchar(100)
) 
AS  
BEGIN 
	Declare @Cnt int
	Set @Cnt = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		Insert Into @RtnValue (ITEMS)
		Select 
			Data = ltrim(rtrim(Substring(@RowData,1,Charindex(@SplitOn,@RowData)-1)))

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @Cnt = @Cnt + 1
	End
	
	Insert Into @RtnValue (ITEMS)
	Select ITEMS = ltrim(rtrim(@RowData))

	Return
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CONVERTDATEFORMAT
-- --------------------------------------------------
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date, ,>
-- Description:	<Description, ,>
-- =============================================
CREATE FUNCTION [dbo].[CONVERTDATEFORMAT]
(
@DATE VARCHAR(11),
@FORMAT VARCHAR(3) = '109'
)
RETURNS VARCHAR(MAX)
AS
BEGIN
	DECLARE @DATEFOR VARCHAR(MAX)
	
	IF LEN(LTRIM(RTRIM(@DATE))) = 10 AND CHARINDEX('/',@DATE) > 0
		BEGIN
			IF @FORMAT = '101'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,103),101)
				END
			ELSE IF @FORMAT = '103'
				BEGIN
					SET @DATEFOR = @DATE
				END
			ELSE IF @FORMAT = '104'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,103),104)
				END
			ELSE IF @FORMAT = '105'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,103),105)
				END
			ELSE IF @FORMAT = '109'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,103),109)
				END
		END
	ELSE
		BEGIN
			IF @FORMAT = '101'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,109),101)
				END
			ELSE IF @FORMAT = '103'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,109),103)
				END
			ELSE IF @FORMAT = '104'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,109),104)
				END
			ELSE IF @FORMAT = '105'
				BEGIN
					SET @DATEFOR = CONVERT(VARCHAR,CONVERT(DATETIME,@DATE,109),105)
				END
			ELSE IF @FORMAT = '109'
				BEGIN
					SET @DATEFOR = @DATE
				END
		END
	RETURN @DATEFOR

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.EXCH_SEG_SPLIT
-- --------------------------------------------------
--SELECT * FROM .DBO.ABC('NSE-CAPITAL|BSE-CAPITAL|NSE-MFSS|BSE-MFSS')





CREATE FUNCTION [dbo].[EXCH_SEG_SPLIT]

(    

  @A VARCHAR(MAX)

)    

RETURNS @BALANCE TABLE

(

	EXCHANGE VARCHAR(100),

	SEGMENT VARCHAR(100)

)



AS

BEGIN 

DECLARE 

	@ROWPOS		INT,

	@EXSEDATA	AS VARCHAR(20)  

  

 SET @ROWPOS = 1

 WHILE 1 = 1  

BEGIN

	SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@A, '|', @ROWPOS)))  



	--DECLARE @RESULTS  TABLE (EXCH_SEG VARCHAR(100)) 

	

	--SELECT .DBO.SPLIT(@A,'|')

	IF @EXSEDATA IS NULL OR @EXSEDATA = ''  

    BEGIN  

     BREAK  

    END 

    INSERT INTO @BALANCE 

     SELECT .DBO.PIECE(@EXSEDATA, '-', 1),  .DBO.PIECE(@EXSEDATA, '-', 2) 

	 

		--INSERT INTO @BALANCE (@EXCHANGE, @SEGMENT)







SET @ROWPOS = @ROWPOS + 1



DELETE B FROM @BALANCE B

		WHERE 

		EXISTS (SELECT EXCHANGE ,SEGMENT,ACCOUNTDB FROM  PRADNYA.DBO.MULTICOMPANY (NOLOCK) M WHERE  

		B.EXCHANGE = M.EXCHANGE AND B.SEGMENT = M.SEGMENT AND M.ACCOUNTDB <> 'BBO_FA')

END

RETURN

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_USERRIGHTS
-- --------------------------------------------------
CREATE FUNCTION [dbo].[FN_USERRIGHTS]
(
	@VTYPE UDTVTYPE, --SMALLINT,
	@BOOKTYPE UDTBOOKTYPE,
	@EXCHANGE UDTEXCHANGE,
	@SEGMENT UDTSEGMENT,
	@UNAME UDTUSERID,
	@CATEGORY VARCHAR(10)--UDTCATCODE UDTCATEGORY
)
RETURNS @USERRIGHTS TABLE
(
	VTYPE UDTVTYPE, --SMALLINT,
	BOOKTYPE UDTBOOKTYPE,
	EXCHANGE UDTEXCHANGE,
	SEGMENT UDTSEGMENT,
	UNAME UDTUSERID,
	CATEGORY VARCHAR(10),
	START_DATE_ADD INT,
	END_DATE_ADD  INT,
	START_DATE_EDIT  INT,
	END_DATE_EDIT INT,
	START_DATE_DELETE  INT,
	END_DATE_DELETE INT,
	ADD_DAYS INT,
	EDIT_DAYS INT,
	DEL_DAYS INT,
	MKCKFLAG TINYINT
)
AS
/*
SELECT * FROM .DBO.FN_USERRIGHTS (2, '01', 'NSE', 'CAPITAL', 'yatin', '388')
GO
SELECT * FROM .DBO.FN_USERRIGHTS(2, 'AS', 'ALL', 'ALL', 'megha', '1')
GO
select * from USERRIGHTS where userid= 'megha' and category  = 1
SELECT * FROM .DBO.USERRIGHTS WHERE USERID = 'DEMO' AND VTYPE = 2
*/
BEGIN	
	INSERT INTO @USERRIGHTS(VTYPE, BOOKTYPE, EXCHANGE, SEGMENT, UNAME, CATEGORY, START_DATE_ADD, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT, START_DATE_DELETE, END_DATE_DELETE, ADD_DAYS, EDIT_DAYS, DEL_DAYS, MKCKFLAG)
	SELECT VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END,
			BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END,
			@EXCHANGE, @SEGMENT, @UNAME, @CATEGORY,
	STRAT_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -ADD_DAYS, GETDATE()), 112))
								END
							END,
	END_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, ADD_DAYS, GETDATE()), 112))
								END
							END,
	STRAT_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -EDIT_DAYS, GETDATE()), 112))
								END
							END,
	END_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, EDIT_DAYS, GETDATE()), 112))
								END
							END,
	STRAT_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -DELETE_DAYS, GETDATE()), 112))
								END
							END,
	END_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
								CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
							ELSE
								CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
								ELSE
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, DELETE_DAYS, GETDATE()), 112))
								END
							END,
	ADD_DAYS, EDIT_DAYS, DELETE_DAYS, MKCKFLAG
FROM 
	USERRIGHTS
WHERE	
	VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END
	AND BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END
	AND EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	AND USERID = @UNAME
	AND CATEGORY = @CATEGORY

IF @@ROWCOUNT = 0
	BEGIN
		INSERT INTO @USERRIGHTS(VTYPE, BOOKTYPE, EXCHANGE, SEGMENT, UNAME, CATEGORY, START_DATE_ADD, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT, START_DATE_DELETE, END_DATE_DELETE, ADD_DAYS, EDIT_DAYS, DEL_DAYS, MKCKFLAG)
		SELECT VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END,
		 BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END, @EXCHANGE, @SEGMENT, @UNAME, @CATEGORY, 
		STRAT_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -ADD_DAYS, GETDATE()), 112))
									END
								END,
		END_DATE_ADD = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, ADD_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, ADD_DAYS, GETDATE()), 112))
									END
								END,
		STRAT_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -EDIT_DAYS, GETDATE()), 112))
									END
								END,
		END_DATE_EDIT = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, EDIT_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, EDIT_DAYS, GETDATE()), 112))
									END
								END,
		STRAT_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, -DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, -DELETE_DAYS, GETDATE()), 112))
									END
								END,
		END_DATE_DELETE = CASE WHEN GETDATE() < CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112) THEN
									CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), START_DATE), 112)), 112))
								ELSE
									CASE WHEN GETDATE() > CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112) THEN
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD (D, DELETE_DAYS, CONVERT(DATETIME, CONVERT(VARCHAR(8), END_DATE), 112)), 112))
									ELSE
										CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), DATEADD(D, DELETE_DAYS, GETDATE()), 112))
									END
								END,
		ADD_DAYS, EDIT_DAYS, DELETE_DAYS, MKCKFLAG
		FROM 
			USERRIGHTS
		WHERE	
			VTYPE = CASE WHEN @VTYPE = 0 THEN VTYPE ELSE @VTYPE END
			AND BOOKTYPE = CASE WHEN @BOOKTYPE = '' THEN BOOKTYPE ELSE @BOOKTYPE END
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			AND CATEGORY = @CATEGORY
			AND USERID = ''
	END
RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETBASETYPE
-- --------------------------------------------------
CREATE FUNCTION [dbo].[GETBASETYPE]
(
	@TYPENAME VARCHAR(256)
)
RETURNS @TYPEDEF TABLE
	(
		UDTNAME VARCHAR(256),
		SYSTEMNAME VARCHAR(256),
		MAX_LENGTH SMALLINT,
		XPRECISION TINYINT,
		XSCALE TINYINT,
		IS_NULLABLE BIT,
		IS_USER_DEFINED BIT
	)

AS
/*
	SELECT * FROM .dbo.GETBASETYPE('VARCHAR')
*/
BEGIN
	INSERT INTO @TYPEDEF
		(
			UDTNAME,
			SYSTEMNAME,
			MAX_LENGTH,
			XPRECISION,
			XSCALE,
			IS_NULLABLE,
			IS_USER_DEFINED
		)
	SELECT
		S1.NAME, --VARCHAR(256)
		S2.NAME, --VARCHAR(256)  --(SELECT NAME FROM SYS.TYPES S2 WHERE S1.SYSTEM_TYPE_ID = S2.USER_TYPE_ID),
		S1.MAX_LENGTH, --SMALLINT
		S1.PRECISION, --TINYINT
		S1.SCALE,  --TINYINT
		S1.IS_NULLABLE, -- BIT
		S1.IS_USER_DEFINED
	FROM
		SYS.TYPES S1,
		SYS.TYPES S2
	WHERE
		S1.SYSTEM_TYPE_ID = S2.USER_TYPE_ID
		AND S1.NAME = @TYPENAME
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETBASETYPE_STR
-- --------------------------------------------------
CREATE FUNCTION	GETBASETYPE_STR
(
	@TYPENAME VARCHAR(256)
)
RETURNS VARCHAR(500)
AS
/*
	SELECT .dbo.GETBASETYPE_STR('UDTVNO')
*/
BEGIN
	DECLARE
		@SYSNAME VARCHAR(256),
		@LENGTH VARCHAR(4),
		@PRECISION VARCHAR(2),
		@SCALE VARCHAR(2),
		@RETURNVALUE VARCHAR(256)
	SELECT
		@SYSNAME = S2.NAME,
		@LENGTH = S1.MAX_LENGTH,
		@PRECISION = S1.PRECISION,
		@SCALE = S1.SCALE
	FROM
		SYS.TYPES S1,
		SYS.TYPES S2
	WHERE
		S1.SYSTEM_TYPE_ID = S2.USER_TYPE_ID
		AND S1.NAME = @TYPENAME
		AND S1.IS_USER_DEFINED = 1

	IF @SYSNAME = 'VARCHAR' OR @SYSNAME = 'CHAR' OR @SYSNAME = 'NCHAR' OR @SYSNAME = 'NVARCHAR' OR @SYSNAME = 'NUMERIC' OR @SYSNAME = 'DECIMAL'
		BEGIN
			SET @RETURNVALUE = @SYSNAME + '(' + CASE WHEN @SYSNAME = 'NUMERIC' OR @SYSNAME = 'DECIMAL' THEN (@PRECISION + ',' + @SCALE) ELSE @LENGTH END + ')'
		END
	ELSE IF @SYSNAME = 'IMAGE' OR @SYSNAME = 'TEXT' OR @SYSNAME = 'TINYINT' OR @SYSNAME = 'SMALLINT' OR @SYSNAME = 'INT' OR @SYSNAME = 'SMALLDATETIME' OR @SYSNAME = 'MONEY' OR @SYSNAME = 'FLOAT' OR @SYSNAME = 'NTEXT' OR @SYSNAME = 'BIT' OR @SYSNAME = 'BIGINT'
		BEGIN
			SET @RETURNVALUE = @SYSNAME
		END
	ELSE
		BEGIN
			SET @RETURNVALUE = ''
		END
	RETURN UPPER(@RETURNVALUE)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetFirstDayOfMonth
-- --------------------------------------------------
CREATE FUNCTION [dbo].[GetFirstDayOfMonth] ( @InputDate    DATETIME )
RETURNS DATETIME
BEGIN

    RETURN CAST(CAST(YEAR(@InputDate) AS VARCHAR(4)) + '/' + 
                CAST(MONTH(@InputDate) AS VARCHAR(2)) + '/01' AS DATETIME)

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.LEDGER_VIEW
-- --------------------------------------------------
CREATE FUNCTION [dbo].[LEDGER_VIEW]()

RETURNS @LEDGERTABLE TABLE
(
	MASTERSNO BIGINT,
	EDT DATETIME,
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	CLTCODE [UDTPARTYCODE],
	ACNAME [UDTACNAME],
	MAINLEDGER [UDTPARTYCODE],
	MAINLEDGERNAME [UDTACNAME],
	MAINACCAT [UDTACCAT],
	NARRATION [UDTNARRATION],
	REFSNO BIGINT,
	BALAMT MONEY,
	BRANCHCODE [UDTBRANCHCODE],
	REFCODE VARCHAR(10),
	ACCAT [UDTACCAT],
	OPP_BANK [UDTPARTYCODE],
	RESERVED1 VARCHAR(20),
	RESERVED2 VARCHAR(20),
	RESERVED3 VARCHAR(20),
	RESERVED4 VARCHAR(20),
	RESERVED5 VARCHAR(20),
	CURRENCY VARCHAR(3),
	SRNO BIGINT IDENTITY(1,1)
)
AS
BEGIN
	INSERT INTO @LEDGERTABLE (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)

	SELECT MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY
	FROM
	(
		SELECT TOP 100 PERCENT MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY FROM ACC_TBL3 ORDER BY ACCAT
		UNION ALL
		SELECT MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY FROM ACC_TBL2
	) A
	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------

CREATE FUNCTION [DBO].[PIECE] (@CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)  
RETURNS VARCHAR(8000)  
AS  
BEGIN  
 IF @POSITION<1 RETURN NULL  
 IF LEN(@DELIMITER)<>1 RETURN NULL  
 DECLARE @START INTEGER  
 SET @START=1  
 WHILE @POSITION>1  
  BEGIN  
   SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)  
   IF @START=0 RETURN NULL  
   SET @POSITION= @POSITION-1  
   SET @START=@START+1  
  END  
 DECLARE @END INTEGER  
 SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)  
 IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1  
 RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Split
-- --------------------------------------------------
CREATE FUNCTION [dbo].[Split]
(
	@RowData nvarchar(2000),
	@SplitOn nvarchar(5)
)  
RETURNS @RtnValue table 
(
	Id int identity(1,1),
	Data nvarchar(100)
) 
AS  
BEGIN 
	Declare @Cnt int
	Set @Cnt = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		Insert Into @RtnValue (data)
		Select 
			Data = ltrim(rtrim(Substring(@RowData,1,Charindex(@SplitOn,@RowData)-1)))

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @Cnt = @Cnt + 1
	End
	
	Insert Into @RtnValue (data)
	Select Data = ltrim(rtrim(@RowData))

	Return
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.UFN_LOGINCHECK
-- --------------------------------------------------

CREATE FUNCTION [dbo].[UFN_LOGINCHECK]      
(      
 @EXCHANGE UDTEXCHANGE = '',      
 @SEGMENT UDTSEGMENT = '',      
 @STATUSID VARCHAR(25),      
 @STATUSNAME VARCHAR(25),      
 @SEARCHWHAT VARCHAR(20) = 'PARTY',      
 @FROMCODE VARCHAR(20) = '0',      
 @TOCODE VARCHAR(20) = 'ZZZZZZZZZZ',      
 @CLTYPE VARCHAR(3) = ''      
)      
/*      
SELECT CODE, SHORT_NAME FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BROKER', 'BROKER', 'party', '100', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BROKER', 'BROKER', 'party', '0', 'a','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'FAMILY', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', 'BRANCH', 'HO', 'TRADER', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'BRANCH', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'AREA', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'REGION', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', '', '0', 'zz','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'GL', '0', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'cb', '0', 'Z','')      
SELECT * FROM UFN_LOGINCHECK('NSE', 'CAPITAL', '118522', 'BROKER', 'BB', '0', 'Z','')      
*/      
RETURNS      
@CLIENTLOGIN TABLE (      
 [CODE] VARCHAR(50) NOT NULL  DEFAULT '', -- PRIMARY KEY CLUSTERED,      
 [SHORT_NAME] UDTACNAME NOT NULL DEFAULT '',      
 [LONG_NAME] UDTACNAME NOT NULL DEFAULT '',      
 [L_ADDRESS1] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ADDRESS2] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ADDRESS3] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_CITY] VARCHAR(35) NOT NULL DEFAULT '',    
 [L_STATE] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_NATION] VARCHAR(50) NOT NULL DEFAULT '',    
 [L_ZIP] VARCHAR(6) NOT NULL DEFAULT '',    
 [FAX] VARCHAR(20) NOT NULL DEFAULT '',    
 [RES_PHONE1] VARCHAR(15) NOT NULL DEFAULT '',    
 [RES_PHONE2] VARCHAR(15) NOT NULL DEFAULT '',    
 [MOBILE_PAGER] VARCHAR(50) NOT NULL DEFAULT '',    
 [PAN_GIR_NO] VARCHAR(10) NOT NULL DEFAULT '',    
 [EMAIL] VARCHAR(50) NOT NULL DEFAULT '',    
 [CL_TYPE] VARCHAR(3) NOT NULL DEFAULT '',   
 [FAMILY] [UDTPARTYCODE] NOT NULL DEFAULT '',      
 [TRADER] [UDTPARTYCODE] NOT NULL DEFAULT '',      
 [SUB_BROKER] UDTREMISIERCODE NOT NULL DEFAULT '',      
 [BRANCH_CD] [UDTBRANCHCODE] NOT NULL DEFAULT '',      
 [AREA] [UDTAREACODE] NOT NULL DEFAULT '',      
 [REGION] [UDTREGIONCODE] NOT NULL DEFAULT ''  
 )      
AS      
BEGIN   
  
IF @FROMCODE = '' OR @FROMCODE = 'ALL' OR @FROMCODE = '%'      
 BEGIN      
  SET @FROMCODE = '0'      
 END      
 IF @TOCODE = '' OR @TOCODE = 'ALL' OR @FROMCODE = '%'      
 BEGIN      
  SET @TOCODE = 'ZZZZZZZZZZ'      
 END  
 -- ======================================= PARTY ======================================      
 IF @SEARCHWHAT = 'PARTY'      
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE, FAMILY, TRADER, SUB_BROKER, BRANCH_CD, AREA, REGION)       
  SELECT CL_CODE, SHORT_NAME, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE, FAMILY, TRADER, SUB_BROKER, BRANCH_CD, AREA, REGION      
  FROM CLIENT1 (NOLOCK)      
  WHERE @STATUSNAME = CASE @STATUSID WHEN 'FAMILY' THEN FAMILY      
   WHEN 'TRADER' THEN TRADER      
   WHEN 'SUBBROKER' THEN SUB_BROKER      
   WHEN 'BRANCH' THEN BRANCH_CD      
   WHEN 'AREA' THEN AREA      
   WHEN 'REGION' THEN REGION      
   ELSE 'BROKER' END      
   --AND CL_CODE LIKE ISNULL(CASE WHEN @FROMCODE <> '' THEN @FROMCODE WHEN @TOCODE <> '' THEN @TOCODE END, '') + '%'  
   AND CL_CODE BETWEEN @FROMCODE AND @TOCODE
   AND CL_TYPE = CASE WHEN @CLTYPE = '' OR @CLTYPE = '%' OR @CLTYPE = 'ALL' THEN CL_TYPE ELSE @CLTYPE END      
  ORDER BY CL_CODE, SHORT_NAME      
 END      
 -- ======================================== PARTY ENDS ===============================      
      
 -- ==================================== FAMILY =======================================      
 ELSE IF @SEARCHWHAT = 'FAMILY'       
 BEGIN      
  IF @STATUSID = 'CLIENT'      
   RETURN       
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CL_CODE, SHORT_NAME, LONG_NAME      
  FROM CLIENT1 (NOLOCK)      
  WHERE @STATUSNAME = CASE @STATUSID WHEN 'FAMILY' THEN FAMILY      
   WHEN 'TRADER' THEN TRADER      
   WHEN 'SUBBROKER' THEN SUB_BROKER      
   WHEN 'BRANCH' THEN BRANCH_CD      
   WHEN 'AREA' THEN AREA      
   WHEN 'REGION' THEN REGION      
   ELSE 'BROKER' END      
   AND FAMILY BETWEEN @FROMCODE and @TOCODE      
   AND CL_TYPE = CASE WHEN @CLTYPE = '' OR @CLTYPE = '%' OR @CLTYPE = 'ALL' THEN CL_TYPE ELSE @CLTYPE END      
  ORDER BY CL_CODE, SHORT_NAME      
 END      
 -- ==================================== FAMILY ENDS=======================================      
      
 -- ==================================== TRADER ===========================================      
 ELSE IF @SEARCHWHAT = 'TRADER'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY'      
   RETURN       
  IF @STATUSID = 'TRADER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CD, SHORT_NAME, LONG_NAME      
   FROM BRANCHES (NOLOCK)      
   WHERE BRANCH_CD = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
   ORDER BY BRANCH_CD, SHORT_NAME      
  END      
      
  ELSE IF @STATUSID = 'SUB_BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), SUBBROKERS S (NOLOCK)      
   WHERE B.BRANCH_CD = S.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE AND @TOCODE      
    AND S.SUB_BROKER = @STATUSNAME      
   ORDER BY B.SHORT_NAME      
  END      
      
  ELSE IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), BRANCH B1 (NOLOCK)      
   WHERE B.BRANCH_CD = B1.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND B1.BRANCH_CODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), AREA A (NOLOCK)      
   WHERE B.BRANCH_CD = A.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.SHORT_NAME, B.SHORT_NAME, B.LONG_NAME      
   FROM BRANCHES B (NOLOCK), REGION R (NOLOCK)      
   WHERE B.BRANCH_CD = R.BRANCH_CODE      
    AND B.SHORT_NAME BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SHORT_NAME, SHORT_NAME, LONG_NAME      
   FROM BRANCHES (NOLOCK)      
   WHERE SHORT_NAME BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== TRADER ENDS =======================================      
      
 -- ==================================== SUB BROKER ========================================      
 ELSE IF @SEARCHWHAT = 'SUB_BROKER'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY'      
   RETURN      
  IF @STATUSID = 'TRADER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM BRANCHES B (NOLOCK), SUBBROKERS S (NOLOCK)      
   WHERE B.BRANCH_CD = S.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE AND @TOCODE      
    AND B.SHORT_NAME = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'SUB_BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SUB_BROKER, NAME, NAME      
   FROM SUBBROKERS (NOLOCK)      
   WHERE SUB_BROKER = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), BRANCH B (NOLOCK)      
   WHERE S.BRANCH_CODE = B.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND B.BRANCH_CODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), AREA A (NOLOCK)      
   WHERE S.BRANCH_CODE = A.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT S.SUB_BROKER, S.NAME, S.NAME      
   FROM SUBBROKERS S (NOLOCK), REGION R (NOLOCK)      
   WHERE S.BRANCH_CODE = R.BRANCH_CODE      
    AND S.SUB_BROKER BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
 ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT SUB_BROKER, NAME, NAME      
   FROM SUBBROKERS (NOLOCK)      
   WHERE SUB_BROKER BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== SUB BROKER ENDS ===================================      
      
 -- ==================================== BRANCH ============================================      
 ELSE IF @SEARCHWHAT = 'BRANCH'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER'      
   RETURN      
  IF @STATUSID = 'BRANCH'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CODE, BRANCH, LONG_NAME      
   FROM BRANCH (NOLOCK)      
   WHERE BRANCH_CODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.BRANCH_CODE, B.BRANCH, B.LONG_NAME      
   FROM BRANCH B (NOLOCK), AREA A (NOLOCK)      
   WHERE B.BRANCH_CODE = A.BRANCH_CODE      
    AND B.BRANCH_CODE BETWEEN @FROMCODE and @TOCODE      
    AND A.AREACODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT B.BRANCH_CODE, B.BRANCH, B.LONG_NAME      
   FROM BRANCH B (NOLOCK), REGION R (NOLOCK)      
   WHERE B.BRANCH_CODE = R.BRANCH_CODE      
    AND B.BRANCH_CODE BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT BRANCH_CODE, BRANCH, LONG_NAME      
   FROM BRANCH (NOLOCK)      
   WHERE BRANCH_CODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== BRANCH ENDS ===================================      
      
 -- ==================================== AREA ============================================      
 ELSE IF @SEARCHWHAT = 'AREA'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER' OR @STATUSID = 'BRANCH'      
   RETURN      
  IF @STATUSID = 'AREA'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT AREACODE, DESCRIPTION, DESCRIPTION      
   FROM AREA (NOLOCK)      
   WHERE AREACODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT A.AREACODE, A.DESCRIPTION, A.DESCRIPTION      
   FROM AREA A (NOLOCK), REGION R (NOLOCK)      
   WHERE A.BRANCH_CODE = R.BRANCH_CODE      
    AND A.AREACODE BETWEEN @FROMCODE and @TOCODE      
    AND R.REGIONCODE = @STATUSNAME      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT AREACODE, DESCRIPTION, DESCRIPTION      
   FROM AREA (NOLOCK)      
   WHERE AREACODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== AREA ENDS ===================================      
      
 -- ==================================== REGION ============================================      
 ELSE IF @SEARCHWHAT = 'REGION'       
 BEGIN      
  IF @STATUSID = 'CLIENT' OR @STATUSID = 'FAMILY' OR @STATUSID = 'TRADER' OR @STATUSID = 'SUB_BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA'      
   RETURN      
  IF @STATUSID = 'REGION'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT REGIONCODE, DESCRIPTION, DESCRIPTION      
   FROM REGION (NOLOCK)      
   WHERE REGIONCODE = @STATUSNAME--BETWEEN @FROMCODE and @TOCODE      
  END      
      
  ELSE IF @STATUSID = 'BROKER'      
  BEGIN      
   INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
   SELECT REGIONCODE, DESCRIPTION, DESCRIPTION      
   FROM REGION (NOLOCK)      
   WHERE REGIONCODE BETWEEN @FROMCODE AND @TOCODE      
  END      
 END      
 -- ==================================== REGION ENDS ===================================      
      
 -- ==================================== General Ledger ================================      
 ELSE IF @SEARCHWHAT = 'GL'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT IN (3, 14, 103)      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== General Ledger End ============================      
      
 -- ==================================== Cash Book ================================      
 ELSE IF @SEARCHWHAT = 'CB'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT = 1      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== Cash Book End ============================      
      
 -- ==================================== Bank Book ================================      
 ELSE IF @SEARCHWHAT = 'BB'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT CLTCODE, ACNAME, LONGNAME      
  FROM ACMAST (NOLOCK)      
  WHERE       
  EXCHANGE = @EXCHANGE      
  AND SEGMENT = @SEGMENT      
  AND ACCAT = 2      
  AND (BRANCHCODE = 'ALL' OR      
   BRANCHCODE = CASE @STATUSID WHEN 'BROKER' THEN BRANCHCODE      
       WHEN 'BRANCH' THEN @STATUSNAME      
       ELSE '' END)      
  AND CLTCODE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CLTCODE, ACNAME      
 END      
      
 -- ==================================== Bank Book End ============================      
      
 -- ==================================== Client Type ================================      
 ELSE IF @SEARCHWHAT = 'CLTYPE'       
 BEGIN      
  INSERT INTO @CLIENTLOGIN(CODE, SHORT_NAME, LONG_NAME)      
  SELECT LTRIM(RTRIM(CL_TYPE)), LTRIM(RTRIM(DESCRIPTION)), LTRIM(RTRIM(DESCRIPTION))      
  FROM CLIENTTYPE (NOLOCK)      
  WHERE       
  CL_TYPE BETWEEN @FROMCODE AND @TOCODE      
  ORDER BY CL_TYPE, DESCRIPTION      
 END      
      
 -- ==================================== Client Type End ============================      
  RETURN      
END      
/*      
SELECT TOP 5 * FROM CLIENT_DETAILS --WHERE FAMILY = '00000031'      
SELECT TOP 5 * FROM CLIENT1      
SELECT TOP 5 * FROM CLIENT2      
SELECT  TOP 5 * FROM BRANCH      
SELECT  TOP 5 * FROM BRANCHES      
SELECT TOP 5 * FROM SUBBROKERS      
SELECT TOP 5 * FROM AREA      
SELECT TOP 5 * FROM REGION      
SELECT TOP 5 * FROM ACMAST  WHERE  ACCAT = 3      
*/

GO

-- --------------------------------------------------
-- FUNCTION dbo.ufnWMS_Split
-- --------------------------------------------------


CREATE FUNCTION [dbo].[ufnWMS_Split]
(
	@text varchar(8000), 
	@delimiter Char(1) = ' '
)
RETURNS @Strings TABLE  
(      
  
  position int IDENTITY PRIMARY KEY,  
  colvalue varchar(8000)     

)  
  
AS  
BEGIN  
  
SET @text  = REPLACE(@text, (@delimiter + @delimiter), (@delimiter + ' ' + @delimiter))    
  
DECLARE @_index int   
  
SET @_index = -1   
  
WHILE (LEN(@text) > 0)   
  BEGIN    
    SET @_index = CHARINDEX(@delimiter , @text)    
  
    IF (@_index = 0) AND (LEN(@text) > 0)    
      BEGIN     
  
        INSERT INTO @Strings VALUES (@text)  
        BREAK    
      END    
  
    IF (@_index > 1)    
      BEGIN     
  
        INSERT INTO @Strings VALUES (LEFT(@text, @_index - 1))     
  
        SET @text = RIGHT(@text, (LEN(@text) - @_index))    
  
      END    
  
    ELSE   
  
      SET @text = RIGHT(@text, (LEN(@text) - @_index))   
  
    END  
  
  RETURN  
  
END

GO

-- --------------------------------------------------
-- INDEX dbo.ACC_TBL1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXEXVCH] ON [dbo].[ACC_TBL1] ([EXCHANGE], [SEGMENT], [VNO], [VTYPE], [BOOKTYPE], [FINYEAR_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.ACC_TBL2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ACC_TBL2] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ACC_TBL3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ACC_TBL3] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ACC_TBL4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ACC_TBL4] ([CHQDD], [RECEIPTNO], [BNKNAME], [BRNNAME])

GO

-- --------------------------------------------------
-- INDEX dbo.ACC_TBL5
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ACC_TBL5] ([PARTYCODE], [BRANCHCODE], [COSTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CLTCODE] ON [dbo].[Acmast] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ARC_ACC_TBL1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXEXVCH] ON [dbo].[ARC_ACC_TBL1] ([EXCHANGE], [SEGMENT], [VNO], [VTYPE], [BOOKTYPE], [FINYEAR_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.ARC_ACC_TBL2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ARC_ACC_TBL2] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ARC_ACC_TBL3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ARC_ACC_TBL3] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ARC_ACC_TBL4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVCH] ON [dbo].[ARC_ACC_TBL4] ([CHQDD], [RECEIPTNO], [BNKNAME], [BRNNAME])

GO

-- --------------------------------------------------
-- INDEX dbo.MFSS_JVEXCEPTION
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_CL] ON [dbo].[MFSS_JVEXCEPTION] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTIBANKID
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cli] ON [dbo].[MULTIBANKID] ([Cltcode]) INCLUDE ([exchange], [segment])

GO

-- --------------------------------------------------
-- INDEX dbo.Multibankid_Other
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_BANKID] ON [dbo].[Multibankid_Other] ([Bankid])

GO

-- --------------------------------------------------
-- INDEX dbo.Recon_NONCMS_Data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20180630-153650] ON [dbo].[Recon_NONCMS_Data] ([UPLOADID])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.USERRIGHTS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXUID] ON [dbo].[USERRIGHTS] ([EXCHANGE], [SEGMENT], [USERID], [START_DATE], [END_DATE], [VTYPE], [BOOKTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_OFFLINE_LEDGER_ENTRIES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_PARTY] ON [dbo].[V2_OFFLINE_LEDGER_ENTRIES] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_OFFLINE_LEDGER_ENTRIES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VNO] ON [dbo].[V2_OFFLINE_LEDGER_ENTRIES] ([ROWSTATE], [APPROVALFLAG], [RESERVED1])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_OFFLINE_LEDGER_ENTRIES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [REVERED1] ON [dbo].[V2_OFFLINE_LEDGER_ENTRIES] ([RESERVED1])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL1] ADD CONSTRAINT [PK_LEDGERMASTER] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACC_TBL2
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL2] ADD CONSTRAINT [PK_ACC_TBL2] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACC_TBL3
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL3] ADD CONSTRAINT [PK_ACC_TBL3] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ACC_TBL4
-- --------------------------------------------------
ALTER TABLE [dbo].[ACC_TBL4] ADD CONSTRAINT [PK_ACC_TBL4] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [PK_Acmast] PRIMARY KEY ([Cltcode], [Exchange], [Segment])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ARC_ACC_TBL1
-- --------------------------------------------------
ALTER TABLE [dbo].[ARC_ACC_TBL1] ADD CONSTRAINT [PK_LEDGERMASTER_ARC] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.BOOKTYPE
-- --------------------------------------------------
ALTER TABLE [dbo].[BOOKTYPE] ADD CONSTRAINT [PK_BOOKTYPE] PRIMARY KEY ([Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CATMAST
-- --------------------------------------------------
ALTER TABLE [dbo].[CATMAST] ADD CONSTRAINT [PK_CATMAST] PRIMARY KEY ([Accat])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CURRENCY_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[CURRENCY_MASTER] ADD CONSTRAINT [PK_CURRENCY_MASTER] PRIMARY KEY ([CURRENCY_CD])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_DELETION_LOGS] ADD CONSTRAINT [PK__RECON_BA__54ECADF504FA9675] PRIMARY KEY ([SRNO], [UPLOADID], [MATCHEDFLAG])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO] ADD CONSTRAINT [PK_UPLOADMASTERPROCESS] PRIMARY KEY ([UPLOADID], [SEGMENT], [BANKNAME], [FILETYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Recon_CMS_Data
-- --------------------------------------------------
ALTER TABLE [dbo].[Recon_CMS_Data] ADD CONSTRAINT [PK__Recon_CM__C3A4D3AC7F41BD1F] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_REPORT_STATUS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_REPORT_STATUS] ADD CONSTRAINT [PK__RECON_RE__AA12F87B77A09B57] PRIMARY KEY ([MATCHCODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__25918339] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Vmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Vmast] ADD CONSTRAINT [PK_Vmast] PRIMARY KEY ([Vtype])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DATAMIGRATION
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GET_ACC_CODES
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_PrintReconcile
-- --------------------------------------------------

--exec acc_PrintReconcile 'bank01', 'checklist',  'apr 24 2018 23:59', 'apr  1 2018 00:00'     
CREATE PROCEDURE  [dbo].[acc_PrintReconcile]                        
@code varchar(10),                      
@reporttype varchar(10),                      
@tdate  datetime,                      
@fdate  datetime                      
AS                      
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                 
                    
if upper(@reporttype) = 'STATEMENT'                      
begin                      
/*set transaction isolation level read uncommitted                    
                  
select distinct vtyp, booktype, vno, lno into #tblbankreco from ledger where cltcode = @code             
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#tblbankreco] ([vno], [vtyp], [BookType])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger          
From Ledger L, #tblbankreco T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
--And L.Lno = T.LNo          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
          
select l.* Into #Ledger1          
From Ledger1 L, #tblbankreco T          
Where L.VNo = T.Vno           
And L.Vtyp = T.Vtyp          
And L.BookType = T.BookType          
          
CREATE CLUSTERED          
  INDEX [Partyvdt] ON [dbo].[#Ledger1] ([vno], [vtyp], [BookType], [LNO])          
WITH          
    FILLFACTOR = 90          
ON [PRIMARY]          
                  
 select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                       
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then relamt  else 0 end ),                      
 Cramt= (case when upper(l.drcr) = 'C' then relamt else 0 end ),                       
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno                      
 From #Ledger l, #Ledger1 L1 ,                      
 #tblbankreco t                       
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype                       
 and l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno          
 and cltcode <> @code and vdt <=@tdate --and l.vtyp not in ( 16, 17) and l1.clear_mode not in ('C', 'R')                      
 and rtrim(l1.ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109)               
 not in(select rtrim(ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109) from #Ledger1 l12, #Ledger l2           
 where l12.vno=l2.vno and l12.vtyp=l2.vtyp                                                 
 and l12.booktype=l2.booktype and l12.vtyp='16' and l2.vdt < @tdate and cltcode= @code)                                              
 and (reldt ='1900-01-01 00:00:00.000' or reldt > @tdate )                       
 order by l.drcr, vdt, l.vtyp, l.vno                      
          
 DROP TABLE #tblbankreco          
 DROP TABLE #Ledger          
 DROP TABLE #Ledger1    */      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT       
 L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,                       
 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN RELAMT  ELSE 0 END ),                      
 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN RELAMT ELSE 0 END ),                       
 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO                      
FROM       
 LEDGER L,       
 LEDGER1 L1 ,                      
 (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @code AND VDT <= @tdate ) L2      
WHERE       
 L.VTYP = L2.VTYP AND L.VNO= L2.VNO AND L.BOOKTYPE = L2.BOOKTYPE                       
 AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO          
 AND CLTCODE <> @code       AND NOT EXISTS      
  (SELECT L3.DDNO FROM LEDGER1 L3, (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @code AND VDT <= @tdate AND VTYP = 16) L4      
  WHERE L1.DDNO = L3.DDNO AND CONVERT(VARCHAR(11),L1.DDDT,109) = CONVERT(VARCHAR(11),L3.DDDT,109) AND L1.RELAMT = L3.RELAMT      
  AND L3.VNO = L4.VNO AND L3.VTYP = L4.VTYP AND L3.BOOKTYPE = L4.BOOKTYPE AND L1.BOOKTYPE = L3.BOOKTYPE )      
 AND (RELDT ='1900-01-01 00:00:00.000' OR RELDT >  @tdate )      
ORDER BY       
 L.DRCR, VDT, L.VTYP, L.VNO      
          
end                      
else                      
begin                      
        
          
select l.* Into #Ledger_TMP          
From acc_Ledger L        
Where oppaccount = @code and  vdt >= @fdate and vdt <= @tdate         
          

          
 select l.vtype, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(instno,'') ddno, isnull(cltcode ,'') cltcode ,                       
 isnull( acname ,'') acname, drcr = case when cramount <> 0 then 'C' else 'D' end, Dramt=dramount,                      
 Cramt= cramount,                       
 treldt=case when dr_reldt <> '' then isnull(convert(varchar, dr_reldt , 103),'') else isnull(convert(varchar, cr_reldt , 103),'') end, instno                      
 From #Ledger_TMP l 
 WHERE cltcode <> @code and vdt >= @fdate and vdt <= @tdate                      
 order by case when cramount <> 0 then 'C' else 'D' end, vdt, vtype, vno          
          
        
DROP TABLE #Ledger_TMP          
        
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_SAVE_DELETE_CATEGORY
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_SAVE_UPDATE_ACCOUNT
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_SAVE_UPDATE_BOOKTYPE
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_SAVE_UPDATE_DEL_PARAMETER
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_UPDATE_ACNAME
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[ACC_UPDATE_ACNAME]
	@EXCHSEG VARCHAR(600),
	@FINANCIAL_YEAR VARCHAR(40),
	@CLTCODE VARCHAR(MAX),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25)
AS
/*
	BEGIN TRAN
	ACC_UPDATE_ACNAME 'BSE-CAPITAL,', '01/04/2009-31/03/2010', '', '', ''
*/
BEGIN TRY
	SET NOCOUNT ON;

	DECLARE @ESDATA VARCHAR(500),
		@SQL VARCHAR(1000),
		@LOOPID INT,
		@EXCHANGE VARCHAR(10),
		@SEGMENT VARCHAR(20),
		@SHAREDB VARCHAR(50),
		@SDTCUR VARCHAR(11),
		@LDTCUR VARCHAR(11)

	CREATE TABLE #SHAREDATA
	(
		SHAREDB VARCHAR(50)
	)
	
	SET @SDTCUR = .DBO.CONVERTDATEFORMAT(.DBO.PIECE(@FINANCIAL_YEAR, '-', 1), '109')
	SET @LDTCUR = .DBO.CONVERTDATEFORMAT(.DBO.PIECE(@FINANCIAL_YEAR, '-', 2), '109')
	
	SET @CLTCODE = REPLACE(@CLTCODE, ',', ''',''')
	SET @LOOPID = 1

	WHILE 1 = 1
		BEGIN
			SET @ESDATA = .DBO.PIECE(@EXCHSEG, ',', @LOOPID)
			IF @ESDATA = '' OR @ESDATA IS NULL
				BEGIN
					BREAK
				END
			SET @EXCHANGE = .DBO.PIECE(@ESDATA, '-', 1)
			SET @SEGMENT = .DBO.PIECE(@ESDATA, '-', 2)
			IF @SEGMENT = '' OR @SEGMENT IS NULL OR @EXCHANGE = '' OR @EXCHANGE IS NULL
				BEGIN
					BREAK
				END
			SET @SQL = 'SELECT UPPER(SHAREDB) FROM VW_MULTICOMPANY WHERE PRIMARYSERVER = 1 AND EXCHANGE = ''' + @EXCHANGE + ''' AND SEGMENT = ''' +  @SEGMENT + ''''
			--PRINT @SQL

			INSERT INTO #SHAREDATA
			EXEC(@SQL)
		
			SELECT @SHAREDB = SHAREDB FROM #SHAREDATA
			IF @SHAREDB = '' OR @SHAREDB IS NULL
				BEGIN
					BREAK
				END
			
			SET @SQL = 'UPDATE A SET A.ACNAME = C1.LONG_NAME '
			SET @SQL = @SQL + ' FROM ' + @SHAREDB + '.DBO.CLIENT1 C1, ' + @SHAREDB + '.DBO.CLIENT2 C2, ACMAST A '
			SET @SQL = @SQL + ' WHERE C1.CL_CODE = C2.CL_CODE '
			SET @SQL = @SQL + ' AND C2.PARTY_CODE = A.CLTCODE '
			SET @SQL = @SQL + ' AND A.ACNAME <> C1.LONG_NAME '

			SET @SQL = @SQL + ' UPDATE V '
			SET @SQL = @SQL + ' SET V.ACNAME = A.ACNAME, V.MAINLEDGERNAME = M.ACNAME '
			SET @SQL = @SQL + ' FROM ACC_LEDGER_PL_ENTRY V, ACMAST A, ACMAST M '
			SET @SQL = @SQL + ' WHERE V.CLTCODE = A.CLTCODE '
			SET @SQL = @SQL + ' AND V.MAINLEDGER = M.CLTCODE '
			SET @SQL = @SQL + ' AND V.LOCK_FLAG = 0 '
			SET @SQL = @SQL + ' AND V.EXCHANGE = ''' + @EXCHANGE + ''''
			SET @SQL = @SQL + ' AND V.SEGMENT = ''' + @SEGMENT + ''''
			--SET @SQL = @SQL + ' AND V.VDT_C BETWEEN ''' + @SDTCUR + ''' AND ''' + @LDTCUR + ''''
			SET @SQL = @SQL + ' AND CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), V.VDT), 112), 109) BETWEEN ''' + @SDTCUR + ''' AND ''' + @LDTCUR + ''''

			IF @CLTCODE <> ''
				BEGIN
					SET @SQL = @SQL + ' AND V.CLTCODE IN (''' + @CLTCODE +''') '
				END

			SET @SQL = @SQL + ' UPDATE V '
			SET @SQL = @SQL + ' SET V.ACNAME = A.ACNAME, V.MAINLEDGERNAME = M.ACNAME '
			SET @SQL = @SQL + ' FROM ACC_LEDGER_GL_ENTRY V, ACMAST A, ACMAST M '
			SET @SQL = @SQL + ' WHERE V.CLTCODE = A.CLTCODE '
			SET @SQL = @SQL + ' AND V.MAINLEDGER = M.CLTCODE '
			SET @SQL = @SQL + ' AND V.LOCK_FLAG = 0 '
			SET @SQL = @SQL + ' AND V.EXCHANGE = ''' + @EXCHANGE + ''''
			SET @SQL = @SQL + ' AND V.SEGMENT = ''' + @SEGMENT + ''''
			--SET @SQL = @SQL + ' AND V.VDT_C BETWEEN ''' + @SDTCUR + ''' AND ''' + @LDTCUR + ''''
			SET @SQL = @SQL + ' AND CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), V.VDT), 112), 103) BETWEEN ''' + @SDTCUR + ''' AND ''' + @LDTCUR + ''''
			IF @CLTCODE <> ''
				BEGIN
					SET @SQL = @SQL + ' AND V.CLTCODE IN (''' + @CLTCODE +''') '
				END
			PRINT @SQL
			EXEC(@SQL)
			SET @LOOPID = @LOOPID + 1
		END
END TRY
BEGIN CATCH
	DECLARE @ERR VARCHAR(MAX)
	SET @ERR = ERROR_MESSAGE()
	RAISERROR(@ERR, 16, 1)
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_UPDATE_OWNER
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACCGENSNO
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACCGENVNO
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADDEDITUSERRIGHTS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Approve_Reject_Offline_Vouhcer
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTO_NEWPOSTBILL
-- --------------------------------------------------

  
CREATE PROCEDURE [dbo].[AUTO_NEWPOSTBILL]                  
(                
 @VTYPE [UDTVTYPE],    
 @BOOKTYPE [UDTBOOKTYPE],    
 @VDT VARCHAR(11),           
 @EDTDR VARCHAR(11),    
 @EDTCR VARCHAR(11),    
 @SETT_NO [UDTSETTNO],    
 @SETT_TYPE [UDTSETTTYPE],    
 @UNAME [UDTUSERID],    
 @CATEGORY NCHAR (20),    
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT],    
 @BILLDATE VARCHAR(11),    
 @IP_ADD VARCHAR(20)  
)     
--WITH ENCRYPTION               
AS      
    
    
BEGIN TRY    
    
IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0    
 BEGIN    
  SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)    
 END    
     
 IF LEN(@EDTDR) = 10 AND CHARINDEX('/', @EDTDR) > 0    
 BEGIN    
  SET @EDTDR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTDR, 103), 109)    
 END    
     
 IF LEN(@EDTCR) = 10 AND CHARINDEX('/', @EDTCR) > 0    
 BEGIN    
  SET @EDTCR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTCR, 103), 109)    
 END    
     
     
    
IF LEN(@BILLDATE) = 10 AND CHARINDEX('/', @BILLDATE) > 0    
 BEGIN    
  SET @BILLDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @BILLDATE, 103), 109)    
 END    
    
DECLARE    
 @VNO VARCHAR(12),    
 @MARTERSNO VARCHAR(12),    
 @@SQL VARCHAR(2000),    
 @SHAREDB VARCHAR(20)    
    
DECLARE    
 @START_DATE_ADD NUMERIC(8),    
 @END_DATE_ADD NUMERIC(8),    
 @START_DATE_EDIT NUMERIC(8),    
 @END_DATE_EDIT NUMERIC(8)    
    
IF @SETT_TYPE <> '' AND @EXCHANGE <> 'IEX'    
 BEGIN    
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VTYPE = @VTYPE    
 END    
ELSE    
 BEGIN    
  SET @SETT_NO = CONVERT(VARCHAR(6), CONVERT(DATETIME, @BILLDATE), 12)    
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT    
 END    
    
IF @MARTERSNO <> '0'    
 BEGIN    
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_EDIT OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_EDIT    
   BEGIN    
    RAISERROR ('NOT ALLOWED', 16, 1)    
    RETURN    
   END    
 END    
ELSE    
 BEGIN    
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_ADD OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_ADD    
   BEGIN    
    RAISERROR ('NOT ALLOWED', 16, 1)    
    RETURN    
   END    
 END    
    
SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT    
    
CREATE TABLE #BILLDETAILS    
(    
 SNO INT IDENTITY(1, 1),    
 SELL_BUY VARCHAR(2) NULL,    
 PARTY_CODE VARCHAR(20) NULL,    
 AMOUNT MONEY NULL,  
 EDT DATETIME,    
 NARRATION VARCHAR(50)    
)    
    
EXEC MAKE_UDT_STRUCTURE     
 '#BILLDETAILS',     
 'BRANCHCD',     
 'UDTBRANCHCODE',     
 '',     
 '0'      
    
    
SELECT @VNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)    
    
IF @SETT_TYPE <> '' AND @BILLDATE <> ''    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYOUT_DATE, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  IF @VTYPE = 15    
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "    
  ELSE    
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "SAUDA_DATE = '" + @BILLDATE + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE IF @SETT_TYPE <> '' AND @SETT_NO <> ''    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYOUT_DATE, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  IF @VTYPE = 15    
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "    
  ELSE    
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE IF @EXCHANGE = "USX" OR @EXCHANGE = "BSE" OR @EXCHANGE = "USM"    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  SET @@SQL = @@SQL + @SHAREDB + "..BFOACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  SET @@SQL = @@SQL + @SHAREDB + "..FOACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
    
EXEC (@@SQL)     
  
IF @MARTERSNO <> '0'    
 BEGIN    
    
  DECLARE    
   @@LEDGERVNO VARCHAR(12),    
   @@EXCHANGE VARCHAR(10),    
   @@SEGMENT VARCHAR(20),    
   @@VTYPE INT,    
   @@BOOKTYPE VARCHAR(10)    
    
    
    
  SELECT @@LEDGERVNO = VNO, @@EXCHANGE = EXCHANGE, @@SEGMENT = SEGMENT, @@VTYPE = VTYPE, @@BOOKTYPE = BOOKTYPE FROM ACC_LEDGER WHERE MASTERSNO = @MARTERSNO    
    
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG    
   (FLDAUTO, VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT,
  
  
  
 ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, EDITED_BY, EDITED_ON, 
  
  
  
 ACTION_FLAG, IP_ADD, RECORD_STATE)    
  SELECT    
   FLDAUTO,    
   VOUCHERTYPE,    
   BOOKTYPE,    
   SNO,    
   VDATE,    
   EDATE,    
   CLTCODE,    
   CREDITAMT,    
   DEBITAMT,    
   NARRATION,    
   OPPCODE,    
   MARGINCODE,    
   BANKNAME,    
   BRANCHNAME,    
   BRANCHCODE,    
   DDNO,    
   CHEQUEMODE,    
   CHEQUEDATE,    
   CHEQUENAME,    
   CLEAR_MODE,    
   TPACCOUNTNUMBER,    
   EXCHANGE,    
   SEGMENT,    
   TPFLAG,    
   ADDDT,    
   ADDBY,    
   STATUSID,    
   STATUSNAME,    
   ROWSTATE,    
   APPROVALFLAG,    
   APPROVALDATE,    
   APPROVEDBY,    
   VOUCHERNO,    
   UPLOADDT,    
   LEDGERVNO,    
   CLIENTNAME,    
   OPPCODENAME,    
   MARGINCODENAME,    
   SETT_NO,    
   SETT_TYPE,    
   PRODUCTTYPE,    
   REVAMT,    
   REVCODE,    
   MICR,    
   REL_DATE,    
   DISPLAY_FLAG,    
   @UNAME,    
   GETDATE(),    
   'E',    
   @IP_ADD,    
   1    
  FROM    
   V2_OFFLINE_LEDGER_ENTRIES    
  WHERE     
   LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
    
  UPDATE V2_OFFLINE_LEDGER_ENTRIES SET ROWSTATE = 1, APPROVALFLAG = 3 WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
  --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
 END    
    
INSERT INTO V2_OFFLINE_LEDGER_ENTRIES    
(    
 VOUCHERTYPE,     
 BOOKTYPE,     
 SNO,     
 VDATE,     
 EDATE,     
 CHEQUEDATE,     
 CLTCODE,     
 CREDITAMT,     
 DEBITAMT,     
 NARRATION,    
 BRANCHCODE,   
 EXCHANGE,     
 SEGMENT,     
 ADDDT,     
 ADDBY,     
 STATUSID,     
 STATUSNAME,     
 ROWSTATE,     
 APPROVALFLAG,     
 VOUCHERNO,    
 UPLOADDT,    
 LEDGERVNO,    
 SETT_NO,    
 SETT_TYPE,    
 CLIENTNAME,    
 RESERVED1,    
 RESERVED2    
)    
SELECT    
 @VTYPE,     
 @BOOKTYPE,     
 B.SNO,     
 @VDT,     
 EDT,     
 @BILLDATE,     
 B.PARTY_CODE,     
 CREDITAMT = CASE WHEN B.SELL_BUY = 2 THEN B.AMOUNT ELSE 0 END,    
 DEBITAMT = CASE WHEN B.SELL_BUY = 1 THEN B.AMOUNT ELSE 0 END,     
 NARRATION =     
 CASE WHEN     
  @BILLDATE = ''     
 THEN     
  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(B.NARRATION))    
 ELSE    
  @EXCHANGE + @BILLDATE + RTRIM(LTRIM(B.NARRATION))    
 END,    
 B.BRANCHCD,    
 @EXCHANGE,     
 @SEGMENT,     
 GETDATE(),     
 @UNAME,     
 'BROKER',     
 'BROKER',     
 ROWSTATE = 0,     
 APPROVALFLAG = 1,     
 VOUCHERNO = @VNO,     
 GETDATE(),     
 LEDGERVNO = CASE WHEN @MARTERSNO <> 0 THEN @@LEDGERVNO ELSE '' END,     
 @SETT_NO,     
 @SETT_TYPE,    
 A.LONGNAME,    
 CASE WHEN @MARTERSNO <> 0 THEN @MARTERSNO ELSE 0 END,    
 9999    
FROM     
 #BILLDETAILS B,    
 ACMAST A    
WHERE    
 B.PARTY_CODE = A.CLTCODE    
 AND A.EXCHANGE = @EXCHANGE    
 AND A.SEGMENT = @SEGMENT    
 AND B.AMOUNT > 0    
    
    
EXEC FA_POSTING @VNO    
    
--SELECT TOP 1 LEDGERVNO FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERNO = @VNO AND (VOUCHERTYPE = 15 OR VOUCHERTYPE = 21)    
    
    
END TRY    
BEGIN CATCH    
 --IF @@TRANCOUNT > 0    
  --ROLLBACK TRAN    
 RETURN    
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTOPROCESS_NEWPOSTBILL
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[AUTOPROCESS_NEWPOSTBILL]
(              
 @SETT_NO [UDTSETTNO],  
 @SETT_TYPE [UDTSETTTYPE],  
 @BILLDATE VARCHAR(11),
 @EXCHANGE [UDTEXCHANGE],  
 @SEGMENT [UDTSEGMENT]  
)   
--WITH ENCRYPTION             
AS    
  

DECLARE
	@VTYPE [UDTVTYPE],  
	@BOOKTYPE [UDTBOOKTYPE],  
	@VDT VARCHAR(11),         
	@EDTDR VARCHAR(11),  
	@EDTCR VARCHAR(11),
	@UNAME [UDTUSERID], 
	@IP_ADD VARCHAR(20),
	@@SQL VARCHAR(500),
	@SHAREDB VARCHAR(100)
	
	
SET @VTYPE = 15
SET	@BOOKTYPE = '01'
SET	@VDT = @BILLDATE
SET	@UNAME = 'AUTO_PROCESS'
SET	@IP_ADD = 'AUTO_PROCESS'

SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  

CREATE TABLE #PAYIN_DATES
(
	PAYIN_DATE DATETIME
)

if @EXCHANGE = 'BSE'
	INSERT INTO #PAYIN_DATES SELECT TOP 1 PAYIN_DATE = PAYOUT_DATE FROM BSEMFSS..ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
else
	INSERT INTO #PAYIN_DATES SELECT TOP 1 PAYIN_DATE = PAYOUT_DATE FROM NSEMFSS..ACCBILL WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE


SELECT @EDTDR = PAYIN_DATE, @EDTCR = PAYIN_DATE FROM #PAYIN_DATES

SELECT @EDTDR, @EDTCR 
--EXEC AUTO_NEWPOSTBILL 15,'01',@BILLDATE,@EDTDR,@EDTCR,@SETT_NO,@SETT_TYPE,'AUTO',@CATEGORY='1',@EXCHANGE,@SEGMENT,'','127.0.0.1'
exec AUTO_NEWPOSTBILL 15,'01',@BILLDATE,@EDTDR,@EDTCR,@SETT_NO,@SETT_TYPE,@UNAME,'1',@EXCHANGE,@SEGMENT,'','127.0.0.1'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ALLBANKS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_ICICI_ALLBANKS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_RPT_ACCPLREPORT_SUM_REV_14032013
-- --------------------------------------------------
  CREATE PROC [dbo].[bak_RPT_ACCPLREPORT_SUM_REV_14032013]    
(    
 @FDATE VARCHAR(11),    
 @TDATE VARCHAR(11),    
 @FCODE [UDTPARTYCODE],    
 @TCODE [UDTPARTYCODE],    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @BRANCHCODE [UDTBRANCHCODE],    
 @SELECTON VARCHAR(3),    
 @SORTON VARCHAR(3),    
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT],    
 @CLTYPE VARCHAR(3) = ''    
)    
AS    
/*    
 EXEC RPT_ACCPLREPORT_SUM_REV 'APR  1 2007', 'Jun  1 2007', '0', 'ZZZZZZ', 'BROKER', 'BROKER', 'AL001', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'INS'    
*/    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0    
 BEGIN    
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)    
 END    
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0    
 BEGIN    
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)    
 END    
DECLARE    
 @YEARSTART VARCHAR(11),    
 @YEAREND VARCHAR(11)    
SELECT    
 @YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),    
 @YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)    
FROM    
 PARAMETER    
WHERE    
 @FDATE BETWEEN SDTCUR AND LDTCUR    
 AND @TDATE BETWEEN SDTCUR AND LDTCUR    
    
IF @YEARSTART IS NULL OR @YEAREND IS NULL    
 BEGIN    
  RAISERROR('Invalid Financial Information...', 16, 1)    
  RETURN    
 END    
  
CREATE TABLE #CLIENT   
(  
 TRADER VARCHAR(20),  
 SUB_BROKER VARCHAR(20),  
 [L_ADDRESS1] VARCHAR(50) NOT NULL,    
 [L_ADDRESS2] VARCHAR(50) NOT NULL,    
 [L_ADDRESS3] VARCHAR(50) NOT NULL,    
 [L_CITY] VARCHAR(35) NOT NULL,    
 [L_STATE] VARCHAR(50) NOT NULL,    
 [L_NATION] VARCHAR(50) NOT NULL,    
 [L_ZIP] VARCHAR(6) NOT NULL,    
 [FAX] VARCHAR(20) NOT NULL,    
 [RES_PHONE1] VARCHAR(15) NOT NULL,    
 [RES_PHONE2] VARCHAR(15) NOT NULL,    
 [MOBILE_PAGER] VARCHAR(50) NOT NULL,    
 [PAN_GIR_NO] VARCHAR(10) NOT NULL,    
 [EMAIL] VARCHAR(50) NOT NULL,   
 [CL_TYPE] VARCHAR(3) NOT NULL,  
 [BANK_NAME] VARCHAR(50) NOT NULL,  
 [ACC_NUM] VARCHAR(40) NOT NULL  
)  
  
EXEC MAKE_UDT_STRUCTURE  
 '#CLIENT',  
 'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',  
 'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',  
 '',  
 ''  
  
DECLARE  
 @@SHAREDB VARCHAR(20),  
 @@SQL VARCHAR(1000)  
  
SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
  
SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION,BANK_NAME,ACC_NUM) "  
SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"  
  
EXEC (@@SQL)  
  
IF @SELECTON = 'VDT'    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,    
   CLTCODE = L.CODE,    
   ACCAT,    
   ACNAME = L.LONG_NAME,    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = ROW_NUMBER() OVER (ORDER BY L.CODE),--CLTCODE    
   ACNRW = ROW_NUMBER() OVER (ORDER BY L.LONG_NAME)--ACNAME, vtype    
  FROM    
   ACC_LEDGER_PL P, #CLIENT L    
  WHERE    
   P.CLTCODE = L.CODE    
   AND EXCHANGE = @EXCHANGE    
   AND SEGMENT = @SEGMENT    
--   AND CLTCODE BETWEEN @FCODE AND @TCODE    
   AND VDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
--   AND ACCAT IN (4, 104)    
   AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
--   AND @STATUSNAME =     
--      (    
--       CASE @STATUSID    
--  WHEN 'AREA' THEN AREA    
--        WHEN 'REGION' THEN REGION    
--        WHEN 'SUBBROKER' THEN SUB_BROKER    
--        WHEN 'TRADER' THEN TRADER    
--        WHEN 'BRANCH' THEN BRANCH_CD    
--        WHEN 'FAMILY' THEN FAMILY    
--        WHEN 'CLIENT' THEN CLTCODE    
--       ELSE    
--        'BROKER'    
--       END    
--      )    
  GROUP BY    
   L.CODE,--CLTCODE,    
   ACCAT,    
   L.LONG_NAME--ACNAME--, vtype--, BRANCHCODE    
  ORDER BY    
   L.LONG_NAME,--ACNAME,    
   L.CODE--CLTCODE    
 END    
ELSE    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(BALANCE) >= 0 THEN SUM(BALANCE) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END,    
   CLTCODE ,    
   ACCAT,    
   ACNAME ,    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = ROW_NUMBER() OVER (ORDER BY CLTCODE),    
   ACNRW = ROW_NUMBER() OVER (ORDER BY ACNAME)    
  FROM    
   (    
    SELECT    
     CLTCODE= L.CODE,    
     ACCAT,    
     ACNAME= L.LONG_NAME,    
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(DRAMOUNT - CRAMOUNT)    
    FROM    
     ACC_LEDGER_PL P, #CLIENT L    
    WHERE    
     P.CLTCODE = L.CODE    
     AND EXCHANGE = @EXCHANGE    
     AND SEGMENT = @SEGMENT    
--     AND CLTCODE BETWEEN @FCODE AND @TCODE    
     AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
--     AND ACCAT IN (4, 104)    
     AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
--     AND @STATUSNAME =     
--        (    
--         CASE @STATUSID    
--          WHEN 'AREA' THEN AREA    
--          WHEN 'REGION' THEN REGION    
--          WHEN 'SUBBROKER' THEN SUB_BROKER    
--          WHEN 'TRADER' THEN TRADER    
--          WHEN 'BRANCH' THEN BRANCH_CD    
--          WHEN 'FAMILY' THEN FAMILY    
--          WHEN 'CLIENT' THEN CLTCODE    
--         ELSE    
--          'BROKER'    
--         END    
--        )    
    GROUP BY    
     L.CODE,--CLTCODE,    
     ACCAT,    
     L.LONG_NAME--ACNAME--, BRANCHCODE    
    UNION ALL    
    SELECT    
     CLTCODE = L.CODE,    
     ACCAT,    
     ACNAME = L.LONG_NAME,    
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(CRAMOUNT - DRAMOUNT)    
    FROM    
     ACC_LEDGER_PL P, #CLIENT L    
    WHERE    
     P.CLTCODE = L.CODE    
     AND EXCHANGE = @EXCHANGE    
     AND SEGMENT = @SEGMENT    
--     AND CLTCODE BETWEEN @FCODE AND @TCODE    
     AND VDT < @YEARSTART    
     AND EDT >= @YEARSTART    
--     AND ACCAT IN (4, 104)    
     AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
--     AND @STATUSNAME =     
--        (    
--         CASE @STATUSID    
--          WHEN 'AREA' THEN AREA    
--          WHEN 'REGION' THEN REGION    
--          WHEN 'SUBBROKER' THEN SUB_BROKER    
--          WHEN 'TRADER' THEN TRADER    
--          WHEN 'BRANCH' THEN BRANCH_CD    
--          WHEN 'FAMILY' THEN FAMILY    
--          WHEN 'CLIENT' THEN CLTCODE    
--         ELSE    
--          'BROKER'    
--         END    
--        )    
    GROUP BY    
     L.CODE,--CLTCODE,    
     ACCAT,    
     L.LONG_NAME--ACNAME --, BRANCHCODE    
   ) A    
  GROUP BY    
   CLTCODE,    
   ACCAT,    
   ACNAME--, BRANCHCODE    
  ORDER BY    
   CLTCODE,    
   ACNAME    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY
-- --------------------------------------------------








--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
CREATE    PROC [dbo].[BANKRECODISPLAY]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(50),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,
 REFNO INT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT,REFNO)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 --RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT,
 REFNO= CASE WHEN @EDITRECO = 0 THEN 0 ELSE CASE WHEN DR_RELAMT > 0 THEN DR_REFNO ELSE CR_REFNO END END       
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO     
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_10102017_pratham
-- --------------------------------------------------

---EXEC BANKRECODISPLAY_10102017_pratham '02014', '', 'oct 10 2017', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'
CREATE PROC [dbo].[BANKRECODISPLAY_10102017_pratham]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')"        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        
--SELECT * FROM #MASTERSNOS        
        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 DR_RELDT VARCHAR(10),
 CR_RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0'      
      
        
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, DR_RELDT,CR_RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 DR_RELDT,
 CR_RELDT,
 --RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT        
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

----select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,       
 DR_RELDT,
 CR_RELDT ,
-- RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 DR_RELDT,
 CR_RELDT ,
 --RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 --RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO = 0        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_bak
-- --------------------------------------------------




--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
create    PROC [dbo].[BANKRECODISPLAY_bak]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
  SET @EDITRECO=1  
  SELECT  @FDATE =  SDTCUR FROM PARAMETER WHERE CURYEAR=1    
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,
 REFNO INT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT,REFNO)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 --RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT,
 REFNO= CASE WHEN @EDITRECO = 0 THEN 0 ELSE CASE WHEN DR_RELAMT > 0 THEN DR_REFNO ELSE CR_REFNO END END       
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO     
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_BAK_14032018
-- --------------------------------------------------




--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
CREATE    PROC [dbo].[BANKRECODISPLAY_BAK_14032018]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,
 REFNO INT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT,REFNO)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 --RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT,
 REFNO= CASE WHEN @EDITRECO = 0 THEN 0 ELSE CASE WHEN DR_RELAMT > 0 THEN DR_REFNO ELSE CR_REFNO END END       
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO     
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_BAK14032018
-- --------------------------------------------------



--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
CREATE    PROC [dbo].[BANKRECODISPLAY]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 --RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT        
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO = 0        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_MFSS
-- --------------------------------------------------



--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
CREATE   PROC [dbo].[BANKRECODISPLAY_MFSS]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT >= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT >= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(50),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,       
 SRNO INT IDENTITY(1,1),
 REFNO INT        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT,REFNO)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 --RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT,
 REFNO= CASE WHEN DR_RELAMT > 0 THEN DR_REFNO ELSE CR_REFNO END        
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 --AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO       
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_MFSS_BAK_14032018
-- --------------------------------------------------


--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'    
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'      
CREATE   PROC [dbo].[BANKRECODISPLAY_MFSS_BAK_14032018]        
(        
 @BANKCODE [UDTPARTYCODE],        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @EDITRECO BIT,        
 @SELECTON VARCHAR(2),        
 @BRANCHCODE [UDTBRANCHCODE],        
 @FCLIENT [UDTPARTYCODE],        
 @TCLIENT [UDTPARTYCODE],        
 @INSTNO [UDTINSTNO],        
 @INSTAMT VARCHAR(18),        
 @SHOWSIDE VARCHAR(2),        
 @SORTON VARCHAR(5),      
 @REPORT_FLAG CHAR(1) = 'N',      
 @EXCHANGE VARCHAR(10),      
 @SEGMENT VARCHAR(15)        
)        
--WITH ENCRYPTION    
AS        
/*        
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'        
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'        
*/        
DECLARE @SQL VARCHAR(MAX)        
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
 BEGIN        
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
 END        
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
 BEGIN        
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
 END        
IF ISNUMERIC(@INSTAMT) = 0        
 BEGIN        
  SET @INSTAMT = 0        
 END        
        
CREATE TABLE #MASTERSNOS        
(        
 MASTERSNO BIGINT,      
 AMT MONEY      
)        
        
SET @SQL = ""        
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "        
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "        
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "      
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "        
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "      
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "        
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "        
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "        
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "    
SET @SQL = @SQL + "AND VTYPE <> 18 "        
IF @SELECTON = 'VD'        
 BEGIN        
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
ELSE IF @SELECTON = 'RD'        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "    
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "    
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "        
 END        
IF @EDITRECO = 1        
 BEGIN        
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
 END        
ELSE       
BEGIN       
 IF @REPORT_FLAG = 'Y'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT >= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT >= '" + @TDATE + " 23:59')  "        
 END      
 ELSE      
 BEGIN        
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "        
 END      
 END        
PRINT @SQL        
EXEC (@SQL)        

        
CREATE TABLE #RECODATA        
(        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 BRANCHCODE VARCHAR(10),        
 CLTCODE VARCHAR(10),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 RELAMT MONEY,        
 VDT VARCHAR(10),        
 VNO VARCHAR(12),        
 VTYPE SMALLINT,      
 BOOKTYPE VARCHAR(2),        
 RELDT VARCHAR(10),        
 SHORTDESC VARCHAR(35),        
 L1_SNO BIGINT,        
 ROWSTATE BIT,       
 SRNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#RECODATA',       
 'EXCHANGE|SEGMENT',       
 'UDTEXCHANGE|UDTSEGMENT',       
 '',       
 '0|0' 
 
 
 
    
      
   print @EDITRECO     
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,        
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT)        
SELECT         
 ACNAME = '',        
 DRCR = '',        
 BRANCHCODE = '',        
 CLTCODE = '',        
 DDNO = T4.INSTNO,        
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),        
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),        
 VNO = T1.VNO,        
 VTYPE = T1.VTYPE,        
 BOOKTYPE = T1.BOOKTYPE,        
 --RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,        
 RELDT =  CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END ,        
 SHORTDESC = V.SHORTDESC,        
 L1_SNO = T1.SNO,        
 ROWSTATE = 1,      
 EXCHANGE,      
 SEGMENT        
FROM        
 ACC_TBL1 T1,        
 ACC_TBL4 T4,        
 VMAST V,        
 #MASTERSNOS M        
WHERE        
 T1.SNO = M.MASTERSNO        
 AND T1.SNO = T4.MASTERSNO      
 AND T1.VTYPE = V.VTYPE      
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END 
 ----AND (T4.CR_RELDT ='' AND  DR_RELDT='') 
 --AND (T4.CR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE T4.CR_RELDT END AND DR_RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE DR_RELDT END)    

--select *from #RECODATA
----RETURN
      
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL2 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
UPDATE #RECODATA        
SET        
 ACNAME = T.ACNAME,        
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,        
 BRANCHCODE = T.BRANCHCODE,        
 CLTCODE = T.CLTCODE        
FROM        
 ACC_TBL3 T        
WHERE        
 #RECODATA.L1_SNO = T.MASTERSNO        
 AND T.CLTCODE <> @BANKCODE        
        
IF @REPORT_FLAG = 'N'      
BEGIN   
print 'suresh'   
SELECT        
 ACNAME,        
 DRCR,        
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO        
END      
ELSE      
BEGIN      
SELECT        
 ACNAME,        
 DRCR,        
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,      
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,      
 BRANCHCODE,        
 CLTCODE,   DDNO,        
 DDDT,        
 RELAMT,        
 VDT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 RELDT,        
 SHORTDESC,        
 L1_SNO,        
 ROWSTATE,      
 RELDT,      
 EXCHANGE,      
 SEGMENT,      
 REFNO = 0        
FROM        
 #RECODATA        
ORDER BY        
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,        
 DRCR,      
 CONVERT(DATETIME, VDT, 103),        
 VTYPE,        
 VNO   
END      
/*        
SQL = ""        
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "        
SQL = SQL & "SELECT "        
SQL = SQL & " ACNAME, "        
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "        
SQL = SQL & " A.BRANCHCODE, "        
SQL = SQL & " A.CLTCODE, "        
SQL = SQL & " DDNO = INSTNO, "        
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "        
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "        
SQL = SQL & " VNO, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " A.BOOKTYPE, "        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "        
Else        
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "        
End If        
SQL = SQL & " SHORTDESC, "        
SQL = SQL & " L1_SNO = MASTERSNO, "        
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "        
SQL = SQL & "FROM "        
SQL = SQL & " ACC_LEDGER A, "        
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "        
SQL = SQL & " VMAST V "        
SQL = SQL & "WHERE "        
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "        
If Request("cmbSelect") = "VD" Then        
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "        
End If        
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "        
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "        
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "        
If Request("cmbSelect") = "RD" Then        
 SQL = SQL & " AND "        
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " ) OR "        
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "        
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "        
 SQL = SQL & " )) "        
End If        
If UCase(Request("Checkbox1")) = "ON" Then        
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "        
Else        
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "        
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "        
End If        
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then        
 Dim txtBranch        
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)        
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "        
End If        
If Trim(Request("ClientCodeFr")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "        
End If        
If Trim(Request("ClientCodeTo")) <> "" Then        
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "        
End If        
If Trim(Request("ChqNoToDisp")) <> "" Then        
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "        
End If        
If Trim(Request("AmountToDisp")) <> "" Then        
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "        
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "        
End If        
SQL = SQL & " AND A.VTYPE = V.VTYPE "        
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "        
If Request("cmbDrCr") = "DR" Then        
 SQL = SQL & " AND DR_RELAMT > 0 "        
ElseIf Request("cmbDrCr") = "CR" Then        
 SQL = SQL & " AND CR_RELAMT > 0 "        
End If        
SQL = SQL & "ORDER BY "        
If trim(request("cmbSort")) = "Amount" Then        
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "        
ElseIf trim(request("cmbSort")) = "ddno" Then        
 SQL = SQL + " INSTNO, "        
ElseIf trim(request("cmbSort")) = "Party Code" Then        
 SQL = SQL + " CLTCODE, "        
End If        
SQL = SQL & " VDT, "        
SQL = SQL & " A.VTYPE, "        
SQL = SQL & " VNO "        
        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANKRECODISPLAY_suresh
-- --------------------------------------------------
--EXEC BANKRECODISPLAY 'GB001', '', 'Apr  6 2011', 0,'VD', '', '0', 'z', '', '', '', 'A', 'Y','BSE','MFSS'  
--EXEC BANKRECODISPLAY '001458', 'Feb  1 2010', 'Mar 22 2010', 0,'VD', '', '0', 'z', '', '', '', 'A'    
CREATE  PROC [dbo].[BANKRECODISPLAY_suresh]      
(      
 @BANKCODE [UDTPARTYCODE],      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @EDITRECO BIT,      
 @SELECTON VARCHAR(2),      
 @BRANCHCODE [UDTBRANCHCODE],      
 @FCLIENT [UDTPARTYCODE],      
 @TCLIENT [UDTPARTYCODE],      
 @INSTNO [UDTINSTNO],      
 @INSTAMT VARCHAR(18),      
 @SHOWSIDE VARCHAR(2),      
 @SORTON VARCHAR(5),    
 @REPORT_FLAG CHAR(1) = 'N',    
 @EXCHANGE VARCHAR(10),    
 @SEGMENT VARCHAR(15)      
)      
--WITH ENCRYPTION  
AS      
/*      
 EXEC BANKRECODISPLAY '001458', 'APR  1 2009', 'MAR  2 2010', 0, 'VD', '', '', '', '', '5000', '', 'A'      
 EXEC BANKRECODISPLAY 'bank01', 'Feb  1 2010', 'Mar  2 2010', 0,'VD', '', '', '', '', '', '', 'A'      
*/      
DECLARE @SQL VARCHAR(MAX)      
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0      
 BEGIN      
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)      
 END      
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0      
 BEGIN      
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)      
 END      
IF ISNUMERIC(@INSTAMT) = 0      
 BEGIN      
  SET @INSTAMT = 0      
 END      
      
CREATE TABLE #MASTERSNOS      
(      
 MASTERSNO BIGINT,    
 AMT MONEY    
)      
      
SET @SQL = ""      
SET @SQL = @SQL + "INSERT INTO #MASTERSNOS (MASTERSNO, AMT) "      
SET @SQL = @SQL + "SELECT DISTINCT MASTERSNO, AMT = CASE WHEN VTYPE = 5 THEN (DRAMOUNT-CRAMOUNT) ELSE 0 END FROM ACC_LEDGER "      
SET @SQL = @SQL + "WHERE OPPACCOUNT = '" + @BANKCODE + "' "    
SET @SQL = @SQL + "AND EXCHANGE = '" + @EXCHANGE + "' "      
SET @SQL = @SQL + "AND SEGMENT = '" + @SEGMENT + "' "    
SET @SQL = @SQL + "AND ENTRY_AMT = CASE WHEN " + @INSTAMT + " > 0 THEN " + @INSTAMT + " ELSE ENTRY_AMT END "      
SET @SQL = @SQL + "AND BRANCHCODE = CASE WHEN '" + @BRANCHCODE + "' = '' OR '" + @BRANCHCODE + "' = 'ALL' THEN BRANCHCODE ELSE '" + @BRANCHCODE + "' END "      
SET @SQL = @SQL + "AND CLTCODE BETWEEN CASE WHEN '" + @FCLIENT + "' = '' THEN '0' ELSE '" + @FCLIENT + "' END AND CASE WHEN '" + @TCLIENT + "' = '' THEN 'ZZZZZZZZZZ' ELSE '" + @TCLIENT + "' END "      
SET @SQL = @SQL + "AND INSTNO = CASE WHEN '" + @INSTNO + "' = '' THEN INSTNO ELSE '" + @INSTNO + "' END "  
SET @SQL = @SQL + "AND VTYPE <> 18 "      
IF @SELECTON = 'VD'      
 BEGIN      
  SET @SQL = @SQL + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "      
 END      
ELSE IF @SELECTON = 'RD'      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "  
  SET @SQL = @SQL + "OR CR_RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59') "  
--  SET @SQL = @SQL + "AND INSTDATE BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59' "      
 END      
IF @EDITRECO = 1      
 BEGIN      
  SET @SQL = @SQL + "AND (DR_RELDT NOT LIKE 'JAN  1 1900%' OR CR_RELDT NOT LIKE 'JAN  1 1900%') "      
 END      
ELSE     
BEGIN     
 IF @REPORT_FLAG = 'Y'    
 BEGIN    
  SET @SQL = @SQL + "AND (DR_RELDT LIKE 'JAN  1 1900%' OR DR_RELDT <= '" + @TDATE + " 23:59') AND (CR_RELDT LIKE 'JAN  1 1900%'  OR CR_RELDT <= '" + @TDATE + " 23:59')"      
 END    
 ELSE    
 BEGIN      
  SET @SQL = @SQL + "AND DR_RELDT LIKE 'JAN  1 1900%' AND CR_RELDT LIKE 'JAN  1 1900%' "      
 END    
 END      
PRINT @SQL      
EXEC (@SQL)      
SELECT * FROM #MASTERSNOS      
return 
      
CREATE TABLE #RECODATA      
(      
 ACNAME VARCHAR(100),      
 DRCR VARCHAR(1),      
 BRANCHCODE VARCHAR(10),      
 CLTCODE VARCHAR(10),      
 DDNO VARCHAR(15),      
 DDDT VARCHAR(10),      
 RELAMT MONEY,      
 VDT VARCHAR(10),      
 VNO VARCHAR(12),      
 VTYPE SMALLINT,    
 BOOKTYPE VARCHAR(2),      
 RELDT VARCHAR(10),      
 SHORTDESC VARCHAR(35),      
 L1_SNO BIGINT,      
 ROWSTATE BIT,     
 SRNO INT IDENTITY(1,1)      
)      
    
EXEC MAKE_UDT_STRUCTURE     
 '#RECODATA',     
 'EXCHANGE|SEGMENT',     
 'UDTEXCHANGE|UDTSEGMENT',     
 '',     
 '0|0'    
    
      
INSERT INTO #RECODATA (ACNAME, DRCR, BRANCHCODE, CLTCODE, DDNO, DDDT, RELAMT,      
VDT, VNO, VTYPE, BOOKTYPE, RELDT, SHORTDESC, L1_SNO, ROWSTATE, EXCHANGE, SEGMENT)      
SELECT       
 ACNAME = '',      
 DRCR = '',      
 BRANCHCODE = '',      
 CLTCODE = '',      
 DDNO = T4.INSTNO,      
 DDDT = CONVERT(VARCHAR(10), INSTDATE, 103),      
 RELAMT = T1.ENTRY_AMT, VDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), T1.VDT), 112), 103),      
 VNO = T1.VNO,      
 VTYPE = T1.VTYPE,      
 BOOKTYPE = T1.BOOKTYPE,      
 RELDT = CASE WHEN @EDITRECO = 0 THEN '' ELSE CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END END,      
 SHORTDESC = V.SHORTDESC,      
 L1_SNO = T1.SNO,      
 ROWSTATE = 1,    
 EXCHANGE,    
 SEGMENT      
FROM      
 ACC_TBL1 T1,      
 ACC_TBL4 T4,      
 VMAST V,      
 #MASTERSNOS M      
WHERE      
 T1.SNO = M.MASTERSNO      
 AND T1.SNO = T4.MASTERSNO    
 AND T1.VTYPE = V.VTYPE    
 AND ABS(M.AMT) = CASE WHEN T1.VTYPE = 5 THEN CASE WHEN M.AMT > 0 THEN CR_RELAMT ELSE DR_RELAMT END ELSE 0 END    
    
UPDATE #RECODATA      
SET      
 ACNAME = T.ACNAME,      
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,      
 BRANCHCODE = T.BRANCHCODE,      
 CLTCODE = T.CLTCODE      
FROM      
 ACC_TBL2 T      
WHERE      
 #RECODATA.L1_SNO = T.MASTERSNO      
 AND T.CLTCODE <> @BANKCODE      
      
UPDATE #RECODATA      
SET      
 ACNAME = T.ACNAME,      
 DRCR = CASE WHEN T.DRAMOUNT > 0 THEN 'D' ELSE 'C' END,      
 BRANCHCODE = T.BRANCHCODE,      
 CLTCODE = T.CLTCODE      
FROM      
 ACC_TBL3 T      
WHERE      
 #RECODATA.L1_SNO = T.MASTERSNO      
 AND T.CLTCODE <> @BANKCODE      
      
IF @REPORT_FLAG = 'N'    
BEGIN    
SELECT      
 ACNAME,      
 DRCR,      
 BRANCHCODE,      
 CLTCODE,   DDNO,      
 DDDT,      
 RELAMT,      
 VDT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 RELDT,      
 SHORTDESC,      
 L1_SNO,      
 ROWSTATE      
FROM      
 #RECODATA      
ORDER BY      
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,      
 DRCR,    
 CONVERT(DATETIME, VDT, 103),      
 VTYPE,      
 VNO      
END    
ELSE    
BEGIN    
SELECT      
 ACNAME,      
 DRCR,      
 DRAMT = CASE WHEN DRCR = 'D' THEN RELAMT ELSE 0 END,    
 CRAMT = CASE WHEN DRCR = 'C' THEN RELAMT ELSE 0 END,    
 BRANCHCODE,      
 CLTCODE,   DDNO,      
 DDDT,      
 RELAMT,      
 VDT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 RELDT,      
 SHORTDESC,      
 L1_SNO,      
 ROWSTATE,    
 RELDT,    
 EXCHANGE,    
 SEGMENT,    
 REFNO = 0      
FROM      
 #RECODATA      
ORDER BY      
 --CASE WHEN @SORTON = 'A' THEN RELAMT ELSE CASE WHEN @SORTON = 'P' THEN CLTCODE ELSE DDNO END END,      
 DRCR,    
 CONVERT(DATETIME, VDT, 103),      
 VTYPE,      
 VNO      
END    
/*      
SQL = ""      
SQL = SQL & "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "      
SQL = SQL & "SELECT "      
SQL = SQL & " ACNAME, "      
SQL = SQL & " DRCR = CASE WHEN DR_RELAMT > 0 THEN 'D' ELSE 'C' END, "      
SQL = SQL & " A.BRANCHCODE, "      
SQL = SQL & " A.CLTCODE, "      
SQL = SQL & " DDNO = INSTNO, "      
SQL = SQL & " DDDT = CONVERT(VARCHAR(10), INSTDATE, 103), "      
SQL = SQL & " RELAMT = CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "      
SQL = SQL & " VDT = CONVERT(VARCHAR(10), VDT, 103), "      
SQL = SQL & " VNO, "      
SQL = SQL & " A.VTYPE, "      
SQL = SQL & " A.BOOKTYPE, "      
If UCase(Request("Checkbox1")) = "ON" Then      
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN CONVERT(VARCHAR(10), DR_RELDT, 103) ELSE CONVERT(VARCHAR(10), CR_RELDT, 103) END, "      
Else      
 SQL = SQL & " RELDT = CASE WHEN DR_RELAMT > 0 THEN DR_RELDT ELSE CR_RELDT END, "      
End If      
SQL = SQL & " SHORTDESC, "      
SQL = SQL & " L1_SNO = MASTERSNO, "      
SQL = SQL & " ROWSTATE = 1, --ISNULL(ROWSTATE, 1) "      
SQL = SQL & "FROM "      
SQL = SQL & " ACC_LEDGER A, "      
SQL = SQL & " --V2_OFFLINE_LEDGER_ENTRIES O, "      
SQL = SQL & " VMAST V "      
SQL = SQL & "WHERE "      
SQL = SQL & " A.VTYPE IN ( '2','3' ,'5', '19','17', '20') "      
If Request("cmbSelect") = "VD" Then      
 SQL = SQL & " AND VDT >= '" & vdateFr & " 00:00:00' "      
 SQL = SQL & " AND VDT <= '" & vdateTo & " 23:59:59' "      
End If      
SQL = SQL & " --AND A.MASTERSNO = O.RESERVED1 "      
SQL = SQL & " AND OPPACCOUNT = '" & CStr(Trim(Request("BankCode"))) & "' "      
SQL = SQL & " AND A.CLTCODE <> '" & CStr(Trim(Request("BankCode"))) & "' "      
If Request("cmbSelect") = "RD" Then      
 SQL = SQL & " AND "      
 SQL = SQL & " ((DR_RELDT >= '" & vdateFr & " 00:00:00' "      
 SQL = SQL & " AND DR_RELDT <= '" & vdateTo & " 23:59:59' "      
 SQL = SQL & " ) OR "      
 SQL = SQL & " (CR_RELDT >= '" & vdateFr & " 00:00:00' "      
 SQL = SQL & " AND CR_RELDT <= '" & vdateTo & " 23:59:59' "      
 SQL = SQL & " )) "      
End If      
If UCase(Request("Checkbox1")) = "ON" Then      
 SQL = SQL & " AND (DR_RELDT NOT LIKE 'JAN  1 1900%' "      
 SQL = SQL & " OR CR_RELDT NOT LIKE 'JAN  1 1900%') "      
Else      
 SQL = SQL & " AND DR_RELDT LIKE 'JAN  1 1900%' "      
 SQL = SQL & " AND CR_RELDT LIKE 'JAN  1 1900%' "      
End If      
If Trim(Request("cmbBranch")) <> "" And Request("cmbBranch") <> "ALL" Then      
 Dim txtBranch      
 txtBranch = Split(Trim(Request("cmbBranch")), "~|~") (0)      
 SQL = SQL & " AND A.BRANCHCODE = '" & txtBranch & "' "      
End If      
If Trim(Request("ClientCodeFr")) <> "" Then      
 SQL = SQL & " AND A.CLTCODE >= '" & CStr(Trim(Request("ClientCodeFr"))) & "' "      
End If      
If Trim(Request("ClientCodeTo")) <> "" Then      
 SQL = SQL & " AND A.CLTCODE <= '" & CStr(Trim(Request("ClientCodeTo"))) & "' "      
End If      
If Trim(Request("ChqNoToDisp")) <> "" Then      
 SQL = SQL & " AND INSTNO = '" & CStr(Trim(Request("ChqNoToDisp"))) & "' "      
End If      
If Trim(Request("AmountToDisp")) <> "" Then      
 SQL = SQL & " AND (DR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & " OR "      
 SQL = SQL & " CR_RELAMT = " & CStr(Replace(Trim(Request("AmountToDisp")), ",", "")) & ") "      
End If      
SQL = SQL & " AND A.VTYPE = V.VTYPE "      
SQL = SQL & " AND UPPER(CLEARMODE) <> 'C' "      
If Request("cmbDrCr") = "DR" Then      
 SQL = SQL & " AND DR_RELAMT > 0 "      
ElseIf Request("cmbDrCr") = "CR" Then      
 SQL = SQL & " AND CR_RELAMT > 0 "      
End If      
SQL = SQL & "ORDER BY "      
If trim(request("cmbSort")) = "Amount" Then      
 SQL = SQL + " CASE WHEN DR_RELAMT > 0 THEN DR_RELAMT ELSE CR_RELAMT END, "      
ElseIf trim(request("cmbSort")) = "ddno" Then      
 SQL = SQL + " INSTNO, "      
ElseIf trim(request("cmbSort")) = "Party Code" Then      
 SQL = SQL + " CLTCODE, "      
End If      
SQL = SQL & " VDT, "      
SQL = SQL & " A.VTYPE, "      
SQL = SQL & " VNO "      
      
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBO_FA_YEAREND
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT
-- --------------------------------------------------






--EXEC BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT 'APR  1 2016', 'APR  2 2016', '000', 'ZZZ', 'ACCODE', 'VDT', '', 0, '', '', '', '', 'BROKER', 'BROKER', '', 'NSE-CAPITAL'
CREATE PROCEDURE [dbo].[BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT]          
(          
 @FDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE   VARCHAR(10), --FCLTCODE           
 @TCODE   VARCHAR(10),                      
 @STRORDER  VARCHAR(6),                      
 @SELECTBY  VARCHAR(3),  --TRANON = V OR E               
 @CLTYPE  VARCHAR(3),          
 @MASTERSNO  BIGINT,          
 @SETT_NO  VARCHAR(7),          
 @SETT_TYPE  VARCHAR(3),          
 @VTYPE   SMALLINT,          
 @BOOKTYPE  VARCHAR(2),          
 @STATUSID  VARCHAR(15),                      
 @STATUSNAME VARCHAR(15),                      
 @STRBRANCH  VARCHAR(10),          
 @SEG_EXCH  VARCHAR(MAX)          
)          
          
AS 

IF @STRBRANCH <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @STRBRANCH
END         
          
CREATE TABLE #TEMP          
(          
 EXCHANGE   VARCHAR(10),          
 SEGMENT    VARCHAR(10),          
 VNO     VARCHAR(12),          
 VTYPE    SMALLINT,          
 BOOKTYPE   VARCHAR(2),          
 VDT     DATETIME,          
 EDT     DATETIME,          
 MASTERSNO   BIGINT,          
 SETT_NO    VARCHAR(7),          
 SETT_TYPE   VARCHAR(3),          
 DRAMOUNT   NUMERIC(18, 2),          
 CRAMOUNT   NUMERIC(18, 2),          
 CLTCODE    VARCHAR(10),          
 ACNAME    VARCHAR(100),          
 ACCAT    VARCHAR(10),          
 MARGINLEDGERCODE VARCHAR(10),          
 MARGINLEDGERNAME VARCHAR(100),          
 NARRATION   VARCHAR(234),          
 BRANCHCODE   VARCHAR(10),          
 OPPACCOUNT   VARCHAR(10),          
 BNKNAME    VARCHAR(35),          
 BRNNAME    VARCHAR(20),          
 CHQDD    VARCHAR(1),          
 INSTNO    VARCHAR(15),          
 INSTDATE   DATETIME,          
 RELDT    DATETIME,          
 REFNO    VARCHAR(12),          
 MICR    BIGINT,          
 CHQINNAME   VARCHAR(100),          
 CHQPRINTED   INT,          
 CLEARMODE   VARCHAR(1),          
 VDESC    VARCHAR(35),          
 SHORTDESC   VARCHAR(6),          
 NODAYS    VARCHAR(20),          
 POSTED_ON   VARCHAR(50),          
 L_ADDRESS1   VARCHAR (40),                      
 L_ADDRESS2   VARCHAR (40),                      
 L_ADDRESS3   VARCHAR (40) ,                      
 L_CITY    VARCHAR (40),                      
 L_ZIP    VARCHAR (10),                      
 RES_PHONE1   VARCHAR (15),                      
 BRANCH_CD   VARCHAR (10),            
 FAMILY    VARCHAR (10),                      
 SUB_BROKER   VARCHAR (10),                      
 TRADER    VARCHAR (20),                      
 CL_TYPE    VARCHAR (3),                      
 BANK_NAME   VARCHAR (100),                      
 CLTDPID    VARCHAR (30),                      
 EDIFF    INT, --= DATEDIFF(D, VDT, GETDATE()          
 LNO     INT , ---= 1          
 ORDERSEG   BIGINT,--- = 15          
OPBAL MONEY    
          
          
)          
  
         

/*
INSERT INTO #TEMP(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, EDT, MASTERSNO, SETT_NO,          
        SETT_TYPE, DRAMOUNT, CRAMOUNT, CLTCODE, ACNAME, ACCAT, MARGINLEDGERCODE,          
        MARGINLEDGERNAME, NARRATION, BRANCHCODE, OPPACCOUNT, BNKNAME, BRNNAME,          
        CHQDD, INSTNO, INSTDATE, RELDT, REFNO, MICR, CHQINNAME, CHQPRINTED,          
        CLEARMODE, VDESC, SHORTDESC, NODAYS,POSTED_ON, OPBAL, EDIFF,LNO, ORDERSEG          
       )          
*/


SELECT *,          
  EDIFF = DATEDIFF(D, EDT, GETDATE()),           
  LNO = 1,          
  ORDERSEG =15   
  into #TEMP1       
  FROM  .DBO.BBO_TRANSACTIONS_CLIENTS(@FDATE, @TDATE, @FCODE, @TCODE, @SELECTBY, @CLTYPE, @MASTERSNO , @SETT_NO, @SETT_TYPE, @VTYPE, @BOOKTYPE, @STATUSID,@STATUSNAME, @SEG_EXCH, 'S') L          
 

alter table #TEMP1 add L_ADDRESS1   VARCHAR (40)                      
alter table #TEMP1 add L_ADDRESS2   VARCHAR (40)                      
alter table #TEMP1 add  L_ADDRESS3   VARCHAR (40)                     
alter table #TEMP1 add  L_CITY    VARCHAR (40)                      
alter table #TEMP1 add L_ZIP    VARCHAR (10)                      
alter table #TEMP1 add  RES_PHONE1   VARCHAR (15)                    
alter table #TEMP1 add  BRANCH_CD   VARCHAR (10)            
alter table #TEMP1 add  FAMILY    VARCHAR (10)                     
alter table #TEMP1 add  SUB_BROKER   VARCHAR (10)
alter table #TEMP1 add  TRADER    VARCHAR (20)                     
alter table #TEMP1 add  CL_TYPE    VARCHAR (3)                      
alter table #TEMP1 add  BANK_NAME   VARCHAR (100)                      
alter table #TEMP1 add  CLTDPID    VARCHAR (30)
alter table #TEMP1 add  OPBAL MONEY   
                   
 
UPDATE #TEMP1         
          
 SET          
  L_ADDRESS1 = A.ADDR1,          
  L_ADDRESS2 = A.ADDR2,       L_ADDRESS3 = A.ADDR3,          
  L_CITY    = A.CITY,          
  L_ZIP    = A.ZIP,          
  RES_PHONE1 = A.RES_PHONE,          
  BRANCH_CD  = A.BRANCH_CD,          
  FAMILY    = A.FAMILY,          
  SUB_BROKER = A.SUB_BROKER,          
  TRADER    = A.TRADER,      
  CL_TYPE    = A.CL_TYPE,          
  BANK_NAME  = A.BANK_NAME,          
  CLTDPID    = A.CLTDPID          
            
  FROM CLIENT_DETAILS A          
            
  WHERE           
  #TEMP1.CLTCODE = A.PARTY_CODE   
  
CREATE TABLE #GET_OPBAL  
(
	CLTCODE VARCHAR(10),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	BALANCE MONEY
)

INSERT INTO  #GET_OPBAL   
SELECT CLTCODE, EXCHANGE, SEGMENT, BALANCE FROM .DBO.BBO_SETT_BALANCE_CLIENTS_MFSS(@FDATE, @FCODE, @TCODE, 'O', 'V', 'Y', '', @STATUSID,@STATUSNAME, @SEG_EXCH)
 
UPDATE T SET OPBAL = BALANCE FROM
#TEMP1 T, #GET_OPBAL O
WHERE T.CLTCODE =  O.CLTCODE AND T.EXCHANGE = O.EXCHANGE AND T.SEGMENT = O.SEGMENT         
           
SELECT BOOKTYPE,VOUDT=VDT,EFFDT=EDT,SHORTDESC,DRAMOUNT,CRAMOUNT,VNO,DDNO='',NARRATION,CLTCODE,                      
VTYPE,VDT=CONVERT(VARCHAR(10), VDT, 103),EDT=CONVERT(VARCHAR(10), EDT, 103),ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,                      
CROSAC=OPPACCOUNT,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, POSTED_ON 
FROM #TEMP1 
where EXCHANGE = LEFT(@SEG_EXCH,3)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT_03032017
-- --------------------------------------------------





--EXEC BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT 'APR  1 2016', 'APR  2 2016', '000', 'ZZZ', 'ACCODE', 'VDT', '', 0, '', '', '', '', 'BROKER', 'BROKER', '', 'NSE-CAPITAL'
CREATE PROCEDURE [dbo].[BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT]          
(          
 @FDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE   VARCHAR(10), --FCLTCODE           
 @TCODE   VARCHAR(10),                      
 @STRORDER  VARCHAR(6),                      
 @SELECTBY  VARCHAR(3),  --TRANON = V OR E               
 @CLTYPE  VARCHAR(3),          
 @MASTERSNO  BIGINT,          
 @SETT_NO  VARCHAR(7),          
 @SETT_TYPE  VARCHAR(3),          
 @VTYPE   SMALLINT,          
 @BOOKTYPE  VARCHAR(2),          
 @STATUSID  VARCHAR(15),                      
 @STATUSNAME VARCHAR(15),                      
 @STRBRANCH  VARCHAR(10),          
 @SEG_EXCH  VARCHAR(MAX)          
)          
          
AS 

IF @STRBRANCH <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @STRBRANCH
END         
          
CREATE TABLE #TEMP          
(          
 EXCHANGE   VARCHAR(10),          
 SEGMENT    VARCHAR(10),          
 VNO     VARCHAR(12),          
 VTYPE    SMALLINT,          
 BOOKTYPE   VARCHAR(2),          
 VDT     DATETIME,          
 EDT     DATETIME,          
 MASTERSNO   BIGINT,          
 SETT_NO    VARCHAR(7),          
 SETT_TYPE   VARCHAR(3),          
 DRAMOUNT   NUMERIC(18, 2),          
 CRAMOUNT   NUMERIC(18, 2),          
 CLTCODE    VARCHAR(10),          
 ACNAME    VARCHAR(100),          
 ACCAT    VARCHAR(10),          
 MARGINLEDGERCODE VARCHAR(10),          
 MARGINLEDGERNAME VARCHAR(100),          
 NARRATION   VARCHAR(234),          
 BRANCHCODE   VARCHAR(10),          
 OPPACCOUNT   VARCHAR(10),          
 BNKNAME    VARCHAR(35),          
 BRNNAME    VARCHAR(20),          
 CHQDD    VARCHAR(1),          
 INSTNO    VARCHAR(15),          
 INSTDATE   DATETIME,          
 RELDT    DATETIME,          
 REFNO    VARCHAR(12),          
 MICR    BIGINT,          
 CHQINNAME   VARCHAR(100),          
 CHQPRINTED   INT,          
 CLEARMODE   VARCHAR(1),          
 VDESC    VARCHAR(35),          
 SHORTDESC   VARCHAR(6),          
 NODAYS    VARCHAR(20),          
 POSTED_ON   VARCHAR(50),          
 L_ADDRESS1   VARCHAR (40),                      
 L_ADDRESS2   VARCHAR (40),                      
 L_ADDRESS3   VARCHAR (40) ,                      
 L_CITY    VARCHAR (40),                      
 L_ZIP    VARCHAR (10),                      
 RES_PHONE1   VARCHAR (15),                      
 BRANCH_CD   VARCHAR (10),            
 FAMILY    VARCHAR (10),                      
 SUB_BROKER   VARCHAR (10),                      
 TRADER    VARCHAR (20),                      
 CL_TYPE    VARCHAR (3),                      
 BANK_NAME   VARCHAR (100),                      
 CLTDPID    VARCHAR (30),                      
 EDIFF    INT, --= DATEDIFF(D, VDT, GETDATE()          
 LNO     INT , ---= 1          
 ORDERSEG   BIGINT,--- = 15          
OPBAL MONEY    
          
          
)          
  
         

/*
INSERT INTO #TEMP(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, EDT, MASTERSNO, SETT_NO,          
        SETT_TYPE, DRAMOUNT, CRAMOUNT, CLTCODE, ACNAME, ACCAT, MARGINLEDGERCODE,          
        MARGINLEDGERNAME, NARRATION, BRANCHCODE, OPPACCOUNT, BNKNAME, BRNNAME,          
        CHQDD, INSTNO, INSTDATE, RELDT, REFNO, MICR, CHQINNAME, CHQPRINTED,          
        CLEARMODE, VDESC, SHORTDESC, NODAYS,POSTED_ON, OPBAL, EDIFF,LNO, ORDERSEG          
       )          
*/


SELECT *,          
  EDIFF = DATEDIFF(D, EDT, GETDATE()),           
  LNO = 1,          
  ORDERSEG =15   
  into #TEMP1       
  FROM  .DBO.BBO_TRANSACTIONS_CLIENTS(@FDATE, @TDATE, @FCODE, @TCODE, @SELECTBY, @CLTYPE, @MASTERSNO , @SETT_NO, @SETT_TYPE, @VTYPE, @BOOKTYPE, @STATUSID,@STATUSNAME, @SEG_EXCH, 'S') L          
 

alter table #TEMP1 add L_ADDRESS1   VARCHAR (40)                      
alter table #TEMP1 add L_ADDRESS2   VARCHAR (40)                      
alter table #TEMP1 add  L_ADDRESS3   VARCHAR (40)                     
alter table #TEMP1 add  L_CITY    VARCHAR (40)                      
alter table #TEMP1 add L_ZIP    VARCHAR (10)                      
alter table #TEMP1 add  RES_PHONE1   VARCHAR (15)                    
alter table #TEMP1 add  BRANCH_CD   VARCHAR (10)            
alter table #TEMP1 add  FAMILY    VARCHAR (10)                     
alter table #TEMP1 add  SUB_BROKER   VARCHAR (10)
alter table #TEMP1 add  TRADER    VARCHAR (20)                     
alter table #TEMP1 add  CL_TYPE    VARCHAR (3)                      
alter table #TEMP1 add  BANK_NAME   VARCHAR (100)                      
alter table #TEMP1 add  CLTDPID    VARCHAR (30)
alter table #TEMP1 add  OPBAL MONEY   
                   
 
UPDATE #TEMP1         
          
 SET          
  L_ADDRESS1 = A.ADDR1,          
  L_ADDRESS2 = A.ADDR2,       L_ADDRESS3 = A.ADDR3,          
  L_CITY    = A.CITY,          
  L_ZIP    = A.ZIP,          
  RES_PHONE1 = A.RES_PHONE,          
  BRANCH_CD  = A.BRANCH_CD,          
  FAMILY    = A.FAMILY,          
  SUB_BROKER = A.SUB_BROKER,          
  TRADER    = A.TRADER,      
  CL_TYPE    = A.CL_TYPE,          
  BANK_NAME  = A.BANK_NAME,          
  CLTDPID    = A.CLTDPID          
            
  FROM CLIENT_DETAILS A          
            
  WHERE           
  #TEMP1.CLTCODE = A.PARTY_CODE   
  
CREATE TABLE #GET_OPBAL  
(
	CLTCODE VARCHAR(10),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	BALANCE MONEY
)

INSERT INTO  #GET_OPBAL   
SELECT CLTCODE, EXCHANGE, SEGMENT, BALANCE FROM .DBO.BBO_SETT_BALANCE_CLIENTS(@TDATE, @FCODE, @TCODE, 'O', 'V', 'Y', '', @STATUSID,@STATUSNAME, @SEG_EXCH)
 
UPDATE T SET OPBAL = BALANCE FROM
#TEMP1 T, #GET_OPBAL O
WHERE T.CLTCODE =  O.CLTCODE AND T.EXCHANGE = O.EXCHANGE AND T.SEGMENT = O.SEGMENT         
           
SELECT BOOKTYPE,VOUDT=VDT,EFFDT=EDT,SHORTDESC,DRAMOUNT,CRAMOUNT,VNO,DDNO='',NARRATION,CLTCODE,                      
VTYPE,VDT=CONVERT(VARCHAR(10), VDT, 103),EDT=CONVERT(VARCHAR(10), EDT, 103),ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,                      
CROSAC=OPPACCOUNT,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, POSTED_ON 
FROM #TEMP1 
where EXCHANGE = LEFT(@SEG_EXCH,3)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT_bak_10022017
-- --------------------------------------------------





--EXEC BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT 'APR  1 2016', 'APR  2 2016', '000', 'ZZZ', 'ACCODE', 'VDT', '', 0, '', '', '', '', 'BROKER', 'BROKER', '', 'NSE-CAPITAL'
CREATE PROCEDURE [dbo].[BBO_RPT_ACC_PARTYLEDGER_ALL_FORCLIENT]          
(          
 @FDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE   VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE   VARCHAR(10), --FCLTCODE           
 @TCODE   VARCHAR(10),                      
 @STRORDER  VARCHAR(6),                      
 @SELECTBY  VARCHAR(3),  --TRANON = V OR E               
 @CLTYPE  VARCHAR(3),          
 @MASTERSNO  BIGINT,          
 @SETT_NO  VARCHAR(7),          
 @SETT_TYPE  VARCHAR(3),          
 @VTYPE   SMALLINT,          
 @BOOKTYPE  VARCHAR(2),          
 @STATUSID  VARCHAR(15),                      
 @STATUSNAME VARCHAR(15),                      
 @STRBRANCH  VARCHAR(10),          
 @SEG_EXCH  VARCHAR(MAX)          
)          
          
AS 

IF @STRBRANCH <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @STRBRANCH
END         
          
CREATE TABLE #TEMP          
(          
 EXCHANGE   VARCHAR(10),          
 SEGMENT    VARCHAR(10),          
 VNO     VARCHAR(12),          
 VTYPE    SMALLINT,          
 BOOKTYPE   VARCHAR(2),          
 VDT     DATETIME,          
 EDT     DATETIME,          
 MASTERSNO   BIGINT,          
 SETT_NO    VARCHAR(7),          
 SETT_TYPE   VARCHAR(3),          
 DRAMOUNT   NUMERIC(18, 2),          
 CRAMOUNT   NUMERIC(18, 2),          
 CLTCODE    VARCHAR(10),          
 ACNAME    VARCHAR(100),          
 ACCAT    VARCHAR(10),          
 MARGINLEDGERCODE VARCHAR(10),          
 MARGINLEDGERNAME VARCHAR(100),          
 NARRATION   VARCHAR(234),          
 BRANCHCODE   VARCHAR(10),          
 OPPACCOUNT   VARCHAR(10),          
 BNKNAME    VARCHAR(35),          
 BRNNAME    VARCHAR(20),          
 CHQDD    VARCHAR(1),          
 INSTNO    VARCHAR(15),          
 INSTDATE   DATETIME,          
 RELDT    DATETIME,          
 REFNO    VARCHAR(12),          
 MICR    BIGINT,          
 CHQINNAME   VARCHAR(100),          
 CHQPRINTED   INT,          
 CLEARMODE   VARCHAR(1),          
 VDESC    VARCHAR(35),          
 SHORTDESC   VARCHAR(6),          
 NODAYS    VARCHAR(20),          
 POSTED_ON   VARCHAR(50),          
 L_ADDRESS1   VARCHAR (40),                      
 L_ADDRESS2   VARCHAR (40),                      
 L_ADDRESS3   VARCHAR (40) ,                      
 L_CITY    VARCHAR (40),                      
 L_ZIP    VARCHAR (10),                      
 RES_PHONE1   VARCHAR (15),                      
 BRANCH_CD   VARCHAR (10),            
 FAMILY    VARCHAR (10),                      
 SUB_BROKER   VARCHAR (10),                      
 TRADER    VARCHAR (20),                      
 CL_TYPE    VARCHAR (3),                      
 BANK_NAME   VARCHAR (100),                      
 CLTDPID    VARCHAR (30),                      
 EDIFF    INT, --= DATEDIFF(D, VDT, GETDATE()          
 LNO     INT , ---= 1          
 ORDERSEG   BIGINT,--- = 15          
OPBAL MONEY    
          
          
)          
  
         

/*
INSERT INTO #TEMP(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, EDT, MASTERSNO, SETT_NO,          
        SETT_TYPE, DRAMOUNT, CRAMOUNT, CLTCODE, ACNAME, ACCAT, MARGINLEDGERCODE,          
        MARGINLEDGERNAME, NARRATION, BRANCHCODE, OPPACCOUNT, BNKNAME, BRNNAME,          
        CHQDD, INSTNO, INSTDATE, RELDT, REFNO, MICR, CHQINNAME, CHQPRINTED,          
        CLEARMODE, VDESC, SHORTDESC, NODAYS,POSTED_ON, OPBAL, EDIFF,LNO, ORDERSEG          
       )          
*/


SELECT *,          
  EDIFF = DATEDIFF(D, EDT, GETDATE()),           
  LNO = 1,          
  ORDERSEG =15   
  into #TEMP1       
  FROM  .DBO.BBO_TRANSACTIONS_CLIENTS(@FDATE, @TDATE, @FCODE, @TCODE, @SELECTBY, @CLTYPE, @MASTERSNO , @SETT_NO, @SETT_TYPE, @VTYPE, @BOOKTYPE, @STATUSID,@STATUSNAME, @SEG_EXCH, 'S') L          
 

alter table #TEMP1 add L_ADDRESS1   VARCHAR (40)                      
alter table #TEMP1 add L_ADDRESS2   VARCHAR (40)                      
alter table #TEMP1 add  L_ADDRESS3   VARCHAR (40)                     
alter table #TEMP1 add  L_CITY    VARCHAR (40)                      
alter table #TEMP1 add L_ZIP    VARCHAR (10)                      
alter table #TEMP1 add  RES_PHONE1   VARCHAR (15)                    
alter table #TEMP1 add  BRANCH_CD   VARCHAR (10)            
alter table #TEMP1 add  FAMILY    VARCHAR (10)                     
alter table #TEMP1 add  SUB_BROKER   VARCHAR (10)
alter table #TEMP1 add  TRADER    VARCHAR (20)                     
alter table #TEMP1 add  CL_TYPE    VARCHAR (3)                      
alter table #TEMP1 add  BANK_NAME   VARCHAR (100)                      
alter table #TEMP1 add  CLTDPID    VARCHAR (30)
alter table #TEMP1 add  OPBAL MONEY   
                   
 
UPDATE #TEMP1         
          
 SET          
  L_ADDRESS1 = A.ADDR1,          
  L_ADDRESS2 = A.ADDR2,       L_ADDRESS3 = A.ADDR3,          
  L_CITY    = A.CITY,          
  L_ZIP    = A.ZIP,          
  RES_PHONE1 = A.RES_PHONE,          
  BRANCH_CD  = A.BRANCH_CD,          
  FAMILY    = A.FAMILY,          
  SUB_BROKER = A.SUB_BROKER,          
  TRADER    = A.TRADER,      
  CL_TYPE    = A.CL_TYPE,          
  BANK_NAME  = A.BANK_NAME,          
  CLTDPID    = A.CLTDPID          
            
  FROM CLIENT_DETAILS A          
            
  WHERE           
  #TEMP1.CLTCODE = A.PARTY_CODE   
  
CREATE TABLE #GET_OPBAL  
(
	CLTCODE VARCHAR(10),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	BALANCE MONEY
)

INSERT INTO  #GET_OPBAL   
SELECT CLTCODE, EXCHANGE, SEGMENT, BALANCE FROM .DBO.BBO_SETT_BALANCE_CLIENTS(@TDATE, @FCODE, @TCODE, 'O', 'V', 'Y', '', @STATUSID,@STATUSNAME, @SEG_EXCH)
 
UPDATE T SET OPBAL = BALANCE FROM
#TEMP1 T, #GET_OPBAL O
WHERE T.CLTCODE =  O.CLTCODE AND T.EXCHANGE = O.EXCHANGE AND T.SEGMENT = O.SEGMENT         
           
SELECT BOOKTYPE,VOUDT=VDT,EFFDT=EDT,SHORTDESC,DRAMOUNT,CRAMOUNT,VNO,DDNO='',NARRATION,CLTCODE,                      
VTYPE,VDT=CONVERT(VARCHAR(10), VDT, 103),EDT=CONVERT(VARCHAR(10), EDT, 103),ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,                      
CROSAC=OPPACCOUNT,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, POSTED_ON 
FROM #TEMP1 
where EXCHANGE = LEFT(@SEG_EXCH,3)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClosingBalance
-- --------------------------------------------------

 /**************************************************************************************************************************************************************************************************        
 THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE         
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~        
 Copy of BrOpeningbalance with change in condition.        
         
 Added two new parameters viz: @flag and @costcode.         
 These are used to display the bank transactions either for all the branches or for a particular branch         
 Depending on the @flag value         
 If @flag = 0  then show bank transaction for all the branches        
 If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )        
  
 Version modified by Deepak Maharishi ON Apr 3 2007  
  1. Removed Cursors and used simple assignments for all values  
  2. Made changes to get the Balance in one query instead of seperate queries for Opening Balance  
  2. Corrected the Balance Computation to get Opening Balance as on Reconciliation Date - 1  
  
  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 22 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 23 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 28 2007 23:59:59', 0,0,0  
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 31 2007 23:59:59', 0,0,0  
  
  
exec acc_PrintReconcile '103','STATEMENT', 'Mar 23 2007 23:59:59', 'Mar 23 2007 23:59:59'  
***************************************************************************************************************************************************************************************************/        
      
    
CREATE  Procedure [dbo].[BrClosingBalance]   
(  
 @cltcode  varchar(10),        
 @sdtcur  varchar(11),        
 @fromdate varchar(11),        
 @vdtedtflag tinyint,        
 @flag   smallint,        
 @costcode  smallint        
)  
       
AS        
        
Declare        
 @@openbaldt   varchar(11),        
 @@openentry   money,        
 @@openingbal   money,        
 @@startdate  datetime,        
 @@enddate  datetime   
    
 select @@startdate = sdtcur, @@enddate = ldtcur from parameter where @fromdate between sdtcur  and ldtcur    
    
 If @vdtedtflag = 0        
 begin        
 /*===============================================================================================================*/  
  /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */        
 /*===============================================================================================================*/  
  if @flag = 0         
  begin        
   select @@openingbal = 0        
  
   select   
    @@openingbal = isnull(sum(dramount - cramount),0)   
   from   
    acc_ledger   
   where   
    vdt >= @@startdate   
    and vdt <= @fromdate + ' 23:59:59'  
    and cltcode = @cltcode        
  
   Select @@Openingbal         
  end        
  /*===============================================================================================================*/  
   /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/        
  /*===============================================================================================================*/  
  else if @flag = 1          
  begin         
   select @@openingbal = 0        
      
   /*select   
    @@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0)   
   from   
    ledger l,  
    ledger2 l2        
   where   
    l.vtyp = l2.vtype   
    and l.vno = l2.vno   
    and l.lno = l2.lno   
    and vdt > = @@openbaldt     
    and vdt >= @@startdate   
    and vdt <= @fromdate + ' 23:59:59'  
    and l.cltcode = @cltcode   
    and costcode = @costcode  */      
      
   select @@openingbal        
  end        
  
 end        
 else if @vdtedtflag = 1        
 begin        
 /*===============================================================================================================*/  
  /*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */        
 /*===============================================================================================================*/  
  if @flag = 0         
  begin        
   select @@openingbal = 0        
  
   select   
    @@openingbal = isnull(sum(dramount - cramount),0)   
   from   
    acc_ledger   
   where   
    vdt between @@startdate and @fromdate + ' 23:59:59'  
    and edt <= @fromdate + ' 23:59:59'  
    and cltcode = @cltcode   
      
   select @@openingbal        
  end         
  /*===============================================================================================================*/  
   /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/        
  /*===============================================================================================================*/  
  else if @flag = 1          
  begin         
   select @@openingbal = 0        
      
   select   
    @@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0)   
   from   
    ledger l,  
    ledger2 l2        
   where    
    l.vtyp = l2.vtype   
    and l.vno = l2.vno   
    and l.lno = l2.lno   
    and vdt between @@startdate and @fromdate + ' 23:59:59'   
    and edt <= @fromdate + ' 23:59:59'  
    and l.cltcode = @cltcode   
    and costcode = @costcode        
  
   select @@openingbal        
  end         
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Cheque_Cancel_Return
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHEQUE_CANCEL_RETURN_GET
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH]
(
	@FCLTCODE VARCHAR(10),
	@TCLTCODE VARCHAR(10)
	,@DATE_FROM VARCHAR(11)
	,@DATE_TO VARCHAR(11)
	,@BANKCODE VARCHAR(30)
	,@DRCR CHAR(1)
	,@REFNO VARCHAR(30)
	,@CHEQUE_NO VARCHAR(30)
	,@AMOUNT NUMERIC(18,2)
	,@STATUS CHAR(1) = ''
	,@FLAG CHAR(2)
	,@SortBy NVARCHAR(50)
	,@BB_DATE_FROM VARCHAR(11)
	,@BB_DATE_TO VARCHAR(11)
	,@FILETYPE NVARCHAR(20)
)
AS 
/*
EXEC CLS_BANKRECO_FETCH '','','01/03/2010','01/12/2015','BANK01','D','','0','',''
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','','0','','L'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BS'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BB'
exec CLS_BANKRECO_FETCH @FCLTCODE='0A143',@TCLTCODE='0A147',@DATE_FROM='01/01/2010',@DATE_TO ='01/01/2015',@BANKCODE='bank01',@DRCR='D',@REFNO='',@STATUS=' ',@FLAG=''
*/
BEGIN
	IF @FLAG ='' OR @FLAG ='L'  /****BOTH BANK STAAND BANK BOOK AS WELL AS FOR LEDGER ENTRY****/
	BEGIN
	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT /*TOP 15*/ 
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,B.VALUEDATE,DESCRIPTION,AMOUNT,DRCR,CROSSREFERENCENO,BR_SNO,BOOKDATE) AS "RNO",	
				REFERENCENO
				,VALUEDATE = CONVERT(VARCHAR(11)
				,CONVERT(DATETIME,B.ValueDate),103)
				, LEFT (DESCRIPTION,20) AS 'DESCRIPTION'					
				, DESCRIPTION AS 'TDESCRIPTION'
				, AMOUNT = ROUND(AMOUNT,2)
				,AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2)
				,DRCR
				,CROSSREFERENCENO
				,BR_SNO
				,BOOKDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,BOOKDATE),103)
				,MATCH_FLAG =''
				,COLOR='' 
				FROM BANKRECO B WITH (NOLOCK) 
				,RECON_BANK_FILEUPLOAD_LOGS S
			WHERE 				
				B.DUMMY2=S.UPLOADID
				AND CLTCODE = @BANKCODE 
				AND CLTCODE=BANKCODE	
				AND BOOKDATE BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'
				AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				AND STATUS = 'UNMATCHED' 
				AND LTRIM(RTRIM(DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND FILETYPE=@FILETYPE
			ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,				
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.VALUEDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
			
		IF @FLAG =''	
			BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				
				SELECT	--TOP 10				
				L.ACNAME
				,DRCR
				,L.CLTCODE
				--,T3.CLTCODE
				,DDNO=ISNULL(L.INSTNO,'0')  
				,DDDT = CONVERT(VARCHAR(10),INSTDATE,103)
				,RELAMT
				,RELAMTWITH_SIGN  =ROUND(CASE WHEN L.DRCR = 'C' THEN RELAMT ELSE -RELAMT END,2)
				,VDT = CONVERT(VARCHAR(10),VDT,103)
				,L.VNO
				,VTYP=L.VTYPE
				,L.BOOKTYPE
				,LNO=-l.MASTERSNO--L.LNO
				,RELDT=''
				,SHORTDESC
				,L1_SNO=l.MASTERSNO
				,ACCNO=''
				,MATCH_FLAG =''
				,COLOR='' 
				,VALUEDT = ''
				,L.BRANCHCODE--'TEST'/*A.POBRANCH*/ AS BRANCHCODE
				,L.ACNAME
				,L.NARRATION					
				FROM CLS_RECON_ACC_LEDGER_GL(NOLOCK) L --, ACMAST(NOLOCK) A	--,acc_tbl3(NOLOCK) t3		
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE <> @BANKCODE					
					--AND L.CLTCODE=A.CLTCODE
					--AND A.ACCAT <>2
					AND L.OPPACCOUNT = @BANKCODE--'03014'
					AND (CR_RELDT LIKE 'JAN  1 1900%'  AND DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
			END
			
	END
	ELSE IF @FLAG ='BS' /****BANK STATEMENT****/
	BEGIN
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            SELECT
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,b.VALUEDATE,DESCRIPTION,AMOUNT,B.DRCR,CROSSREFERENCENO,BR_SNO) AS "RNO",
				REFERENCENO,
				VALUEDATE = CONVERT(VARCHAR(11),
				CONVERT(DATETIME,B.VALUEDATE),103),
				LEFT (DESCRIPTION,15)DESCRIPTION,
				DESCRIPTION AS 'TDESCRIPTION',
				AMOUNT = ROUND(AMOUNT,2),
				AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2),
				B.DRCR,
				CROSSREFERENCENO,
				BR_SNO ,DUMMY1,MATCH_FLAG = ''
            FROM
				BANKRECO B WITH (NOLOCK) ,RECON_BANK_FILEUPLOAD_LOGS s
            WHERE 
			B.DUMMY2=S.UPLOADID
			AND FILETYPE=@FILETYPE
				AND CROSSREFERENCENO = (CASE WHEN @REFNO = '' THEN CROSSREFERENCENO ELSE @REFNO END)
				AND CLTCODE = @BANKCODE 
				AND CLTCODE=BANKCODE
				AND [STATUS] = (CASE WHEN @STATUS = 'M' THEN 'MATCHED' ELSE [STATUS] END)
				AND LTRIM(RTRIM(B.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(B.DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND B.VALUEDATE  BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)
            ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.ValueDate END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
	END
	ELSE IF @FLAG ='BB' AND @REFNO = ''/****BANK BOOK****/
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 		
		SELECT
		L.DRCR,
		L.CLTCODE
		,L.VNO,
		ISNULL(L.INSTNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
		DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
		RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
		VDT = CONVERT(VARCHAR(10),VDT,103),
		RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
		REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END,
		MATCH_FLAG =''
        FROM CLS_RECON_ACC_LEDGER_GL L , ACMAST A				
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE <> @BANKCODE 
					AND L.CLTCODE=A.CLTCODE
					AND A.ACCAT<>2
					AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
	END
	
	ELSE IF @FLAG ='BB' AND @REFNO <> ''/****BANK BOOK FOR CHECKEDEDIT****/
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L.DRCR,
			L.CLTCODE,
			L.VNO,
			ISNULL(L.INSTNO,'0')AS DDNO,
			DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
			RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
			REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			,MATCH_FLAG ='' 
			,BRANCHCODE AS BRANCHCODE
        FROM 
			CLS_RECON_ACC_LEDGER_GL L 
        WHERE 
			L.VTYPE IN ( '2','3' ,'5', '19','17', '20' )			
			AND  @REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')
			AND CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
			
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH_bak
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH_bak]
(
	@FCLTCODE VARCHAR(10),
	@TCLTCODE VARCHAR(10)
	,@DATE_FROM VARCHAR(11)
	,@DATE_TO VARCHAR(11)
	,@BANKCODE VARCHAR(30)
	,@DRCR CHAR(1)
	,@REFNO VARCHAR(30)
	,@CHEQUE_NO VARCHAR(30)
	,@AMOUNT NUMERIC(18,2)
	,@STATUS CHAR(1) = ''
	,@FLAG CHAR(2)
	,@SortBy NVARCHAR(50)
	,@BB_DATE_FROM VARCHAR(11)
	,@BB_DATE_TO VARCHAR(11)
	,@FILETYPE NVARCHAR(20)
)
AS 
/*
EXEC CLS_BANKRECO_FETCH '','','01/03/2010','01/12/2015','BANK01','D','','0','',''
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','','0','','L'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BS'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BB'
exec CLS_BANKRECO_FETCH @FCLTCODE='0A143',@TCLTCODE='0A147',@DATE_FROM='01/01/2010',@DATE_TO ='01/01/2015',@BANKCODE='bank01',@DRCR='D',@REFNO='',@STATUS=' ',@FLAG=''
*/
BEGIN
	IF @FLAG ='' OR @FLAG ='L'  /****BOTH BANK STAAND BANK BOOK AS WELL AS FOR LEDGER ENTRY****/
	BEGIN
	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT /*TOP 15*/ 
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,B.VALUEDATE,DESCRIPTION,AMOUNT,DRCR,CROSSREFERENCENO,BR_SNO,BOOKDATE) AS "RNO",	
				REFERENCENO
				,VALUEDATE = CONVERT(VARCHAR(11)
				,CONVERT(DATETIME,B.ValueDate),103)
				, LEFT (DESCRIPTION,20) AS 'DESCRIPTION'					
				, DESCRIPTION AS 'TDESCRIPTION'
				, AMOUNT = ROUND(AMOUNT,2)
				,AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2)
				,DRCR
				,CROSSREFERENCENO
				,BR_SNO
				,BOOKDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,BOOKDATE),103)
				,MATCH_FLAG =''
				,COLOR='' 
				FROM BANKRECO B WITH (NOLOCK) 
				,RECON_BANK_FILEUPLOAD_LOGS S
			WHERE 				
				B.DUMMY2=S.UPLOADID
				AND CLTCODE = @BANKCODE 	
				AND BOOKDATE BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'
				AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				AND STATUS = 'UNMATCHED' 
				AND LTRIM(RTRIM(DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND FILETYPE=@FILETYPE
			ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,				
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.VALUEDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
			
		IF @FLAG =''	
			BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				
				SELECT	--TOP 10				
				L.ACNAME
				,DRCR
				,L.CLTCODE
				,DDNO=ISNULL(L.INSTNO,'0')  
				,DDDT = CONVERT(VARCHAR(10),INSTDATE,103)
				,RELAMT
				,RELAMTWITH_SIGN  =ROUND(CASE WHEN L.DRCR = 'C' THEN RELAMT ELSE -RELAMT END,2)
				,VDT = CONVERT(VARCHAR(10),VDT,103)
				,L.VNO
				,VTYP=L.VTYPE
				,L.BOOKTYPE
				,LNO=-MASTERSNO--L.LNO
				,RELDT=''
				,SHORTDESC
				,L1_SNO=MASTERSNO
				,ACCNO=''
				,MATCH_FLAG =''
				,COLOR='' 
				,VALUEDT = ''
				,L.BRANCHCODE--'TEST'/*A.POBRANCH*/ AS BRANCHCODE
				,L.ACNAME
				,L.NARRATION					
				FROM CLS_RECON_ACC_LEDGER_GL L	, ACMAST A			
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE <> @BANKCODE 
					AND L.CLTCODE=A.CLTCODE
					AND A.ACCAT =4
					AND (CR_RELDT LIKE 'JAN  1 1900%'  AND DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 23:59:59'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
			END
			
	END
	ELSE IF @FLAG ='BS' /****BANK STATEMENT****/
	BEGIN
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            SELECT
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,b.VALUEDATE,DESCRIPTION,AMOUNT,B.DRCR,CROSSREFERENCENO,BR_SNO) AS "RNO",
				REFERENCENO,
				VALUEDATE = CONVERT(VARCHAR(11),
				CONVERT(DATETIME,B.VALUEDATE),103),
				LEFT (DESCRIPTION,15)DESCRIPTION,
				DESCRIPTION AS 'TDESCRIPTION',
				AMOUNT = ROUND(AMOUNT,2),
				AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2),
				B.DRCR,
				CROSSREFERENCENO,
				BR_SNO ,DUMMY1,MATCH_FLAG = ''
            FROM
				BANKRECO B WITH (NOLOCK) ,RECON_BANK_FILEUPLOAD_LOGS s
            WHERE 
			B.DUMMY2=S.UPLOADID
			AND FILETYPE=@FILETYPE
				AND CROSSREFERENCENO = (CASE WHEN @REFNO = '' THEN CROSSREFERENCENO ELSE @REFNO END)
				AND CLTCODE = @BANKCODE AND [STATUS] = (CASE WHEN @STATUS = 'M' THEN 'MATCHED' ELSE [STATUS] END)
				AND LTRIM(RTRIM(B.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(B.DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND B.VALUEDATE  BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)
            ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.ValueDate END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
	END
	ELSE IF @FLAG ='BB' AND @REFNO = ''/****BANK BOOK****/
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 		
		SELECT
		L.DRCR,
		L.CLTCODE
		,L.VNO,
		ISNULL(L.INSTNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
		DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
		RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
		VDT = CONVERT(VARCHAR(10),VDT,103),
		RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
		REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END,
		MATCH_FLAG =''
        FROM CLS_RECON_ACC_LEDGER_GL L , ACMAST A				
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE <> @BANKCODE 
					AND L.CLTCODE=A.CLTCODE
					AND A.ACCAT=4
					AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 23:59:59'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
	END
	
	ELSE IF @FLAG ='BB' AND @REFNO <> ''/****BANK BOOK FOR CHECKEDEDIT****/
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L.DRCR,
			L.CLTCODE,
			L.VNO,
			ISNULL(L.INSTNO,'0')AS DDNO,
			DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
			RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
			REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			,MATCH_FLAG ='' 
			,BRANCHCODE AS BRANCHCODE
        FROM 
			CLS_RECON_ACC_LEDGER_GL L 
        WHERE 
			L.VTYPE IN ( '2','3' ,'5', '19','17', '20' )			
			AND  @REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')
			AND CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
			
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH_bak_11052018
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH_bak_11052018]
(
	@FCLTCODE VARCHAR(10),
	@TCLTCODE VARCHAR(10)
	,@DATE_FROM VARCHAR(11)
	,@DATE_TO VARCHAR(11)
	,@BANKCODE VARCHAR(30)
	,@DRCR CHAR(1)
	,@REFNO VARCHAR(30)
	,@CHEQUE_NO VARCHAR(30)
	,@AMOUNT NUMERIC(18,2)
	,@STATUS CHAR(1) = ''
	,@FLAG CHAR(2)
	,@SortBy NVARCHAR(50)
	,@BB_DATE_FROM VARCHAR(11)
	,@BB_DATE_TO VARCHAR(11)
	,@FILETYPE NVARCHAR(20)
)
AS 
/*
EXEC CLS_BANKRECO_FETCH '','','01/03/2010','01/12/2015','BANK01','D','','0','',''
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','','0','','L'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BS'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BB'
exec CLS_BANKRECO_FETCH @FCLTCODE='0A143',@TCLTCODE='0A147',@DATE_FROM='01/01/2010',@DATE_TO ='01/01/2015',@BANKCODE='bank01',@DRCR='D',@REFNO='',@STATUS=' ',@FLAG=''
*/
BEGIN
	IF @FLAG ='' OR @FLAG ='L'  /****BOTH BANK STAAND BANK BOOK AS WELL AS FOR LEDGER ENTRY****/
	BEGIN
	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT /*TOP 15*/ 
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,B.VALUEDATE,DESCRIPTION,AMOUNT,DRCR,CROSSREFERENCENO,BR_SNO,BOOKDATE) AS "RNO",	
				REFERENCENO
				,VALUEDATE = CONVERT(VARCHAR(11)
				,CONVERT(DATETIME,B.ValueDate),103)
				, LEFT (DESCRIPTION,20) AS 'DESCRIPTION'					
				, DESCRIPTION AS 'TDESCRIPTION'
				, AMOUNT = ROUND(AMOUNT,2)
				,AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2)
				,DRCR
				,CROSSREFERENCENO
				,BR_SNO
				,BOOKDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,BOOKDATE),103)
				,MATCH_FLAG =''
				,COLOR='' 
				FROM BANKRECO B WITH (NOLOCK) 
				,RECON_BANK_FILEUPLOAD_LOGS S
			WHERE 				
				B.DUMMY2=S.UPLOADID
				AND CLTCODE = @BANKCODE 	
				AND BOOKDATE BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'
				AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				AND STATUS = 'UNMATCHED' 
				AND LTRIM(RTRIM(DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND FILETYPE=@FILETYPE
			ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,				
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.VALUEDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
			
		IF @FLAG =''	
			BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				
				SELECT	--TOP 10				
				L.ACNAME
				,DRCR
				,L.CLTCODE
				,DDNO=ISNULL(L.INSTNO,'0')  
				,DDDT = CONVERT(VARCHAR(10),INSTDATE,103)
				,RELAMT
				,RELAMTWITH_SIGN  =ROUND(CASE WHEN L.DRCR = 'C' THEN RELAMT ELSE -RELAMT END,2)
				,VDT = CONVERT(VARCHAR(10),VDT,103)
				,L.VNO
				,VTYP=L.VTYPE
				,L.BOOKTYPE
				,LNO=-MASTERSNO--L.LNO
				,RELDT=''
				,SHORTDESC
				,L1_SNO=MASTERSNO
				,ACCNO=''
				,MATCH_FLAG =''
				,COLOR='' 
				,VALUEDT = ''
				,BRANCHCODE--'TEST'/*A.POBRANCH*/ AS BRANCHCODE
				,L.ACNAME
				,L.NARRATION					
				FROM CLS_RECON_ACC_LEDGER_GL L				
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE = @BANKCODE 
					AND (CR_RELDT LIKE 'JAN  1 1900%'  AND DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 23:59:59'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
			END
			
	END
	ELSE IF @FLAG ='BS' /****BANK STATEMENT****/
	BEGIN
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            SELECT
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,b.VALUEDATE,DESCRIPTION,AMOUNT,B.DRCR,CROSSREFERENCENO,BR_SNO) AS "RNO",
				REFERENCENO,
				VALUEDATE = CONVERT(VARCHAR(11),
				CONVERT(DATETIME,B.VALUEDATE),103),
				LEFT (DESCRIPTION,15)DESCRIPTION,
				DESCRIPTION AS 'TDESCRIPTION',
				AMOUNT = ROUND(AMOUNT,2),
				AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2),
				B.DRCR,
				CROSSREFERENCENO,
				BR_SNO ,DUMMY1,MATCH_FLAG = ''
            FROM
				BANKRECO B WITH (NOLOCK) ,RECON_BANK_FILEUPLOAD_LOGS s
            WHERE 
			B.DUMMY2=S.UPLOADID
			AND FILETYPE=@FILETYPE
				AND CROSSREFERENCENO = (CASE WHEN @REFNO = '' THEN CROSSREFERENCENO ELSE @REFNO END)
				AND CLTCODE = @BANKCODE AND [STATUS] = (CASE WHEN @STATUS = 'M' THEN 'MATCHED' ELSE [STATUS] END)
				AND LTRIM(RTRIM(B.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(B.DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND B.VALUEDATE  BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)
            ORDER BY 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.ValueDate END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
	END
	ELSE IF @FLAG ='BB' AND @REFNO = ''/****BANK BOOK****/
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 		
		SELECT
		L.DRCR,
		L.CLTCODE
		,L.VNO,
		ISNULL(L.INSTNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
		DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
		RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
		VDT = CONVERT(VARCHAR(10),VDT,103),
		RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
		REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END,
		MATCH_FLAG =''
        FROM CLS_RECON_ACC_LEDGER_GL L				
				WHERE 
					ISNULL(L.INSTNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L.INSTNO,'0') ELSE @CHEQUE_NO  END)
					AND L.VTYPE IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					AND LTRIM(RTRIM(L.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L.DRCR))ELSE @DRCR END)					
					AND L.CLTCODE = @BANKCODE 
					AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')					
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.VDT BETWEEN  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 23:59:59'  AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				ORDER BY 
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L.INSTNO END, 
				CASE WHEN @SortBy ='Date' THEN INSTDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
	END
	
	ELSE IF @FLAG ='BB' AND @REFNO <> ''/****BANK BOOK FOR CHECKEDEDIT****/
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L.DRCR,
			L.CLTCODE,
			L.VNO,
			ISNULL(L.INSTNO,'0')AS DDNO,
			DDDT = CONVERT(VARCHAR(10),INSTDATE,103),
			RELAMT = ROUND(CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),CASE WHEN CR_RELDT='' THEN DR_RELDT ELSE CR_RELDT END,103),
			REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			,MATCH_FLAG ='' 
			,BRANCHCODE AS BRANCHCODE
        FROM 
			CLS_RECON_ACC_LEDGER_GL L
        WHERE 
			L.VTYPE IN ( '2','3' ,'5', '19','17', '20' )			
			AND  @REFNO=CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END
			AND (CR_RELDT LIKE 'JAN  1 1900%'  OR DR_RELDT LIKE 'JAN  1 1900%')
			AND CASE WHEN DR_REFNO='' THEN CR_REFNO ELSE DR_REFNO END NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
			
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH_DETAILS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH_DETAILS]
(
	@FLAG CHAR(20)
	,@BRSNO NVARCHAR(50)
	,@L1SNO NVARCHAR(50)
)
AS 

BEGIN
DECLARE @FLAGVALUE NVARCHAR(50)
SELECT @FLAGVALUE= .DBO.PIECE(@BRSNO,'|',2)

	IF(@FLAGVALUE='L')
	BEGIN
	SET @FLAG='LEDGER'
	SELECT @L1SNO=.DBO.PIECE(@BRSNO,'|',1)
	SET @BRSNO=''
	END

	IF(@FLAGVALUE='B')
	BEGIN
	SET @FLAG = 'BANKRECO'
	SELECT @BRSNO=.DBO.PIECE(@BRSNO,'|',1)
	END

	--SELECT @FLAG,@BRSNO,@L1SNO	RETURN

	IF @FLAG ='BANKRECO'   
	BEGIN	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		SELECT TOP 1 
		CLTCODE,BOOKDATE,DESCRIPTION,AMOUNT,DRCR,VALUEDATE,REFERENCENO,CROSSREFERENCENO AS CROSSNO,STATUS
		FROM BANKRECO B WITH (NOLOCK) 				
		WHERE B.BR_SNO=@BRSNO
	END			
			
	IF @FLAG ='LEDGER'	
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT	L.VNO,L.VTYP,L.BOOKTYPE,CLTCODE,DDNO,RELAMT,L1.DRCR,L.ACNAME AS 'CLIENTNAME' ,L.NARRATION
			FROM	LEDGER L,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND EXISTS (SELECT	VNO	FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO	AND L11.VTYP = L1.VTYP	AND L11.BOOKTYPE = L1.BOOKTYPE)
			AND L1.L1_SNO = @L1SNO			
	END			
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_UPDATE
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_UPDATE]
(

	@PARAM_VAL1 VARCHAR(MAX)
	,@PARAM_VAL2 VARCHAR(MAX)
	,@PARAM_VAL3 VARCHAR(MAX)
	,@FLAG VARCHAR(3)
	,@USERID VARCHAR(30) 
	,@STATUSID VARCHAR(30) 
	,@STATUSNAME VARCHAR(25) 
	,@REFNO VARCHAR(MAX)
	)
	AS
	BEGIN


CREATE TABLE #REFNO 
( CROSSREFNO VARCHAR(12),
UPDATED_CROSSREFNO VARCHAR(12)
)
INSERT INTO #REFNO
		SELECT
		.DBO.CLS_PIECE(ITEMS, ',', 1)
		,.DBO.CLS_PIECE(ITEMS, ',', 2)

	FROM.DBO.CLS_SPLIT(@REFNO, ',')
	WHERE.DBO.CLS_PIECE(ITEMS, ',', 1) <> ''

	
CREATE TABLE #TEMP_DATA
		(
			CROSSREFNO VARCHAR(12)
			,LNO BIGINT
			,RELDT VARCHAR(11)
			,VDT VARCHAR(11)
			--,FINAL_DT  AS (CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
			,FINAL_DT  AS (CASE WHEN CONVERT(DATETIME,VDT,103) < CONVERT(DATETIME,RELDT,103)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
		)

INSERT INTO #TEMP_DATA
	SELECT
		.DBO.CLS_PIECE(ITEMS, '^', 1)
		,.DBO.CLS_PIECE(ITEMS, '^', 2)
		,.DBO.CLS_PIECE(ITEMS, '^', 3)
		,.DBO.CLS_PIECE(ITEMS, '^', 4)
	FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
	WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''
	
ALTER TABLE #TEMP_DATA
ADD VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3)

UPDATE T
SET	T.VNO = L1.VNO
	,T.VTYP = L1.VTYPE
	,T.BOOKTYPE = L1.BOOKTYPE
FROM #TEMP_DATA T, CLS_RECON_ACC_LEDGER_GL L1
WHERE MASTERSNO = T.LNO

UPDATE R 
SET R.UPDATED_CROSSREFNO = T.CROSSREFNO
FROM #REFNO R, #TEMP_DATA T

IF @REFNO <> ''
BEGIN
UPDATE B 
SET B.Dummy1 = B.Crossreferenceno
, B.Crossreferenceno = R.UPDATED_CROSSREFNO
 FROM Bankreco B,  #REFNO R
 WHERE B.Crossreferenceno = R.CROSSREFNO

UPDATE RC
SET RC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM RECON_CMS_DATA RC,  #REFNO R
WHERE RC.CROSS_NO = R.CROSSREFNO

UPDATE RNC
SET RNC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM Recon_NONCMS_Data RNC,  #REFNO R
WHERE RNC.CROSS_NO = R.CROSSREFNO
END

IF LTRIM(RTRIM(@FLAG)) = 'U' 
BEGIN

UPDATE L1
SET	L1.DR_REFNO = CASE WHEN L1.DR_RELAMT<>0 THEN  T.CROSSREFNO ELSE ''END
	,L1.CR_REFNO = CASE WHEN L1.CR_RELAMT<>0 THEN  T.CROSSREFNO ELSE ''END
	,L1.DR_RELDT = CASE WHEN L1.DR_RELAMT<>0 THEN  T.FINAL_DT ELSE '' END  
	,L1.CR_RELDT = CASE WHEN L1.CR_RELAMT<>0 THEN  T.FINAL_DT ELSE '' END  
FROM ACC_TBL4 L1, #TEMP_DATA T
WHERE MASTERSNO = T.LNO

UPDATE B
SET	VALUEDATE = FINAL_DT 
	,STATUS = 'MATCHED'
FROM BANKRECO B, #TEMP_DATA T
WHERE B.CROSSREFERENCENO = T.CROSSREFNO


IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN

UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_CMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO

END

IF EXISTS (SELECT *	FROM	RECON_NONCMS_DATA RC,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
BEGIN
UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO
END
SELECT * FROM #TEMP_DATA RETURN


END 

IF LTRIM(RTRIM(@FLAG)) = 'E'
BEGIN 
IF @REFNO <> ''
	BEGIN	
		
	UPDATE B
	SET STATUS = 'UNMATCHED'
	,B.CROSSREFERENCENO = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END 
	FROM BANKRECO B
	,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
	WHERE B.CROSSREFERENCENO = C.ITEMS

	IF EXISTS (SELECT	*	FROM	RECON_CMS_DATA RC,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
	BEGIN
		UPDATE RC
		SET	MATCHEDFLAG = 0
			,UPLOADSTATUS = 'PENDING'
			,CROSS_NO = R.CROSSREFNO
			,MODIFIEDDATE = GETDATE()
			,UPLOADBY = @USERID
			,VNO = T.VNO
			,VTYP = T.VTYP
			,BOOKTYPE = T.BOOKTYPE
			,MATCHCODE = 0
		FROM RECON_CMS_DATA RC, #TEMP_DATA T, #REFNO R
		WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO
	END


IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
BEGIN
UPDATE RC
SET	MATCHEDFLAG = 0
	,UPLOADSTATUS = 'PENDING'
	,CROSS_NO = R.CROSSREFNO
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
	,MATCHCODE = 0
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T, #REFNO R
WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO

END


END 

ELSE IF @REFNO = ''
BEGIN
		DECLARE @TEMPDATA TABLE(AMOUNT MONEY,CROSSREFERENCENO NVARCHAR(50),REFERENCENO NVARCHAR(50)
								,DUMMY1 NVARCHAR(50), REFCOUNT INT)
		INSERT INTO @TEMPDATA
		SELECT AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1,COUNT(CROSSREFERENCENO )REFCOUNT 
		FROM BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C 
		WHERE DUMMY1<>0 AND  B.CROSSREFERENCENO = C.ITEMS
		GROUP BY AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1 
		
		IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
		BEGIN
		UPDATE R
		SET 
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL		
		,MATCHCODE = 0
		FROM RECON_CMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.INST_AMT

		END
		
	IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
	BEGIN
		UPDATE R
		SET 		
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL		
		,MATCHCODE = 0
		FROM RECON_NONCMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.AMT
		END
		
		UPDATE B
		SET STATUS = 'UNMATCHED'
		, B.Crossreferenceno = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END
		, B.Dummy1=0
		FROM BANKRECO B
		,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS

		IF EXISTS(SELECT * FROM  @TEMPDATA)
		 BEGIN
		    IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_NONCMS_DATA R,@TEMPDATA T
			 WHERE R.AMT=T.AMOUNT
			 AND R.REFERENCENO=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			END 
			IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_CMS_DATA R,@TEMPDATA T
			 WHERE R.INST_AMT=T.AMOUNT
			 AND R.INST_NO_CHECK=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			 ENd
		 
		 END

END

UPDATE L1
SET	L1.DR_REFNO = ''
	,L1.CR_REFNO = ''
	,L1.DR_RELDT = ''  
	,L1.CR_RELDT = '' 
FROM ACC_TBL4 L1 
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
WHERE L1.MASTERSNO = C.ITEMS
AND C.ITEMS <> ''
AND C.ITEMS IS NOT NULL

END
DROP TABLE #TEMP_DATA
DROP TABLE #REFNO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECON_MISMATCH_ACCOUNTNUMBER
-- --------------------------------------------------
CREATE PROCEDURE CLS_BANKRECON_MISMATCH_ACCOUNTNUMBER
(

@VALUEDATE DATETIME
,@BANKCODE VARCHAR(50)
)
AS

--EXEC CLS_BANKRECON_MISMATCH_ACCOUNTNUMBER 'MAY 01 2018','05016'
CREATE TABLE #TEMP(
CLTACCNO NVARCHAR(50)
,ACCNO NVARCHAR(50)
,CLTCODE NVARCHAR(50)
,BOCLTCODE NVARCHAR(50)
,DDNO NVARCHAR(50)
,INST_NO_CHECK NVARCHAR(50)
,INST_AMT DECIMAL(18,2)
,RELAMT DECIMAL(18,2)
,DRCR NVARCHAR(50)
,BODRCR NVARCHAR(50)
,VDT DATETIME
,VALUEDATE DATETIME
,UPLOADSTATUS NVARCHAR(50)
,CROSS_NO  NVARCHAR(50)
, ROWNUMBER INT )

INSERT INTO #TEMP (CLTACCNO,ACCNO,CLTCODE,BOCLTCODE,DDNO,INST_NO_CHECK,INST_AMT,RELAMT,DRCR,BODRCR,VDT,VALUEDATE,UPLOADSTATUS,CROSS_NO,ROWNUMBER)
SELECT  C.CLTACCNO,M.ACCNO
 ,M.CLTCODE , L.CLTCODE
,DDNO=SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) , INST_NO_CHECK=SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
,C.INST_AMT , L.RELAMT
,C.DRCR , L.DRCR
,L.VDT,C.VALUEDATE
,UPLOADSTATUS
,CROSS_NO
,ROW_NUMBER() OVER(PARTITION BY INST_NO_CHECK,INST_AMT,C.DRCR,VALUEDATE,CROSS_NO ORDER BY CROSS_NO ASC)    AS RowNUMBER

FROM RECON_CMS_DATA C (NOLOCK)
			,(SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.EDT
		,L.VDT
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
		AND L11.VDT<=@VALUEDATE))L
			,CLS_MULTIBANKID_RECO_VW M
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			--AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
			AND M.CLTCODE = L.CLTCODE
			AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
			AND  MATCHEDFLAG=0 
			--AND UPLOADSTATUS='pending'
			AND ROWTYPE<>'DR'
			AND VALUEDATE >DATEADD(DAY,-10 , @VALUEDATE)
	
SELECT * FROM #TEMP WHERE ROWNUMBER=1

DROP TABLE #TEMP
------------3-------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_BANK_FILEUPLOAD_LOGS] (
  @UPLOADID         NVARCHAR(50)
, @SEGMENT        NVARCHAR(50)
, @BANKCODE       NVARCHAR(50)
, @BANKNAME       NVARCHAR(50)
, @FILETYPE       NVARCHAR(50)
, @BANKACCOUNT    NVARCHAR(100)
, @UPLOADFILENAME NVARCHAR(150)
, @UPLOADEDDATE   NVARCHAR(50)
, @MODIFIEDDATE   NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1) = 'N'
, @FILE_PATH VARCHAR(500) = ''
, @UNAME VARCHAR(50)=''
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
)
AS
BEGIN
		DECLARE @@SQL           VARCHAR(MAX),
				@@ACCOUNTDB     VARCHAR(20),
				@@ACCOUNTSERVER VARCHAR(20),
				@COMBINEFILE NVARCHAR(2)
				
	SELECT @UPLOADEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @UPLOADEDDATE, 103)
	SELECT @MODIFIEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @MODIFIEDDATE, 103)
	--SELECT @UPLOADEDDATE,@MODIFIEDDATE,'P' RETURN
	
	IF(@BANKCODE='')
	SET @BANKCODE='0'
	IF(@BANKACCOUNT='')
	SET @BANKACCOUNT='0'
	
	IF(ISNULL(@BANKCODE,'0')='0' AND ISNULL(@BANKACCOUNT,'0')='0' AND @REPROCESS_FLAG='N' )
	SET @COMBINEFILE='0'
	ELSE
	SET @COMBINEFILE='1'
		
	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

IF (@BANKNAME = 'YES BANK1' AND @FILETYPE = 'NON-CMS') AND @SEGMENT <> 'NSE-CAPITAL' 
BEGIN
SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY) "
SET @@SQL = @@SQL + " SELECT  PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY FROM MSAJAG.DBO.FILEDATA WHERE PROGID = '" + @UPLOADID + "'"

EXEC (@@SQL)

SET @@SQL = " EXEC " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS "
SET @@SQL = @@SQL + "'" + @UPLOADID + "'"
SET @@SQL = @@SQL + ",'" + @SEGMENT + "'"
SET @@SQL = @@SQL + ",'" + @BANKCODE + "'"
SET @@SQL = @@SQL + ",'" + @BANKNAME + "'"
SET @@SQL = @@SQL + ",'" + @FILETYPE + "'"
SET @@SQL = @@SQL + ",'" + @BANKACCOUNT + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADFILENAME + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @MODIFIEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @UPLOAD_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @FILE_PATH + "'"
SET @@SQL = @@SQL + ",'" + @UNAME + "'"
SET @@SQL = @@SQL + ",'" + @REPROCESS_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADDATE + "'"

EXEC (@@SQL)

RETURN
END


DECLARE @PROCESS NVARCHAR(1)
SET @PROCESS = 'N'

CREATE TABLE #TEMP(FILE_DATA VARCHAR(MAX))

IF NOT EXISTS(SELECT * FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE  FILETYPE=@FILETYPE
AND BANKNAME=@BANKNAME AND UPLOADFILENAME=@UPLOADFILENAME)
BEGIN
	INSERT INTO RECON_BANK_UPLOAD_PROCESS_INFO (UPLOADID, SEGMENT, BANKCODE
	, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
	, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
	VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', 
	@UNAME, GETDATE(), GETDATE(), GETDATE())

IF (@REPROCESS_FLAG <> 'R') 
BEGIN
--SELECT 'SS',@COMBINEFILE RETURN
IF(@COMBINEFILE<>'0') 
BEGIN
	IF (CHARINDEX(@BANKACCOUNT, @UPLOADFILENAME) = 1)
	BEGIN
	
	IF( @UPLOAD_FLAG <> 'B' )
			BEGIN
			
				--IF ((@BANKNAME = 'HDFC BANK') OR (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS')OR (@BANKNAME = 'KOTAK BANK') ) 
				IF(@COMBINEFILE<>'0')
				BEGIN	
									
								SET @PROCESS = 'Y'
								INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
								, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
								, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
								 VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
							
				END 
				ELSE 
				--IF ((@BANKNAME = 'YES BANK' AND @FILETYPE = 'CMS') OR @BANKNAME = 'STANDARD CHARTERED BANK') 
				IF(@COMBINEFILE='0')
					BEGIN
					
						SET @PROCESS = 'Y'
						INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
						VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
					END
				END
		ELSE
			BEGIN
				
				IF(@SEGMENT='NSE-CAPITAL')
				BEGIN
				DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
				END

				DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				--PRINT @@SQL

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " +
				+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID, SEGMENT, BANKCODE
				, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
				, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
				VALUES('" + @UPLOADID + "',"
				+ "'" + @SEGMENT + "',"
				+ "'" + @BANKCODE + "',"
				+ "'" + @BANKNAME + "',"
				+ "'" + @FILETYPE + "',"
				+ "'" + @BANKACCOUNT + "',"
				+ "'" + @UPLOADFILENAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "'SUCCESS'" + ","
				+ "'" + @UNAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103))"

				EXEC (@@SQL)
				PRINT @@SQL
				SET @UPLOAD_FLAG='N'

				SET @@SQL = ''
				SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
				+ ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS '" + @UPLOADID + "','" + @SEGMENT + "','" + @BANKCODE + "','" + @BANKNAME + "','"
				+ @FILETYPE + "','" + @BANKACCOUNT + "','" 
				+ @UPLOADFILENAME + "','" 
				+ @UploadedDate + "','" 
				+ @MODIFIEDDATE + "','" 
				+@UPLOAD_FLAG + "','" 
				+@FILE_PATH + "','" +@UNAME + "','" + @REPROCESS_FLAG + "','" + @UPLOADDATE + "'"
				
				EXEC (@@SQL)
				PRINT @@SQL	
				SET @PROCESS = 'Y'
				RETURN
			END
		END 
		ELSE
 
		BEGIN
			--DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
			SELECT		'YOU HAVE SELECTED WRONG SEGMENT FILE'
			DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
			RETURN
		END
	END
	ELSE
	
		IF (@COMBINEFILE=0) 
		BEGIN
		
		SET @PROCESS = 'Y'
		INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
		VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
		

		IF ((@PROCESS = 'Y' OR @REPROCESS_FLAG = 'N' ) AND @UPLOAD_FLAG = 'B' )	
		BEGIN
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				PRINT @@SQL

				EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
		END
	END
END

IF (@PROCESS = 'Y'  AND @UPLOAD_FLAG <> 'B' )
BEGIN

EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
END
END

ELSE
	BEGIN 
	SELECT 'FILE YOU TRY TO UPLOAD IS ALREADY IN PROCESS PLEASE WAIT ...' 
	--DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
	END
IF( @REPROCESS_FLAG = 'R' )
BEGIN

--SELECT @PROCESS,@UPLOAD_FLAG,@REPROCESS_FLAG RETURN
DECLARE @TEMPREPROCESS TABLE(Report_Name NVARCHAR(500))
DECLARE @TEMPBANKMASTER TABLE(
SEGMENT NVARCHAR(50),
BANKNAME NVARCHAR(50),
BANKCODE NVARCHAR(50),
BANKACCOUNT NVARCHAR(50),
FILETYPE NVARCHAR(50))

INSERT INTO @TEMPBANKMASTER (SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE)
SELECT SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE FROM RECON_BANK_MASTER(NOLOCK) 
WHERE BANKNAME=@BANKNAME AND FILETYPE<>'ENCRYPTION'

DECLARE @MBANKACCOUNT NVARCHAR(50)

--SELECT * FROM @TEMPBANKMASTER
	WHILE (SELECT COUNT(*)	FROM @TEMPBANKMASTER)> 0 
	BEGIN

		SET @SEGMENT = ''
		SET @BANKNAME=''		
		SET @BANKCODE = ''
		SET @MBANKACCOUNT = ''
		SET @FILETYPE=''
		SET @@ACCOUNTDB = ''
		SET @@ACCOUNTSERVER = ''

		SELECT TOP 1 @SEGMENT=SEGMENT,@BANKNAME=BANKNAME,@BANKCODE=BANKCODE,@MBANKACCOUNT=BANKACCOUNT,@FILETYPE=FILETYPE FROM @TEMPBANKMASTER


		SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
		WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT	AND PRIMARYSERVER = 1

		--EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@SEGMENT
		
			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
			+ ".DBO.CLS_RECON_INSERT_PROCESS '"	+ @UPLOADID + "','" + @FILETYPE + "','" + @BANKNAME + "','" + @UPLOAD_FLAG + "','"+ @REPROCESS_FLAG + "','" 
			+ @UPLOADDATE + "','" + @BANKCODE + "','"+ @BANKACCOUNT + "','" + @SEGMENT 	+ "','" + @UNAME 	+ "','" + @FILE_PATH	+ "','" + @COMBINEFILE	+ "','" 
			+ @UPLOADFILENAME + "'"
			INSERT INTO @TEMPREPROCESS (Report_Name)
			EXEC (@@SQL)
			PRINT @@SQL
			
			DECLARE @@ERRORVALUE NVARCHAR(MAX),@SPNAME NVARCHAR(50)
			
			SET @@SQL=''
			SET @@ERRORVALUE=''
			SET @@ERRORVALUE=@@SQL
			
			/*SET @SPNAME='CLS_RECON_INSERT_PROCESS'
			SET @@SQL = ''
			SET @@SQL = "INSERT INTO " +
			+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_LOGS(SERVERNAME,DATABASENAME,USERNAME,LOGDATE,ERRORLOGS,SOURCENAME)
			VALUES('" + @@ACCOUNTSERVER + "',"
			+ "'" + @@ACCOUNTDB + "',"
			+ "'" + @UNAME + "',"
			+ "'" + @UPLOADDATE + "',"
			+ "'" + @@ERRORVALUE + "',"
			+ "'" + @SPNAME + "')"
			SET @SPNAME=''
			
			--EXEC (@@SQL)			
			PRINT @@SQL*/
			
			--SELECT @SEGMENT,@BANKNAME,@BANKCODE,@MBANKACCOUNT,@FILETYPE
			
			DELETE FROM @TEMPBANKMASTER WHERE
			SEGMENT=ISNULL(@SEGMENT,'')	
			AND BANKNAME=ISNULL(@BANKNAME,'')								
			AND BANKCODE=ISNULL(@BANKCODE,'')			
			AND BANKACCOUNT=ISNULL(@MBANKACCOUNT,'')
			AND FILETYPE=ISNULL(@FILETYPE,'')
	END
	SELECT TOP 1 * FROM @TEMPREPROCESS 
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BANK_FILEUPLOAD_LOGS_WEEK
-- --------------------------------------------------


	CREATE  PROCEDURE [dbo].[CLS_RECON_BANK_FILEUPLOAD_LOGS_WEEK]
	AS
	
	BEGIN
	DECLARE @REPROCUPLOADDATE DATETIME,@NDAY INT ,@MBANKACCOUNT NVARCHAR(50)
	DECLARE @@SQL VARCHAR(MAX)
	, @@ACCOUNTDB VARCHAR(20)
	, @@ACCOUNTSERVER VARCHAR(20)
	, @BANKACCOUNT VARCHAR(50)
	, @UPLOADID         NVARCHAR(50)
	, @SEGMENT        NVARCHAR(50)
	, @BANKCODE       NVARCHAR(50)
	, @BANKNAME       NVARCHAR(50)
	, @FILETYPE       NVARCHAR(50)
	, @CLIENT		  NVARCHAR(50)
	, @FILEFORMATE    NVARCHAR(50)
	, @ENCRYPTIONCODE NVARCHAR(50)
	, @UNAME VARCHAR(50)
	, @REPROCESS_FLAG CHAR(1)
	, @UPLOAD_FLAG NVARCHAR(50)
	, @UPLOADDATE NVARCHAR(25)
	,@FILE_PATH NVARCHAR(500)
	
	
	SET @UNAME='AUTO'
	SET @FILE_PATH=''
	SET @SEGMENT = ''
	SET @BANKCODE = ''
	SET @BANKACCOUNT = ''
	SET @@ACCOUNTDB = ''
	SET @@ACCOUNTSERVER = ''	
	SET @NDAY = 0
	SET @REPROCESS_FLAG='R'
	SET @REPROCUPLOADDATE = GETDATE()
	DECLARE @COMBINEFILE NVARCHAR(2),@UPLOADFILENAME NVARCHAR(100)
	SET @UPLOADFILENAME=''
	SET @COMBINEFILE=1

	CREATE TABLE #RECON_BANK_MASTER_REPROCESS(
	BANKMASTERID INT IDENTITY(1,1) NOT NULL,
	SEGMENT NVARCHAR(50) NOT NULL,
	BANKNAME NVARCHAR(100) NULL,
	BANKCODE NVARCHAR(50) NULL,
	BANKACCOUNT NVARCHAR(50) NOT NULL,	
	FILETYPE NVARCHAR(50) NOT NULL,	
	REPROCESSFLAG NVARCHAR(50) NULL,
	VALUEDATE DATETIME	)

		CREATE TABLE  #TEMPBANKMASTER (SEGMENT NVARCHAR(50))

		INSERT INTO #TEMPBANKMASTER (SEGMENT)
		SELECT DISTINCT SEGMENT FROM RECON_BANK_MASTER_VW(NOLOCK) 
		WHERE FILETYPE<>'ENCRYPTION'		
		AND SEGMENT in('NSE-CAPITAL')

WHILE (SELECT COUNT(*)	FROM #TEMPBANKMASTER)> 0 
	BEGIN	
 
		SELECT TOP 1 @SEGMENT=SEGMENT FROM #TEMPBANKMASTER	

		SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
		WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT AND PRIMARYSERVER = 1

	SET @@SQL = ''

	SET @@SQL = "INSERT INTO #RECON_BANK_MASTER_REPROCESS(SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE,REPROCESSFLAG,VALUEDATE) 
	SELECT DISTINCT SEGMENT, BANKNAME,BANKCODE, BANKACCOUNT,FILETYPE,0,R.VALUEDATE FROM  " + @@ACCOUNTSERVER + "."
	 + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS R," +@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].BANKRECO BR
	WHERE R.UPLOADID=BR.DUMMY2
	AND BR.STATUS='UNMATCHED'
	AND R.SEGMENT ='"+@SEGMENT+"'
	AND R.VALUEDATE BETWEEN  '"+ CONVERT(VARCHAR(11),DATEADD(DAY, -7,   @REPROCUPLOADDATE ), 113)+"'  AND  '"+CONVERT(VARCHAR(11), @REPROCUPLOADDATE ,113)+"'
	ORDER BY SEGMENT,BANKCODE"

	EXEC(@@SQL)
	PRINT @@SQL	
	DELETE FROM #TEMPBANKMASTER		
	WHERE SEGMENT = ISNULL(@SEGMENT, '')

	
	END
	--SELECT * FROM #RECON_BANK_MASTER_REPROCESS RETURN 

			WHILE (SELECT COUNT(*)	FROM #RECON_BANK_MASTER_REPROCESS WHERE REPROCESSFLAG<>'1')> 0 
				BEGIN	
				
				DELETE FROM  #RECON_BANK_MASTER_REPROCESS 	WHERE  REPROCESSFLAG='1'

					SET @SEGMENT = ''
					SET @BANKNAME = ''
					SET @BANKCODE = ''
					SET @MBANKACCOUNT = ''
					SET @FILETYPE = ''
					SET @@ACCOUNTDB = ''
					SET @@ACCOUNTSERVER = ''
					SET @REPROCUPLOADDATE = ''
					DECLARE @VALUEDATELOOP DATETIME
					DECLARE @VALUEDATEINNER NVARCHAR(20)

					SELECT TOP 1 @SEGMENT = SEGMENT,@BANKNAME = BANKNAME,@BANKCODE = BANKCODE,@MBANKACCOUNT = BANKACCOUNT
					,@FILETYPE = FILETYPE 
					,@VALUEDATEINNER=CONVERT(VARCHAR(10),CONVERT(DATE,VALUEDATE,106),103),@VALUEDATELOOP=VALUEDATE FROM #RECON_BANK_MASTER_REPROCESS
					WHERE REPROCESSFLAG<>'1'

					SELECT @@ACCOUNTDB = ACCOUNTDB,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
					WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT AND PRIMARYSERVER = 1

								
					DECLARE @DATELOOP INT =1
						
						--EXEC CLS_RECON_INSERT_PROCESS @UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG
						--,@VALUEDATEINNER,@BANKCODE,@SEGMENT

						SET @@SQL = ''
						SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
						+ ".DBO.CLS_RECON_INSERT_PROCESS '"
						+ ISNULL(@UPLOADID, '') + "','" 
						+ ISNULL(@FILETYPE, '') + "','" 
						+ ISNULL(@BANKNAME, '') + "','" 
						+ ISNULL(@UPLOAD_FLAG, '') + "','"
						+ ISNULL(@REPROCESS_FLAG, '') + "','" 
						+ CONVERT(VARCHAR(10), @VALUEDATEINNER, 103) 
						+ "','" + ISNULL(@BANKCODE, '') 
						+ "','" + ISNULL(@MBANKACCOUNT, '') 
						+ "','" + ISNULL(@SEGMENT, '') 
						+ "','" + @UNAME 
						+ "','" + @FILE_PATH 
						+ "','" + @COMBINEFILE 
						+ "','" + @UPLOADFILENAME + "'"

						EXEC (@@SQL)
						PRINT @@SQL
						SET @@SQL = ''						

						SET @DATELOOP=@DATELOOP+1

						PRINT @SEGMENT+@BANKNAME+@BANKCODE+@FILETYPE+@VALUEDATEINNER

					UPDATE #RECON_BANK_MASTER_REPROCESS SET REPROCESSFLAG='1'
					WHERE SEGMENT = @SEGMENT AND BANKNAME = @BANKNAME AND BANKCODE = @BANKCODE 
					AND FILETYPE = @FILETYPE AND VALUEDATE=@VALUEDATELOOP
					
				END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BULKUPLOD_FILES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_BULKUPLOD_FILES]
(@UPLOADID NVARCHAR(25),
@FILENAME NVARCHAR(MAX),
@UPLOADBY NVARCHAR(100),
@SEGMENT NVARCHAR(50),
@COMBINEFILE NVARCHAR(2)
)

AS 
BEGIN

CREATE TABLE #TEMP
(
	FILE_DATA VARCHAR(MAX)
)
DECLARE @CMD VARCHAR(MAX)

SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILENAME + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
EXEC (@CMD)
PRINT (@CMD)

IF(@COMBINEFILE='0')
BEGIN
	DECLARE @@SQL    VARCHAR(MAX),
			@@ACCOUNTDB     VARCHAR(20),
			@@ACCOUNTSERVER VARCHAR(20)

	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY
	WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

	BEGIN TRY
		SET @@SQL = ''
		SET @@SQL = "INSERT INTO " +@@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UploadDateTime,	UploadBy)
												SELECT  '" + @UPLOADID + "'
												, FILE_DATA
												, GETDATE() 
												, '" + @UPLOADBY + "'
												FROM   #TEMP "

		EXEC (@@SQL)
		PRINT (@@SQL)
	END TRY
	BEGIN CATCH
		SELECT 'YOU HAVE NOT SELECTED COMBINE FILE CHECK BOX'
		RETURN;
	END CATCH
	
END
ELSE
BEGIN
INSERT INTO MSAJAG.DBO.FILEDATA
	SELECT
		@UPLOADID
		,FILE_DATA
		,GETDATE()
		,@UPLOADBY
	FROM #TEMP
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_HDFC_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_CMS_HDFC_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		, @BANKCODE BANKCODE
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		--,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) + SUBSTRING(.DBO.PIECE(F.FILE_DATA, ',', 6), 3, 2) + LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2), 112))) VALUEDATE
		,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) --year
		+ SUBSTRING(RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 6), 1, 2) + --month
		CASE WHEN LEN(.DBO.PIECE(F.FILE_DATA, ',', 6))=8 THEN LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2) ELSE --date
		LEFT(STUFF(.DBO.PIECE(F.FILE_DATA, ',', 6),1,0,'0'), 2) END, 112))) VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 18))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 5) AS DECIMAL(20, 2)))) AS INST_AMT
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 10))) DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 26), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 24))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''
	AND.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1) = 'D'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_ICICI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_ICICI_PROCESS] ( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
          

	INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1))) ROWTYPE
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, '|', 6), 105) AS VALUEDATE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 4))) DRCR
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, '|', 17))) INST_NO_CHECK
	,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, '|', 20) AS DECIMAL(20, 2)))) AS INST_AMT
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 20))) DRAWER_NAME
	,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, '|', 24), ' ', ''))) CLTCODE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 28))) CLTACCNO
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''	
	AND RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1)))<>'ROW_TYPE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_IDFC_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_CMS_IDFC_PROCESS] (

@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS

BEGIN
INSERT INTO #CMS_DATA

SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )),  105))) AS VALUEDATE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS DRCR
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS INST_NO_CHECK
			,RTRIM(LTRIM(CAST(REPLACE(.DBO.Piece(FILE_DATA,'',3), '''', '') AS DECIMAL(20, 2)))) AMT
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7))) AS DRAWER_NAME
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) ))  AS CLTCODE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) ))  <> ''


END
--SELECT REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS 'CLIENT_CODE ' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS 'DEBIT_CREDIT_FLAG' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',3) )) AS 'INSTRUMENT_AMNT' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )) AS 'VALUE_DATE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS 'INSTRUMENT_NMBR' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',6) )) AS 'DRAWEE_BANK_DESCRIPTION' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7) )) AS 'DRAWER_DESCRIPTION' 
----,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'CLTCODE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'REF' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS 'REM' 
--FROM  MSAJAG..FILEDATA 
--WHERE PROGID='82a91859'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_KOTAK_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_CMS_KOTAK_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		,@BANKCODE AS 'BANKCODE'
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',5),105)  AS VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, ',', 14))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 15) AS DECIMAL(20, 2)))) AS INST_AMT
		,'' AS  'DRAWER_NAME'
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 32), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 31))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) IS NOT NULL
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) NOT IN('DEBIT_CREDIT_FLAG')

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_SBI_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_CMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,'' ROWTYPE
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'INST_NO_CHECK'
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMOUNT'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) AS 'DRAWER_NAME'
	,'' AS 'CLTCODE'
	,'' AS 'CLTACCNO'
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #CMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YES_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YES_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN
DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=0
BEGIN
	IF(@UPLOAD_FLAG ='B')
BEGIN
UPDATE FILEDATA_BANKRECO
SET FILE_DATA = FILE_DATA + '@'
WHERE PROGID = @UPLOADID

INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', '')))AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		,CASE WHEN ISNUMERIC(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))))=1 THEN RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))
		ELSE SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) END AS CLTACC
		--,SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) AS CLTACC
		--, RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))) AS CLTACC            
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,@BANKCODE AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', ''))) AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		--, SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))),0,LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))))-1) AS CLTACC  
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS CLTACC
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END

PRINT 'INSERTED TEMP TABLE'
END
ELSE
	BEGIN
	SELECT 'YOU HAVE SELECTED YESBANK_BUSINESS FILE ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN

DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=1
	BEGIN
	
		UPDATE MSAJAG..FILEDATA
		SET FILE_DATA =.dbo.Piece(FILE_DATA, '"', 1)
		+.dbo.Piece(FILE_DATA, '"', 2)
		+.dbo.Piece(FILE_DATA, '"', 3)
		+.dbo.Piece(FILE_DATA, '"', 4)
		+.dbo.Piece(FILE_DATA, '"', 5)
		+.dbo.Piece(FILE_DATA, '"', 6)
		+.dbo.Piece(FILE_DATA, '"', 7)
		+.dbo.Piece(FILE_DATA, '"', 8)
		+.dbo.Piece(FILE_DATA, '"', 9)
		+.dbo.Piece(FILE_DATA, '"', 10)
		+.dbo.Piece(FILE_DATA, '"', 11)
		+.dbo.Piece(FILE_DATA, '"', 12)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 14)
		+.dbo.Piece(FILE_DATA, '"', 15)
		+.dbo.Piece(FILE_DATA, '"', 16)
		+.dbo.Piece(FILE_DATA, '"', 17)
		+.dbo.Piece(FILE_DATA, '"', 18)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 20)
		+.dbo.Piece(FILE_DATA, '"', 21)
		+.dbo.Piece(FILE_DATA, '"', 22)
		+.dbo.Piece(FILE_DATA, '"', 23)
		+.dbo.Piece(FILE_DATA, '"', 24)
		+.dbo.Piece(FILE_DATA, '"', 25)
		+.dbo.Piece(FILE_DATA, '"', 26)
		+.dbo.Piece(FILE_DATA, '"', 27)
		+.dbo.Piece(FILE_DATA, '"', 28)
		+.dbo.Piece(FILE_DATA, '"', 29)
		+.dbo.Piece(FILE_DATA, '"', 30)
		+.dbo.Piece(FILE_DATA, '"', 31)
		+.dbo.Piece(FILE_DATA, '"', 32)
		+.dbo.Piece(FILE_DATA, '"', 33)
		+.dbo.Piece(FILE_DATA, '"', 34)
		+.dbo.Piece(FILE_DATA, '"', 35)
		+.dbo.Piece(FILE_DATA, '"', 36)
		+.dbo.Piece(FILE_DATA, '"', 37)
		+.dbo.Piece(FILE_DATA, '"', 38)
		+.dbo.Piece(FILE_DATA, '"', 39)
		+.dbo.Piece(FILE_DATA, '"', 40)
		+.dbo.Piece(FILE_DATA, '"', 41)
		+.dbo.Piece(FILE_DATA, '"', 42)
		+.dbo.Piece(FILE_DATA, '"', 43)
		+.dbo.Piece(FILE_DATA, '"', 44)
		+.dbo.Piece(FILE_DATA, '"', 45)
		+.dbo.Piece(FILE_DATA, '"', 46)
		WHERE PROGID = @UPLOADID
		AND .dbo.Piece(FILE_DATA,'"',1)<>''
		
			INSERT INTO #CMS_DATA
			SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '''', ''), ',', 2), '''', ''))) AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''), 105))) AS VALUEDATE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 10), '''', ''))) AS DRCR
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 17), '''', ''))) AS INST_NO_CHECK
			,ABS(RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', '') AS DECIMAL(20, 2))))) AMT
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS DRAWER_NAME
			,'' AS CLIENTID
			,'' AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
			AND .dbo.Piece(FILE_DATA, ',', 1) <> ''
			AND.DBO.PIECE(FILE_DATA, ',', 22) <> 'VALUE_DATE'
			AND (.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%CAP360%'
			OR.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%NCDEX384%')
			

	END
	ELSE
	BEGIN
	SELECT 'FILE NAME SHOULD START WITH YESCMSBUSINESS ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END

PRINT 'INSERTED TEMP TABLE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_GET_BANKMASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_GET_BANKMASTER]
AS
BEGIN

SELECT * FROM RECON_BANK_MASTER_VW

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_PROCESS
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[CLS_RECON_INSERT_PROCESS] (@UPLOADID   NVARCHAR(50)
, @FILETYPE NVARCHAR(50)
, @BANKNAME NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1)
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
, @BANKCODE NVARCHAR(20)
, @BANKACCOUNT NVARCHAR(50)
, @SEGMENT NVARCHAR(20)
, @UNAME NVARCHAR(50)
, @FILE_PATH NVARCHAR(150)
, @COMBINEFILE NVARCHAR(5)
, @UPLOADFILENAME NVARCHAR(150))
AS
  BEGIN
  DECLARE @MFSS NVARCHAR(20)
  SELECT @MFSS=.DBO.PIECE(@SEGMENT,'-',2)
  DECLARE @VALUEDATE DATETIME
  
  

		IF(@REPROCESS_FLAG<>'R')
			BEGIN

		IF(	@BANKCODE='0' AND @BANKACCOUNT='0')				
		SET @COMBINEFILE='0'		
		ELSE
		SET @COMBINEFILE='1'
				
IF(@COMBINEFILE='0')
	BEGIN
		SELECT	@BANKCODE = BANKCODE
		FROM RECON_BANK_MASTER_VW 
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE

		UPDATE RECON_BANK_FILEUPLOAD_LOGS
		SET BANKCODE=@BANKCODE
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE
	END
END
DECLARE @TOTALFILERECORD INT, @TOTALINSERTRECORD INT, @LOOPINSERTRECORD NVARCHAR(20)



DECLARE @TEMPBANKACCOUNTMASTER TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @TEMPBANKACCOUNT TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @@SQL VARCHAR(MAX),
@@ACCOUNTDB VARCHAR(20),
@@ACCOUNTSERVER VARCHAR(20)
DECLARE @@CROSS_NO INT

BEGIN TRY

IF (@FILETYPE = 'CMS') 
BEGIN
CREATE TABLE #CMS_DATA(SNO INT IDENTITY (1, 1)
, UPLOADID NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, ROWTYPE NVARCHAR(50)
, VALUEDATE DATETIME
, DRCR NVARCHAR(50)
, INST_NO_CHECK NVARCHAR(50)
, INST_AMT DECIMAL(20, 2)
, DRAWER_NAME NVARCHAR(250)
, CLTCODE NVARCHAR(50)
, CLTACCNO NVARCHAR(50)
, VNO NVARCHAR(20)
, VTYP NVARCHAR(20)
, BOOKTYPE NVARCHAR(20)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE NVARCHAR(50)
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))
CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))



IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_CMS_HDFC_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'ICICI BANK') EXEC CLS_RECON_CMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_CMS_KOTAK_PROCESS	@UPLOADID,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') PRINT 'EXEC CLS_RECON_CMS_SCB_PROCESS @UPLOADID'
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_CMS_IDFC_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_CMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_CMS_YES_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'YESBANK BUSINESS') EXEC CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

PRINT 'PROCESS CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT		
		UPLOADID
		,R.BANKCODE
		,ROWTYPE
		,R.VALUEDATE
		,R.DRCR
		,R.INST_NO_CHECK
		,R.INST_AMT
		,DRAWER_NAME
		,R.CLTCODE
		,R.CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY		
	FROM RECON_CMS_DATA R (NOLOCK)
	WHERE VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND MATCHEDFLAG = 0
	AND BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=R.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND RowType<>'DR'
END

IF(@MFSS<>'MFSS')
BEGIN
IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
		INSERT INTO #LEDGER_TO_MAP
		SELECT
			L.VNO
			,L.VTYP
			,L.BOOKTYPE
			,CLTCODE
			,DDNO
			,RELAMT
			,L1.DRCR
			,L.Edt
			,L.Vdt
			,L.NARRATION
		FROM	LEDGER L
				,LEDGER1 L1
		WHERE L.VNO = L1.VNO
		AND L.VTYP = L1.VTYP
		AND L.LNO = L1.LNO
		AND L.BOOKTYPE = L1.BOOKTYPE
		AND L1.RELDT = ''
		AND EXISTS (SELECT
				VNO
			FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO
			AND L11.VTYP = L1.VTYP
			AND L11.BOOKTYPE = L1.BOOKTYPE
			AND L11.CLTCODE = @BANKCODE
			AND L11.VTYP IN (2, 3, 17)
		--AND L11.Vdt<=@VALUEDATE
		)
	END
END
IF(@COMBINEFILE<>0) 
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
	--AND L11.Vdt<=@VALUEDATE
	)
		END
							
END

END


--MFSS
IF(@MFSS='MFSS')
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN	
				
		INSERT INTO #LEDGER_TO_MAP
				SELECT					
				L.VNO
				,L.VTYPE
				,L.BOOKTYPE
				,CLTCODE
				,DDNO=INSTNO
				,RELAMT=CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END
				,DRCR  =CASE WHEN DR_RELAMT=0 THEN 'C' ELSE 'D' END
				,L.Edt
				,L.Vdt
				,L.NARRATION					
			FROM ACC_LEDGER_GL L
			WHERE L.EXCHANGE+'-'+L.SEGMENT=@SEGMENT			
			AND CLTCODE = @BANKCODE
			AND DR_RELDT='' AND CR_RELDT=''
					
			
		END
END
IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF @REPROCESS_FLAG <> 'R'
BEGIN
				DELETE FROM T 
				FROM #CMS_DATA T,RECON_CMS_DATA R
				WHERE  ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 30),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 30),'')
				------AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(T.BANKCODE,'')=ISNULL(R.BANKCODE,'')
				AND R.ROWTYPE<>'DR'

END				

IF EXISTS(SELECT * FROM  #CMS_DATA)
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
	ELSE
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)

	SELECT @VALUEDATE = MAX(VALUEDATE) FROM #CMS_DATA 
	
ALTER TABLE #CMS_DATA
ADD  MATCHCODE INT

SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE INTO #CMS_DATA_DUPLICATE FROM #CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE
HAVING COUNT(*)>1

IF(@FILETYPE='CMS' AND @BANKNAME='SBI')
BEGIN
	UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
	WHERE L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT
	AND C.INST_NO_CHECK=RTRIM(LTRIM(.DBO.PIECE(L.NARRATION,':',2)))
	--AND M.CLTCODE = C.CLTCODE
	--AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)	
	AND M.CLTCODE = L.CLTCODE
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
IF(@FILETYPE='CMS' AND @BANKNAME<>'SBI')
BEGIN
IF @REPROCESS_FLAG = 'R' AND @BANKNAME='YESBANK BUSINESS'
BEGIN
print 'bb'
			UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
	AND L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT	
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
ELSE
BEGIN 
UPDATE C
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,C.VNO = L.VNO
	,C.VTYP = L.VTYP
	,C.BOOKTYPE = L.BOOKTYPE
	,C.MATCHCODE=1
	,CLTCODE=L.CLTCODE
FROM #CMS_DATA C (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
AND L.DDNO<>''
AND C.DRCR = L.DRCR
AND C.INST_AMT = L.RELAMT
--AND M.CLTCODE = C.CLTCODE
AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
AND M.CLTCODE = L.CLTCODE
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
WHERE E.BANKCODE=C.BANKCODE
--AND E.CLTACCNO=C.CLTACCNO
AND E.CLTCODE=C.CLTCODE
AND E.DRCR=C.DRCR
AND E.INST_AMT=C.INST_AMT
AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END 
END


SELECT UPLOADID ,VNO,VTYP,BOOKTYPE INTO #DUPLICATE_CMS_DATA
FROM #CMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE C
	SET	MATCHEDFLAG =0
		,MODIFIEDDATE = ''
		,C.VNO = ''
		,C.VTYP = ''
		,C.BOOKTYPE = ''
		,C.MATCHCODE=''
		,CLTCODE=''
	FROM #CMS_DATA C 
	, #DUPLICATE_CMS_DATA L 
	WHERE C.VNO = L.VNO
	AND C.VTYP = L.VTYP		
	AND C.BOOKTYPE = L.BOOKTYPE	
	AND C.UPLOADID=L.UPLOADID


IF @REPROCESS_FLAG <> 'R' 
BEGIN
SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0) FROM BANKRECO(NOLOCK)				
				
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
, MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY 
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM #CMS_DATA
	
IF(@MFSS<>'MFSS')
BEGIN	
UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO --UPLOADSTATUS
FROM #CMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #CMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
END

ELSE
BEGIN

		UPDATE L4
		SET	 L4.CR_RELDT = CASE WHEN DRCR='C' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_RELDT = CASE WHEN DRCR='D' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_REFNO=CASE WHEN DRCR='D' THEN ISNULL(CAST(@@CROSS_NO AS  INT) + N.SNO,0) ELSE 0 END
			,L4.CR_REFNO=CASE WHEN DRCR='C' THEN ISNULL(CAST(@@CROSS_NO AS  INT) + N.SNO,0) ELSE 0 END			
		FROM #CMS_DATA N, ACC_TBL1 L1, ACC_TBL4 L4
		WHERE L1.SNO = L4.MASTERSNO AND
		 N.VNO = L1.VNO
		AND N.VTYP = L1.VTYPE
		AND N.BOOKTYPE = L1.BOOKTYPE

END
END 
ELSE 
BEGIN

UPDATE RECON_CMS_DATA
SET	VNO = C.VNO
	,VTYP = C.VTYP
	,BOOKTYPE = C.BOOKTYPE
	,MATCHEDFLAG = C.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = C.MODIFIEDDATE
	,MATCHCODE=C.MATCHCODE
	,CLTCODE=C.CLTCODE
FROM #CMS_DATA C, RECON_CMS_DATA R
WHERE C.UPLOADSTATUS = R.CROSS_NO
AND C.MATCHEDFLAG = 1

UPDATE B SET STATUS =CASE WHEN BR.MATCHEDFLAG = 1 THEN 'MATCHED' ELSE 'UNMATCHED' END
			FROM #CMS_DATA BR, BANKRECO B
			WHERE BANKCODE = B.CLTCODE
			AND B.CROSSREFERENCENO = BR.UPLOADSTATUS

IF(@MFSS<>'MFSS')
BEGIN
UPDATE L1 SET RELDT = VALUEDATE	,REFNO = UPLOADSTATUS
			FROM #CMS_DATA N , LEDGER1 L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1 SET EDT = VALUEDATE
			FROM #CMS_DATA N, LEDGER L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE
			AND EDT LIKE 'DEC 31 2049%'
END

ELSE
BEGIN

		UPDATE L4
		SET	 L4.CR_RELDT = CASE WHEN DRCR='C' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_RELDT = CASE WHEN DRCR='D' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_REFNO=CASE WHEN DRCR='D' THEN ISNULL(CAST(@@CROSS_NO AS  INT) + N.SNO,0) ELSE 0 END
			,L4.CR_REFNO=CASE WHEN DRCR='C' THEN ISNULL(CAST(@@CROSS_NO AS  INT) + N.SNO,0) ELSE 0 END			
		FROM #CMS_DATA N, ACC_TBL1 L1, ACC_TBL4 L4
		WHERE L1.SNO = L4.MASTERSNO AND
		 N.VNO = L1.VNO
		AND N.VTYP = L1.VTYPE
		AND N.BOOKTYPE = L1.BOOKTYPE
END
			
END


SELECT	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD>=1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE
DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END


IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO @TEMPBANKACCOUNTMASTER
	SELECT DISTINCT	BANKACCOUNT	FROM RECON_BANK_MASTER_VW WHERE BANKNAME=@BANKNAME AND FILEFORMATE=0 AND FILETYPE=@FILETYPE

INSERT INTO @TEMPBANKACCOUNT
SELECT  DISTINCT BANKACCOUNT  FROM @TEMPBANKACCOUNTMASTER BM,#CMS_DATA T
WHERE LTRIM(RTRIM(T.ROWTYPE))= BM.BANKACCOUNT AND UPLOADID=@UPLOADID

WHILE (SELECT		COUNT(*)	FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT AND BANKNAME =@BANKNAME

SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_CMS_DATA (UPLOADID,
BANKCODE,
ROWTYPE,
VALUEDATE,
DRCR,
INST_NO_CHECK,
INST_AMT,
DRAWER_NAME,
CLTCODE,
CLTACCNO,
VNO,
VTYP,
BOOKTYPE,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY,
CROSS_NO,
MATCHCODE)
										SELECT UPLOADID
										, "+@BANKCODE+"
										, ROWTYPE
										, VALUEDATE
										, DRCR
										, INST_NO_CHECK
										, INST_AMT
										, DRAWER_NAME
										, CLTCODE
										, CLTACCNO
										, VNO
										, VTYP
										, BOOKTYPE
										, MATCHEDFLAG
										, UPLOADSTATUS
										, UPLOADEDDATE
										, MODIFIEDDATE
										, UPLOADBY
										, 0
										, 0
										FROM   #CMS_DATA WHERE ROWTYPE='" + @BANKACCOUNT + "'"

EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "'" + ",'" + @SEGMENT + "'"

EXEC (@@SQL)
--PRINT @@SQL

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_CMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)
END
SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #CMS_DATA
WHERE ROWTYPE = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END
SELECT	@TOTALFILERECORD = COUNT(*)
FROM RECON_CMS_DATA
WHERE UPLOADID = @UPLOADID

END


IF @REPROCESS_FLAG <> 'R' 
BEGIN
IF (@COMBINEFILE<>'0')
BEGIN
/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS
	SET	FILEUPLOAD_EDATE = GETDATE(),VALUEDATE = @VALUEDATE
	WHERE UPLOADID = @UPLOADID

END

END

DROP TABLE #CMS_DATA

END 
ELSE 
IF (@FILETYPE = 'NON-CMS' OR @FILETYPE = 'TECHPROCESS') 
BEGIN

CREATE TABLE #NONCMS_DATA(SRNONCMS INT IDENTITY (1, 1) NOT NULL
, UPLOADID NVARCHAR(50)
, BANKACCOUNT NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, DESCRIPTION NVARCHAR(150)
, LEDGERBALANCE NVARCHAR(50)
, DRCR NVARCHAR(50)
, AMT DECIMAL(20, 2)
, VALUEDATE NVARCHAR(50)
, REFERENCENO NVARCHAR(50)
, CLTACCOUNT NVARCHAR(50)
, CUSTOMERREFERENCE NVARCHAR(300) NULL
, TRANSACTIONDETAIL NVARCHAR(800) NULL
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE DATETIME
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))

CREATE TABLE #LEDGER_TO_MAP_NON(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_HDFC(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)



CREATE TABLE #NONCMS_DATA_DUPLICATE(SRNONCMS INT
, UPLOADID NVARCHAR(50)
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3))

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_NONCMS_HDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME

IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS') EXEC CLS_RECON_NONCMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_NONCMS_KOTAK_PROCESS @UPLOADID ,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') EXEC CLS_RECON_NONCMS_SCB_PROCESS	@UPLOADID ,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_NONCMS_IDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME	

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_NONCMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME

IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_NONCMS_YES_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS') EXEC CLS_RECON_TECHPROCESS_ICICI_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'INDUSIND BANK') EXEC CLS_RECON_NONCMS_INDUSIND_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'AXIS BANK') EXEC CLS_RECON_NONCMS_AXIS_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'RAZORPAY'AND @FILETYPE = 'NON-CMS') EXEC CLS_RECON_NONCMS_RAZORPAY_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME



PRINT 'PROCESS NON CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #NONCMS_DATA
	SELECT		
		UPLOADID
		,BANKACCOUNT
		,BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		
	FROM RECON_NONCMS_DATA(NOLOCK) C
	WHERE C.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND C.MATCHEDFLAG = 0
	AND C.BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=C.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND LedgerBalance<>'DR'
END

ALTER TABLE #NONCMS_DATA
ADD  MATCHCODE INT 


IF(@MFSS<>'MFSS')
BEGIN
IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END
IF(@COMBINEFILE<>0) 
BEGIN
	IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END

INSERT INTO #LEDGER_TO_MAP_NON
	SELECT
		MAX(VNO)
		,MAX(VTYP)
		,MAX(BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,DRCR
		,Edt
		,Vdt
		,NARRATION
	FROM #LEDGER_TO_MAP_NON_HDFC
	GROUP BY	DDNO
				,RELAMT
				,DRCR
				,EDT
				,VDT
				,NARRATION
	HAVING COUNT(1) = 1
END
--MFSS
IF(@MFSS='MFSS')
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA )
	BEGIN
	
		INSERT INTO #LEDGER_TO_MAP_NON
				SELECT					
				L.VNO
				,L.VTYPE
				,L.BOOKTYPE
				,CLTCODE
				,DDNO=INSTNO
				,RELAMT=CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END
				,DRCR  =CASE WHEN DR_RELAMT=0 THEN 'C' ELSE 'D' END
				,L.Edt
				,L.Vdt
				,L.NARRATION					
			FROM ACC_LEDGER_GL L
			WHERE L.EXCHANGE+'-'+L.SEGMENT=@SEGMENT			
			AND CLTCODE = @BANKCODE
			AND DR_RELDT='' AND CR_RELDT=''
		END
	
	
END


IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

	DELETE FROM T
	FROM #NONCMS_DATA T ,RECON_NONCMS_DATA R
	WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
	AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
	AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
	AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
	AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
	AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
	AND R.LEDGERBALANCE <>'DR'

END
	
	IF EXISTS(SELECT * FROM  #NONCMS_DATA)
	BEGIN	
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)	
	END
	ELSE
	BEGIN
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
	END
	SELECT @VALUEDATE =MAX(CONVERT(DATETIME, VALUEDATE, 105)) FROM #NONCMS_DATA 				
	
	SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)FROM BANKRECO(NOLOCK)

IF(@BANKNAME<>'INDUSIND BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) <= 15

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE	
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) > 15

--HDFC BANK FOR CLTACCOUNT
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
--, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE=.DBO.PIECE(REPLACE(DESCRIPTION,' ','|'),'|',2)
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)

AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

--HDFC BANK FOR CLTCODE
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
WHERE L.CLTCODE=RTRIM(LTRIM(SUBSTRING(DESCRIPTION,CHARINDEX('Angel to',DESCRIPTION )+8,len(DESCRIPTION))))
AND Description LIKE '%Angel to%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

IF EXISTS(SELECT * FROM TEMP_NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)

		AND N.MATCHEDFLAG=0

		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',3), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',3)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG=0
	END
	
END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='YES BANK')
BEGIN

INSERT INTO #LEDGER_TO_MAP_NON_YES
SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION FROM 
#LEDGER_TO_MAP_NON  WHERE NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION 
HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=5
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE DESCRIPTION LIKE'%NEFT-RETURN-%'
AND NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='AXIS BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE = .dbo.piece(N.DESCRIPTION,'/',5)
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='KOTAK BANK')
BEGIN


UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0


END
IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
	
	
	
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG = 0
		
	END
IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE '%ATOM %')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = SUBSTRING(REPLACE(DESCRIPTION,'ATOM ',''),0,CHARINDEX(' ',REPLACE(DESCRIPTION,'ATOM ',''))) 
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND MATCHEDFLAG=0
AND DESCRIPTION LIKE '%ATOM %'
AND N.MATCHEDFLAG=0


END
/*COMPARE WITH ENCRYPTION FILE */
IF(@FILETYPE='NON-CMS' AND @BANKNAME='HDFC BANK')
BEGIN

UPDATE N
SET MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = T.VNO
	,N.VTYP = T.VTYP
	,N.BOOKTYPE = T.BOOKTYPE
	,N.MATCHCODE=4
	,N.CUSTOMERREFERENCE=T.CLTCODE
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND T.DDNO<>''
AND N.AMT = T.RELAMT
AND N.MATCHEDFLAG=0

UPDATE E
SET MATCH_STATUS = 1,CROSS_NO=@@CROSS_NO + SRNONCMS
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND N.AMT = T.RELAMT
--AND E.MATCH_STATUS = 0

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='INDUSIND BANK')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND MATCHEDFLAG=0


END

INSERT INTO #NONCMS_DATA_DUPLICATE (UPLOADID ,VNO,VTYP,BOOKTYPE)
SELECT UPLOADID ,VNO,VTYP,BOOKTYPE FROM #NONCMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE N SET MATCHEDFLAG = 0
			,MODIFIEDDATE = ''
			,N.VNO = ''
			,N.VTYP = ''
			,N.BOOKTYPE = ''
			,N.MATCHCODE = ''
			FROM #NONCMS_DATA N	,#NONCMS_DATA_DUPLICATE ND
			WHERE N.VNO=ND.VNO
			AND N.VTYP=ND.VTYP
			AND N.BOOKTYPE=ND.BOOKTYPE
			AND N.UPLOADID=ND.UPLOADID
			
IF (@REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,@@CROSS_NO + SRNONCMS
		,MATCHCODE
	FROM #NONCMS_DATA
IF(@MFSS<>'MFSS')
BEGIN
UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS--UPLOADSTATUS
FROM #NONCMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'	
END
ELSE
BEGIN


		UPDATE L4
		SET	 L4.CR_RELDT = CASE WHEN DRCR='C' THEN CONVERT(DATETIME ,VALUEDATE ,103) ELSE '' END
			,L4.DR_RELDT = CASE WHEN DRCR='D' THEN CONVERT(DATETIME ,VALUEDATE ,103) ELSE '' END
			,L4.DR_REFNO=CASE WHEN DRCR='D' THEN  @@CROSS_NO + SRNONCMS ELSE 0 END
			,L4.CR_REFNO=CASE WHEN DRCR='C' THEN  @@CROSS_NO + SRNONCMS ELSE 0 END			
		FROM #NONCMS_DATA N, ACC_TBL1 L1, ACC_TBL4 L4
		WHERE L1.SNO = L4.MASTERSNO AND
		 N.VNO = L1.VNO
		AND N.VTYP = L1.VTYPE
		AND N.BOOKTYPE = L1.BOOKTYPE
		
END	
END 
	


IF (@REPROCESS_FLAG = 'R') 
BEGIN
UPDATE B
SET	VNO = NR.VNO
	,VTYP = NR.VTYP
	,BOOKTYPE = NR.BOOKTYPE
	,MATCHEDFLAG = NR.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = NR.MODIFIEDDATE
	,MATCHCODE = NR.MATCHCODE
	,CUSTOMERREFERENCE=NR.CUSTOMERREFERENCE
FROM #NONCMS_DATA NR, RECON_NONCMS_DATA B
WHERE b.BANKCODE = @BANKCODE
AND NR.UPLOADSTATUS = B.CROSS_NO
AND NR.MATCHEDFLAG = 1


UPDATE B
SET STATUS =CASE WHEN MATCHEDFLAG = 1 THEN 'MATCHED'	ELSE 'UNMATCHED' END
FROM #NONCMS_DATA NR,BANKRECO B
WHERE B.CLTCODE=@BANKCODE
AND BANKCODE = CLTCODE
AND NR.UPLOADSTATUS = B.CROSSREFERENCENO
IF(@MFSS<>'MFSS')
BEGIN
UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = N.UPLOADSTATUS
FROM #NONCMS_DATA N, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
END
ELSE
BEGIN
		UPDATE L4
		SET	 L4.CR_RELDT = CASE WHEN DRCR='C' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_RELDT = CASE WHEN DRCR='D' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
			,L4.DR_REFNO=CASE WHEN DRCR='D' THEN ISNULL( N.UPLOADSTATUS,0) ELSE 0 END
			,L4.CR_REFNO=CASE WHEN DRCR='C' THEN ISNULL( N.UPLOADSTATUS,0) ELSE 0 END			
		FROM #NONCMS_DATA N, ACC_TBL1 L1, ACC_TBL4 L4
		WHERE L1.SNO = L4.MASTERSNO AND
		 N.VNO = L1.VNO
		AND N.VTYP = L1.VTYPE
		AND N.BOOKTYPE = L1.BOOKTYPE
		

END	
END


SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA(NOLOCK)

IF (@TOTALFILERECORD>0) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE

DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID


END

IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN

INSERT INTO @TEMPBANKACCOUNT
	SELECT DISTINCT
		BANKACCOUNT
	FROM #NONCMS_DATA
DELETE FROM  @TEMPBANKACCOUNT WHERE BANKACCOUNT IS NULL
WHILE (SELECT COUNT(*)FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

IF(@FILETYPE<>'TECHPROCESS')
SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT

IF(@FILETYPE='TECHPROCESS')

SELECT	@SEGMENT = RT.SEGMENT
,@BANKCODE = RB.BANKCODE FROM RECON_BANK_MASTER_VW RB(NOLOCK),RECON_TECH_PROCESS_MASTER_VW RT(NOLOCK)
WHERE  RB.SEGMENT=RT.SEGMENT AND  RB.FILETYPE=@FILETYPE AND RB.BANKNAME=@BANKNAME 
AND RT.ACCOUNTTYPE=@BANKACCOUNT


SELECT
	@@ACCOUNTDB = ACCOUNTDB
	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_NONCMS_DATA (UPLOADID
	,BANKACCOUNT
	,BANKCODE
	,DESCRIPTION
	,LEDGERBALANCE
	,DRCR
	,AMT
	,VALUEDATE
	,REFERENCENO
	,CLTACCOUNT
	,CUSTOMERREFERENCE
	,TRANSACTIONDETAIL
	,VNO
	,VTYP
	,BOOKTYPE
	,MATCHEDFLAG
	,UPLOADSTATUS
	,UPLOADEDDATE
	,MODIFIEDDATE
	,UPLOADBY
	,BOOKDATE
	,CROSS_NO
	,MATCHCODE) 
	SELECT UPLOADID
	 , BANKACCOUNT
	 , "+@BANKCODE+"
	 , DESCRIPTION
	 , LEDGERBALANCE
	 , DRCR
	 , AMT
	 , VALUEDATE
	 , REFERENCENO
	 , CLTACCOUNT
	 , CUSTOMERREFERENCE
	 , TRANSACTIONDETAIL
	 , VNO
	 , VTYP
	 , BOOKTYPE
	 , MATCHEDFLAG
	 , UPLOADSTATUS
	 , UPLOADEDDATE 
	 , MODIFIEDDATE
	 , UPLOADBY
	 , VALUEDATE
	 ,0
	 ,0
	FROM   #NONCMS_DATA  WHERE  BANKACCOUNT='" + @BANKACCOUNT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "','" + @BANKNAME + "'" + ",'" + @FILETYPE + "'" + ",'" + @SEGMENT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_NONCMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)

END

SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #NONCMS_DATA
WHERE BANKACCOUNT = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END

SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD >1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
END



/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */
IF (@COMBINEFILE<>'0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CAST(CROSS_NO AS NVARCHAR(20))
		,CASE WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'	ELSE 'UNMATCHED' END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR ,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2
	AND   CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE	AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1
	AND UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS 
	SET FILEUPLOAD_EDATE=GETDATE(),VALUEDATE=@VALUEDATE  WHERE UPLOADID=@UPLOADID

	END
	DROP TABLE #NONCMS_DATA


END 
ELSE 
BEGIN
PRINT 'PLEASE CHECK SUPPLY PARAMETERS'
DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
END

IF @REPROCESS_FLAG <> 'R'
BEGIN

	IF NOT EXISTS(SELECT * FROM EXISTS_RECORDS_VW WHERE RECORDSTATUS=0 AND UPLOADID=@UPLOADID )
	BEGIN	
	SELECT 'UPLOADED RECORDS ALREADY EXISTS'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END
	ELSE
	BEGIN
	SELECT 'FILE UPLOAD SUCCESSFULLY'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END

END
ELSE
BEGIN
		SELECT 'REPROCESS SUCCESSFULLY'
END

DELETE FROM EXISTS_RECORDS WHERE UPLOADID=@UPLOADID

DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID

DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
END TRY
BEGIN CATCH

SELECT 'ERROR :LINE ' + CONVERT (NVARCHAR(50) ,ERROR_LINE())+ ' MESSAGE: '+ERROR_MESSAGE()

END CATCH
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT
-- --------------------------------------------------




CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT]
		(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

BEGIN         
IF @FILETYPE='0'
SET @FILETYPE=''

DECLARE @CMS_MATCHBY NVARCHAR(100),
@NONCMS_MATCHBY NVARCHAR(35)

SET @CMS_MATCHBY='CHQNO+AMT+DRCR+CLTCODE+ACCNO'
SET @NONCMS_MATCHBY='CHQNO + AMT'

			CREATE TABLE #TEMP_DATA
			(
			CROSSREFNO VARCHAR(12)			
			,FINAL_DT  VARCHAR(25)
			,VNO VARCHAR(12)
			,VTYP INT
			,BOOKTYPE VARCHAR(3)
			,BANKCODE NVARCHAR(20)
			)

			IF(@MATCHEDFLAG='D')
			BEGIN
			INSERT INTO #TEMP_DATA
			SELECT
			.DBO.CLS_PIECE(ITEMS, '^', 1)
			,.DBO.CLS_PIECE(ITEMS, '^', 2)
			,''
			,''
			,''
			,.DBO.CLS_PIECE(ITEMS, '^', 3)
			FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
			WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''

			/*UPDATE T
			SET	T.VNO = L1.VNO
			,T.VTYP = L1.VTYP
			,T.BOOKTYPE = L1.BOOKTYPE
			FROM #TEMP_DATA T, LEDGER1 L1
			WHERE L1.REFNO = T.CROSSREFNO
			*/
			UPDATE T
		SET	T.VNO = L1.VNO
		,T.VTYP = L1.VTYPE
		,T.BOOKTYPE = L1.BOOKTYPE
		FROM #TEMP_DATA T, CLS_RECON_ACC_LEDGER_GL L1
		WHERE MASTERSNO = T.CROSSREFNO

			END
---SELECT * FROM #TEMP_DATA
			CREATE TABLE #TEMP_REPORT
			(
			ROWID     INT          NOT NULL  IDENTITY(1,1)
			, FILEUPLOADID        NVARCHAR(50)
			, UPLOADDATE          DATETIME							
			, VALUEDATE           DATETIME
			, SDATE				  DATETIME
			, EDATE				  DATETIME
			, MATCHEDDATE		  DATETIME
			, SEGMENT             NVARCHAR(50)
			, BANK                NVARCHAR(50)
			, ARRANGEMENTTYPE     NVARCHAR(50)
			, BANKCODE            NVARCHAR(50)
			, BANKACCOUNT         NVARCHAR(50)
			, ACCOUNTNO           NVARCHAR(70)
			, NARRATION           NVARCHAR(MAX)
			, CHEQUENO            NVARCHAR(50)
			, DRCR                NVARCHAR(5)
			, BANKSTATEMENTAMOUNT MONEY
			, VOUCHERAMOUNT       MONEY
			, BANKLOCATION        NVARCHAR(50)
			, ANGELLOCATION       NVARCHAR(50)
			, CLIENTCODE          NVARCHAR(50)
			, CLIENTNAME          NVARCHAR(50)
			, STATUS              NVARCHAR(50)
			, CROSSREFNO          NVARCHAR(50)
			, VOUCHERNO           NVARCHAR(50)
			, MATCHEDBY           NVARCHAR(100)
			, VOUCHERDATE         DATETIME
			, DEPOSITDATE         DATETIME
			, MATCHEDFLAG         BIT
			, VNO                 VARCHAR(15)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, TRAN_STATUS         VARCHAR(12)
			, REPORT_FLAG		  NVARCHAR(100)
			, USERNAME			  NVARCHAR(100)
			--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)
			)
						

			CREATE TABLE #LEDGER_TO_MAP
			(
			VNO                 VARCHAR(12)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, CLTCODE             VARCHAR(10)
			, DDNO                VARCHAR(30)
			, RELAMT              MONEY
			, DRCR                CHAR(1)
			, BANKSTATEMENTAMOUNT MONEY
			, NARRATION           NVARCHAR(250)
			, CLIENTNAME          NVARCHAR(100)
			, VOUCHERNO           NVARCHAR(15)
			, VOUCHERDATE         DATETIME
			)
				
			IF(@FILETYPE ='NON-CMS' OR @FILETYPE='TECHPROCESS' OR @FILETYPE='')
			BEGIN			
					INSERT INTO #TEMP_REPORT
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE 
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,RC.BANKACCOUNT
						,RC.CLTACCOUNT
						,DESCRIPTION AS NARRATION
						,REFERENCENO AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.LEDGERBALANCE AS REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_NONCMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
					ON RC.UPLOADID = RBL.UPLOADID
					AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END	
					AND RC.BANKACCOUNT=RBL.BANKACCOUNT									
					LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
					ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105)
                                                AND CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.LEDGERBALANCE<>'DR'
					
			END
				IF(@FILETYPE ='CMS' OR @FILETYPE='')
				BEGIN
				
					INSERT INTO #TEMP_REPORT				
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,'' AS BANKACCOUNT
						,RC.CLTACCNO
						,'' AS NARRATION
						,RC.INST_NO_CHECK AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,INST_AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.ROWTYPE  REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_CMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
						ON RC.UPLOADID = RBL.UPLOADID
						AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END						
						LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
							ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN CONVERT(DATETIME, @FROM_DATE, 105)	AND		CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.ROWTYPE<>'DR'
					
					
				END
				
				SELECT @BANKCODE=F.BANKCODE 
				FROM RECON_BANK_FILEUPLOAD_LOGS F(NOLOCK),#TEMP_REPORT T
				WHERE F.UPLOADID=T.FILEUPLOADID 
				AND F.BANKNAME=@BANKNAME AND F.SEGMENT= @SEGMENT AND F.FILETYPE=@FILETYPE

IF(@MATCHEDFLAG='R' AND @PARAM_VAL1='')
BEGIN
	
		IF(@MATCHEDFLAG='R')
		BEGIN
		
			SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, BANKACCOUNT
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS
							, REPORT_FLAG
							,''
							,''
							,''
							,'' 
							,USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG<>'DR'
			         
		END
		
END
IF (@MATCHEDFLAG = 'D')
BEGIN 


				IF(@BULKDELETE='BULK')
				BEGIN
				
			ALTER TABLE #TEMP_REPORT
			ADD UPLOADFILENAME VARCHAR(100) ,			
			 UPLOADSTATUS VARCHAR(50) ,			
			 FILEUPLOAD_SDATE VARCHAR(100),		
			 FILEUPLOAD_EDATE VARCHAR(100)


				UPDATE TR SET UPLOADFILENAME=RL.UPLOADFILENAME,UPLOADSTATUS=RL.UPLOADSTATUS
				,FILEUPLOAD_SDATE=RL.FILEUPLOAD_SDATE,FILEUPLOAD_EDATE=RL.FILEUPLOAD_EDATE
				FROM RECON_BANK_FILEUPLOAD_LOGS RL,#TEMP_REPORT TR
				WHERE TR.FILEUPLOADID = RL.UPLOADID
				AND RL.FILETYPE=@FILETYPE
				AND RL.BANKNAME=@BANKNAME
				AND( RL.SEGMENT=@SEGMENT OR @SEGMENT='')
				
				
				SELECT 
				ISNULL(FILEUPLOADID, '') AS UPLOADID
				,ISNULL(SEGMENT,'') AS SEGMENT
				,ISNULL(BANK,'') AS 'BANKNAME'
				,ISNULL(BANKACCOUNT,'') AS BANKACCOUNT 
				,ISNULL(ARRANGEMENTTYPE,'') AS FILETYPE
				,CONVERT(VARCHAR(10), ISNULL(VALUEDATE,''), 105) VALUEDATE --R.VALUEDATE
				,ISNULL(UPLOADFILENAME,'') AS UPLOADFILENAME
				,ISNULL(UPLOADSTATUS,'') AS UPLOADSTATUS
				,MIN(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_SDATE,''), 120)) FILEUPLOAD_SDATE
				,MAX(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_EDATE,''), 120)) FILEUPLOAD_EDATE
				FROM #TEMP_REPORT
				WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			
				GROUP BY ISNULL(FILEUPLOADID, ''),ISNULL(SEGMENT,''),ISNULL(BANK,''),ISNULL(BANKACCOUNT,''),ISNULL(ARRANGEMENTTYPE,''),ISNULL(VALUEDATE,'')
				,ISNULL(UPLOADFILENAME,''),ISNULL(UPLOADSTATUS,''),ISNULL(FILEUPLOAD_SDATE,''),ISNULL(FILEUPLOAD_EDATE,'')

					SELECT
					FILEUPLOADID
					,CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
					,EDATE UPLOADENDDATE
					,CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
					--, SDATE
					,MATCHEDDATE
					,SEGMENT
					,BANK
					,ARRANGEMENTTYPE
					,BANKCODE
					,ACCOUNTNO
					,NARRATION
					,CHEQUENO
					,DRCR
					,BANKSTATEMENTAMOUNT
					,VOUCHERAMOUNT
					,BANKLOCATION
					,ANGELLOCATION
					,CLIENTCODE
					,CLIENTNAME
					,STATUS
					,CROSSREFNO
					,VOUCHERNO
					,MATCHEDBY
					,VOUCHERDATE
					,DEPOSITDATE
					,MATCHEDFLAG
					,VNO
					,VTYP
					,BOOKTYPE
					,TRAN_STATUS
					,USERNAME
				FROM #TEMP_REPORT WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			

				END
			ELSE			
				BEGIN			
							SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS 
							, USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG <>'DR'
							 AND MATCHEDFLAG=0
							 AND (SEGMENT=@SEGMENT OR @SEGMENT='')
							 AND (ARRANGEMENTTYPE=@FILETYPE OR @FILETYPE='')
							 AND (BANK =@BANKNAME OR @BANKNAME='')
							 

		
		IF(@PARAM_VAL1<>'')
		BEGIN

		/*******BANK RECO DELETE************/
		DELETE B
		FROM BANKRECO B, #TEMP_DATA T	WHERE B.CROSSREFERENCENO = T.CROSSREFNO	
		AND B.VALUEDATE=T.FINAL_DT 
		AND B.CLTCODE=T.BANKCODE	
		
		--UPDATE L SET RELDT='' ,REFNO=''
		--FROM LEDGER1 L ,#TEMP_DATA T
		--WHERE L.REFNO=T.CROSSREFNO
		--AND L.RELDT=T.FINAL_DT 
		

		IF(@FILETYPE='CMS')
		BEGIN
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
			, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
			, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)

			SELECT UPLOADID,'',C.BANKCODE,'','CMS '+@BANKNAME,'','',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY
			,'','',VALUEDATE,ROWTYPE,DRCR,INST_NO_CHECK,INST_AMT,DRAWER_NAME,CLTCODE,CLTACCNO,C.VNO
			,C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,'','','',
			'',@LOGINNAME,GETDATE(),'','','' 
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.Valuedate=T.FINAL_DT
			
		
			UPDATE C 
			SET ROWTYPE='DR'
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
		END

		IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS')
		BEGIN
		INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
		, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
		, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
		, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)
		SELECT UPLOADID,'',C.BANKCODE,'','NONCMS '+@BANKNAME,BANKACCOUNT,'',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,
		'','',VALUEDATE,'',DRCR,REFERENCENO,AMT,'','',CLTACCOUNT,C.VNO,
		C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,DESCRIPTION,LEDGERBALANCE,CUSTOMERREFERENCE,
		TRANSACTIONDETAIL,@LOGINNAME,GETDATE(),'','',''
		FROM RECON_NONCMS_DATA C,#TEMP_DATA T
		WHERE C.CROSS_NO=T.CROSSREFNO
		AND C.BANKCODE=T.BANKCODE
		AND C.ValueDate=T.FINAL_DT
			
			UPDATE C 
			SET LEDGERBALANCE='DR'
			FROM RECON_NONCMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
			
			UPDATE E
			SET MATCH_STATUS = 0
			FROM RECON_ENCRYPTION_DETAILS E, #TEMP_DATA T
			WHERE E.CROSS_NO = T.CROSSREFNO
			
		END
		END
		END
		
END

	DROP TABLE #TEMP_DATA
	DROP TABLE #TEMP_REPORT
	DROP TABLE #LEDGER_TO_MAP
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT_Bkup_12Mar18
-- --------------------------------------------------



Create  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT_Bkup_12Mar18]
		(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

BEGIN         
IF @FILETYPE='0'
SET @FILETYPE=''

DECLARE @CMS_MATCHBY NVARCHAR(100),
@NONCMS_MATCHBY NVARCHAR(35)

SET @CMS_MATCHBY='CHQNO+AMT+DRCR+CLTCODE+ACCNO'
SET @NONCMS_MATCHBY='CHQNO + AMT'

			CREATE TABLE #TEMP_DATA
			(
			CROSSREFNO VARCHAR(12)			
			,FINAL_DT  VARCHAR(25)
			,VNO VARCHAR(12)
			,VTYP INT
			,BOOKTYPE VARCHAR(3)
			,BANKCODE NVARCHAR(20)
			)

			IF(@MATCHEDFLAG='D')
			BEGIN
			INSERT INTO #TEMP_DATA
			SELECT
			.DBO.CLS_PIECE(ITEMS, '^', 1)
			,.DBO.CLS_PIECE(ITEMS, '^', 2)
			,''
			,''
			,''
			,.DBO.CLS_PIECE(ITEMS, '^', 3)
			FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
			WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''

			UPDATE T
			SET	T.VNO = L1.VNO
			,T.VTYP = L1.VTYP
			,T.BOOKTYPE = L1.BOOKTYPE
			FROM #TEMP_DATA T, LEDGER1 L1
			WHERE L1.REFNO = T.CROSSREFNO

			END

			CREATE TABLE #TEMP_REPORT
			(
			ROWID     INT          NOT NULL  IDENTITY(1,1)
			, FILEUPLOADID        NVARCHAR(50)
			, UPLOADDATE          DATETIME							
			, VALUEDATE           DATETIME
			, SDATE				  DATETIME
			, EDATE				  DATETIME
			, MATCHEDDATE		  DATETIME
			, SEGMENT             NVARCHAR(50)
			, BANK                NVARCHAR(50)
			, ARRANGEMENTTYPE     NVARCHAR(50)
			, BANKCODE            NVARCHAR(50)
			, BANKACCOUNT         NVARCHAR(50)
			, ACCOUNTNO           NVARCHAR(70)
			, NARRATION           NVARCHAR(MAX)
			, CHEQUENO            NVARCHAR(50)
			, DRCR                NVARCHAR(5)
			, BANKSTATEMENTAMOUNT MONEY
			, VOUCHERAMOUNT       MONEY
			, BANKLOCATION        NVARCHAR(50)
			, ANGELLOCATION       NVARCHAR(50)
			, CLIENTCODE          NVARCHAR(50)
			, CLIENTNAME          NVARCHAR(50)
			, STATUS              NVARCHAR(50)
			, CROSSREFNO          NVARCHAR(50)
			, VOUCHERNO           NVARCHAR(50)
			, MATCHEDBY           NVARCHAR(100)
			, VOUCHERDATE         DATETIME
			, DEPOSITDATE         DATETIME
			, MATCHEDFLAG         BIT
			, VNO                 VARCHAR(15)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, TRAN_STATUS         VARCHAR(12)
			, REPORT_FLAG		  NVARCHAR(100)
			, USERNAME			  NVARCHAR(100)
			--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)
			)
						

			CREATE TABLE #LEDGER_TO_MAP
			(
			VNO                 VARCHAR(12)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, CLTCODE             VARCHAR(10)
			, DDNO                VARCHAR(30)
			, RELAMT              MONEY
			, DRCR                CHAR(1)
			, BANKSTATEMENTAMOUNT MONEY
			, NARRATION           NVARCHAR(250)
			, CLIENTNAME          NVARCHAR(100)
			, VOUCHERNO           NVARCHAR(15)
			, VOUCHERDATE         DATETIME
			)
				
			IF(@FILETYPE ='NON-CMS' OR @FILETYPE='TECHPROCESS' OR @FILETYPE='')
			BEGIN			
					INSERT INTO #TEMP_REPORT
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE 
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,RC.BANKACCOUNT
						,RC.CLTACCOUNT
						,DESCRIPTION AS NARRATION
						,REFERENCENO AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.LEDGERBALANCE AS REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_NONCMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
					ON RC.UPLOADID = RBL.UPLOADID
					AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END										
					LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
					ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105)
                                                AND CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.LEDGERBALANCE<>'DR'
					
			END
				IF(@FILETYPE ='CMS' OR @FILETYPE='')
				BEGIN
				
					INSERT INTO #TEMP_REPORT				
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,'' AS BANKACCOUNT
						,RC.CLTACCNO
						,'' AS NARRATION
						,RC.INST_NO_CHECK AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,INST_AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.ROWTYPE  REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_CMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
						ON RC.UPLOADID = RBL.UPLOADID
						AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END						
						LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
							ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN CONVERT(DATETIME, @FROM_DATE, 105)	AND		CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.ROWTYPE<>'DR'
					
					
				END
				
				SELECT @BANKCODE=F.BANKCODE 
				FROM RECON_BANK_FILEUPLOAD_LOGS F(NOLOCK),#TEMP_REPORT T
				WHERE F.UPLOADID=T.FILEUPLOADID 
				AND F.BANKNAME=@BANKNAME AND F.SEGMENT= @SEGMENT AND F.FILETYPE=@FILETYPE

IF(@MATCHEDFLAG='R' AND @PARAM_VAL1='')
BEGIN
	
		IF(@MATCHEDFLAG='R')
		BEGIN
		
			SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, BANKACCOUNT
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS
							, REPORT_FLAG
							,''
							,''
							,''
							,'' 
							,USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG<>'DR'
			         
		END
		
END
IF (@MATCHEDFLAG = 'D')
BEGIN 


				IF(@BULKDELETE='BULK')
				BEGIN
				
			ALTER TABLE #TEMP_REPORT
			ADD UPLOADFILENAME VARCHAR(100) ,			
			 UPLOADSTATUS VARCHAR(50) ,			
			 FILEUPLOAD_SDATE VARCHAR(100),		
			 FILEUPLOAD_EDATE VARCHAR(100)


				UPDATE TR SET UPLOADFILENAME=RL.UPLOADFILENAME,UPLOADSTATUS=RL.UPLOADSTATUS
				,FILEUPLOAD_SDATE=RL.FILEUPLOAD_SDATE,FILEUPLOAD_EDATE=RL.FILEUPLOAD_EDATE
				FROM RECON_BANK_FILEUPLOAD_LOGS RL,#TEMP_REPORT TR
				WHERE TR.FILEUPLOADID = RL.UPLOADID
				AND RL.FILETYPE=@FILETYPE
				AND RL.BANKNAME=@BANKNAME
				AND( RL.SEGMENT=@SEGMENT OR @SEGMENT='')
				
				
				SELECT 
				ISNULL(FILEUPLOADID, '') AS UPLOADID
				,ISNULL(SEGMENT,'') AS SEGMENT
				,ISNULL(BANK,'') AS 'BANKNAME'
				,ISNULL(BANKACCOUNT,'') AS BANKACCOUNT 
				,ISNULL(ARRANGEMENTTYPE,'') AS FILETYPE
				,CONVERT(VARCHAR(10), ISNULL(VALUEDATE,''), 105) VALUEDATE --R.VALUEDATE
				,ISNULL(UPLOADFILENAME,'') AS UPLOADFILENAME
				,ISNULL(UPLOADSTATUS,'') AS UPLOADSTATUS
				,MIN(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_SDATE,''), 120)) FILEUPLOAD_SDATE
				,MAX(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_EDATE,''), 120)) FILEUPLOAD_EDATE
				FROM #TEMP_REPORT
				WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			
				GROUP BY ISNULL(FILEUPLOADID, ''),ISNULL(SEGMENT,''),ISNULL(BANK,''),ISNULL(BANKACCOUNT,''),ISNULL(ARRANGEMENTTYPE,''),ISNULL(VALUEDATE,'')
				,ISNULL(UPLOADFILENAME,''),ISNULL(UPLOADSTATUS,''),ISNULL(FILEUPLOAD_SDATE,''),ISNULL(FILEUPLOAD_EDATE,'')

					SELECT
					FILEUPLOADID
					,CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
					,EDATE UPLOADENDDATE
					,CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
					--, SDATE
					,MATCHEDDATE
					,SEGMENT
					,BANK
					,ARRANGEMENTTYPE
					,BANKCODE
					,ACCOUNTNO
					,NARRATION
					,CHEQUENO
					,DRCR
					,BANKSTATEMENTAMOUNT
					,VOUCHERAMOUNT
					,BANKLOCATION
					,ANGELLOCATION
					,CLIENTCODE
					,CLIENTNAME
					,STATUS
					,CROSSREFNO
					,VOUCHERNO
					,MATCHEDBY
					,VOUCHERDATE
					,DEPOSITDATE
					,MATCHEDFLAG
					,VNO
					,VTYP
					,BOOKTYPE
					,TRAN_STATUS
					,USERNAME
				FROM #TEMP_REPORT WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			

				END
			ELSE			
				BEGIN			
							SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS 
							, USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG <>'DR'
							 AND MATCHEDFLAG=0
							 AND (SEGMENT=@SEGMENT OR @SEGMENT='')
							 AND (ARRANGEMENTTYPE=@FILETYPE OR @FILETYPE='')
							 AND (BANK =@BANKNAME OR @BANKNAME='')
							 

		
		IF(@PARAM_VAL1<>'')
		BEGIN

		/*******BANK RECO DELETE************/
		DELETE B
		FROM BANKRECO B, #TEMP_DATA T	WHERE B.CROSSREFERENCENO = T.CROSSREFNO	
		AND B.VALUEDATE=T.FINAL_DT 
		AND B.CLTCODE=T.BANKCODE	
		
		--UPDATE L SET RELDT='' ,REFNO=''
		--FROM LEDGER1 L ,#TEMP_DATA T
		--WHERE L.REFNO=T.CROSSREFNO
		--AND L.RELDT=T.FINAL_DT 
		

		IF(@FILETYPE='CMS')
		BEGIN
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
			, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
			, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)

			SELECT UPLOADID,'',C.BANKCODE,'','CMS '+@BANKNAME,'','',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY
			,'','',VALUEDATE,ROWTYPE,DRCR,INST_NO_CHECK,INST_AMT,DRAWER_NAME,CLTCODE,CLTACCNO,C.VNO
			,C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,'','','',
			'',@LOGINNAME,GETDATE(),'','','' 
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.Valuedate=T.FINAL_DT
			
		
			UPDATE C 
			SET ROWTYPE='DR'
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
		END

		IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS')
		BEGIN
		INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
		, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
		, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
		, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)
		SELECT UPLOADID,'',C.BANKCODE,'','NONCMS '+@BANKNAME,BANKACCOUNT,'',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,
		'','',VALUEDATE,'',DRCR,REFERENCENO,AMT,'','',CLTACCOUNT,C.VNO,
		C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,DESCRIPTION,LEDGERBALANCE,CUSTOMERREFERENCE,
		TRANSACTIONDETAIL,@LOGINNAME,GETDATE(),'','',''
		FROM RECON_NONCMS_DATA C,#TEMP_DATA T
		WHERE C.CROSS_NO=T.CROSSREFNO
		AND C.BANKCODE=T.BANKCODE
		AND C.ValueDate=T.FINAL_DT
			
			UPDATE C 
			SET LEDGERBALANCE='DR'
			FROM RECON_NONCMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
			
			UPDATE E
			SET MATCH_STATUS = 0
			FROM RECON_ENCRYPTION_DETAILS E, #TEMP_DATA T
			WHERE E.CROSS_NO = T.CROSSREFNO
			
		END
		END
		END
		
END

	DROP TABLE #TEMP_DATA
	DROP TABLE #TEMP_REPORT
	DROP TABLE #LEDGER_TO_MAP
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER]
(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE  NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

IF @SEGMENT='0'
SET @SEGMENT = ''
IF (@FILETYPE = 'ALL'  OR @FILETYPE = '0') 
SET @FILETYPE = ''

DECLARE @MFSS NVARCHAR(20)
IF(@SEGMENT<>'')
SELECT @MFSS=.DBO.PIECE(@SEGMENT,'-',2)


IF UPPER(@FILETYPE)='ENCRYPTION'
BEGIN 
	SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK)
	WHERE (SEGMENT=@SEGMENT OR @SEGMENT='')
	AND (BANKNAME=@BANKNAME OR @BANKNAME='')
	AND INCRYPTIONDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105) AND CONVERT(DATETIME, @TO_DATE, 105)
	 
END
ELSE
BEGIN
CREATE TABLE #TEMP_REPORT_WRAPPER(ROWID INT NOT NULL IDENTITY (1, 1)
, FILEUPLOADID NVARCHAR(50)
, UPLOADDATE DATETIME
, EDATE DATETIME
, VALUEDATE DATETIME
, MATCHEDDATE DATETIME
--, SDATE				  DATETIME	
, SEGMENT NVARCHAR(50)
, BANK NVARCHAR(50)
, ARRANGEMENTTYPE NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, BANKACCOUNT NVARCHAR(75)
, ACCOUNTNO NVARCHAR(75)
, NARRATION NVARCHAR(MAX)
, CHEQUENO NVARCHAR(70)
, DRCR NVARCHAR(5)
, BANKSTATEMENTAMOUNT MONEY
, VOUCHERAMOUNT MONEY
, BANKLOCATION NVARCHAR(50)
, ANGELLOCATION NVARCHAR(150)
, CLIENTCODE NVARCHAR(50)
, CLIENTNAME NVARCHAR(150)
, STATUS NVARCHAR(50)
, CROSSREFNO NVARCHAR(50)
, VOUCHERNO NVARCHAR(50)
, MATCHEDBY NVARCHAR(250)
, VOUCHERDATE NVARCHAR(50)
, DEPOSITDATE NVARCHAR(50)
, MATCHEDFLAG BIT
, VNO VARCHAR(15)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, TRAN_STATUS VARCHAR(20)
, REPORT_FLAG NVARCHAR(100)
, UPLOADFILENAME NVARCHAR(100)
, UPLOADSTATUS NVARCHAR(15)
, FILEUPLOAD_SDATE DATETIME
, FILEUPLOAD_EDATE DATETIME
, USERNAME NVARCHAR(100)
--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)							
)

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, CLTCODE VARCHAR(10)
, DDNO VARCHAR(30)
, RELAMT MONEY
, DRCR CHAR(1)
, BANKSTATEMENTAMOUNT MONEY
, NARRATION NVARCHAR(250)
, CLIENTNAME NVARCHAR(150)
, VOUCHERNO NVARCHAR(15)
, VOUCHERDATE DATETIME
, SEGMENT VARCHAR(20))

IF @SEGMENT <> '' 
BEGIN


INSERT INTO #TEMP_REPORT_WRAPPER
EXEC [CLS_RECON_MATCH_UNMATCH_REPORT]	@FROM_DATE
										,@TO_DATE
										,@BANKCODE
										,@MATCHEDFLAG
										,@FILETYPE
										,@BANKNAME
										,@SEGMENT
										,@PARAM_VAL1
										,@BULKDELETE
										,@LOGINNAME


--SELECT * FROM #TEMP_REPORT_WRAPPER RETURN

UPDATE TRW
SET	UPLOADFILENAME = RL.UPLOADFILENAME
	,UPLOADSTATUS = RL.UPLOADSTATUS
	,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
	,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
	,TRW.BANKACCOUNT = RL.BANKACCOUNT
FROM RECON_BANK_FILEUPLOAD_LOGS RL, 
#TEMP_REPORT_WRAPPER TRW 
WHERE TRW.FILEUPLOADID = RL.UPLOADID
AND TRW.SEGMENT = RL.SEGMENT
AND TRW.ARRANGEMENTTYPE = RL.FILETYPE
--AND TRW.BankName = RL.BANKNAME
AND TRW.BANKCODE = RL.BANKCODE
AND TRW.BANKACCOUNT=RL.BANKACCOUNT
AND (RL.FILETYPE = @FILETYPE OR @FILETYPE = '')
AND (RL.BANKNAME = @BANKNAME OR @BANKNAME = '')
AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')

SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
FROM #TEMP_REPORT_WRAPPER
WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
AND (BANK = @BANKNAME OR @BANKNAME = '')
AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
GROUP BY	FILEUPLOADID
			,SEGMENT
			,BANK
			,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS


			IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
			BEGIN
			IF(@MFSS<>'MFSS')
			BEGIN
					INSERT INTO #LEDGER_TO_MAP
						SELECT
							L.VNO
							,L.VTYP
							,L.BOOKTYPE
							,L.CLTCODE
							,L1.DDNO
							,L1.RELAMT
							,L1.DRCR
							,L1.RELAMT
							,L.NARRATION
							,L.ACNAME
							,L1.VNO
							,L.VDT
							,SEGMENT = @SEGMENT
						FROM	LEDGER L
								,LEDGER1 L1
								,#TEMP_REPORT_WRAPPER T
						WHERE L.VNO = L1.VNO
						AND L.VTYP = L1.VTYP
						AND L.LNO = L1.LNO
						AND L.BOOKTYPE = L1.BOOKTYPE
						AND L1.VNO = T.VNO
						AND L1.VTYP = T.VTYP
						AND L1.BOOKTYPE = T.BOOKTYPE
						AND EXISTS (SELECT VNO	FROM #TEMP_REPORT_WRAPPER L11 
							WHERE L11.VNO = L.VNO
							AND L11.VTYP = L.VTYP
							AND L11.BOOKTYPE = L.BOOKTYPE	
						)

			END
		IF(@MFSS='MFSS')
		BEGIN	
						
				INSERT INTO #LEDGER_TO_MAP
				
						SELECT
						L.VNO
						,L.VTYPE
						,L.BOOKTYPE
						,CLTCODE
						,DDNO=INSTNO
						,RELAMT=CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END
						,DRCR  =CASE WHEN DR_RELAMT=0 THEN 'C' ELSE 'D' END
						,RELAMT=CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END
						,L.NARRATION
						,L.ACNAME
						,L.VNO
						,L.Vdt
						,SEGMENT = @SEGMENT					
					FROM ACC_LEDGER_GL L
					WHERE L.EXCHANGE+'-'+L.SEGMENT=@SEGMENT			
					AND CLTCODE = @BANKCODE
				END
		
					UPDATE T
					SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
						,CLIENTCODE = L.CLTCODE
						,CLIENTNAME = L.CLIENTNAME
						,VOUCHERNO = L.VOUCHERNO
						,VOUCHERDATE = L.VOUCHERDATE
						,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED'ELSE 'UNRECONCILED' END
						FROM #TEMP_REPORT_WRAPPER T
						, #LEDGER_TO_MAP L
						WHERE T.VNO = L.VNO
						AND T.VTYP = L.VTYP
						AND T.BOOKTYPE = L.BOOKTYPE
						AND T.DRCR = L.DRCR
						AND T.SEGMENT = L.SEGMENT
				END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (RL.BANK = @BANKNAME OR @BANKNAME = '')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')
	ORDER BY CROSSREFNO

	SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (BANK = @BANKNAME OR @BANKNAME = '')
	AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END 

ELSE 

BEGIN
		DECLARE @@ACCOUNTSERVER NVARCHAR(100),@@ACCOUNTDB NVARCHAR(100),@@SQL NVARCHAR(MAX),@@SEGMENT  NVARCHAR(50)
		DECLARE  @TEMP_SEGMENT TABLE(SEGMENT NVARCHAR(50), ACCOUNTDB NVARCHAR(100),ACCOUNTSERVER NVARCHAR(100))

		INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1
		--AND  L.SEGMENT IN ('NSE-CAPITAL','BSE-CAPITAL','NSE-FUTURES','NSX-FUTURES')

		--SELECT * FROM @TEMP_SEGMENT RETURN 
WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
	BEGIN
	
		SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
		
	IF ( (@@ACCOUNTSERVER +( CASE WHEN REPLACE(@@SERVICENAME,'MSSQLSERVER', '') ='' THEN '' ELSE '\'+@@SERVICENAME  END ))<> @@SERVERNAME  )
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
	ELSE
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
		
		
		EXEC (@@SQL)
		PRINT @@SQL	
        
		SET @@SQL = ''
		SET @@SQL ="UPDATE TRW SET	UPLOADFILENAME = RL.UPLOADFILENAME
					,UPLOADSTATUS = RL.UPLOADSTATUS
					,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
					,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
					,TRW.BANKACCOUNT = RL.BANKACCOUNT FROM "
					 + @@ACCOUNTSERVER + "." + @@ACCOUNTDB	+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS RL, #TEMP_REPORT_WRAPPER TRW
					WHERE TRW.FILEUPLOADID = RL.UPLOADID
					AND TRW.SEGMENT = RL.SEGMENT
					AND TRW.ARRANGEMENTTYPE = RL.FILETYPE
					AND TRW.Bank = RL.BANKNAME
					AND TRW.BANKCODE = RL.BANKCODE"
					--AND (RL.FILETYPE = @FILETYPE OR @FILETYPE='')
					--AND (RL.BANKNAME = @BANKNAME OR @BANKNAME='')
					--AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
					EXEC (@@SQL)
					PRINT @@SQL

		DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
	END
	
		CREATE CLUSTERED INDEX IDX_VALUEDATE ON #TEMP_REPORT_WRAPPER
		(
		ROWID,
		VALUEDATE
		)
			SELECT
			FILEUPLOADID AS UPLOADID
			,CASE WHEN BANK='STANDARD CHARTERED BANK' THEN '' -- MAX(SEGMENT)
			WHEN BANK='YES BANK' THEN '' ELSE MAX(SEGMENT) END SEGMENT
			--SELECT
			--FILEUPLOADID AS UPLOADID
			--,'' AS SEGMENT --MAX(SEGMENT)
			,BANK AS 'BANKNAME'
			,MAX(BANKACCOUNT)BANKACCOUNT
			,ARRANGEMENTTYPE AS FILETYPE
			,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
			,UPLOADFILENAME
			,UPLOADSTATUS
			,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
			,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
			FROM #TEMP_REPORT_WRAPPER
			WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='') AND (BANK = @BANKNAME OR @BANKNAME='') AND (SEGMENT = @SEGMENT OR @SEGMENT='')
			GROUP BY	FILEUPLOADID
			,BANK
			--,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS

		IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
		BEGIN

			INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1

			WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
			BEGIN
			SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
			
			SET @@SQL = ''
			SET @@SQL ="INSERT INTO #LEDGER_TO_MAP 
			SELECT L.VNO
			,L.VTYP	,L.BOOKTYPE	,L.CLTCODE,L1.DDNO,L1.RELAMT,L1.DRCR,L1.RELAMT,L.NARRATION,L.ACNAME,L1.VNO,L.VDT,'" + @@SEGMENT + "' FROM " 
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER L ,"
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER1 L1 ,
			#TEMP_REPORT_WRAPPER T
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.VNO = T.VNO
			AND L1.VTYP = T.VTYP
			AND L1.BOOKTYPE = T.BOOKTYPE
			AND EXISTS (SELECT
			VNO
			FROM #TEMP_REPORT_WRAPPER L11 (NOLOCK)
			WHERE L11.VNO = L.VNO
			AND L11.VTYP = L.VTYP
			AND L11.BOOKTYPE = L.BOOKTYPE			
			) "
			
			EXEC (@@SQL)
			PRINT @@SQL
			
			
			
			DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
			END
             
			CREATE CLUSTERED INDEX IDX_LEDGER_TO_MAP ON #LEDGER_TO_MAP
			(
				SEGMENT
			) 
  
			
			UPDATE T
			SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
			,CLIENTCODE = L.CLTCODE
			,CLIENTNAME = L.CLIENTNAME
			,VOUCHERNO = L.VOUCHERNO
			,VOUCHERDATE = L.VOUCHERDATE
			,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED' ELSE 'UNRECONCILED' END
			FROM #TEMP_REPORT_WRAPPER T, #LEDGER_TO_MAP L
			WHERE T.VNO = L.VNO
			AND T.VTYP = L.VTYP
			AND T.BOOKTYPE = L.BOOKTYPE
			AND T.DRCR = L.DRCR
			AND T.SEGMENT = L.SEGMENT
			
			
END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (RL.BANK = @BANKNAME OR @BANKNAME='')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
	ORDER BY CROSSREFNO

SELECT
	FILEUPLOADID AS UPLOADID
	,SEGMENT SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0  END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (BANK = @BANKNAME OR @BANKNAME='')
	AND (SEGMENT = @SEGMENT OR @SEGMENT='')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END

DROP TABLE #LEDGER_TO_MAP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_CMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS
BEGIN
BEGIN TRY 
BEGIN TRAN

	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT
	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)--ISNULL(MAX(CROSSREFERENCENO), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T 
				FROM TEMP_CMS_DATA T,RECON_CMS_DATA R
				WHERE ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 10),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 10),'')
				----AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 10),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 10),'')
				AND R.ROWTYPE<>'DR'

				IF EXISTS(SELECT * FROM  TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)			
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
				
				

				SELECT @VALUEDATE=MAX(VALUEDATE) FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))

CREATE TABLE #LEDGER_TO_MAP_DUPLICATE(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF EXISTS(SELECT TOP 1 * FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)
BEGIN
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
		AND L11.Vdt<=@VALUEDATE)

END

	CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
	(   
		--VDT,
		VNO,
		VTYP,
		BOOKTYPE	
	)
		INSERT INTO #LEDGER_TO_MAP_DUPLICATE
		SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
		#LEDGER_TO_MAP
		GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
		HAVING COUNT(*)=1
		
		
SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO INTO #CMS_DATA_DUPLICATE FROM TEMP_CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO
HAVING COUNT(*)>1

IF(@BANKACCOUNT LIKE '%CAP360%'	OR @BANKACCOUNT LIKE '%NCDEX384%')
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,C.VNO = L.VNO
			,C.VTYP = L.VTYP
			,C.BOOKTYPE = L.BOOKTYPE
			,C.MATCHCODE = 7
			,C.CLTCODE=L.CLTCODE			
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP_DUPLICATE L (NOLOCK)			
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= C.VALUEDATE
			AND C.UPLOADID = @UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
			

		END
		ELSE
		
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
				,MODIFIEDDATE = GETDATE()
				,C.VNO = L.VNO
				,C.VTYP = L.VTYP
				,C.BOOKTYPE = L.BOOKTYPE
				,C.MATCHCODE=1
				,C.CLTCODE=L.CLTCODE
			--, C.BANKCODE = @BANKCODE
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP L (NOLOCK)
			,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			--AND M.CLTCODE = C.CLTCODE
			AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
			AND M.CLTCODE = L.CLTCODE
			AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
			AND C.UPLOADID=@UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
	 END
	 
UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,C.CLTCODE=''
FROM TEMP_CMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_CMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 

				 
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
,MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM TEMP_CMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID

UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER1 L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND N.UPLOADID=@UPLOADID

UPDATE L1
SET EDT = VALUEDATE
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
AND UPLOADID=@UPLOADID

/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID = @UPLOADID

DECLARE @TOTALFILERECORD INT

SELECT 	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD > 0) 
BEGIN
				
	IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
		BEGIN
				
				UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END
	ELSE
		BEGIN
		
			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE)
			SELECT  UPLOADID,SEGMENT,@BANKCODE,BANKNAME,FILETYPE,@BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE
			FROM RECON_BANK_FILEUPLOAD_LOGS_VW
			WHERE UPLOADID=@UPLOADID

			UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END

END
ELSE
BEGIN
IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END

DELETE FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID
COMMIT

END TRY 
 
BEGIN CATCH 

   ROLLBACK

END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@BANKNAME NVARCHAR(50)
,@FILETYPE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS

BEGIN
BEGIN TRY 
BEGIN TRAN

	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T
				FROM TEMP_NONCMS_DATA T ,RECON_NONCMS_DATA R
				WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
				AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
				AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
				AND R.LEDGERBALANCE <>'DR'
				
				IF EXISTS(SELECT * FROM  TEMP_NONCMS_DATA)
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(0)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(1)
				
				SELECT @VALUEDATE=MAX(CONVERT(DATETIME, VALUEDATE, 109)) FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)



IF EXISTS(SELECT TOP 1 * FROM TEMP_NONCMS_DATA )
	BEGIN	
				
		INSERT INTO #LEDGER_TO_MAP
				SELECT					
				L.VNO
				,L.VTYPE
				,L.BOOKTYPE
				,CLTCODE
				,DDNO=INSTNO
				,RELAMT=CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END
				,DRCR  =CASE WHEN DR_RELAMT=0 THEN 'C' ELSE 'D' END
				,L.Edt
				,L.Vdt
				,L.NARRATION					
			FROM ACC_LEDGER_GL L
			WHERE L.EXCHANGE+'-'+L.SEGMENT=@SEGMENT			
			AND CLTCODE = @BANKCODE
			AND DR_RELDT='' AND CR_RELDT=''
					
			
		END
	
CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
(   
    --VDT,
	VNO,
	VTYP,
	BOOKTYPE	
)
CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS')
BEGIN 
 
	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
	#LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1
	 
	 
	UPDATE N
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,N.VNO = L.VNO
		,N.VTYP = L.VTYP
		,N.BOOKTYPE = L.BOOKTYPE
		,N.MATCHCODE=6
		,N.CUSTOMERREFERENCE=L.CLTCODE
	--, N.BANKCODE = @BANKCODE /* ADD*/
	FROM TEMP_NONCMS_DATA N (NOLOCK)
	, #LEDGER_TO_MAP_NON_YES L (NOLOCK)	
	WHERE L.DDNO = N.REFERENCENO
	AND L.DDNO<>''
	--L.CLTCODE = N.REFERENCENO
	AND L.RELAMT = CONVERT(MONEY, N.AMT)
	AND N.DRCR = L.DRCR
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
	AND MATCHEDFLAG = 0
END
IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS')
BEGIN

	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	FROM #LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1


UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEFT(N.REFERENCENO,15)<>''
AND N.UPLOADID=@UPLOADID
AND N.MATCHEDFLAG = 0

IF EXISTS(SELECT * FROM TEMP_NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM TEMP_NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG = 0
	END
END

IF(@BANKNAME <> 'ICICI BANK' )
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)<=15
AND N.UPLOADID=@UPLOADID

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE L.DDNO = N.REFERENCENO
AND  L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)>15
AND N.UPLOADID=@UPLOADID
END

UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,CUSTOMERREFERENCE=''
FROM TEMP_NONCMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_NONCMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 


INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,CONVERT(INT, @@CROSS_NO) + SRNONCMS
		,MATCHCODE
	FROM TEMP_NONCMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID


UPDATE L4
SET	 L4.CR_RELDT = CASE WHEN DRCR='C' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
,L4.DR_RELDT = CASE WHEN DRCR='D' THEN VALUEDATE ELSE '1900-01-01 00:00:00.000' END
,L4.DR_REFNO=CASE WHEN DRCR='D' THEN CONVERT(INT, @@CROSS_NO) + SRNONCMS  ELSE 0 END
,L4.CR_REFNO=CASE WHEN DRCR='C' THEN CONVERT(INT, @@CROSS_NO) + SRNONCMS ELSE 0 END			
FROM TEMP_NONCMS_DATA N, ACC_TBL1 L1, ACC_TBL4 L4
WHERE L1.SNO = L4.MASTERSNO AND
N.VNO = L1.VNO
AND N.VTYP = L1.VTYPE
AND N.BOOKTYPE = L1.BOOKTYPE



/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */

INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR 
			,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2	
	AND UPLOADID = @UPLOADID
	AND BANKACCOUNT=@BANKACCOUNT
	AND CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1


		DECLARE @TOTALFILERECORD INT
		DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID AND SEGMENT='NSE-CAPITAL'
		SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
		WHERE UPLOADID = @UPLOADID

		IF (@TOTALFILERECORD > 0) 
		BEGIN
		
				BEGIN					
												
				    INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
					SELECT  UPLOADID,SEGMENT,@BANKCODE,BANKNAME,FILETYPE,@BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE
					FROM RECON_BANK_FILEUPLOAD_LOGS_VIEW
					WHERE UPLOADID=@UPLOADID 
				

					UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VIEW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
				END

		END
		ELSE
		BEGIN
		IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
					--DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID
					PRINT 'NODATA'

		END
		DELETE FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

COMMIT

END TRY 
 
BEGIN CATCH 

   ROLLBACK

END CATCH

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_AXIS_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_AXIS_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',4) , ''))) AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='CR' THEN 'C'
		WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='DR' THEN 'D' ELSE '' END AS 'DRCR'
	
	,CAST (RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',5))) AS DECIMAL(20,2)) AS 'AMT'
	---,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',2))) AS DATETIME) AS 'VALUEDATE'
	,CONVERT(DATETIME, RTRIM(LTRIM(.DBO.PIECE(FILE_DATA,'',2))), 103) AS 'VALUEDATE'
	---,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' ELSE ISNULL(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',3))) , '') END AS 'REFERENCENO'
	,CASE WHEN  DBO.PIECE(FILE_DATA,'',4) LIKE '%ICONN/%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),'/',2)
		  WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' 	        
		  ELSE ISNULL(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',3))) , '')  END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')<>''
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'VALUE DATE'

	--SELECT * FROM #NONCMS_DATA RETURN
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_HDFC_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_HDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @D VARCHAR(50),@VALUEDATE VARCHAR(11)
SELECT  @D=.DBO.PIECE(@UPLOADFILENAME,'_',2)
 
SELECT @VALUEDATE= STUFF(STUFF( @D, 5, 0, '/'), 3, 0, '/')-- DD/MM/YYYY

IF(@VALUEDATE='' OR @VALUEDATE IS NULL)
BEGIN
	DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
	SELECT		'PLEASE ADD DATE IN THE FILE NAME'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
END
--select @VALUEDATE
CREATE TABLE #NONCMS_HDFC (
	UPLOADID NVARCHAR(50),
	BANKACCOUNT NVARCHAR(50),
	BANKCODE NVARCHAR(50),	
	BOOKDATE NVARCHAR(50),
	DESCRIPTION NVARCHAR(500),
	LEDGERBALANCE NVARCHAR (500) ,
	CREDITAMT NVARCHAR (50),
	DEBITAMT NVARCHAR(50),
	VALUEDATE NVARCHAR(50),
	REFERENCENO NVARCHAR (50),
	TRANSACTIONBRANCH NVARCHAR(500),
	MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #NONCMS_HDFC (UPLOADID,
BANKACCOUNT,
BANKCODE,
BOOKDATE,
DESCRIPTION,
LEDGERBALANCE,
CREDITAMT,
DEBITAMT,
VALUEDATE,
REFERENCENO,
TRANSACTIONBRANCH,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		--,'' AS BANKACCOUNT
		, @BANKCODE 
		,.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '	', 1) BookType
		,.DBO.PIECE(FILE_DATA, '	', 2) Description
		,.DBO.PIECE(FILE_DATA, '	', 3) LedgerBalance
		,.DBO.PIECE(FILE_DATA, '	', 4) Credit
		,.DBO.PIECE(FILE_DATA, '	', 5) Debit
		--,.DBO.PIECE(FILE_DATA, '	', 6) ValueDate
		,@VALUEDATE AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, '	', 7) ReferenceNo
		,.DBO.PIECE(FILE_DATA, '	', 8) TransactionBranch
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, '	', 2) <> ''



INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CustomerReference
, TransaCtionDetail
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,CASE
			WHEN CREDITAMT <> '' THEN 'C'
			WHEN DEBITAMT <> '' THEN 'D'
			ELSE ' '
		END AS DRCR
		,CASE
			WHEN CREDITAMT <> '' THEN REPLACE(REPLACE(REPLACE(CREDITAMT, '(', ''), ')', ''), ',', '')
			WHEN DEBITAMT <> '' THEN REPLACE(REPLACE(REPLACE(DEBITAMT, '(', ''), ')', ''), ',', '')
			ELSE '0'
		END AS AMT
		,REPLACE(VALUEDATE, '/', '-')
		,REFERENCENO
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,MATCHEDFLAG
		,UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
	FROM #NONCMS_HDFC
	WHERE LEDGERBALANCE = ''
PRINT 'INSERTED INTO TEMP TABLE'
DROP TABLE #NONCMS_HDFC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_ICICI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_ICICI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
) 
AS

BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = REPLACE (.DBO.PIECE(FILE_DATA,'"',1),'''','') +
.DBO.PIECE(FILE_DATA,'"',2)+
.DBO.PIECE(FILE_DATA,'"',3)+
.DBO.PIECE(FILE_DATA,'"',4)+
.DBO.PIECE(FILE_DATA,'"',5)+
REPLACE (.DBO.PIECE(FILE_DATA,'"',6),',','')+
.DBO.PIECE(FILE_DATA,'"',7)+
.DBO.PIECE(FILE_DATA,'"',8)+
.DBO.PIECE(FILE_DATA,'"',9)+
.DBO.PIECE(FILE_DATA,'"',10)+
.DBO.PIECE(FILE_DATA,'"',11)+
.DBO.PIECE(FILE_DATA,'"',12)+
.DBO.PIECE(FILE_DATA,'"',13)+
.DBO.PIECE(FILE_DATA,'"',14)+
.DBO.PIECE(FILE_DATA,'"',15)+
.DBO.PIECE(FILE_DATA,'"',16)+
.DBO.PIECE(FILE_DATA,'"',17)+
.DBO.PIECE(FILE_DATA,'"',18)+
.DBO.PIECE(FILE_DATA,'"',19)+
.DBO.PIECE(FILE_DATA,'"',21)+
.DBO.PIECE(FILE_DATA,'"',22)+
.DBO.PIECE(FILE_DATA,'"',23)
FROM MSAJAG.DBO.FILEDATA
WHERE DBO.PIECE(FILE_DATA,'"',2) IS NOT NULL

CREATE TABLE #TEMP_ICICI(UPLOADID NVARCHAR(50),ACCOUNTNUMBER NVARCHAR(50),BANKCODE NVARCHAR(50),TRANDATE DATETIME,InstNum NVARCHAR(100),TRANPARTICULAR NVARCHAR(150),TRANREMARKS NVARCHAR(150)
,DRTRANAMT  MONEY,CRTRANAMT MONEY,DEPOSITBRANCH NVARCHAR(150),MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #TEMP_ICICI
SELECT
	U.UPLOADID
	,.DBO.PIECE(DBO.PIECE(FILE_DATA, ',', 1),':',2)
	, @BANKCODE 
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, ',', 2), 105) 'VALUEDATE' 
	,DBO.PIECE(FILE_DATA, ',', 5) 'INSTNUM'
	,DBO.PIECE(FILE_DATA, ',', 3) 'DESCRIPTION'
	,DBO.PIECE(FILE_DATA, ',', 4) 'DESCRIPTION2'
	,CAST(DBO.PIECE(FILE_DATA, ',', 8) AS DECIMAL(20, 2)) 'DRTRANAMT'
	,CAST(DBO.PIECE(FILE_DATA, ',', 9) AS DECIMAL(20, 2)) 'CRTRANAMT'
	,DBO.PIECE(FILE_DATA, ',', 11) 'DEPOSITBRANCH'
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA, ',', 2) IS NOT NULL
		AND REPLACE(.DBO.PIECE(FILE_DATA, ',', 1), '''', '') NOT IN ('ACCOUNT NUMBER', '','--------------')
		AND DBO.PIECE(FILE_DATA, ',', 3) NOT IN ('B/F')

INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)

SELECT 
UPLOADID
,ACCOUNTNUMBER
,BANKCODE
,TRANPARTICULAR
,''
,CASE WHEN CRTRANAMT <>'' THEN 'C' WHEN DRTRANAMT <> '' THEN 'D'		ELSE ' 'END AS DRCR
,CASE WHEN DRTRANAMT <> '' THEN REPLACE(DRTRANAMT,',','') WHEN CRTRANAMT <> '' THEN REPLACE(CRTRANAMT,',','') ELSE '0' END AS AMT
,TRANDATE
,INSTNUM AS 'REFERENCENO'
,'' AS 'CLTACCOUNT'
, '' AS 'CUSTOMERREFERENCE'
, TRANPARTICULAR+ '|'+DEPOSITBRANCH AS 'TRANSACTIONDETAIL'
,'' AS  VNO
,'' AS  VTYP
,'' AS  BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
 FROM #TEMP_ICICI
-- where ltrim(rtrim(ACCOUNTNUMBER))='000405072363'


 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_IDFC_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_IDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN
INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,CASE WHEN .DBO.PIECE(FILE_DATA,'',3) LIKE '%MUMBAI|IDLCC|%' THEN .DBO.PIECE(.DBO.PIECE(FILE_DATA,'',3),'|',4) ELSE .DBO.PIECE(FILE_DATA,'',3)END  AS 'DESCRIPTION'
		,'' AS 'LEDGERBALANCE'
		, CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END AS 'DRCR'
		,CASE  WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END AS 'AMT'
		, CONVERT( DATETIME,.DBO.PIECE(FILE_DATA,'',2),103) AS 'VALUEDATE'
		,.DBO.PIECE(FILE_DATA,'',4) AS 'REFERENCENO'
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,0 AS 'MATCHEDFLAG'
		,UPLOADSTATUS
		,GETDATE()
		,MODIFIEDDATE
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

--SELECT * FROM #NONCMS_DATA RETURN

END

--SELECT DRCR= CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END ,
--AMOUNT=CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END 

--FROM MSAJAG..FILEDATA
--WHERE ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
--AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_INDUSIND_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_INDUSIND_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

IF(@FILE_PATH<>'')
	BEGIN
--SELECT @FILE_PATH RETURN
DECLARE @SQL NVARCHAR(MAX)
SET @SQL="SELECT * INTO XLImport FROM OPENDATASOURCE('Microsoft.Ace.OLEDB.12.0',
'Data Source="+@FILE_PATH +";Extended Properties=Excel 8.0')...[Sheet1$]"
EXEC (@SQL)
PRINT @SQL


			INSERT INTO #NONCMS_DATA 
			SELECT
			@UPLOADID
			,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
			,@BANKCODE AS BANKCODE
			,F5 AS DESCRIPTION
			,'' AS LEDGERBALANCE
			,CASE WHEN ISNULL(F4 , '')='Credit' THEN 'C' ELSE 'D' END AS DRCR
			,CASE WHEN F6<>'' THEN CAST (F6 AS DECIMAL(20,2))  ELSE CAST (F7 AS DECIMAL(20,2)) END  --CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
			,CONVERT(DATETIME,F2,105)  AS VALUEDATE
			,CASE WHEN F5 LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF TO',F5)+8,LEN(F5)),'/',1)))
			WHEN F5 LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF FRM',F5)+8,LEN(F5)),'///',1)))
			WHEN F5 LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(F5,', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END	 AS REFERENCENO
			,'' AS CLTACCOUNT
			,'' AS CUSTOMERREFERENCE
			,'' AS TRANSACTIONDETAIL
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0
			,'PENDING' AS 'UPLOADSTATUS'
			,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
			,GETDATE()
			,@UNAME	
			FROM XLImport 
			WHERE F2<>''
			AND F1 NOT IN ('CustomerName','Bank Reference')
			AND F4 NOT IN('ToDate')
				
		DROP TABLE XLImport
		
	END
	IF(@FILE_PATH='')
	BEGIN
	--SELECT .dbo.piece(DBO.PIECE(FILE_DATA,'',4),':',2) FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID  and DBO.PIECE(FILE_DATA,'',4) like '%Account No :%'

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',4) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CAST (DBO.PIECE(FILE_DATA,'',5) AS DECIMAL(20,2))  AS AMT
				,CONVERT(DATETIME,CONVERT(VARCHAR(11),CONVERT(DATETIME,.DBO.CLS_REMOVE_SPACE(DBO.PIECE(FILE_DATA,'',1)),103),101))
				,CASE WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'/',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'///',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),', ',3),'C/NO ',''),'///','')))
				ELSE '' END  AS REFERENCENO
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',3) IN('DEBIT','CREDIT')
					AND DBO.PIECE(FILE_DATA,'',3)<>''
					
			
	END
	/* OLD FORMAT
	BEGIN

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',5) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',4) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CASE WHEN DBO.PIECE(FILE_DATA,'',6)<>'' THEN CAST (DBO.PIECE(FILE_DATA,'',6) AS DECIMAL(20,2))  ELSE CAST (DBO.PIECE(FILE_DATA,'',7) AS DECIMAL(20,2)) END   AS AMT
				,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,'',2),105)  AS VALUEDATE
				,CASE WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'/',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'///',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',5),', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END AS REFERENCE
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',4) in('Debit','Credit')
	END
	*/
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_KOTAK_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_KOTAK_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA =.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 1)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 2)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 3)	
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 4)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 5)
	+REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 6), ',', '')
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 7)
	+ISNULL(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 8), ',', ''), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 9), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 10), '')
WHERE PROGID = @UPLOADID
----AND .DBO.PIECE(FILE_DATA, '"=""', 4) LIKE '%FF %'

		INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		,@BANKCODE AS BANKCODE
		,LEFT (RIGHT(DBO.PIECE(FILE_DATA,',',3),LEN(DBO.PIECE(FILE_DATA,',',3)) - 1) ,50)AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',',6) , '')='CR' THEN 'C' ELSE 'D' END AS DRCR
		,CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',2),105)  AS VALUEDATE
		--,DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2) AS REFERENCENO
		,CASE WHEN .DBO.PIECE(FILE_DATA, ',', 4) LIKE '=GBM%' THEN .DBO.PIECE (.DBO.PIECE(FILE_DATA, ',', 4),'-',2) 
			  ELSE .DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2)  END AS REFERENCENO
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA,',',6) IN ('DR','CR')
		AND DBO.PIECE(FILE_DATA,',',6) IS NOT NULL

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_RAZORPAY_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_RAZORPAY_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN
DECLARE @SQL NVARCHAR(800)
SET @SQL = ''
SET @SQL = @SQL + ' SELECT * INTO ##CLSRECONTABLE FROM CLSRECONTABLE_'+@UPLOADID
SET @SQL = @SQL + ' DROP TABLE CLSRECONTABLE_'+@UPLOADID

PRINT @SQL
EXEC(@SQL)

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)

	SELECT
	(SELECT UPLOADID FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'UPLOADID'
	,SEGMENT_NAME AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,REF_NO+'_'+CLIENT_CODE +'_'+ SETTLEMENT_UTR+'_'+SEGMENT_NAME AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,'C' AS 'DRCR'	
	,CAST (RTRIM(LTRIM(AMOUNT)) AS DECIMAL(20,2)) AS 'AMOUNT'
	,CONVERT(DATETIME, RTRIM(LTRIM(SETTLEMENT_INITIATED_ON)), 103) AS 'VALUEDATE'
	, REF_NO AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM ##CLSRECONTABLE
	WHERE ISNULL(AMOUNT , '')<>''
	
	DROP TABLE ##CLSRECONTABLE
	--DELETE FROM #NONCMS_DATA WHERE BANKACCOUNT<>'NSE'
	--SELECT * FROM #NONCMS_DATA WHERE BANKACCOUNT='NSE'
	--return
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_SBI_PROCESS
-- --------------------------------------------------




Create PROCEDURE [dbo].[CLS_RECON_NONCMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

--SELECT * INTO #TEMP2 FROM  #TEMP  WHERE DBO.PIECE(FILE_DATA,'	',2) <> ''
DECLARE @CLOSINGBALANCE NVARCHAR(50)
SELECT TOP 1 @CLOSINGBALANCE= CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',8))) AS MONEY) FROM MSAJAG..FILEDATA 
WHERE .DBO.PIECE(FILE_DATA,'	',2) <> ''
AND PROGID=@UPLOADID 
ORDER BY SRNO DESC

INSERT INTO #NONCMS_DATA (
	UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG

, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) 
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMT'
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	--,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'REFERENCENO'
	--, SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGACV',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) AS 'REFERENCENO'
	, CASE WHEN .DBO.PIECE(FILE_DATA,'	',4) like '%IGA%' THEN
	 SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGA',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) 
	WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%' THEN SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGAD',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
		ELSE '' END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',4))) AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME
	--,@CLOSINGBALANCE	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #NONCMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_Recon_NONCMS_SCB_Process
-- --------------------------------------------------



 CREATE PROCEDURE [dbo].[CLS_Recon_NONCMS_SCB_Process] (@UPLOADID nvarchar(50), @UPLOAD_FLAG CHAR(1),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
       

--DECLARE @UPLOADID NVARCHAR(50) 
--SET @UPLOADID='35CBA453'


IF @UPLOAD_FLAG = 'B'
BEGIN
UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, '"', 1), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 2), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 3), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 4), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 5), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 6), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 7), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 8), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 9), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 10), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 11), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 12), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 13), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 14), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 15), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 16), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 17), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 18), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 19), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 20), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 21), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 22), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 23), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 24), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 25), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 26), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 27), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 28), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 29), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 30), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 31), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 32), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 33), '')
WHERE PROGID = @UPLOADID
END

INSERT INTO #NONCMS_DATA
	SELECT
		U.UPLOADID
		,.dbo.piece(FILE_DATA, ',', 2) AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,'' AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE
			WHEN.dbo.piece(FILE_DATA, ',', 16) = 'Credit' THEN 'C'
			ELSE 'D'
		END AS DRCR
		,CAST(.dbo.piece(FILE_DATA, ',', 32) AS DECIMAL(20, 2)) AS AMT
		,CONVERT(DATETIME,.DBO.PIECE(FILE_DATA, ',', 60), 105) AS VALUEDATE
		,.dbo.piece(FILE_DATA, ',', 30) AS REFERENCENO
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UploadStatus
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM Recon_bank_FileUpload_logs U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.dbo.piece(FILE_DATA, ',', 32) NOT IN (''
	, 'Transaction Amount')
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_YES_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_YES_PROCESS]
( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 

AS 
BEGIN

--UPDATE MSAJAG.DBO.FILEDATA
--SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
----REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), 'NET TXN: ', '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '')
--WHERE PROGID = @UPLOADID
--AND .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%'
--AND  .DBO.PIECE(FILE_DATA, ',', 5) NOT LIKE '% to %'


INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,LEFT(.DBO.PIECE(FILE_DATA, ',', 5), 149) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 3) AS DECIMAL(20, 2)) AS AMT
		, CONVERT (DATETIME ,REPLACE(.DBO.PIECE(FILE_DATA, ',', 2),'/','-'),105) AS VALUEDATE
		,CASE WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%RTGS-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NEFT-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  (.DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%' AND .DBO.PIECE(FILE_DATA, ',', 4)='D') THEN LEFT(.DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2)), CHARINDEX(' ', .DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2))))
		ELSE .DBO.PIECE(FILE_DATA, ',', 6)
		END AS REFERENCENO
		,.DBO.PIECE(FILE_DATA, ',', 7) AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, ',', 2) <> ''
	AND.DBO.PIECE(FILE_DATA, ',', 6) IS NOT NULL
	AND.DBO.PIECE(FILE_DATA, ',', 6) <> 'REFERENCE NO.'

--DROP TABLE #NONCMS_DATA
PRINT 'INSERTED INTO TEMP TABLE'


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_TECHPROCESS_ICICI_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_TECHPROCESS_ICICI_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN

DECLARE @VALUEDATE VARCHAR(10)
SELECT TOP 1 @VALUEDATE=.DBO.PIECE(.DBO.PIECE(FILE_DATA, ':', 2),',',1) FROM MSAJAG..FILEDATA 
WHERE PROGID=@UPLOADID
ORDER BY SRNO ASC


UPDATE MSAJAG.DBO.FILEDATA SET FILE_DATA=ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 11), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 12), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 13), '') + ',' +
ISNULL(REPLACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 14),':',3),'}',''), '') 
WHERE .DBO.PIECE(FILE_DATA, ',', 14) LIKE '%ITC:ABC_123%'

INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		--,CASE WHEN  .DBO.PIECE(FILE_DATA,',',14) NOT LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',2)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3) 
		--WHEN .DBO.PIECE(FILE_DATA,',',14)  LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',4) ELSE '' END
		--AS 'BANKACCOUNT'
		, .DBO.PIECE(.DBO.PIECE(FILE_DATA,',',14),'_',2) AS 'BANKACCOUNT'
		,@BANKCODE AS BANKCODE
		,.DBO.PIECE(FILE_DATA, ',', 14) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,'C'  AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 7) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,RTRIM(LTRIM(@VALUEDATE)),126)  AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS REFERENCENO		
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID=@UPLOADID
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>''
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>'Bank_ID'		
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMBINED_VOUCHER_UPLOAD
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMBINED_VOUCHER_UPLOAD_NEW
-- --------------------------------------------------

--EXEC COMBINED_VOUCHER_UPLOAD_NEW '122417168201', '', 8, '01', 'BSE', 'MFSS', 'demo', '1'

CREATE PROC [dbo].[COMBINED_VOUCHER_UPLOAD_NEW]  
 @PROGID VARCHAR(16),  
 @ENTRY_TYPE VARCHAR(10),  
 @VTYPE [UDTVTYPE],  
 @BOOKTYPE [UDTBOOKTYPE],  
 @EXCHANGE [UDTEXCHANGE],  
 @SEGMENT [UDTSEGMENT],  
 @UNAME VARCHAR(50),  
 @USER_CATEGORY INT,  
 @DISP_BLOCK CHAR(1) = 'N' -- 'N' > FULL DISPLAY / 'Y' > SPECIFIC BLOCK DISPLAY  
   
AS  
  
 SET NOCOUNT ON  
 --BEGIN TRY  
 
 DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
 CREATE TABLE #FILE_FORMAT  
 (  
  SRNO INT,  
  VDATE DATETIME,  
  EDATE DATETIME,  
 )  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'CLTCODE|MAINCODE',  
  'UDTPARTYCODE|UDTPARTYCODE',  
  '',  
  ''  
  
 ALTER TABLE #FILE_FORMAT  
  ADD AMOUNT MONEY,  
  DRCR CHAR(1)  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'NARRATION|BRANCHCODE',  
  'UDTNARRATION|UDTBRANCHCODE',  
  '',  
  ''  
  
  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD CASHCODE VARCHAR(10)  
 END  
  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKNAME VARCHAR(50),  
  DDNO VARCHAR(20),  
  BRANCHNAME VARCHAR(50),  
  CHQMODE VARCHAR(10),  
  CHQDATE DATETIME,  
  CLMODE VARCHAR(10)  
 END  
  
 IF @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKCODE VARCHAR(10),  
  ACCCODE VARCHAR(20)  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 20  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKCODE VARCHAR(10),  
  CHQNAME VARCHAR(100)  
 END  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'EXCHANGE|SEGMENT',  
  'UDTEXCHANGE|UDTSEGMENT',  
  '',  
  ''  
  
  
  
 DECLARE  
  @@SQL VARCHAR(8000),  
  @@MKCK_FLAG TINYINT  
  

 SET @@SQL = "INSERT INTO #FILE_FORMAT"  
 SET @@SQL = @@SQL + " SELECT  .DBO.PIECE(FILEDATA, ',', 1) ,CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 2), 103), CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 3), 103), .DBO.PIECE(FILEDATA, ',', 4), .DBO.PIECE(FILEDATA, ',', 5), .DBO.PIECE(FILEDATA, ',', 6), .DBO.PIECE(FILEDATA, ',', 7), .DBO.PIECE(FILEDATA, ',', 8), .DBO.PIECE(FILEDATA, ',', 9)/*, .DBO.PIECE(FILEDATA, ',', 10)*/ "  


 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 11)"  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 11), .DBO.PIECE(FILEDATA, ',', 12), .DBO.PIECE(FILEDATA, ',', 13), .DBO.PIECE(FILEDATA, ',', 14), CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 15), 103), .DBO.PIECE(FILEDATA, ',', 16) "  
 END  
 IF @VTYPE = 2 OR @VTYPE = 3 OR @VTYPE = 19 OR @VTYPE = 20  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 17) , .DBO.PIECE(FILEDATA, ',', 18)"  
 END  
 SET @@SQL = @@SQL + ",'" + @EXCHANGE + "','" + @SEGMENT + "'"  
 SET @@SQL = @@SQL + " FROM FILE_DATA WHERE PROGID = '" + @PROGID + "'"  
 print @@SQL
 EXEC(@@SQL)
 
 /*IF @BOOKTYPE = ''
 BEGIN
	SELECT @BOOKTYPE = BOOKTYPE FROM ACMAST A, #FILE_FORMAT F WHERE A.CLTCODE = BANKCODE AND A.EXCHANGE = @EXCHANGE AND A.SEGMENT = @SEGMENT
 END*/
 
   
 SET @@SQL = "INSERT INTO VOUCHER_UPLOAD(SRNO, VDATE, EDATE, CLTCODE, MAINCODE, AMOUNT, DRCR, NARRATION, BRANCHCODE/*, L1_SRNO*/"  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SET @@SQL = @@SQL + ", CASHCODE"  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKNAME, DDNO, BRANCHNAME, CHQMODE, CHQDATE, CLMODE"  
 END  
 IF @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKCODE, ACCCODE"  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 20  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKCODE, CHQNAME"  
 END  
 SET @@SQL = @@SQL + ",EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, PROGID)"  
 SET @@SQL = @@SQL + "SELECT *, " + CONVERT(VARCHAR,@VTYPE) + ",'" + @BOOKTYPE + "','" + @PROGID + "' FROM #FILE_FORMAT"  
 PRINT @@SQL
 EXEC (@@SQL)  


   
 IF @VTYPE = 5  
 BEGIN  
  UPDATE VOUCHER_UPLOAD SET BANKCODE = CLTCODE, CLTCODE = '' WHERE PROGID = @PROGID  
 END  
  
 UPDATE VOUCHER_UPLOAD SET MARGINCODE = MAINCODE WHERE PROGID = @PROGID  
  
 UPDATE V SET V.BOOKTYPE = A.BOOKTYPE FROM VOUCHER_UPLOAD V, ACMAST A  
 WHERE (V.BANKCODE = A.CLTCODE OR V.CASHCODE = A.CLTCODE) AND V.BOOKTYPE = ''  
  AND A.EXCHANGE = @EXCHANGE AND A.SEGMENT = @SEGMENT  
  AND PROGID = @PROGID  
  
 DECLARE   
  @@ERROR_COUNT INT  
  

 -------------- VALIDATIONS ----------------  
 -------------- ACCOUNT MASTER MISMATCH ----------------  
 IF @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, MARGINCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 4 AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 14 AND A.CLTCODE = V.MARGINCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  )A  
  IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR MARGIN CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
    SELECT [ACCOUNT CODE] = CLTCODE, [MARGIN CODE] = MARGINCODE  
    FROM VOUCHER_UPLOAD V   
    WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 4 AND A.CLTCODE = V.CLTCODE)  
    AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 14 AND A.CLTCODE = V.MARGINCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
    AND PROGID = @PROGID  
  
    RAISERROR ('ACCOUNT CODES OR MARGIN CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
    --RETURN  
   END  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 2 AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  )A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [BANK CODE] = BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 2 AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, CASHCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 1 AND A.CLTCODE = V.CASHCODE)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR CASH CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [CASH CODE] = CASHCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 1 AND A.CLTCODE = V.CASHCODE)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR CASH CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 IF @VTYPE = 5  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(1, 2) AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [BANK CODE] = BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(1, 2) AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 ELSE  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT CLTCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
  
 ------------------ MULTIPLE BANK/CASH/MARGIN/VDT IN SINGLE SRNO ----------------  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT BANKCODE), 0),            
   SRNO  
  FROM                      
   VOUCHER_UPLOAD  
  WHERE BANKCODE <> '' AND PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT BANKCODE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [BANK CODES] = BANKCODE                      
  FROM                      
   VOUCHER_UPLOAD   
  WHERE BANKCODE <> '' AND PROGID = @PROGID                          
     
  
  RAISERROR('MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT CASHCODE), 0),            
   SRNO                      
  FROM                      
   VOUCHER_UPLOAD  
  WHERE CASHCODE <> '' AND PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT CASHCODE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE CASH CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [CASH CODES] = CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT CASHCODE), 0))  
  FROM                      
   VOUCHER_UPLOAD   
  WHERE CASHCODE <> '' AND PROGID = @PROGID                          
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT CASHCODE) > 1       
  
  RAISERROR('MULTIPLE CASH CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 IF @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
  FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT MARGINCODE), 0),            
    SRNO                      
   FROM                      
    VOUCHER_UPLOAD  
   WHERE MARGINCODE <> '' AND PROGID = @PROGID                    
   GROUP BY                      
    SRNO                      
   HAVING                      
    COUNT(DISTINCT MARGINCODE) > 1                      
  ) A                      
  IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE MARGIN CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
   SELECT                      
    [SRNO] = SRNO, [MARGIN CODES] = MARGINCODE  
   FROM                      
    VOUCHER_UPLOAD   
   WHERE MARGINCODE <> '' AND PROGID = @PROGID                          
     
   RAISERROR('MULTIPLE MARGIN CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
  END  
 END  
  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT VDATE), 0),            
   SRNO                      
  FROM                      
   VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT VDATE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE COUCHER DATES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [VOUCHER DATES] = VDATE  
  FROM                      
   VOUCHER_UPLOAD   
  WHERE PROGID = @PROGID                          
   
  RAISERROR('MULTIPLE VOUCHER DATES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
 
-- SELECT * FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
 
 /*SELECT V.* FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U, VOUCHER_UPLOAD V  
 WHERE U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) >= START_DATE_ADD AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) <= END_DATE_ADD AND PROGID = @PROGID  */
  
 --------------- CHECK USERRIGHTS -------------------  
 -------- CONVERT START_DATE_ADD TO 112 ---------------   
 /*SELECT @@ERROR_COUNT = COUNT(1) FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U, VOUCHER_UPLOAD V  
 WHERE U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) >= START_DATE_ADD AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) <= END_DATE_ADD AND PROGID = @PROGID  
  
 IF @@ERROR_COUNT = 0                      
 BEGIN  
  SELECT  
   [ACCOUNT CODE] = CLTCODE, [VOUCHER DATE] = VDATE, [AMOUNT] = AMOUNT  
  FROM   
   .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U,   
   VOUCHER_UPLOAD V  
  WHERE   
   U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND (CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) < START_DATE_ADD OR CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) > END_DATE_ADD) AND PROGID = @PROGID  
  
  RAISERROR('YOU DO NOT HAVE A PERMISSION TO DO THIS ENTRY.', 16, 1)  
 END  */
  
 SELECT @@MKCK_FLAG = MKCKFLAG FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY)  
 ---------------- EDATE SHOULD BE GRATER THAN VDATE ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD  
 WHERE VDATE > EDATE  
 AND PROGID = @PROGID  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'EFFECTIVE DATE CAN NOT BE GRATER THAN VOUCHER DATE. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT  
   [VOUCHER DATE] = VDATE, [EFFECTIVE DATE] = EDATE   
  FROM   
   VOUCHER_UPLOAD  
  WHERE VDATE > EDATE  
  AND PROGID = @PROGID  
  
  RAISERROR('EFFECTIVE DATE CAN NOT BE GRATER THAN VOUCHER DATE. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 ---------------- AMOUNT SHOULD BE LESS THAN 0 ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD  
 WHERE AMOUNT < 0  
 AND PROGID = @PROGID  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'AMOUNT CAN NOT BE LESS THAN 0. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT [PARTY CODE] = CLTCODE, AMOUNT = AMOUNT  
  FROM   
   VOUCHER_UPLOAD  
  WHERE AMOUNT < 0  
  AND PROGID = @PROGID  
  
  RAISERROR('AMOUNT CAN NOT BE LESS THAN 0. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 ---------------- CHEQUE NUMBER ALREDY EXISTS ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD V  
 WHERE BANKCODE <> ''  
 AND PROGID = @PROGID  
 AND EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4, ACC_TBL1 A1 WHERE A1.SNO = A4.MASTERSNO AND V.VTYPE = A1.VTYPE AND V.BOOKTYPE = A1.BOOKTYPE AND V.DDNO = A4.INSTNO AND ISNULL(V.DDNO, '0') <> '0' AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
 AND CLEARMODE <> 'R' AND A1.EXCHANGE = V.EXCHANGE AND A1.SEGMENT = V.SEGMENT)  
  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT [ACCOUNT CODE] = CLTCODE, [CHEQUE NO] = DDNO  
  FROM VOUCHER_UPLOAD V  
  WHERE BANKCODE <> ''  
  AND PROGID = @PROGID  
  AND EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4, ACC_TBL1 A1 WHERE A1.SNO = A4.MASTERSNO AND V.VTYPE = A1.VTYPE AND V.BOOKTYPE = A1.BOOKTYPE AND V.DDNO = A4.INSTNO AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
  AND CLEARMODE <> 'R' AND A1.EXCHANGE = V.EXCHANGE AND A1.SEGMENT = V.SEGMENT)  
  
  RAISERROR('FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
   
 ELSE  
 BEGIN  
  -- PENDING VALIDATIONS --  
  -- CHECK DRCR & AVAILABLE MARGIN   
  IF (SELECT COUNT(1) FROM  
  (  
   SELECT SRNO, DRCRMIS = SUM(AMOUNT) FROM   
   (  
    SELECT SRNO, AMOUNT = CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END  
    FROM  
    VOUCHER_UPLOAD  
    WHERE  
    PROGID = @PROGID  
    UNION ALL  
    SELECT SRNO, AMOUNT = CASE WHEN DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END  
    FROM  
    VOUCHER_UPLOAD  
    WHERE  
    PROGID = @PROGID  
    AND (BANKCODE <> '' OR CASHCODE <> '')  
   ) A  
   GROUP BY SRNO  
   HAVING SUM(AMOUNT) <> 0  
  ) A ) > 0  
  BEGIN  
   SELECT ERROR_CODE = '2', ERROR_DESCRIPTION = 'FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [CHEQUE NO] = DDNO  
   FROM VOUCHER_UPLOAD V  
   WHERE BANKCODE <> ''  
   AND PROGID = @PROGID  
   AND NOT EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4 WHERE V.DDNO = A4.INSTNO AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
   AND CLEARMODE <> 'R')  
  
   RAISERROR('FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
  
  END  
 END  
  
 IF @VTYPE = 1 OR @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1)  
  FROM VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID  
  GROUP BY SRNO  
  HAVING SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 4 OR @VTYPE = 20  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1)  
  FROM VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID  
  GROUP BY SRNO  
  HAVING SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) < 0  
 END  
  
 IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'INVALID FILE FORMAT'  
  RAISERROR ('INVALID FILE FORMAT', 16, 1)  
  --SELECT 'INVALID FILE FORMAT.'   
 END  
  
 SET NOCOUNT OFF  
  
 UPDATE VOUCHER_UPLOAD SET LNO = (SELECT COUNT(1) + 1 FROM VOUCHER_UPLOAD I WHERE VOUCHER_UPLOAD.SRNO = I.SRNO AND I.SNO < VOUCHER_UPLOAD.SNO AND VOUCHER_UPLOAD.PROGID = I.PROGID)  
 WHERE PROGID = @PROGID  
  
 UPDATE V SET   
  CLIENTNAME = A.LONGNAME,   
  MARGINCODENAME = B.LONGNAME  
 FROM   
  VOUCHER_UPLOAD V,   
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT NOT IN(1, 2)) A,  
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT NOT IN(1, 2)) B  
 WHERE   
  V.CLTCODE = A.CLTCODE  
  AND MARGINCODE = B.CLTCODE  
  
 UPDATE V SET   
  OPPCODENAME = C.LONGNAME  
 FROM   
  VOUCHER_UPLOAD V,   
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT IN(1, 2)) C  
 WHERE  
  C.CLTCODE = CASE WHEN @ENTRY_TYPE = 'CASH' THEN CASHCODE ELSE BANKCODE END  
  AND (CASHCODE IS NOT NULL OR BANKCODE IS NOT NULL)  
  
 IF @@MKCK_FLAG = 4 OR @DISP_BLOCK = 'Y'  
 BEGIN  
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
   (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME,  
   BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT,  
   TPFLAG, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT,  
   LEDGERVNO,CLIENTNAME,OPPCODENAME,MARGINCODENAME,RESERVED2)  
  SELECT   
   @VTYPE, BOOKTYPE, LNO, VDATE, EDATE, CLTCODE, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END,  
   NARRATION, BANKCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHQMODE, CHQDATE, CASE WHEN CHQNAME = '' THEN CLIENTNAME ELSE CHQNAME END, CLMODE,  
   ACCCODE, EXCHANGE, SEGMENT, 1, GETDATE(), @UNAME, 'BROKER', 'BROKER', 0, 1, GETDATE(), @UNAME, PROGID, GETDATE(), '',CLIENTNAME,OPPCODENAME,MARGINCODENAME, SRNO  
  FROM    
   VOUCHER_UPLOAD  
  WHERE   
   PROGID = @PROGID  
 END  
 ELSE  
 BEGIN  
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
   (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME,  
   BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT,  
   TPFLAG, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT,  
   LEDGERVNO,CLIENTNAME,OPPCODENAME,MARGINCODENAME,RESERVED2)  
  SELECT   
   @VTYPE, BOOKTYPE, LNO, VDATE, EDATE, CLTCODE, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END,  
   NARRATION, BANKCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHQMODE, CHQDATE, CASE WHEN CHQNAME = '' THEN CLIENTNAME ELSE CHQNAME END, CLMODE,  
   ACCCODE, EXCHANGE, SEGMENT, 1, GETDATE(), @UNAME, 'BROKER', 'BROKER', 0, 0, GETDATE(), @UNAME, PROGID, GETDATE(), '',CLIENTNAME,OPPCODENAME,MARGINCODENAME, SRNO  
  FROM    
   VOUCHER_UPLOAD  
  WHERE   
   PROGID = @PROGID  
 END  
 SET NOCOUNT ON  
  
 DECLARE  
  @@AUTOPOSTING BIT  
  
 IF @DISP_BLOCK = 'N'  
 BEGIN  
  SELECT @@AUTOPOSTING = AUTOPOSTING FROM OFFLINE_VOUCHER_SETTING  
 END  
 ELSE  
 BEGIN  
  SET @@AUTOPOSTING = 1  
 END  
  
 IF @@AUTOPOSTING = 1  
 BEGIN  
  --PRINT '1'  
  EXEC FA_POSTING @PROGID  
    
  IF @DISP_BLOCK = 'N'  
  BEGIN  
   /*SELECT [ACCOUNT CODE] = '', [CHEQUE NO] = '', AMOUNT = 0  
   FROM VOUCHER_UPLOAD V  
   WHERE 1 = 0  */
     
   SELECT ERROR_CODE = '0', ERROR_DESCRIPTION = 'NO ERROR'  
     
   SELECT  
    CLTCODE,  
    VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
    EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
    AMOUNT = CASE WHEN CREDITAMT > 0 THEN CONVERT(VARCHAR, CREDITAMT) ELSE '(' + CONVERT(VARCHAR, DEBITAMT) + ')' END,  
    NARRATION,  
    BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
    MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
    DDNO,  
    VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END  
   FROM   
    V2_OFFLINE_LEDGER_ENTRIES  
   WHERE   
    VOUCHERNO = @PROGID   
  END  
    
  ELSE  
  BEGIN  
   /*INSERT INTO  
    #POSTING  */
   SELECT  
    CLTCODE,  
    VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
    EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
    AMOUNT = CASE WHEN CREDITAMT > 0 THEN CREDITAMT ELSE DEBITAMT END,  
    NARRATION,  
    BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
    MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
    DDNO,  
    VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END  
   FROM   
    V2_OFFLINE_LEDGER_ENTRIES  
   WHERE   
    VOUCHERNO = @PROGID  
  END  
 END  
 ELSE  
 BEGIN    
  /*SELECT [ACCOUNT CODE] = '', [CHEQUE NO] = '', AMOUNT = 0  
  FROM VOUCHER_UPLOAD V  
  WHERE 1 = 0  */
    
  SELECT ERROR_CODE = '0', ERROR_DESCRIPTION = 'NO ERROR'  
    
  SELECT  
   CLTCODE,   
   VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
   EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
   AMOUNT = CASE WHEN CREDITAMT > 0 THEN CONVERT(VARCHAR, CREDITAMT) ELSE '(' + CONVERT(VARCHAR, DEBITAMT) + ')' END,  
   NARRATION,  
   BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
   MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
   DDNO,  
   VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END    FROM   
   V2_OFFLINE_LEDGER_ENTRIES  
  WHERE   
   VOUCHERNO = @PROGID    
 END  
  
 --DELETE FROM FILE_DATA WHERE PROGID = @PROGID  
 --DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
  
 /*END TRY  
 BEGIN CATCH  
  IF @@TRANCOUNT > 0  
   ROLLBACK TRAN  
  
  --DELETE FROM FILE_DATA WHERE PROGID = @PROGID  
  --DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
    
  DECLARE @ERR_MSG NVARCHAR(2048)  
  SET @ERR_MSG = ERROR_MESSAGE()  
    
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = @ERR_MSG  
    
  RETURN  
 END CATCH  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMBINED_VOUCHER_UPLOAD_NEW_28122015
-- --------------------------------------------------
--EXEC COMBINED_VOUCHER_UPLOAD_NEW '122417168201', '', 8, '01', 'BSE', 'MFSS', 'demo', '1'

CREATE PROC [dbo].[COMBINED_VOUCHER_UPLOAD_NEW]  
 @PROGID VARCHAR(16),  
 @ENTRY_TYPE VARCHAR(10),  
 @VTYPE [UDTVTYPE],  
 @BOOKTYPE [UDTBOOKTYPE],  
 @EXCHANGE [UDTEXCHANGE],  
 @SEGMENT [UDTSEGMENT],  
 @UNAME VARCHAR(50),  
 @USER_CATEGORY INT,  
 @DISP_BLOCK CHAR(1) = 'N' -- 'N' > FULL DISPLAY / 'Y' > SPECIFIC BLOCK DISPLAY  
   
AS  
  
 SET NOCOUNT ON  
 --BEGIN TRY  
 
 DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
 CREATE TABLE #FILE_FORMAT  
 (  
  SRNO INT,  
  VDATE DATETIME,  
  EDATE DATETIME,  
 )  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'CLTCODE|MAINCODE',  
  'UDTPARTYCODE|UDTPARTYCODE',  
  '',  
  ''  
  
 ALTER TABLE #FILE_FORMAT  
  ADD AMOUNT MONEY,  
  DRCR CHAR(1)  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'NARRATION|BRANCHCODE',  
  'UDTNARRATION|UDTBRANCHCODE',  
  '',  
  ''  
  
  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD CASHCODE VARCHAR(10)  
 END  
  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKNAME VARCHAR(50),  
  DDNO VARCHAR(20),  
  BRANCHNAME VARCHAR(50),  
  CHQMODE VARCHAR(10),  
  CHQDATE DATETIME,  
  CLMODE VARCHAR(10)  
 END  
  
 IF @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKCODE VARCHAR(10),  
  ACCCODE VARCHAR(20)  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 20  
 BEGIN  
  ALTER TABLE #FILE_FORMAT  
  ADD BANKCODE VARCHAR(10),  
  CHQNAME VARCHAR(100)  
 END  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#FILE_FORMAT',  
  'EXCHANGE|SEGMENT',  
  'UDTEXCHANGE|UDTSEGMENT',  
  '',  
  ''  
  
  
  
 DECLARE  
  @@SQL VARCHAR(8000),  
  @@MKCK_FLAG TINYINT  
  
 SET @@SQL = "INSERT INTO #FILE_FORMAT"  
 SET @@SQL = @@SQL + " SELECT  .DBO.PIECE(FILEDATA, ',', 1) ,CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 2), 103), CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 3), 103), .DBO.PIECE(FILEDATA, ',', 4), .DBO.PIECE(FILEDATA, ',', 5), .DBO.PIECE(FILEDATA, ',', 6), .DBO.PIECE(FILEDATA, ',', 7), .DBO.PIECE(FILEDATA, ',', 8), .DBO.PIECE(FILEDATA, ',', 9)/*, .DBO.PIECE(FILEDATA, ',', 10)*/ "  


 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 11)"  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 11), .DBO.PIECE(FILEDATA, ',', 12), .DBO.PIECE(FILEDATA, ',', 13), .DBO.PIECE(FILEDATA, ',', 14), CONVERT(DATETIME, .DBO.PIECE(FILEDATA, ',', 15), 103), .DBO.PIECE(FILEDATA, ',', 16) "  
 END  
 IF @VTYPE = 2 OR @VTYPE = 3 OR @VTYPE = 19 OR @VTYPE = 20  
 BEGIN  
  SET @@SQL = @@SQL + ", .DBO.PIECE(FILEDATA, ',', 17) , .DBO.PIECE(FILEDATA, ',', 18)"  
 END  
 SET @@SQL = @@SQL + ",'" + @EXCHANGE + "','" + @SEGMENT + "'"  
 SET @@SQL = @@SQL + " FROM FILE_DATA WHERE PROGID = '" + @PROGID + "'"  
 print @@SQL
 EXEC(@@SQL)
 
 /*IF @BOOKTYPE = ''
 BEGIN
	SELECT @BOOKTYPE = BOOKTYPE FROM ACMAST A, #FILE_FORMAT F WHERE A.CLTCODE = BANKCODE AND A.EXCHANGE = @EXCHANGE AND A.SEGMENT = @SEGMENT
 END*/
 
   
 SET @@SQL = "INSERT INTO VOUCHER_UPLOAD(SRNO, VDATE, EDATE, CLTCODE, MAINCODE, AMOUNT, DRCR, NARRATION, BRANCHCODE/*, L1_SRNO*/"  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SET @@SQL = @@SQL + ", CASHCODE"  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKNAME, DDNO, BRANCHNAME, CHQMODE, CHQDATE, CLMODE"  
 END  
 IF @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKCODE, ACCCODE"  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 20  
 BEGIN  
  SET @@SQL = @@SQL + ", BANKCODE, CHQNAME"  
 END  
 SET @@SQL = @@SQL + ",EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, PROGID)"  
 SET @@SQL = @@SQL + "SELECT *, " + CONVERT(VARCHAR,@VTYPE) + ",'" + @BOOKTYPE + "','" + @PROGID + "' FROM #FILE_FORMAT"  
 PRINT @@SQL
 EXEC (@@SQL)  


   
 IF @VTYPE = 5  
 BEGIN  
  UPDATE VOUCHER_UPLOAD SET BANKCODE = CLTCODE, CLTCODE = '' WHERE PROGID = @PROGID  
 END  
  
 UPDATE VOUCHER_UPLOAD SET MARGINCODE = MAINCODE WHERE PROGID = @PROGID  
  
 UPDATE V SET V.BOOKTYPE = A.BOOKTYPE FROM VOUCHER_UPLOAD V, ACMAST A  
 WHERE (V.BANKCODE = A.CLTCODE OR V.CASHCODE = A.CLTCODE) AND V.BOOKTYPE = ''  
  AND A.EXCHANGE = @EXCHANGE AND A.SEGMENT = @SEGMENT  
  AND PROGID = @PROGID  
  
 DECLARE   
  @@ERROR_COUNT INT  
  

 -------------- VALIDATIONS ----------------  
 -------------- ACCOUNT MASTER MISMATCH ----------------  
 IF @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, MARGINCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 4 AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 14 AND A.CLTCODE = V.MARGINCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  )A  
  IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR MARGIN CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
    SELECT [ACCOUNT CODE] = CLTCODE, [MARGIN CODE] = MARGINCODE  
    FROM VOUCHER_UPLOAD V   
    WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 4 AND A.CLTCODE = V.CLTCODE)  
    AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 14 AND A.CLTCODE = V.MARGINCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
    AND PROGID = @PROGID  
  
    RAISERROR ('ACCOUNT CODES OR MARGIN CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
    --RETURN  
   END  
 END  
 IF @ENTRY_TYPE = 'BANK' OR @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 2 AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  )A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [BANK CODE] = BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 2 AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 IF @ENTRY_TYPE = 'CASH'  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, CASHCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 1 AND A.CLTCODE = V.CASHCODE)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR CASH CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [CASH CODE] = CASHCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE)  
   AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT = 1 AND A.CLTCODE = V.CASHCODE)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR CASH CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 IF @VTYPE = 5  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE, BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(1, 2) AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [BANK CODE] = BANKCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(1, 2) AND A.CLTCODE = V.BANKCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES OR BANK CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
 ELSE  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1) FROM  
  (  
   SELECT CLTCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  ) A  
  
  IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'ACCOUNT CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.'  
  
   SELECT CLTCODE  
   FROM VOUCHER_UPLOAD V   
   WHERE CLTCODE <> '' AND NOT EXISTS(SELECT CLTCODE FROM ACMAST A WHERE ACCAT IN(3, 4, 18) AND A.CLTCODE = V.CLTCODE AND A.EXCHANGE = V.EXCHANGE AND A.SEGMENT = V.SEGMENT)  
   AND PROGID = @PROGID  
  
   RAISERROR ('ACCOUNT CODES SPECIFIED IN BELLOW LIST DOES NOT EXIST.', 16, 1)  
  END  
 END  
  
 ------------------ MULTIPLE BANK/CASH/MARGIN/VDT IN SINGLE SRNO ----------------  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT BANKCODE), 0),            
   SRNO  
  FROM                      
   VOUCHER_UPLOAD  
  WHERE BANKCODE <> '' AND PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT BANKCODE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [BANK CODES] = BANKCODE                      
  FROM                      
   VOUCHER_UPLOAD   
  WHERE BANKCODE <> '' AND PROGID = @PROGID                          
     
  
  RAISERROR('MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT CASHCODE), 0),            
   SRNO                      
  FROM                      
   VOUCHER_UPLOAD  
  WHERE CASHCODE <> '' AND PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT CASHCODE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE CASH CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [CASH CODES] = CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT CASHCODE), 0))  
  FROM                      
   VOUCHER_UPLOAD   
  WHERE CASHCODE <> '' AND PROGID = @PROGID                          
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT CASHCODE) > 1       
  
  RAISERROR('MULTIPLE CASH CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 IF @ENTRY_TYPE = 'MARGIN'  
 BEGIN  
  SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
  FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT MARGINCODE), 0),            
    SRNO                      
   FROM                      
    VOUCHER_UPLOAD  
   WHERE MARGINCODE <> '' AND PROGID = @PROGID                    
   GROUP BY                      
    SRNO                      
   HAVING                      
    COUNT(DISTINCT MARGINCODE) > 1                      
  ) A                      
  IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE MARGIN CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
   SELECT                      
    [SRNO] = SRNO, [MARGIN CODES] = MARGINCODE  
   FROM                      
    VOUCHER_UPLOAD   
   WHERE MARGINCODE <> '' AND PROGID = @PROGID                          
     
   RAISERROR('MULTIPLE MARGIN CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
  END  
 END  
  
 SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
 FROM                      
 (                      
  SELECT                      
   BANK_CNT = ISNULL(COUNT(DISTINCT VDATE), 0),            
   SRNO                      
  FROM                      
   VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID                    
  GROUP BY                      
   SRNO                      
  HAVING                      
   COUNT(DISTINCT VDATE) > 1                      
 ) A                      
 IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'MULTIPLE COUCHER DATES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT                      
   [SRNO] = SRNO, [VOUCHER DATES] = VDATE  
  FROM                      
   VOUCHER_UPLOAD   
  WHERE PROGID = @PROGID                          
   
  RAISERROR('MULTIPLE VOUCHER DATES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
 
-- SELECT * FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
 
 /*SELECT V.* FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U, VOUCHER_UPLOAD V  
 WHERE U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) >= START_DATE_ADD AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) <= END_DATE_ADD AND PROGID = @PROGID  */
  
 --------------- CHECK USERRIGHTS -------------------  
 -------- CONVERT START_DATE_ADD TO 112 ---------------   
 /*SELECT @@ERROR_COUNT = COUNT(1) FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U, VOUCHER_UPLOAD V  
 WHERE U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) >= START_DATE_ADD AND CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) <= END_DATE_ADD AND PROGID = @PROGID  
  
 IF @@ERROR_COUNT = 0                      
 BEGIN  
  SELECT  
   [ACCOUNT CODE] = CLTCODE, [VOUCHER DATE] = VDATE, [AMOUNT] = AMOUNT  
  FROM   
   .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY) U,   
   VOUCHER_UPLOAD V  
  WHERE   
   U.VTYPE = V.VTYPE AND U.BOOKTYPE = V.BOOKTYPE AND (CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) < START_DATE_ADD OR CONVERT(NUMERIC, CONVERT(VARCHAR, VDATE, 112)) > END_DATE_ADD) AND PROGID = @PROGID  
  
  RAISERROR('YOU DO NOT HAVE A PERMISSION TO DO THIS ENTRY.', 16, 1)  
 END  */
  
 SELECT @@MKCK_FLAG = MKCKFLAG FROM .dbo.FN_USERRIGHTS(@VTYPE, @BOOKTYPE, @EXCHANGE, @SEGMENT, @UNAME, @USER_CATEGORY)  
 ---------------- EDATE SHOULD BE GRATER THAN VDATE ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD  
 WHERE VDATE > EDATE  
 AND PROGID = @PROGID  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'EFFECTIVE DATE CAN NOT BE GRATER THAN VOUCHER DATE. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT  
   [VOUCHER DATE] = VDATE, [EFFECTIVE DATE] = EDATE   
  FROM   
   VOUCHER_UPLOAD  
  WHERE VDATE > EDATE  
  AND PROGID = @PROGID  
  
  RAISERROR('EFFECTIVE DATE CAN NOT BE GRATER THAN VOUCHER DATE. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 ---------------- AMOUNT SHOULD BE LESS THAN 0 ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD  
 WHERE AMOUNT < 0  
 AND PROGID = @PROGID  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'AMOUNT CAN NOT BE LESS THAN 0. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT [PARTY CODE] = CLTCODE, AMOUNT = AMOUNT  
  FROM   
   VOUCHER_UPLOAD  
  WHERE AMOUNT < 0  
  AND PROGID = @PROGID  
  
  RAISERROR('AMOUNT CAN NOT BE LESS THAN 0. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
  
 ---------------- CHEQUE NUMBER ALREDY EXISTS ---------------  
 SELECT @@ERROR_COUNT = COUNT(1) FROM VOUCHER_UPLOAD V  
 WHERE BANKCODE <> ''  
 AND PROGID = @PROGID  
 AND EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4, ACC_TBL1 A1 WHERE A1.SNO = A4.MASTERSNO AND V.VTYPE = A1.VTYPE AND V.BOOKTYPE = A1.BOOKTYPE AND V.DDNO = A4.INSTNO AND ISNULL(V.DDNO, '0') <> '0' AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
 AND CLEARMODE <> 'R' AND A1.EXCHANGE = V.EXCHANGE AND A1.SEGMENT = V.SEGMENT)  
  
 IF @@ERROR_COUNT > 0                      
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
  SELECT [ACCOUNT CODE] = CLTCODE, [CHEQUE NO] = DDNO  
  FROM VOUCHER_UPLOAD V  
  WHERE BANKCODE <> ''  
  AND PROGID = @PROGID  
  AND EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4, ACC_TBL1 A1 WHERE A1.SNO = A4.MASTERSNO AND V.VTYPE = A1.VTYPE AND V.BOOKTYPE = A1.BOOKTYPE AND V.DDNO = A4.INSTNO AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
  AND CLEARMODE <> 'R' AND A1.EXCHANGE = V.EXCHANGE AND A1.SEGMENT = V.SEGMENT)  
  
  RAISERROR('FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
 END  
   
 ELSE  
 BEGIN  
  -- PENDING VALIDATIONS --  
  -- CHECK DRCR & AVAILABLE MARGIN   
  IF (SELECT COUNT(1) FROM  
  (  
   SELECT SRNO, DRCRMIS = SUM(AMOUNT) FROM   
   (  
    SELECT SRNO, AMOUNT = CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END  
    FROM  
    VOUCHER_UPLOAD  
    WHERE  
    PROGID = @PROGID  
    UNION ALL  
    SELECT SRNO, AMOUNT = CASE WHEN DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END  
    FROM  
    VOUCHER_UPLOAD  
    WHERE  
    PROGID = @PROGID  
    AND (BANKCODE <> '' OR CASHCODE <> '')  
   ) A  
   GROUP BY SRNO  
   HAVING SUM(AMOUNT) <> 0  
  ) A ) > 0  
  BEGIN  
   SELECT ERROR_CODE = '2', ERROR_DESCRIPTION = 'FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.'  
  
   SELECT [ACCOUNT CODE] = CLTCODE, [CHEQUE NO] = DDNO  
   FROM VOUCHER_UPLOAD V  
   WHERE BANKCODE <> ''  
   AND PROGID = @PROGID  
   AND NOT EXISTS(SELECT BNKNAME FROM ACC_TBL4 A4 WHERE V.DDNO = A4.INSTNO AND CHQDD = 'C' AND V.BANKNAME = A4.BNKNAME  
   AND CLEARMODE <> 'R')  
  
   RAISERROR('FOLLOWING CHEQUE NUMBERS ARE ALREADY EXISTS. PLEASE REFER TO THE FOLLOWING ROWS.', 16, 1)  
  
  END  
 END  
  
 IF @VTYPE = 1 OR @VTYPE = 2 OR @VTYPE = 19  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1)  
  FROM VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID  
  GROUP BY SRNO  
  HAVING SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) > 0  
 END  
  
 IF @VTYPE = 3 OR @VTYPE = 4 OR @VTYPE = 20  
 BEGIN  
  SELECT @@ERROR_COUNT = COUNT(1)  
  FROM VOUCHER_UPLOAD  
  WHERE PROGID = @PROGID  
  GROUP BY SRNO  
  HAVING SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END) < 0  
 END  
  
 IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = 'INVALID FILE FORMAT'  
  RAISERROR ('INVALID FILE FORMAT', 16, 1)  
  --SELECT 'INVALID FILE FORMAT.'   
 END  
  
 SET NOCOUNT OFF  
  
 UPDATE VOUCHER_UPLOAD SET LNO = (SELECT COUNT(1) + 1 FROM VOUCHER_UPLOAD I WHERE VOUCHER_UPLOAD.SRNO = I.SRNO AND I.SNO < VOUCHER_UPLOAD.SNO)  
 WHERE PROGID = @PROGID  
  
 UPDATE V SET   
  CLIENTNAME = A.LONGNAME,   
  MARGINCODENAME = B.LONGNAME  
 FROM   
  VOUCHER_UPLOAD V,   
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT NOT IN(1, 2)) A,  
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT NOT IN(1, 2)) B  
 WHERE   
  V.CLTCODE = A.CLTCODE  
  AND MARGINCODE = B.CLTCODE  
  
 UPDATE V SET   
  OPPCODENAME = C.LONGNAME  
 FROM   
  VOUCHER_UPLOAD V,   
  (SELECT CLTCODE, LONGNAME FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND ACCAT IN(1, 2)) C  
 WHERE  
  C.CLTCODE = CASE WHEN @ENTRY_TYPE = 'CASH' THEN CASHCODE ELSE BANKCODE END  
  AND (CASHCODE IS NOT NULL OR BANKCODE IS NOT NULL)  
  
 IF @@MKCK_FLAG = 4 OR @DISP_BLOCK = 'Y'  
 BEGIN  
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
   (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME,  
   BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT,  
   TPFLAG, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT,  
   LEDGERVNO,CLIENTNAME,OPPCODENAME,MARGINCODENAME,RESERVED2)  
  SELECT   
   @VTYPE, BOOKTYPE, LNO, VDATE, EDATE, CLTCODE, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END,  
   NARRATION, BANKCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHQMODE, CHQDATE, CASE WHEN CHQNAME = '' THEN CLIENTNAME ELSE CHQNAME END, CLMODE,  
   ACCCODE, EXCHANGE, SEGMENT, 1, GETDATE(), @UNAME, 'BROKER', 'BROKER', 0, 1, GETDATE(), @UNAME, PROGID, GETDATE(), '',CLIENTNAME,OPPCODENAME,MARGINCODENAME, SRNO  
  FROM    
   VOUCHER_UPLOAD  
  WHERE   
   PROGID = @PROGID  
 END  
 ELSE  
 BEGIN  
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
   (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME,  
   BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT,  
   TPFLAG, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT,  
   LEDGERVNO,CLIENTNAME,OPPCODENAME,MARGINCODENAME,RESERVED2)  
  SELECT   
   @VTYPE, BOOKTYPE, LNO, VDATE, EDATE, CLTCODE, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END,  
   NARRATION, BANKCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHQMODE, CHQDATE, CASE WHEN CHQNAME = '' THEN CLIENTNAME ELSE CHQNAME END, CLMODE,  
   ACCCODE, EXCHANGE, SEGMENT, 1, GETDATE(), @UNAME, 'BROKER', 'BROKER', 0, 0, GETDATE(), @UNAME, PROGID, GETDATE(), '',CLIENTNAME,OPPCODENAME,MARGINCODENAME, SRNO  
  FROM    
   VOUCHER_UPLOAD  
  WHERE   
   PROGID = @PROGID  
 END  
 SET NOCOUNT ON  
  
 DECLARE  
  @@AUTOPOSTING BIT  
  
 IF @DISP_BLOCK = 'N'  
 BEGIN  
  SELECT @@AUTOPOSTING = AUTOPOSTING FROM OFFLINE_VOUCHER_SETTING  
 END  
 ELSE  
 BEGIN  
  SET @@AUTOPOSTING = 1  
 END  
  
 IF @@AUTOPOSTING = 1  
 BEGIN  
  --PRINT '1'  
  EXEC FA_POSTING @PROGID  
    
  IF @DISP_BLOCK = 'N'  
  BEGIN  
   /*SELECT [ACCOUNT CODE] = '', [CHEQUE NO] = '', AMOUNT = 0  
   FROM VOUCHER_UPLOAD V  
   WHERE 1 = 0  */
     
   SELECT ERROR_CODE = '0', ERROR_DESCRIPTION = 'NO ERROR'  
     
   SELECT  
    CLTCODE,  
    VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
    EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
    AMOUNT = CASE WHEN CREDITAMT > 0 THEN CONVERT(VARCHAR, CREDITAMT) ELSE '(' + CONVERT(VARCHAR, DEBITAMT) + ')' END,  
    NARRATION,  
    BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
    MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
    DDNO,  
    VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END  
   FROM   
    V2_OFFLINE_LEDGER_ENTRIES  
   WHERE   
    VOUCHERNO = @PROGID   
  END  
    
  ELSE  
  BEGIN  
   /*INSERT INTO  
    #POSTING  */
   SELECT  
    CLTCODE,  
    VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
    EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
    AMOUNT = CASE WHEN CREDITAMT > 0 THEN CREDITAMT ELSE DEBITAMT END,  
    NARRATION,  
    BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
    MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
    DDNO,  
    VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END  
   FROM   
    V2_OFFLINE_LEDGER_ENTRIES  
   WHERE   
    VOUCHERNO = @PROGID  
  END  
 END  
 ELSE  
 BEGIN    
  /*SELECT [ACCOUNT CODE] = '', [CHEQUE NO] = '', AMOUNT = 0  
  FROM VOUCHER_UPLOAD V  
  WHERE 1 = 0  */
    
  SELECT ERROR_CODE = '0', ERROR_DESCRIPTION = 'NO ERROR'  
    
  SELECT  
   CLTCODE,   
   VDATE = CONVERT(VARCHAR(10), VDATE, 103),  
   EDATE = CONVERT(VARCHAR(10), EDATE, 103),  
   AMOUNT = CASE WHEN CREDITAMT > 0 THEN CONVERT(VARCHAR, CREDITAMT) ELSE '(' + CONVERT(VARCHAR, DEBITAMT) + ')' END,  
   NARRATION,  
   BANKCODE = CASE WHEN @ENTRY_TYPE IN ('CASH', 'BANK') THEN OPPCODE ELSE '' END,  
   MARGINCODE = CASE WHEN @ENTRY_TYPE = 'MARGIN' THEN MARGINCODE ELSE '' END,  
   DDNO,  
   VNO = CASE WHEN LEDGERVNO = '' THEN 'OFFLINE AREA' ELSE LEDGERVNO END    FROM   
   V2_OFFLINE_LEDGER_ENTRIES  
  WHERE   
   VOUCHERNO = @PROGID    
 END  
  
 --DELETE FROM FILE_DATA WHERE PROGID = @PROGID  
 --DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
  
 /*END TRY  
 BEGIN CATCH  
  IF @@TRANCOUNT > 0  
   ROLLBACK TRAN  
  
  --DELETE FROM FILE_DATA WHERE PROGID = @PROGID  
  --DELETE FROM VOUCHER_UPLOAD WHERE PROGID = @PROGID  
    
  DECLARE @ERR_MSG NVARCHAR(2048)  
  SET @ERR_MSG = ERROR_MESSAGE()  
    
  SELECT ERROR_CODE = '1', ERROR_DESCRIPTION = @ERR_MSG  
    
  RETURN  
 END CATCH  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING
-- --------------------------------------------------

--exec FA_POSTING '120402943803'
--rollback
CREATE PROCEDURE [dbo].[FA_POSTING]
	@VOUCHERNO VARCHAR(12) = ''
--WITH ENCRYPTION
AS
	
BEGIN TRY

CREATE TABLE #VNODATA  
(  
	VDT DATETIME,  
	SDTCUR DATETIME,  
	LDTCUR DATETIME,  
	MASTERSNO BIGINT,  
	ENTRY_AMT MONEY,  
	SETT_NO VARCHAR(7),  
	SETT_TYPE VARCHAR(3),  
	EDT DATETIME,  
	DRAMOUNT MONEY,  
	CRAMOUNT MONEY,  
	BANKNAME [VARCHAR](50) NULL,
	BRANCHNAME [VARCHAR](20) NULL,
	DDNO [VARCHAR](28) NULL,
	CHEQUEMODE [VARCHAR](1) NULL,
	CHEQUEDATE [DATETIME] NULL,
	CLEAR_MODE [VARCHAR](1) NULL,
	MICR [VARCHAR](9) NULL,
	SNO INT, 
	FLDAUTO BIGINT,
	FINYEARID INT, 
	REVCODE VARCHAR(21),
	POSTED_BY VARCHAR(50),
	CHECKED_BY VARCHAR(50),
	ENTRY_IDF INT,
	IDNO INT IDENTITY(1,1)  
)  

EXEC MAKE_UDT_STRUCTURE 
	'#VNODATA', 
	'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME', 
	'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME', 
	'', 
	'0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'

INSERT INTO #VNODATA  
(  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT,  
	CRAMOUNT,  
	CLTCODE,  
	ACNAME,  
	ACCAT,  
	MAINLEDGER,  
	MAINLEDGERNAME,  
	MAINACCAT,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,
	VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FLDAUTO,
	FINYEARID,
	REVCODE,
	POSTED_BY,
	CHECKED_BY,
	ENTRY_IDF
)
SELECT  
	M.EXCHANGE,  
	M.SEGMENT,  
	VNO = '',  
	VTYPE = M.VOUCHERTYPE,  
	M.BOOKTYPE,  
	VDT = M.VDATE,  
	SDTCUR = CONVERT(DATETIME, ''),  
	LDTCUR = CONVERT(DATETIME, ''),  
	MASTERSNO = ISNULL(RESERVED1, 0),  
	ENTRY_AMT = 0,  
	SETT_NO = ISNULL(M.SETT_NO, ''),  
	SETT_TYPE = ISNULL(M.SETT_TYPE, ''),  
	M.EDATE,  
	DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),  
	CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),  
	M.CLTCODE,  
	ACNAME = M.CLIENTNAME,  
	ACCAT = 0,  
	MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,  
	MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,  
	MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,  
	M.NARRATION,  
	BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),  
	REFCODE = '',  
	OPPACCOUNT = M.OPPCODE,
	OPPCODENAME,  
	M.VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO = ISNULL(CC.SNO, M.SNO),
	M.FLDAUTO,
	P.FLDAUTO,
	REVCODE,
	M.ADDBY,
	M.APPROVEDBY,
	M.RESERVED2
FROM  
	(SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE APPROVALFLAG = 1 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%') M  
	LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON  
		M.FLDAUTO = CC.VOLE_REFNO,
	PARAMETER P 
WHERE
	M.VDATE BETWEEN SDTCUR AND LDTCUR

UPDATE V SET 
	V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,
	V.MASTERSNO = A.SNO
FROM 
	#VNODATA V, 
	ACC_TBL1 A, 
	PARAMETER P
WHERE 
	V.MASTERSNO = A.SNO
	AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))
	AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR
	AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE
  
  
CREATE TABLE #VNOGEN  
(  
	VDT DATETIME,  
	MASTERSNO BIGINT,  
	SNO INT,  
	VNOFLAG TINYINT,  
	PARAMNO TINYINT,  
	NOVCH INT,  
	IDNO INT,  
	SRNO INT IDENTITY(1,1),
	ENTRY_IDF INT
) 

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGEN',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',     
 '',     
 '0|0|0|0|0|0|0' 
  
INSERT INTO #VNOGEN  
(  
	EXCHANGE,  
	SEGMENT,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	VOUCHERNO,  
	MASTERSNO,  
	LEDGERNO,  
	SNO,  
	VNOFLAG,  
	PARAMNO,  
	NOVCH,  
	IDNO,
	ENTRY_IDF
)  
SELECT 
	EXCHANGE, 
	SEGMENT, 
	VTYPE, 
	BOOKTYPE, 
	VDT, 
	VOUCHERNO, 
	MASTERSNO = 0, 
	LEDGERNO = '', 
	COUNT(DISTINCT SNO), 
	P.VNOFLAG,  
	P.FLDAUTO, 
	(SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO), 
	IDNO,
	ENTRY_IDF
FROM 
	#VNODATA V, 
	PARAMETER P  
WHERE   
	V.SNO = 1 AND   
	MASTERSNO = 0 AND  
	V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR  
GROUP BY 
	EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF
ORDER BY 
	VTYPE, BOOKTYPE, VDT, VOUCHERNO  
  
DECLARE  
	@TOTSNOS INT,  
	@STARTSNO BIGINT,  
	@LOOPSNO BIGINT  


SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0

IF @TOTSNOS > 0
BEGIN
	EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT  
	  
	UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V  
	WHERE #VNODATA.IDNO = V.IDNO  
	  
	UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO  
	FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I  
	WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO
	AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF
	AND #VNODATA.SNO <> 1  
END
IF @VOUCHERNO <> '' AND @TOTSNOS = 0
BEGIN
	SELECT @STARTSNO = MASTERSNO FROM #VNODATA
END
  
DECLARE  
	@VNOCUR CURSOR,  
	@VTYPE [UDTVTYPE],  
	@BOOKTYPE [UDTBOOKTYPE],  
	@VDT VARCHAR(11),  
	@EXCHANGE [UDTEXCHANGE],  
	@SEGMENT [UDTSEGMENT],  
	@STARTVNO [UDTVNO],  
	@ENDVNO [UDTVNO],  
	@MASTERSNO BIGINT,  
	@VNOCOUNT INT  

  
CREATE TABLE #VNOGENERATION  
(  
	VDT VARCHAR(11),  
	MASTERSNO BIGINT,   
	SNO INT IDENTITY(1, 1)  
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGENERATION',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',     
 '',     
 '0|0|0|0|0'  

SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA 
  
SET @VNOCUR = CURSOR FOR  
	SELECT	
		VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''  
	GROUP BY 
		VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT  
	--ORDER BY 
	--	VOUCHERNO, IDNO  
OPEN @VNOCUR  
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)      
		SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1   
		AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
		ORDER BY VOUCHERNO, IDNO  

		EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT  
		UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V  
		WHERE #VNODATA.MASTERSNO = V.MASTERSNO   

		TRUNCATE TABLE #VNOGENERATION  
		FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
	END  
  
UPDATE #VNODATA  
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR  
FROM PARAMETER P  
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR  
  
INSERT INTO #VNODATA 
	(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,  
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,  
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,  
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,
	 CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,
	FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)  
SELECT  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT = SUM(CRAMOUNT),  
	CRAMOUNT = SUM(DRAMOUNT),  
	CLTCODE = OPPACCOUNT,  
	ACNAME = OPPCODENAME,  
	ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,   
	MAINLEDGER = OPPACCOUNT,  
	MAINLEDGERNAME = OPPCODENAME,  
	MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,  
	VOUCHERNO, 
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,   
	SNO,
	FINYEARID,
	CHECKED_BY = CHECKED_BY,
	POSTED_BY = POSTED_BY,
	ENTRY_IDF
FROM 
	#VNODATA 
WHERE 
	VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)  
GROUP BY  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	OPPACCOUNT, 
	OPPCODENAME, 
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,   
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	VOUCHERNO,  
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FINYEARID,
	CHECKED_BY,
	POSTED_BY,
	ENTRY_IDF
  
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END  
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S  
WHERE #VNODATA.MASTERSNO = S.MASTERSNO  
  
  
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5  
  
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A  
WHERE #VNODATA.CLTCODE = A.CLTCODE  
  
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH  
WHERE BRANCHCODE <> ORGBRANCH  
AND ORGBRANCH <> 'ALL'  

UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL

UPDATE #VNODATA  
SET  
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END  
FROM  
 (SELECT  
  MASTERSNO, 
  BRANCHCODE,  
  CNT = SUM(DRAMOUNT - CRAMOUNT)
 FROM  
  #VNODATA  
 GROUP BY  
  MASTERSNO, 
  BRANCHCODE  
 ) L  
WHERE  
 #VNODATA.MASTERSNO = L.MASTERSNO  
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE

	

	BEGIN TRAN

	SELECT * Into #V2_OFFLINE_LEDGER_ENTRIES
	FROM V2_OFFLINE_LEDGER_ENTRIES V
	WHERE VOUCHERNO=CASE WHEN  @VOUCHERNO<>'' THEN @VOUCHERNO ELSE VOUCHERNO END


	INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG
	SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1
	FROM #V2_OFFLINE_LEDGER_ENTRIES V
	WHERE ((ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3) 
	AND NOT EXISTS(SELECT RESERVED1 FROM #V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)

	
	CREATE TABLE #VNO_TO_DELETE
	(
		MASTERSNO INT
	)
	
	CREATE NONCLUSTERED INDEX [MSNO_VNODATA] ON [dbo].[#VNO_TO_DELETE] 
	(
		[MASTERSNO] ASC
	)
	
	INSERT INTO #VNO_TO_DELETE
	SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT MASTERSNO = RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V

	/*DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALF
LAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALF
LAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALF
LAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALF
LAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALF
LAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  */
	
	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 
	
	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.SNO ) 

	--DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3
	
	UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL
	--SELECT * FROM #VNODATA
	INSERT INTO ACC_TBL1
	SELECT  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		FINYEARID, 
		MKCKFLAG = 1,  
		VNO_MK = VOUCHERNO,  
		SNO = MASTERSNO,  
		REMARK = '',  
		REFSNO = 0,  
		POSTED_ON = GETDATE(),  
		POSTED_BY = POSTED_BY, 
		CHECKED_ON = GETDATE(),   
		CHECKED_BY = CHECKED_BY,   
		ENTRY_AMT,  
		SOURCE_MODULE = 'VNOPOST',  
		ENTRY_TYPE = 'N',  
		SETT_NO,  
		SETT_TYPE,  
		BILL_NO = 0,  
		SELL_BUY = 0,  
		LOCK_FLAG = 0,  
		DISPLAY_FLAG = 1,  
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = ''  
	FROM  
		#VNODATA  
	GROUP BY  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		VOUCHERNO,  
		MASTERSNO,  
		ENTRY_AMT,  
		SETT_NO,  
		SETT_TYPE,
		FINYEARID,
		POSTED_BY,
		CHECKED_BY 
	ORDER BY  
		MASTERSNO  

	INSERT INTO ACC_TBL2 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME, 
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'    
	FROM  
		#VNODATA  
	WHERE  
		ACCAT <> 4

	INSERT INTO ACC_TBL3 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,  
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'     
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 4
	
	INSERT INTO ACC_TBL4
	(BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)
	SELECT 
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO = ISNULL(DDNO, ''), 
		CHEQUEDATE,
		DR_RELDT = '', 
		CR_RELDT = '', 
		DR_RELAMT = SUM(CRAMOUNT), 
		CR_RELAMT = SUM(DRAMOUNT), 
		DR_REFNO = 0, 
		CR_REFNO = 0, 
		RECEIPTNO = 0, 
		DR_MICR = MICR, 
		CR_MICR = MICR, 
		SLIP_NO = 0, 
		SLIP_DATE = '', 
		CHEQUENAME, 
		CHQPRINTED = 0, 
		CLEARMODE = CLEAR_MODE, 
		MASTERSNO, 
		RESERVED1 = '', 
		RESERVED2 = '', 
		RESERVED3 = '', 
		RESERVED4 = '', 
		RESERVED5 = ''
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 2
	GROUP BY
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO, 
		CHEQUEDATE,
		MICR,
		CHEQUENAME, 
		CLEAR_MODE, 
		MASTERSNO

	UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO

	/*
	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0

	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0
	*/
	--------------- INSERT QUERIES -----------------------
	COMMIT TRAN
  
	DROP TABLE #VNODATA  
	DROP TABLE #VNOGEN  
	DROP TABLE #VNOGENERATION

/*	IF @VOUCHERNO <> ''
	BEGIN
		SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO
		SELECT @STARTVNO
	END*/
END TRY
BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK TRAN

DECLARE @ERR_MSG nvarchar(2048) 
	SET @ERR_MSG = ERROR_MESSAGE()
	RAISERROR (@ERR_MSG, 16, 1)
	--RETURN
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_api
-- --------------------------------------------------
--exec FA_POSTING '120402943803'
--rollback
CREATE PROCEDURE [dbo].[FA_POSTING_api]
	@VOUCHERNO VARCHAR(12) = ''
--WITH ENCRYPTION
AS
	
BEGIN TRY

CREATE TABLE #VNODATA  
(  
	VDT DATETIME,  
	SDTCUR DATETIME,  
	LDTCUR DATETIME,  
	MASTERSNO BIGINT,  
	ENTRY_AMT MONEY,  
	SETT_NO VARCHAR(7),  
	SETT_TYPE VARCHAR(3),  
	EDT DATETIME,  
	DRAMOUNT MONEY,  
	CRAMOUNT MONEY,  
	BANKNAME [VARCHAR](50) NULL,
	BRANCHNAME [VARCHAR](20) NULL,
	DDNO [VARCHAR](15) NULL,
	CHEQUEMODE [VARCHAR](1) NULL,
	CHEQUEDATE [DATETIME] NULL,
	CLEAR_MODE [VARCHAR](1) NULL,
	MICR [VARCHAR](9) NULL,
	SNO INT, 
	FLDAUTO BIGINT,
	FINYEARID INT, 
	REVCODE VARCHAR(21),
	POSTED_BY VARCHAR(50),
	CHECKED_BY VARCHAR(50),
	ENTRY_IDF INT,
	IDNO INT IDENTITY(1,1)  
)  

EXEC MAKE_UDT_STRUCTURE 
	'#VNODATA', 
	'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME', 
	'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME', 
	'', 
	'0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'



INSERT INTO #VNODATA  
(  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT,  
	CRAMOUNT,  
	CLTCODE,  
	ACNAME,  
	ACCAT,  
	MAINLEDGER,  
	MAINLEDGERNAME,  
	MAINACCAT,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,
	VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FLDAUTO,
	FINYEARID,
	REVCODE,
	POSTED_BY,
	CHECKED_BY,
	ENTRY_IDF
)
SELECT  
	M.EXCHANGE,  
	M.SEGMENT,  
	VNO = '',  
	VTYPE = M.VOUCHERTYPE,  
	M.BOOKTYPE,  
	VDT = M.VDATE,  
	SDTCUR = CONVERT(DATETIME, ''),  
	LDTCUR = CONVERT(DATETIME, ''),  
	MASTERSNO = ISNULL(RESERVED1, 0),  
	ENTRY_AMT = 0,  
	SETT_NO = ISNULL(M.SETT_NO, ''),  
	SETT_TYPE = ISNULL(M.SETT_TYPE, ''),  
	M.EDATE,  
	DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),  
	CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),  
	M.CLTCODE,  
	ACNAME = M.CLIENTNAME,  
	ACCAT = 0,  
	MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,  
	MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,  
	MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,  
	M.NARRATION,  
	BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),  
	REFCODE = '',  
	OPPACCOUNT = M.OPPCODE,
	OPPCODENAME,  
	M.VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO = ISNULL(CC.SNO, M.SNO),
	M.FLDAUTO,
	P.FLDAUTO,
	REVCODE,
	M.ADDBY,
	M.APPROVEDBY,
	M.RESERVED2
FROM  
	(SELECT * FROM v2_offline_ledger_entries_api WHERE APPROVALFLAG = 1
	 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%') M  
	LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON  
		M.FLDAUTO = CC.VOLE_REFNO,
	PARAMETER P 
WHERE
	M.VDATE BETWEEN SDTCUR AND LDTCUR
	
	

UPDATE V SET 
	V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,
	V.MASTERSNO = A.SNO
FROM 
	#VNODATA V, 
	ACC_TBL1 A, 
	PARAMETER P
WHERE 
	V.MASTERSNO = A.SNO
	AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))
	AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR
	AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE
  
  
CREATE TABLE #VNOGEN  
(  
	VDT DATETIME,  
	MASTERSNO BIGINT,  
	SNO INT,  
	VNOFLAG TINYINT,  
	PARAMNO TINYINT,  
	NOVCH INT,  
	IDNO INT,  
	SRNO INT IDENTITY(1,1),
	ENTRY_IDF INT
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGEN',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',     
 '',     
 '0|0|0|0|0|0|0' 
  
INSERT INTO #VNOGEN  
(  
	EXCHANGE,  
	SEGMENT,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	VOUCHERNO,  
	MASTERSNO,  
	LEDGERNO,  
	SNO,  
	VNOFLAG,  
	PARAMNO,  
	NOVCH,  
	IDNO,
	ENTRY_IDF
)  
SELECT 
	EXCHANGE, 
	SEGMENT, 
	VTYPE, 
	BOOKTYPE, 
	VDT, 
	VOUCHERNO, 
	MASTERSNO = 0, 
	LEDGERNO = '', 
	COUNT(DISTINCT SNO), 
	P.VNOFLAG,  
	P.FLDAUTO, 
	(SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO), 
	IDNO,
	ENTRY_IDF
FROM 
	#VNODATA V, 
	PARAMETER P  
WHERE   
	V.SNO = 1 AND   
	MASTERSNO = 0 AND  
	V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR  
GROUP BY 
	EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF
ORDER BY 
	VTYPE, BOOKTYPE, VDT, VOUCHERNO  
  
DECLARE  
	@TOTSNOS INT,  
	@STARTSNO BIGINT,  
	@LOOPSNO BIGINT  


SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0

IF @TOTSNOS > 0
BEGIN
	EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT  
	  
	UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V  
	WHERE #VNODATA.IDNO = V.IDNO  
	  
	UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO  
	FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I  
	WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO
	AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF
	AND #VNODATA.SNO <> 1  
END
IF @VOUCHERNO <> '' AND @TOTSNOS = 0
BEGIN
	SELECT @STARTSNO = MASTERSNO FROM #VNODATA
END
  
DECLARE  
	@VNOCUR CURSOR,  
	@VTYPE [UDTVTYPE],  
	@BOOKTYPE [UDTBOOKTYPE],  
	@VDT VARCHAR(11),  
	@EXCHANGE [UDTEXCHANGE],  
	@SEGMENT [UDTSEGMENT],  
	@STARTVNO [UDTVNO],  
	@ENDVNO [UDTVNO],  
	@MASTERSNO BIGINT,  
	@VNOCOUNT INT  

  
CREATE TABLE #VNOGENERATION  
(  
	VDT VARCHAR(11),  
	MASTERSNO BIGINT,   
	SNO INT IDENTITY(1, 1)  
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGENERATION',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',     
 '',     
 '0|0|0|0|0'  

SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA 
  
SET @VNOCUR = CURSOR FOR  
	SELECT	
		VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''  
	GROUP BY 
		VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT  
	--ORDER BY 
	--	VOUCHERNO, IDNO  
OPEN @VNOCUR  
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)      
		SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1   
		AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
		ORDER BY VOUCHERNO, IDNO  

		EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT  
		UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V  
		WHERE #VNODATA.MASTERSNO = V.MASTERSNO   

		TRUNCATE TABLE #VNOGENERATION  
		FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
	END  
  
UPDATE #VNODATA  
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR  
FROM PARAMETER P  
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR  
  
INSERT INTO #VNODATA 
	(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,  
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,  
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,  
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,
	 CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,
	FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)  
SELECT  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT = SUM(CRAMOUNT),  
	CRAMOUNT = SUM(DRAMOUNT),  
	CLTCODE = OPPACCOUNT,  
	ACNAME = OPPCODENAME,  
	ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,   
	MAINLEDGER = OPPACCOUNT,  
	MAINLEDGERNAME = OPPCODENAME,  
	MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,  
	VOUCHERNO, 
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,   
	SNO,
	FINYEARID,
	CHECKED_BY = CHECKED_BY,
	POSTED_BY = POSTED_BY,
	ENTRY_IDF
FROM 
	#VNODATA 
WHERE 
	VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)  
GROUP BY  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	OPPACCOUNT, 
	OPPCODENAME, 
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,   
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	VOUCHERNO,  
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FINYEARID,
	CHECKED_BY,
	POSTED_BY,
	ENTRY_IDF

  
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END  
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S  
WHERE #VNODATA.MASTERSNO = S.MASTERSNO  
  
  
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5  
  
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A  
WHERE #VNODATA.CLTCODE = A.CLTCODE  
  
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH  
WHERE BRANCHCODE <> ORGBRANCH  
AND ORGBRANCH <> 'ALL'  

UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL

UPDATE #VNODATA  
SET  
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END  
FROM  
 (SELECT  
  MASTERSNO, 
  BRANCHCODE,  
  CNT = SUM(DRAMOUNT - CRAMOUNT)
 FROM  
  #VNODATA  
 GROUP BY  
  MASTERSNO, 
  BRANCHCODE  
 ) L  
WHERE  
 #VNODATA.MASTERSNO = L.MASTERSNO  
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE

	

	BEGIN TRAN

	INSERT INTO v2_offline_ledger_entries_LOG
	SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1
	FROM v2_offline_ledger_entries_api V
	WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3
	AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)

	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM v2_offline_ledger_entries_api V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM v2_offline_ledger_entries_api V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM v2_offline_ledger_entries_api V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM v2_offline_ledger_entries_api V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM v2_offline_ledger_entries_api V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM v2_offline_ledger_entries_api V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  

	--DELETE FROM v2_offline_ledger_entries_api WHERE ROWSTATE = 1 AND APPROVALFLAG = 3
	
	UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL
	


	INSERT INTO ACC_TBL1
	SELECT  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		FINYEARID, 
		MKCKFLAG = 1,  
		VNO_MK = VOUCHERNO,  
		SNO = MASTERSNO,  
		REMARK = '',  
		REFSNO = 0,  
		POSTED_ON = GETDATE(),  
		POSTED_BY = POSTED_BY, 
		CHECKED_ON = GETDATE(),   
		CHECKED_BY = CHECKED_BY,   
		ENTRY_AMT,  
		SOURCE_MODULE = 'VNOPOST',  
		ENTRY_TYPE = 'N',  
		SETT_NO,  
		SETT_TYPE,  
		BILL_NO = 0,  
		SELL_BUY = 0,  
		LOCK_FLAG = 0,  
		DISPLAY_FLAG = 1,  
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = ''  
	FROM  
		#VNODATA  
	GROUP BY  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		VOUCHERNO,  
		MASTERSNO,  
		ENTRY_AMT,  
		SETT_NO,  
		SETT_TYPE,
		FINYEARID,
		POSTED_BY,
		CHECKED_BY 
	ORDER BY  
		MASTERSNO  

	INSERT INTO ACC_TBL2 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME, 
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'    
	FROM  
		#VNODATA  
	WHERE  
		ACCAT <> 4

	INSERT INTO ACC_TBL3 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,  
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'     
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 4
	
	INSERT INTO ACC_TBL4
	(BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)
	SELECT 
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO = ISNULL(DDNO, ''), 
		CHEQUEDATE,
		DR_RELDT = '', 
		CR_RELDT = '', 
		DR_RELAMT = SUM(CRAMOUNT), 
		CR_RELAMT = SUM(DRAMOUNT), 
		DR_REFNO = 0, 
		CR_REFNO = 0, 
		RECEIPTNO = 0, 
		DR_MICR = MICR, 
		CR_MICR = MICR, 
		SLIP_NO = 0, 
		SLIP_DATE = '', 
		CHEQUENAME, 
		CHQPRINTED = 0, 
		CLEARMODE = CLEAR_MODE, 
		MASTERSNO, 
		RESERVED1 = '', 
		RESERVED2 = '', 
		RESERVED3 = '', 
		RESERVED4 = '', 
		RESERVED5 = ''
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 2
	GROUP BY
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO, 
		CHEQUEDATE,
		MICR,
		CHEQUENAME, 
		CLEAR_MODE, 
		MASTERSNO

	UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 
	FROM v2_offline_ledger_entries_api V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO

	/*
	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0

	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0
	*/
	--------------- INSERT QUERIES -----------------------
	COMMIT TRAN
  
	DROP TABLE #VNODATA  
	DROP TABLE #VNOGEN  
	DROP TABLE #VNOGENERATION

/*	IF @VOUCHERNO <> ''
	BEGIN
		SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO
		SELECT @STARTVNO
	END*/
END TRY
BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK TRAN

DECLARE @ERR_MSG nvarchar(2048) 
	SET @ERR_MSG = ERROR_MESSAGE()
	RAISERROR (@ERR_MSG, 16, 1)
	--RETURN
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_newdec282015
-- --------------------------------------------------

--exec FA_POSTING '120402943803'
--rollback
CREATE PROCEDURE [dbo].[FA_POSTING]
	@VOUCHERNO VARCHAR(12) = ''
--WITH ENCRYPTION
AS
	
BEGIN TRY

CREATE TABLE #VNODATA  
(  
	VDT DATETIME,  
	SDTCUR DATETIME,  
	LDTCUR DATETIME,  
	MASTERSNO BIGINT,  
	ENTRY_AMT MONEY,  
	SETT_NO VARCHAR(7),  
	SETT_TYPE VARCHAR(3),  
	EDT DATETIME,  
	DRAMOUNT MONEY,  
	CRAMOUNT MONEY,  
	BANKNAME [VARCHAR](50) NULL,
	BRANCHNAME [VARCHAR](20) NULL,
	DDNO [VARCHAR](15) NULL,
	CHEQUEMODE [VARCHAR](1) NULL,
	CHEQUEDATE [DATETIME] NULL,
	CLEAR_MODE [VARCHAR](1) NULL,
	MICR [VARCHAR](9) NULL,
	SNO INT, 
	FLDAUTO BIGINT,
	FINYEARID INT, 
	REVCODE VARCHAR(21),
	POSTED_BY VARCHAR(50),
	CHECKED_BY VARCHAR(50),
	ENTRY_IDF INT,
	IDNO INT IDENTITY(1,1)  
)  

EXEC MAKE_UDT_STRUCTURE 
	'#VNODATA', 
	'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME', 
	'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME', 
	'', 
	'0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'



INSERT INTO #VNODATA  
(  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT,  
	CRAMOUNT,  
	CLTCODE,  
	ACNAME,  
	ACCAT,  
	MAINLEDGER,  
	MAINLEDGERNAME,  
	MAINACCAT,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,
	VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FLDAUTO,
	FINYEARID,
	REVCODE,
	POSTED_BY,
	CHECKED_BY,
	ENTRY_IDF
)
SELECT  
	M.EXCHANGE,  
	M.SEGMENT,  
	Vno='' ,  
	VTYPE = M.VOUCHERTYPE,  
	M.BOOKTYPE,  
	VDT = M.VDATE,  
	SDTCUR = CONVERT(DATETIME, ''),  
	LDTCUR = CONVERT(DATETIME, ''),  
	MASTERSNO = ISNULL(RESERVED1, 0),  
	ENTRY_AMT = 0,  
	SETT_NO = ISNULL(M.SETT_NO, ''),  
	SETT_TYPE = ISNULL(M.SETT_TYPE, ''),  
	M.EDATE,  
	DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),  
	CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),  
	M.CLTCODE,  
	ACNAME = M.CLIENTNAME,  
	ACCAT = 0,  
	MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,  
	MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,  
	MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,  
	M.NARRATION,  
	BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),  
	REFCODE = '',  
	OPPACCOUNT = M.OPPCODE,
	OPPCODENAME,  
	M.VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO = ISNULL(CC.SNO, M.SNO),
	M.FLDAUTO,
	P.FLDAUTO,
	REVCODE,
	M.ADDBY,
	M.APPROVEDBY,
	M.RESERVED2
FROM  
	(SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE APPROVALFLAG = 1 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%') M  
	LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON  
		M.FLDAUTO = CC.VOLE_REFNO,
	PARAMETER P 
WHERE
	M.VDATE BETWEEN SDTCUR AND LDTCUR

UPDATE V SET 
	V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,
	V.MASTERSNO = A.SNO
FROM 
	#VNODATA V, 
	ACC_TBL1 A, 
	PARAMETER P
WHERE 
	V.MASTERSNO = A.SNO
	AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))
	AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR
	AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE
  
  --select * from #VNODATA 
  --return
CREATE TABLE #VNOGEN  
(  
	VDT DATETIME,  
	MASTERSNO BIGINT,  
	SNO INT,  
	VNOFLAG TINYINT,  
	PARAMNO TINYINT,  
	NOVCH INT,  
	IDNO INT,  
	SRNO INT IDENTITY(1,1),
	ENTRY_IDF INT
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGEN',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',     
 '',     
 '0|0|0|0|0|0|0' 
  
INSERT INTO #VNOGEN  
(  
	EXCHANGE,  
	SEGMENT,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	VOUCHERNO,  
	MASTERSNO,  
	LEDGERNO,  
	SNO,  
	VNOFLAG,  
	PARAMNO,  
	NOVCH,  
	IDNO,
	ENTRY_IDF
)  
SELECT 
	EXCHANGE, 
	SEGMENT, 
	VTYPE, 
	BOOKTYPE, 
	VDT, 
	VOUCHERNO, 
	MASTERSNO = 0, 
	LEDGERNO = '', 
	COUNT(DISTINCT SNO), 
	P.VNOFLAG,  
	P.FLDAUTO, 
	(SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO), 
	IDNO,
	ENTRY_IDF
FROM 
	#VNODATA V, 
	PARAMETER P  
WHERE   
	V.SNO = 1 AND   
	MASTERSNO = 0 AND  
	V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR  
GROUP BY 
	EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF
ORDER BY 
	VTYPE, BOOKTYPE, VDT, VOUCHERNO  
  
DECLARE  
	@TOTSNOS INT,  
	@STARTSNO BIGINT,  
	@LOOPSNO BIGINT  


SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0

IF @TOTSNOS > 0
BEGIN
	EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT  
	  
	UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V  
	WHERE #VNODATA.IDNO = V.IDNO  
	  
	UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO  
	FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I  
	WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO
	AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF
	AND #VNODATA.SNO <> 1  
END
IF @VOUCHERNO <> '' AND @TOTSNOS = 0
BEGIN
	SELECT @STARTSNO = MASTERSNO FROM #VNODATA
END
  
DECLARE  
	@VNOCUR CURSOR,  
	@VTYPE [UDTVTYPE],  
	@BOOKTYPE [UDTBOOKTYPE],  
	@VDT VARCHAR(11),  
	@EXCHANGE [UDTEXCHANGE],  
	@SEGMENT [UDTSEGMENT],  
	@STARTVNO [UDTVNO],  
	@ENDVNO [UDTVNO],  
	@MASTERSNO BIGINT,  
	@VNOCOUNT INT  

  
CREATE TABLE #VNOGENERATION  
(  
	VDT VARCHAR(11),  
	MASTERSNO BIGINT,   
	SNO INT IDENTITY(1, 1)  
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGENERATION',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',     
 '',     
 '0|0|0|0|0'  

SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA 
  
SET @VNOCUR = CURSOR FOR  
	SELECT	
		VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''  
	GROUP BY 
		VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT  
	--ORDER BY 
	--	VOUCHERNO, IDNO  
OPEN @VNOCUR  
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)      
		SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1   
		AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
		ORDER BY VOUCHERNO, IDNO  

		EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT  
		UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V  
		WHERE #VNODATA.MASTERSNO = V.MASTERSNO   

		TRUNCATE TABLE #VNOGENERATION  
		FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
	END  
  
UPDATE #VNODATA  
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR  
FROM PARAMETER P  
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR  
  
INSERT INTO #VNODATA 
	(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,  
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,  
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,  
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,
	 CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,
	FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)  
SELECT  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT = SUM(CRAMOUNT),  
	CRAMOUNT = SUM(DRAMOUNT),  
	CLTCODE = OPPACCOUNT,  
	ACNAME = OPPCODENAME,  
	ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,   
	MAINLEDGER = OPPACCOUNT,  
	MAINLEDGERNAME = OPPCODENAME,  
	MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,  
	VOUCHERNO, 
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,   
	SNO,
	FINYEARID,
	CHECKED_BY = CHECKED_BY,
	POSTED_BY = POSTED_BY,
	ENTRY_IDF
FROM 
	#VNODATA 
WHERE 
	VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)  
GROUP BY  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	OPPACCOUNT, 
	OPPCODENAME, 
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,   
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	VOUCHERNO,  
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FINYEARID,
	CHECKED_BY,
	POSTED_BY,
	ENTRY_IDF
  
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END  
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S  
WHERE #VNODATA.MASTERSNO = S.MASTERSNO  
  
  
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5  
  
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A  
WHERE #VNODATA.CLTCODE = A.CLTCODE  
  
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH  
WHERE BRANCHCODE <> ORGBRANCH  
AND ORGBRANCH <> 'ALL'  

UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL

UPDATE #VNODATA  
SET  
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END  
FROM  
 (SELECT  
  MASTERSNO, 
  BRANCHCODE,  
  CNT = SUM(DRAMOUNT - CRAMOUNT)
 FROM  
  #VNODATA  
 GROUP BY  
  MASTERSNO, 
  BRANCHCODE  
 ) L  
WHERE  
 #VNODATA.MASTERSNO = L.MASTERSNO  
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE

	

	BEGIN TRAN

	INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG
	SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1
	FROM V2_OFFLINE_LEDGER_ENTRIES V
	WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3
	AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)

	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  

	--DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3
	
	UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL

	INSERT INTO ACC_TBL1
	SELECT  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		FINYEARID, 
		MKCKFLAG = 1,  
		VNO_MK = VOUCHERNO,  
		SNO = MASTERSNO,  
		REMARK = '',  
		REFSNO = 0,  
		POSTED_ON = GETDATE(),  
		POSTED_BY = POSTED_BY, 
		CHECKED_ON = GETDATE(),   
		CHECKED_BY = CHECKED_BY,   
		ENTRY_AMT,  
		SOURCE_MODULE = 'VNOPOST',  
		ENTRY_TYPE = 'N',  
		SETT_NO,  
		SETT_TYPE,  
		BILL_NO = 0,  
		SELL_BUY = 0,  
		LOCK_FLAG = 0,  
		DISPLAY_FLAG = 1,  
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = ''  
	FROM  
		#VNODATA  
	GROUP BY  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		VOUCHERNO,  
		MASTERSNO,  
		ENTRY_AMT,  
		SETT_NO,  
		SETT_TYPE,
		FINYEARID,
		POSTED_BY,
		CHECKED_BY 
	ORDER BY  
		MASTERSNO  

	INSERT INTO ACC_TBL2 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME, 
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'    
	FROM  
		#VNODATA  
	WHERE  
		ACCAT <> 4

	INSERT INTO ACC_TBL3 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,  
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'     
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 4
	
	INSERT INTO ACC_TBL4
	(BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)
	SELECT 
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO = ISNULL(DDNO, ''), 
		CHEQUEDATE,
		DR_RELDT = '', 
		CR_RELDT = '', 
		DR_RELAMT = SUM(CRAMOUNT), 
		CR_RELAMT = SUM(DRAMOUNT), 
		DR_REFNO = 0, 
		CR_REFNO = 0, 
		RECEIPTNO = 0, 
		DR_MICR = MICR, 
		CR_MICR = MICR, 
		SLIP_NO = 0, 
		SLIP_DATE = '', 
		CHEQUENAME, 
		CHQPRINTED = 0, 
		CLEARMODE = CLEAR_MODE, 
		MASTERSNO, 
		RESERVED1 = '', 
		RESERVED2 = '', 
		RESERVED3 = '', 
		RESERVED4 = '', 
		RESERVED5 = ''
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 2
	GROUP BY
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO, 
		CHEQUEDATE,
		MICR,
		CHEQUENAME, 
		CLEAR_MODE, 
		MASTERSNO

	UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO
--select * from V2_OFFLINE_LEDGER_ENTRIES where VDATE like 'dec 28 2015%'and NARRATION ='test'
	/*
	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0

	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0
	*/
	--------------- INSERT QUERIES -----------------------
	COMMIT TRAN
  
	DROP TABLE #VNODATA  
	DROP TABLE #VNOGEN  
	DROP TABLE #VNOGENERATION

/*	IF @VOUCHERNO <> ''
	BEGIN
		SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO
		SELECT @STARTVNO
	END*/
END TRY
BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK TRAN

DECLARE @ERR_MSG nvarchar(2048) 
	SET @ERR_MSG = ERROR_MESSAGE()
	RAISERROR (@ERR_MSG, 16, 1)
	--RETURN
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_OfflINE
-- --------------------------------------------------

--EXEC FA_POSTING '120402943803'    
--ROLLBACK    
CREATE PROCEDURE [dbo].[FA_POSTING_OfflINE]    
 @VOUCHERNO VARCHAR(12) = ''    
--WITH ENCRYPTION    
AS    
     
BEGIN TRY    
    
CREATE TABLE #VNODATA      
(      
 VDT DATETIME,      
 SDTCUR DATETIME,      
 LDTCUR DATETIME,      
 MASTERSNO BIGINT,      
 ENTRY_AMT MONEY,      
 SETT_NO VARCHAR(7),      
 SETT_TYPE VARCHAR(3),      
 EDT DATETIME,      
 DRAMOUNT MONEY,      
 CRAMOUNT MONEY,      
 BANKNAME [VARCHAR](50) NULL,    
 BRANCHNAME [VARCHAR](20) NULL,    
 DDNO [VARCHAR](15) NULL,    
 CHEQUEMODE [VARCHAR](1) NULL,    
 CHEQUEDATE [DATETIME] NULL,    
 CLEAR_MODE [VARCHAR](1) NULL,    
 MICR [VARCHAR](9) NULL,    
 SNO INT,     
 FLDAUTO BIGINT,    
 FINYEARID INT,     
 REVCODE VARCHAR(21),    
 POSTED_BY VARCHAR(50),    
 CHECKED_BY VARCHAR(50),    
 ENTRY_IDF INT,    
 IDNO INT IDENTITY(1,1)      
)      
    
EXEC MAKE_UDT_STRUCTURE     
 '#VNODATA',     
 'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME',     
 '',     
 '0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'    
    
    
    
INSERT INTO #VNODATA      
(      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 DRAMOUNT,      
 CRAMOUNT,      
 CLTCODE,      
 ACNAME,      
 ACCAT,      
 MAINLEDGER,      
 MAINLEDGERNAME,      
 MAINACCAT,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 OPPACCOUNT,    
 OPPCODENAME,    
 VOUCHERNO,    
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO,    
 FLDAUTO,    
 FINYEARID,    
 REVCODE,    
 POSTED_BY,    
 CHECKED_BY,    
 ENTRY_IDF    
)    
SELECT      
 M.EXCHANGE,      
 M.SEGMENT,      
 VNO = '',      
 VTYPE = M.VOUCHERTYPE,      
 M.BOOKTYPE,      
 VDT = M.VDATE,      
 SDTCUR = CONVERT(DATETIME, ''),      
 LDTCUR = CONVERT(DATETIME, ''),      
 MASTERSNO = ISNULL(RESERVED1, 0),      
 ENTRY_AMT = 0,      
 SETT_NO = ISNULL(M.SETT_NO, ''),      
 SETT_TYPE = ISNULL(M.SETT_TYPE, ''),      
 M.EDATE,      
 DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),      
 CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),      
 M.CLTCODE,      
 ACNAME = M.CLIENTNAME,      
 ACCAT = 0,      
 MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,      
 MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,      
 MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,      
 M.NARRATION,      
 BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),      
 REFCODE = '',      
 OPPACCOUNT = M.OPPCODE,    
 OPPCODENAME,      
 M.VOUCHERNO,    
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO = ISNULL(CC.SNO, M.SNO),    
 M.FLDAUTO,    
 P.FLDAUTO,    
 REVCODE,    
 M.ADDBY,    
 M.APPROVEDBY,    
 M.RESERVED2    
FROM      
 (SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERTYPE=2 AND APPROVALFLAG = 1 AND ROWSTATE = 0 AND ADDBY='TPR' AND VOUCHERNO LIKE @VOUCHERNO + '%') M      
 LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON      
  M.FLDAUTO = CC.VOLE_REFNO,    
 PARAMETER P     
WHERE    
 M.VDATE BETWEEN SDTCUR AND LDTCUR    
    
UPDATE V SET     
 V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,    
 V.MASTERSNO = A.SNO    
FROM     
 #VNODATA V,     
 ACC_TBL1 A,     
 PARAMETER P    
WHERE     
 V.MASTERSNO = A.SNO    
 AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))    
 AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR    
 AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE    
      
      
CREATE TABLE #VNOGEN      
(      
 VDT DATETIME,      
 MASTERSNO BIGINT,      
 SNO INT,      
 VNOFLAG TINYINT,      
 PARAMNO TINYINT,      
 NOVCH INT,      
 IDNO INT,      
 SRNO INT IDENTITY(1,1),    
 ENTRY_IDF INT    
)      
    
EXEC MAKE_UDT_STRUCTURE         
 '#VNOGEN',         
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',         
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',         
 '',         
 '0|0|0|0|0|0|0'     
      
INSERT INTO #VNOGEN      
(      
 EXCHANGE,      
 SEGMENT,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 VOUCHERNO,      
 MASTERSNO,      
 LEDGERNO,      
 SNO,      
 VNOFLAG,      
 PARAMNO,      
 NOVCH,      
 IDNO,    
 ENTRY_IDF    
)      
SELECT     
 EXCHANGE,     
 SEGMENT,     
 VTYPE,     
 BOOKTYPE,     
 VDT,     
 VOUCHERNO,     
 MASTERSNO = 0,     
 LEDGERNO = '',     
 COUNT(DISTINCT SNO),     
 P.VNOFLAG,      
 P.FLDAUTO,     
 (SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO),     
 IDNO,    
 ENTRY_IDF    
FROM     
 #VNODATA V,     
 PARAMETER P      
WHERE       
 V.SNO = 1 AND       
 MASTERSNO = 0 AND      
 V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR      
GROUP BY     
 EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF    
ORDER BY     
 VTYPE, BOOKTYPE, VDT, VOUCHERNO      
 

      
DECLARE      
 @TOTSNOS INT,      
 @STARTSNO BIGINT,      
 @LOOPSNO BIGINT      
    
    
SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0    
    
IF @TOTSNOS > 0    
BEGIN    
 EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT      
       
 UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V      
 WHERE #VNODATA.IDNO = V.IDNO      
       
 UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO      
 FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I      
 WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO    
 AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF    
 AND #VNODATA.SNO <> 1      
END    
IF @VOUCHERNO <> '' AND @TOTSNOS = 0    
BEGIN    
 SELECT @STARTSNO = MASTERSNO FROM #VNODATA    
END    
      
DECLARE      
 @VNOCUR CURSOR,      
 @VTYPE [UDTVTYPE],      
 @BOOKTYPE [UDTBOOKTYPE],      
 @VDT VARCHAR(11),      
 @EXCHANGE [UDTEXCHANGE],      
 @SEGMENT [UDTSEGMENT],      
 @STARTVNO [UDTVNO],      
 @ENDVNO [UDTVNO],      
 @MASTERSNO BIGINT,      
 @VNOCOUNT INT      
    
      
CREATE TABLE #VNOGENERATION      
(      
 VDT VARCHAR(11),      
 MASTERSNO BIGINT,       
 SNO INT IDENTITY(1, 1)      
)      
    
EXEC MAKE_UDT_STRUCTURE         
 '#VNOGENERATION',         
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',         
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',         
 '',         
 '0|0|0|0|0'      
    
SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA     
      
SET @VNOCUR = CURSOR FOR      
 SELECT     
  VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''      
 GROUP BY     
  VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT      
 --ORDER BY     
 -- VOUCHERNO, IDNO      
OPEN @VNOCUR      
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)          
  SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1       
  AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT      
  ORDER BY VOUCHERNO, IDNO      
    
  EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT      
  UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V      
  WHERE #VNODATA.MASTERSNO = V.MASTERSNO       
    
  TRUNCATE TABLE #VNOGENERATION      
  FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT      
 END      
      
UPDATE #VNODATA      
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR      
FROM PARAMETER P      
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR      
      
INSERT INTO #VNODATA     
 (EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,      
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,      
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,      
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,    
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,    
  CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,    
 FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)      
SELECT      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 DRAMOUNT = SUM(CRAMOUNT),      
 CRAMOUNT = SUM(DRAMOUNT),      
 CLTCODE = OPPACCOUNT,      
 ACNAME = OPPCODENAME,      
 ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,       
 MAINLEDGER = OPPACCOUNT,      
 MAINLEDGERNAME = OPPCODENAME,      
 MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 OPPACCOUNT,    
 OPPCODENAME,      
 VOUCHERNO,     
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,       
 SNO,    
 FINYEARID,    
 CHECKED_BY = CHECKED_BY,    
 POSTED_BY = POSTED_BY,    
 ENTRY_IDF    
FROM     
 #VNODATA     
WHERE     
 VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)      
GROUP BY      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 OPPACCOUNT,     
 OPPCODENAME,     
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,       
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 VOUCHERNO,      
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO,    
 FINYEARID,    
 CHECKED_BY,    
 POSTED_BY,    
 ENTRY_IDF    
      
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END      
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S      
WHERE #VNODATA.MASTERSNO = S.MASTERSNO      
      
      
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5      
      
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A      
WHERE #VNODATA.CLTCODE = A.CLTCODE      
      
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH      
WHERE BRANCHCODE <> ORGBRANCH      
AND ORGBRANCH <> 'ALL'      
    
UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL    
    
UPDATE #VNODATA      
SET      
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END      
FROM      
 (SELECT      
  MASTERSNO,     
  BRANCHCODE,      
  CNT = SUM(DRAMOUNT - CRAMOUNT)    
 FROM      
  #VNODATA      
 GROUP BY      
  MASTERSNO,     
  BRANCHCODE      
 ) L      
WHERE      
 #VNODATA.MASTERSNO = L.MASTERSNO      
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE    
    

    
 BEGIN TRAN    
    
 INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG    
 SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1    
 FROM V2_OFFLINE_LEDGER_ENTRIES V    
 WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3    
 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)    
    
 CREATE TABLE #VNO_TO_DELETE
	(
		MASTERSNO INT
	)
	
	CREATE NONCLUSTERED INDEX [MSNO_VNODATA] ON [dbo].[#VNO_TO_DELETE] 
	(
		[MASTERSNO] ASC
	)
	
	INSERT INTO #VNO_TO_DELETE
	SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT MASTERSNO = RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V

	/*DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  */
	
	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 
	
	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.SNO ) 

 --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3    
     
 UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL    
    
 INSERT INTO ACC_TBL1    
 SELECT      
  VNO,      
  VTYPE,      
  BOOKTYPE,      
  EXCHANGE,      
  SEGMENT,      
  VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),      
  FINYEARID,     
  MKCKFLAG = 1,      
  VNO_MK = VOUCHERNO,      
  SNO = MASTERSNO,      
  REMARK = '',      
  REFSNO = 0,      
  POSTED_ON = GETDATE(),      
  POSTED_BY = POSTED_BY,     
  CHECKED_ON = GETDATE(),       
  CHECKED_BY = CHECKED_BY,       
  ENTRY_AMT,      
  SOURCE_MODULE = 'VNOPOST',      
  ENTRY_TYPE = 'N',      
  SETT_NO,      
  SETT_TYPE,      
  BILL_NO = 0,      
  SELL_BUY = 0,      
  LOCK_FLAG = 0,      
  DISPLAY_FLAG = 1,      
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = ''      
 FROM      
  #VNODATA      
 GROUP BY      
  VNO,      
  VTYPE,      
  BOOKTYPE,      
  EXCHANGE,      
  SEGMENT,      
  CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),      
  VOUCHERNO,      
  MASTERSNO,      
  ENTRY_AMT,      
  SETT_NO,      
  SETT_TYPE,    
  FINYEARID,    
  POSTED_BY,    
  CHECKED_BY    
 ORDER BY      
  MASTERSNO      
    
 INSERT INTO ACC_TBL2     
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)    
 SELECT      
  MASTERSNO,      
  EDT,      
  DRAMOUNT,      
  CRAMOUNT,      
  CLTCODE,      
  ACNAME,      
  MAINLEDGER,      
  MAINLEDGERNAME,     
  MAINACCAT,      
  NARRATION,    
  REFSNO = 0,      
  BALAMT = 0,      
  BRANCHCODE,      
  REFCODE,      
  ACCAT,      
  OPPACCOUNT,    
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = '',    
  'INR'        
 FROM      
  #VNODATA      
 WHERE      
  ACCAT <> 4    
    
 INSERT INTO ACC_TBL3     
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)    
 SELECT      
  MASTERSNO,      
  EDT,      
  DRAMOUNT,      
  CRAMOUNT,      
  CLTCODE,      
  ACNAME,      
  MAINLEDGER,      
  MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,      
  MAINACCAT,      
  NARRATION,    
  REFSNO = 0,      
  BALAMT = 0,      
  BRANCHCODE,      
  REFCODE,      
  ACCAT,      
  OPPACCOUNT,    
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = '',    
  'INR'         
 FROM      
  #VNODATA      
 WHERE      
  ACCAT = 4    
     
 INSERT INTO ACC_TBL4    
 (BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)    
 SELECT     
  BANKNAME,     
  BRANCHNAME,     
  CHEQUEMODE,    
  DDNO = ISNULL(DDNO, ''),     
  CHEQUEDATE,    
  DR_RELDT = '',     
  CR_RELDT = '',     
  DR_RELAMT = SUM(CRAMOUNT),     
  CR_RELAMT = SUM(DRAMOUNT),     
  DR_REFNO = 0,     
  CR_REFNO = 0,     
  RECEIPTNO = 0,     
  DR_MICR = MICR,     
  CR_MICR = MICR,     
  SLIP_NO = 0,     
  SLIP_DATE = '',     
  CHEQUENAME,     
  CHQPRINTED = 0,     
  CLEARMODE = CLEAR_MODE,     
  MASTERSNO,     
  RESERVED1 = '',     
  RESERVED2 = '',     
  RESERVED3 = '',     
  RESERVED4 = '',     
  RESERVED5 = ''    
 FROM      
  #VNODATA      
 WHERE      
  ACCAT = 2    
 GROUP BY    
  BANKNAME,     
  BRANCHNAME,     
  CHEQUEMODE,    
  DDNO,     
  CHEQUEDATE,    
  MICR,    
  CHEQUENAME,     
  CLEAR_MODE,     
  MASTERSNO    
    
 UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO    
    
 /*    
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END    
 FROM ACC_TBL4 A4, #VNODATA V2    
 WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0    
    
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END    
 FROM ACC_TBL4 A4, #VNODATA V2    
 WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0    
 */    
 --------------- INSERT QUERIES -----------------------    
 COMMIT TRAN    
      
 DROP TABLE #VNODATA      
 DROP TABLE #VNOGEN      
 DROP TABLE #VNOGENERATION    
    
/* IF @VOUCHERNO <> ''    
 BEGIN    
  SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO    
  SELECT @STARTVNO    
 END*/    
END TRY    
BEGIN CATCH    
 IF @@TRANCOUNT > 0    
  ROLLBACK TRAN    
    
DECLARE @ERR_MSG NVARCHAR(2048)     
 SET @ERR_MSG = ERROR_MESSAGE()    
 RAISERROR (@ERR_MSG, 16, 1)    
 --RETURN    
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_OfflINE_06122017
-- --------------------------------------------------

--EXEC FA_POSTING '120402943803'    
--ROLLBACK    
create PROCEDURE [dbo].[FA_POSTING_OfflINE_06122017]    
 @VOUCHERNO VARCHAR(12) = ''    
--WITH ENCRYPTION    
AS    
     
BEGIN TRY    
    
CREATE TABLE #VNODATA      
(      
 VDT DATETIME,      
 SDTCUR DATETIME,      
 LDTCUR DATETIME,      
 MASTERSNO BIGINT,      
 ENTRY_AMT MONEY,      
 SETT_NO VARCHAR(7),      
 SETT_TYPE VARCHAR(3),      
 EDT DATETIME,      
 DRAMOUNT MONEY,      
 CRAMOUNT MONEY,      
 BANKNAME [VARCHAR](50) NULL,    
 BRANCHNAME [VARCHAR](20) NULL,    
 DDNO [VARCHAR](15) NULL,    
 CHEQUEMODE [VARCHAR](1) NULL,    
 CHEQUEDATE [DATETIME] NULL,    
 CLEAR_MODE [VARCHAR](1) NULL,    
 MICR [VARCHAR](9) NULL,    
 SNO INT,     
 FLDAUTO BIGINT,    
 FINYEARID INT,     
 REVCODE VARCHAR(21),    
 POSTED_BY VARCHAR(50),    
 CHECKED_BY VARCHAR(50),    
 ENTRY_IDF INT,    
 IDNO INT IDENTITY(1,1)      
)      
    
EXEC MAKE_UDT_STRUCTURE     
 '#VNODATA',     
 'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME',     
 '',     
 '0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'    
    
    
    
INSERT INTO #VNODATA      
(      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 DRAMOUNT,      
 CRAMOUNT,      
 CLTCODE,      
 ACNAME,      
 ACCAT,      
 MAINLEDGER,      
 MAINLEDGERNAME,      
 MAINACCAT,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 OPPACCOUNT,    
 OPPCODENAME,    
 VOUCHERNO,    
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO,    
 FLDAUTO,    
 FINYEARID,    
 REVCODE,    
 POSTED_BY,    
 CHECKED_BY,    
 ENTRY_IDF    
)    
SELECT      
 M.EXCHANGE,      
 M.SEGMENT,      
 VNO = '',      
 VTYPE = M.VOUCHERTYPE,      
 M.BOOKTYPE,      
 VDT = M.VDATE,      
 SDTCUR = CONVERT(DATETIME, ''),      
 LDTCUR = CONVERT(DATETIME, ''),      
 MASTERSNO = ISNULL(RESERVED1, 0),      
 ENTRY_AMT = 0,      
 SETT_NO = ISNULL(M.SETT_NO, ''),      
 SETT_TYPE = ISNULL(M.SETT_TYPE, ''),      
 M.EDATE,      
 DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),      
 CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),      
 M.CLTCODE,      
 ACNAME = M.CLIENTNAME,      
 ACCAT = 0,      
 MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,      
 MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,      
 MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,      
 M.NARRATION,      
 BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),      
 REFCODE = '',      
 OPPACCOUNT = M.OPPCODE,    
 OPPCODENAME,      
 M.VOUCHERNO,    
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO = ISNULL(CC.SNO, M.SNO),    
 M.FLDAUTO,    
 P.FLDAUTO,    
 REVCODE,    
 M.ADDBY,    
 M.APPROVEDBY,    
 M.RESERVED2    
FROM      
 (SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERTYPE in (2,3) AND APPROVALFLAG = 1 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%') M      
 LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON      
  M.FLDAUTO = CC.VOLE_REFNO,    
 PARAMETER P     
WHERE    
 M.VDATE BETWEEN SDTCUR AND LDTCUR    
    
UPDATE V SET     
 V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,    
 V.MASTERSNO = A.SNO    
FROM     
 #VNODATA V,     
 ACC_TBL1 A,     
 PARAMETER P    
WHERE     
 V.MASTERSNO = A.SNO    
 AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))    
 AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR    
 AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE    
      
      
CREATE TABLE #VNOGEN      
(      
 VDT DATETIME,      
 MASTERSNO BIGINT,      
 SNO INT,      
 VNOFLAG TINYINT,      
 PARAMNO TINYINT,      
 NOVCH INT,      
 IDNO INT,      
 SRNO INT IDENTITY(1,1),    
 ENTRY_IDF INT    
)      
    
EXEC MAKE_UDT_STRUCTURE         
 '#VNOGEN',         
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',         
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',         
 '',         
 '0|0|0|0|0|0|0'     
      
INSERT INTO #VNOGEN      
(      
 EXCHANGE,      
 SEGMENT,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 VOUCHERNO,      
 MASTERSNO,      
 LEDGERNO,      
 SNO,      
 VNOFLAG,      
 PARAMNO,      
 NOVCH,      
 IDNO,    
 ENTRY_IDF    
)      
SELECT     
 EXCHANGE,     
 SEGMENT,     
 VTYPE,     
 BOOKTYPE,     
 VDT,     
 VOUCHERNO,     
 MASTERSNO = 0,     
 LEDGERNO = '',     
 COUNT(DISTINCT SNO),     
 P.VNOFLAG,      
 P.FLDAUTO,     
 (SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO),     
 IDNO,    
 ENTRY_IDF    
FROM     
 #VNODATA V,     
 PARAMETER P      
WHERE       
 V.SNO = 1 AND       
 MASTERSNO = 0 AND      
 V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR      
GROUP BY     
 EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF    
ORDER BY     
 VTYPE, BOOKTYPE, VDT, VOUCHERNO      
 

      
DECLARE      
 @TOTSNOS INT,      
 @STARTSNO BIGINT,      
 @LOOPSNO BIGINT      
    
    
SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0    
    
IF @TOTSNOS > 0    
BEGIN    
 EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT      
       
 UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V      
 WHERE #VNODATA.IDNO = V.IDNO      
       
 UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO      
 FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I      
 WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO    
 AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF    
 AND #VNODATA.SNO <> 1      
END    
IF @VOUCHERNO <> '' AND @TOTSNOS = 0    
BEGIN    
 SELECT @STARTSNO = MASTERSNO FROM #VNODATA    
END    
      
DECLARE      
 @VNOCUR CURSOR,      
 @VTYPE [UDTVTYPE],      
 @BOOKTYPE [UDTBOOKTYPE],      
 @VDT VARCHAR(11),      
 @EXCHANGE [UDTEXCHANGE],      
 @SEGMENT [UDTSEGMENT],      
 @STARTVNO [UDTVNO],      
 @ENDVNO [UDTVNO],      
 @MASTERSNO BIGINT,      
 @VNOCOUNT INT      
    
      
CREATE TABLE #VNOGENERATION      
(      
 VDT VARCHAR(11),      
 MASTERSNO BIGINT,       
 SNO INT IDENTITY(1, 1)      
)      
    
EXEC MAKE_UDT_STRUCTURE         
 '#VNOGENERATION',         
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',         
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',         
 '',         
 '0|0|0|0|0'      
    
SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA     
      
SET @VNOCUR = CURSOR FOR      
 SELECT     
  VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''      
 GROUP BY     
  VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT      
 --ORDER BY     
 -- VOUCHERNO, IDNO      
OPEN @VNOCUR      
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)          
  SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1       
  AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT      
  ORDER BY VOUCHERNO, IDNO      
    
  EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT      
  UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V      
  WHERE #VNODATA.MASTERSNO = V.MASTERSNO       
    
  TRUNCATE TABLE #VNOGENERATION      
  FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT      
 END      
      
UPDATE #VNODATA      
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR      
FROM PARAMETER P      
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR      
      
INSERT INTO #VNODATA     
 (EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,      
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,      
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,      
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,    
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,    
  CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,    
 FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)      
SELECT      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 DRAMOUNT = SUM(CRAMOUNT),      
 CRAMOUNT = SUM(DRAMOUNT),      
 CLTCODE = OPPACCOUNT,      
 ACNAME = OPPCODENAME,      
 ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,       
 MAINLEDGER = OPPACCOUNT,      
 MAINLEDGERNAME = OPPCODENAME,      
 MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 OPPACCOUNT,    
 OPPCODENAME,      
 VOUCHERNO,     
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,       
 SNO,    
 FINYEARID,    
 CHECKED_BY = CHECKED_BY,    
 POSTED_BY = POSTED_BY,    
 ENTRY_IDF    
FROM     
 #VNODATA     
WHERE     
 VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)      
GROUP BY      
 EXCHANGE,      
 SEGMENT,      
 VNO,      
 VTYPE,      
 BOOKTYPE,      
 VDT,      
 SDTCUR,      
 LDTCUR,      
 MASTERSNO,      
 ENTRY_AMT,      
 SETT_NO,      
 SETT_TYPE,      
 EDT,      
 OPPACCOUNT,     
 OPPCODENAME,     
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,       
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,      
 NARRATION,      
 BRANCHCODE,      
 REFCODE,      
 VOUCHERNO,      
 BANKNAME,    
 BRANCHNAME,    
 DDNO,    
 CHEQUEMODE,    
 CHEQUEDATE,    
 CHEQUENAME,    
 CLEAR_MODE,    
 MICR,      
 SNO,    
 FINYEARID,    
 CHECKED_BY,    
 POSTED_BY,    
 ENTRY_IDF    
      
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END      
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S      
WHERE #VNODATA.MASTERSNO = S.MASTERSNO      
      
      
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5      
      
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A      
WHERE #VNODATA.CLTCODE = A.CLTCODE      
      
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH      
WHERE BRANCHCODE <> ORGBRANCH      
AND ORGBRANCH <> 'ALL'      
    
UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL    
    
UPDATE #VNODATA      
SET      
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END      
FROM      
 (SELECT      
  MASTERSNO,     
  BRANCHCODE,      
  CNT = SUM(DRAMOUNT - CRAMOUNT)    
 FROM      
  #VNODATA      
 GROUP BY      
  MASTERSNO,     
  BRANCHCODE      
 ) L      
WHERE      
 #VNODATA.MASTERSNO = L.MASTERSNO      
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE    
    

    
 BEGIN TRAN    
    
 INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG    
 SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1    
 FROM V2_OFFLINE_LEDGER_ENTRIES V    
 WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3    
 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)    
    
 DELETE A FROM ACC_TBL2 A     
 WHERE EXISTS     
 (SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND 
 APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)      
    
 DELETE A FROM ACC_TBL3 A     
 WHERE EXISTS     
 (SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 
 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)      
    
 DELETE A FROM ACC_TBL4 A     
 WHERE EXISTS     
 (SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 
 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)      
    
 DELETE A FROM ACC_TBL5 A     
 WHERE EXISTS     
 (SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 
 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)      
    
 DELETE A FROM ACC_TBL1 A     
 WHERE EXISTS     
 (SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 
 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)      
    
 --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3    
     
 UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL    
    
 INSERT INTO ACC_TBL1    
 SELECT      
  VNO,      
  VTYPE,      
  BOOKTYPE,      
  EXCHANGE,      
  SEGMENT,      
  VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),      
  FINYEARID,     
  MKCKFLAG = 1,      
  VNO_MK = VOUCHERNO,      
  SNO = MASTERSNO,      
  REMARK = '',      
  REFSNO = 0,      
  POSTED_ON = GETDATE(),      
  POSTED_BY = POSTED_BY,     
  CHECKED_ON = GETDATE(),       
  CHECKED_BY = CHECKED_BY,       
  ENTRY_AMT,      
  SOURCE_MODULE = 'VNOPOST',      
  ENTRY_TYPE = 'N',      
  SETT_NO,      
  SETT_TYPE,      
  BILL_NO = 0,      
  SELL_BUY = 0,      
  LOCK_FLAG = 0,      
  DISPLAY_FLAG = 1,      
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = ''      
 FROM      
  #VNODATA      
 GROUP BY      
  VNO,      
  VTYPE,      
  BOOKTYPE,      
  EXCHANGE,      
  SEGMENT,      
  CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),      
  VOUCHERNO,      
  MASTERSNO,      
  ENTRY_AMT,      
  SETT_NO,      
  SETT_TYPE,    
  FINYEARID,    
  POSTED_BY,    
  CHECKED_BY    
 ORDER BY      
  MASTERSNO      
    
 INSERT INTO ACC_TBL2     
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)    
 SELECT      
  MASTERSNO,      
  EDT,      
  DRAMOUNT,      
  CRAMOUNT,      
  CLTCODE,      
  ACNAME,      
  MAINLEDGER,      
  MAINLEDGERNAME,     
  MAINACCAT,      
  NARRATION,    
  REFSNO = 0,      
  BALAMT = 0,      
  BRANCHCODE,      
  REFCODE,      
  ACCAT,      
  OPPACCOUNT,    
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = '',    
  'INR'        
 FROM      
  #VNODATA      
 WHERE      
  ACCAT <> 4    
    
 INSERT INTO ACC_TBL3     
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)    
 SELECT      
  MASTERSNO,      
  EDT,      
  DRAMOUNT,      
  CRAMOUNT,      
  CLTCODE,      
  ACNAME,      
  MAINLEDGER,      
  MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,      
  MAINACCAT,      
  NARRATION,    
  REFSNO = 0,      
  BALAMT = 0,      
  BRANCHCODE,      
  REFCODE,      
  ACCAT,      
  OPPACCOUNT,    
  RESERVED1 = '',      
  RESERVED2 = '',      
  RESERVED3 = '',      
  RESERVED4 = '',      
  RESERVED5 = '',    
  'INR'         
 FROM      
  #VNODATA      
 WHERE      
  ACCAT = 4    
     
 INSERT INTO ACC_TBL4    
 (BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)    
 SELECT     
  BANKNAME,     
  BRANCHNAME,     
  CHEQUEMODE,    
  DDNO = ISNULL(DDNO, ''),     
  CHEQUEDATE,    
  DR_RELDT = '',     
  CR_RELDT = '',     
  DR_RELAMT = SUM(CRAMOUNT),     
  CR_RELAMT = SUM(DRAMOUNT),     
  DR_REFNO = 0,     
  CR_REFNO = 0,     
  RECEIPTNO = 0,     
  DR_MICR = MICR,     
  CR_MICR = MICR,     
  SLIP_NO = 0,     
  SLIP_DATE = '',     
  CHEQUENAME,     
  CHQPRINTED = 0,     
  CLEARMODE = CLEAR_MODE,     
  MASTERSNO,     
  RESERVED1 = '',     
  RESERVED2 = '',     
  RESERVED3 = '',     
  RESERVED4 = '',     
  RESERVED5 = ''    
 FROM      
  #VNODATA      
 WHERE      
  ACCAT = 2    
 GROUP BY    
  BANKNAME,     
  BRANCHNAME,     
  CHEQUEMODE,    
  DDNO,     
  CHEQUEDATE,    
  MICR,    
  CHEQUENAME,     
  CLEAR_MODE,     
  MASTERSNO    
    
 UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO    
    
 /*    
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END    
 FROM ACC_TBL4 A4, #VNODATA V2    
 WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0    
    
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END    
 FROM ACC_TBL4 A4, #VNODATA V2    
 WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0    
 */    
 --------------- INSERT QUERIES -----------------------    
 COMMIT TRAN    
      
 DROP TABLE #VNODATA      
 DROP TABLE #VNOGEN      
 DROP TABLE #VNOGENERATION    
    
/* IF @VOUCHERNO <> ''    
 BEGIN    
  SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO    
  SELECT @STARTVNO    
 END*/    
END TRY    
BEGIN CATCH    
 IF @@TRANCOUNT > 0    
  ROLLBACK TRAN    
    
DECLARE @ERR_MSG NVARCHAR(2048)     
 SET @ERR_MSG = ERROR_MESSAGE()    
 RAISERROR (@ERR_MSG, 16, 1)    
 --RETURN    
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_OfflINE_Payout
-- --------------------------------------------------
--EXEC FA_POSTING '120402943803'      
--ROLLBACK      
CREATE PROCEDURE [dbo].[FA_POSTING_OfflINE_Payout]      
 @VOUCHERNO VARCHAR(12) = ''      
--WITH ENCRYPTION      
AS      
       
BEGIN TRY      
      
CREATE TABLE #VNODATA        
(        
 VDT DATETIME,        
 SDTCUR DATETIME,        
 LDTCUR DATETIME,        
 MASTERSNO BIGINT,        
 ENTRY_AMT MONEY,        
 SETT_NO VARCHAR(7),        
 SETT_TYPE VARCHAR(3),        
 EDT DATETIME,        
 DRAMOUNT MONEY,        
 CRAMOUNT MONEY,        
 BANKNAME [VARCHAR](50) NULL,      
 BRANCHNAME [VARCHAR](20) NULL,      
 DDNO [VARCHAR](15) NULL,      
 CHEQUEMODE [VARCHAR](1) NULL,      
 CHEQUEDATE [DATETIME] NULL,      
 CLEAR_MODE [VARCHAR](1) NULL,      
 MICR [VARCHAR](9) NULL,      
 SNO INT,       
 FLDAUTO BIGINT,      
 FINYEARID INT,       
 REVCODE VARCHAR(21),      
 POSTED_BY VARCHAR(50),      
 CHECKED_BY VARCHAR(50),      
 ENTRY_IDF INT,      
 IDNO INT IDENTITY(1,1)        
)        
      
EXEC MAKE_UDT_STRUCTURE       
 '#VNODATA',       
 'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME',       
 'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME',       
 '',       
 '0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'      
      
      
      
INSERT INTO #VNODATA        
(        
 EXCHANGE,        
 SEGMENT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 VDT,        
 SDTCUR,        
 LDTCUR,        
 MASTERSNO,        
 ENTRY_AMT,        
 SETT_NO,        
 SETT_TYPE,        
 EDT,        
 DRAMOUNT,        
 CRAMOUNT,        
 CLTCODE,        
 ACNAME,        
 ACCAT,        
 MAINLEDGER,        
 MAINLEDGERNAME,        
 MAINACCAT,        
 NARRATION,        
 BRANCHCODE,        
 REFCODE,        
 OPPACCOUNT,      
 OPPCODENAME,      
 VOUCHERNO,      
 BANKNAME,      
 BRANCHNAME,      
 DDNO,      
 CHEQUEMODE,      
 CHEQUEDATE,      
 CHEQUENAME,      
 CLEAR_MODE,      
 MICR,        
 SNO,      
 FLDAUTO,      
 FINYEARID,      
 REVCODE,      
 POSTED_BY,      
 CHECKED_BY,      
 ENTRY_IDF      
)      
SELECT        
 M.EXCHANGE,        
 M.SEGMENT,        
 VNO = '',        
 VTYPE = M.VOUCHERTYPE,        
 M.BOOKTYPE,        
 VDT = M.VDATE,        
 SDTCUR = CONVERT(DATETIME, ''),        
 LDTCUR = CONVERT(DATETIME, ''),        
 MASTERSNO = ISNULL(RESERVED1, 0),        
 ENTRY_AMT = 0,        
 SETT_NO = ISNULL(M.SETT_NO, ''),        
 SETT_TYPE = ISNULL(M.SETT_TYPE, ''),        
 M.EDATE,        
 DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),        
 CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),        
 M.CLTCODE,        
 ACNAME = M.CLIENTNAME,        
 ACCAT = 0,        
 MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,        
 MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,        
 MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,        
 M.NARRATION,        
 BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),        
 REFCODE = '',        
 OPPACCOUNT = M.OPPCODE,      
 OPPCODENAME,        
 M.VOUCHERNO,      
 BANKNAME,      
 BRANCHNAME,      
 DDNO,      
 CHEQUEMODE,      
 CHEQUEDATE,      
 CHEQUENAME,      
 CLEAR_MODE,      
 MICR,        
 SNO = ISNULL(CC.SNO, M.SNO),      
 M.FLDAUTO,      
 P.FLDAUTO,      
 REVCODE,      
 M.ADDBY,      
 M.APPROVEDBY,      
 M.RESERVED2      
FROM        
 (SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERTYPE =3 AND APPROVALFLAG = 1 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%' and addby='TPR') M        
 LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON        
  M.FLDAUTO = CC.VOLE_REFNO,      
 PARAMETER P       
WHERE      
 M.VDATE BETWEEN SDTCUR AND LDTCUR      
      
UPDATE V SET       
 V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,      
 V.MASTERSNO = A.SNO      
FROM       
 #VNODATA V,       
 ACC_TBL1 A,       
 PARAMETER P      
WHERE       
 V.MASTERSNO = A.SNO      
 AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))      
 AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR      
 AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE      
        
        
CREATE TABLE #VNOGEN        
(        
 VDT DATETIME,        
 MASTERSNO BIGINT,        
 SNO INT,        
 VNOFLAG TINYINT,        
 PARAMNO TINYINT,        
 NOVCH INT,        
 IDNO INT,        
 SRNO INT IDENTITY(1,1),      
 ENTRY_IDF INT      
)        
      
EXEC MAKE_UDT_STRUCTURE           
 '#VNOGEN',           
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',           
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',           
 '',           
 '0|0|0|0|0|0|0'       
        
INSERT INTO #VNOGEN        
(        
 EXCHANGE,        
 SEGMENT,        
 VTYPE,        
 BOOKTYPE,        
 VDT,        
 VOUCHERNO,        
 MASTERSNO,        
 LEDGERNO,        
 SNO,        
 VNOFLAG,        
 PARAMNO,        
 NOVCH,        
 IDNO,      
 ENTRY_IDF      
)        
SELECT       
 EXCHANGE,       
 SEGMENT,       
 VTYPE,       
 BOOKTYPE,       
 VDT,       
 VOUCHERNO,       
 MASTERSNO = 0,       
 LEDGERNO = '',       
 COUNT(DISTINCT SNO),       
 P.VNOFLAG,        
 P.FLDAUTO,       
 (SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO),       
 IDNO,      
 ENTRY_IDF      
FROM       
 #VNODATA V,       
 PARAMETER P        
WHERE         
 V.SNO = 1 AND         
 MASTERSNO = 0 AND        
 V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR        
GROUP BY       
 EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF      
ORDER BY       
 VTYPE, BOOKTYPE, VDT, VOUCHERNO        
   
  
        
DECLARE        
 @TOTSNOS INT,        
 @STARTSNO BIGINT,        
 @LOOPSNO BIGINT        
      
      
SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0      
      
IF @TOTSNOS > 0      
BEGIN      
 EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT        
         
 UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V        
 WHERE #VNODATA.IDNO = V.IDNO        
         
 UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO        
 FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I        
 WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO      
 AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF      
 AND #VNODATA.SNO <> 1        
END      
IF @VOUCHERNO <> '' AND @TOTSNOS = 0      
BEGIN      
 SELECT @STARTSNO = MASTERSNO FROM #VNODATA      
END      
        
DECLARE        
 @VNOCUR CURSOR,        
 @VTYPE [UDTVTYPE],        
 @BOOKTYPE [UDTBOOKTYPE],        
 @VDT VARCHAR(11),        
 @EXCHANGE [UDTEXCHANGE],        
 @SEGMENT [UDTSEGMENT],        
 @STARTVNO [UDTVNO],        
 @ENDVNO [UDTVNO],        
 @MASTERSNO BIGINT,        
 @VNOCOUNT INT        
      
        
CREATE TABLE #VNOGENERATION        
(        
 VDT VARCHAR(11),        
 MASTERSNO BIGINT,         
 SNO INT IDENTITY(1, 1)        
)        
      
EXEC MAKE_UDT_STRUCTURE           
 '#VNOGENERATION',           
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',           
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',           
 '',           
 '0|0|0|0|0'        
      
SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA       
        
SET @VNOCUR = CURSOR FOR        
 SELECT       
  VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''        
 GROUP BY       
  VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT        
 --ORDER BY       
 -- VOUCHERNO, IDNO        
OPEN @VNOCUR        
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT        
WHILE @@FETCH_STATUS = 0        
 BEGIN        
  INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)            
  SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1         
  AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT        
  ORDER BY VOUCHERNO, IDNO        
      
  EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT        
  UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V        
  WHERE #VNODATA.MASTERSNO = V.MASTERSNO         
      
  TRUNCATE TABLE #VNOGENERATION        
  FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT        
 END        
        
UPDATE #VNODATA        
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR        
FROM PARAMETER P        
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR        
        
INSERT INTO #VNODATA       
 (EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,        
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,        
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,        
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,      
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,      
  CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,      
 FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)        
SELECT        
 EXCHANGE,        
 SEGMENT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 VDT,        
 SDTCUR,        
 LDTCUR,        
 MASTERSNO,        
 ENTRY_AMT,        
 SETT_NO,        
 SETT_TYPE,        
 EDT,        
 DRAMOUNT = SUM(CRAMOUNT),        
 CRAMOUNT = SUM(DRAMOUNT),        
 CLTCODE = OPPACCOUNT,        
 ACNAME = OPPCODENAME,        
 ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,         
 MAINLEDGER = OPPACCOUNT,        
 MAINLEDGERNAME = OPPCODENAME,        
 MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,        
 NARRATION,        
 BRANCHCODE,        
 REFCODE,        
 OPPACCOUNT,      
 OPPCODENAME,        
 VOUCHERNO,       
 BANKNAME,      
 BRANCHNAME,      
 DDNO,      
 CHEQUEMODE,      
 CHEQUEDATE,      
 CHEQUENAME,      
 CLEAR_MODE,      
 MICR,         
 SNO,      
 FINYEARID,      
 CHECKED_BY = CHECKED_BY,      
 POSTED_BY = POSTED_BY,      
 ENTRY_IDF      
FROM       
 #VNODATA       
WHERE       
 VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)        
GROUP BY        
 EXCHANGE,        
 SEGMENT,        
 VNO,        
 VTYPE,        
 BOOKTYPE,        
 VDT,        
 SDTCUR,        
 LDTCUR,        
 MASTERSNO,        
 ENTRY_AMT,        
 SETT_NO,        
 SETT_TYPE,        
 EDT,        
 OPPACCOUNT,       
 OPPCODENAME,       
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,         
 CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,        
 NARRATION,        
 BRANCHCODE,        
 REFCODE,        
 VOUCHERNO,        
 BANKNAME,      
 BRANCHNAME,      
 DDNO,      
 CHEQUEMODE,      
 CHEQUEDATE,      
 CHEQUENAME,      
 CLEAR_MODE,      
 MICR,        
 SNO,      
 FINYEARID,      
 CHECKED_BY,      
 POSTED_BY,      
 ENTRY_IDF      
        
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END        
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S        
WHERE #VNODATA.MASTERSNO = S.MASTERSNO        
        
        
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5        
        
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A        
WHERE #VNODATA.CLTCODE = A.CLTCODE        
        
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH        
WHERE BRANCHCODE <> ORGBRANCH        
AND ORGBRANCH <> 'ALL'        
      
UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL      
      
UPDATE #VNODATA        
SET        
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END        
FROM        
 (SELECT        
  MASTERSNO,       
  BRANCHCODE,        
  CNT = SUM(DRAMOUNT - CRAMOUNT)      
 FROM        
  #VNODATA      
 GROUP BY        
  MASTERSNO,       
  BRANCHCODE        
 ) L        
WHERE        
 #VNODATA.MASTERSNO = L.MASTERSNO        
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE      
      
  
      
 BEGIN TRAN      
      
 INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG      
 SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1      
 FROM V2_OFFLINE_LEDGER_ENTRIES V      
 WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3      
 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)      
      
CREATE TABLE #VNO_TO_DELETE
	(
		MASTERSNO INT
	)
	
	CREATE NONCLUSTERED INDEX [MSNO_VNODATA] ON [dbo].[#VNO_TO_DELETE] 
	(
		[MASTERSNO] ASC
	)
	
	INSERT INTO #VNO_TO_DELETE
	SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT MASTERSNO = RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V

	/*DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  */
	
	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 
	
	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.MASTERSNO ) 

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM #VNO_TO_DELETE v WHERE V.MASTERSNO = A.SNO ) 

 --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3      
       
 UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL      
      
 INSERT INTO ACC_TBL1      
 SELECT        
  VNO,        
  VTYPE,        
  BOOKTYPE,        
  EXCHANGE,        
  SEGMENT,        
  VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),        
  FINYEARID,       
  MKCKFLAG = 1,        
  VNO_MK = VOUCHERNO,        
  SNO = MASTERSNO,        
  REMARK = '',        
  REFSNO = 0,        
  POSTED_ON = GETDATE(),        
  POSTED_BY = POSTED_BY,       
  CHECKED_ON = GETDATE(),         
  CHECKED_BY = CHECKED_BY,         
  ENTRY_AMT,        
  SOURCE_MODULE = 'VNOPOST',        
  ENTRY_TYPE = 'N',        
  SETT_NO,        
  SETT_TYPE,        
  BILL_NO = 0,        
  SELL_BUY = 0,        
  LOCK_FLAG = 0,        
  DISPLAY_FLAG = 1,        
  RESERVED1 = '',        
  RESERVED2 = '',        
  RESERVED3 = '',        
  RESERVED4 = '',        
  RESERVED5 = ''        
 FROM        
  #VNODATA        
 GROUP BY        
  VNO,        
  VTYPE,        
  BOOKTYPE,        
  EXCHANGE,        
  SEGMENT,        
  CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),        
  VOUCHERNO,        
  MASTERSNO,        
  ENTRY_AMT,        
  SETT_NO,        
  SETT_TYPE,      
  FINYEARID,      
  POSTED_BY,      
  CHECKED_BY      
 ORDER BY        
  MASTERSNO        
      
 INSERT INTO ACC_TBL2       
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)      
 SELECT        
  MASTERSNO,        
  EDT,        
  DRAMOUNT,        
  CRAMOUNT,        
  CLTCODE,        
  ACNAME,        
  MAINLEDGER,        
  MAINLEDGERNAME,       
  MAINACCAT,        
  NARRATION,      
  REFSNO = 0,        
  BALAMT = 0,        
  BRANCHCODE,        
  REFCODE,        
  ACCAT,        
  OPPACCOUNT,      
  RESERVED1 = '',        
  RESERVED2 = '',        
  RESERVED3 = '',        
  RESERVED4 = '',        
  RESERVED5 = '',      
  'INR'          
 FROM        
  #VNODATA        
 WHERE        
  ACCAT <> 4      
      
 INSERT INTO ACC_TBL3       
 (MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)      
 SELECT        
  MASTERSNO,        
  EDT,        
  DRAMOUNT,        
  CRAMOUNT,        
  CLTCODE,        
  ACNAME,        
  MAINLEDGER,        
  MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,        
  MAINACCAT,        
  NARRATION,      
  REFSNO = 0,        
  BALAMT = 0,        
  BRANCHCODE,        
  REFCODE,        
  ACCAT,        
  OPPACCOUNT,      
  RESERVED1 = '',        
  RESERVED2 = '',        
  RESERVED3 = '',        
  RESERVED4 = '',        
  RESERVED5 = '',      
  'INR'           
 FROM        
  #VNODATA        
 WHERE        
  ACCAT = 4      
       
 INSERT INTO ACC_TBL4      
 (BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)      
 SELECT       
  BANKNAME,       
  BRANCHNAME,       
  CHEQUEMODE,      
  DDNO = ISNULL(DDNO, ''),       
  CHEQUEDATE,      
  DR_RELDT = '',       
  CR_RELDT = '',       
  DR_RELAMT = SUM(CRAMOUNT),       
  CR_RELAMT = SUM(DRAMOUNT),       
  DR_REFNO = 0,       
  CR_REFNO = 0,       
  RECEIPTNO = 0,       
  DR_MICR = MICR,       
  CR_MICR = MICR,       
  SLIP_NO = 0,       
  SLIP_DATE = '',       
  CHEQUENAME,       
  CHQPRINTED = 0,       
  CLEARMODE = CLEAR_MODE,       
  MASTERSNO,       
  RESERVED1 = '',       
  RESERVED2 = '',       
  RESERVED3 = '',       
  RESERVED4 = '',       
  RESERVED5 = ''      
 FROM        
  #VNODATA        
 WHERE        
  ACCAT = 2      
 GROUP BY      
  BANKNAME,       
  BRANCHNAME,       
  CHEQUEMODE,      
  DDNO,       
  CHEQUEDATE,      
  MICR,      
  CHEQUENAME,       
  CLEAR_MODE,       
  MASTERSNO      
      
 UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO      
      
 /*      
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END      
 FROM ACC_TBL4 A4, #VNODATA V2      
 WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0      
      
 UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END      
 FROM ACC_TBL4 A4, #VNODATA V2      
 WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0      
 */      
 --------------- INSERT QUERIES -----------------------      
 COMMIT TRAN      
        
 DROP TABLE #VNODATA        
 DROP TABLE #VNOGEN        
 DROP TABLE #VNOGENERATION      
      
/* IF @VOUCHERNO <> ''      
 BEGIN      
  SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO      
  SELECT @STARTVNO      
 END*/      
END TRY      
BEGIN CATCH      
 IF @@TRANCOUNT > 0      
  ROLLBACK TRAN      
      
DECLARE @ERR_MSG NVARCHAR(2048)       
 SET @ERR_MSG = ERROR_MESSAGE()      
 RAISERROR (@ERR_MSG, 16, 1)      
 --RETURN      
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FA_POSTING_tesing
-- --------------------------------------------------
--exec FA_POSTING '120402943803'
--rollback
CREATE PROCEDURE [dbo].[FA_POSTING_tesing]
	@VOUCHERNO VARCHAR(12) = ''
--WITH ENCRYPTION
AS
	
BEGIN TRY

CREATE TABLE #VNODATA  
(  
	VDT DATETIME,  
	SDTCUR DATETIME,  
	LDTCUR DATETIME,  
	MASTERSNO BIGINT,  
	ENTRY_AMT MONEY,  
	SETT_NO VARCHAR(7),  
	SETT_TYPE VARCHAR(3),  
	EDT DATETIME,  
	DRAMOUNT MONEY,  
	CRAMOUNT MONEY,  
	BANKNAME [VARCHAR](50) NULL,
	BRANCHNAME [VARCHAR](20) NULL,
	DDNO [VARCHAR](15) NULL,
	CHEQUEMODE [VARCHAR](1) NULL,
	CHEQUEDATE [DATETIME] NULL,
	CLEAR_MODE [VARCHAR](1) NULL,
	MICR [VARCHAR](9) NULL,
	SNO INT, 
	FLDAUTO BIGINT,
	FINYEARID INT, 
	REVCODE VARCHAR(21),
	POSTED_BY VARCHAR(50),
	CHECKED_BY VARCHAR(50),
	ENTRY_IDF INT,
	IDNO INT IDENTITY(1,1)  
)  

EXEC MAKE_UDT_STRUCTURE 
	'#VNODATA', 
	'EXCHANGE|SEGMENT|VNO|VTYPE|BOOKTYPE|CLTCODE|ACNAME|ACCAT|MAINLEDGER|MAINLEDGERNAME|MAINACCAT|NARRATION|BRANCHCODE|REFCODE|ORGBRANCH|OPPACCOUNT|OPPCODENAME|VOUCHERNO|CHEQUENAME', 
	'UDTEXCHANGE|UDTSEGMENT|UDTVNO|UDTVTYPE|UDTBOOKTYPE|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTPARTYCODE|UDTACNAME|UDTVTYPE|UDTNARRATION|UDTBRANCHCODE|UDTBRANCHCODE|UDTBRANCHCODE|UDTPARTYCODE|UDTACNAME|UDTVNO|UDTACNAME', 
	'', 
	'0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'



INSERT INTO #VNODATA  
(  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT,  
	CRAMOUNT,  
	CLTCODE,  
	ACNAME,  
	ACCAT,  
	MAINLEDGER,  
	MAINLEDGERNAME,  
	MAINACCAT,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,
	VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FLDAUTO,
	FINYEARID,
	REVCODE,
	POSTED_BY,
	CHECKED_BY,
	ENTRY_IDF
)
SELECT  
	M.EXCHANGE,  
	M.SEGMENT,  
	VNO = '',  
	VTYPE = M.VOUCHERTYPE,  
	M.BOOKTYPE,  
	VDT = M.VDATE,  
	SDTCUR = CONVERT(DATETIME, ''),  
	LDTCUR = CONVERT(DATETIME, ''),  
	MASTERSNO = ISNULL(RESERVED1, 0),  
	ENTRY_AMT = 0,  
	SETT_NO = ISNULL(M.SETT_NO, ''),  
	SETT_TYPE = ISNULL(M.SETT_TYPE, ''),  
	M.EDATE,  
	DRAMOUNT = ISNULL(CC.DEBITAMT, M.DEBITAMT),  
	CRAMOUNT = ISNULL(CC.CREDITAMT, M.CREDITAMT),  
	M.CLTCODE,  
	ACNAME = M.CLIENTNAME,  
	ACCAT = 0,  
	MAINLEDGER = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODE ELSE M.CLTCODE END,  
	MAINLEDGERNAME = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN M.MARGINCODENAME ELSE M.CLIENTNAME END,  
	MAINACCAT = CASE WHEN M.VOUCHERTYPE IN (19, 20, 22, 23, 24) THEN 14 ELSE 0 END,  
	M.NARRATION,  
	BRANCHCODE = ISNULL(CC.BRANCHCODE, M.BRANCHCODE),  
	REFCODE = '',  
	OPPACCOUNT = M.OPPCODE,
	OPPCODENAME,  
	M.VOUCHERNO,
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO = ISNULL(CC.SNO, M.SNO),
	M.FLDAUTO,
	P.FLDAUTO,
	REVCODE,
	M.ADDBY,
	M.APPROVEDBY,
	M.RESERVED2
FROM  
	(SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE APPROVALFLAG = 1 AND ROWSTATE = 0 AND VOUCHERNO LIKE @VOUCHERNO + '%') M  
	LEFT JOIN V2_OFFLINE_CC_ENTRIES CC ON  
		M.FLDAUTO = CC.VOLE_REFNO,
	PARAMETER P 
WHERE
	M.VDATE BETWEEN SDTCUR AND LDTCUR
	and m.CLTCODE='NOD2228'
	and m.CREDITAMT=3
	
	

UPDATE V SET 
	V.VNO = CASE WHEN VNOFLAG = 0 THEN A.VNO ELSE CASE WHEN CONVERT(NUMERIC, CONVERT(VARCHAR, V.VDT, 112)) = A.VDT THEN A.VNO ELSE '' END END,
	V.MASTERSNO = A.SNO
FROM 
	#VNODATA V, 
	ACC_TBL1 A, 
	PARAMETER P
WHERE 
	V.MASTERSNO = A.SNO
	AND A.VDT >= CONVERT(NUMERIC, CONVERT(VARCHAR, P.SDTCUR, 112)) AND A.VDT <= CONVERT(NUMERIC, CONVERT(VARCHAR, P.LDTCUR, 112))
	AND V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR
	AND V.EXCHANGE = A.EXCHANGE AND V.SEGMENT = A.SEGMENT AND V.VTYPE = A.VTYPE AND A.BOOKTYPE = V.BOOKTYPE
  
  
CREATE TABLE #VNOGEN  
(  
	VDT DATETIME,  
	MASTERSNO BIGINT,  
	SNO INT,  
	VNOFLAG TINYINT,  
	PARAMNO TINYINT,  
	NOVCH INT,  
	IDNO INT,  
	SRNO INT IDENTITY(1,1),
	ENTRY_IDF INT
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGEN',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE|VOUCHERNO|LEDGERNO',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE|UDTVNO|UDTVNO',     
 '',     
 '0|0|0|0|0|0|0' 
  
INSERT INTO #VNOGEN  
(  
	EXCHANGE,  
	SEGMENT,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	VOUCHERNO,  
	MASTERSNO,  
	LEDGERNO,  
	SNO,  
	VNOFLAG,  
	PARAMNO,  
	NOVCH,  
	IDNO,
	ENTRY_IDF
)  
SELECT 
	EXCHANGE, 
	SEGMENT, 
	VTYPE, 
	BOOKTYPE, 
	VDT, 
	VOUCHERNO, 
	MASTERSNO = 0, 
	LEDGERNO = '', 
	COUNT(DISTINCT SNO), 
	P.VNOFLAG,  
	P.FLDAUTO, 
	(SELECT COUNT(1) FROM #VNODATA I WHERE I.VOUCHERNO = V.VOUCHERNO), 
	IDNO,
	ENTRY_IDF
FROM 
	#VNODATA V, 
	PARAMETER P  
WHERE   
	V.SNO = 1 AND   
	MASTERSNO = 0 AND  
	V.VDT >= P.SDTCUR AND V.VDT <= P.LDTCUR  
GROUP BY 
	EXCHANGE, SEGMENT, VTYPE, BOOKTYPE, VDT, VOUCHERNO, P.VNOFLAG, P.FLDAUTO, IDNO, ENTRY_IDF
ORDER BY 
	VTYPE, BOOKTYPE, VDT, VOUCHERNO  
  
DECLARE  
	@TOTSNOS INT,  
	@STARTSNO BIGINT,  
	@LOOPSNO BIGINT  


SELECT @TOTSNOS = COUNT(1) FROM #VNODATA WHERE SNO = 1 AND MASTERSNO = 0

IF @TOTSNOS > 0
BEGIN
	EXEC ACCGENSNO @TOTSNOS, @STARTSNO OUTPUT  
	  
	UPDATE #VNODATA SET MASTERSNO = @STARTSNO + (SRNO - 1) FROM #VNOGEN V  
	WHERE #VNODATA.IDNO = V.IDNO  
	  
	UPDATE #VNODATA SET MASTERSNO = I.MASTERSNO  
	FROM (SELECT MASTERSNO, VOUCHERNO, ENTRY_IDF FROM #VNODATA WHERE SNO = 1) I  
	WHERE #VNODATA.VOUCHERNO = I.VOUCHERNO
	AND #VNODATA.ENTRY_IDF = I.ENTRY_IDF
	AND #VNODATA.SNO <> 1  
END
IF @VOUCHERNO <> '' AND @TOTSNOS = 0
BEGIN
	SELECT @STARTSNO = MASTERSNO FROM #VNODATA
END
  
DECLARE  
	@VNOCUR CURSOR,  
	@VTYPE [UDTVTYPE],  
	@BOOKTYPE [UDTBOOKTYPE],  
	@VDT VARCHAR(11),  
	@EXCHANGE [UDTEXCHANGE],  
	@SEGMENT [UDTSEGMENT],  
	@STARTVNO [UDTVNO],  
	@ENDVNO [UDTVNO],  
	@MASTERSNO BIGINT,  
	@VNOCOUNT INT  

  
CREATE TABLE #VNOGENERATION  
(  
	VDT VARCHAR(11),  
	MASTERSNO BIGINT,   
	SNO INT IDENTITY(1, 1)  
)  

EXEC MAKE_UDT_STRUCTURE     
 '#VNOGENERATION',     
 'EXCHANGE|SEGMENT|VTYPE|BOOKTYPE',     
 'UDTEXCHANGE|UDTSEGMENT|UDTVTYPE|UDTBOOKTYPE',     
 '',     
 '0|0|0|0|0'  

SELECT TOP 1 @STARTVNO = VNO FROM #VNODATA 
  
SET @VNOCUR = CURSOR FOR  
	SELECT	
		VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, COUNT(1) FROM #VNODATA WHERE SNO = 1 AND VNO = ''  
	GROUP BY 
		VTYPE, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT  
	--ORDER BY 
	--	VOUCHERNO, IDNO  
OPEN @VNOCUR  
FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
WHILE @@FETCH_STATUS = 0  
	BEGIN  
		INSERT INTO #VNOGENERATION  (VTYPE, BOOKTYPE, VDT, EXCHANGE, SEGMENT, MASTERSNO)      
		SELECT VTYPE, BOOKTYPE, VDT = CONVERT(VARCHAR(11), VDT, 109), EXCHANGE, SEGMENT, MASTERSNO FROM #VNODATA WHERE SNO = 1   
		AND VTYPE = @VTYPE AND BOOKTYPE = @BOOKTYPE AND VDT = @VDT AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
		ORDER BY VOUCHERNO, IDNO  

		EXEC ACCGENVNO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT, @STARTVNO OUTPUT, @ENDVNO OUTPUT  
		UPDATE #VNODATA SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @STARTVNO) + (V.SNO - 1)) FROM #VNOGENERATION V  
		WHERE #VNODATA.MASTERSNO = V.MASTERSNO   

		TRUNCATE TABLE #VNOGENERATION  
		FETCH NEXT FROM @VNOCUR INTO @VTYPE, @BOOKTYPE, @VDT, @EXCHANGE, @SEGMENT, @VNOCOUNT  
	END  
  
UPDATE #VNODATA  
SET SDTCUR = P.SDTCUR, LDTCUR = P.LDTCUR  
FROM PARAMETER P  
WHERE #VNODATA.VDT BETWEEN P.SDTCUR AND P.LDTCUR  
  
INSERT INTO #VNODATA 
	(EXCHANGE, SEGMENT, VNO, VTYPE, BOOKTYPE, VDT, SDTCUR, LDTCUR,  
     MASTERSNO, ENTRY_AMT, SETT_NO, SETT_TYPE, EDT, DRAMOUNT,  
     CRAMOUNT, CLTCODE, ACNAME, ACCAT, MAINLEDGER, MAINLEDGERNAME,  
     MAINACCAT, NARRATION, BRANCHCODE, REFCODE, OPPACCOUNT, OPPCODENAME,
     VOUCHERNO, BANKNAME, BRANCHNAME, DDNO, CHEQUEMODE,
	 CHEQUEDATE, CHEQUENAME, CLEAR_MODE, MICR, SNO,
	FINYEARID,CHECKED_BY,POSTED_BY, ENTRY_IDF)  
SELECT  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	DRAMOUNT = SUM(CRAMOUNT),  
	CRAMOUNT = SUM(DRAMOUNT),  
	CLTCODE = OPPACCOUNT,  
	ACNAME = OPPCODENAME,  
	ACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,   
	MAINLEDGER = OPPACCOUNT,  
	MAINLEDGERNAME = OPPCODENAME,  
	MAINACCAT = CASE WHEN VTYPE IN(1, 4, 22, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	OPPACCOUNT,
	OPPCODENAME,  
	VOUCHERNO, 
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,   
	SNO,
	FINYEARID,
	CHECKED_BY = CHECKED_BY,
	POSTED_BY = POSTED_BY,
	ENTRY_IDF
FROM 
	#VNODATA 
WHERE 
	VTYPE IN (1, 2, 3, 4, 19, 20, 22, 23)  
GROUP BY  
	EXCHANGE,  
	SEGMENT,  
	VNO,  
	VTYPE,  
	BOOKTYPE,  
	VDT,  
	SDTCUR,  
	LDTCUR,  
	MASTERSNO,  
	ENTRY_AMT,  
	SETT_NO,  
	SETT_TYPE,  
	EDT,  
	OPPACCOUNT, 
	OPPCODENAME, 
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,   
	CASE WHEN VTYPE IN(1, 4, 2, 23) THEN 1 ELSE 2 END,  
	NARRATION,  
	BRANCHCODE,  
	REFCODE,  
	VOUCHERNO,  
	BANKNAME,
	BRANCHNAME,
	DDNO,
	CHEQUEMODE,
	CHEQUEDATE,
	CHEQUENAME,
	CLEAR_MODE,
	MICR,  
	SNO,
	FINYEARID,
	CHECKED_BY,
	POSTED_BY,
	ENTRY_IDF
  
UPDATE #VNODATA SET ENTRY_AMT = CASE WHEN S.DAMOUNT > 0 THEN S.DAMOUNT ELSE S.CAMOUNT END  
FROM (SELECT MASTERSNO, DAMOUNT = SUM(DRAMOUNT), CAMOUNT = SUM(CRAMOUNT) FROM #VNODATA GROUP BY MASTERSNO) S  
WHERE #VNODATA.MASTERSNO = S.MASTERSNO  
  
  
UPDATE #VNODATA SET CLTCODE = OPPACCOUNT WHERE VTYPE = 5  
  
UPDATE #VNODATA SET ORGBRANCH = A.BRANCHCODE, ACCAT = A.ACCAT, MAINACCAT = CASE WHEN MAINACCAT = 0 THEN A.ACCAT ELSE MAINACCAT END FROM ACMAST A  
WHERE #VNODATA.CLTCODE = A.CLTCODE  
  
UPDATE #VNODATA SET BRANCHCODE = ORGBRANCH  
WHERE BRANCHCODE <> ORGBRANCH  
AND ORGBRANCH <> 'ALL'  

UPDATE #VNODATA SET OPPACCOUNT = '' WHERE OPPACCOUNT IS NULL

UPDATE #VNODATA  
SET  
 REFCODE = CASE WHEN L.CNT <> 0 THEN 'HO' ELSE L.BRANCHCODE END  
FROM  
 (SELECT  
  MASTERSNO, 
  BRANCHCODE,  
  CNT = SUM(DRAMOUNT - CRAMOUNT)
 FROM  
  #VNODATA  
 GROUP BY  
  MASTERSNO, 
  BRANCHCODE  
 ) L  
WHERE  
 #VNODATA.MASTERSNO = L.MASTERSNO  
 AND #VNODATA.BRANCHCODE = L.BRANCHCODE

	
	BEGIN TRAN

	INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG
	SELECT *, APPROVEDBY, GETDATE(), CASE WHEN APPROVALFLAG = 1 THEN 'E' ELSE 'D' END, HOST_NAME(), 1
	FROM V2_OFFLINE_LEDGER_ENTRIES V
	WHERE (ROWSTATE = 0 AND APPROVALFLAG = 1 AND LEDGERVNO <> '') OR APPROVALFLAG = 3
	AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V.RESERVED1 = V1.RESERVED1)

	DELETE A FROM ACC_TBL2 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL3 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL4 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL5 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.MASTERSNO)  

	DELETE A FROM ACC_TBL1 A 
	WHERE EXISTS 
	(SELECT MASTERSNO FROM (SELECT MASTERSNO FROM #VNODATA UNION ALL SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V2 WHERE ROWSTATE = 1 AND APPROVALFLAG = 3 AND NOT EXISTS(SELECT RESERVED1 FROM V2_OFFLINE_LEDGER_ENTRIES V1 WHERE ROWSTATE = 1 AND APPROVALFLAG = 1 AND V2.RESERVED1 = V1.RESERVED1)) V WHERE V.MASTERSNO = A.SNO)  

	--DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE ROWSTATE = 1 AND APPROVALFLAG = 3
	
	UPDATE #VNODATA SET #VNODATA.ACNAME = LONGNAME FROM ACMAST A WHERE #VNODATA.CLTCODE = A.CLTCODE AND #VNODATA.ACNAME IS NULL

	INSERT INTO ACC_TBL1
	SELECT  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		VDT = CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		FINYEARID, 
		MKCKFLAG = 1,  
		VNO_MK = VOUCHERNO,  
		SNO = MASTERSNO,  
		REMARK = '',  
		REFSNO = 0,  
		POSTED_ON = GETDATE(),  
		POSTED_BY = POSTED_BY, 
		CHECKED_ON = GETDATE(),   
		CHECKED_BY = CHECKED_BY,   
		ENTRY_AMT,  
		SOURCE_MODULE = 'VNOPOST',  
		ENTRY_TYPE = 'N',  
		SETT_NO,  
		SETT_TYPE,  
		BILL_NO = 0,  
		SELL_BUY = 0,  
		LOCK_FLAG = 0,  
		DISPLAY_FLAG = 1,  
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = ''  
	FROM  
		#VNODATA  
	GROUP BY  
		VNO,  
		VTYPE,  
		BOOKTYPE,  
		EXCHANGE,  
		SEGMENT,  
		CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), VDT, 112)),  
		VOUCHERNO,  
		MASTERSNO,  
		ENTRY_AMT,  
		SETT_NO,  
		SETT_TYPE,
		FINYEARID,
		POSTED_BY,
		CHECKED_BY 
	ORDER BY  
		MASTERSNO  
		

	INSERT INTO ACC_TBL2 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME, 
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'    
	FROM  
		#VNODATA  
	WHERE  
		ACCAT <> 4

	INSERT INTO ACC_TBL3 
	(MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY)
	SELECT  
		MASTERSNO,  
		EDT,  
		DRAMOUNT,  
		CRAMOUNT,  
		CLTCODE,  
		ACNAME,  
		MAINLEDGER,  
		MAINLEDGERNAME = CASE WHEN ISNULL(MAINLEDGERNAME, '') = '' THEN ACNAME ELSE MAINLEDGERNAME END,  
		MAINACCAT,  
		NARRATION,
		REFSNO = 0,  
		BALAMT = 0,  
		BRANCHCODE,  
		REFCODE,  
		ACCAT,  
		OPPACCOUNT,
		RESERVED1 = '',  
		RESERVED2 = '',  
		RESERVED3 = '',  
		RESERVED4 = '',  
		RESERVED5 = '',
		'INR'     
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 4
	
	INSERT INTO ACC_TBL4
	(BNKNAME,BRNNAME,CHQDD,INSTNO,INSTDATE,DR_RELDT,CR_RELDT,DR_RELAMT,CR_RELAMT,DR_REFNO,CR_REFNO,RECEIPTNO,DR_MICRNO,CR_MICRNO,SLIP_NO,SLIP_DATE,CHQINNAME,CHQPRINTED,CLEARMODE,MASTERSNO,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)
	SELECT 
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO = ISNULL(DDNO, ''), 
		CHEQUEDATE,
		DR_RELDT = '', 
		CR_RELDT = '', 
		DR_RELAMT = SUM(CRAMOUNT), 
		CR_RELAMT = SUM(DRAMOUNT), 
		DR_REFNO = 0, 
		CR_REFNO = 0, 
		RECEIPTNO = 0, 
		DR_MICR = MICR, 
		CR_MICR = MICR, 
		SLIP_NO = 0, 
		SLIP_DATE = '', 
		CHEQUENAME, 
		CHQPRINTED = 0, 
		CLEARMODE = CLEAR_MODE, 
		MASTERSNO, 
		RESERVED1 = '', 
		RESERVED2 = '', 
		RESERVED3 = '', 
		RESERVED4 = '', 
		RESERVED5 = ''
	FROM  
		#VNODATA  
	WHERE  
		ACCAT = 2
	GROUP BY
		BANKNAME, 
		BRANCHNAME, 
		CHEQUEMODE,
		DDNO, 
		CHEQUEDATE,
		MICR,
		CHEQUENAME, 
		CLEAR_MODE, 
		MASTERSNO

	UPDATE V2 SET LEDGERVNO = V.VNO, ROWSTATE = 1, RESERVED1 = MASTERSNO, APPROVALFLAG = 1
	 FROM V2_OFFLINE_LEDGER_ENTRIES V2, #VNODATA V WHERE V2.FLDAUTO = V.FLDAUTO

	/*
	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = V2.MASTERSNO AND .DBO.PIECE(REVCODE, '|', 2) = 0

	UPDATE A4 SET DR_RELDT = CASE WHEN DRAMOUNT >= 0 THEN V2.VDT ELSE '' END, CR_RELDT = CASE WHEN CRAMOUNT >= 0 THEN V2.VDT ELSE '' END
	FROM ACC_TBL4 A4, #VNODATA V2
	WHERE A4.MASTERSNO = .DBO.PIECE(REVCODE, '|', 1) AND .DBO.PIECE(REVCODE, '|', 2) = 0
	*/
	--------------- INSERT QUERIES -----------------------
	COMMIT TRAN
  
	DROP TABLE #VNODATA  
	DROP TABLE #VNOGEN  
	DROP TABLE #VNOGENERATION

/*	IF @VOUCHERNO <> ''
	BEGIN
		SELECT @STARTVNO = VNO FROM ACC_TBL1 WHERE SNO = @STARTSNO
		SELECT @STARTVNO
	END*/
END TRY
BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK TRAN

DECLARE @ERR_MSG nvarchar(2048) 
	SET @ERR_MSG = ERROR_MESSAGE()
	RAISERROR (@ERR_MSG, 16, 1)
	--RETURN
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FILELIST
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fun
-- --------------------------------------------------

CREATE PROC Fun @fun VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @fun + '%' and xtype='FN' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_ACC_GROUPS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_CAT_USER_LIST
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_OFFLINE_VOUCHER_EDIT_DATA
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[GET_OFFLINE_VOUCHER_EDIT_DATA]
@FLDAUTO VARCHAR(600),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(20),
@VNO VARCHAR(12),
@VTYPE VARCHAR(2),
@BOOOKTYPE VARCHAR(3)
AS
/*
GET_OFFLINE_VOUCHER_EDIT_DATA '74,75,76', 'NSE', 'CAPITAL', '090902447203', '2', '01'
SELECT * FROM v2_offline_ledger_entries WHERE voucherno = '090901651017' FLDAUTO = 241 ORDER BY FLDAUTO DESC
SELECT * FROM v2_offline_CC_entries WHERE VOLE_REFNO in  (74,75,76) ORDER BY FLDAUTO DESC
*/
BEGIN	
	SET NOCOUNT ON;

	CREATE TABLE #ENTRIES(
	[VDATE] [VARCHAR](11) NULL,
	[EDATE] [VARCHAR](11) NULL,
	[CLTCODE] [varchar](10) NULL,
	[CREDITAMT] [money] NULL,
	[DEBITAMT] [money] NULL,
	[OPPCODE] [varchar](10) NULL,
	[NARRATION] [varchar](255) NULL,
	[VOUCHERNO] [varchar](12) NULL,
	[VOUCHERTYPE] [smallint] NULL,
	[BOOKTYPE] [varchar](2) NULL,
	[SNO] [int] NULL,
	[BRANCHCODE] [varchar](10) NULL,
	[MARGINCODE] [varchar](10) NULL,
	[DDNO] [varchar](50) NULL,
	[CHEQUEMODE] [varchar](1) NULL,
	[CHEQUEDATE] [VARCHAR](11) NULL,
	[CHEQUENAME] [varchar](50) NULL,
	[CLEAR_MODE] [varchar](1) NULL,
	[TPACCOUNTNUMBER] [varchar](20) NULL,
	[EXCHANGE] [varchar](3) NULL,
	[SEGMENT] [varchar](20) NULL,
	[TPFLAG] [tinyint] NULL,
	[CLIENTNAME] [varchar](100) NULL,
	[OPPCODENAME] [varchar](100) NULL,
	[MARGINCODENAME] [varchar](100) NULL,
	[REVAMT] [money] NULL,
	[REVCODE] [varchar](10) NULL,
	COSTCENTERDATA VARCHAR(8000),
	[MICR] [varchar](9) NULL,
	[DISPLAY_FLAG] [bit] NULL,
	BRANCHBREAKUPDATA VARCHAR(8000),
	[FLDAUTO] [int]  NOT NULL,
	[BANKNAME] [varchar](50) NULL,
	[BRANCHNAME] [varchar](20) NULL,
--	[ADDDT] [datetime] NULL,
--	[ADDBY] [varchar](25) NULL,
--	[STATUSID] [varchar](25) NULL,
--	[STATUSNAME] [varchar](25) NULL,
	[ROWSTATE] [tinyint] NULL,
	[APPROVALFLAG] [tinyint] NULL,
--	[APPROVALDATE] [datetime] NULL,
--	[APPROVEDBY] [varchar](25) NULL,
--	[UPLOADDT] [datetime] NULL,
--	[LEDGERVNO] [varchar](12) NULL,
--	[SETT_NO] [varchar](7) NULL,
--	[SETT_TYPE] [varchar](3) NULL,
--	[PRODUCTTYPE] [varchar](3) NULL,
)
DECLARE @SQL VARCHAR(MAX)	
/*
SELECT VDATE=CONVERT(VARCHAR,VDATE,103), EDATE=CONVERT(VARCHAR,EDATE,103), CLTCODE, CREDITAMT,DEBITAMT,OPPCODE from V2_OFFLINE_LEDGER_ENTRIES
where 
*/
SET @SQL = "SELECT VDATE=CONVERT(VARCHAR,VDATE,103), EDATE=CONVERT(VARCHAR,EDATE,103), CLTCODE, CREDITAMT,DEBITAMT,OPPCODE, "
SET @SQL = @SQL + "	NARRATION, VOUCHERNO,VOUCHERTYPE,BOOKTYPE,SNO,BRANCHCODE,MARGINCODE,DDNO,CHEQUEMODE, "
SET @SQL = @SQL + "	CHEQUEDATE=CONVERT(VARCHAR,CHEQUEDATE,103), CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER, "
SET @SQL = @SQL + "	EXCHANGE,SEGMENT,TPFLAG,CLIENTNAME,OPPCODENAME,MARGINCODENAME,REVAMT,REVCODE, "
SET @SQL = @SQL + "	'',MICR, DISPLAY_FLAG, "
SET @SQL = @SQL + "	'', FLDAUTO, BANKNAME,BRANCHNAME,ROWSTATE,APPROVALFLAG "
SET @SQL = @SQL + "	FROM V2_OFFLINE_LEDGER_ENTRIES WHERE "
SET @SQL = @SQL + "	FLDAUTO IN ('" + REPLACE(@FLDAUTO, ",", "','") + "') AND FLDAUTO <>'' and "
SET @SQL = @SQL + "	 exchange = '" + @EXCHANGE + "' and segment = '" + @SEGMENT + "' " 
SET @SQL = @SQL + "	and voucherno = '" + @VNO + "' and vouchertype = '" + @VTYPE + "'"
SET @SQL = @SQL + "	and booktype = '" + @BOOOKTYPE + "'"

--EXEC(@SQL)

INSERT INTO #ENTRIES (VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,OPPCODE,
	NARRATION,VOUCHERNO,VOUCHERTYPE,BOOKTYPE,SNO,BRANCHCODE,MARGINCODE,DDNO,CHEQUEMODE,
	CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,
	EXCHANGE,SEGMENT,TPFLAG,CLIENTNAME,OPPCODENAME,MARGINCODENAME,REVAMT,REVCODE,
	COSTCENTERDATA,MICR,DISPLAY_FLAG,
	BRANCHBREAKUPDATA,FLDAUTO,BANKNAME,BRANCHNAME,ROWSTATE,APPROVALFLAG)
EXEC(@SQL)

--SELECT * FROM #ENTRIES

DECLARE @DATACURSOR CURSOR,
	@FLDSRNO INT,
	@CLTCODE_EN VARCHAR(10),
	@BRANCH_EN VARCHAR(10),
	@CATCURSOR CURSOR,
	@CATCODE VARCHAR(35),
	@COSTCODE VARCHAR(35),
	@AMT MONEY,
	@COSTDATA VARCHAR(8000),
	@BRANCHDATA VARCHAR(8000)

SET @BRANCHDATA = ''
SET @COSTDATA = ''

SET @DATACURSOR = CURSOR FOR SELECT DISTINCT FLDAUTO , CLTCODE, BRANCHCODE FROM #ENTRIES
OPEN @DATACURSOR
FETCH NEXT FROM @DATACURSOR INTO @FLDSRNO, @CLTCODE_EN, @BRANCH_EN
	WHILE @@FETCH_STATUS = 0
		BEGIN
			SET @CATCURSOR = CURSOR FOR SELECT UPPER(LTRIM(RTRIM(CATCODE))) CATCODE, COSTCODE, CREDITAMT + DEBITAMT AMT 
										FROM V2_OFFLINE_CC_ENTRIES
										WHERE VOLE_REFNO =  @FLDSRNO
											AND CLTCODE = @CLTCODE_EN
											AND BRANCHCODE = @BRANCH_EN
			OPEN @CATCURSOR
			FETCH NEXT FROM @CATCURSOR INTO @CATCODE, @COSTCODE, @AMT
			WHILE @@FETCH_STATUS = 0
				BEGIN
				IF @CATCODE = 'BRANCH'
					BEGIN
						SET @BRANCHDATA = @BRANCHDATA + '0|' + @CATCODE + '|' + @COSTCODE +  '|' + CONVERT(VARCHAR,@AMT) + '|0~'
	PRINT @BRANCHDATA
					END
				ELSE
					BEGIN
						SET @COSTDATA = @COSTDATA + '0|' + @CATCODE + '|' + @COSTCODE +  '|' + CONVERT(VARCHAR,@AMT) + '|0~'
	PRINT @COSTDATA
					END
			
				FETCH NEXT FROM @CATCURSOR INTO @CATCODE, @COSTCODE, @AMT
				END

			UPDATE #ENTRIES
				SET COSTCENTERDATA = @COSTDATA,
					BRANCHBREAKUPDATA = @BRANCHDATA
			WHERE FLDAUTO =  @FLDSRNO
				AND CLTCODE = @CLTCODE_EN
				AND BRANCHCODE = @BRANCH_EN
			SET @BRANCHDATA = ''
			SET @COSTDATA = ''

			FETCH NEXT FROM @DATACURSOR INTO @FLDSRNO, @CLTCODE_EN, @BRANCH_EN
		END


SELECT * FROM #ENTRIES
--SELECT UPPER(CATCODE) CATCODE, COSTCODE , CC.CREDITAMT + CC.DEBITAMT AMT FROM V2_OFFLINE_CC_ENTRIES CC, #ENTRIES EN
--WHERE VOLE_REFNO =  EN.FLDAUTO
--AND CC.CLTCODE = EN.CLTCODE
--AND CC.BRANCHCODE = EN.BRANCHCODE
		

DROP TABLE #ENTRIES
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_OFFLINE_VOUCHER_EDIT_DATA_BAK_29102018
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_OFFLINE_VOUCHER_LISTING
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_PARAMETER_DETAILS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GET_PARAMETER_DETAILS]  
AS  
SELECT 
SDT=CONVERT(VARCHAR,SDTCUR,103),
LDT=CONVERT(VARCHAR,LDTCUR,103),
EDTPY=CONVERT(VARCHAR,LDTPRV,103),
SDTNY=CONVERT(VARCHAR,SDTNXT,103),
CURYEAR,VNOFLAG,MATCH_BTOB,
MATCH_CTOC,MAKER_CHECKER,
VOUCHERPRINTFLAG,BRANCHFLAG,
FLDAUTO,REPORTDAYS,
(CONVERT(VARCHAR,SDTCUR,103) + '----' + CONVERT(VARCHAR,LDTCUR,103)) as FINANCIAL_YEAR ,
 (CONVERT(VARCHAR,SDTCUR,103) + ';' + CONVERT(VARCHAR,LDTCUR,103)) as FINANCIAL_YEAR_VAL
FROM 
PARAMETER 
ORDER BY 
SDT
DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_VOUCHER_APPR_EDIT_DATA
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[GET_VOUCHER_APPR_EDIT_DATA]      
 @VDATEFR VARCHAR(11),      
 @VDATETO VARCHAR(11),      
 @VTYPE VARCHAR(100),      
 @USERCATEGORY VARCHAR(10),--@MKCKFLAG TINYINT,      
 @EXCSEGMENT VARCHAR(40),      
 @FVNO UDTVNO,      
 @TVNO UDTVNO,      
 @UA VARCHAR(2),      
 @VAMT MONEY,      
 @THIRDPARTY VARCHAR(10),      
 @CLTCODE UDTPARTYCODE,      
 @OPPCODE UDTPARTYCODE,      
 @FILTERON VARCHAR(30),      
 @ADDBY VARCHAR(30),      
 @UNAME VARCHAR(30),      
 @QUICKEDIT VARCHAR(1),      
 @STATUSID VARCHAR(30),      
 @STATUSNAME VARCHAR(30)      
AS      
/*      
      
EXEC GET_VOUCHER_APPR_EDIT_DATA '01/02/2010', '05/03/2010', '2', '1', 'NSE-MFSS', '200900000129', '200900000130', 'A', '', 'ALL', '', '', '', '', 'DEMO', 'Y', 'broker', 'broker'      
GET_VOUCHER_APPR_EDIT_DATA @VDATEFR = '01/10/2007', @VDATETO = '31/03/2010', @VTYPE='', @UNAME='MEGHA', @STATUSID='BROKER', @STATUSNAME='BROKER',      
 @USERCATEGORY = 388, @EXCSEGMENT = 'NSE-CAPITAL', @FVNO = '', @TVNO = '', @UA = 'UA', @VAMT = '', @THIRDPARTY = 'ALL', @CLTCODE = '', @OPPCODE = '',      
 @FILTERON = '', @ADDBY = ''       
*/      
BEGIN       
 SET NOCOUNT ON;      
      
 DECLARE @EXCHANGE UDTEXCHANGE,      
   @SEGMENT UDTSEGMENT       
      
 SET @VDATEFR = .DBO.CONVERTDATEFORMAT(@VDATEFR, '109')      
 SET @VDATETO = .DBO.CONVERTDATEFORMAT(@VDATETO, '109')      
      
 SET @EXCHANGE = .DBO.PIECE(@EXCSEGMENT, '-', 1)      
 SET @SEGMENT = .DBO.PIECE(@EXCSEGMENT, '-', 2)      
 IF @FVNO = '' OR @FVNO = 'ALL' OR @FVNO = '%'      
  BEGIN      
   SET @FVNO = '0'      
  END      
 IF @TVNO = '' OR @TVNO = 'ALL' OR @TVNO = '%'      
  BEGIN      
   SET @TVNO = '999999999999'      
  END      
 CREATE TABLE #VTYPES      
 (      
  SNO INT      
 )      
 EXEC MAKE_UDT_STRUCTURE      
  '#VTYPES',      
  'VTYPE|MKCKFLAG|END_DATE_ADD|START_DATE_EDIT|END_DATE_EDIT',      
  'UDTVTYPE|TINYINT|INT|INT|INT',      
  '',      
  ''      
 ALTER TABLE #VTYPES DROP COLUMN SNO      
-- CREATE TABLE #VTYPES      
-- (VTYPE UDTVTYPE,      
-- MKCKFLAG TINYINT,      
-- END_DATE_ADD INT)      
      
 INSERT INTO #VTYPES(VTYPE, MKCKFLAG, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT)      
 SELECT DISTINCT VTYPE , MKCKFLAG, END_DATE_ADD, START_DATE_EDIT, END_DATE_EDIT      
 FROM  FN_USERRIGHTS(@VTYPE, '01', @EXCHANGE, @SEGMENT, @UNAME, @USERCATEGORY)      
      
 --SELECT * FROM .DBO.FN_USERRIGHTS(2, '', 'NSE', 'MFSS', 'DEMO', 1)      
 --select * from #VTYPES    
 --return     
 DECLARE @VOUHCERSETTING INT,      
   @LOOKUPARRAY VARCHAR(50),      
   @LOOPID INT,      
   @LOOPCOUNT INT,      
   @BEFORE_EDIT INT,--BIT,      
   @BEFORE_DELETE INT,--BIT,      
   @AFTER_EDIT INT,--BIT,      
  @AFTER_DELETE INT--BIT      
      
 SET @BEFORE_EDIT = 0      
 SET @BEFORE_DELETE = 0      
 SET @AFTER_EDIT = 0      
 SET @AFTER_DELETE = 0      
      
 SET @LOOKUPARRAY = '1,2,4,6,7,8'      
      
 SELECT @LOOPCOUNT = COUNT(1) FROM .dbo.SPLIT(@LookUpArray, ',')      
 SELECT @VOUHCERSETTING = OPFLAG FROM OFFLINE_VOUCHER_SETTING      
 SET @LOOPID = @LOOPCOUNT      
       
 WHILE 1=1      
  BEGIN      
   IF @LOOPID < 0      
    BEGIN      
     BREAK      
    END      
   IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT      
    BEGIN      
     SET @AFTER_DELETE = 1      
     SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))      
    END      
   ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 1      
    BEGIN      
     SET @AFTER_EDIT = 1      
     SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))      
    END      
   ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 2      
    BEGIN      
     SET @BEFORE_DELETE = 1      
     SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))      
    END      
   ELSE IF CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID)) <= @VOUHCERSETTING AND @LOOPID = @LOOPCOUNT - 3      
    BEGIN      
     SET @BEFORE_EDIT = 1      
     SET @VOUHCERSETTING = @VOUHCERSETTING - CONVERT(INT,.DBO.PIECE(@LOOKUPARRAY, ',', @LOOPID))      
    END        
   SET @LOOPID = @LOOPID - 1        
  END      
 IF @QUICKEDIT <> 'Y'      
  BEGIN      
   PRINT 'Y'  
   print @AFTER_EDIT
   print @BEFORE_EDIT    
   SELECT FLDAUTO, A.EXCHANGE + '-' + A.SEGMENT AS EXCSEGMENT, A.VOUCHERNO, A.VOUCHERTYPE, A.BOOKTYPE,      
     CLTCODE = CLTCODE,      
     OPPCODE = ISNULL(OPPCODE, ''),       
     MARGINCODE = MARGINCODE,      
     CONVERT(VARCHAR,A.VDATE,103) AS VDATE, VDATE1 = CONVERT(VARCHAR,A.VDATE,111),      
     A.DDNO, SNO=A.SNO, V.VDESC, ISNULL(A.LEDGERVNO,'') AS LEDGERVNO,      
     DEBITAMT,      
     CREDITAMT,      
     ISNULL(A.TPFLAG,0) AS THIRDPARTY, TPAccountNumber,BankName,      
     ADDDT = CONVERT(VARCHAR(11),A.ADDDT,103),      
     END_DATE_ADD = DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)),      
     DISPLAY_FLAG,      
     VT.MKCKFLAG,      
     A.ROWSTATE, A.APPROVALFLAG,      
     EDIT = CASE WHEN VT.MKCKFLAG <> 1 AND (A.VOUCHERTYPE <> 16 OR A.VOUCHERTYPE <> 17) --AND ((A.VOUCHERTYPE <> 2 OR A.VOUCHERTYPE <> 3) AND A.REVCODE = '' AND A.ROWSTATE <> 99)      
         AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN      
        CASE WHEN ROWSTATE = 1 AND APPROVALFLAG = 3 THEN 0      
        ELSE      
         CASE  WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0      
         ELSE           
          CASE WHEN ROWSTATE = 1 THEN @AFTER_EDIT      
          ELSE @BEFORE_EDIT END      
         END      
        END      
       ELSE 0      
       END,      
           
     APPROVE = CASE WHEN VT.MKCKFLAG <> 1 AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN       
         CASE WHEN A.VOUCHERTYPE IN (16, 17) AND ROWSTATE = 0 AND APPROVALFLAG = 0 AND @UA = 'UA' THEN 1      
           WHEN @UA = 'UA' AND ROWSTATE = 0 and A.VOUCHERTYPE NOT IN (16, 17)THEN 1 ELSE 0 END      
        ELSE 0      
        END,      
     DELET = CASE WHEN  VT.MKCKFLAG <> 1 AND APPROVALFLAG <> 3  and  (ROWSTATE <> 0 or ROWSTATE <> 1)--ROWSTATE NOT IN (0,1)       
         AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN      
        CASE WHEN  A.VOUCHERTYPE IN (16, 17) AND ROWSTATE = 0 AND APPROVALFLAG = 0 THEN             
                
         (CASE WHEN ROWSTATE = 1 THEN @AFTER_DELETE      
          ELSE @BEFORE_DELETE END)      
              
          WHEN  A.VOUCHERTYPE NOT IN (16, 17) THEN      
         (CASE WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0       
          WHEN ROWSTATE = 1 THEN @AFTER_DELETE      
          ELSE @BEFORE_DELETE END) ELSE 0 END      
       ELSE 0       
       END,      
     REJECT = CASE WHEN  VT.MKCKFLAG <> 1 AND  ROWSTATE <> 1 AND APPROVALFLAG <> 3      
         AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN      
         CASE WHEN  A.VOUCHERTYPE IN (16, 17) AND APPROVALFLAG = 1 OR APPROVALFLAG = 0 THEN 1      
           WHEN A.VOUCHERTYPE NOT IN (16, 17) THEN       
           CASE WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0       
           ELSE 1 END      
           ELSE 0 END      
       ELSE 0      
       END      
            
     FROM V2_OFFLINE_LEDGER_ENTRIES A, #VTYPES VT, VMAST V       
     WHERE      
      V.VTYPE = VT.VTYPE      
      AND A.VOUCHERTYPE = V.VTYPE      
      AND A.ADDBY = CASE WHEN VT.MKCKFLAG =  1 THEN @UNAME ELSE A.ADDBY END      
      AND A.BRANCHCODE = CASE WHEN @STATUSID = 'BROKER' THEN A.BRANCHCODE ELSE RTRIM(LTRIM(@STATUSNAME)) END          
      AND (A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 0 ELSE 1 END OR           
       A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 2 ELSE 1 END OR      
       A.APPROVALFLAG = 3) -- UNAPPROVED SELECTED      
      --AND A.APPROVALFLAG <> CASE WHEN A.ROWSTATE = 1 THEN 3  END-- SHOULD NOT DISPLAY POSTED-DELETED      
    --AND A.ROWSTATE <> 99-- = 0      
      AND A.ROWSTATE = CASE WHEN @UA = 'UA' THEN 0 ELSE A.ROWSTATE END--1      
      AND A.CREDITAMT + A.DEBITAMT  = CASE WHEN @VAMT = '' THEN A.CREDITAMT + A.DEBITAMT ELSE @VAMT END          
      AND A.EXCHANGE+'-'+A.SEGMENT = @EXCSEGMENT      
      AND A.VOUCHERNO BETWEEN (CASE WHEN A.ROWSTATE = 0 THEN @FVNO ELSE '0' END) AND (CASE WHEN A.ROWSTATE = 0 THEN @TVNO ELSE '999999999999' END)      
      AND A.LEDGERVNO BETWEEN (CASE WHEN A.ROWSTATE <> 0 THEN @FVNO ELSE '' END) AND (CASE WHEN A.ROWSTATE <> 0 THEN @TVNO ELSE '999999999999' END)      
      /*AND A.VOUCHERNO >= CASE WHEN @FVNO = '' OR @FVNO = 'ALL' OR @FVNO = '%' THEN '0' ELSE @FVNO END      
      AND A.VOUCHERNO <= CASE WHEN @TVNO = '' OR @TVNO = 'ALL' OR @TVNO ='%' THEN 'ZZZZZZZZZZZZ' ELSE @TVNO END*/      
      AND A.ADDDT BETWEEN @VDATEFR AND @VDATETO + ' 23:59'       
      AND ISNULL(A.TPFLAG,0) = CASE WHEN @THIRDPARTY = 'ALL' THEN ISNULL(A.TPFLAG,0) ELSE @THIRDPARTY END      
      AND A.CLTCODE = CASE WHEN @CLTCODE = '' OR @CLTCODE = 'ALL' OR @CLTCODE = '%' THEN A.CLTCODE ELSE @CLTCODE END      
      AND ISNULL(A.OPPCODE, '') = CASE WHEN @OPPCODE = '' OR @OPPCODE = 'ALL' OR @OPPCODE = '%' THEN ISNULL(A.OPPCODE, '') ELSE @OPPCODE END      
      AND A.STATUSNAME = CASE WHEN @FILTERON = '' OR @FILTERON = 'ALL' OR @FILTERON = '%' THEN A.STATUSNAME ELSE @FILTERON END      
      AND A.ADDBY = CASE WHEN @ADDBY = '' OR @ADDBY = 'ALL' OR @ADDBY = '%' THEN A.ADDBY ELSE @ADDBY END      
     ORDER BY VOUCHERNO, FLDAUTO      
  END      
 ELSE      
  BEGIN      
   PRINT 'N'      
   SELECT DISTINCT      
    EXCSEGMENT = @EXCSEGMENT,      
    A.VOUCHERNO,      
    A.VOUCHERTYPE,      
    A.BOOKTYPE,      
    VDATE = CONVERT(VARCHAR(10), VDATE, 103),      
    VDATE1 = CONVERT(VARCHAR(10), VDATE, 111),      
    EDATE = CONVERT(VARCHAR(10), EDATE, 103),      
    EDATE1 = CONVERT(VARCHAR(10), EDATE, 111),      
    ENTRYAMT = 0,      
    DISPLAYFLAG = ISNULL(A.DISPLAY_FLAG, 1),      
    VT.MKCKFLAG,      
    A.ROWSTATE,      
    A.APPROVALFLAG,      
    A.LEDGERVNO,      
    DDNO = ISNULL(A.DDNO, ''),      
    CHEQUEMODE = ISNULL(A.CHEQUEMODE, ''),      
    CHEQUEDATE = CASE WHEN A.CHEQUEDATE IS NULL THEN '' ELSE CONVERT(VARCHAR(10), A.CHEQUEDATE, 103) END,      
    CHEQUENAME = ISNULL(A.CHEQUENAME, ''),      
    CLEAR_MODE = ISNULL(A.CLEAR_MODE, ''),      
    EDIT = CASE WHEN VT.MKCKFLAG <> 1 AND (A.VOUCHERTYPE <> 16 OR A.VOUCHERTYPE <> 17) --AND ((A.VOUCHERTYPE <> 2 OR A.VOUCHERTYPE <> 3) AND A.REVCODE = '' AND A.ROWSTATE <> 99)      
         AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN      
        CASE WHEN ROWSTATE = 1 AND APPROVALFLAG = 3 THEN 0      
        ELSE      
         CASE  WHEN (A.VOUCHERTYPE = 2 OR A.VOUCHERTYPE = 3) AND A.REVCODE <> '' AND A.ROWSTATE = 99 THEN 0      
         ELSE           
          CASE WHEN ROWSTATE = 1 THEN @AFTER_EDIT      
          ELSE @BEFORE_EDIT END      
         END      
        END      
       ELSE 0      
       END,      
    APPROVE = CASE WHEN VT.MKCKFLAG <> 1 AND DATEDIFF(DAY, CONVERT(DATETIME,A.VDATE,103), CONVERT(DATETIME,CONVERT(DATETIME,CONVERT(VARCHAR(8), VT.END_DATE_ADD)), 103)) >= 0 THEN       
        CASE WHEN A.VOUCHERTYPE IN (16, 17) AND ROWSTATE = 0 AND APPROVALFLAG = 0 AND @UA = 'UA' THEN 1      
          WHEN @UA = 'UA' AND ROWSTATE = 0 and A.VOUCHERTYPE NOT IN (16, 17)THEN 1 ELSE 0 END      
       ELSE 0      
       END,      
    DELET = 0,      
    REJECT = 0,      
    ENTRYIDF = VOUCHERNO + ISNULL(RESERVED2, '1')      
   FROM   
    V2_OFFLINE_LEDGER_ENTRIES A,      
    #VTYPES VT,      
    VMAST V      
   WHERE      
    V.VTYPE = VT.VTYPE      
    AND A.VOUCHERTYPE = V.VTYPE      
    AND A.ADDBY = CASE WHEN VT.MKCKFLAG =  1 THEN @UNAME ELSE A.ADDBY END      
    AND A.BRANCHCODE = CASE WHEN @STATUSID = 'BROKER' THEN A.BRANCHCODE ELSE RTRIM(LTRIM(@STATUSNAME)) END          
    AND (A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 0 ELSE 1 END OR           
     A.APPROVALFLAG = CASE WHEN @UA = 'UA' THEN 2 ELSE 1 END OR      
     A.APPROVALFLAG = 3)      
    AND A.ROWSTATE = CASE WHEN @UA = 'UA' THEN 0 ELSE A.ROWSTATE END      
    --AND A.ROWSTATE <> 99      
    AND A.CREDITAMT + A.DEBITAMT  = CASE WHEN @VAMT = '' THEN A.CREDITAMT + A.DEBITAMT ELSE @VAMT END          
    AND A.EXCHANGE+'-'+A.SEGMENT = @EXCSEGMENT      
    AND A.VOUCHERNO BETWEEN (CASE WHEN A.ROWSTATE = 0 THEN @FVNO ELSE '0' END) AND (CASE WHEN A.ROWSTATE = 0 THEN @TVNO ELSE '999999999999' END)      
    AND A.LEDGERVNO BETWEEN (CASE WHEN A.ROWSTATE <> 0 THEN @FVNO ELSE '' END) AND (CASE WHEN A.ROWSTATE <> 0 THEN @TVNO ELSE '999999999999' END)      
    AND A.ADDDT BETWEEN @VDATEFR AND @VDATETO + ' 23:59'      
    AND ISNULL(A.TPFLAG,0) = CASE WHEN @THIRDPARTY = 'ALL' THEN ISNULL(A.TPFLAG,0) ELSE @THIRDPARTY END      
    AND A.CLTCODE = CASE WHEN @CLTCODE = '' OR @CLTCODE = 'ALL' OR @CLTCODE = '%' THEN A.CLTCODE ELSE @CLTCODE END      
    AND ISNULL(A.OPPCODE, '') = CASE WHEN @OPPCODE = '' OR @OPPCODE = 'ALL' OR @OPPCODE = '%' THEN ISNULL(A.OPPCODE, '') ELSE @OPPCODE END      
    AND A.STATUSNAME = CASE WHEN @FILTERON = '' OR @FILTERON = 'ALL' OR @FILTERON = '%' THEN A.STATUSNAME ELSE @FILTERON END      
    AND A.ADDBY = CASE WHEN @ADDBY = '' OR @ADDBY = 'ALL' OR @ADDBY = '%' THEN A.ADDBY ELSE @ADDBY END      
    AND A.VDATE BETWEEN (CONVERT(DATETIME, CONVERT(VARCHAR(8), VT.START_DATE_EDIT), 112)) AND (CONVERT(DATETIME, CONVERT(VARCHAR(8), VT.END_DATE_EDIT), 112))      
    AND A.VOUCHERTYPE IN (1, 2, 3, 4, 5, 6, 7, 8, 19, 20, 22, 23, 24)      
   ORDER BY      
    VOUCHERNO      
  END      
         
 DROP TABLE #VTYPES      
      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_VOUCHERTYPE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GET_VOUCHERTYPE]
AS
SELECT VDESC,VTYPE FROM VMAST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETBILLDATASUM_NEW
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetCltcode
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETREMVTYPES
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETUSERCATEGORY
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETUSERRIGHTS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IMPORTFILE
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MAKE_UDT_STRUCTURE
-- --------------------------------------------------


CREATE PROC [dbo].[MAKE_UDT_STRUCTURE]
(
	@TABLENAME VARCHAR(256),
	@FIELDLIST VARCHAR(MAX),
	@FIELDTYPE VARCHAR(MAX),
	@FIELDLENS VARCHAR(500),
	@NULLVALUE VARCHAR(100)
)
AS
/*
	SET NOCOUNT ON
	CREATE TABLE #BILLDETAILS (SRNO INT IDENTITY(1,1))
	SELECT * FROM #BILLDETAILS
	EXEC MAKE_UDT_STRUCTURE '#BILLDETAILS', 'VNO|VTYPE|BOOKTYPE|VDT', 'UDTVNO|NUMERIC|UDTBOOKTYPE|DATETIME', '|10,4||', ''
	SELECT * FROM #BILLDETAILS
	DROP TABLE #BILLDETAILS
*/
SET NOCOUNT ON
DECLARE
	@SCRIPT VARCHAR(MAX),
	@FLDNAME VARCHAR(256),
	@UDTNAME VARCHAR(256),
	@TYPENAME VARCHAR(256),
	@MAX_LENGTH SMALLINT,
	@PRECISION TINYINT,
	@SCALE TINYINT,
	@IS_NULLABLE BIT,
	@IS_USER_DEFINED BIT,
	@POSITION INT

SET @POSITION = 1
IF LEN(LTRIM(RTRIM(@TABLENAME))) <= 0
	BEGIN
		RETURN
	END
IF LEN(LTRIM(RTRIM(@FIELDLIST))) <= 0
	BEGIN
		RETURN
	END
SET @SCRIPT = 'ALTER TABLE ' + @TABLENAME + ' ADD '
WHILE 1 = 1
	BEGIN
		SET @UDTNAME = .dbo.PIECE(@FIELDTYPE, '|', @POSITION)
		SET @FLDNAME = .dbo.PIECE(@FIELDLIST, '|', @POSITION)
		IF @UDTNAME IS NULL OR @UDTNAME = ''
			BEGIN
				BREAK
			END
		SELECT
			@TYPENAME = SYSTEMNAME,
			@MAX_LENGTH = MAX_LENGTH,
			@PRECISION = XPRECISION,
			@SCALE = XSCALE,
			@IS_NULLABLE = IS_NULLABLE,
			@IS_USER_DEFINED = IS_USER_DEFINED
		FROM
			.DBO.GETBASETYPE(@UDTNAME)
		IF @TYPENAME = 'VARCHAR' OR @TYPENAME = 'CHAR' OR @TYPENAME = 'NCHAR' OR @TYPENAME = 'NVARCHAR'
			BEGIN
				IF @IS_USER_DEFINED = 0
					BEGIN
						SET @SCRIPT = @SCRIPT + @FLDNAME + ' ' + @TYPENAME + '(' + .dbo.PIECE(@FIELDLENS, '|', @POSITION) + ')'
					END
				ELSE
					BEGIN
						SET @SCRIPT = @SCRIPT + @FLDNAME + ' ' + @TYPENAME + '(' + CONVERT(VARCHAR, @MAX_LENGTH) + ')'
					END
			END
		ELSE IF @TYPENAME = 'NUMERIC' OR @TYPENAME = 'DECIMAL'
			BEGIN
				IF @IS_USER_DEFINED = 0
					BEGIN
						SET @SCRIPT = @SCRIPT + @FLDNAME + ' ' + @TYPENAME + '(' + .dbo.PIECE(@FIELDLENS, '|', @POSITION) + ')'
					END
				ELSE
					BEGIN
						SET @SCRIPT = @SCRIPT + @FLDNAME + ' ' + @TYPENAME + '(' + (CONVERT(VARCHAR, @PRECISION) + ',' + CONVERT(VARCHAR, @SCALE)) + ')'
					END
			END
		ELSE IF @TYPENAME = 'IMAGE' OR @TYPENAME = 'TEXT' OR @TYPENAME = 'TINYINT' OR @TYPENAME = 'SMALLINT' OR @TYPENAME = 'INT' OR @TYPENAME = 'SMALLDATETIME' OR @TYPENAME = 'MONEY' OR @TYPENAME = 'FLOAT' OR @TYPENAME = 'NTEXT' OR @TYPENAME = 'BIT' OR @TYPENAME = 'BIGINT' OR @TYPENAME = 'DATETIME'
			BEGIN
				SET @SCRIPT = @SCRIPT + @FLDNAME + ' ' + @TYPENAME
			END
		SET @IS_NULLABLE = .dbo.PIECE(@NULLVALUE, '|', @POSITION)
		IF @IS_NULLABLE = 0 OR @IS_NULLABLE IS NULL
			BEGIN
				SET @SCRIPT = @SCRIPT + ' NULL'
			END
		ELSE
			BEGIN
				SET @SCRIPT = @SCRIPT + ' NOT NULL'
			END
		SET @POSITION = @POSITION + 1
		IF .dbo.PIECE(@FIELDLIST, '|', @POSITION) IS NOT NULL OR .dbo.PIECE(@FIELDLIST, '|', @POSITION) <> ''
			BEGIN
				SET @SCRIPT = @SCRIPT + ','
			END
	END
	PRINT 'RRR'
PRINT @SCRIPT
EXEC(@SCRIPT)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MF_BANK_ADDTIONAL
-- --------------------------------------------------
CREATE PROC [dbo].[MF_BANK_ADDTIONAL]  
( @PARTY_CODE VARCHAR(10),  
  @BANK_NAME VARCHAR(50),  
  @BRANCH_NAME VARCHAR(50),  
  @ACCNO VARCHAR(50), @ACC_TYPE  VARCHAR(7),@IS_DEFALUT VARCHAR(1),  
  @IFSC_CODE VARCHAR(12))  
AS   
  ---exec    MF_BANK_ADDTIONAL 'V70081','STATE BANK OF INDIA','STATE BANK OF INDIA','20059679834','SAVING','0','SBIN0012124'
     
 DECLARE @CNT INT,@ACCT_STATUS INT  ,@AC_STATUS INT,@bankcode VARCHAR(15),@LONG_NAME VARCHAR(50)  
  
 SELECT @AC_STATUS=COUNT(*) FROM BSEMFSS.DBO.MFSS_CLIENT WHERE PARTY_CODE=@PARTY_CODE  
  SELECT @LONG_NAME=PARTY_NAME FROM BSEMFSS.DBO.MFSS_CLIENT WHERE PARTY_CODE=@PARTY_CODE  
  
  IF @AC_STATUS =0  
    BEGIN   
    Select ACC_STATUS='Account Not Available'  
    Return  
 ENd      
  
    
  SELECT @CNT =COUNT(*) FROM  BSEMFSS.DBO.POBANK    
  WHERE BANK_NAME =@BANK_NAME AND BRANCH_NAME =@BRANCH_NAME  
  
  IF @CNT =0  
   BEGIN   
  
     INSERT INTO BSEMFSS.DBO.POBANK   VALUES (@BANK_NAME,@BRANCH_NAME,'','','','','INDIA','','','','','',@IFSC_CODE)  
  
   END   
 ELSE 
  BEGIN 
   UPDATE P SET  IFSCCODE=@IFSC_CODE   FROM BSEMFSS.DBO.POBANK  P WHERE BANK_NAME=@BANK_NAME AND BRANCH_NAME =@BRANCH_NAME AND ISNULL(IFSCCODE,'') =''
 
  END 

 
        
 SELECT @ACCT_STATUS =COUNT(*) FROM (   
  
  SELECT  CLTCODE FROM MULTIBANKID  WHERE CLTCODE =@PARTY_CODE AND ACCNO = @ACCNO   AND BANKID <>0
  UNION   
  SELECT   CLTCODE FROM Multibankid_Other  WHERE CLTCODE =@PARTY_CODE AND ACCNO = @ACCNO AND BANKID <>0 )A   
  
  IF @ACCT_STATUS >=1  
    BEGIN   
   Select  ACC_STATUS ='Account Code Already Exist'  
   Return  
    END  
  
  select @bankcode =CONVERT(VARCHAR(16),MAX(BANKID))  FROM BSEMFSS.DBO.POBANK WHERE BANK_NAME =@BANK_NAME AND BRANCH_NAME =@BRANCH_NAME  
  
  IF @IS_DEFALUT =1   
  BEGIN   
  UPDATE MULTIBANKID SET Defaultbank =0 WHERE CLTCODE =@PARTY_CODE   
  UPDATE Multibankid_Other SET Defaultbank =0 WHERE CLTCODE =@PARTY_CODE   
  
  UPDATE M SET BANK_NAME =@BANK_NAME,BANK_BRANCH=@BRANCH_NAME,ACC_NO = @ACCNO,NEFTCODE=@IFSC_CODE  FROM BSEMFSS.DBO.MFSS_CLIENT M WHERE PARTY_CODE =@PARTY_CODE   
 

  END  
  
  
  INSERT INTO Multibankid_Other VALUES (@PARTY_CODE,@bankcode,@ACCNO,@ACC_TYPE,@LONG_NAME,@IS_DEFALUT )  
   
 SELECT @CNT =COUNT(SRNO) FROM  Multibankid_Other    
    WHERE CLTCODE =@PARTY_CODE AND Accno =@ACCNO  
  
  IF @CNT > 0  
   BEGIN   
   SELECT ACCT_STATUS = @PARTY_CODE +'  Account Added Sucessfully'  
   END  
  ELSE   
   BEGIN   
    SELECT ACCT_STATUS = @PARTY_CODE +'  Account Not Added'  
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MF_PHY_CLIENT_BAL
-- --------------------------------------------------

 CREATE PROC [dbo].[MF_PHY_CLIENT_BAL]
 (@DATE DATETIME ,@FROMPARTY VARCHAR(10),@TOPARY VARCHAR(10) )
 AS 
 --DECLARE @FROMDATE DATETIME,@DATE DATETIME
 --SET @FROMDATE ='2017-04-01'   
 --SET @DATE ='2017-10-26'

SELECT Party_Code,
PARTY_NAME ,
Region,
BRANCH_CD ,
SUB_BROKER ,BANK_NAME,ACC_NO,NEFTCODE INTO #CL  FROM BSEMFSS.DBO.MFSS_CLIENT WHERE DP_TYPE ='PHY' 
AND PARTY_CODE NOT IN (SELECT CL_CODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS)
AND PARTY_CODE >=@FROMPARTY AND PARTY_CODE <=@TOPARY 
 
DECLARE @FROMDATE DATETIME

 SET @FROMDATE = (SELECT  SDTCUR FROM PARAMETER WHERE @DATE BETWEEN Sdtcur AND Ldtcur )  


SELECT CLTCODE,LEDBAL = SUM(DRAMOUNT-CRAMOUNT) INTO #LED FROM MFSS_LEDGER_BSE 
WHERE VDT >=@FROMDATE AND VDT <=@DATE +' 23:59' AND CLTCODE IN (SELECT Party_Code FROM #CL)
GROUP BY CLTCODE

SELECT  CLTCODE,EFFBAL = SUM(DRAMOUNT-CRAMOUNT) INTO #EFF FROM MFSS_LEDGER_BSE   
WHERE VDT >=@FROMDATE AND EDT <=@DATE +' 23:59' AND CLTCODE IN (SELECT Party_Code FROM #CL) 
GROUP BY CLTCODE
 
 
SELECT CLTCODE,UNSETTLED_BILL = SUM(DRAMOUNT-CRAMOUNT) INTO #UNSETT FROM MFSS_LEDGER_BSE   
WHERE   EDT > @DATE AND CLTCODE IN (SELECT Party_Code FROM #CL)
GROUP BY CLTCODE


SELECT CLTCODE,UNCLEARCHQ_DR = SUM(DRAMOUNT),UNCLEARCHQ_CR = SUM(CRAMOUNT) INTO #UNCLEAR
FROM ACC_TBL1 T1 , ACC_TBL3 T3 ,ACC_TBL4 T4 WHERE  T1.SNO=T3.MASTERSNO    AND T3.MASTERSNO =T4.MASTERSNO 
AND  CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) >=@FROMDATE  AND CLTCODE IN (SELECT Party_Code FROM #CL)
AND VTYPE IN (2,3)
AND CR_RELDT ='' AND DR_RELDT =''
GROUP BY CLTCODE

SELECT Party_Code,PARTY_NAME,Region,BRANCH_CD,SUB_BROKER,BANK_NAME,ACC_NO,NEFTCODE,
LEDBAL =ISNULL(LEDBAL,0)*-1,
EFFBAL =ISNULL(EFFBAL,0)*-1,
UNSETTLED_BILL =ISNULL(UNSETTLED_BILL,0),
UNCLEARCHQ_CR =ISNULL(UNCLEARCHQ_CR,0),
UNCLEARCHQ_DR =ISNULL(UNCLEARCHQ_DR,0) FROM (
SELECT C.*,LEDBAL ,EFFBAL,UNSETTLED_BILL,UNCLEARCHQ_CR,UNCLEARCHQ_DR
 FROM  #CL C
LEFT OUTER JOIN
#LED  L ON C.PARTY_CODE =L.CLTCODE 
LEFT OUTER JOIN  
#EFF E ON C.PARTY_CODE =E.CLTCODE
LEFT OUTER JOIN  
#UNSETT U ON C.PARTY_CODE =U.CLTCODE
LEFT OUTER JOIN  
#UNCLEAR UB ON C.PARTY_CODE =UB.CLTCODE )A 
WHERE ISNULL(LEDBAL,0) <>0 OR ISNULL(EFFBAL,0) <>0 OR ISNULL(UNSETTLED_BILL,0) <>0 OR ISNULL(UNCLEARCHQ_CR,0) <>0 OR ISNULL(UNCLEARCHQ_DR,0) <>0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_AUTOJV_AMOUNT
-- --------------------------------------------------



--EXEC MFSS_AUTOJV_AMOUNT 'may 24 2017', 'A109749', 'A109749', 'NIK'
CREATE PROCEDURE [dbo].[MFSS_AUTOJV_AMOUNT]
	@VDT VARCHAR(11),
	@FR_CLIENT VARCHAR(10),
	@TO_CLIENT VARCHAR(10),
	@UNAME VARCHAR(15)

AS
DECLARE
	@SDTCUR VARCHAR(11),
	@LDTCUR VARCHAR(11)
	

/*SET @VDT = 'MAR 31 2017'
SET @UNAME = 'NIK'*/

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @LDTCUR = LDTCUR FROM PARAMETER WHERE @VDT BETWEEN SDTCUR AND LDTCUR


CREATE TABLE #TRF_ENTRIES
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #TRF_ENTRIES (CLTCODE, BRANCHCODE, CLIENT_NAME, EXCHANGE, SEGMENT, AMOUNT)
SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE, BRANCHCODE, ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT - CRAMOUNT) FROM ACC_LEDGER_PL L
	WHERE EDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59'
	----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
	GROUP BY L.CLTCODE, L.BRANCHCODE, ACNAME,L.EXCHANGE, L.SEGMENT
	UNION ALL
	SELECT CLTCODE, BRANCHCODE, ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT) FROM ACC_LEDGER_PL L
	WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15
	--AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
	GROUP BY L.CLTCODE, L.BRANCHCODE, ACNAME,L.EXCHANGE, L.SEGMENT
	UNION ALL
	SELECT CLTCODE, BRANCHCODE, ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT*(-1)) FROM ACC_LEDGER_PL L
	WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15
	AND NARRATION  LIKE '%XSIP DIRECT PAYMENT%'
	GROUP BY L.CLTCODE, L.BRANCHCODE, ACNAME,L.EXCHANGE, L.SEGMENT
    UNION ALL
	SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT - DRAMOUNT) FROM ACC_LEDGER_PL
	WHERE EDT >= @SDTCUR AND VDT < @SDTCUR AND VTYPE = 15 
	----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
	GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
) A
WHERE CLTCODE BETWEEN @FR_CLIENT AND @TO_CLIENT
GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
HAVING SUM(AMOUNT) <> 0

SELECT * FROM #TRF_ENTRIES

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_AUTOJV_AMOUNT_NEW
-- --------------------------------------------------

--EXEC MFSS_AUTOJV_AMOUNT_NEW 'JUL 10 2017', 'A00', 'ZZZZZ', 'SYSTEM','D'
CREATE PROCEDURE [dbo].[MFSS_AUTOJV_AMOUNT_NEW]
	@VDT VARCHAR(11),
	@FR_CLIENT VARCHAR(10),
	@TO_CLIENT VARCHAR(10),
	@UNAME VARCHAR(15),
	@FLAG VARCHAR(1)

AS
DECLARE
	@SDTCUR VARCHAR(11),
	@LDTCUR VARCHAR(11)
	

/*SET @VDT = 'MAR 31 2017'
SET @UNAME = 'NIK'*/

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @LDTCUR = LDTCUR FROM PARAMETER WHERE @VDT BETWEEN SDTCUR AND LDTCUR


CREATE TABLE #TRF_ENTRIES
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	EQ_GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)


IF @FLAG = 'C'

	BEGIN 
		INSERT INTO #TRF_ENTRIES (CLTCODE, BRANCHCODE, CLIENT_NAME, EXCHANGE, SEGMENT, AMOUNT)
		SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMT = SUM(AMOUNT) FROM
		(
			SELECT CLTCODE,'' BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT - CRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE EDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE,'' BRANCHCODE,''  ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			--AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, ''BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT*(-1)) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			AND (NARRATION  LIKE '%XSIP DIRECT PAYMENT%' OR NARRATION  LIKE '%ISIP DIRECT PAYMENT%')
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, ''BRANCHCODE, '' ACNAME,EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT - DRAMOUNT) FROM ACC_LEDGER_PL
			WHERE EDT >= @SDTCUR AND VDT < @SDTCUR AND VTYPE = 15  AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT
		) A
		WHERE CLTCODE BETWEEN @FR_CLIENT AND @TO_CLIENT 
		AND CLTCODE NOT IN (SELECT CLTCODE FROM MFSS_JVEXCEPTION)
		GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
		HAVING SUM(AMOUNT) < 0
    END 

IF @FLAG = 'D'
	   BEGIN 
	   INSERT INTO #TRF_ENTRIES (CLTCODE, BRANCHCODE, CLIENT_NAME, EXCHANGE, SEGMENT, AMOUNT)
		SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMT = SUM(AMOUNT) FROM
		(
			SELECT CLTCODE,'' BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT - CRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE EDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE,'' BRANCHCODE,''  ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			--AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE,'' BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT*(-1)) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			AND (NARRATION  LIKE '%XSIP DIRECT PAYMENT%' OR NARRATION  LIKE '%ISIP DIRECT PAYMENT%')
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, ''BRANCHCODE, '' ACNAME,EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT - DRAMOUNT) FROM ACC_LEDGER_PL
			WHERE EDT >= @SDTCUR AND VDT < @SDTCUR AND VTYPE = 15  AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT
		) A
		WHERE CLTCODE BETWEEN @FR_CLIENT AND @TO_CLIENT 
		AND CLTCODE NOT IN (SELECT CLTCODE FROM MFSS_JVEXCEPTION)
		GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
		HAVING SUM(AMOUNT) >  0

	END 




--SELECT * FROM #TRF_ENTRIES

--UPDATE T SET  BRANCHCODE =A.Branchcode  FROM #TRF_ENTRIES T ,ACMAST A
--WHERE T.CLTCODE =A.CLTCODE AND EXCHANGE ='BSE' AND SEGMENT ='MFSS'

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'BSE' FROM ANAND.ACCOUNT_AB.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'NSE' FROM ANAND1.ACCOUNT.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'NFO' FROM ACCOUNTFO.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE T SET T.GL_ACCOUNT = G.GL_ACCOUNT, T.EQ_GL_ACCOUNT = G.EQ_GL_ACCOUNT
FROM #TRF_ENTRIES T, AUTOJV_MFSS_GLACCOUNT G
WHERE T.EXCHANGE = G.EXCHANGE AND T.SEGMENT = G.SEGMENT AND T.SR_SEGMENT = G.SR_SEGMENT

DELETE #TRF_ENTRIES WHERE ISNULL(SR_SEGMENT ,'')=''



DECLARE	
	@@VOUCHERNO VARCHAR(20)
SELECT @@VOUCHERNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)  

INSERT INTO BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES        
(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,      
BRANCHCODE, EXCHANGE, SEGMENT, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG,        
APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, CLIENTNAME, RESERVED2)         
SELECT 88, '01', 2, @VDT,@VDT,T.CLTCODE,        
CREDITAMT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE 0 END,        
DEBITAMT = CASE WHEN AMOUNT < 0 THEN ABS(AMOUNT) ELSE 0 END,        
NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END, BRANCHCODE = '', T.EXCHANGE, T.SEGMENT, ADDDT = GETDATE(), ADDBY = 'SYSTEM',       
'BROKER', 'BROKER', ROWSTATE = 0, APPROVALFLAG = 1,        
APPROVALDATE = GETDATE(), APPROVEDBY = 'SYSTEM', /*VOUCHERNO = CONVERT(VARCHAR, CONVERT(NUMERIC, @@VOUCHERNO) + SNO)*/ VOUCHERNO = @@VOUCHERNO,  
UPLOADDT = GETDATE(), ACNAME, SNO     
FROM         
#TRF_ENTRIES T, ACMAST A
WHERE T.CLTCODE = A.Cltcode AND T.EXCHANGE = A.Exchange AND T.SEGMENT = A.Segment         

        
INSERT INTO BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES        
(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,      
BRANCHCODE, EXCHANGE, SEGMENT, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG,        
APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, CLIENTNAME, RESERVED2)         
SELECT 88, '01', 1, @VDT,@VDT,GL_ACCOUNT,        
CREDITAMT = CASE WHEN AMOUNT < 0 THEN ABS(AMOUNT) ELSE 0 END,      
DEBITAMT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE 0 END,        
NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END, BRANCHCODE = '', T.EXCHANGE, T.SEGMENT, ADDDT = GETDATE(), ADDBY = 'SYSTEM',       
'BROKER', 'BROKER', ROWSTATE = 0, APPROVALFLAG = 1,        
APPROVALDATE = GETDATE(), APPROVEDBY = 'SYSTEM', /*VOUCHERNO = CONVERT(VARCHAR, CONVERT(NUMERIC, @@VOUCHERNO) + SNO)*/ VOUCHERNO = @@VOUCHERNO,        
UPLOADDT = GETDATE(), ACNAME , SNO         
FROM         
#TRF_ENTRIES T, ACMAST A
WHERE T.GL_ACCOUNT = A.Cltcode AND T.EXCHANGE = A.Exchange AND T.SEGMENT = A.Segment   


EXEC BBO_FA.DBO.FA_POSTING @@VOUCHERNO



CREATE TABLE #TRF_ENTRIES_NSE
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

CREATE TABLE #TRF_ENTRIES_BSE
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

CREATE TABLE #TRF_ENTRIES_NFO
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #TRF_ENTRIES_NSE
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'NSE'

INSERT INTO #TRF_ENTRIES_BSE
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'BSE'

INSERT INTO #TRF_ENTRIES_NFO
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'NFO'

DECLARE
	@REC_COUNT INT,
	@@LASTVNO VARCHAR(12)

SET @REC_COUNT = 0
	
SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_BSE	

	
CREATE TABLE #VNO
(
	LASTVNO VARCHAR(12)
)

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ANAND.ACCOUNT_AB.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ANAND.ACCOUNT_AB.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END,
	AMOUNT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_BSE T, ANAND.ACCOUNT_AB.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ANAND.ACCOUNT_AB.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_BSE T, ANAND.ACCOUNT_AB.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END


SET @REC_COUNT = 0
TRUNCATE TABLE #VNO

SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_NSE		

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ANAND1.ACCOUNT.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ANAND1.ACCOUNT.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END , @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NSE T,ANAND1.ACCOUNT.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ANAND1.ACCOUNT.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END,
	AMOUNT=CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NSE T, ANAND1.ACCOUNT.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END

SET @REC_COUNT = 0
TRUNCATE TABLE #VNO

SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_NFO

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ACCOUNTFO.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ACCOUNTFO.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NFO T, ACCOUNTFO.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ACCOUNTFO.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NFO T, ACCOUNTFO.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END


INSERT INTO MFSS_TRF_ENTRIES (CLTCODE,BRANCHCODE,CLIENT_NAME,EXCHANGE,SEGMENT,AMOUNT,SR_SEGMENT,GL_ACCOUNT,EQ_GL_ACCOUNT,TRANSFER_DATE,FLAG)
select CLTCODE,BRANCHCODE,CLIENT_NAME,EXCHANGE,SEGMENT,AMOUNT,SR_SEGMENT,GL_ACCOUNT,EQ_GL_ACCOUNT,GETDATE(),@FLAG from #TRF_ENTRIES

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_AUTOJV_AMOUNT_NEW_bk_07082018
-- --------------------------------------------------

--EXEC MFSS_AUTOJV_AMOUNT_NEW 'JUL 10 2017', 'A00', 'ZZZZZ', 'SYSTEM','D'
create PROCEDURE [dbo].[MFSS_AUTOJV_AMOUNT_NEW_bk_07082018]
	@VDT VARCHAR(11),
	@FR_CLIENT VARCHAR(10),
	@TO_CLIENT VARCHAR(10),
	@UNAME VARCHAR(15),
	@FLAG VARCHAR(1)

AS
DECLARE
	@SDTCUR VARCHAR(11),
	@LDTCUR VARCHAR(11)
	

/*SET @VDT = 'MAR 31 2017'
SET @UNAME = 'NIK'*/

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @LDTCUR = LDTCUR FROM PARAMETER WHERE @VDT BETWEEN SDTCUR AND LDTCUR


CREATE TABLE #TRF_ENTRIES
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	EQ_GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)


IF @FLAG = 'C'

	BEGIN 
		INSERT INTO #TRF_ENTRIES (CLTCODE, BRANCHCODE, CLIENT_NAME, EXCHANGE, SEGMENT, AMOUNT)
		SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMT = SUM(AMOUNT) FROM
		(
			SELECT CLTCODE, BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT - CRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE EDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE,''  ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			--AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT*(-1)) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			AND (NARRATION  LIKE '%XSIP DIRECT PAYMENT%' OR NARRATION  LIKE '%ISIP DIRECT PAYMENT%')
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE, '' ACNAME,EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT - DRAMOUNT) FROM ACC_LEDGER_PL
			WHERE EDT >= @SDTCUR AND VDT < @SDTCUR AND VTYPE = 15  AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT
		) A
		WHERE CLTCODE BETWEEN @FR_CLIENT AND @TO_CLIENT 
		AND CLTCODE NOT IN (SELECT CLTCODE FROM MFSS_JVEXCEPTION)
		GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
		HAVING SUM(AMOUNT) < 0
    END 

IF @FLAG = 'D'
	   BEGIN 
	   INSERT INTO #TRF_ENTRIES (CLTCODE, BRANCHCODE, CLIENT_NAME, EXCHANGE, SEGMENT, AMOUNT)
		SELECT CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT, AMT = SUM(AMOUNT) FROM
		(
			SELECT CLTCODE, BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT - CRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE EDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE,''  ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(DRAMOUNT) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			--AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE, '' ACNAME, EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT*(-1)) FROM ACC_LEDGER_PL L
			WHERE VDT BETWEEN @SDTCUR AND @VDT + ' 23:59:59' AND EDT > @VDT + ' 23:59:59' AND VTYPE = 15 AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			AND (NARRATION  LIKE '%XSIP DIRECT PAYMENT%' OR NARRATION  LIKE '%ISIP DIRECT PAYMENT%')
			GROUP BY L.CLTCODE, L.BRANCHCODE, L.EXCHANGE, L.SEGMENT
			UNION ALL
			SELECT CLTCODE, BRANCHCODE, '' ACNAME,EXCHANGE, SEGMENT, AMOUNT = SUM(CRAMOUNT - DRAMOUNT) FROM ACC_LEDGER_PL
			WHERE EDT >= @SDTCUR AND VDT < @SDTCUR AND VTYPE = 15  AND EXCHANGE='BSE' AND SEGMENT ='MFSS'
			----AND NARRATION NOT LIKE '%XSIP DIRECT PAYMENT%'
			GROUP BY CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT
		) A
		WHERE CLTCODE BETWEEN @FR_CLIENT AND @TO_CLIENT 
		AND CLTCODE NOT IN (SELECT CLTCODE FROM MFSS_JVEXCEPTION)
		GROUP BY CLTCODE, BRANCHCODE, ACNAME,EXCHANGE, SEGMENT
		HAVING SUM(AMOUNT) >  0

	END 




--SELECT * FROM #TRF_ENTRIES

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'BSE' FROM ANAND.ACCOUNT_AB.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'NSE' FROM ANAND1.ACCOUNT.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE #TRF_ENTRIES SET SR_SEGMENT = 'NFO' FROM ACCOUNTFO.DBO.ACMAST A
WHERE #TRF_ENTRIES.CLTCODE = A.CLTCODE AND ISNULL(SR_SEGMENT, '') = ''

UPDATE T SET T.GL_ACCOUNT = G.GL_ACCOUNT, T.EQ_GL_ACCOUNT = G.EQ_GL_ACCOUNT
FROM #TRF_ENTRIES T, AUTOJV_MFSS_GLACCOUNT G
WHERE T.EXCHANGE = G.EXCHANGE AND T.SEGMENT = G.SEGMENT AND T.SR_SEGMENT = G.SR_SEGMENT

DELETE #TRF_ENTRIES WHERE ISNULL(SR_SEGMENT ,'')=''



DECLARE	
	@@VOUCHERNO VARCHAR(20)
SELECT @@VOUCHERNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)  

INSERT INTO BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES        
(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,      
BRANCHCODE, EXCHANGE, SEGMENT, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG,        
APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, CLIENTNAME, RESERVED2)         
SELECT 88, '01', 2, @VDT,@VDT,T.CLTCODE,        
CREDITAMT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE 0 END,        
DEBITAMT = CASE WHEN AMOUNT < 0 THEN ABS(AMOUNT) ELSE 0 END,        
NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END, BRANCHCODE = '', T.EXCHANGE, T.SEGMENT, ADDDT = GETDATE(), ADDBY = 'SYSTEM',       
'BROKER', 'BROKER', ROWSTATE = 0, APPROVALFLAG = 1,        
APPROVALDATE = GETDATE(), APPROVEDBY = 'SYSTEM', /*VOUCHERNO = CONVERT(VARCHAR, CONVERT(NUMERIC, @@VOUCHERNO) + SNO)*/ VOUCHERNO = @@VOUCHERNO,  
UPLOADDT = GETDATE(), ACNAME, SNO     
FROM         
#TRF_ENTRIES T, ACMAST A
WHERE T.CLTCODE = A.Cltcode AND T.EXCHANGE = A.Exchange AND T.SEGMENT = A.Segment         

        
INSERT INTO BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES        
(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,      
BRANCHCODE, EXCHANGE, SEGMENT, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG,        
APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, CLIENTNAME, RESERVED2)         
SELECT 88, '01', 1, @VDT,@VDT,GL_ACCOUNT,        
CREDITAMT = CASE WHEN AMOUNT < 0 THEN ABS(AMOUNT) ELSE 0 END,      
DEBITAMT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE 0 END,        
NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END, BRANCHCODE = '', T.EXCHANGE, T.SEGMENT, ADDDT = GETDATE(), ADDBY = 'SYSTEM',       
'BROKER', 'BROKER', ROWSTATE = 0, APPROVALFLAG = 1,        
APPROVALDATE = GETDATE(), APPROVEDBY = 'SYSTEM', /*VOUCHERNO = CONVERT(VARCHAR, CONVERT(NUMERIC, @@VOUCHERNO) + SNO)*/ VOUCHERNO = @@VOUCHERNO,        
UPLOADDT = GETDATE(), ACNAME , SNO         
FROM         
#TRF_ENTRIES T, ACMAST A
WHERE T.GL_ACCOUNT = A.Cltcode AND T.EXCHANGE = A.Exchange AND T.SEGMENT = A.Segment   


EXEC BBO_FA.DBO.FA_POSTING @@VOUCHERNO



CREATE TABLE #TRF_ENTRIES_NSE
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

CREATE TABLE #TRF_ENTRIES_BSE
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

CREATE TABLE #TRF_ENTRIES_NFO
(
	CLTCODE VARCHAR(10),
	BRANCHCODE VARCHAR(10),
	CLIENT_NAME VARCHAR(100),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	AMOUNT MONEY,
	SR_SEGMENT VARCHAR(10),
	GL_ACCOUNT VARCHAR(10),
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #TRF_ENTRIES_NSE
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'NSE'

INSERT INTO #TRF_ENTRIES_BSE
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'BSE'

INSERT INTO #TRF_ENTRIES_NFO
SELECT CLTCODE,
	BRANCHCODE,
	CLIENT_NAME,
	EXCHANGE,
	SEGMENT,
	AMOUNT,
	SR_SEGMENT,
	GL_ACCOUNT
FROM #TRF_ENTRIES
WHERE SR_SEGMENT = 'NFO'

DECLARE
	@REC_COUNT INT,
	@@LASTVNO VARCHAR(12)

SET @REC_COUNT = 0
	
SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_BSE	

	
CREATE TABLE #VNO
(
	LASTVNO VARCHAR(12)
)

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ANAND.ACCOUNT_AB.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ANAND.ACCOUNT_AB.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END,
	AMOUNT = CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_BSE T, ANAND.ACCOUNT_AB.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ANAND.ACCOUNT_AB.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_BSE T, ANAND.ACCOUNT_AB.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END


SET @REC_COUNT = 0
TRUNCATE TABLE #VNO

SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_NSE		

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ANAND1.ACCOUNT.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ANAND1.ACCOUNT.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END , @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NSE T,ANAND1.ACCOUNT.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ANAND1.ACCOUNT.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END,
	AMOUNT=CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NSE T, ANAND1.ACCOUNT.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END

SET @REC_COUNT = 0
TRUNCATE TABLE #VNO

SELECT @REC_COUNT = COUNT(1) FROM #TRF_ENTRIES_NFO

IF @REC_COUNT > 0
BEGIN
	INSERT INTO #VNO
	EXEC ACCOUNTFO.DBO.ACC_GENVNO_NEW @VDT, 88, '01', @SDTCUR, @LDTCUR, @REC_COUNT

	SELECT @@LASTVNO = LASTVNO FROM #VNO

	INSERT INTO ACCOUNTFO.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 2, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'D' ELSE 'C' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), T.CLTCODE, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NFO T, ACCOUNTFO.DBO.ACMAST A
	WHERE A.CLTCODE = T.CLTCODE

	INSERT INTO ACCOUNTFO.DBO.LEDGER
	SELECT 88, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO), @VDT, 1, LONGNAME, CASE WHEN AMOUNT > 0 THEN 'C' ELSE 'D' END, 
	AMOUNT =CASE WHEN AMOUNT > 0 THEN AMOUNT ELSE ABS(AMOUNT) END, @VDT, CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@LASTVNO) + SNO),
	REFNO = 0, BALAMT = 0, NODAYS = 0, CDT = GETDATE(), CLTCODE = GL_ACCOUNT, BOOKTYPE = '01', ENTEREDBY = 'SYSTEM', PDT = GETDATE(), CHECKEDBY = 'SYSTEM', Actnodays = 0,
	NARRATION = 'FUNDS TRANSFER FROM ' + CASE WHEN AMOUNT > 0 THEN ' EQUITY TO MFSS SEGMENT' ELSE ' MFSS TO EQUITY SEGMENT ' END
	FROM #TRF_ENTRIES_NFO T, ACCOUNTFO.DBO.ACMAST A
	WHERE A.CLTCODE = GL_ACCOUNT
END


INSERT INTO MFSS_TRF_ENTRIES (CLTCODE,BRANCHCODE,CLIENT_NAME,EXCHANGE,SEGMENT,AMOUNT,SR_SEGMENT,GL_ACCOUNT,EQ_GL_ACCOUNT,TRANSFER_DATE,FLAG)
select CLTCODE,BRANCHCODE,CLIENT_NAME,EXCHANGE,SEGMENT,AMOUNT,SR_SEGMENT,GL_ACCOUNT,EQ_GL_ACCOUNT,GETDATE(),@FLAG from #TRF_ENTRIES

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_JV
-- --------------------------------------------------
CREATE PROC MFSS_JV
AS 

DECLARE @VDT AS VARCHAR(11)

SET @VDT =CONVERT(VARCHAR(11),GETDATE(),109)

EXEC MFSS_AUTOJV_AMOUNT_NEW  @VDT, 'A00', 'ZZZZZ', 'SYSTEM','D'
 
EXEC MFSS_AUTOJV_AMOUNT_NEW  @VDT, 'A00', 'ZZZZZ', 'SYSTEM','C'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_KYC_JV
-- --------------------------------------------------

--EXEC MFSS_AUTOJV_AMOUNT_NEW 'JUL 10 2017', 'A00', 'ZZZZZ', 'SYSTEM','D'
CREATE PROCEDURE [dbo].[MFSS_KYC_JV]
AS
--DECLARE
--	@SDTCUR VARCHAR(11),
--	@LDTCUR VARCHAR(11)
	

/*SET @VDT = 'MAR 31 2017'
SET @UNAME = 'NIK'*/

--SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @LDTCUR = LDTCUR FROM PARAMETER WHERE @VDT BETWEEN SDTCUR AND LDTCUR

  
   	SELECT  P.*  into #TRF_ENTRIES FROM MIS.KYC_CI.dbo.tbl_BankPaymentInfo_Ekyc_Middleware_Bo P WITH(NOLOCK) 
	,ACMAST  D WITH(NOLOCK) 
	WHERE P.CLTCODE=D.Cltcode AND P.EXCHANGE=D.EXCHANGE AND P.SEGMENT=D.SEGMENT   and
	isnull(BoPushed,'')='' AND P.SEGMENT ='MFSS' 

 
  DELETE FROM #TRF_ENTRIES
  WHERE VoucherNo IN (SELECT VoucherNo FROM #TRF_ENTRIES 
  GROUP BY VoucherNo
  HAVING COUNT(VoucherNo)=1)

 IF (SELECT COUNT(*) FROM #TRF_ENTRIES)>=1

 BEGIN 
	DECLARE	
		@@VOUCHERNO VARCHAR(20)
		SELECT @@VOUCHERNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)  

		INSERT INTO BBO_FA.DBO.V2_OFFLINE_LEDGER_ENTRIES        
		(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,      
		BRANCHCODE, EXCHANGE, SEGMENT, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG,        
		APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, CLIENTNAME, RESERVED2)         
		SELECT 8, '01', SNO, CONVERT(VARCHAR(11),t.VDATE,120),CONVERT(VARCHAR(11),t.VDATE,120),T.CLTCODE,        
		CREDITAMT  ,        
		DEBITAMT  ,        
		NARRATION  , BRANCHCODE = '', T.EXCHANGE, T.SEGMENT, ADDDT = GETDATE(), ADDBY = 'EKYC',       
		'BROKER', 'BROKER', ROWSTATE = 0, APPROVALFLAG = 1,        
		APPROVALDATE = GETDATE(), APPROVEDBY = 'SYSTEM', /*VOUCHERNO = CONVERT(VARCHAR, CONVERT(NUMERIC, @@VOUCHERNO) + SNO)*/ VOUCHERNO = @@VOUCHERNO,  
		UPLOADDT = GETDATE(), ACNAME, '1'     
		FROM         
		#TRF_ENTRIES T, ACMAST A
		WHERE T.CLTCODE = A.Cltcode AND T.EXCHANGE = A.Exchange AND T.SEGMENT = A.Segment         

		UPDATE A SET BoPushed ='Y',BoPushed_Date = getdate()  ,VOUCHERNO =@@VOUCHERNO
				FROM MIS.KYC_CI.dbo.tbl_BankPaymentInfo_Ekyc_Middleware_Bo A,  
				#TRF_ENTRIES P WHERE A.CLTCODE=p.CLTCODE  AND A.EXCHANGE=P.EXCHANGE AND A.SEGMENT=P.SEGMENT
				AND A.VDATE=P.VDATE  AND A.VoucherNo=P.VoucherNo
				AND  	isnull(A.BoPushed,'')=''  


		EXEC BBO_FA.DBO.FA_POSTING @@VOUCHERNO


 				UPDATE A SET Boprocessed ='Y',Boprocessed_Date= P.ApprovalDate 
				FROM MIS.KYC_CI.dbo.tbl_BankPaymentInfo_Ekyc_Middleware_Bo A,  
				V2_OFFLINE_LEDGER_ENTRIES P WHERE A.CLTCODE=p.CLTCODE  
	            AND CONVERT(VARCHAR(11),A.VDATE,120)=P.VDATE AND A.VOUCHERTYPE=P.VoucherType   AND A.EXCHANGE=P.EXCHANGE AND A.SEGMENT=P.SEGMENT
			----	AND  A.VDATE =P.VDATE AND A.VOUCHERTYPE=P.VoucherType   AND A.EXCHANGE=P.EXCHANGE AND A.SEGMENT=P.SEGMENT
				AND isnull(A.Boprocessed,'')='' AND A.VoucherNo=P.VoucherNo ---Boprocessed IS NULL   
				and p.RowState=1 AND A.SEGMENT ='MFSS'


 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFSS_LEDGER_DUMP_REPORT
-- --------------------------------------------------

---EXEC MFSS_LEDGER_DUMP_REPORT '2017-04-01 ','2017-05-31'

create PROCEDURE MFSS_LEDGER_DUMP_REPORT

(
@FROMDATE DATETIME ,
@TODATE DATETIME)
as begin

select A.EXCHANGE,VTYPE,VNO,VDT,DRAMOUNT,CRAMOUNT,A.CLTCODE,A.ACNAME,POSTED_BY,POSTED_ON,NARRATION,B.actyp
 from ACC_LEDGER A WITH(NOLOCK),ACMAST B WITH(NOLOCK) 
 where VDT>=@FROMDATE + '00:00:00' and  vdt<=@TODATE + '23:59:59'
  and VTYPE<>18
 AND A.CLTCODE=B.CLTCODE
 order by CLTCODE
 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------
/*      
exec NEWPOSTBILL @VTYPE=15,@BOOKTYPE='01',@VDT='27/06/2006',@EDTDR='28/06/2006',@EDTCR='28/06/2006',@SETT_NO='2006082',@SETT_TYPE='N',@UNAME='demo d',@CATEGORY=N'388                 ',@EXCHANGE='NSE',@SEGMENT='CAPITAL',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
  
    
RR_NO='' ,@ERR_MSG=''      
exec NEWPOSTBILL @VTYPE=21,@BOOKTYPE='01',@VDT='27/06/2006',@EDTDR='21/07/2006',@EDTCR='21/07/2006',@SETT_NO='2006082',@SETT_TYPE='N',@UNAME='demo d',@CATEGORY=N'388                 ',@EXCHANGE='NSE',@SEGMENT='CAPITAL',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
  
    
RR_NO='',@ERR_MSG=''      
      
      
begin tran    
declare @p14 tinyint    
set @p14=1    
declare @p15 varchar(500)    
set @p15=''    
exec NEWPOSTBILL @VTYPE=15,@BOOKTYPE='01',@VDT='07/03/2011',@EDTDR='09/03/2011',@EDTCR='09/03/2011',@SETT_NO='2011044',@SETT_TYPE='S',@UNAME='demo demo',@CATEGORY=N'1                   ',@EXCHANGE='NSE',@SEGMENT='MFSS',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
  
RR_NO=@p14 output,@ERR_MSG=@p15 output    
select @p14, @p15    
SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES ORDER BY ADDDT DESC    
rollback    
*/      
CREATE PROCEDURE [dbo].[NEWPOSTBILL]                    
(                  
 @VTYPE [UDTVTYPE],      
 @BOOKTYPE [UDTBOOKTYPE],      
 @VDT VARCHAR(11),             
 @EDTDR VARCHAR(11),      
 @EDTCR VARCHAR(11),      
 @SETT_NO [UDTSETTNO],      
 @SETT_TYPE [UDTSETTTYPE],      
 @UNAME [UDTUSERID],      
 @CATEGORY NCHAR (20),      
 @EXCHANGE [UDTEXCHANGE],      
 @SEGMENT [UDTSEGMENT],      
 @BILLDATE VARCHAR(11),      
 @IP_ADD VARCHAR(20),      
 @ERR_NO TINYINT OUTPUT,      
 @ERR_MSG VARCHAR(500) OUTPUT           
)       
--WITH ENCRYPTION                 
AS        
      
      
BEGIN TRY      
      
IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0      
 BEGIN      
  SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)      
 END      
       
 IF LEN(@EDTDR) = 10 AND CHARINDEX('/', @EDTDR) > 0      
 BEGIN      
  SET @EDTDR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTDR, 103), 109)      
 END      
       
 IF LEN(@EDTCR) = 10 AND CHARINDEX('/', @EDTCR) > 0      
 BEGIN      
  SET @EDTCR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTCR, 103), 109)      
 END      
       
       
      
IF LEN(@BILLDATE) = 10 AND CHARINDEX('/', @BILLDATE) > 0      
 BEGIN      
  SET @BILLDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @BILLDATE, 103), 109)      
 END      
      
DECLARE      
 @VNO VARCHAR(12),      
 @MARTERSNO VARCHAR(12),      
 @@SQL VARCHAR(2000),      
 @SHAREDB VARCHAR(20)      
      
DECLARE      
 @START_DATE_ADD NUMERIC(8),      
 @END_DATE_ADD NUMERIC(8),      
 @START_DATE_EDIT NUMERIC(8),      
 @END_DATE_EDIT NUMERIC(8)      
      
IF @SETT_TYPE <> '' AND @EXCHANGE <> 'IEX'      
 BEGIN      
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VTYPE = @VTYPE      
 END      
ELSE      
 BEGIN      
  SET @SETT_NO = CONVERT(VARCHAR(6), CONVERT(DATETIME, @BILLDATE), 12)      
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT      
 END      
      
IF @MARTERSNO <> '0'      
 BEGIN      
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_EDIT OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_EDIT      
   BEGIN      
    RAISERROR ('NOT ALLOWED', 16, 1)      
    RETURN      
   END      
 END      
ELSE      
 BEGIN      
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_ADD OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_ADD      
   BEGIN      
    RAISERROR ('NOT ALLOWED', 16, 1)      
    RETURN      
   END      
 END      
      
SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT      
      
CREATE TABLE #BILLDETAILS      
(      
 SNO INT IDENTITY(1, 1),      
 SELL_BUY VARCHAR(2) NULL,      
 PARTY_CODE VARCHAR(20) NULL,      
 AMOUNT MONEY NULL,    
 EDT DATETIME,      
 NARRATION VARCHAR(50)      
)      
      
EXEC MAKE_UDT_STRUCTURE       
 '#BILLDETAILS',       
 'BRANCHCD',       
 'UDTBRANCHCODE',       
 '',       
 '0'        
      
      
SELECT @VNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)      
      
IF @SETT_TYPE <> '' AND @BILLDATE <> ''      
 BEGIN      
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "      
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYout_DATE, NARRATION, BRANCHCD "      
  SET @@SQL = @@SQL + "FROM "      
  IF @VTYPE = 15      
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "      
  ELSE      
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "      
  SET @@SQL = @@SQL + "WHERE "      
  SET @@SQL = @@SQL + "SAUDA_DATE = '" + @BILLDATE + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "      
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"      
 END      
ELSE IF @SETT_TYPE <> '' AND @SETT_NO <> ''      
 BEGIN      
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "      
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYout_DATE, NARRATION, BRANCHCD "      
  SET @@SQL = @@SQL + "FROM "      
  IF @VTYPE = 15      
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "      
  ELSE      
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "      
  SET @@SQL = @@SQL + "WHERE "      
  SET @@SQL = @@SQL + "SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "      
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"      
 END      
ELSE IF @EXCHANGE = "USX" OR @EXCHANGE = "BSE" OR @EXCHANGE = "USM"      
 BEGIN      
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "      
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "      
  SET @@SQL = @@SQL + "FROM "      
  SET @@SQL = @@SQL + @SHAREDB + "..BFOACCBILL "      
  SET @@SQL = @@SQL + "WHERE "      
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "      
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"      
 END      
ELSE      
 BEGIN      
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "      
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "      
  SET @@SQL = @@SQL + "FROM "      
  SET @@SQL = @@SQL + @SHAREDB + "..FOACCBILL "      
  SET @@SQL = @@SQL + "WHERE "      
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "      
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"      
 END      
      
EXEC (@@SQL)   
--print  @@SQL    
--SELECT * FROM #BILLDETAILS      
IF @MARTERSNO <> '0'      
 BEGIN      
      
  DECLARE      
   @@LEDGERVNO VARCHAR(12),      
   @@EXCHANGE VARCHAR(10),      
   @@SEGMENT VARCHAR(20),      
   @@VTYPE INT,      
   @@BOOKTYPE VARCHAR(10)      
      
      
      
  SELECT @@LEDGERVNO = VNO, @@EXCHANGE = EXCHANGE, @@SEGMENT = SEGMENT, @@VTYPE = VTYPE, @@BOOKTYPE = BOOKTYPE FROM ACC_LEDGER WHERE MASTERSNO = @MARTERSNO      
    
      
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG      
   (FLDAUTO, VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT,
  
    
 ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, EDITED_BY, EDITED_ON, 
  
    
ACTION_FLAG, IP_ADD, RECORD_STATE)      
  SELECT      
   FLDAUTO,      
   VOUCHERTYPE,      
   BOOKTYPE,      
   SNO,      
   VDATE,      
   EDATE,      
   CLTCODE,      
   CREDITAMT,      
   DEBITAMT,      
   NARRATION,      
   OPPCODE,      
   MARGINCODE,      
   BANKNAME,      
   BRANCHNAME,      
   BRANCHCODE,      
   DDNO,      
   CHEQUEMODE,      
   CHEQUEDATE,      
   CHEQUENAME,      
   CLEAR_MODE,      
   TPACCOUNTNUMBER,      
   EXCHANGE,      
   SEGMENT,      
   TPFLAG,      
   ADDDT,      
   ADDBY,      
   STATUSID,      
   STATUSNAME,      
   ROWSTATE,      
   APPROVALFLAG,      
   APPROVALDATE,      
   APPROVEDBY,      
   VOUCHERNO,      
   UPLOADDT,      
   LEDGERVNO,      
   CLIENTNAME,      
   OPPCODENAME,      
   MARGINCODENAME,      
   SETT_NO,      
   SETT_TYPE,      
   PRODUCTTYPE,      
   REVAMT,      
   REVCODE,      
   MICR,      
   REL_DATE,      
   DISPLAY_FLAG,      
   @UNAME,      
   GETDATE(),      
   'E',      
   @IP_ADD,      
   1      
  FROM      
   V2_OFFLINE_LEDGER_ENTRIES      
  WHERE       
   LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT      
      
  UPDATE V2_OFFLINE_LEDGER_ENTRIES SET ROWSTATE = 1, APPROVALFLAG = 3 WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT      
  --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT      
 END      
      
INSERT INTO V2_OFFLINE_LEDGER_ENTRIES      
(      
 VOUCHERTYPE,       
 BOOKTYPE,       
 SNO,       
 VDATE,       
 EDATE,       
 CHEQUEDATE,       
 CLTCODE,       
 CREDITAMT,       
 DEBITAMT,       
 NARRATION,      
 BRANCHCODE,       
 EXCHANGE,       
 SEGMENT,       
 ADDDT,       
 ADDBY,       
 STATUSID,       
 STATUSNAME,       
 ROWSTATE,       
 APPROVALFLAG,       
 VOUCHERNO,      
 UPLOADDT,      
 LEDGERVNO,      
 SETT_NO,      
 SETT_TYPE,      
 CLIENTNAME,      
 RESERVED1,      
 RESERVED2      
)      
SELECT      
 @VTYPE,       
 @BOOKTYPE,       
 B.SNO,       
 @VDT,       
 EDT,       
 @BILLDATE,       
 B.PARTY_CODE,       
 CREDITAMT = CASE WHEN B.SELL_BUY = 2 THEN B.AMOUNT ELSE 0 END,      
 DEBITAMT = CASE WHEN B.SELL_BUY = 1 THEN B.AMOUNT ELSE 0 END,       
 NARRATION =       
 CASE WHEN       
  @BILLDATE = ''       
 THEN       
  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(B.NARRATION))      
 ELSE      
  @EXCHANGE + @BILLDATE + RTRIM(LTRIM(B.NARRATION))      
 END,      
 B.BRANCHCD,      
 @EXCHANGE,       
 @SEGMENT,       
 GETDATE(),       
 @UNAME,       
 'BROKER',       
 'BROKER',       
 ROWSTATE = 0,       
 APPROVALFLAG = 1,       
 VOUCHERNO = @VNO,       
 GETDATE(),       
 LEDGERVNO = CASE WHEN @MARTERSNO <> 0 THEN @@LEDGERVNO ELSE '' END,       
 @SETT_NO,       
 @SETT_TYPE,      
 A.LONGNAME,      
 CASE WHEN @MARTERSNO <> 0 THEN @MARTERSNO ELSE 0 END,      
 9999      
FROM       
 #BILLDETAILS B,      
 ACMAST A      
WHERE      
 B.PARTY_CODE = A.CLTCODE      
 AND A.EXCHANGE = @EXCHANGE      
 AND A.SEGMENT = @SEGMENT      
 AND B.AMOUNT > 0      
      
      
    
EXEC FA_POSTING @VNO      
      
SELECT TOP 1 LEDGERVNO FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERNO = @VNO AND (VOUCHERTYPE = 15 OR VOUCHERTYPE = 21)      
      
      
END TRY      
BEGIN CATCH      
 IF @@TRANCOUNT > 0      
  ROLLBACK TRAN      
 SET @ERR_NO = 1      
 SET @ERR_MSG = ERROR_MESSAGE()      
      
 PRINT @ERR_MSG      
 RETURN      
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL_suresh
-- --------------------------------------------------
  
/*    
exec NEWPOSTBILL @VTYPE=15,@BOOKTYPE='01',@VDT='27/06/2006',@EDTDR='28/06/2006',@EDTCR='28/06/2006',@SETT_NO='2006082',@SETT_TYPE='N',@UNAME='demo d',@CATEGORY=N'388                 ',@EXCHANGE='NSE',@SEGMENT='CAPITAL',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
  
RR_NO='' ,@ERR_MSG=''    
exec NEWPOSTBILL @VTYPE=21,@BOOKTYPE='01',@VDT='27/06/2006',@EDTDR='21/07/2006',@EDTCR='21/07/2006',@SETT_NO='2006082',@SETT_TYPE='N',@UNAME='demo d',@CATEGORY=N'388                 ',@EXCHANGE='NSE',@SEGMENT='CAPITAL',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
  
RR_NO='',@ERR_MSG=''    
    
    
begin tran  
declare @p14 tinyint  
set @p14=1  
declare @p15 varchar(500)  
set @p15=''  
exec NEWPOSTBILL @VTYPE=15,@BOOKTYPE='01',@VDT='07/03/2011',@EDTDR='09/03/2011',@EDTCR='09/03/2011',@SETT_NO='2011044',@SETT_TYPE='S',@UNAME='demo demo',@CATEGORY=N'1                   ',@EXCHANGE='NSE',@SEGMENT='MFSS',@BILLDATE='',@IP_ADD ='127.0.0.1',@E
RR_NO=@p14 output,@ERR_MSG=@p15 output  
select @p14, @p15  
SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES ORDER BY ADDDT DESC  
rollback  
*/    
CREATE PROCEDURE [dbo].[NEWPOSTBILL_suresh]                  
(                
 @VTYPE [UDTVTYPE],    
 @BOOKTYPE [UDTBOOKTYPE],    
 @VDT VARCHAR(11),           
 @EDTDR VARCHAR(11),    
 @EDTCR VARCHAR(11),    
 @SETT_NO [UDTSETTNO],    
 @SETT_TYPE [UDTSETTTYPE],    
 @UNAME [UDTUSERID],    
 @CATEGORY NCHAR (20),    
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT],    
 @BILLDATE VARCHAR(11),    
 @IP_ADD VARCHAR(20),    
 @ERR_NO TINYINT OUTPUT,    
 @ERR_MSG VARCHAR(500) OUTPUT         
)     
--WITH ENCRYPTION               
AS      
    
    
BEGIN TRY    
    
IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0    
 BEGIN    
  SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)    
 END    
     
 IF LEN(@EDTDR) = 10 AND CHARINDEX('/', @EDTDR) > 0    
 BEGIN    
  SET @EDTDR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTDR, 103), 109)    
 END    
     
 IF LEN(@EDTCR) = 10 AND CHARINDEX('/', @EDTCR) > 0    
 BEGIN    
  SET @EDTCR = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EDTCR, 103), 109)    
 END    
     
     
    
IF LEN(@BILLDATE) = 10 AND CHARINDEX('/', @BILLDATE) > 0    
 BEGIN    
  SET @BILLDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @BILLDATE, 103), 109)    
 END    
    
DECLARE    
 @VNO VARCHAR(12),    
 @MARTERSNO VARCHAR(12),    
 @@SQL VARCHAR(2000),    
 @SHAREDB VARCHAR(20)    
    
DECLARE    
 @START_DATE_ADD NUMERIC(8),    
 @END_DATE_ADD NUMERIC(8),    
 @START_DATE_EDIT NUMERIC(8),    
 @END_DATE_EDIT NUMERIC(8)    
    
IF @SETT_TYPE <> '' AND @EXCHANGE <> 'IEX'    
 BEGIN    
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VTYPE = @VTYPE    
 END    
ELSE    
 BEGIN    
  SET @SETT_NO = CONVERT(VARCHAR(6), CONVERT(DATETIME, @BILLDATE), 12)    
  SELECT TOP 1 @MARTERSNO = ISNULL(MASTERSNO, '0') FROM ACC_LEDGER WHERE SETT_NO = @SETT_NO AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT    
 END    
    
IF @MARTERSNO <> '0'    
 BEGIN    
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_EDIT OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_EDIT    
   BEGIN    
    RAISERROR ('NOT ALLOWED', 16, 1)    
    RETURN    
   END    
 END    
ELSE    
 BEGIN    
  IF CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) < @START_DATE_ADD OR CONVERT(NUMERIC(8), CONVERT(VARCHAR(8), CONVERT(DATETIME, @VDT), 112)) > @END_DATE_ADD    
   BEGIN    
    RAISERROR ('NOT ALLOWED', 16, 1)    
    RETURN    
   END    
 END    
    
SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT    
    
CREATE TABLE #BILLDETAILS    
(    
 SNO INT IDENTITY(1, 1),    
 SELL_BUY VARCHAR(2) NULL,    
 PARTY_CODE VARCHAR(20) NULL,    
 AMOUNT MONEY NULL,  
 EDT DATETIME,    
 NARRATION VARCHAR(50)    
)    
    
EXEC MAKE_UDT_STRUCTURE     
 '#BILLDETAILS',     
 'BRANCHCD',     
 'UDTBRANCHCODE',     
 '',     
 '0'      
    
    
SELECT @VNO = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)    
    
IF @SETT_TYPE <> '' AND @BILLDATE <> ''    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYin_DATE, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  IF @VTYPE = 15    
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "    
  ELSE    
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "SAUDA_DATE = '" + @BILLDATE + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE IF @SETT_TYPE <> '' AND @SETT_NO <> ''    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, PAYin_DATE, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  IF @VTYPE = 15    
   SET @@SQL = @@SQL + @SHAREDB + "..ACCBILL "    
  ELSE    
   SET @@SQL = @@SQL + @SHAREDB + "..IACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE IF @EXCHANGE = "USX" OR @EXCHANGE = "BSE" OR @EXCHANGE = "USM"    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  SET @@SQL = @@SQL + @SHAREDB + "..BFOACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
ELSE    
 BEGIN    
  SET @@SQL = "INSERT INTO #BILLDETAILS(SELL_BUY, PARTY_CODE, AMOUNT, EDT, NARRATION, BRANCHCD) "    
  SET @@SQL = @@SQL + "SELECT SELL_BUY, PARTY_CODE, AMOUNT, CASE WHEN SELL_BUY = 2 THEN '" + @EDTCR + "' ELSE '" + @EDTDR + "' END, NARRATION, BRANCHCD "    
  SET @@SQL = @@SQL + "FROM "    
  SET @@SQL = @@SQL + @SHAREDB + "..FOACCBILL "    
  SET @@SQL = @@SQL + "WHERE "    
  SET @@SQL = @@SQL + "BILLDATE LIKE '" + @BILLDATE + "%' "    
  SET @@SQL = @@SQL + "AND BRANCHCD <> 'ZZZ' ORDER BY AMOUNT DESC"    
 END    
    
EXEC (@@SQL)    
SELECT * FROM #BILLDETAILS    
IF @MARTERSNO <> '0'    
 BEGIN    
    
  DECLARE    
   @@LEDGERVNO VARCHAR(12),    
   @@EXCHANGE VARCHAR(10),    
   @@SEGMENT VARCHAR(20),    
   @@VTYPE INT,    
   @@BOOKTYPE VARCHAR(10)    
    
    
    
  SELECT @@LEDGERVNO = VNO, @@EXCHANGE = EXCHANGE, @@SEGMENT = SEGMENT, @@VTYPE = VTYPE, @@BOOKTYPE = BOOKTYPE FROM ACC_LEDGER WHERE MASTERSNO = @MARTERSNO    
    
  select * from #BILLDETAILS  
 return  
    
  INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG    
   (FLDAUTO, VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT,
  
 ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, EDITED_BY, EDITED_ON, 
  
ACTION_FLAG, IP_ADD, RECORD_STATE)    
  SELECT    
   FLDAUTO,    
   VOUCHERTYPE,    
   BOOKTYPE,    
   SNO,    
   VDATE,    
   EDATE,    
   CLTCODE,    
   CREDITAMT,    
   DEBITAMT,    
   NARRATION,    
   OPPCODE,    
   MARGINCODE,    
   BANKNAME,    
   BRANCHNAME,    
   BRANCHCODE,    
   DDNO,    
   CHEQUEMODE,    
   CHEQUEDATE,    
   CHEQUENAME,    
   CLEAR_MODE,    
   TPACCOUNTNUMBER,    
   EXCHANGE,    
   SEGMENT,    
   TPFLAG,    
   ADDDT,    
   ADDBY,    
   STATUSID,    
   STATUSNAME,    
   ROWSTATE,    
   APPROVALFLAG,    
   APPROVALDATE,    
   APPROVEDBY,    
   VOUCHERNO,    
   UPLOADDT,    
   LEDGERVNO,    
   CLIENTNAME,    
   OPPCODENAME,    
   MARGINCODENAME,    
   SETT_NO,    
   SETT_TYPE,    
   PRODUCTTYPE,    
   REVAMT,    
   REVCODE,    
   MICR,    
   REL_DATE,    
   DISPLAY_FLAG,    
   @UNAME,    
   GETDATE(),    
   'E',    
   @IP_ADD,    
   1    
  FROM    
   V2_OFFLINE_LEDGER_ENTRIES    
  WHERE     
   LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
    
  UPDATE V2_OFFLINE_LEDGER_ENTRIES SET ROWSTATE = 1, APPROVALFLAG = 3 WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
  --DELETE FROM V2_OFFLINE_LEDGER_ENTRIES WHERE LEDGERVNO = @@LEDGERVNO AND VOUCHERTYPE = @@VTYPE AND BOOKTYPE = @@BOOKTYPE AND EXCHANGE = @@EXCHANGE AND SEGMENT = @@SEGMENT    
 END    
    
INSERT INTO V2_OFFLINE_LEDGER_ENTRIES    
(    
 VOUCHERTYPE,     
 BOOKTYPE,     
 SNO,     
 VDATE,     
 EDATE,     
 CHEQUEDATE,     
 CLTCODE,     
 CREDITAMT,     
 DEBITAMT,     
 NARRATION,    
 BRANCHCODE,     
 EXCHANGE,     
 SEGMENT,     
 ADDDT,     
 ADDBY,     
 STATUSID,     
 STATUSNAME,     
 ROWSTATE,     
 APPROVALFLAG,     
 VOUCHERNO,    
 UPLOADDT,    
 LEDGERVNO,    
 SETT_NO,    
 SETT_TYPE,    
 CLIENTNAME,    
 RESERVED1,    
 RESERVED2    
)    
SELECT    
 @VTYPE,     
 @BOOKTYPE,     
 B.SNO,     
 @VDT,     
 EDT,     
 @BILLDATE,     
 B.PARTY_CODE,     
 CREDITAMT = CASE WHEN B.SELL_BUY = 2 THEN B.AMOUNT ELSE 0 END,    
 DEBITAMT = CASE WHEN B.SELL_BUY = 1 THEN B.AMOUNT ELSE 0 END,     
 NARRATION =     
 CASE WHEN     
  @BILLDATE = ''     
 THEN     
  'SETTNO=' + RTRIM(@SETT_NO) + @EXCHANGE + RTRIM(@SETT_TYPE) + RTRIM(LTRIM(B.NARRATION))    
 ELSE    
  @EXCHANGE + @BILLDATE + RTRIM(LTRIM(B.NARRATION))    
 END,    
 B.BRANCHCD,    
 @EXCHANGE,     
 @SEGMENT,     
 GETDATE(),     
 @UNAME,     
 'BROKER',     
 'BROKER',     
 ROWSTATE = 0,     
 APPROVALFLAG = 1,     
 VOUCHERNO = @VNO,     
 GETDATE(),     
 LEDGERVNO = CASE WHEN @MARTERSNO <> 0 THEN @@LEDGERVNO ELSE '' END,     
 @SETT_NO,     
 @SETT_TYPE,    
 A.LONGNAME,    
 CASE WHEN @MARTERSNO <> 0 THEN @MARTERSNO ELSE 0 END,    
 9999    
FROM     
 #BILLDETAILS B,    
 ACMAST A    
WHERE    
 B.PARTY_CODE = A.CLTCODE    
 AND A.EXCHANGE = @EXCHANGE    
 AND A.SEGMENT = @SEGMENT    
 AND B.AMOUNT > 0    
    
    
  
EXEC FA_POSTING @VNO    
    
SELECT TOP 1 LEDGERVNO FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VOUCHERNO = @VNO AND (VOUCHERTYPE = 15 OR VOUCHERTYPE = 21)    
    
    
END TRY    
BEGIN CATCH    
 IF @@TRANCOUNT > 0    
  ROLLBACK TRAN    
 SET @ERR_NO = 1    
 SET @ERR_MSG = ERROR_MESSAGE()    
    
 PRINT @ERR_MSG    
 RETURN    
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_AUTOPOST_VOUCHER
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PCREATEBOUSERS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_acc_getcompanyname
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_BANK_POSTING
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RECEIPT_BANK_POSTING]
(
	@TRANSACTION_ID VARCHAR(20), -- UNIQUE TRANSACTION NUMBER RECEIVED IN API
	@EFFECTIVE_DATE VARCHAR(20), -- RECEIPT EFFECTIVE DATE IN DD/MM/YYYY FORMAT
	@VOUCHER_DATE VARCHAR(20), -- RECEIPT VOUCHER DATE IN DD/MM/YYYY FORMAT
	@CLIENT_CODE VARCHAR(50), -- CLIENT OR GL ACCOUNT
	@AMOUNT MONEY, -- RECEIPT AMOUNT
	@NARRATION VARCHAR(234), -- RECEIPT NARRATION
	@BANK_CODE VARCHAR(10), -- BROKER BANK ACCOUNT
	@BANK_NAME VARCHAR(100), -- RECEIPT BANK NAME
	@REFERENCE_NO VARCHAR(28), -- RECEIPT REFERENCE NO
	@BRANCHCODE VARCHAR(20), -- CLIENT OR GL BRANCH CODE SPECIFIED IN BROKERS SYSTEM
	@BRANCH_NAME VARCHAR(50), -- RECEIPT BRANCH NAME
	@CHQ_MODE VARCHAR(1), -- RECEIPT CHEQUE MODE (C - CHEQUE , D - DD, I - INTERSEGMENT, N -NEFT/RTGS'
	@CHQ_DATE VARCHAR(20), -- RECEIPT CHEQUE DATE
	@CHQ_NAME VARCHAR(100), -- NAME OF CLIENT IN CASE THE RECEIVED FROM CLIENT
	@CL_MODE VARCHAR(1), -- CHEQUE CLEARING MODE
	@EXCHANGE VARCHAR(10), -- EXCHANGE FOR WHICH THE RECEIPT HAS BEEN ENTERED
	@SEGMENT VARCHAR(10),-- SEGMENT FOR WHICH THE RECEIPT HAS BEEN ENTERED
	@UNAME VARCHAR(25), -- LOGIN USER NAME
	@APIACCOUNT VARCHAR(25) -- API DETAILS SERVER
--	@APITABLE VARCHAR(25) -- APIDETAILS TABLE NAME
)
AS

DECLARE
	@@STD_DATE VARCHAR(11),
	@@LST_DATE VARCHAR(11),
	@@BRANCHFLAG AS TINYINT,
	@@VNOFLAG AS TINYINT,
	@@VNOMETHOD INT,
	@@ACNAME CHAR(100),
	@@BOOKTYPE CHAR(2),
	@@MICRNO VARCHAR(10),
	@@DRCR VARCHAR(1),
	@@VTYP SMALLINT,
	@@BANK_CODE VARCHAR(100),
	@@BACKDAYS INT,
	@@BACKDATE VARCHAR(11),
	@@SERIAL_NO INT,
	@@NEWVNO AS VARCHAR(12),
	@@MAXCOUNT AS INT,
	@@VDT AS VARCHAR(11),
	@@ERROR_COUNT AS INT,
	@@SQL AS VARCHAR(2000),
	@@MAXVNO AS INT,
	@USERCAT SMALLINT,
	@DRCR CHAR(1)
	
SET @DRCR = 'C'	

/*INSERT INTO APIDETAILS..API_PAYMENT_DETAILS
	(TRANSACTION_ID, EFFECTIVE_DATE, VOUCHER_DATE, CLIENT_CODE, AMOUNT, DRCR, NARRATION, BANK_CODE, BANK_NAME, REFERENCE_NO, BRANCHCODE, BRANCH_NAME, CHQ_MODE, CHQ_DATE, CHQ_NAME, CL_MODE, EXCHANGE, SEGMENT, UNAME, POST_DATE, ACTION_FLAG)
VALUES
(
	@TRANSACTION_ID,
	@EFFECTIVE_DATE,
	@VOUCHER_DATE,
	@CLIENT_CODE,
	@AMOUNT,
	@DRCR,
	@NARRATION,
	@BANK_CODE,
	@BANK_NAME,
	@REFERENCE_NO,
	@BRANCHCODE,
	@BRANCH_NAME,
	@CHQ_MODE,
	@CHQ_DATE,
	@CHQ_NAME,
	@CL_MODE,
	@EXCHANGE,
	@SEGMENT,
	@UNAME,
	GETDATE(),
	'I'
)*/

--SELECT @USERCAT = FLDCATEGORY FROM MSAJAG.DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = @UNAME

--BEGIN TRAN
	
CREATE TABLE #RECPAY_TABLE_TMP
(
	TRANSACTION_ID VARCHAR(20),
	SERIAL_NO INT,
	EDATE VARCHAR(20),
	VOUCHER_DATE VARCHAR(20),
	CLIENT_CODE VARCHAR(50),
	AMOUNT MONEY,
	DRCR VARCHAR(1),
	NARRATION VARCHAR(234),
	BANK_CODE VARCHAR(10),
	BANK_NAME VARCHAR(100),
	REF_NO VARCHAR(28),
	BRANCHCODE VARCHAR(20),
	BRANCH_NAME VARCHAR(50),
	CHQ_MODE VARCHAR(1),
	CHQ_DATE VARCHAR(20),
	CHQ_NAME VARCHAR(100),
	CL_MODE VARCHAR(1)
)

SELECT @@ERROR_COUNT = (CASE WHEN @EXCHANGE IN ('NSE','BSE') AND @SEGMENT ='MFSS' THEN 1 ELSE 0 END) FROM OWNER WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT


IF @@ERROR_COUNT = 0
BEGIN
	--UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'INVALID EXCHANGE SEGMENT POSTING' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'INVALID EXCHANGE SEGMENT POSTING', '" + @UNAME + "'"
	exec(@@SQL)
	RETURN
END

INSERT INTO #RECPAY_TABLE_TMP VALUES
(
	@TRANSACTION_ID,
	1,
	@EFFECTIVE_DATE,
	@VOUCHER_DATE,
	@CLIENT_CODE,
	@AMOUNT,
	@DRCR,
	@NARRATION,
	@BANK_CODE,
	@BANK_NAME,
	@REFERENCE_NO,
	@BRANCHCODE,
	@BRANCH_NAME,
	@CHQ_MODE,
	@CHQ_DATE,
	@CHQ_NAME,
	@CL_MODE
)

CREATE TABLE [#RECPAY_TABLE]
(
	TRANSACTION_ID VARCHAR(20),
	SERIAL_NO INT,
	EDATE VARCHAR(20),
	VOUCHER_DATE VARCHAR(20),
	CLIENT_CODE VARCHAR(50),
	AMOUNT MONEY,
	DRCR VARCHAR(1),
	NARRATION VARCHAR(234),
	BANK_CODE VARCHAR(10),
	BANK_NAME VARCHAR(100),
	REF_NO VARCHAR(28),
	BRANCHCODE VARCHAR(20),
	BRANCH_NAME VARCHAR(50),
	CHQ_MODE VARCHAR(1),
	CHQ_DATE VARCHAR(20),
	CHQ_NAME VARCHAR(100),
	CL_MODE VARCHAR(1),
	SNO INT IDENTITY (1, 1) NOT NULL ,
	VDT DATETIME NULL ,
	FYSTART DATETIME NULL ,
	FYEND DATETIME NULL ,
	UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),
	EDT DATETIME NULL ,
	DDDT DATETIME NULL ,
	VNO VARCHAR (12) NULL ,
	VTYP SMALLINT NULL ,
	ACNAME VARCHAR (100) NULL ,
	COSTCODE SMALLINT NULL,
	BANKCOST SMALLINT NULL,
	LNO SMALLINT NOT NULL DEFAULT(0),
	BANKNAME VARCHAR(100) NULL,
	MICRNO INT NULL,
	BOOKTYPE VARCHAR(2) NULL,
) ON [PRIMARY]

INSERT INTO
 #RECPAY_TABLE
 (
  TRANSACTION_ID,
  SERIAL_NO,
  EDATE,
  VOUCHER_DATE,
  CLIENT_CODE,
  AMOUNT,
  DRCR,
  NARRATION,
  BANK_CODE,
  BANK_NAME,
  REF_NO,
  BRANCHCODE,
  BRANCH_NAME,
  CHQ_MODE,
  CHQ_DATE,
  CHQ_NAME,
  CL_MODE
 )
SELECT
 TRANSACTION_ID,
 SERIAL_NO,
 EDATE,
 VOUCHER_DATE,
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),
 AMOUNT,
 UPPER(LTRIM(RTRIM(DRCR))),
 NARRATION,
 UPPER(LTRIM(RTRIM(BANK_CODE))),
 UPPER(LTRIM(RTRIM(BANK_NAME))),
 REF_NO,
 UPPER(LTRIM(RTRIM(BRANCHCODE))),
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),
 UPPER(LTRIM(RTRIM(CHQ_MODE))),
 CHQ_DATE,
 CHQ_NAME,
 CL_MODE
FROM
 #RECPAY_TABLE_TMP

UPDATE
 #RECPAY_TABLE
SET
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))


SELECT TOP 1
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)
FROM
 #RECPAY_TABLE


SELECT
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
 @@BRANCHFLAG = BRANCHFLAG,
 @@VNOFLAG = VNOFLAG
FROM
 PARAMETER
WHERE
 @@VDT BETWEEN SDTCUR AND LDTCUR

 
  UPDATE
   #RECPAY_TABLE
  SET
   FYSTART = @@STD_DATE,
   FYEND = @@LST_DATE + ' 23:59:59',
   UPDFLAG = 'Y',
   ACNAME = A.LONGNAME,
   BANKNAME = B.LONGNAME,
   BOOKTYPE = B.BOOKTYPE,
   MICRNO = ISNULL(B.MICRNO, 0)
  FROM
   (SELECT * FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT) A, (SELECT * FROM ACMAST WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT) B
  WHERE
   A.CLTCODE = CLIENT_CODE
   AND B.CLTCODE = BANK_CODE
   AND A.ACCAT IN ('3','4','18')
   AND B.ACCAT = '2'



 UPDATE R
  SET VTYP =
 CASE WHEN AMOUNT1 > 0 THEN 3 ELSE 2 END
 FROM (SELECT AMOUNT1 = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END), SERIAL_NO FROM #RECPAY_TABLE GROUP BY SERIAL_NO) R1, #RECPAY_TABLE R
 WHERE R.SERIAL_NO = R1.SERIAL_NO
 
 SELECT @@VTYP = VTYP FROM #RECPAY_TABLE

/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/
SELECT
	@@ERROR_COUNT = COUNT(1)
FROM
	#RECPAY_TABLE
WHERE
	VDT > EDT

IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/
IF @AMOUNT <= 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------VALIDATION FOR BLANK CHEQUE NUMBER ------------------------*/
SELECT
@@ERROR_COUNT = COUNT(1)
FROM
(
	SELECT DISTINCT
		 RP.REF_NO
	FROM
		#RECPAY_TABLE RP
		 WITH(NOLOCK)
	  --WHERE RP.REF_NO  = ''
	  where isnull(RP.REF_NO,'')=''
) A

IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER IS BLANK', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER ALREADY EXISTS' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END


/*--------------------------VALIDATION FOR DUPLICATE CHEQUE NUMBER ------------------------*/
SELECT
@@ERROR_COUNT = COUNT(1)
FROM
(
	SELECT DISTINCT
		DDNO  = RP.REF_NO
	FROM
		#RECPAY_TABLE RP,
		ACC_LEDGER L1  WITH(NOLOCK)
	WHERE
		L1.INSTNO = RP.REF_NO
		AND L1.CHQDD = RP.CHQ_MODE
		AND CRAMOUNT <> 0
		AND L1.VTYPE = @@VTYP
		AND RP.REF_NO <> '0'
		AND ISNUMERIC(RP.REF_NO) = 1
		AND L1.EXCHANGE = @EXCHANGE
		AND L1.SEGMENT = @SEGMENT
) A


IF @@ERROR_COUNT > 0
BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER ALREADY EXISTS', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CHEQUE NUMBER ALREADY EXISTS' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
END

/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/
SELECT
 @@ERROR_COUNT = COUNT(1)
FROM
 (
  SELECT DISTINCT
   CLIENT_CODE
  FROM
   #RECPAY_TABLE
  WHERE
   UPDFLAG = 'N'
 ) A
IF @@ERROR_COUNT > 0
 BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS DO NOT EXIST', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS DO NOT EXIST' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
 END

 /*
---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------
	UPDATE
		#RECPAY_TABLE
		SET UPDFLAG = 'N'
	FROM ( SELECT
		PARTY_CODE,
		INACTIVEFROM
	FROM MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),
		MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)
	WHERE C2.CL_CODE = C5.CL_CODE
		AND C2.PARTY_CODE IN (SELECT CLIENT_CODE FROM #RECPAY_TABLE)
		AND INACTIVEFROM <= GETDATE()) C
	WHERE CLIENT_CODE = C.PARTY_CODE


SELECT
 @@ERROR_COUNT = COUNT(1)
FROM
 (
  SELECT DISTINCT
   CLIENT_CODE
  FROM
   #RECPAY_TABLE
  WHERE
   UPDFLAG = 'N'
 ) A
IF @@ERROR_COUNT > 0
 BEGIN
	SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
	SET @@SQL = @@SQL + " SELECT POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS IS INACTIVE', '" + @UNAME + "'"
	EXEC(@@SQL)
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE
--	ROLLBACK TRAN
--	UPDATE APIDETAILS..API_PAYMENT_DETAILS SET POST_STATUS = 'FAIL', EXECUTION_REMARK = 'CLIENTS IS INACTIVE' WHERE TRANSACTION_ID = @TRANSACTION_ID  AND ISNULL(POST_STATUS, '') = ''
	RETURN
 END
 */
 SELECT @@BOOKTYPE = BOOKTYPE FROM ACMAST WHERE CLTCODE = @BANK_CODE

 DECLARE
	@VOUCHERNO VARCHAR(12)


Select @VOUCHERNO = CONVERT(varchar,RIGHT(DATEPART(yy,getdate()), 2))+
CONVERT(varchar,datepart(mm,getdate())) +
CONVERT(varchar,datepart(dd,getdate()))+
CONVERT(varchar,datepart(HH,getdate()))+
CONVERT(varchar,datepart(MI,getdate()))+
CONVERT(varchar,datepart(SS,getdate()))




INSERT INTO V2_OFFLINE_LEDGER_ENTRIES
(VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT, ADDBY, STATUSID, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME)
SELECT 2, @@BOOKTYPE, 1, VDT, EDT, CLIENT_CODE, AMOUNT, 0, NARRATION, BANK_CODE, '', BANK_NAME, BRANCH_NAME=LEFT(BRANCH_NAME,20), BRANCHCODE, REF_NO, CHQ_MODE, CHQ_DATE=DDDT, CHQ_NAME, CL_MODE, '', @EXCHANGE, @SEGMENT, 0, GETDATE(), @UNAME, 'BROKER', 'BROKER', 0, 1, GETDATE(), @UNAME, @VOUCHERNO, GETDATE(), '', CLIENTNAME=ACNAME, OPPCODENAME=BANKNAME, ''
FROM #RECPAY_TABLE

EXEC FA_POSTING @VOUCHERNO



SET @@SQL = "INSERT INTO [" + @APIACCOUNT + "].APIDETAILS.DBO.API_RESULT_DETAILS"
SET @@SQL = @@SQL + " SELECT POST_STATUS = 'SUCCESS', EXECUTION_REMARK = VNO + '|' + CONVERT(VARCHAR, " + CONVERT(VARCHAR, @@VTYP) + ") + '|' + BOOKTYPE + '|' + CLIENT_CODE + '|' + BANK_CODE + '|' + CONVERT(VARCHAR, AMOUNT), '" + @UNAME + "' FROM #RECPAY_TABLE"
EXEC(@@SQL)

/*UPDATE RD SET POST_STATUS = 'SUCCESS', EXECUTION_REMARK = VNO 
FROM APIDETAILS..API_PAYMENT_DETAILS RD, #RECPAY_TABLE R
WHERE RD.TRANSACTION_ID = R.TRANSACTION_ID
AND RD.TRANSACTION_ID = @TRANSACTION_ID
AND  ISNULL(POST_STATUS, '') = ''*/

DROP TABLE #RECPAY_TABLE_TMP
DROP TABLE #RECPAY_TABLE


--COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_acc_partyledger_All
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[rpt_acc_partyledger_All]        
                @fdate      VARCHAR(11),            /* As mmm dd yyyy */        
                @tdate      VARCHAR(11),            /* As mmm dd yyyy */        
                @fcode      VARCHAR(10),        
                @tcode      VARCHAR(10),        
                @strorder   VARCHAR(6),        
                @selectby   VARCHAR(3),         
                @statusid   VARCHAR(15),        
                @statusname VARCHAR(15),        
                @statusname_To VARCHAR(15),      
                @ORDERFLG   VARCHAR(1)  = 'N',        
                @EXCSEGMENT VARCHAR(1000) = '',        
                @ENTITY_TYPE VARCHAR(20) = 'ENTITY',        
                @Single     VARCHAR(1)  = 'N',        
                @FORPDF  VARCHAR(1) = 'N',      
                @CSV   VARCHAR(1) = 'N',        
				@VTYPE   VARCHAR(2) = '',
				@ENTITY varchar(25) ='',
				@ENTITY_LIST varchar(max) = '',
				@SHOWMARGIN INT = 0,
				@BALTYPE VARCHAR(15) = '' 
                        
        
AS        
/*        
select * from COMPANY_MASTER_SETTING        
 Exec [CLS_RPT_ACC_PARTYLEDGER_ALL] 'Apr 1 2008','Mar 2 2009','0','0a143','ACCODE','vdt','broker','broker','','','','','ACCOUNT~ACCOUNTBSE~ACCOUNTFO'        
commit        
Exec rpt_acc_partyledger_all 'May  1 2017','May  4 2017','A100024','A100024','ACCODE','vdt','broker','broker','',''        

EXEC BBO_FA..rpt_acc_partyledger_All '04/05/2017','04/05/2017','A100024','A100024','broker','broker','','VDT','codewise','BSE-MFSS','4','Y','Y','','N','ALL'
    
drop proc CLS_RPT_ACC_PARTYLEDGER_ALL_Test    
commit        
*/        
        
SET NOCOUNT ON        
        
  BEGIN        
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0        
  BEGIN        
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)        
  END        
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0        
  BEGIN        
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)        
  END       
     
 DECLARE @YEAR_START VARCHAR(11),    
  @YEAR_END VARCHAR(20)      
  SELECT @YEAR_START = CONVERT(VARCHAR(11), SDTCUR, 109), @YEAR_END = CONVERT(VARCHAR(11), LDTCUR, 109) + ' 23:59:59' FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR    
      
  CREATE TABLE [DBO].[#TMPLEDGERNEW] (        
  [BOOKTYPE]   [CHAR](2)   NULL,        
  [VOUDT]      [DATETIME]   NULL,        
  [EFFDT]      [DATETIME]   NULL,        
  [SHORTDESC]  [CHAR](6)   NULL,        
  [DRAMT]      [MONEY]   NULL,        
  [CRAMT]      [MONEY]   NULL,        
  [VNO]        [VARCHAR](12)   NULL,        
  [DDNO]       [VARCHAR](20)   NULL,        
  [NARRATION]  [VARCHAR](500)   NULL,        
  [CLTCODE]    [VARCHAR](10)   NOT NULL,        
  [VTYP]       [INT]   NULL,        
 -- [VTYP]       [VARCHAR](30)   NULL,        
  [VDT]        [VARCHAR](30)   NULL,        
  [EDT]        [VARCHAR](30)   NULL,        
  [ACNAME]     [VARCHAR](100)   NULL,        
  [OPBAL]      [MONEY]   NULL,        
  [L_ADDRESS1] [VARCHAR](100)   NULL,        
  [L_ADDRESS2] [VARCHAR](100)   NULL,        
  [L_ADDRESS3] [VARCHAR](100)   NULL,        
  [L_CITY]     [VARCHAR](50)   NULL,        
  [L_ZIP]      [VARCHAR](25)   NULL,        
  [RES_PHONE1] [VARCHAR](15)   NULL,        
  [BRANCH_CD]  [VARCHAR](10)   NULL,        
  [CROSAC]     [VARCHAR](10)   NULL,        
  [EDIFF]      [INT]   NULL,        
  [FAMILY]     [VARCHAR](10)   NULL,        
  [SUB_BROKER] [VARCHAR](10)   NULL,        
  [TRADER]     [VARCHAR](20)   NULL,        
  [CL_TYPE]    [VARCHAR](3)   NULL,        
  [BANK_NAME]  [VARCHAR](100)   NULL,        
  [CLTDPID]    [VARCHAR](16)   NULL,        
  [LNO]        [INT]    NULL,        
  [PDT]        [DATETIME]   NULL,        
  [EXCHANGE] [VARCHAR] (15) NULL,        
  [SEGMENT]    [VARCHAR](10)   NULL,        
  [ENTITY]     [VARCHAR](50)   NULL,        
  [ORDERSEG]   [BIGINT]   NULL,        
  [ACTIVE_SEG] [VARCHAR] (MAX),        
  [PARTYROWCOUNT] [INT] NULL,        
  [TOTALPAGES] [INT] NULL        
      )        
    ON [PRIMARY]        
        
 CREATE TABLE [DBO].[#DBNAME]            
 (            
  ACCOUNTDB VARCHAR(20),             
  EXCHANGE VARCHAR(6),             
  SEGMENT VARCHAR(10),            
  ACCOUNTSERVER VARCHAR(20),          
  SHAREDB VARCHAR(20),        
  GROUPID VARCHAR(20),        
  ORDER_SEGMENT INT          
 ) ON [PRIMARY]          
DECLARE  @@DB VARCHAR(1000)        
        
IF @EXCSEGMENT = ''        
 SELECT @EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM OWNER        
        
IF @ENTITY_TYPE = 'ENTITY'         
 SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE "            
ELSE        
 SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE GROUPID IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY GROUPID "            
   
--   SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING      

PRINT @@DB        
EXEC(@@DB)          
        
DECLARE @@MAINREC AS CURSOR,        
  @@ACCOUNTDB VARCHAR(20),          
  @@SHAREDB VARCHAR(20),             
  @@ACCOUNTSVR VARCHAR(20),            
  @@EXCHANGE VARCHAR(15),            
  @@SEGMENT VARCHAR(15),        
  @@GROUPID VARCHAR(20),        
  @@ORDERSEG VARCHAR(3),        
  @@ORDERSECOUNT INT        
SET @@ORDERSECOUNT = (SELECT COUNT(1) FROM COMPANY_MASTER_SETTING)         
        
DECLARE @@SQL VARCHAR(MAX)        
--SET @@SQL = ""        
SET @@MAINREC = CURSOR FOR            
     SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME           
             
OPEN @@MAINREC            
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG            
  WHILE @@FETCH_STATUS = 0            
  BEGIN           
  PRINT @@ACCOUNTDB        
 IF @BALTYPE = 'VDTBAL' OR @BALTYPE = 'EDTBAL' OR @BALTYPE = 'UNREALIZED' OR @BALTYPE = ''
 BEGIN 
	 SET @@SQL = " INSERT INTO #TMPLEDGERNEW "        
	 SET @@SQL = @@SQL + " (BOOKTYPE, "        
	 SET @@SQL = @@SQL +" VOUDT, "        
	 SET @@SQL = @@SQL +" EFFDT, "        
	 SET @@SQL = @@SQL +" SHORTDESC, "        
	 SET @@SQL = @@SQL +" DRAMT, "        
	 SET @@SQL = @@SQL +" CRAMT, "        
	 SET @@SQL = @@SQL +" VNO, "        
	 SET @@SQL = @@SQL +" DDNO, "        
	 SET @@SQL = @@SQL +" NARRATION, "        
	 SET @@SQL = @@SQL +" CLTCODE, "        
	 SET @@SQL = @@SQL +" VTYP, "        
	 SET @@SQL = @@SQL +" VDT, "        
	 SET @@SQL = @@SQL +" EDT, "        
	 SET @@SQL = @@SQL +" ACNAME, "        
	 SET @@SQL = @@SQL +" OPBAL, "        
	 SET @@SQL = @@SQL +" L_ADDRESS1, "        
	 SET @@SQL = @@SQL +" L_ADDRESS2, "        
	 SET @@SQL = @@SQL +" L_ADDRESS3, "        
	 SET @@SQL = @@SQL +" L_CITY, "        
	 SET @@SQL = @@SQL +" L_ZIP, "        
	 SET @@SQL = @@SQL +" RES_PHONE1, "        
	 SET @@SQL = @@SQL +" BRANCH_CD, "        
	 SET @@SQL = @@SQL +" CROSAC, "        
	 SET @@SQL = @@SQL +" EDIFF, "        
	 SET @@SQL = @@SQL +" FAMILY, "        
	 SET @@SQL = @@SQL +" SUB_BROKER, "        
	 SET @@SQL = @@SQL +" TRADER, "        
	 SET @@SQL = @@SQL +" CL_TYPE, "        
	 SET @@SQL = @@SQL +" BANK_NAME, "        
	 SET @@SQL = @@SQL +" CLTDPID, "        
	 SET @@SQL = @@SQL +" LNO, "        
	 SET @@SQL = @@SQL +" PDT) "        
	 IF @@SERVERNAME <> @@ACCOUNTSVR        
	 SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTSVR+"."+@@ACCOUNTDB+"..V2_RPT_ACC_PARTYLEDGER_TEST "        
	 ELSE        
	 SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTDB+"..V2_RPT_ACC_PARTYLEDGER_TEST "        
	 SET @@SQL = @@SQL +"'" +@fdate +"', "        
	 SET @@SQL = @@SQL +"'" +@tdate +"', "        
	 SET @@SQL = @@SQL +"'" +@fcode +"', "        
	 SET @@SQL = @@SQL +"'" +@tcode +"', "        
	 SET @@SQL = @@SQL +"'" +@strorder +"', "        
	 SET @@SQL = @@SQL +"'" +@selectby +"', "        
	 SET @@SQL = @@SQL +"'" +@statusid +"', "        
	 SET @@SQL = @@SQL +"'" +@statusname+"', "        
	 SET @@SQL = @@SQL +"'" +@statusname_to+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY_LIST+"' "        
		--return        
	        
	print (@@SQL)         
	EXEC (@@SQL)    
	
	IF @ORDERFLG = 'N'        
    BEGIN        
    UPDATE #TMPLEDGERNEW         
    SET EXCHANGE = @@EXCHANGE,         
     SEGMENT = @@SEGMENT,        
      ENTITY = 'SETTLEMENT LEDGER',        
     ORDERSEG = 1         
    WHERE  SEGMENT IS NULL         
  END         
  ELSE         
   BEGIN        
   UPDATE #TMPLEDGERNEW         
      SET  EXCHANGE = @@EXCHANGE,        
       SEGMENT =@@SEGMENT,        
       ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN @@SEGMENT +"-"+ @@EXCHANGE ELSE @@GROUPID + ' - SETTLEMENT LEDGER' END,        
       ORDERSEG = @@ORDERSEG         
    WHERE  SEGMENT IS NULL         
	END         
           
END
        
IF @BALTYPE = 'MARGINBAL' OR @BALTYPE = ''   
BEGIN
	SET @@SQL = "  INSERT INTO #TMPLEDGERNEW "        
	SET @@SQL = @@SQL + " (BOOKTYPE, "        
	SET @@SQL = @@SQL + "  VOUDT, "        
	SET @@SQL = @@SQL + "  EFFDT, "        
	SET @@SQL = @@SQL + "  SHORTDESC, "        
	SET @@SQL = @@SQL + "  DRAMT, "        
	SET @@SQL = @@SQL + "  CRAMT, "        
	SET @@SQL = @@SQL + "  VNO, "        
	SET @@SQL = @@SQL + "  DDNO, "        
	SET @@SQL = @@SQL + "  NARRATION, "        
	SET @@SQL = @@SQL + "  CLTCODE, "        
	SET @@SQL = @@SQL + "  VTYP, "        
	SET @@SQL = @@SQL + "  VDT, "        
	SET @@SQL = @@SQL + "  EDT, "        
	SET @@SQL = @@SQL + "  ACNAME, "        
	SET @@SQL = @@SQL + "  OPBAL, "        
	SET @@SQL = @@SQL + "  L_ADDRESS1, "        
	SET @@SQL = @@SQL + "  L_ADDRESS2, "        
	SET @@SQL = @@SQL + "  L_ADDRESS3, "        
	SET @@SQL = @@SQL + "  L_CITY, "        
	SET @@SQL = @@SQL + "  L_ZIP, "        
	SET @@SQL = @@SQL + "  RES_PHONE1, "        
	SET @@SQL = @@SQL + "  BRANCH_CD, "        
	SET @@SQL = @@SQL + "  CROSAC, "        
	SET @@SQL = @@SQL + "  EDIFF, "        
	SET @@SQL = @@SQL + "  FAMILY, "        
	SET @@SQL = @@SQL + "  SUB_BROKER, "        
	SET @@SQL = @@SQL + "  TRADER, "        
	SET @@SQL = @@SQL + "  CL_TYPE, "        
	SET @@SQL = @@SQL + "  BANK_NAME, "        
	SET @@SQL = @@SQL + "  CLTDPID, "        
	SET @@SQL = @@SQL + "  LNO, "        
	SET @@SQL = @@SQL + "  PDT) "        
	IF @@SERVERNAME <> @@ACCOUNTSVR        
	SET @@SQL = @@SQL + "    EXEC "+ @@ACCOUNTSVR +"."+@@ACCOUNTDB+"..V2_RPT_ACC_MARGINLEDGER_TEST "        
	ELSE        
	SET @@SQL = @@SQL + "    EXEC "+@@ACCOUNTDB+"..V2_RPT_ACC_MARGINLEDGER_TEST "        
	SET @@SQL = @@SQL +"'" + @fdate +"', "        
	SET @@SQL = @@SQL +"'" + @tdate +"', "        
	SET @@SQL = @@SQL +"'" + @fcode +"', "        
	SET @@SQL = @@SQL +"'" + @tcode +"', "        
	SET @@SQL = @@SQL +"'" + @strorder +"', "        
	SET @@SQL = @@SQL +"'" + @selectby +"', "        
	SET @@SQL = @@SQL +"'" + @statusid +"', "        
	SET @@SQL = @@SQL +"'" + @statusname +"', "        
	SET @@SQL = @@SQL +"'" +@statusname_to+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY+"', "        
	SET @@SQL = @@SQL +"'" +@ENTITY_LIST+"' "                
	IF @SHOWMARGIN = 1 
	BEGIN
		PRINT(@@SQL)      
		EXEC (@@SQL)						
	END
		IF @ORDERFLG = 'N'        
		  BEGIN        
	  UPDATE #TMPLEDGERNEW         
	   SET   EXCHANGE =@@EXCHANGE,        
	   SEGMENT = @@SEGMENT ,        
	   ENTITY = 'MARGIN  LEDGER',         
	   ORDERSEG = 2         
	  WHERE SEGMENT IS NULL         
		  END        
		ELSE        
		  BEGIN        
	  UPDATE #TMPLEDGERNEW         
	   SET    EXCHANGE = @@EXCHANGE,        
	   SEGMENT = @@SEGMENT,        
	   ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY' THEN 'MARGIN-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN LEDGER' END,        
	   --IF @@ACCOUNTDB = 'ACCOUNT'        
	   -- SET @@SQL = @@SQL + "        ORDERSEG = 4"        
	   --ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'        
	   -- SET @@SQL = @@SQL + "        ORDERSEG = 5"        
	   --ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'        
	   -- SET @@SQL = @@SQL + "        ORDERSEG = 6"        
	            
	   ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT        
	  WHERE  SEGMENT IS NULL         
	 END       
 END 
         
        
FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB ,@@GROUPID, @@ORDERSEG           
END        
CLOSE @@MAINREC        
DEALLOCATE @@MAINREC        
        
--IF ((SELECT COUNT(1) FROM [#DBNAME] WHERE ACCOUNTDB = 'ACCOUNTFO') = 1)        
--BEGIN        
--    INSERT INTO #TMPLEDGERNEW        
--              (VOUDT,        
--               EFFDT,        
--               SHORTDESC,        
--               DRAMT,        
--               CRAMT,        
--               VNO,        
--               DDNO,        
--               NARRATION,        
--               CLTCODE,        
--               VTYP,        
--               VDT,        
--             EDT)        
--    EXEC BSEFO.DBO.V2_GETMARGINREQ        
--      @TDATE ,        
--      @FCODE ,        
--      @TCODE ,        
--  @STATUSID ,        
--      @STATUSNAME ,        
--      @STRBRANCH        
         
              
--        UPDATE #TMPLEDGERNEW        
--        SET    EXCHANGE = 'NSE',        
--          SEGMENT = 'FUTURES',        
--               ENTITY = 'MARGIN REQ - NFO',        
--               ORDERSEG = (@@ORDERSECOUNT * 2)+ 1        
--        WHERE  SEGMENT IS NULL        
              
--END        
        
    IF @ORDERFLG = 'N'        
      BEGIN        
        SELECT   CLTCODE,        
				 EXCHANGE,        
				 SEGMENT,        
                 ORDERSEG,        
                 OPBAL = MAX(OPBAL)        
        INTO     #OPBAL        
        FROM     #TMPLEDGERNEW        
        GROUP BY CLTCODE,EXCHANGE,SEGMENT,ORDERSEG        
        
        
        SELECT   CLTCODE,        
                 ORDERSEG,        
                 OPBAL = SUM(OPBAL),
				 EXCHANGE = MAX(EXCHANGE),
				 SEGMENT = MAX(SEGMENT)        
        INTO     #FINOPBAL        
        FROM     #OPBAL        
        GROUP BY CLTCODE,ORDERSEG        
        
        UPDATE #TMPLEDGERNEW        
        SET    OPBAL = 0        
        
        UPDATE #TMPLEDGERNEW        
        SET    OPBAL = ISNULL(T.OPBAL,0)        
        FROM   #TMPLEDGERNEW L WITH (NoLock),        
               #FINOPBAL T WITH (NoLock)        
        WHERE          
			L.CLTCODE = T.CLTCODE                             
			AND L.ORDERSEG = T.ORDERSEG

--		DELETE T
--		FROM #TMPLEDGERNEW T WHERE NARRATION = 'OPENING BALANCE' AND NOT EXISTS(SELECT CLTCODE FROM  #FINOPBAL O WHERE T.CLTCODE = O.CLTCODE AND T.EXCHANGE = O.EXCHANGE AND T.SEGMENT = O.SEGMENT)
      END        
      --UPDATE #TMPLEDGERNEW SET ACTIVE_SEG = 'NSE,BSE,FNO,COMMODITY'        

IF @ORDERFLG = 'Y'        
BEGIN                
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'OPBAL', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END, CRAMT = CASE WHEN MAX(OPBAL) < 0 THEN MAX(ABS(OPBAL)) ELSE 0 END, 'OPENING BALANCE', CLTCODE, 18, @YEAR_START, @YEAR_START, ACNAME, MAX(-OPBAL), @YEAR_START, EXCHANGE, SEGMENT, ENTITY,  
	ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_START), EFFDT = CONVERT(DATETIME, @YEAR_START), CLTCODE    
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG      
	--HAVING CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END <> 0 OR CASE WHEN MAX(OPBAL) < 0 THEN MAX(OPBAL) ELSE 0 END <> 0    
END 
ELSE
BEGIN
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'OPBAL', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END, CRAMT = CASE WHEN MAX(OPBAL) < 0 THEN MAX(ABS(OPBAL)) ELSE 0 END, 'OPENING BALANCE', CLTCODE, 18, @YEAR_START, @YEAR_START, ACNAME, MAX(-OPBAL), @YEAR_START, MAX(EXCHANGE), MAX(SEGMENT), ENTITY,  
	ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_START), EFFDT = CONVERT(DATETIME, @YEAR_START), CLTCODE
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, ENTITY, ORDERSEG, ACTIVE_SEG      
	--HAVING CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END <> 0 OR CASE WHEN MAX(OPBAL) < 0 THEN MAX(OPBAL) ELSE 0 END <> 0    
END
    
 --select * from #TMPLEDGERNEW      
--return      
 DELETE FROM #TMPLEDGERNEW WHERE VTYP = 18 /*AND ISNULL(NARRATION, '') <> 'OPENING BALANCE'*/ AND ISNULL(SHORTDESC, '') <> 'OPBAL'    
    
/*SELECT * FROM #TMPLEDGERNEW T,    
(SELECT CLTCODE, COUNT(1) #TMPLEDGERNEW    
GROUP BY CLTCODE    
HAVING COUNT(1) = 1)    
WHERE T.CLTCODE = T1.CLTCODE AND T.DRAMT = 0 AND T.CRAMT = 0*/    

IF @ORDERFLG = 'Y'        
BEGIN                    
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'TBAL', DRAMT = SUM(DRAMT), CRAMT = CASE WHEN SUM(CRAMT) < 0 THEN -SUM(CRAMT) ELSE SUM(CRAMT) END,     
	'TOTAL BALANCE', CLTCODE, 99, @YEAR_END, @YEAR_END, ACNAME, MAX(OPBAL), @YEAR_END, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_END), EFFDT = CONVERT(DATETIME, @YEAR_END), CLTCODE    
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG     
END
ELSE
BEGIN
	INSERT INTO #TMPLEDGERNEW(SHORTDESC, DRAMT, CRAMT, NARRATION, CLTCODE, VTYP, VDT, EDT, ACNAME, OPBAL, PDT, EXCHANGE, SEGMENT, ENTITY, ORDERSEG, ACTIVE_SEG, VOUDT, EFFDT, CROSAC)    
	SELECT 'TBAL', DRAMT = SUM(DRAMT), CRAMT = CASE WHEN SUM(CRAMT) < 0 THEN -SUM(CRAMT) ELSE SUM(CRAMT) END,     
	'TOTAL BALANCE', CLTCODE, 99, @YEAR_END, @YEAR_END, ACNAME, MAX(OPBAL), @YEAR_END, EXCHANGE = MAX(EXCHANGE), SEGMENT = MAX(SEGMENT), ENTITY, ORDERSEG, ACTIVE_SEG,    
	VOUDT = CONVERT(DATETIME, @YEAR_END), EFFDT = CONVERT(DATETIME, @YEAR_END), CLTCODE
	FROM #TMPLEDGERNEW    
	GROUP BY CLTCODE, ACNAME, ENTITY, ORDERSEG, ACTIVE_SEG     
END
           
 IF @FORPDF = 'Y'        
  BEGIN        
   ALTER TABLE #TMPLEDGERNEW ADD PDFLINES INT        
   UPDATE #TMPLEDGERNEW SET PDFLINES = LEN(LTRIM(RTRIM(ISNULL(NARRATION, '')))) / 35 + 1 WHERE VTYP <> '18'        
   UPDATE #TMPLEDGERNEW SET PDFLINES = (I.LNO + 1) FROM (SELECT CLTCODE, LNO = SUM(PDFLINES) FROM #TMPLEDGERNEW GROUP BY CLTCODE) I        
     WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE        
        
        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = CEILING(CONVERT(NUMERIC(10,2), LEN(ISNULL(NARRATION, ''))) / 35)        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = 1 WHERE LEN(ISNULL(NARRATION, '')) = 0        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = (SELECT SUM(PARTYROWCOUNT) /*+ COUNT(DISTINCT ORDERSEG)*/ FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)        
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = PARTYROWCOUNT + (SELECT (COUNT(DISTINCT ORDERSEG) * 1) + 1 FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)        
   UPDATE #TMPLEDGERNEW SET TOTALPAGES = .dbo.PARTYLEDGERPAGES(PARTYROWCOUNT)        
        
        
  END        
        
        
--  BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
      
      
IF @CSV = 'Y'      
BEGIN      
CREATE TABLE #PARTYLEDGERCSV      
(      
 CLTCODE VARCHAR(10),      
 VOUCHER_DATE VARCHAR(10),       
 EFFECTIVE_DATE VARCHAR(10),       
 VTYPE VARCHAR(15),       
 VNO VARCHAR(15),       
 AC_CODE VARCHAR(10),       
 PERTIULARS VARCHAR(500),       
 DDNO VARCHAR(20),       
 DRAMT MONEY,       
 CRAMT MONEY,      
 ENTITY     VARCHAR(50),        
 ORDERSEG   BIGINT,        
 BALANCE MONEY,      
 SNO INT IDENTITY(1, 1)      
)      
      
 INSERT INTO #PARTYLEDGERCSV      
 (      
  CLTCODE, VOUCHER_DATE, EFFECTIVE_DATE, VTYPE, VNO, AC_CODE,       
  PERTIULARS, DDNO, DRAMT, CRAMT, ENTITY, ORDERSEG      
 )      
 SELECT       
  CLTCODE, VOUCHER_DATE = '', EFFECTIVE_DATE = '', VTYPE = 'OPENING', VNO = '', AC_CODE = CLTCODE,       
  PERTIULARS = 'OPENING ENTRY', DDNO = '', DRAMT = CASE WHEN MAX(OPBAL) > 0 THEN MAX(OPBAL) ELSE 0 END,       
  CRAMT = CASE WHEN MAX(OPBAL) <= 0 THEN MAX(OPBAL) ELSE 0 END, ENTITY, ORDERSEG      
 FROM           
  #TMPLEDGERNEW      
 GROUP BY      
  CLTCODE, ENTITY, ORDERSEG      
 ORDER BY       
  CLTCODE,        
  ORDERSEG      
      
 INSERT INTO #PARTYLEDGERCSV      
 (      
  CLTCODE, VOUCHER_DATE, EFFECTIVE_DATE, VTYPE, VNO, AC_CODE,       
  PERTIULARS, DDNO, DRAMT, CRAMT, ENTITY, ORDERSEG      
 )      
 SELECT       
  CLTCODE, VOUCHER_DATE = VOUDT, EFFECTIVE_DATE = EFFDT, VTYPE = SHORTDESC, VNO, AC_CODE = CASE WHEN SHORTDESC = 'OPBAL ' THEN CLTCODE ELSE CROSAC END,       
  PERTIULARS = NARRATION, DDNO, DRAMT, CRAMT, ENTITY, ORDERSEG      
 FROM           
  #TMPLEDGERNEW      
 WHERE       
    VOUDT IS NOT NULL      
 ORDER BY       
  CLTCODE,        
  ORDERSEG,        
  VOUDT        
        
 UPDATE P      
 SET BALANCE = (SELECT SUM(DRAMT - CRAMT) FROM #PARTYLEDGERCSV P1
  WHERE P.CLTCODE = P1.CLTCODE AND P.ENTITY = P1.ENTITY AND P.ORDERSEG = P1.ORDERSEG AND P.SNO <= P1.SNO)      
 FROM #PARTYLEDGERCSV P      
       
 SELECT * FROM #PARTYLEDGERCSV ORDER BY CLTCODE, ORDERSEG, SNO      

RETURN
       
END      
    
	--IF @VTYPE <> ''
	--BEGIN
	--	delete from #TMPLEDGERNEW where  VTYP <> @VTYPE
	--END

    IF @strorder = 'ACCODE'        
      BEGIN        
        IF @selectby = 'vdt'        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
            
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         VOUDT, VNO        
              END        
            ELSE        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         VOUDT, VNO        
              END        
          END        
        ELSE        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         EFFDT        
              END        
            ELSE        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY CLTCODE,        
                         ORDERSEG,        
                         EFFDT        
              END        
          END        
      END        
  ELSE        
 BEGIN        
 IF @selectby = 'vdt'        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW T        
                ORDER BY ACNAME,        
                         ORDERSEG,        
                         VOUDT, VNO        
              END        
            ELSE        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY ACNAME,        
                         ORDERSEG,        
                         VOUDT, VNO        
              END        
          END        
        ELSE        
          BEGIN        
            IF @ORDERFLG = 'N'        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY ACNAME,        
                         ORDERSEG,        
                         EFFDT        
              END        
            ELSE        
              BEGIN        
                SELECT   BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,VTYP,CONVERT(VARCHAR(11),VDT,103) AS VDT ,CONVERT(VARCHAR(11),EDT,103) AS EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO,PDT,EXCHANGE,SEGMENT,ENTITY,ORDERSEG,ACTIVE_SEG,PARTYROWCOUNT,TOTALPAGES      
                FROM     #TMPLEDGERNEW        
                ORDER BY ACNAME,        
                         ORDERSEG,        
                         EFFDT        
              END        
          END        
      END        
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCBBREPORT_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCBBREPORT_REV_TEST
-- --------------------------------------------------


  CREATE PROC [dbo].[RPT_ACCBBREPORT_REV_TEST]
(
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@FCODE [UDTPARTYCODE],
	@TCODE [UDTPARTYCODE],
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@BRANCHCODE [UDTBRANCHCODE],
	@SELECTON VARCHAR(3),
	@EXCHANGE [UDTEXCHANGE],
	@SEGMENT [UDTSEGMENT]
)
AS
/*
	EXEC RPT_ACCBBREPORT_REV_TEST 'APR  1 2009', 'MAR 31 2010', '03013n', '03013n', 'BROKER', 'BROKER', '', 'VDT', 'nse', 'mfss'
*/
IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'
	BEGIN
		RAISERROR('This Report is not available for your type of Login', 16, 1)
		RETURN
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
	BEGIN
		SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
	END
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
	BEGIN
		SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
	END
DECLARE
	@YEARSTART VARCHAR(11),
	@YEAREND VARCHAR(11)
SELECT
	@YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),
	@YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)
FROM
	PARAMETER
WHERE
	@FDATE BETWEEN SDTCUR AND LDTCUR
	AND @TDATE BETWEEN SDTCUR AND LDTCUR

IF @YEARSTART IS NULL OR @YEAREND IS NULL
	BEGIN
		RAISERROR('Invalid Financial Information...', 16, 1)
		RETURN
	END

CREATE TABLE #TBL_GLREPORT
(
	SRNO INT IDENTITY(1,1) NOT NULL
)
EXEC MAKE_UDT_STRUCTURE
	'#TBL_GLREPORT',
	'BOOKTYPE|VOUDT|EFFDT|SHORTDESC|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|PROCID|REPDATE|MAINCODE|VCHDT|ENTITY|MASTERSNO',
	'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT|VARCHAR|UDTPARTYCODE|DATETIME|VARCHAR|BIGINT',
	'|10|10|6|||||||||||||||35||8|||25|',
	'0|0|0|1|0|0|0|0|0|1|0|0|0|1|0|1|1|0|0|0|0|0|0|0|0'
--CREATE TABLE #TBL_GLREPORT
--(
--	SRNO INT IDENTITY (1, 1) NOT NULL,
--	BOOKTYPE [UDTBOOKTYPE] NULL,
--	VOUDT VARCHAR(10) NULL,
--	EFFDT VARCHAR(10) NULL,
--	SHORTDESC CHAR (6) NOT NULL DEFAULT(' '),
--	DRAMT MONEY NULL,
--	CRAMT MONEY NULL,
--	VNO [UDTVNO] NULL,
--	NARRATION [UDTNARRATION] NULL,
--	DDNO [UDTINSTNO] NULL,
--	CLTCODE [UDTPARTYCODE] NOT NULL,
--	LONGNAME [UDTACNAME] NULL,
--	VDT DATETIME NULL,
--	EDT DATETIME NULL,
--	VTYP [UDTVTYPE] NOT NULL,
--	ACCAT [UDTACCAT] NULL,
--	OPBAL MONEY NOT NULL,
--	CROSAC [UDTPARTYCODE] NOT NULL,
--	ACNAME [UDTACNAME] NULL,
--	BRANCHCODE VARCHAR (35) NULL,
--	PROCID BIGINT NULL,
--	REPDATE VARCHAR (8) NULL,
--	MAINCODE [UDTPARTYCODE] NULL,
--	VCHDT DATETIME NULL,
--	ENTITY VARCHAR(25),
--	MASTERSNO BIGINT
--)
IF @SELECTON = 'VDT'
	BEGIN
		INSERT INTO #TBL_GLREPORT
		(
			BOOKTYPE,
			VOUDT,
			EFFDT,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			PROCID,
			REPDATE,
			MAINCODE,
			VCHDT,
			ENTITY,
			MASTERSNO
		)
		SELECT
			BOOKTYPE = '',
			VOUDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = 'CLBAL',
			DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) < 0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,
			CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,
			VNO = '',
			NARRATION = 'CLOSING BALANCE',
			DDNO = '',
			CLTCODE,
			LONGNAME = ACNAME,
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = 0,
			ACCAT = 2,
			OPBAL = 0,
			CROSAC = CLTCODE,
			ACNAME = ACNAME,
			BRANCHCODE = CASE WHEN @BRANCHCODE <> '' OR @BRANCHCODE <> 'ALL' THEN @BRANCHCODE ELSE '' END,
			PROCID = @@SPID,
			REPDATE = CONVERT(VARCHAR(8), GETDATE(), 112),
			MAINCODE = '',
			VCHDT = '',
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			MASTERSNO = 0
		FROM
			ACC_LEDGER_GL
		WHERE
			EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			AND	CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT <= @TDATE + ' 23:59'
			AND VDT >= @YEARSTART
			AND ACCAT = 2
			AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
			AND @STATUSNAME = 
						(
							CASE @STATUSID
								WHEN 'BRANCH' THEN BRANCHCODE
							ELSE
								'BROKER'
							END
						)
		GROUP BY
			CLTCODE,
			ACNAME
	END
ELSE
	BEGIN
		INSERT INTO #TBL_GLREPORT
		(
			BOOKTYPE,
			VOUDT,
			EFFDT,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			PROCID,
			REPDATE,
			MAINCODE,
			VCHDT,
			ENTITY,
			MASTERSNO
		)
		SELECT 
			BOOKTYPE = '',
			VOUDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = 'CLBAL',
			DRAMT = CASE WHEN SUM(A.BALANCE) >= 0 THEN SUM(A.BALANCE) ELSE 0 END,
			CRAMT = CASE WHEN SUM(A.BALANCE) < 0 THEN ABS(SUM(A.BALANCE)) ELSE 0 END,
			VNO = '',
			NARRATION = 'CLOSING BALANCE',
			DDNO = '',
			A.CLTCODE,
			LONGNAME = A.ACNAME,
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = 0,
			ACCAT = 2,
			OPBAL = 0,
			CROSAC = CLTCODE,
			ACNAME = A.ACNAME,
			BRANCHCODE = CASE WHEN @BRANCHCODE <> '' OR @BRANCHCODE <> 'ALL'THEN @BRANCHCODE ELSE '' END,
			PROCID = @@SPID,
			REPDATE = CONVERT(VARCHAR(8), GETDATE(), 112),
			MAINCODE = '',
			VCHDT = '',
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			MASTERSNO = 0
		FROM
			(
				SELECT
					CLTCODE,
					ACNAME,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT)
				FROM
					ACC_LEDGER_GL
				WHERE
					EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					AND	CLTCODE BETWEEN @FCODE AND @TCODE
					AND EDT <= @TDATE + ' 23:59'
					AND EDT >= @YEARSTART
					AND ACCAT = 2
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
					AND @STATUSNAME = 
								(
									CASE @STATUSID
										WHEN 'BRANCH' THEN BRANCHCODE
									ELSE
										'BROKER'
									END
								)
				GROUP BY
					CLTCODE,
					ACNAME
				UNION ALL
				SELECT
					CLTCODE,
					ACNAME,
					BALANCE = SUM(CRAMOUNT - DRAMOUNT)
				FROM
					ACC_LEDGER_GL
				WHERE
					EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					AND	CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT < @YEARSTART
					AND EDT >= @YEARSTART
					AND ACCAT = 2
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
					AND @STATUSNAME = 
								(
									CASE @STATUSID
										WHEN 'BRANCH' THEN BRANCHCODE
									ELSE
										'BROKER'
									END
								)
				GROUP BY
					CLTCODE,
					ACNAME
			) A
		GROUP BY
			A.CLTCODE,
			A.ACNAME
	END
INSERT INTO #TBL_GLREPORT
(
	BOOKTYPE,
	VOUDT,
	EFFDT,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	PROCID,
	REPDATE,
	MAINCODE,
	VCHDT,
	ENTITY,
	MASTERSNO
)
SELECT
	BOOKTYPE,
	VOUDT = VDT_C,
	EFFDT = EDT_C,
	SHORTDESC = '',
	DRAMT = SUM(CRAMOUNT),
	CRAMT = SUM(DRAMOUNT),
	VNO,
	NARRATION = MAX(NARRATION),
	DDNO = ISNULL(INSTNO, ''),
	CLTCODE = OPPACCOUNT,
	LONGNAME = '',
	VDT,
	EDT,
	VTYP = MAX(VTYPE),
	ACCAT = 2,
	OPBAL = 0,
	CROSAC = CLTCODE,
	ACNAME = '',
	BRANCHCODE = CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END,
	PROCID = @@SPID,
	REPDATE = CONVERT(VARCHAR(8), GETDATE(), 112),
	MAINCODE = OPPACCOUNT,
	VCHDT = VDT,
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	MASTERSNO
FROM
	ACC_LEDGER
WHERE
	EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	AND OPPACCOUNT BETWEEN @FCODE AND @TCODE
	AND VTYPE <> 18
	AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%'  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
	AND @STATUSNAME = 
				(
					CASE @STATUSID
						WHEN 'BRANCH' THEN BRANCHCODE
					ELSE
						'BROKER'
					END
				)
	AND ACCAT <> 2
GROUP BY
	BOOKTYPE,
	VDT_C,
	EDT_C,
	VNO,
	ISNULL(INSTNO, ''),
	OPPACCOUNT,
	VDT,
	EDT,
	CLTCODE,
	CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END,
	MASTERSNO
ORDER BY
	OPPACCOUNT,
	CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
	BOOKTYPE,
	VTYP,
	VNO
INSERT INTO #TBL_GLREPORT
(
	BOOKTYPE,
	VOUDT,
	EFFDT,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	PROCID,
	REPDATE,
	MAINCODE,
	VCHDT,
	ENTITY,
	MASTERSNO
)
SELECT
	BOOKTYPE,
	VOUDT = VDT_C,
	EFFDT = EDT_C,
	SHORTDESC = '',
	DRAMT = SUM(CRAMOUNT),
	CRAMT = SUM(DRAMOUNT),
	VNO,
	NARRATION = MAX(NARRATION),
	DDNO = ISNULL(INSTNO, ''),
	CLTCODE = OPPACCOUNT,
	LONGNAME = '',
	VDT,
	EDT,
	VTYP = MAX(VTYPE),
	ACCAT = 2,
	OPBAL = 0,
	CROSAC = CLTCODE,
	ACNAME = '',
	BRANCHCODE = CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END,
	PROCID = @@SPID,
	REPDATE = CONVERT(VARCHAR(8), GETDATE(), 112),
	MAINCODE = OPPACCOUNT,
	VCHDT = VDT,
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	MASTERSNO
FROM
	ACC_LEDGER
WHERE
	EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	AND OPPACCOUNT BETWEEN @FCODE AND @TCODE
	AND VTYPE = 5
	AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%'  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
	AND @STATUSNAME = 
				(
					CASE @STATUSID
						WHEN 'BRANCH' THEN BRANCHCODE
					ELSE
						'BROKER'
					END
				)
	AND ACCAT = 2
GROUP BY
	BOOKTYPE,
	VDT_C,
	EDT_C,
	VNO,
	ISNULL(INSTNO, ''),
	OPPACCOUNT,
	VDT,
	EDT,
	CLTCODE,
	CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END,
	MASTERSNO
ORDER BY
	OPPACCOUNT,
	CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
	BOOKTYPE,
	VTYP,
	VNO


INSERT INTO #TBL_GLREPORT
(
	BOOKTYPE,
	VOUDT,
	EFFDT,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	PROCID,
	REPDATE,
	MAINCODE,
	VCHDT,
	ENTITY,
	MASTERSNO
)
SELECT
	BOOKTYPE = '01',
	VOUDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = 'OPENT',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = 'OPENING BALANCE',
	DDNO = '',
	CLTCODE,
	LONGNAME,
	VDT = @FDATE,
	EDT = @FDATE,
	VTYP = 18,
	ACCAT = 2,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = CASE WHEN @BRANCHCODE = ''  OR @BRANCHCODE = 'ALL'  THEN BRANCHCODE ELSE @BRANCHCODE END,
	PROCID = @@SPID,
	REPDATE = CONVERT(VARCHAR(8), GETDATE(), 112),
	MAINCODE = CLTCODE,
	VCHDT = '',
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	MASTERSNO = 0
FROM
	#TBL_GLREPORT
WHERE
	VTYP = 0
GROUP BY
	CLTCODE,
	LONGNAME,
	CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = 'ALL'  THEN BRANCHCODE ELSE @BRANCHCODE END

UPDATE #TBL_GLREPORT
SET
	LONGNAME = A.ACNAME
FROM
	ACMAST A
WHERE
	#TBL_GLREPORT.CLTCODE = A.CLTCODE

IF @BRANCHCODE = '' OR @BRANCHCODE = 'ALL'
	BEGIN
		UPDATE #TBL_GLREPORT
		SET
			BRANCHCODE = A.BRANCHCODE
		FROM
			ACMAST A
		WHERE
			#TBL_GLREPORT.CLTCODE = A.CLTCODE
	END

UPDATE #TBL_GLREPORT
SET
	CRAMT = CASE WHEN (S.DRAMT - S.CRAMT) >= 0 THEN (S.DRAMT - S.CRAMT) ELSE 0 END,
	DRAMT = CASE WHEN (S.DRAMT - S.CRAMT) < 0 THEN ABS(S.DRAMT - S.CRAMT) ELSE 0 END
FROM
	(
		SELECT
			CLTCODE,
			DRAMT = SUM(CASE WHEN VTYP = 0 THEN CRAMT ELSE DRAMT END),
			CRAMT = SUM(CASE WHEN VTYP = 0 THEN DRAMT ELSE CRAMT END)
		FROM
			#TBL_GLREPORT
		GROUP BY
			CLTCODE
	) S
WHERE
	#TBL_GLREPORT.CLTCODE = S.CLTCODE
	AND #TBL_GLREPORT.VTYP = 18
SELECT *, RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TBL_GLREPORT I WHERE I.CLTCODE = #TBL_GLREPORT.CLTCODE AND I.SRNO >= #TBL_GLREPORT.SRNO AND #TBL_GLREPORT.VTYP <> 0), 0) FROM #TBL_GLREPORT ORDER BY CLTCODE, SRNO
--SELECT
--	VOUDT,
--	VTYP = SHORTDESC,
--	VNO,
--	CROSAC,
--	NARRATION,
--	DDNO,
--	DRAMT,
--	CRAMT,
--	RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TBL_GLREPORT I WHERE I.CLTCODE = #TBL_GLREPORT.CLTCODE AND I.SRNO >= #TBL_GLREPORT.SRNO AND #TBL_GLREPORT.VTYP <> 0), 0),
--	CLTCODE,
--	ACNAME
--FROM
--	#TBL_GLREPORT
--ORDER BY
--	CLTCODE,
--	SRNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCBOOKSREPORT_SUM_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCCBREPORT_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCGLREPORT_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCGLREPORT_REV_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_ACCGLREPORT_REV_NEW]
(
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@FCODE [UDTPARTYCODE],
	@TCODE [UDTPARTYCODE],
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@BRANCHCODE [UDTBRANCHCODE],
	@SELECTON VARCHAR(3),
	@SORTON VARCHAR(3),
	@EXCHANGE [UDTEXCHANGE],
	@SEGMENT [UDTSEGMENT]
)
AS
/*
	EXEC RPT_ACCGLREPORT_REV 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'--, 'ALL'
*/
IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'
	BEGIN
		RAISERROR('This Report is not available for your type of Login', 16, 1)
		RETURN
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
	BEGIN
		SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
	END
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
	BEGIN
		SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
	END
DECLARE
	@YEARSTART VARCHAR(11),
	@YEAREND VARCHAR(11)
SELECT
	@YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),
	@YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)
FROM
	PARAMETER
WHERE
	@FDATE BETWEEN SDTCUR AND LDTCUR
	AND @TDATE BETWEEN SDTCUR AND LDTCUR

IF @YEARSTART IS NULL OR @YEAREND IS NULL
	BEGIN
		RAISERROR('Invalid Financial Information...', 16, 1)
		RETURN
	END
CREATE TABLE #CLBAL
(
	SNO INT
)
EXEC MAKE_UDT_STRUCTURE
	'#CLBAL',
	'CLTCODE|BALANCE',
	'UDTPARTYCODE|MONEY',
	'',
	''
ALTER TABLE #CLBAL DROP COLUMN SNO
--CREATE TABLE #CLBAL
--(
--	CLTCODE [UDTPARTYCODE],
--	BALANCE MONEY
--)
CREATE TABLE #TEMPTABLE_GL
(
	ENTITY VARCHAR(25)
)
EXEC MAKE_UDT_STRUCTURE
	'#TEMPTABLE_GL',
	'BOOKTYPE|VOUDT1|EFFDT1|SHORTDESC|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO',
	'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT',
	'|10|10|6|||||||||||||||35|',
	'0|0|0|0|0|0|0|0|0|1|0|0|0|0|0|1|0|0|0|0'

ALTER TABLE #TEMPTABLE_GL ADD SNO INT IDENTITY(1,1)



--CREATE TABLE #TEMPTABLE_GL
--(
--	[ENTITY] VARCHAR(25),
--	[BOOKTYPE] [UDTBOOKTYPE] NULL,
--	[VOUDT1] [VARCHAR] (10) NULL,
--	[EFFDT1] [VARCHAR] (10) NULL,
--	[SHORTDESC] [CHAR] (6) NULL,
--	[DRAMT] [MONEY] NULL,
--	[CRAMT] [MONEY] NULL,
--	[VNO] [UDTVNO] NULL,
--	[NARRATION] [UDTNARRATION] NULL,
--	[DDNO] [UDTINSTNO] NULL,
--	[CLTCODE] [UDTPARTYCODE] NOT NULL,
--	[LONGNAME] [UDTACNAME] NULL,
--	[VDT] [DATETIME] NULL,
--	[EDT] [DATETIME] NULL,
--	[VTYP] [UDTVTYPE] NULL,
--	[ACCAT] [UDTACCAT] NULL,
--	[OPBAL] [MONEY] NULL,
--	[CROSAC] [UDTPARTYCODE] NULL,
--	[ACNAME] [UDTACNAME] NULL,
--	[BRANCHCODE] VARCHAR(35) NULL,
--	[MASTERSNO] BIGINT,
--	[SNO] INT IDENTITY(1,1)
--)

/*Closing Balance */
IF @SELECTON = 'VDT'
	BEGIN
		INSERT INTO #CLBAL (CLTCODE, BALANCE)
		SELECT
			CLTCODE = L.CODE,
			BALANCE = SUM(DRAMOUNT - CRAMOUNT)
		FROM
			ACC_LEDGER_GL G, DBO.UFN_LOGINCHECK(@EXCHANGE, @SEGMENT, @STATUSID, @STATUSNAME, 'GL', @FCODE, @TCODE, '') L
		WHERE
			G.CLTCODE = L.CODE
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT <= @TDATE + ' 23:59'
			AND VDT >= @YEARSTART
			--AND ACCAT IN (3, 14, 103)
			AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
--			AND @STATUSNAME = 
--						(
--							CASE @STATUSID
--								WHEN 'BRANCH' THEN BRANCHCODE
--							ELSE
--								'BROKER'
--							END
--						)
		GROUP BY
			 L.CODE
	END
ELSE
	BEGIN
		INSERT INTO #CLBAL (CLTCODE, BALANCE)
		SELECT
			CLTCODE ,
			BALANCE = SUM(BALANCE)
		FROM
			(
				SELECT
					CLTCODE = L.CODE,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT)
				FROM
					ACC_LEDGER_GL G, DBO.UFN_LOGINCHECK(@EXCHANGE, @SEGMENT, @STATUSID, @STATUSNAME, 'GL', @FCODE, @TCODE, '') L
				WHERE
					G.CLTCODE = L.CODE
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND EDT <= @TDATE + ' 23:59'
					AND EDT >= @YEARSTART
--					AND ACCAT IN (3, 14, 103)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'BRANCH' THEN BRANCHCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE
				UNION ALL
				SELECT
					CLTCODE = L.CODE,
					BALANCE = SUM(CRAMOUNT - DRAMOUNT)
				FROM
					ACC_LEDGER_GL G, DBO.UFN_LOGINCHECK(@EXCHANGE, @SEGMENT, @STATUSID, @STATUSNAME, 'GL', @FCODE, @TCODE, '') L
				WHERE
					G.CLTCODE = L.CODE
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
--					AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT < @YEARSTART
					AND EDT >= @YEARSTART
--					AND ACCAT IN (3, 14, 103)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'BRANCH' THEN BRANCHCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE--CLTCODE
			) OPBAL
		GROUP BY
			CLTCODE
	END

INSERT INTO #TEMPTABLE_GL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	SHORTDESC = 'CLBAL',
	DRAMT = CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
	CRAMT = CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
	VNO = '',
	NARRATION = 'CLOSING BALANCE',
	DDNO = '',
	CLTCODE ,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 0,
	ACCAT = 0,
	OPBAL = BALANCE,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0
FROM
	#CLBAL

/* Closing Balance */

/* Report Transaction */
INSERT INTO #TEMPTABLE_GL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE,
	VOUDT1 = VDT_C,
	EFFDT1 = EDT_C,
	SHORTDESC,
	DRAMT = (CASE WHEN SUM(DRAMOUNT) > SUM(CRAMOUNT) THEN SUM(DRAMOUNT) - SUM(CRAMOUNT) ELSE 0 END),
	CRAMT = (CASE WHEN SUM(CRAMOUNT) > SUM(DRAMOUNT) THEN SUM(CRAMOUNT) - SUM(DRAMOUNT) ELSE 0 END),
	VNO,
	NARRATION,
	DDNO = ISNULL(INSTNO, ''),
	CLTCODE = L.CODE,
	ACNAME = L.LONG_NAME,
	VDT = VDT,
	EDT = EDT,
	VTYPE,
	ACCAT,
	OPBAL = 0,
	CROSAC = OPPACCOUNT,
	ACNAME = L.LONG_NAME,--ACNAME,
	BRANCHCODE=@BRANCHCODE,
	MASTERSNO=MAX(MASTERSNO)
FROM
	ACC_LEDGER_GL G, DBO.UFN_LOGINCHECK(@EXCHANGE, @SEGMENT, @STATUSID, @STATUSNAME, 'GL', @FCODE, @TCODE, '') L
WHERE
	G.CLTCODE = L.CODE
	AND EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	--AND CLTCODE BETWEEN @FCODE AND @TCODE
	AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' OR @BRANCHCODE = 'ALL' THEN BRANCHCODE ELSE @BRANCHCODE END
	AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND VTYPE <> 18
	--AND ACCAT IN (3, 14, 103)
--	AND @STATUSNAME = 
--				(
--					CASE @STATUSID
--						WHEN 'BRANCH' THEN BRANCHCODE
--					ELSE
--						'BROKER'
--					END
--				)
GROUP BY L.CODE,L.LONG_NAME,--CLTCODE,ACNAME,
	 BOOKTYPE, VTYPE, VNO, ACCAT, VDT, EDT, VDT_C, EDT_C, SHORTDESC, NARRATION, ISNULL(INSTNO, ''), OPPACCOUNT
ORDER BY
	L.CODE,--CLTCODE,
	CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
	BOOKTYPE,
	VTYPE,
	VNO

/* Report Transaction */

INSERT INTO #TEMPTABLE_GL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = 'OPENT',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = 'OPENING BALANCE',
	DDNO = '',
	CLTCODE,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 18,
	ACCAT = 0,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0
FROM
	#TEMPTABLE_GL
GROUP BY
	CLTCODE

UPDATE #TEMPTABLE_GL
SET
	DRAMT = CASE WHEN (S.DRAMT - S.CRAMT) < 0 THEN ABS(S.DRAMT - S.CRAMT) ELSE 0 END,
	CRAMT = CASE WHEN (S.DRAMT - S.CRAMT) >= 0 THEN (S.DRAMT - S.CRAMT) ELSE 0 END
FROM
	(
		SELECT
			CLTCODE,
			DRAMT = SUM(CASE WHEN VTYP = 0 THEN CRAMT ELSE DRAMT END),
			CRAMT = SUM(CASE WHEN VTYP = 0 THEN DRAMT ELSE CRAMT END)
		FROM
			#TEMPTABLE_GL
		GROUP BY
			CLTCODE
	) S
WHERE
	#TEMPTABLE_GL.CLTCODE = S.CLTCODE
	AND #TEMPTABLE_GL.VTYP = 18


--COMMENTED AS USED LOGIN_CHECK FUNCTION
--UPDATE #TEMPTABLE_GL
--SET
--	ACNAME = A.ACNAME,
--	LONGNAME = A.ACNAME,
--	ACCAT = A.ACCAT
--FROM
--	ACMAST A
--WHERE
--	#TEMPTABLE_GL.CLTCODE = A.CLTCODE
--	AND #TEMPTABLE_GL.ACNAME = ''

--SELECT
--	RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_GL I WHERE I.CLTCODE = #TEMPTABLE_GL.CLTCODE AND I.SNO >= #TEMPTABLE_GL.SNO AND #TEMPTABLE_GL.VTYP <> 0), 0),
--	ENTITY,
--	BOOKTYPE,
--	VOUDT1,
--	EFFDT1,
--	SHORTDESC,
--	DRAMT,
--	CRAMT,
--	VNO,
--	NARRATION,
--	DDNO,
--	CLTCODE,
--	LONGNAME,
--	VDT,
--	EDT,
--	VTYP,
--	ACCAT,
--	OPBAL,
--	CROSAC,
--	ACNAME,
--	BRANCHCODE
--FROM
--	#TEMPTABLE_GL
--ORDER BY
--	CLTCODE,
--	SNO

SELECT
	VOUDT1,
	EFFDT1,
	VTYPE = SHORTDESC,
	VNO,
	CROSAC,
	BRANCHCODE,
	NARRATION,
	DDNO,
	DRAMT,
	CRAMT,
	RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_GL I WHERE I.CLTCODE = #TEMPTABLE_GL.CLTCODE AND I.SNO >= #TEMPTABLE_GL.SNO AND #TEMPTABLE_GL.VTYP <> 0), 0),
	ENTITY,
	CLTCODE,
	LONGNAME,
	VTYP,
	MASTERSNO
FROM
	#TEMPTABLE_GL
ORDER BY
	CLTCODE,
	SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCGLREPORT_SUM_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_MULTI_SEG_SUM_REV
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_REV
-- --------------------------------------------------



CREATE PROC [dbo].[RPT_ACCPLREPORT_REV]
(
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@FCODE [UDTPARTYCODE],
	@TCODE [UDTPARTYCODE],
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@BRANCHCODE [UDTBRANCHCODE],
	@SELECTON VARCHAR(3),
	@SORTON VARCHAR(3),
	@EXCHANGE [UDTEXCHANGE],
	@SEGMENT [UDTSEGMENT],
	@SHOWMARGIN VARCHAR(1) = 'N',
	@VTYPE VARCHAR(70) = '',
	@WITHXML VARCHAR(1) = 'N',
	@CLTYPE varchar(3) = '',
	@FORPDF VARCHAR(1) = 'N'
)
--WITH ENCRYPTION
AS

/*
 EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', '1031635', '1031635', 'BROKER', 'BROKER', '',
 'VDT', 'VDT', 'BSE', 'MFSS', 'N', '', 'N',''

 EXEC [RPT_ACCPLREPORT_REV] 'APR  1 2018', 'SEP  7 2018', 'A137346', 'A137346', 'BROKER', 'BROKER', '','VDT', 'VDT', 'BSE', 'MFSS', 'N', '', 'N',''
 SELECT LEN('00220180906076395336')
*/
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
	BEGIN
		SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
	END
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
	BEGIN
		SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
	END

DECLARE @YEARSTART VARCHAR(11),
	@YEAREND VARCHAR(11),
	@SHAREDB VARCHAR(25),
	@SQL VARCHAR(200),
	@HTMLBOLD VARCHAR(4),
	@HTMLBOLDEND VARCHAR(4)
	
	IF @FORPDF = 'N'
		BEGIN
			SET @HTMLBOLD = '<B>'
			SET @HTMLBOLDEND = '</B>'
		END
	ELSE
		BEGIN
			SET @HTMLBOLD = ''
			SET @HTMLBOLDEND = ''
		END

SELECT
	@YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),
	@YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)
FROM
	PARAMETER
WHERE
	@FDATE BETWEEN SDTCUR AND LDTCUR
	AND @TDATE BETWEEN SDTCUR AND LDTCUR

IF @YEARSTART IS NULL OR @YEAREND IS NULL
	BEGIN
		RAISERROR('Invalid Financial Information...', 16, 1)
		RETURN
	END
CREATE TABLE #VMAST
(
	SNO INT
)
EXEC MAKE_UDT_STRUCTURE
	'#VMAST',
	'VTYPE',
	'UDTVTYPE',
	'',
	''
ALTER TABLE #VMAST DROP COLUMN SNO

--CREATE TABLE #VMAST
--(
-- VTYPE [UDTVTYPE]
--)
IF @VTYPE <> ''
	BEGIN

		DECLARE
			@VPOS INT,
			@INNERVTYPE [UDTVTYPE]
		SET @VPOS = 1
		WHILE 1 = 1
			BEGIN
			
				SET @INNERVTYPE = .dbo.PIECE(@VTYPE, '|', @VPOS)
				IF @INNERVTYPE IS NULL OR @INNERVTYPE = ''
					BEGIN
						BREAK
					END
				INSERT INTO #VMAST (VTYPE) VALUES (@INNERVTYPE)
				SET @VPOS = @VPOS + 1
			END
	END
ELSE
	BEGIN
		INSERT INTO #VMAST (VTYPE) SELECT VTYPE FROM VMAST
	END

	

--SELECT * FROM #VMAST
CREATE TABLE #CLBAL
(
	SNO INT
)
EXEC MAKE_UDT_STRUCTURE
	'#CLBAL',
	'CLTCODE|BALANCE|SLML',
	'UDTPARTYCODE|MONEY|VARCHAR',
	'||1',
	''
ALTER TABLE #CLBAL DROP COLUMN SNO
--CREATE TABLE #CLBAL
--(
-- CLTCODE [UDTPARTYCODE],
-- BALANCE MONEY,
-- SLML VARCHAR(1)
--)
CREATE TABLE #TEMPTABLE_PL
(
	ENTITY VARCHAR(25)
)
EXEC MAKE_UDT_STRUCTURE
	'#TEMPTABLE_PL',
	'BOOKTYPE|VOUDT1|EFFDT1|SHORTDESC|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO',
	'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|VARCHAR|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT',
	'|10|10|6|||||50||||||||||35|',
	'0|0|0|0|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0'
ALTER TABLE #TEMPTABLE_PL ADD SNO INT IDENTITY(1,1), SLML VARCHAR(1)
EXEC MAKE_UDT_STRUCTURE
	'#TEMPTABLE_PL',
	'DELVTYPE',
	'UDTVTYPE',
	'',
	''

--CREATE TABLE #TEMPTABLE_PL
--(
-- [ENTITY] VARCHAR(25),
-- [BOOKTYPE] [UDTBOOKTYPE] NULL,
-- [VOUDT1] [VARCHAR] (10) NULL,
-- [EFFDT1] [VARCHAR] (10) NULL,
-- [SHORTDESC] [CHAR] (6) NULL,
-- [DRAMT] [MONEY] NULL,
-- [CRAMT] [MONEY] NULL,
-- [VNO] [UDTVNO] NULL,
-- [NARRATION] [UDTNARRATION] NULL,
-- [DDNO] [UDTINSTNO] NULL,
-- [CLTCODE] [UDTPARTYCODE] NOT NULL,
-- [LONGNAME] [UDTACNAME] NULL,
-- [VDT] [DATETIME] NULL,
-- [EDT] [DATETIME] NULL,
-- [VTYP] [UDTVTYPE] NULL,
-- [ACCAT] [UDTACCAT] NULL,
-- [OPBAL] [MONEY] NULL,
-- [CROSAC] [UDTPARTYCODE] NULL,
-- [ACNAME] [UDTACNAME] NULL,
-- [BRANCHCODE] VARCHAR(35) NULL,
-- [MASTERSNO] BIGINT,
-- [SNO] INT IDENTITY(1,1),
-- [SLML] VARCHAR(1),
-- [DELVTYPE] UDTVTYPE
--)
--CREATE TABLE #COMPDATA
--(
-- COMPNAME VARCHAR(100),
-- COMPADDR VARCHAR(500)
--)

CREATE TABLE #CLIENT
(
	TRADER VARCHAR(20),
	SUB_BROKER VARCHAR(20),
	[L_ADDRESS1] VARCHAR(50) NOT NULL,
	[L_ADDRESS2] VARCHAR(50) NOT NULL,
	[L_ADDRESS3] VARCHAR(50) NOT NULL,
	[L_CITY] VARCHAR(35) NOT NULL,
	[L_STATE] VARCHAR(50) NOT NULL,
	[L_NATION] VARCHAR(50) NOT NULL,
	[L_ZIP] VARCHAR(12) NOT NULL,
	[FAX] VARCHAR(20) NOT NULL,
	[RES_PHONE1] VARCHAR(15) NOT NULL,
	[RES_PHONE2] VARCHAR(15) NOT NULL,
	[MOBILE_PAGER] VARCHAR(50) NOT NULL,
	[PAN_GIR_NO] VARCHAR(10) NOT NULL,
	[EMAIL] VARCHAR(100) NOT NULL,
	[CL_TYPE] VARCHAR(3) NOT NULL,
	[BANK_NAME] VARCHAR(100)NULL,
	[ACC_NUM] VARCHAR(40)NULL
)

EXEC MAKE_UDT_STRUCTURE
	'#CLIENT',
	'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',
	'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',
	'',
	''

DECLARE
	@@SHAREDB VARCHAR(20),
	@@SQL VARCHAR(1000)

SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT

SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,
			L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION, BANK_NAME, ACC_NUM) "
SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + "..UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"
PRINT @@SQL
EXEC (@@SQL)

IF @SELECTON = 'VDT'
	BEGIN
		--SELECT @TDATE, @YEARSTART,
		INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
		SELECT
			CLTCODE = L.CODE,
			BALANCE = SUM(DRAMOUNT - CRAMOUNT),
			SLML = '1'
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND VTYPE NOT IN (19, 20, 22, 23, 24)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT <= @TDATE + ' 23:59'
			AND VDT >= @YEARSTART
			--   AND ACCAT IN (4, 104)
			AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		GROUP BY
			L.CODE--CLTCODE
			--SELECT * FROM #CLBAL
		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
				SELECT
					CLTCODE = L.CODE,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT),
					SLML = '2'
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--     AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT <= @TDATE + ' 23:59'
					AND VDT >= @YEARSTART
					--     AND ACCAT IN (4, 104)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
					--     AND @STATUSNAME =
					--        (
					--         CASE @STATUSID
					--          WHEN 'AREA' THEN AREA
					--          WHEN 'REGION' THEN REGION
					--          WHEN 'SUBBROKER' THEN SUB_BROKER
					--          WHEN 'TRADER' THEN TRADER
					--          WHEN 'BRANCH' THEN BRANCH_CD
					--          WHEN 'FAMILY' THEN FAMILY
					--          WHEN 'CLIENT' THEN CLTCODE
					--         ELSE
					--          'BROKER'
					--         END
					--        )
				GROUP BY
					L.CODE--CLTCODE
			END
	END
ELSE --for EDT
	BEGIN
		INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
		SELECT
			CLTCODE,
			BALANCE = SUM(BALANCE),
			SLML = '1'
		FROM
		(
			SELECT
				CLTCODE = L.CODE,
				BALANCE = SUM(DRAMOUNT - CRAMOUNT)
			FROM
				ACC_LEDGER_PL P, #CLIENT L
			WHERE
				P.CLTCODE = L.CODE
				AND VTYPE NOT IN (19, 20, 22, 23, 24)
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
				--     AND CLTCODE BETWEEN @FCODE AND @TCODE
				AND EDT <= @TDATE + ' 23:59'
				AND EDT >= @YEARSTART
				--     AND ACCAT IN (4, 104)
				AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
				--     AND @STATUSNAME =
				--        (
				--         CASE @STATUSID
				--          WHEN 'AREA' THEN AREA
				--          WHEN 'REGION' THEN REGION
				--          WHEN 'SUBBROKER' THEN SUB_BROKER
				--          WHEN 'TRADER' THEN TRADER
				--          WHEN 'BRANCH' THEN BRANCH_CD
				--          WHEN 'FAMILY' THEN FAMILY
				--          WHEN 'CLIENT' THEN CLTCODE
				--         ELSE
				--          'BROKER'
				--         END
				--        )
			GROUP BY
				L.CODE--CLTCODE
			UNION ALL
			SELECT
				CLTCODE = L.CODE,
				BALANCE = SUM(CRAMOUNT - DRAMOUNT)
			FROM
				ACC_LEDGER_PL P, #CLIENT L
			WHERE
				P.CLTCODE = L.CODE
				AND VTYPE NOT IN (19, 20, 22, 23, 24)
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
				----     AND CLTCODE BETWEEN @FCODE AND @TCODE
				AND VDT < @YEARSTART
				AND EDT >= @YEARSTART
				--     AND ACCAT IN (4, 104)
				AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
				--     AND @STATUSNAME =
				--        (
				--         CASE @STATUSID
				--          WHEN 'AREA' THEN AREA
				--          WHEN 'REGION' THEN REGION
				--          WHEN 'SUBBROKER' THEN SUB_BROKER
				--          WHEN 'TRADER' THEN TRADER
				--          WHEN 'BRANCH' THEN BRANCH_CD
				--          WHEN 'FAMILY' THEN FAMILY
				--          WHEN 'CLIENT' THEN CLTCODE
				--         ELSE
				--          'BROKER'
				--         END
				--        )
			GROUP BY
				L.CODE--CLTCODE
			) CLBAL
		GROUP BY
			CLTCODE

		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
				SELECT
					CLTCODE,
					BALANCE = SUM(BALANCE),
					SLML = '2'
				FROM
				(
					SELECT
						CLTCODE = L.CODE,
						BALANCE = SUM(DRAMOUNT - CRAMOUNT)
					FROM
						ACC_LEDGER_PL P, #CLIENT L
					WHERE
						P.CLTCODE = L.CODE
						AND VTYPE IN (19, 20, 22, 23, 24)
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
						--       AND CLTCODE BETWEEN @FCODE AND @TCODE
						AND EDT <= @TDATE + ' 23:59'
						AND EDT >= @YEARSTART
						--       AND ACCAT IN (4, 104)
						AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
						--       AND @STATUSNAME =
						--          (
						--           CASE @STATUSID
						--            WHEN 'AREA' THEN AREA
						--            WHEN 'REGION' THEN REGION
						--            WHEN 'SUBBROKER' THEN SUB_BROKER
						--            WHEN 'TRADER' THEN TRADER
						--            WHEN 'BRANCH' THEN BRANCH_CD
						--            WHEN 'FAMILY' THEN FAMILY
						--            WHEN 'CLIENT' THEN CLTCODE
						--           ELSE
						--            'BROKER'
						--           END
						--          )
					GROUP BY
						L.CODE--CLTCODE
					UNION ALL
					SELECT
						CLTCODE = L.CODE,
						BALANCE = SUM(CRAMOUNT - DRAMOUNT)
					FROM
						ACC_LEDGER_PL P, #CLIENT L
					WHERE
						P.CLTCODE = L.CODE
						AND VTYPE IN (19, 20, 22, 23, 24)
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
						--       AND CLTCODE BETWEEN @FCODE AND @TCODE
						AND VDT < @YEARSTART
						AND EDT >= @YEARSTART
						--       AND ACCAT IN (4, 104)
						AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
						--       AND @STATUSNAME =
						--          (
						--           CASE @STATUSID    --            WHEN 'AREA' THEN AREA
						--            WHEN 'REGION' THEN REGION
						--            WHEN 'SUBBROKER' THEN SUB_BROKER
						--            WHEN 'TRADER' THEN TRADER
						--            WHEN 'BRANCH' THEN BRANCH_CD
						--            WHEN 'FAMILY' THEN FAMILY
						--            WHEN 'CLIENT' THEN CLTCODE
						--           ELSE
						--            'BROKER'
						--           END
						--          )
					GROUP BY
						L.CODE--CLTCODE
					) CLBAL
				GROUP BY
					CLTCODE
			END
	END
--SELECT * FROM #CLBAL
IF @FORPDF = 'N'
	BEGIN
		INSERT INTO #TEMPTABLE_PL
			( ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
			EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE)
		SELECT DISTINCT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE = '',
			VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = '',
			DRAMT = 0,--CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
			CRAMT = 0,--CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
			VNO = '',
			NARRATION = @HTMLBOLD + ':: SETTLEMENT DETAIL::' + @HTMLBOLDEND,
			DDNO = '',
			CLTCODE,
			LONGNAME = '',
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = 0,
			ACCAT = 0,
			OPBAL = 0,
			CROSAC = '',
			ACNAME = '',
			BRANCHCODE = '',--@BRANCHCODE,
			MASTERSNO = 0,
			SLML = '1',
			DELVTYPE = NULL
		FROM
			#CLBAL
--select * from #TEMPTABLE_PL
		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #TEMPTABLE_PL
					(
					ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
					EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE)
				SELECT DISTINCT
					ENTITY = @EXCHANGE + '-' + @SEGMENT,
					BOOKTYPE = '',
					VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					SHORTDESC = '',
					DRAMT = 0,--CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
					CRAMT = 0,--CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
					VNO = '',
					NARRATION = @HTMLBOLD + ':: MARGIN DETAIL::' + @HTMLBOLDEND,
					DDNO = '',
					CLTCODE,
					LONGNAME = '',
					VDT = @TDATE,
					EDT = @TDATE,
					VTYP = 0,
					ACCAT = 0,
					OPBAL = 0,--BALANCE,
					CROSAC = '',
					ACNAME = '',
					BRANCHCODE = '',--@BRANCHCODE,
					MASTERSNO = 0,
					SLML = '2',
					DELVTYPE = NULL
				FROM
					#CLBAL
			END
	END

INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	SHORTDESC = 'CLBAL',
	DRAMT = CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
	CRAMT = CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
	VNO = '',
	NARRATION = @HTMLBOLD + 'CLOSING BALANCE' + @HTMLBOLDEND,
	DDNO = '',
	CLTCODE,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 0,
	ACCAT = 0,
	OPBAL = BALANCE,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0,
	SLML ,--= '1',
	DELVTYPE = 0
FROM
	#CLBAL

IF @VTYPE <> ''
	BEGIN
		INSERT INTO #TEMPTABLE_PL
		(
			ENTITY,
			BOOKTYPE,
			VOUDT1,
			EFFDT1,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML,
			DELVTYPE
		)
		SELECT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE = '',
			VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = '',
			DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,
			CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) < 0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,
			VNO = '',
			NARRATION = 'Other Vouchers (Net)',
			DDNO = '',
			CLTCODE = L.CODE,
			ACNAME = L.LONG_NAME,
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = '0',
			ACCAT,
			OPBAL = 0,
			CROSAC = '',
			ACNAME = '',
			BRANCHCODE,
			MASTERSNO = '0',
			SLML = '1',
			DELVTYPE = 0
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND P.VTYPE NOT IN (19, 20, 22, 23, 24)
			AND NOT EXISTS (SELECT VTYPE FROM #VMAST IV WHERE ACC_LEDGER_PL.VTYPE = IV.VTYPE)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND P.VTYPE <> 18
			--   AND ACCAT IN (4, 104)
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		GROUP BY
			L.CODE,--CLTCODE,
			L.LONG_NAME,--ACNAME,
			ACCAT,
			BRANCHCODE
		ORDER BY
			L.CODE--CLTCODE
	END

INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE,
	VOUDT1 = VDT_C,
	EFFDT1 = EDT_C,
	LTRIM(RTRIM(SHORTDESC)),
	DRAMT = DRAMOUNT,
	CRAMT = CRAMOUNT,
	VNO,
	LTRIM(RTRIM(NARRATION)),
	DDNO = ISNULL(INSTNO, ''),
	CLTCODE = L.CODE,
	L.LONG_NAME,--LTRIM(RTRIM(ACNAME)),
	VDT = VDT,
	EDT = EDT,
	VTYPE,
	ACCAT,
	OPBAL = 0,
	CROSAC = OPPACCOUNT,
	ACNAME = L.LONG_NAME,--ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML = '1',
	DELVTYPE = VTYPE
FROM
	ACC_LEDGER_PL P, #CLIENT L
WHERE
	P.CLTCODE = L.CODE
	AND VTYPE NOT IN (19, 20, 22, 23, 24)
	AND EXISTS (SELECT VTYPE FROM #VMAST IV WHERE P.VTYPE = IV.VTYPE)
	AND EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	-- AND CLTCODE BETWEEN @FCODE AND @TCODE
	AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND VTYPE <> 18
	-- AND ACCAT IN (4, 104)
	-- AND @STATUSNAME =
	--    (
	--     CASE @STATUSID
	--      WHEN 'AREA' THEN AREA
	--      WHEN 'REGION' THEN REGION
	--      WHEN 'SUBBROKER' THEN SUB_BROKER
	--      WHEN 'TRADER' THEN TRADER
	--      WHEN 'BRANCH' THEN BRANCH_CD
	--      WHEN 'FAMILY' THEN FAMILY
	--      WHEN 'CLIENT' THEN CLTCODE
	--     ELSE
	--      'BROKER'
	--     END
	--    )
ORDER BY
	L.CODE,--CLTCODE,
	CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
	BOOKTYPE,
	VTYPE,
	VNO

IF @SHOWMARGIN = 'Y'
	BEGIN
		IF @VTYPE <> ''
			BEGIN
				INSERT INTO #TEMPTABLE_PL
				(
					ENTITY,
					BOOKTYPE,
					VOUDT1,
					EFFDT1,
					SHORTDESC,
					DRAMT,
					CRAMT,
					VNO,
					NARRATION,
					DDNO,
					CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					VTYP,
					ACCAT,
					OPBAL,
					CROSAC,
					ACNAME,
					BRANCHCODE,
					MASTERSNO,
					SLML,
					DELVTYPE
				)
				SELECT
					ENTITY = @EXCHANGE + '-' + @SEGMENT,
					BOOKTYPE = '',
					VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					SHORTDESC = '',
					DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,
					CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) < 0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,
					VNO = '',
					NARRATION = 'Other Margin Vouchers (Net)',
					DDNO = '',
					CLTCODE,
					ACNAME,
					VDT = @TDATE,
					EDT = @TDATE,
					VTYPE = '0',
					ACCAT,
					OPBAL = 0,
					CROSAC = '',
					AACNAME = '',
					BRANCHCODE,
					MASTERSNO = '0',
					SLML = '2',
					DELVTYPE = 0
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE IN (19, 20, 22, 23, 24)
					AND NOT EXISTS (SELECT VTYPE FROM #VMAST IV WHERE ACC_LEDGER_PL.VTYPE = IV.VTYPE)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--     AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
					AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
					AND VTYPE <> 18
					--     AND ACCAT IN (4, 104)
					--     AND @STATUSNAME =
					--        (
					--         CASE @STATUSID
					--          WHEN 'AREA' THEN AREA
					--          WHEN 'REGION' THEN REGION
					--          WHEN 'SUBBROKER' THEN SUB_BROKER
					--          WHEN 'TRADER' THEN TRADER
					--          WHEN 'BRANCH' THEN BRANCH_CD
					--          WHEN 'FAMILY' THEN FAMILY
					--          WHEN 'CLIENT' THEN CLTCODE
					--         ELSE
					--          'BROKER'
					--         END
					--        )
				GROUP BY
					L.CODE,--CLTCODE,
					L.LONG_NAME,--ACNAME,
					ACCAT,
					BRANCHCODE
				ORDER BY
					L.CODE--CLTCODE
			END

		INSERT INTO #TEMPTABLE_PL
		(
			ENTITY,
			BOOKTYPE,
			VOUDT1,
			EFFDT1,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML,
			DELVTYPE
		)
		SELECT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE,
			VOUDT1 = VDT_C,
			EFFDT1 = EDT_C,
			SHORTDESC,
			DRAMT = DRAMOUNT,
			CRAMT = CRAMOUNT,
			VNO,
			NARRATION,
			DDNO = ISNULL(INSTNO, ''),
			CLTCODE = L.CODE,
			ACNAME = L.LONG_NAME,
			VDT = VDT,
			EDT = EDT,
			VTYPE,
			ACCAT,
			OPBAL = 0,
			CROSAC = OPPACCOUNT,
			AACNAME = L.LONG_NAME,--ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML = '2',
			DELVTYPE = VTYPE
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND VTYPE IN (19, 20, 22, 23, 24)
			AND EXISTS (SELECT VTYPE FROM #VMAST IV WHERE P.VTYPE = IV.VTYPE)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND VTYPE <> 18
			--   AND ACCAT IN (4, 104)
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		ORDER BY
			L.CODE,--CLTCODE,
			CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
			BOOKTYPE,
			VTYPE,
			VNO
	END


INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = 'OPENT',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = @HTMLBOLD + 'OPENING BALANCE' + @HTMLBOLDEND,
	DDNO = '',
	CLTCODE,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 18,
	ACCAT = 0,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0,
	SLML ,--= '1',
	DELVTYPE = 0
FROM
	#TEMPTABLE_PL
WHERE EXISTS(SELECT CLTCODE, SLML FROM #CLBAL WHERE #TEMPTABLE_PL.CLTCODE = #CLBAL.CLTCODE AND #TEMPTABLE_PL.SLML = #CLBAL.SLML)
GROUP BY
	CLTCODE, SLML



UPDATE #TEMPTABLE_PL
SET
	DRAMT = CASE WHEN (S.DRAMT - S.CRAMT) < 0 THEN ABS(S.DRAMT - S.CRAMT) ELSE 0 END,
	CRAMT = CASE WHEN (S.DRAMT - S.CRAMT) >= 0 THEN (S.DRAMT - S.CRAMT) ELSE 0 END
FROM
	(
	SELECT
		CLTCODE,
		DRAMT = SUM(CASE WHEN VTYP = 0 THEN CRAMT ELSE DRAMT END),
		CRAMT = SUM(CASE WHEN VTYP = 0 THEN DRAMT ELSE CRAMT END),
		SLML
	FROM
		#TEMPTABLE_PL
	GROUP BY
		CLTCODE,
		SLML
	) S
WHERE
	#TEMPTABLE_PL.CLTCODE = S.CLTCODE
	AND #TEMPTABLE_PL.VTYP = 18
	AND #TEMPTABLE_PL.SLML = S.SLML

--USED FN_LOGIN_CHECK...
--UPDATE #TEMPTABLE_PL
--SET
-- ACNAME = A.ACNAME,
-- LONGNAME = A.ACNAME,
-- ACCAT = A.ACCAT
--FROM
-- ACMAST A
--WHERE
-- #TEMPTABLE_PL.CLTCODE = A.CLTCODE
-- AND #TEMPTABLE_PL.ACNAME = ''

--SELECT COUNT(1) CNT,CLTCODE, SLML FROM #TEMPTABLE_PL
--GROUP BY CLTCODE, SLML
--HAVING COUNT(1) = 1

INSERT INTO #TEMPTABLE_PL
(
	ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
	EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE
)
SELECT DISTINCT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '',
	VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = '',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = 'NO RECORD FOUND',
	DDNO = '',
	CLTCODE  ,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = '',
	ACCAT = 0,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = '',--@BRANCHCODE
	MASTERSNO = 0,
	SLML,
	DELVTYPE = NULL
FROM
(
	SELECT COUNT(1) CNT,CLTCODE, SLML FROM #TEMPTABLE_PL
	GROUP BY CLTCODE, SLML
	HAVING COUNT(1) = 1
) O


--
--SELECT @SHAREDB = SHAREDB FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1
--SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "
--
--INSERT INTO #COMPDATA(COMPNAME, COMPADDR)
--EXEC(@SQL)

IF @WITHXML = 'N'
	BEGIN
		SELECT
			VOUDT1,
			EFFDT1,
			VTYPE = SHORTDESC,
			VNO,
			CROSAC,
			BRANCHCODE,
			NARRATION,
			DDNO,
			DRAMT,
			CRAMT,
			RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0),
			ENTITY,
			CLTCODE,
			LONGNAME,
			VTYP,
			MASTERSNO,
			SLML,
			DELVTYPE--,
			--COMPNAME,
			--COMPADDR
		FROM
			#TEMPTABLE_PL --, #COMPDATA C
		ORDER BY
			CLTCODE, SLML,
			SNO
	END
ELSE
	BEGIN
		SELECT
			VOUDT1 = LTRIM(RTRIM(VOUDT1)),
			EFFDT1 = LTRIM(RTRIM(EFFDT1)),
			VTYPE = LTRIM(RTRIM(SHORTDESC)),
			VNO = LTRIM(RTRIM(VNO)),
			CROSAC = LTRIM(RTRIM(CROSAC)),
			BRANCHCODE = LTRIM(RTRIM(BRANCHCODE)),
			NARRATION = LTRIM(RTRIM(NARRATION)),
			DDNO = LTRIM(RTRIM(DDNO)),
			DRAMT = CASE WHEN DRAMT <= 0 THEN '' ELSE CONVERT(VARCHAR(24), DRAMT) END,
			CRAMT = CASE WHEN DRAMT <= 0 THEN '' ELSE CONVERT(VARCHAR(24), CRAMT) END,
			RUNNINGBALANCE = CONVERT(VARCHAR(24), ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0)),
			ENTITY = LTRIM(RTRIM(ENTITY)),
			CLTCODE = LTRIM(RTRIM(CLTCODE)),
			LONGNAME = LTRIM(RTRIM(LONGNAME)),
			VTYP,
			MASTERSNO,
			SLML,
			DELVTYPE--,
			--COMPNAME,
			--COMPADDR
		FROM
			#TEMPTABLE_PL --, #COMPDATA C
		ORDER BY
			CLTCODE, SLML,
			SNO
		FOR XML RAW
	END

--SELECT
-- RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0),
-- SNO,
-- ENTITY,
-- BOOKTYPE,
-- VOUDT1,
-- EFFDT1,
-- SHORTDESC,
-- DRAMT,
-- CRAMT,
-- VNO,
-- NARRATION,
-- DDNO,
-- CLTCODE,
-- LONGNAME,
-- VDT,
-- EDT,
-- VTYP,
-- ACCAT,
-- OPBAL,
-- CROSAC,
-- ACNAME,
-- BRANCHCODE
--FROM
-- #TEMPTABLE_PL
--ORDER BY
-- CLTCODE,
-- SNO

--Exec RPT_ACCPLREPORT_REV '01/04/2008', '31/03/2009', '0A146', '0A146', 'broker', 'broker', '', 'VDT', 'codewise', 'NSE', 'CAPITAL' ,'Y'
--Exec RPT_ACCPLREPORT_REV '01/04/2008', '31/03/2009', '0', 'ZZZ', 'broker', 'broker', '', 'VDT', 'codewise', 'NSE', 'CAPITAL' ,'Y'
/*
23932183.18
 SELECT * FROM ACC_LEDGER WHERE MASTERSNO = 3628
 EXEC RPT_ACCPLREPORT_REV 'NOV  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'N', '2|17', 'N'
 DROP TABLE TEMP_SZ
 SELECT * FROM ACC_TBL1 WHERE VNO = '200705020001' AND VTYPE = 2
 SELECT * FROM ACC_TBL2 WHERE MASTERSNO = 531
 SELECT * FROM ACC_TBL3 WHERE MASTERSNO = 531
 SELECT * FROM ACC_LEDGER_PL WHERE VNO = '200705020001' AND VTYPE = 2
 SELECT * FROM ACC_LEDGER_PL WHERE CLTCODE = '0A143' AND VDT BETWEEN 'APR  1 2007' AND 'MAY 31 2007 23:59' ORDER BY VDT
 SELECT * FROM [10.11.12.5].ACCOUNT.dbo.LEDGER WHERE VNO = '200705100001' AND VTYP = 24
 SELECT * FROM [10.11.12.5].ACCOUNT.dbo.LEDGER2 WHERE VNO = '200705100001' AND VTYPE = 2*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_REV_bak_07092018
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_REV_suresh
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_ACCPLREPORT_REV_suresh]
(
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@FCODE [UDTPARTYCODE],
	@TCODE [UDTPARTYCODE],
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@BRANCHCODE [UDTBRANCHCODE],
	@SELECTON VARCHAR(3),
	@SORTON VARCHAR(3),
	@EXCHANGE [UDTEXCHANGE],
	@SEGMENT [UDTSEGMENT],
	@SHOWMARGIN VARCHAR(1) = 'N',
	@VTYPE VARCHAR(70) = '',
	@WITHXML VARCHAR(1) = 'N',
	@CLTYPE varchar(3) = '',
	@FORPDF VARCHAR(1) = 'N'
)
--WITH ENCRYPTION
AS

/*
 EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', '1031635', '1031635', 'BROKER', 'BROKER', '',
 'VDT', 'VDT', 'BSE', 'MFSS', 'N', '', 'N',''
*/
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
	BEGIN
		SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
	END
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
	BEGIN
		SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
	END

DECLARE @YEARSTART VARCHAR(11),
	@YEAREND VARCHAR(11),
	@SHAREDB VARCHAR(25),
	@SQL VARCHAR(200),
	@HTMLBOLD VARCHAR(4),
	@HTMLBOLDEND VARCHAR(4)
	
	IF @FORPDF = 'N'
		BEGIN
			SET @HTMLBOLD = '<B>'
			SET @HTMLBOLDEND = '</B>'
		END
	ELSE
		BEGIN
			SET @HTMLBOLD = ''
			SET @HTMLBOLDEND = ''
		END

SELECT
	@YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),
	@YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)
FROM
	PARAMETER
WHERE
	@FDATE BETWEEN SDTCUR AND LDTCUR
	AND @TDATE BETWEEN SDTCUR AND LDTCUR

IF @YEARSTART IS NULL OR @YEAREND IS NULL
	BEGIN
		RAISERROR('Invalid Financial Information...', 16, 1)
		RETURN
	END
CREATE TABLE #VMAST
(
	SNO INT
)
EXEC MAKE_UDT_STRUCTURE
	'#VMAST',
	'VTYPE',
	'UDTVTYPE',
	'',
	''
ALTER TABLE #VMAST DROP COLUMN SNO
--CREATE TABLE #VMAST
--(
-- VTYPE [UDTVTYPE]
--)
IF @VTYPE <> ''
	BEGIN
		DECLARE
			@VPOS INT,
			@INNERVTYPE [UDTVTYPE]
		SET @VPOS = 1
		WHILE 1 = 1
			BEGIN
				SET @INNERVTYPE = .dbo.PIECE(@VTYPE, '|', @VPOS)
				IF @INNERVTYPE IS NULL OR @INNERVTYPE = ''
					BEGIN
						BREAK
					END
				INSERT INTO #VMAST (VTYPE) VALUES (@INNERVTYPE)
				SET @VPOS = @VPOS + 1
			END
	END
ELSE
	BEGIN
		INSERT INTO #VMAST (VTYPE) SELECT VTYPE FROM VMAST
	END

--SELECT * FROM #VMAST
CREATE TABLE #CLBAL
(
	SNO INT
)
EXEC MAKE_UDT_STRUCTURE
	'#CLBAL',
	'CLTCODE|BALANCE|SLML',
	'UDTPARTYCODE|MONEY|VARCHAR',
	'||1',
	''
ALTER TABLE #CLBAL DROP COLUMN SNO
--CREATE TABLE #CLBAL
--(
-- CLTCODE [UDTPARTYCODE],
-- BALANCE MONEY,
-- SLML VARCHAR(1)
--)
CREATE TABLE #TEMPTABLE_PL
(
	ENTITY VARCHAR(25)
)
EXEC MAKE_UDT_STRUCTURE
	'#TEMPTABLE_PL',
	'BOOKTYPE|VOUDT1|EFFDT1|SHORTDESC|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO',
	'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT',
	'|10|10|6|||||||||||||||35|',
	'0|0|0|0|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0'
ALTER TABLE #TEMPTABLE_PL ADD SNO INT IDENTITY(1,1), SLML VARCHAR(1)
EXEC MAKE_UDT_STRUCTURE
	'#TEMPTABLE_PL',
	'DELVTYPE',
	'UDTVTYPE',
	'',
	''

--CREATE TABLE #TEMPTABLE_PL
--(
-- [ENTITY] VARCHAR(25),
-- [BOOKTYPE] [UDTBOOKTYPE] NULL,
-- [VOUDT1] [VARCHAR] (10) NULL,
-- [EFFDT1] [VARCHAR] (10) NULL,
-- [SHORTDESC] [CHAR] (6) NULL,
-- [DRAMT] [MONEY] NULL,
-- [CRAMT] [MONEY] NULL,
-- [VNO] [UDTVNO] NULL,
-- [NARRATION] [UDTNARRATION] NULL,
-- [DDNO] [UDTINSTNO] NULL,
-- [CLTCODE] [UDTPARTYCODE] NOT NULL,
-- [LONGNAME] [UDTACNAME] NULL,
-- [VDT] [DATETIME] NULL,
-- [EDT] [DATETIME] NULL,
-- [VTYP] [UDTVTYPE] NULL,
-- [ACCAT] [UDTACCAT] NULL,
-- [OPBAL] [MONEY] NULL,
-- [CROSAC] [UDTPARTYCODE] NULL,
-- [ACNAME] [UDTACNAME] NULL,
-- [BRANCHCODE] VARCHAR(35) NULL,
-- [MASTERSNO] BIGINT,
-- [SNO] INT IDENTITY(1,1),
-- [SLML] VARCHAR(1),
-- [DELVTYPE] UDTVTYPE
--)
--CREATE TABLE #COMPDATA
--(
-- COMPNAME VARCHAR(100),
-- COMPADDR VARCHAR(500)
--)

CREATE TABLE #CLIENT
(
	TRADER VARCHAR(20),
	SUB_BROKER VARCHAR(20),
	[L_ADDRESS1] VARCHAR(50) NOT NULL,
	[L_ADDRESS2] VARCHAR(50) NOT NULL,
	[L_ADDRESS3] VARCHAR(50) NOT NULL,
	[L_CITY] VARCHAR(35) NOT NULL,
	[L_STATE] VARCHAR(50) NOT NULL,
	[L_NATION] VARCHAR(50) NOT NULL,
	[L_ZIP] VARCHAR(12) NOT NULL,
	[FAX] VARCHAR(20) NOT NULL,
	[RES_PHONE1] VARCHAR(15) NOT NULL,
	[RES_PHONE2] VARCHAR(15) NOT NULL,
	[MOBILE_PAGER] VARCHAR(50) NOT NULL,
	[PAN_GIR_NO] VARCHAR(10) NOT NULL,
	[EMAIL] VARCHAR(100) NOT NULL,
	[CL_TYPE] VARCHAR(3) NOT NULL,
	[BANK_NAME] VARCHAR(100)NULL,
	[ACC_NUM] VARCHAR(40)NULL
)

EXEC MAKE_UDT_STRUCTURE
	'#CLIENT',
	'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',
	'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',
	'',
	''

DECLARE
	@@SHAREDB VARCHAR(20),
	@@SQL VARCHAR(1000)

SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT

SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,
			L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION, BANK_NAME, ACC_NUM) "
SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + "..UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"
PRINT @@SQL
EXEC (@@SQL)

IF @SELECTON = 'VDT'
	BEGIN
		--SELECT @TDATE, @YEARSTART,
		INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
		SELECT
			CLTCODE = L.CODE,
			BALANCE = SUM(DRAMOUNT - CRAMOUNT),
			SLML = '1'
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND VTYPE NOT IN (19, 20, 22, 23, 24)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT <= @TDATE + ' 23:59'
			AND VDT >= @YEARSTART
			--   AND ACCAT IN (4, 104)
			AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		GROUP BY
			L.CODE--CLTCODE
			--SELECT * FROM #CLBAL
		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
				SELECT
					CLTCODE = L.CODE,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT),
					SLML = '2'
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--     AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT <= @TDATE + ' 23:59'
					AND VDT >= @YEARSTART
					--     AND ACCAT IN (4, 104)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
					--     AND @STATUSNAME =
					--        (
					--         CASE @STATUSID
					--          WHEN 'AREA' THEN AREA
					--          WHEN 'REGION' THEN REGION
					--          WHEN 'SUBBROKER' THEN SUB_BROKER
					--          WHEN 'TRADER' THEN TRADER
					--          WHEN 'BRANCH' THEN BRANCH_CD
					--          WHEN 'FAMILY' THEN FAMILY
					--          WHEN 'CLIENT' THEN CLTCODE
					--         ELSE
					--          'BROKER'
					--         END
					--        )
				GROUP BY
					L.CODE--CLTCODE
			END
	END
ELSE --for EDT
	BEGIN
		INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
		SELECT
			CLTCODE,
			BALANCE = SUM(BALANCE),
			SLML = '1'
		FROM
		(
			SELECT
				CLTCODE = L.CODE,
				BALANCE = SUM(DRAMOUNT - CRAMOUNT)
			FROM
				ACC_LEDGER_PL P, #CLIENT L
			WHERE
				P.CLTCODE = L.CODE
				AND VTYPE NOT IN (19, 20, 22, 23, 24)
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
				--     AND CLTCODE BETWEEN @FCODE AND @TCODE
				AND EDT <= @TDATE + ' 23:59'
				AND EDT >= @YEARSTART
				--     AND ACCAT IN (4, 104)
				AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
				--     AND @STATUSNAME =
				--        (
				--         CASE @STATUSID
				--          WHEN 'AREA' THEN AREA
				--          WHEN 'REGION' THEN REGION
				--          WHEN 'SUBBROKER' THEN SUB_BROKER
				--          WHEN 'TRADER' THEN TRADER
				--          WHEN 'BRANCH' THEN BRANCH_CD
				--          WHEN 'FAMILY' THEN FAMILY
				--          WHEN 'CLIENT' THEN CLTCODE
				--         ELSE
				--          'BROKER'
				--         END
				--        )
			GROUP BY
				L.CODE--CLTCODE
			UNION ALL
			SELECT
				CLTCODE = L.CODE,
				BALANCE = SUM(CRAMOUNT - DRAMOUNT)
			FROM
				ACC_LEDGER_PL P, #CLIENT L
			WHERE
				P.CLTCODE = L.CODE
				AND VTYPE NOT IN (19, 20, 22, 23, 24)
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
				----     AND CLTCODE BETWEEN @FCODE AND @TCODE
				AND VDT < @YEARSTART
				AND EDT >= @YEARSTART
				--     AND ACCAT IN (4, 104)
				AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
				--     AND @STATUSNAME =
				--        (
				--         CASE @STATUSID
				--          WHEN 'AREA' THEN AREA
				--          WHEN 'REGION' THEN REGION
				--          WHEN 'SUBBROKER' THEN SUB_BROKER
				--          WHEN 'TRADER' THEN TRADER
				--          WHEN 'BRANCH' THEN BRANCH_CD
				--          WHEN 'FAMILY' THEN FAMILY
				--          WHEN 'CLIENT' THEN CLTCODE
				--         ELSE
				--          'BROKER'
				--         END
				--        )
			GROUP BY
				L.CODE--CLTCODE
			) CLBAL
		GROUP BY
			CLTCODE

		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #CLBAL (CLTCODE, BALANCE, SLML)
				SELECT
					CLTCODE,
					BALANCE = SUM(BALANCE),
					SLML = '2'
				FROM
				(
					SELECT
						CLTCODE = L.CODE,
						BALANCE = SUM(DRAMOUNT - CRAMOUNT)
					FROM
						ACC_LEDGER_PL P, #CLIENT L
					WHERE
						P.CLTCODE = L.CODE
						AND VTYPE IN (19, 20, 22, 23, 24)
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
						--       AND CLTCODE BETWEEN @FCODE AND @TCODE
						AND EDT <= @TDATE + ' 23:59'
						AND EDT >= @YEARSTART
						--       AND ACCAT IN (4, 104)
						AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
						--       AND @STATUSNAME =
						--          (
						--           CASE @STATUSID
						--            WHEN 'AREA' THEN AREA
						--            WHEN 'REGION' THEN REGION
						--            WHEN 'SUBBROKER' THEN SUB_BROKER
						--            WHEN 'TRADER' THEN TRADER
						--            WHEN 'BRANCH' THEN BRANCH_CD
						--            WHEN 'FAMILY' THEN FAMILY
						--            WHEN 'CLIENT' THEN CLTCODE
						--           ELSE
						--            'BROKER'
						--           END
						--          )
					GROUP BY
						L.CODE--CLTCODE
					UNION ALL
					SELECT
						CLTCODE = L.CODE,
						BALANCE = SUM(CRAMOUNT - DRAMOUNT)
					FROM
						ACC_LEDGER_PL P, #CLIENT L
					WHERE
						P.CLTCODE = L.CODE
						AND VTYPE IN (19, 20, 22, 23, 24)
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
						--       AND CLTCODE BETWEEN @FCODE AND @TCODE
						AND VDT < @YEARSTART
						AND EDT >= @YEARSTART
						--       AND ACCAT IN (4, 104)
						AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' THEN BRANCHCODE ELSE @BRANCHCODE END
						--       AND @STATUSNAME =
						--          (
						--           CASE @STATUSID    --            WHEN 'AREA' THEN AREA
						--            WHEN 'REGION' THEN REGION
						--            WHEN 'SUBBROKER' THEN SUB_BROKER
						--            WHEN 'TRADER' THEN TRADER
						--            WHEN 'BRANCH' THEN BRANCH_CD
						--            WHEN 'FAMILY' THEN FAMILY
						--            WHEN 'CLIENT' THEN CLTCODE
						--           ELSE
						--            'BROKER'
						--           END
						--          )
					GROUP BY
						L.CODE--CLTCODE
					) CLBAL
				GROUP BY
					CLTCODE
			END
	END
--SELECT * FROM #CLBAL
IF @FORPDF = 'N'
	BEGIN
		INSERT INTO #TEMPTABLE_PL
			( ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
			EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE)
		SELECT DISTINCT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE = '',
			VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = '',
			DRAMT = 0,--CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
			CRAMT = 0,--CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
			VNO = '',
			NARRATION = @HTMLBOLD + ':: SETTLEMENT DETAIL::' + @HTMLBOLDEND,
			DDNO = '',
			CLTCODE,
			LONGNAME = '',
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = 0,
			ACCAT = 0,
			OPBAL = 0,
			CROSAC = '',
			ACNAME = '',
			BRANCHCODE = '',--@BRANCHCODE,
			MASTERSNO = 0,
			SLML = '1',
			DELVTYPE = NULL
		FROM
			#CLBAL
--select * from #TEMPTABLE_PL
		IF @SHOWMARGIN = 'Y'
			BEGIN
				INSERT INTO #TEMPTABLE_PL
					(
					ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
					EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE)
				SELECT DISTINCT
					ENTITY = @EXCHANGE + '-' + @SEGMENT,
					BOOKTYPE = '',
					VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					SHORTDESC = '',
					DRAMT = 0,--CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
					CRAMT = 0,--CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
					VNO = '',
					NARRATION = @HTMLBOLD + ':: MARGIN DETAIL::' + @HTMLBOLDEND,
					DDNO = '',
					CLTCODE,
					LONGNAME = '',
					VDT = @TDATE,
					EDT = @TDATE,
					VTYP = 0,
					ACCAT = 0,
					OPBAL = 0,--BALANCE,
					CROSAC = '',
					ACNAME = '',
					BRANCHCODE = '',--@BRANCHCODE,
					MASTERSNO = 0,
					SLML = '2',
					DELVTYPE = NULL
				FROM
					#CLBAL
			END
	END

INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
	SHORTDESC = 'CLBAL',
	DRAMT = CASE WHEN BALANCE >= 0 THEN BALANCE ELSE 0 END,
	CRAMT = CASE WHEN BALANCE <  0 THEN ABS(BALANCE) ELSE 0 END,
	VNO = '',
	NARRATION = @HTMLBOLD + 'CLOSING BALANCE' + @HTMLBOLDEND,
	DDNO = '',
	CLTCODE,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 0,
	ACCAT = 0,
	OPBAL = BALANCE,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0,
	SLML ,--= '1',
	DELVTYPE = 0
FROM
	#CLBAL

IF @VTYPE <> ''
	BEGIN
		INSERT INTO #TEMPTABLE_PL
		(
			ENTITY,
			BOOKTYPE,
			VOUDT1,
			EFFDT1,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML,
			DELVTYPE
		)
		SELECT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE = '',
			VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
			SHORTDESC = '',
			DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,
			CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) < 0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,
			VNO = '',
			NARRATION = 'Other Vouchers (Net)',
			DDNO = '',
			CLTCODE = L.CODE,
			ACNAME = L.LONG_NAME,
			VDT = @TDATE,
			EDT = @TDATE,
			VTYP = '0',
			ACCAT,
			OPBAL = 0,
			CROSAC = '',
			ACNAME = '',
			BRANCHCODE,
			MASTERSNO = '0',
			SLML = '1',
			DELVTYPE = 0
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND P.VTYPE NOT IN (19, 20, 22, 23, 24)
			AND NOT EXISTS (SELECT VTYPE FROM #VMAST IV WHERE ACC_LEDGER_PL.VTYPE = IV.VTYPE)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND P.VTYPE <> 18
			--   AND ACCAT IN (4, 104)
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		GROUP BY
			L.CODE,--CLTCODE,
			L.LONG_NAME,--ACNAME,
			ACCAT,
			BRANCHCODE
		ORDER BY
			L.CODE--CLTCODE
	END

INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE,
	VOUDT1 = VDT_C,
	EFFDT1 = EDT_C,
	LTRIM(RTRIM(SHORTDESC)),
	DRAMT = DRAMOUNT,
	CRAMT = CRAMOUNT,
	VNO,
	LTRIM(RTRIM(NARRATION)),
	DDNO = ISNULL(INSTNO, ''),
	CLTCODE = L.CODE,
	L.LONG_NAME,--LTRIM(RTRIM(ACNAME)),
	VDT = VDT,
	EDT = EDT,
	VTYPE,
	ACCAT,
	OPBAL = 0,
	CROSAC = OPPACCOUNT,
	ACNAME = L.LONG_NAME,--ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML = '1',
	DELVTYPE = VTYPE
FROM
	ACC_LEDGER_PL P, #CLIENT L
WHERE
	P.CLTCODE = L.CODE
	AND VTYPE NOT IN (19, 20, 22, 23, 24)
	AND EXISTS (SELECT VTYPE FROM #VMAST IV WHERE P.VTYPE = IV.VTYPE)
	AND EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	-- AND CLTCODE BETWEEN @FCODE AND @TCODE
	AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
	AND VTYPE <> 18
	-- AND ACCAT IN (4, 104)
	-- AND @STATUSNAME =
	--    (
	--     CASE @STATUSID
	--      WHEN 'AREA' THEN AREA
	--      WHEN 'REGION' THEN REGION
	--      WHEN 'SUBBROKER' THEN SUB_BROKER
	--      WHEN 'TRADER' THEN TRADER
	--      WHEN 'BRANCH' THEN BRANCH_CD
	--      WHEN 'FAMILY' THEN FAMILY
	--      WHEN 'CLIENT' THEN CLTCODE
	--     ELSE
	--      'BROKER'
	--     END
	--    )
ORDER BY
	L.CODE,--CLTCODE,
	CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
	BOOKTYPE,
	VTYPE,
	VNO

IF @SHOWMARGIN = 'Y'
	BEGIN
		IF @VTYPE <> ''
			BEGIN
				INSERT INTO #TEMPTABLE_PL
				(
					ENTITY,
					BOOKTYPE,
					VOUDT1,
					EFFDT1,
					SHORTDESC,
					DRAMT,
					CRAMT,
					VNO,
					NARRATION,
					DDNO,
					CLTCODE,
					LONGNAME,
					VDT,
					EDT,
					VTYP,
					ACCAT,
					OPBAL,
					CROSAC,
					ACNAME,
					BRANCHCODE,
					MASTERSNO,
					SLML,
					DELVTYPE
				)
				SELECT
					ENTITY = @EXCHANGE + '-' + @SEGMENT,
					BOOKTYPE = '',
					VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @TDATE, 109), 103),
					SHORTDESC = '',
					DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,
					CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) < 0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,
					VNO = '',
					NARRATION = 'Other Margin Vouchers (Net)',
					DDNO = '',
					CLTCODE,
					ACNAME,
					VDT = @TDATE,
					EDT = @TDATE,
					VTYPE = '0',
					ACCAT,
					OPBAL = 0,
					CROSAC = '',
					AACNAME = '',
					BRANCHCODE,
					MASTERSNO = '0',
					SLML = '2',
					DELVTYPE = 0
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE IN (19, 20, 22, 23, 24)
					AND NOT EXISTS (SELECT VTYPE FROM #VMAST IV WHERE ACC_LEDGER_PL.VTYPE = IV.VTYPE)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--     AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
					AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
					AND VTYPE <> 18
					--     AND ACCAT IN (4, 104)
					--     AND @STATUSNAME =
					--        (
					--         CASE @STATUSID
					--          WHEN 'AREA' THEN AREA
					--          WHEN 'REGION' THEN REGION
					--          WHEN 'SUBBROKER' THEN SUB_BROKER
					--          WHEN 'TRADER' THEN TRADER
					--          WHEN 'BRANCH' THEN BRANCH_CD
					--          WHEN 'FAMILY' THEN FAMILY
					--          WHEN 'CLIENT' THEN CLTCODE
					--         ELSE
					--          'BROKER'
					--         END
					--        )
				GROUP BY
					L.CODE,--CLTCODE,
					L.LONG_NAME,--ACNAME,
					ACCAT,
					BRANCHCODE
				ORDER BY
					L.CODE--CLTCODE
			END

		INSERT INTO #TEMPTABLE_PL
		(
			ENTITY,
			BOOKTYPE,
			VOUDT1,
			EFFDT1,
			SHORTDESC,
			DRAMT,
			CRAMT,
			VNO,
			NARRATION,
			DDNO,
			CLTCODE,
			LONGNAME,
			VDT,
			EDT,
			VTYP,
			ACCAT,
			OPBAL,
			CROSAC,
			ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML,
			DELVTYPE
		)
		SELECT
			ENTITY = @EXCHANGE + '-' + @SEGMENT,
			BOOKTYPE,
			VOUDT1 = VDT_C,
			EFFDT1 = EDT_C,
			SHORTDESC,
			DRAMT = DRAMOUNT,
			CRAMT = CRAMOUNT,
			VNO,
			NARRATION,
			DDNO = ISNULL(INSTNO, ''),
			CLTCODE = L.CODE,
			ACNAME = L.LONG_NAME,
			VDT = VDT,
			EDT = EDT,
			VTYPE,
			ACCAT,
			OPBAL = 0,
			CROSAC = OPPACCOUNT,
			AACNAME = L.LONG_NAME,--ACNAME,
			BRANCHCODE,
			MASTERSNO,
			SLML = '2',
			DELVTYPE = VTYPE
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND VTYPE IN (19, 20, 22, 23, 24)
			AND EXISTS (SELECT VTYPE FROM #VMAST IV WHERE P.VTYPE = IV.VTYPE)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			--   AND CLTCODE BETWEEN @FCODE AND @TCODE
			AND VDT BETWEEN CASE WHEN @SELECTON = 'VDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'VDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND EDT BETWEEN CASE WHEN @SELECTON = 'EDT' THEN @FDATE ELSE 'JAN  1 1900' END AND CASE WHEN @SELECTON = 'EDT' THEN @TDATE + ' 23:59' ELSE 'DEC 31 2049 23:59:59' END
			AND VTYPE <> 18
			--   AND ACCAT IN (4, 104)
			--   AND @STATUSNAME =
			--      (
			--       CASE @STATUSID
			--        WHEN 'AREA' THEN AREA
			--        WHEN 'REGION' THEN REGION
			--        WHEN 'SUBBROKER' THEN SUB_BROKER
			--        WHEN 'TRADER' THEN TRADER
			--        WHEN 'BRANCH' THEN BRANCH_CD
			--        WHEN 'FAMILY' THEN FAMILY
			--        WHEN 'CLIENT' THEN CLTCODE
			--       ELSE
			--        'BROKER'
			--       END
			--      )
		ORDER BY
			L.CODE,--CLTCODE,
			CASE WHEN @SELECTON = 'VDT' THEN VDT ELSE EDT END DESC,
			BOOKTYPE,
			VTYPE,
			VNO
	END



INSERT INTO #TEMPTABLE_PL
(
	ENTITY,
	BOOKTYPE,
	VOUDT1,
	EFFDT1,
	SHORTDESC,
	DRAMT,
	CRAMT,
	VNO,
	NARRATION,
	DDNO,
	CLTCODE,
	LONGNAME,
	VDT,
	EDT,
	VTYP,
	ACCAT,
	OPBAL,
	CROSAC,
	ACNAME,
	BRANCHCODE,
	MASTERSNO,
	SLML,
	DELVTYPE
)
SELECT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '01',
	VOUDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT1 = CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = 'OPENT',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = @HTMLBOLD + 'OPENING BALANCE' + @HTMLBOLDEND,
	DDNO = '',
	CLTCODE,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = 18,
	ACCAT = 0,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = @BRANCHCODE,
	MASTERSNO = 0,
	SLML ,--= '1',
	DELVTYPE = 0
FROM
	#TEMPTABLE_PL
WHERE EXISTS(SELECT CLTCODE, SLML FROM #CLBAL WHERE #TEMPTABLE_PL.CLTCODE = #CLBAL.CLTCODE 
AND #TEMPTABLE_PL.SLML = #CLBAL.SLML)
GROUP BY
	CLTCODE, SLML


UPDATE #TEMPTABLE_PL
SET
	DRAMT = CASE WHEN S.BALANCE - C.BALANCE <= 0 THEN ABS(S.BALANCE - C.BALANCE) ELSE 0 END,
	CRAMT = CASE WHEN S.BALANCE - C.BALANCE > 0 THEN S.BALANCE - C.BALANCE ELSE 0 END
FROM
	(
	SELECT
		CLTCODE,
		BALANCE = SUM(DRAMT - CRAMT),
		SLML
	FROM
		#TEMPTABLE_PL
	GROUP BY
		CLTCODE,
		SLML
	) S,
	#CLBAL C
WHERE
	#TEMPTABLE_PL.CLTCODE = S.CLTCODE
	AND #TEMPTABLE_PL.VTYP = 18
	AND #TEMPTABLE_PL.SLML = S.SLML
	AND C.CLTCODE = S.CLTCODE
	AND C.SLML = S.SLML

--USED FN_LOGIN_CHECK...
--UPDATE #TEMPTABLE_PL
--SET
-- ACNAME = A.ACNAME,
-- LONGNAME = A.ACNAME,
-- ACCAT = A.ACCAT
--FROM
-- ACMAST A
--WHERE
-- #TEMPTABLE_PL.CLTCODE = A.CLTCODE
-- AND #TEMPTABLE_PL.ACNAME = ''

--SELECT COUNT(1) CNT,CLTCODE, SLML FROM #TEMPTABLE_PL
--GROUP BY CLTCODE, SLML
--HAVING COUNT(1) = 1

INSERT INTO #TEMPTABLE_PL
(
	ENTITY, BOOKTYPE, VOUDT1, EFFDT1, SHORTDESC, DRAMT, CRAMT, VNO, NARRATION, DDNO, CLTCODE, LONGNAME, VDT,
	EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, MASTERSNO, SLML, DELVTYPE
)
SELECT DISTINCT
	ENTITY = @EXCHANGE + '-' + @SEGMENT,
	BOOKTYPE = '',
	VOUDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	EFFDT1 = '',--CONVERT(VARCHAR(10), CONVERT(DATETIME, @FDATE, 109), 103),
	SHORTDESC = '',
	DRAMT = 0,
	CRAMT = 0,
	VNO = '',
	NARRATION = 'NO RECORD FOUND',
	DDNO = '',
	CLTCODE  ,
	LONGNAME = '',
	VDT = @TDATE,
	EDT = @TDATE,
	VTYP = '',
	ACCAT = 0,
	OPBAL = 0,
	CROSAC = '',
	ACNAME = '',
	BRANCHCODE = '',--@BRANCHCODE
	MASTERSNO = 0,
	SLML,
	DELVTYPE = NULL
FROM
(
	SELECT COUNT(1) CNT,CLTCODE, SLML FROM #TEMPTABLE_PL
	GROUP BY CLTCODE, SLML
	HAVING COUNT(1) = 1
) O


--
--SELECT @SHAREDB = SHAREDB FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1
--SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "
--
--INSERT INTO #COMPDATA(COMPNAME, COMPADDR)
--EXEC(@SQL)

IF @WITHXML = 'N'
	BEGIN
		SELECT
			VOUDT1,
			EFFDT1,
			VTYPE = SHORTDESC,
			VNO,
			CROSAC,
			BRANCHCODE,
			NARRATION,
			DDNO,
			DRAMT,
			CRAMT,
			RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0),
			ENTITY,
			CLTCODE,
			LONGNAME,
			VTYP,
			MASTERSNO,
			SLML,
			DELVTYPE--,
			--COMPNAME,
			--COMPADDR
		FROM
			#TEMPTABLE_PL --, #COMPDATA C
		ORDER BY
			CLTCODE, SLML,
			SNO
	END
ELSE
	BEGIN
		SELECT
			VOUDT1 = LTRIM(RTRIM(VOUDT1)),
			EFFDT1 = LTRIM(RTRIM(EFFDT1)),
			VTYPE = LTRIM(RTRIM(SHORTDESC)),
			VNO = LTRIM(RTRIM(VNO)),
			CROSAC = LTRIM(RTRIM(CROSAC)),
			BRANCHCODE = LTRIM(RTRIM(BRANCHCODE)),
			NARRATION = LTRIM(RTRIM(NARRATION)),
			DDNO = LTRIM(RTRIM(DDNO)),
			DRAMT = CASE WHEN DRAMT <= 0 THEN '' ELSE CONVERT(VARCHAR(24), DRAMT) END,
			CRAMT = CASE WHEN DRAMT <= 0 THEN '' ELSE CONVERT(VARCHAR(24), CRAMT) END,
			RUNNINGBALANCE = CONVERT(VARCHAR(24), ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0)),
			ENTITY = LTRIM(RTRIM(ENTITY)),
			CLTCODE = LTRIM(RTRIM(CLTCODE)),
			LONGNAME = LTRIM(RTRIM(LONGNAME)),
			VTYP,
			MASTERSNO,
			SLML,
			DELVTYPE--,
			--COMPNAME,
			--COMPADDR
		FROM
			#TEMPTABLE_PL --, #COMPDATA C
		ORDER BY
			CLTCODE, SLML,
			SNO
		FOR XML RAW
	END

--SELECT
-- RUNNINGBALANCE = ISNULL((SELECT SUM(DRAMT-CRAMT) FROM #TEMPTABLE_PL I WHERE I.CLTCODE = #TEMPTABLE_PL.CLTCODE AND I.SNO >= #TEMPTABLE_PL.SNO AND #TEMPTABLE_PL.VTYP <> 0), 0),
-- SNO,
-- ENTITY,
-- BOOKTYPE,
-- VOUDT1,
-- EFFDT1,
-- SHORTDESC,
-- DRAMT,
-- CRAMT,
-- VNO,
-- NARRATION,
-- DDNO,
-- CLTCODE,
-- LONGNAME,
-- VDT,
-- EDT,
-- VTYP,
-- ACCAT,
-- OPBAL,
-- CROSAC,
-- ACNAME,
-- BRANCHCODE
--FROM
-- #TEMPTABLE_PL
--ORDER BY
-- CLTCODE,
-- SNO

--Exec RPT_ACCPLREPORT_REV '01/04/2008', '31/03/2009', '0A146', '0A146', 'broker', 'broker', '', 'VDT', 'codewise', 'NSE', 'CAPITAL' ,'Y'
--Exec RPT_ACCPLREPORT_REV '01/04/2008', '31/03/2009', '0', 'ZZZ', 'broker', 'broker', '', 'VDT', 'codewise', 'NSE', 'CAPITAL' ,'Y'
/*
23932183.18
 SELECT * FROM ACC_LEDGER WHERE MASTERSNO = 3628
 EXEC RPT_ACCPLREPORT_REV 'NOV  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'N', '2|17', 'N'
 DROP TABLE TEMP_SZ
 SELECT * FROM ACC_TBL1 WHERE VNO = '200705020001' AND VTYPE = 2
 SELECT * FROM ACC_TBL2 WHERE MASTERSNO = 531
 SELECT * FROM ACC_TBL3 WHERE MASTERSNO = 531
 SELECT * FROM ACC_LEDGER_PL WHERE VNO = '200705020001' AND VTYPE = 2
 SELECT * FROM ACC_LEDGER_PL WHERE CLTCODE = '0A143' AND VDT BETWEEN 'APR  1 2007' AND 'MAY 31 2007 23:59' ORDER BY VDT
 SELECT * FROM [10.11.12.5].ACCOUNT.dbo.LEDGER WHERE VNO = '200705100001' AND VTYP = 24
 SELECT * FROM [10.11.12.5].ACCOUNT.dbo.LEDGER2 WHERE VNO = '200705100001' AND VTYPE = 2*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_SUM_REV
-- --------------------------------------------------
CREATE   
 PROC [dbo].[RPT_ACCPLREPORT_SUM_REV]    
(    
 @FDATE VARCHAR(11),    
 @TDATE VARCHAR(11),    
 @FCODE [UDTPARTYCODE],    
 @TCODE [UDTPARTYCODE],    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @BRANCHCODE [UDTBRANCHCODE],    
 @SELECTON VARCHAR(3),    
 @SORTON VARCHAR(3),    
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT],    
 @CLTYPE VARCHAR(3) = ''    
)    
  
AS    
/*    
 EXEC RPT_ACCPLREPORT_SUM_REV 'APR  1 2007', 'Jun  1 2007', '0', 'ZZZZZZ', 'BROKER', 'BROKER', 'AL001', 'VDT', 'VDT', 'NSE', 'CAPITAL', ''    
*/    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0    
 BEGIN    
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)    
 END    
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0    
 BEGIN    
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)    
 END    
DECLARE    
 @YEARSTART VARCHAR(11),    
 @YEAREND VARCHAR(11)    
SELECT    
 @YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),    
 @YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)    
FROM    
 PARAMETER    
WHERE    
 @FDATE BETWEEN SDTCUR AND LDTCUR    
 AND @TDATE BETWEEN SDTCUR AND LDTCUR    
    
IF @YEARSTART IS NULL OR @YEAREND IS NULL    
 BEGIN    
  RAISERROR('Invalid Financial Information...', 16, 1)    
  RETURN    
 END    
  
/*CREATE TABLE #CLIENT   
(  
 TRADER VARCHAR(20),  
 SUB_BROKER VARCHAR(20),  
 [L_ADDRESS1] VARCHAR(50) NOT NULL,    
 [L_ADDRESS2] VARCHAR(50) NOT NULL,    
 [L_ADDRESS3] VARCHAR(50) NOT NULL,    
 [L_CITY] VARCHAR(35) NOT NULL,    
 [L_STATE] VARCHAR(100) NOT NULL,    
 [L_NATION] VARCHAR(50) NOT NULL,    
 [L_ZIP] VARCHAR(12) NOT NULL,    
 [FAX] VARCHAR(20) NOT NULL,    
 [RES_PHONE1] VARCHAR(30) NOT NULL,    
 [RES_PHONE2] VARCHAR(30) NOT NULL,    
 [MOBILE_PAGER] VARCHAR(50) NOT NULL,    
 [PAN_GIR_NO] VARCHAR(10) NOT NULL,    
 [EMAIL] VARCHAR(100) NOT NULL,   
 [CL_TYPE] VARCHAR(3) NOT NULL,  
 [BANK_NAME] VARCHAR(100) NOT NULL,  
 [ACC_NUM] VARCHAR(40) NOT NULL  
)  
  
EXEC MAKE_UDT_STRUCTURE  
 '#CLIENT',  
 'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',  
 'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',  
 '',  
 ''*/  
  
CREATE TABLE #CLIENT   
(  
 [ACC_NUM] VARCHAR(40) NOT NULL  
)  
  
EXEC MAKE_UDT_STRUCTURE  
 '#CLIENT',  
 'CODE|LONG_NAME',  
 'UDTPARTYCODE|UDTACNAME',  
 '',  
 '1|0'  
  
DECLARE  
 @@SHAREDB VARCHAR(20),  
 @@SQL VARCHAR(1000)  
  
SELECT @@SQL = "ALTER TABLE [DBO].[#CLIENT] ADD  CONSTRAINT [PK_CLTMAST] PRIMARY KEY CLUSTERED ([CODE] ASC)"  
  
EXEC (@@SQL)  
  
SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
  
SET @@SQL = "INSERT INTO #CLIENT(CODE,LONG_NAME, ACC_NUM)"  
SET @@SQL = @@SQL + " SELECT CODE, LONG_NAME, ACC_NUM FROM " + @@SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"  
  
EXEC (@@SQL)  
  
IF @SELECTON = 'VDT'    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,    
   CLTCODE = L.CODE,    
   ACCAT,    
   ACNAME = L.LONG_NAME,    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = ROW_NUMBER() OVER (ORDER BY L.CODE),--CLTCODE    
   ACNRW = ROW_NUMBER() OVER (ORDER BY L.LONG_NAME)--ACNAME, vtype    
  FROM    
   (SELECT   
  CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
 FROM   
  ACC_LEDGER_PL   
 WHERE   
  EXCHANGE = @EXCHANGE    
  AND SEGMENT = @SEGMENT    
  AND VDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
  AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L    
  WHERE   
   P.CLTCODE = L.CODE    
  GROUP BY    
   L.CODE,  
   ACCAT,    
   L.LONG_NAME  
  ORDER BY    
   L.LONG_NAME,  
   L.CODE  
 END    
ELSE    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(BALANCE) >= 0 THEN SUM(BALANCE) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END,    
   CLTCODE ,    
   ACCAT,    
   ACNAME ,    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = ROW_NUMBER() OVER (ORDER BY CLTCODE),    
   ACNRW = ROW_NUMBER() OVER (ORDER BY ACNAME)    
  FROM    
   (    
    SELECT    
     CLTCODE= L.CODE,    
     ACCAT,    
     ACNAME= L.LONG_NAME,    
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(DRAMOUNT - CRAMOUNT)    
    FROM    
     (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
 FROM   
 ACC_LEDGER_PL   
 WHERE  
  EXCHANGE = @EXCHANGE    
  AND SEGMENT = @SEGMENT    
  AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
  AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L    
    WHERE    
     P.CLTCODE = L.CODE    
     GROUP BY    
     L.CODE,  
     ACCAT,    
     L.LONG_NAME  
    UNION ALL    
    SELECT   
     CLTCODE = L.CODE,    
     ACCAT,    
     ACNAME = L.LONG_NAME,    
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(CRAMOUNT - DRAMOUNT)    
    FROM    
     (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
   FROM  
  ACC_LEDGER_PL  
  WHERE EXCHANGE = @EXCHANGE    
      AND SEGMENT = @SEGMENT    
   AND VDT < @YEARSTART    
  AND EDT >= @YEARSTART    
  AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  ) P, #CLIENT L    
    WHERE    
     P.CLTCODE = L.CODE    
    GROUP BY    
     L.CODE,  
     ACCAT,    
     L.LONG_NAME  
   ) A    
  GROUP BY    
   CLTCODE,    
   ACCAT,    
   ACNAME  
  ORDER BY    
   CLTCODE,    
   ACNAME    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_SUM_REV_SETT_MARGIN
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_SUM_REV_SETT_MARGIN_yogesh
-- --------------------------------------------------


CREATE  PROC [dbo].[RPT_ACCPLREPORT_SUM_REV_SETT_MARGIN_yogesh]
(
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@FCODE [UDTPARTYCODE],
	@TCODE [UDTPARTYCODE],
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@BRANCHCODE [UDTBRANCHCODE],
	@SELECTON VARCHAR(3),
	@SORTON VARCHAR(3),
	@EXCHANGE [UDTEXCHANGE],
	@SEGMENT [UDTSEGMENT],
	@SHOWMARGIN VARCHAR(1),
	@CLTYPE VARCHAR(3) = ''
)
AS
/*
	EXEC RPT_ACCPLREPORT_SUM_REV 'APR  1 2007', 'Mar 31 2008', '0', 'ZZZZZZ', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'
	EXEC RPT_ACCPLREPORT_SUM_REV_SETT_MARGIN 'APR  1 2007', 'Mar 31 2008', '0', 'ZZZZZZ', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'Y'
EXEC RPT_ACCPLREPORT_SUM_REV 'APR  1 2007', 'Mar 31 2008', '0', 'ZZZZZZ', 'BROKER', 'BROKER', '', 'EDT', 'EDT', 'NSE', 'CAPITAL'
	EXEC RPT_ACCPLREPORT_SUM_REV_SETT_MARGIN 'APR  1 2007', 'Mar 31 2008', '0', 'ZZZZZZ', 'BROKER', 'BROKER', '', 'EDT', 'VDT', 'NSE', 'CAPITAL', 'Y'
*/
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
	BEGIN
		SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
	END
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
	BEGIN
		SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
	END
DECLARE
	@YEARSTART VARCHAR(11),
	@YEAREND VARCHAR(11)
SELECT
	@YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),
	@YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)
FROM
	PARAMETER
WHERE
	@FDATE BETWEEN SDTCUR AND LDTCUR
	AND @TDATE BETWEEN SDTCUR AND LDTCUR

IF @YEARSTART IS NULL OR @YEAREND IS NULL
	BEGIN
		RAISERROR('Invalid Financial Information...', 16, 1)
		RETURN
	END
CREATE TABLE #DATA_PL
(
	ENTITY VARCHAR(20) NOT NULL
)
EXEC MAKE_UDT_STRUCTURE
	'#DATA_PL',
	'SETTLEMENT|CLTCODE|ACNAME|ACCAT|BRANCHCODE',
	'MONEY|UDTPARTYCODE|UDTACNAME|UDTACCAT|UDTBRANCHCODE',
	'',
	''
ALTER TABLE #DATA_PL
	ADD
		SRNO INT IDENTITY(1,1),
		VLINK INT DEFAULT 1,
		MARGIN MONEY,
		NETCLOSING MONEY

CREATE TABLE #CLIENT
(
	TRADER VARCHAR(20),
	SUB_BROKER VARCHAR(20),
	[L_ADDRESS1] VARCHAR(50) NOT NULL,  
	[L_ADDRESS2] VARCHAR(50) NOT NULL,  
	[L_ADDRESS3] VARCHAR(50) NOT NULL,  
	[L_CITY] VARCHAR(35) NOT NULL,  
	[L_STATE] VARCHAR(100) NOT NULL,  
	[L_NATION] VARCHAR(50) NOT NULL,  
	[L_ZIP] VARCHAR(12) NOT NULL,  
	[FAX] VARCHAR(20) NOT NULL,  
	[RES_PHONE1] VARCHAR(30) NOT NULL,  
	[RES_PHONE2] VARCHAR(30) NOT NULL,  
	[MOBILE_PAGER] VARCHAR(50) NOT NULL,  
	[PAN_GIR_NO] VARCHAR(10) NOT NULL,  
	[EMAIL] VARCHAR(100) NOT NULL, 
	[CL_TYPE] VARCHAR(3) NOT NULL,  
    [BANK_NAME] VARCHAR(100)NULL,  
    [ACC_NUM] VARCHAR(40)NULL
)

EXEC MAKE_UDT_STRUCTURE
	'#CLIENT',
	'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',
	'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',
	'',
	''

DECLARE
	@@SHAREDB VARCHAR(20),
	@@SQL VARCHAR(1000)

SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT


SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,  
						L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION, BANK_NAME, ACC_NUM) "
SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + "..UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"

EXEC (@@SQL)

--CREATE TABLE #DATA_PL
--(
--	ENTITY VARCHAR(20) NOT NULL,
--	SETTLEMENT MONEY,
--	CLTCODE [UDTPARTYCODE],--VARCHAR(45) NOT NULL, -- Increased the Field Length for Branch Control Account Reverse Effect (Routed Entries)
--	ACNAME UDTACNAME,
--	ACCAT UDTACCAT,
--	BRANCHCODE UDTBRANCHCODE,
----	FDATE VARCHAR(11),
----	TDATE VARCHAR(11),
----	SELECTON VARCHAR(3),
----	SORTON VARCHAR(10),
----	EXCHANGE UDTEXCHANGE NULL,
----	SEGMENT UDTSEGMENT NULL,
----	CLTRW INT,
----	ACNRW INT,
--	SRNO INT IDENTITY(1,1),
--	VLINK INT DEFAULT 1,
--	MARGIN MONEY,
--	NETCLOSING MONEY
--)

IF @SELECTON = 'VDT'
	BEGIN
		INSERT INTO #DATA_PL(ENTITY, SETTLEMENT , CLTCODE, ACCAT, ACNAME, BRANCHCODE, MARGIN, NETCLOSING)
		SELECT
			ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),
			SETTLEMENT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN -SUM(DRAMOUNT - CRAMOUNT)
							  WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE '' END,
			CLTCODE = L.CODE,
			ACCAT,
			ACNAME = L.LONG_NAME,
			BRANCHCODE = CASE WHEN @BRANCHCODE = '%' THEN '' ELSE @BRANCHCODE END,
			MARGIN = 0,
			NETCLOSING =  CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN -SUM(DRAMOUNT - CRAMOUNT) 
							  WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE '' END
		FROM
			ACC_LEDGER_PL P, #CLIENT L
		WHERE
			P.CLTCODE = L.CODE
			AND VTYPE NOT IN (19, 20, 22, 23, 24)
			AND EXCHANGE = @EXCHANGE
			AND SEGMENT = @SEGMENT
			AND VDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'
			AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--			AND @STATUSNAME = 
--						(
--							CASE @STATUSID
--								WHEN 'AREA' THEN AREA
--								WHEN 'REGION' THEN REGION
--								WHEN 'SUBBROKER' THEN SUB_BROKER
--								WHEN 'TRADER' THEN TRADER
--								WHEN 'BRANCH' THEN BRANCH_CD
--								WHEN 'FAMILY' THEN FAMILY
--								WHEN 'CLIENT' THEN CLTCODE
--							ELSE
--								'BROKER'
--							END
--						)			
		GROUP BY
			L.CODE,
			ACCAT,
			L.LONG_NAME

		IF @SHOWMARGIN = 'Y' 
			BEGIN

				INSERT INTO #DATA_PL(ENTITY, SETTLEMENT, CLTCODE, ACCAT, ACNAME, BRANCHCODE, MARGIN, NETCLOSING) 
			SELECT 
				ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),
				SETTLEMENT = 0,
				CLTCODE = L.CODE,
				ACCAT,
				ACNAME = L.LONG_NAME,
				BRANCHCODE = @BRANCHCODE,
				MARGIN = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN -SUM(DRAMOUNT - CRAMOUNT) 
							WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE '' END,
				NETCLOSING =  CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN -SUM(DRAMOUNT - CRAMOUNT) 
								  WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE '' END
			FROM
				ACC_LEDGER_PL P, #CLIENT L
			WHERE
				P.CLTCODE = L.CODE
				AND VTYPE IN (19, 20, 22, 23, 24)
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT					
				AND VDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'
				AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'AREA' THEN AREA
--										WHEN 'REGION' THEN REGION
--										WHEN 'SUBBROKER' THEN SUB_BROKER
--										WHEN 'TRADER' THEN TRADER
--										WHEN 'BRANCH' THEN BRANCH_CD
--										WHEN 'FAMILY' THEN FAMILY
--										WHEN 'CLIENT' THEN CLTCODE
--									ELSE
--										'BROKER'
--									END
--								)			
			GROUP BY
				L.CODE, L.LONG_NAME, ACCAT
		END
	END
ELSE
	BEGIN  --EDT
		INSERT INTO #DATA_PL(ENTITY, SETTLEMENT, CLTCODE, ACCAT, ACNAME, BRANCHCODE, 
							MARGIN, NETCLOSING)
		SELECT
			ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),
			SETTLEMENT = CASE WHEN SUM(BALANCE) > 0 THEN -SUM(BALANCE) 
								WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END,
			CLTCODE,
			ACCAT,
			ACNAME,
			BRANCHCODE = @BRANCHCODE,
			MARGIN = 0,
			NETCLOSING = CASE WHEN SUM(BALANCE) > 0 THEN -SUM(BALANCE) 
								WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END
		FROM
			(
				SELECT
					CLTCODE = L.CODE,
					ACCAT,
					ACNAME = L.LONG_NAME,
					--BRANCHCODE = @BRANCHCODE,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT)
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE NOT IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT					
					AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'AREA' THEN AREA
--										WHEN 'REGION' THEN REGION
--										WHEN 'SUBBROKER' THEN SUB_BROKER
--										WHEN 'TRADER' THEN TRADER
--										WHEN 'BRANCH' THEN BRANCH_CD
--										WHEN 'FAMILY' THEN FAMILY
--										WHEN 'CLIENT' THEN CLTCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE,
					ACCAT,
					L.LONG_NAME
				UNION ALL
				SELECT
					CLTCODE = L.CODE,
					ACCAT,
					ACNAME = L.LONG_NAME,
					--BRANCHCODE = @BRANCHCODE,
					BALANCE = SUM(CRAMOUNT - DRAMOUNT)
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE NOT IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT < @YEARSTART
					AND EDT >= @YEARSTART
					--AND ACCAT IN (4, 104)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'AREA' THEN AREA
--										WHEN 'REGION' THEN REGION
--										WHEN 'SUBBROKER' THEN SUB_BROKER
--										WHEN 'TRADER' THEN TRADER
--										WHEN 'BRANCH' THEN BRANCH_CD
--										WHEN 'FAMILY' THEN FAMILY
--										WHEN 'CLIENT' THEN CLTCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE,
					ACCAT,
					L.LONG_NAME
			) A
		GROUP BY
			CLTCODE,
			ACCAT,
			ACNAME

		IF @SHOWMARGIN = 'Y' 
		BEGIN
			
		INSERT INTO #DATA_PL(ENTITY, SETTLEMENT, CLTCODE, ACCAT, ACNAME, BRANCHCODE, 
							MARGIN, NETCLOSING)
		SELECT
			ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),
			SETTLEMENT = 0,
			CLTCODE,
			ACCAT,
			ACNAME,
			BRANCHCODE = @BRANCHCODE,
			MARGIN = CASE WHEN SUM(BALANCE) > 0 THEN -SUM(BALANCE) 
								WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END,
			NETCLOSING = CASE WHEN SUM(BALANCE) > 0 THEN -SUM(BALANCE) 
								WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END
		FROM
			(
				SELECT
					CLTCODE = L.CODE,
					ACCAT,
					ACNAME = L.LONG_NAME,
					--BRANCHCODE = @BRANCHCODE,
					BALANCE = SUM(DRAMOUNT - CRAMOUNT)
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE  IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'
					--AND ACCAT IN (4, 104)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'AREA' THEN AREA
--										WHEN 'REGION' THEN REGION
--										WHEN 'SUBBROKER' THEN SUB_BROKER
--										WHEN 'TRADER' THEN TRADER
--										WHEN 'BRANCH' THEN BRANCH_CD
--										WHEN 'FAMILY' THEN FAMILY
--										WHEN 'CLIENT' THEN CLTCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE,
					ACCAT,
					L.LONG_NAME
				UNION ALL
				SELECT
					CLTCODE = L.CODE,
					ACCAT,
					ACNAME = L.LONG_NAME,
					--BRANCHCODE = @BRANCHCODE,
					BALANCE = SUM(CRAMOUNT - DRAMOUNT)
				FROM
					ACC_LEDGER_PL P, #CLIENT L
				WHERE
					P.CLTCODE = L.CODE
					AND VTYPE  IN (19, 20, 22, 23, 24)
					AND EXCHANGE = @EXCHANGE
					AND SEGMENT = @SEGMENT
					--AND CLTCODE BETWEEN @FCODE AND @TCODE
					AND VDT < @YEARSTART
					AND EDT >= @YEARSTART
					--AND ACCAT IN (4, 104)
					AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END
--					AND @STATUSNAME = 
--								(
--									CASE @STATUSID
--										WHEN 'AREA' THEN AREA
--										WHEN 'REGION' THEN REGION
--										WHEN 'SUBBROKER' THEN SUB_BROKER
--										WHEN 'TRADER' THEN TRADER
--										WHEN 'BRANCH' THEN BRANCH_CD
--										WHEN 'FAMILY' THEN FAMILY
--										WHEN 'CLIENT' THEN CLTCODE
--									ELSE
--										'BROKER'
--									END
--								)
				GROUP BY
					L.CODE,
					ACCAT,
					L.LONG_NAME
			) A
		GROUP BY
			CLTCODE,
			ACCAT,
			ACNAME
	END
END

IF @SHOWMARGIN <> 'Y' 
	BEGIN
		SELECT ENTITY, CLTCODE, ACNAME, ACCAT, BRANCHCODE, SETTLEMENT, MARGIN, NETCLOSING, VLINK, 
			FDATE = @FDATE,
			TDATE = @TDATE,
			SELECTON = @SELECTON,
			SORTON = @SORTON,
			EXCHANGE = @EXCHANGE,
			SEGMENT = @SEGMENT,
			CLTRW = ROW_NUMBER() OVER (ORDER BY CLTCODE),
			ACNRW = ROW_NUMBER() OVER (ORDER BY ACNAME)
		FROM #DATA_PL
ORDER BY
			CASE WHEN @SORTON = 'CODEWISE' THEN CLTCODE ELSE ACNAME END
			
	END
ELSE
	BEGIN	
		SELECT ENTITY, CLTCODE, ACNAME, ACCAT, BRANCHCODE,
				SETTLEMENT = SUM(SETTLEMENT),
				MARGIN = SUM(MARGIN),
				NETCLOSING = SUM(NETCLOSING), VLINK, 
				FDATE = @FDATE,
				TDATE = @TDATE,
				SELECTON = @SELECTON,
				SORTON = @SORTON,
				EXCHANGE = @EXCHANGE,
				SEGMENT = @SEGMENT,
				CLTRW = ROW_NUMBER() OVER (ORDER BY CLTCODE),
				ACNRW = ROW_NUMBER() OVER (ORDER BY ACNAME)
		FROM #DATA_PL
		GROUP BY ENTITY, CLTCODE, ACNAME, BRANCHCODE, ACCAT, VLINK
		ORDER BY
					CASE WHEN @SORTON = 'CODEWISE' THEN CLTCODE ELSE ACNAME END
END

select * from #DATA_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCPLREPORT_SUM_REV_TOTAL
-- --------------------------------------------------
  
create PROC [dbo].[RPT_ACCPLREPORT_SUM_REV_TOTAL]    
(    
 @FDATE VARCHAR(11),    
 @TDATE VARCHAR(11),    
 @FCODE [UDTPARTYCODE],    
 @TCODE [UDTPARTYCODE],    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @BRANCHCODE [UDTBRANCHCODE],    
 @SELECTON VARCHAR(3),    
 @SORTON VARCHAR(3),    
 @EXCHANGE [UDTEXCHANGE],    
 @SEGMENT [UDTSEGMENT],    
 @CLTYPE VARCHAR(3) = ''    
)    
  
AS    
/*    
 EXEC RPT_ACCPLREPORT_SUM_REV 'APR  1 2007', 'Jun  1 2007', '0', 'ZZZZZZ', 'BROKER', 'BROKER', 'AL001', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'INS'    
*/    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0    
 BEGIN    
  SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)    
 END    
IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0    
 BEGIN    
  SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)    
 END    
DECLARE    
 @YEARSTART VARCHAR(11),    
 @YEAREND VARCHAR(11)    
SELECT    
 @YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),    
 @YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)    
FROM    
 PARAMETER    
WHERE    
 @FDATE BETWEEN SDTCUR AND LDTCUR    
 AND @TDATE BETWEEN SDTCUR AND LDTCUR    
    
IF @YEARSTART IS NULL OR @YEAREND IS NULL    
 BEGIN    
  RAISERROR('Invalid Financial Information...', 16, 1)    
  RETURN    
 END    
  
CREATE TABLE #CLIENT   
(  
 TRADER VARCHAR(20),  
 SUB_BROKER VARCHAR(20),  
 [L_ADDRESS1] VARCHAR(50) NOT NULL,    
 [L_ADDRESS2] VARCHAR(50) NOT NULL,    
 [L_ADDRESS3] VARCHAR(50) NOT NULL,    
 [L_CITY] VARCHAR(35) NOT NULL,    
 [L_STATE] VARCHAR(100) NOT NULL,    
 [L_NATION] VARCHAR(50) NOT NULL,    
 [L_ZIP] VARCHAR(12) NOT NULL,    
 [FAX] VARCHAR(20) NOT NULL,    
 [RES_PHONE1] VARCHAR(30) NOT NULL,    
 [RES_PHONE2] VARCHAR(30) NOT NULL,    
 [MOBILE_PAGER] VARCHAR(50) NOT NULL,    
 [PAN_GIR_NO] VARCHAR(10) NOT NULL,    
 [EMAIL] VARCHAR(100) NOT NULL,   
 [CL_TYPE] VARCHAR(3) NOT NULL,  
 [BANK_NAME] VARCHAR(100) NOT NULL,  
 [ACC_NUM] VARCHAR(40) NOT NULL  
)  
  
EXEC MAKE_UDT_STRUCTURE  
 '#CLIENT',  
 'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',  
 'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',  
 '',  
 ''  
  
DECLARE  
 @@SHAREDB VARCHAR(20),  
 @@SQL VARCHAR(1000)  
  
SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
  
SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,    
      L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION,BANK_NAME,ACC_NUM) "  
SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + "..UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"  
  
EXEC (@@SQL)  
  
IF @SELECTON = 'VDT'    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END,    
   CLTCODE = 'ZZZZZZZZ',    
   ACCAT,    
   ACNAME = 'PARTY TOTAL',    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = 0,   
   ACNRW = 0  
  FROM    
   ACC_LEDGER_PL P    
  WHERE    
   EXISTS (SELECT CODE FROM #CLIENT L WHERE P.CLTCODE = L.CODE)    
   AND EXCHANGE = @EXCHANGE    
   AND SEGMENT = @SEGMENT    
   AND VDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
   AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
  GROUP BY    
   ACCAT   
 END    
ELSE    
 BEGIN    
  SELECT    
   ENTITY = LTRIM(RTRIM(@EXCHANGE)) + '-' + LTRIM(RTRIM(@SEGMENT)),    
   DRAMT = CASE WHEN SUM(BALANCE) >= 0 THEN SUM(BALANCE) ELSE 0 END,    
   CRAMT = CASE WHEN SUM(BALANCE) <  0 THEN ABS(SUM(BALANCE)) ELSE 0 END,    
   CLTCODE ,    
   ACCAT,    
   ACNAME ,    
   BRANCHCODE = @BRANCHCODE,    
   FDATE = @FDATE,    
   TDATE = @TDATE,    
   SELECTON = @SELECTON,    
   SORTON = @SORTON,    
   EXCHANGE = @EXCHANGE,    
   SEGMENT = @SEGMENT,    
   CLTRW = 0,    
   ACNRW = 0    
  FROM    
   (    
    SELECT    
     CLTCODE = 'ZZZZZZZZ',    
     ACCAT,    
     ACNAME = 'PARTY TOTAL',      
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(DRAMOUNT - CRAMOUNT)    
    FROM    
     ACC_LEDGER_PL P    
    WHERE    
     EXISTS (SELECT CODE FROM #CLIENT L WHERE P.CLTCODE = L.CODE)    
     AND EXCHANGE = @EXCHANGE    
     AND SEGMENT = @SEGMENT    
     AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'    
     AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
    GROUP BY    
     ACCAT   
    UNION ALL    
    SELECT    
     CLTCODE = 'ZZZZZZZZ',    
     ACCAT,    
     ACNAME = 'PARTY TOTAL',   
     BRANCHCODE = @BRANCHCODE,    
     BALANCE = SUM(CRAMOUNT - DRAMOUNT)    
    FROM    
     ACC_LEDGER_PL P    
    WHERE    
     EXISTS (SELECT CODE FROM #CLIENT L WHERE P.CLTCODE = L.CODE)    
     AND EXCHANGE = @EXCHANGE    
     AND SEGMENT = @SEGMENT    
     AND VDT < @YEARSTART    
     AND EDT >= @YEARSTART    
     AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END    
    GROUP BY    
     ACCAT  
   ) A    
  GROUP BY    
   CLTCODE,    
   ACCAT,    
   ACNAME  
  ORDER BY    
   CLTCODE,    
   ACNAME    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCREPORT_MULTI_EXCHANGE
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[RPT_ACCREPORT_MULTI_EXCHANGE]        
    
    
      
 @FDATE VARCHAR(11),              
 @TDATE VARCHAR(11),              
 @FCODE [UDTPARTYCODE],              
 @TCODE [UDTPARTYCODE],              
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @BRANCHCODE [UDTBRANCHCODE],              
 @SELECTON VARCHAR(3),              
 @SORTON VARCHAR(3),              
 @SEG_EXC VARCHAR(200),              
 @ACCAT UDTACCAT,              
 @MEMBERADDR VARCHAR(1),              
 @SHOWMARGIN VARCHAR(1) = 'N',              
 @VTYPE VARCHAR(70) = '',              
 @WITHXML VARCHAR(1) = 'N',              
 @CLTYPE VARCHAR(3) = ''              
AS              
/*              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '4', 'Y', 'Y', '', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '1', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '2', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '3', 'Y'              
              
*/              
               
 SET NOCOUNT ON;              
 BEGIN TRY              
 SET NOCOUNT ON;              
  IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'              
   BEGIN              
    RAISERROR('This Report is not available for your type of Login', 16, 1)              
    RETURN              
   END 
   
   IF @ACCAT = 4 AND @STATUSID = 'BROKER'
		SET @BRANCHCODE = ''             

  DECLARE @EXSEDATA VARCHAR(20),              
   @EXCHANGE VARCHAR(20),              
   @SEGMENT VARCHAR(20),              
   @ROWPOS INT,              
   @SQL VARCHAR(MAX),              
   @SHAREDB VARCHAR(25),              
   @COMPNAME VARCHAR(100),              
   @COMPADDR VARCHAR(400)              
              
                
  SET @ROWPOS = 1               
  CREATE TABLE #TEMP_DATA              
  (              
   ENTITY VARCHAR(25)              
  )              
  EXEC MAKE_UDT_STRUCTURE              
   '#TEMP_DATA',              
   'BOOKTYPE|VOUDT1|EFFDT1|VTYPE|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO|RUNNINGBALANCE|PROCID|REPDATE|MAINCODE|VCHDT|SRNO|SLML|DELVTYPE|COMPNAME|COMPADDR',              
   'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|VARCHAR|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT|MONEY|BIGINT|VARCHAR|UDTPARTYCODE|DATETIME|INT|VARCHAR|UDTVTYPE|VARCHAR|VRCHAR',              
   '|10|10|6|||||50||||||||||35||8||8||||1||100|500',              
   '0|0|0|1|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'              
  ALTER TABLE #TEMP_DATA ADD SRNUMBER INT IDENTITY(1,1)              
--  CREATE TABLE #TEMP_DATA              
--   (              
--    [ENTITY] VARCHAR(25),              
--    [BOOKTYPE] [UDTBOOKTYPE] NULL,--              
--    [VOUDT1] [VARCHAR] (10) NULL,              
--    [EFFDT1] [VARCHAR] (10) NULL,              
--    [VTYPE] [CHAR] (6) NOT NULL DEFAULT(' '),              
--    [DRAMT] [MONEY] NULL,              
--    [CRAMT] [MONEY] NULL,              
--    [VNO] [UDTVNO] NULL,              
--    [NARRATION] [UDTNARRATION] NULL,              
--    [DDNO] [UDTINSTNO] NULL,              
--    [CLTCODE] [UDTPARTYCODE] NOT NULL,              
--    [LONGNAME] [UDTACNAME] NULL,              
--    [VDT] [DATETIME] NULL,--              
--    [EDT] [DATETIME] NULL,--              
--    [VTYP] [UDTVTYPE] NULL,              
--    [ACCAT] [UDTACCAT] NULL,--              
-- [OPBAL] [MONEY] NULL,              
--    [CROSAC] [UDTPARTYCODE] NULL,              
--    [ACNAME] [UDTACNAME] NULL,              
--    [BRANCHCODE] VARCHAR(35) NULL,              
--    [MASTERSNO] BIGINT,              
--    RUNNINGBALANCE MONEY,              
--    --[SNO] INT IDENTITY(1,1)              
--    PROCID BIGINT NULL,--          
--    REPDATE VARCHAR (8) NULL,--              
--    MAINCODE [UDTPARTYCODE] NULL,--              
--    VCHDT DATETIME NULL,--              
--    SRNO INT NULL,--              
--    SLML VARCHAR(1) NULL,              
--    DELVTYPE UDTVTYPE NULL,              
--    COMPNAME VARCHAR(100),              
--    COMPADDR VARCHAR(500),              
--    SRNUMBER INT IDENTITY(1,1)              
--   )--to delete column sign  end with --              
              
   CREATE TABLE #COMPDATA              
   (              
    COMPNAME VARCHAR(100),              
    COMPADDR VARCHAR(500)              
   )                  
            
   CREATE TABLE #CLIENTS            
   (              
    TRADER VARCHAR(20),              
    SUB_BROKER VARCHAR(20),              
    [L_ADDRESS1] VARCHAR(50) NOT NULL,                
    [L_ADDRESS2] VARCHAR(50) NOT NULL,                
    [L_ADDRESS3] VARCHAR(50) NOT NULL,                
    [L_CITY] VARCHAR(35) NOT NULL,                
    [L_STATE] VARCHAR(50) NOT NULL,                
    [L_NATION] VARCHAR(50) NOT NULL,                
    [L_ZIP] VARCHAR(6) NOT NULL,                
    [FAX] VARCHAR(20) NOT NULL,                
    [RES_PHONE1] VARCHAR(15) NOT NULL,                
    [RES_PHONE2] VARCHAR(15) NOT NULL,                
    [MOBILE_PAGER] VARCHAR(50) NOT NULL,                
    [PAN_GIR_NO] VARCHAR(10) NOT NULL,                
    [EMAIL] VARCHAR(50) NOT NULL,               
    [CL_TYPE] VARCHAR(3) NOT NULL,              
    [BANK_NAME] VARCHAR(50)NULL,              
    [ACC_NUM] VARCHAR(40)NULL            
   )              
              
   EXEC MAKE_UDT_STRUCTURE              
    '#CLIENTS',              
    'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',              
    'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',              
    '',              
    ''              
     
	       
            
   DECLARE              
    @@SHAREDB VARCHAR(20),              
    @@SQL VARCHAR(1000)              
            
   WHILE 1 = 1              
    BEGIN              
     SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))              
     IF @EXSEDATA IS NULL OR @EXSEDATA = ''              
      BEGIN              
       BREAK              
      END              
              
     SET @EXCHANGE = .DBO.PIECE(@EXSEDATA, '-', 1)              
     SET @SEGMENT = .DBO.PIECE(@EXSEDATA, '-', 2)              
              
     SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1              
             
            
    SET @@SQL = "INSERT INTO #CLIENTS(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,     L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA, REGION, BANK_NAME, ACC_NUM) "              
        SET @@SQL = @@SQL + " SELECT * FROM " + @SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"              
    PRINT @@SQL            
    EXEC (@@SQL) 
	
	           
                   
     SET @SQL = "SELECT '', '', '', '', '', '', '<B>' + LTRIM(RTRIM(COMPANY)) + '</B>', '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '',"              
     SET @SQL =  @SQL + " '', '', '', '', '', '', '', '' FROM " + @SHAREDB + ".DBO.OWNER "              
        
              
              
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
     EXEC(@SQL)  
	 
	             
              
     IF @MEMBERADDR = 'Y'              
      BEGIN              
       SET @SQL = "SELECT '', '', '', '', '', '', ( '<B>' + ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE + '</B>'),  "               
       SET @SQL =  @SQL + " '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '', '', '', '', '', '', '', '', '' "              
       SET @SQL =  @SQL + " FROM " + @SHAREDB + ".DBO.OWNER "              
              
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
          DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
          BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
       EXEC(@SQL)              
      END              
                   
                   
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)           VALUES ('', '', '', '', '', '', '<B>' + ':: ' + @EXSEDATA + ' ::' + '</B>', '', '', '', '' , @EXSEDATA, '', '', '' , '', '', '', '',              
        '', '', '', '', '', '', '', '')     
		      
            
     IF @ACCAT = '1'              
      BEGIN 
      print 'suresh'             
       -- EXEC RPT_ACCCBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'CAPITAL'              
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,              
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,              
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)              
       EXEC RPT_ACCCBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT              
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      END              
     ELSE IF @ACCAT = '2'              
      BEGIN 
      print 'suresh1'                          
       --EXEC RPT_ACCBBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'FUTURES'              
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,              
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,              
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)              
       EXEC RPT_ACCBBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT                    
       IF @@ROWCOUNT = 0              
        BEGIN 
        print 'suresh3'                          
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      END              
     ELSE IF @ACCAT = '4'              
      BEGIN 
      print 'suresh4'                          
       -- EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'  
	   
	   
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)--, COMPNAME, COMPADDR     
		 
		       
       EXEC RPT_ACCPLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @SHOWMARGIN, @VTYPE, 'N', @CLTYPE              
       
       
        
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "              
              
      INSERT INTO #COMPDATA(COMPNAME, COMPADDR)              
      EXEC(@SQL) 
      print @SQL             
              
      UPDATE D              
       SET D.COMPNAME = C.COMPNAME,              
        D.COMPADDR = C.COMPADDR              
      FROM #TEMP_DATA D, #COMPDATA C              
      WHERE ENTITY = @EXSEDATA              
              
      DELETE  FROM #COMPDATA              
              
      END              
     ELSE               
      BEGIN   
              
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO)              
       EXEC RPT_ACCGLREPORT_REV_NEW @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT              
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '') 
                        
        END  
                    
      END              
                  
              
              
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
     VALUES ('', '', '', '', '', '', '&nbsp;', '', '', '', '' , '', '', '', '' , '', '', '', '',              
        '', '', '', '', '', '', '', '')              
     SET @ROWPOS = @ROWPOS + 1      
   END              
 --SELECT * FROM #TEMP_DATA RETURN              
   INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)              
   SELECT VOUDT1 = '',              
     EFFDT1 = '',              
     VTYPE = '',              
     VNO = '',              
     CROSAC = '',              
     BRANCHCODE = '',              
     NARRATION = '<B>' + 'Net Closing Balance' + '</B>',              
     DDNO = '',              
     DRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) >= 0 THEN SUM(DRAMT) - SUM(CRAMT) ELSE 0 END,              
     CRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) < 0 THEN SUM(CRAMT) - SUM(DRAMT) ELSE 0 END,              
     RUNNINGBALANCE = 0,              
     ENTITY = '',              
     CLTCODE,              
     LONGNAME = '',              
     VTYP = '',              
     MASTERSNO = 0,              
     SLML = '3',              
DELVTYPE = 0              
   FROM #TEMP_DATA              
   WHERE VTYP = 0 AND CLTCODE <> ''              
   GROUP BY CLTCODE              
              
--   SELECT VOUDT1, EFFDT1, vtype = VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
--        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
--        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO              
--     FROM #TEMP_DATA              
  IF @ACCAT = '4'              
   BEGIN--@WITHXML              
    IF @WITHXML = 'Y'               
     BEGIN  --SELECT SRNUMBER, VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, NARRATION, DDNO, DRAMT, CRAMT, RUNNINGBALANCE, MASTERSNO, VTYPE  FROM #TEMP_DATA              
      SELECT SRNUMBER,               
        VOUDT1 = CASE WHEN VOUDT1 <> '' AND VNO = '' THEN              
           '<B>' + VOUDT1 + '</B>'              
          ELSE VOUDT1 END,              
        EFFDT1 = CASE WHEN EFFDT1 <> '' AND VNO = '' THEN              
           '<B>' + EFFDT1 + '</B>'              
          ELSE EFFDT1 END,              
        VTYPE= CASE WHEN VTYPE <> '' AND VNO = '' THEN              
           '<B>' + VTYPE + '</B>'              
          ELSE VTYPE END,              
        VNO, CROSAC, NARRATION, DDNO,               
        DRAMT = CASE WHEN VOUDT1 = '' AND EFFDT1 = '' AND SLML <> 3 THEN ''               
           ELSE               
            CASE WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'              
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), DRAMT )              
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN              
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'              
             ELSE ''              
             END              
          END,               
        CRAMT = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' AND SLML <> 3 THEN ''                
           ELSE               
            CASE WHEN (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'              
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), CRAMT )              
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN              
             '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'              
             ELSE ''              
            END              
          END,               
        RUNNINGBALANCE = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' OR (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN ''                
             ELSE               
              CONVERT(VARCHAR(24), RUNNINGBALANCE )           
            END,              
        MASTERSNO, VTYP              
      FROM #TEMP_DATA              
      --FOR XML RAW              
     END              
    ELSE              
     BEGIN               
                  
      SELECT --D.*,              
        D.ENTITY ,  D.BOOKTYPE,              
        VOUDT1 = CASE WHEN D.VOUDT1 <> '' AND D.VNO = '' THEN              
           '<B>' + D.VOUDT1 + '</B>'              
           WHEN D.VOUDT1 = '' THEN '&nbsp;'              
           ELSE D.VOUDT1 END,              
        EFFDT1 = CASE WHEN D.EFFDT1 <> '' AND D.VNO = '' THEN              
           '<B>' + D.EFFDT1 + '</B>'              
          ELSE D.EFFDT1 END,              
        VTYPE= CASE WHEN D.VTYPE <> '' AND D.VNO = '' THEN              
           '<B>' + D.VTYPE + '</B>'              
          ELSE D.VTYPE END,                     
        DRAMT = CASE WHEN (D.VOUDT1 = '' AND D.EFFDT1 = '') AND D.SLML <> 3 THEN ''               
           ELSE               
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'              
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), D.DRAMT )                         WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE = '' AND D.SLML = 3 THEN              
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'              
             ELSE ''              
             END              
          END,               
        CRAMT = --d.cramt,              
         CASE WHEN (D.VOUDT1 = '' OR D.EFFDT1 = '') AND D.SLML <> 3 THEN ''                
           ELSE               
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'              
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), D.CRAMT )              
             WHEN  D.VTYPE = '' AND D.SLML = 3 THEN              
             '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'              
             ELSE ''              
            END              
          END,              
        D.VNO, D.NARRATION, D.DDNO ,D.CLTCODE, D.LONGNAME, D.VDT, D.EDT, D.VTYP,D.ACCAT,              
        D.OPBAL, D.CROSAC, D.ACNAME, D.BRANCHCODE, D.MASTERSNO,              
        RUNNINGBALANCE = CASE WHEN D.VOUDT1 = '' OR D.EFFDT1 = '' OR (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN ''                
             ELSE               
              CONVERT(VARCHAR(24), D.RUNNINGBALANCE )              
            END,               
        D.PROCID, D.REPDATE, D.MAINCODE, D.VCHDT, D.SRNO, D.SLML, D.DELVTYPE, D.COMPNAME, D.COMPADDR, D.SRNUMBER,              
        LTRIM(RTRIM(C.SUB_BROKER)) SUB_BROKER, LTRIM(RTRIM(C.TRADER)) TRADER,              
        LTRIM(RTRIM(C.L_ADDRESS1)) L_ADDRESS1, LTRIM(RTRIM(C.L_CITY)) L_CITY,              
        LTRIM(RTRIM(C.L_ADDRESS2)) L_ADDRESS2, LTRIM(RTRIM(C.L_STATE)) L_STATE,              
        LTRIM(RTRIM(C.L_ADDRESS3)) L_ADDRESS3, LTRIM(RTRIM(C.CL_TYPE)) CL_TYPE,              
        LTRIM(RTRIM(C.L_ZIP)) L_ZIP,-- LTRIM(RTRIM(C.PAN_GIR_NO)) PAN_GIR_NO,              
        LTRIM(RTRIM(C.RES_PHONE1)) RES_PHONE1, --LTRIM(RTRIM(C.RES_PHONE2)) RES_PHONE2,              
        --LTRIM(RTRIM(C.MOBILE_PAGER)) MOBILE_PAGER, LTRIM(RTRIM(C.EMAIL)) EMAIL,              
LTRIM(RTRIM(C.AREA)) AREA, LTRIM(RTRIM(C.BANK_NAME)) BANK_NAME,              
        LTRIM(RTRIM(C.FAMILY)) FAMILY, LTRIM(RTRIM(C.ACC_NUM)) AC_NUM              
      FROM #TEMP_DATA D LEFT JOIN  #CLIENTS C              
      ON  D.CLTCODE = C.CODE              
      ORDER BY D.SRNUMBER              
     END              
 --   SELECT * FROM MSAJAG.DBO.CLIENT_DETAILS              
 END              
  ELSE --IF IF @ACCAT = '4'              
   BEGIN               
                  
   SELECT ENTITY,BOOKTYPE,VOUDT1,EFFDT1,VTYPE,              
   DRAMT = CONVERT(VARCHAR(24), DRAMT ),              
   CRAMT = CONVERT(VARCHAR(24), CRAMT ),VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,EDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,MASTERSNO,              
   RUNNINGBALANCE = CONVERT(VARCHAR(24), RUNNINGBALANCE ),PROCID,REPDATE,MAINCODE,VCHDT,SRNO,SLML,DELVTYPE,COMPNAME,COMPADDR,SRNUMBER              
 FROM #TEMP_DATA ORDER BY SRNUMBER              
   END              
              
  DROP TABLE #TEMP_DATA              
      
END TRY              
BEGIN CATCH              
 DECLARE @ERRMSG VARCHAR(MAX)              
 SET @ERRMSG = ERROR_MESSAGE()              
 RAISERROR( @ERRMSG, 16, 1)              
END CATCH              
/*              
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2008', '31/03/2009', '010A141', '010A141', 'broker', 'broker', 'HO', 'VDT', 'codewise', 'NSE-CAPITAL| NSE-FUTURES', '4', 'Y', 'Y', '', 'n'              
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2009', '06/10/2009', '100', '100', 'broker', 'broker', 'ALL', 'VDT', 'codewise', 'NSE-CAPITAL', '3', '', 'Y', '', 'N'              
*/     
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCREPORT_MULTI_EXCHANGE_12102010
-- --------------------------------------------------
    
  
  
  
CREATE  PROCEDURE [dbo].[RPT_ACCREPORT_MULTI_EXCHANGE_12102010]      
  
  
    
 @FDATE VARCHAR(11),            
 @TDATE VARCHAR(11),            
 @FCODE [UDTPARTYCODE],            
 @TCODE [UDTPARTYCODE],            
 @STATUSID VARCHAR(25),            
 @STATUSNAME VARCHAR(25),            
 @BRANCHCODE [UDTBRANCHCODE],            
 @SELECTON VARCHAR(3),            
 @SORTON VARCHAR(3),            
 @SEG_EXC VARCHAR(200),            
 @ACCAT UDTACCAT,            
 @MEMBERADDR VARCHAR(1),            
 @SHOWMARGIN VARCHAR(1) = 'N',            
 @VTYPE VARCHAR(70) = '',            
 @WITHXML VARCHAR(1) = 'N',            
 @CLTYPE VARCHAR(3) = ''            
AS            
/*            
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '4', 'Y', 'Y', '', 'Y'            
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '1', 'Y'            
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '2', 'Y'            
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '3', 'Y'            
            
*/            
             
 SET NOCOUNT ON;            
 BEGIN TRY            
 SET NOCOUNT ON;            
  IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'            
   BEGIN            
    RAISERROR('This Report is not available for your type of Login', 16, 1)            
    RETURN            
   END            
  DECLARE @EXSEDATA VARCHAR(20),            
   @EXCHANGE VARCHAR(20),            
   @SEGMENT VARCHAR(20),            
   @ROWPOS INT,            
   @SQL VARCHAR(MAX),            
   @SHAREDB VARCHAR(25),            
   @COMPNAME VARCHAR(100),            
   @COMPADDR VARCHAR(400)            
            
              
  SET @ROWPOS = 1             
  CREATE TABLE #TEMP_DATA            
  (            
   ENTITY VARCHAR(25)            
  )            
  EXEC MAKE_UDT_STRUCTURE            
   '#TEMP_DATA',            
   'BOOKTYPE|VOUDT1|EFFDT1|VTYPE|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO|RUNNINGBALANCE|PROCID|REPDATE|MAINCODE|VCHDT|SRNO|SLML|DELVTYPE|COMPNAME|COMPADDR',            
   'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT|MONEY|BIGINT|VARCHAR|UDTPARTYCODE|DATETIME|INT|VARCHAR|UDTVTYPE|VARCHAR|V
RCHAR',            
   '|10|10|6|||||||||||||||35||8||8||||1||100|500',            
   '0|0|0|1|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'            
  ALTER TABLE #TEMP_DATA ADD SRNUMBER INT IDENTITY(1,1)            
--  CREATE TABLE #TEMP_DATA            
--   (            
--    [ENTITY] VARCHAR(25),            
--    [BOOKTYPE] [UDTBOOKTYPE] NULL,--            
--    [VOUDT1] [VARCHAR] (10) NULL,            
--    [EFFDT1] [VARCHAR] (10) NULL,            
--    [VTYPE] [CHAR] (6) NOT NULL DEFAULT(' '),            
--    [DRAMT] [MONEY] NULL,            
--    [CRAMT] [MONEY] NULL,            
--    [VNO] [UDTVNO] NULL,            
--    [NARRATION] [UDTNARRATION] NULL,            
--    [DDNO] [UDTINSTNO] NULL,            
--    [CLTCODE] [UDTPARTYCODE] NOT NULL,            
--    [LONGNAME] [UDTACNAME] NULL,            
--    [VDT] [DATETIME] NULL,--            
--    [EDT] [DATETIME] NULL,--            
--    [VTYP] [UDTVTYPE] NULL,            
--    [ACCAT] [UDTACCAT] NULL,--            
--    [OPBAL] [MONEY] NULL,            
--    [CROSAC] [UDTPARTYCODE] NULL,            
--    [ACNAME] [UDTACNAME] NULL,            
--    [BRANCHCODE] VARCHAR(35) NULL,            
--    [MASTERSNO] BIGINT,            
--    RUNNINGBALANCE MONEY,            
--    --[SNO] INT IDENTITY(1,1)            
--    PROCID BIGINT NULL,--        
--    REPDATE VARCHAR (8) NULL,--            
--    MAINCODE [UDTPARTYCODE] NULL,--            
--    VCHDT DATETIME NULL,--            
--    SRNO INT NULL,--            
--    SLML VARCHAR(1) NULL,            
--    DELVTYPE UDTVTYPE NULL,            
--    COMPNAME VARCHAR(100),            
--    COMPADDR VARCHAR(500),            
--    SRNUMBER INT IDENTITY(1,1)            
--   )--to delete column sign  end with --            
            
   CREATE TABLE #COMPDATA            
   (            
    COMPNAME VARCHAR(100),            
    COMPADDR VARCHAR(500)            
   )                
          
   CREATE TABLE #CLIENTS          
   (            
    TRADER VARCHAR(20),            
    SUB_BROKER VARCHAR(20),            
    [L_ADDRESS1] VARCHAR(50) NOT NULL,              
    [L_ADDRESS2] VARCHAR(50) NOT NULL,              
    [L_ADDRESS3] VARCHAR(50) NOT NULL,              
    [L_CITY] VARCHAR(35) NOT NULL,              
    [L_STATE] VARCHAR(50) NOT NULL,              
    [L_NATION] VARCHAR(50) NOT NULL,              
    [L_ZIP] VARCHAR(6) NOT NULL,              
    [FAX] VARCHAR(20) NOT NULL,              
    [RES_PHONE1] VARCHAR(15) NOT NULL,              
    [RES_PHONE2] VARCHAR(15) NOT NULL,              
    [MOBILE_PAGER] VARCHAR(50) NOT NULL,              
    [PAN_GIR_NO] VARCHAR(10) NOT NULL,              
    [EMAIL] VARCHAR(50) NOT NULL,             
    [CL_TYPE] VARCHAR(3) NOT NULL,            
    [BANK_NAME] VARCHAR(50)NULL,            
    [ACC_NUM] VARCHAR(40)NULL          
   )            
            
   EXEC MAKE_UDT_STRUCTURE            
    '#CLIENTS',            
    'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',            
    'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',            
    '',            
    ''            
            
          
   DECLARE            
    @@SHAREDB VARCHAR(20),            
    @@SQL VARCHAR(1000)            
          
   WHILE 1 = 1            
    BEGIN            
     SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))            
     IF @EXSEDATA IS NULL OR @EXSEDATA = ''            
      BEGIN            
       BREAK            
      END            
            
     SET @EXCHANGE = .DBO.PIECE(@EXSEDATA, '-', 1)            
     SET @SEGMENT = .DBO.PIECE(@EXSEDATA, '-', 2)            
            
     SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1            
           
          
    SET @@SQL = "INSERT INTO #CLIENTS(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,  
 L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA, REGION, BANK_NAME, ACC_NUM) "            
    SET @@SQL = @@SQL + " SELECT * FROM " + @SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"            
    PRINT @@SQL          
    EXEC (@@SQL)          
                 
     SET @SQL = "SELECT '', '', '', '', '', '', '<B>' + LTRIM(RTRIM(COMPANY)) + '</B>', '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '',"            
     SET @SQL =  @SQL + " '', '', '', '', '', '', '', '' FROM " + @SHAREDB + ".DBO.OWNER "            
          
            
            
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
     EXEC(@SQL)            
            
     IF @MEMBERADDR = 'Y'            
      BEGIN            
       SET @SQL = "SELECT '', '', '', '', '', '', ( '<B>' + ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE + '</B>'),  "             
       SET @SQL =  @SQL + " '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '', '', '', '', '', '', '', '', '' "            
       SET @SQL =  @SQL + " FROM " + @SHAREDB + ".DBO.OWNER "            
            
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
          DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
          BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
       EXEC(@SQL)            
      END            
                 
                 
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)           VALUES ('', '', '', '', '', '', '<B>' + ':: ' + @EXSEDATA + ' ::' + '</B>', '', '', '', '' , @EXSEDATA, '', '', '' , '', '', '', '',            
        '', '', '', '', '', '', '', '')            
          
     IF @ACCAT = '1'            
      BEGIN            
       -- EXEC RPT_ACCCBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'CAPITAL'            
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,            
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,            
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)            
       EXEC RPT_ACCCBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT            
       IF @@ROWCOUNT = 0            
        BEGIN            
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',            
            '', '', '', '', '', '', '', '')            
        END            
      END            
     ELSE IF @ACCAT = '2'            
      BEGIN            
       --EXEC RPT_ACCBBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'FUTURES'            
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,            
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,            
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)            
       EXEC RPT_ACCBBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT                  
       IF @@ROWCOUNT = 0            
        BEGIN            
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',            
            '', '', '', '', '', '', '', '')            
        END            
      END            
     ELSE IF @ACCAT = '4'            
      BEGIN            
       -- EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'            
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)--, COMPNAME, COMPADDR            
       EXEC RPT_ACCPLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @SHOWMARGIN, @VTYPE, 'N', @CLTYPE            
      
      
       IF @@ROWCOUNT = 0            
        BEGIN            
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',            
            '', '', '', '', '', '', '', '')            
        END            
      SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "            
            
      INSERT INTO #COMPDATA(COMPNAME, COMPADDR)            
      EXEC(@SQL)            
            
      UPDATE D            
       SET D.COMPNAME = C.COMPNAME,            
        D.COMPADDR = C.COMPADDR            
      FROM #TEMP_DATA D, #COMPDATA C            
      WHERE ENTITY = @EXSEDATA            
            
      DELETE  FROM #COMPDATA            
            
      END            
     ELSE             
      BEGIN            
       --EXEC RPT_ACCGLREPORT_REV 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'            
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO)            
       EXEC RPT_ACCGLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT            
       IF @@ROWCOUNT = 0            
        BEGIN            
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',            
            '', '', '', '', '', '', '', '')            
        END            
      END            
                
            
            
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)            
     VALUES ('', '', '', '', '', '', '&nbsp;', '', '', '', '' , '', '', '', '' , '', '', '', '',            
        '', '', '', '', '', '', '', '')            
     SET @ROWPOS = @ROWPOS + 1                
   END            
 --SELECT * FROM #TEMP_DATA RETURN            
   INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)            
   SELECT VOUDT1 = '',            
     EFFDT1 = '',            
     VTYPE = '',            
     VNO = '',            
     CROSAC = '',            
     BRANCHCODE = '',            
     NARRATION = '<B>' + 'Net Closing Balance' + '</B>',            
     DDNO = '',            
     DRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) >= 0 THEN SUM(DRAMT) - SUM(CRAMT) ELSE 0 END,            
     CRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) < 0 THEN SUM(CRAMT) - SUM(DRAMT) ELSE 0 END,            
     RUNNINGBALANCE = 0,            
     ENTITY = '',            
     CLTCODE,            
     LONGNAME = '',            
     VTYP = '',            
     MASTERSNO = 0,            
     SLML = '3',            
DELVTYPE = 0            
   FROM #TEMP_DATA            
   WHERE VTYP = 0 AND CLTCODE <> ''            
   GROUP BY CLTCODE            
            
--   SELECT VOUDT1, EFFDT1, vtype = VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,            
--        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,            
--        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO            
--     FROM #TEMP_DATA            
  IF @ACCAT = '4'            
   BEGIN--@WITHXML            
    IF @WITHXML = 'Y'             
     BEGIN  --SELECT SRNUMBER, VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, NARRATION, DDNO, DRAMT, CRAMT, RUNNINGBALANCE, MASTERSNO, VTYPE  FROM #TEMP_DATA            
      SELECT SRNUMBER,             
        VOUDT1 = CASE WHEN VOUDT1 <> '' AND VNO = '' THEN            
           '<B>' + VOUDT1 + '</B>'            
          ELSE VOUDT1 END,            
        EFFDT1 = CASE WHEN EFFDT1 <> '' AND VNO = '' THEN            
           '<B>' + EFFDT1 + '</B>'            
          ELSE EFFDT1 END,            
        VTYPE= CASE WHEN VTYPE <> '' AND VNO = '' THEN            
           '<B>' + VTYPE + '</B>'            
          ELSE VTYPE END,            
        VNO, CROSAC, NARRATION, DDNO,             
        DRAMT = CASE WHEN VOUDT1 = '' AND EFFDT1 = '' AND SLML <> 3 THEN ''             
           ELSE             
            CASE WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE <> '' THEN            
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'            
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN            
              CONVERT(VARCHAR(24), DRAMT )            
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN            
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'            
             ELSE ''            
             END            
          END,             
        CRAMT = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' AND SLML <> 3 THEN ''              
           ELSE             
            CASE WHEN (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN            
              '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'            
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN            
              CONVERT(VARCHAR(24), CRAMT )            
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN            
             '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'            
             ELSE ''            
            END            
          END,             
        RUNNINGBALANCE = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' OR (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN ''              
             ELSE             
              CONVERT(VARCHAR(24), RUNNINGBALANCE )            
            END,            
        MASTERSNO, VTYP            
      FROM #TEMP_DATA            
      --FOR XML RAW            
     END            
    ELSE            
     BEGIN             
                
      SELECT --D.*,            
        D.ENTITY ,  D.BOOKTYPE,            
        VOUDT1 = CASE WHEN D.VOUDT1 <> '' AND D.VNO = '' THEN            
           '<B>' + D.VOUDT1 + '</B>'            
           WHEN D.VOUDT1 = '' THEN '&nbsp;'            
           ELSE D.VOUDT1 END,            
        EFFDT1 = CASE WHEN D.EFFDT1 <> '' AND D.VNO = '' THEN            
           '<B>' + D.EFFDT1 + '</B>'            
          ELSE D.EFFDT1 END,            
        VTYPE= CASE WHEN D.VTYPE <> '' AND D.VNO = '' THEN            
           '<B>' + D.VTYPE + '</B>'            
          ELSE D.VTYPE END,                   
        DRAMT = CASE WHEN (D.VOUDT1 = '' AND D.EFFDT1 = '') AND D.SLML <> 3 THEN ''             
           ELSE             
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE <> '' THEN            
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'            
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN            
              CONVERT(VARCHAR(24), D.DRAMT )                         WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE = '' AND D.SLML = 3 THEN            
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'            
             ELSE ''            
             END            
          END,             
        CRAMT = --d.cramt,            
         CASE WHEN (D.VOUDT1 = '' OR D.EFFDT1 = '') AND D.SLML <> 3 THEN ''              
           ELSE             
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN            
              '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'            
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN            
              CONVERT(VARCHAR(24), D.CRAMT )            
             WHEN  D.VTYPE = '' AND D.SLML = 3 THEN            
             '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'            
             ELSE ''            
            END            
          END,            
        D.VNO, D.NARRATION, D.DDNO ,D.CLTCODE, D.LONGNAME, D.VDT, D.EDT, D.VTYP,D.ACCAT,            
        D.OPBAL, D.CROSAC, D.ACNAME, D.BRANCHCODE, D.MASTERSNO,            
        RUNNINGBALANCE = CASE WHEN D.VOUDT1 = '' OR D.EFFDT1 = '' OR (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN ''              
             ELSE             
              CONVERT(VARCHAR(24), D.RUNNINGBALANCE )            
            END,             
        D.PROCID, D.REPDATE, D.MAINCODE, D.VCHDT, D.SRNO, D.SLML, D.DELVTYPE, D.COMPNAME, D.COMPADDR, D.SRNUMBER,            
        LTRIM(RTRIM(C.SUB_BROKER)) SUB_BROKER, LTRIM(RTRIM(C.TRADER)) TRADER,            
        LTRIM(RTRIM(C.L_ADDRESS1)) L_ADDRESS1, LTRIM(RTRIM(C.L_CITY)) L_CITY,            
        LTRIM(RTRIM(C.L_ADDRESS2)) L_ADDRESS2, LTRIM(RTRIM(C.L_STATE)) L_STATE,            
        LTRIM(RTRIM(C.L_ADDRESS3)) L_ADDRESS3, LTRIM(RTRIM(C.CL_TYPE)) CL_TYPE,            
        LTRIM(RTRIM(C.L_ZIP)) L_ZIP,-- LTRIM(RTRIM(C.PAN_GIR_NO)) PAN_GIR_NO,            
        LTRIM(RTRIM(C.RES_PHONE1)) RES_PHONE1, --LTRIM(RTRIM(C.RES_PHONE2)) RES_PHONE2,            
        --LTRIM(RTRIM(C.MOBILE_PAGER)) MOBILE_PAGER, LTRIM(RTRIM(C.EMAIL)) EMAIL,            
LTRIM(RTRIM(C.AREA)) AREA, LTRIM(RTRIM(C.BANK_NAME)) BANK_NAME,            
        LTRIM(RTRIM(C.FAMILY)) FAMILY, LTRIM(RTRIM(C.ACC_NUM)) AC_NUM            
      FROM #TEMP_DATA D LEFT JOIN  #CLIENTS C            
      ON  D.CLTCODE = C.CODE            
      ORDER BY D.SRNUMBER            
     END            
 --   SELECT * FROM MSAJAG.DBO.CLIENT_DETAILS            
   END            
  ELSE --IF IF @ACCAT = '4'            
   BEGIN             
print 'vin'      
select * from #TEMP_DATA      
return                 
   SELECT ENTITY,BOOKTYPE,VOUDT1,EFFDT1,VTYPE,            
   DRAMT = CONVERT(VARCHAR(24), DRAMT ),            
   CRAMT = CONVERT(VARCHAR(24), CRAMT ),VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,EDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,MASTERSNO,            
   RUNNINGBALANCE = CONVERT(VARCHAR(24), RUNNINGBALANCE ),PROCID,REPDATE,MAINCODE,VCHDT,SRNO,SLML,DELVTYPE,COMPNAME,COMPADDR,SRNUMBER            
 FROM #TEMP_DATA ORDER BY SRNUMBER            
   END            
            
  DROP TABLE #TEMP_DATA            
            
END TRY            
BEGIN CATCH            
 DECLARE @ERRMSG VARCHAR(MAX)            
 SET @ERRMSG = ERROR_MESSAGE()            
 RAISERROR( @ERRMSG, 16, 1)            
END CATCH            
/*            
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2008', '31/03/2009', '010A141', '010A141', 'broker', 'broker', 'HO', 'VDT', 'codewise', 'NSE-CAPITAL| NSE-FUTURES', '4', 'Y', 'Y', '', 'n'            
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2009', '06/10/2009', '100', '100', 'broker', 'broker', 'ALL', 'VDT', 'codewise', 'NSE-CAPITAL', '3', '', 'Y', '', 'N'            
*/   
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCREPORT_MULTI_EXCHANGE_26052010
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ACCREPORT_MULTI_EXCHANGE_26052010]           
 @FDATE VARCHAR(11),          
 @TDATE VARCHAR(11),          
 @FCODE [UDTPARTYCODE],          
 @TCODE [UDTPARTYCODE],          
 @STATUSID VARCHAR(25),          
 @STATUSNAME VARCHAR(25),          
 @BRANCHCODE [UDTBRANCHCODE],          
 @SELECTON VARCHAR(3),          
 @SORTON VARCHAR(3),          
 @SEG_EXC VARCHAR(200),          
 @ACCAT UDTACCAT,          
 @MEMBERADDR VARCHAR(1),          
 @SHOWMARGIN VARCHAR(1) = 'N',          
 @VTYPE VARCHAR(70) = '',          
 @WITHXML VARCHAR(1) = 'N',          
 @CLTYPE VARCHAR(3) = ''          
AS          
/*          
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '4', 'Y', 'Y', '', 'Y'          
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '1', 'Y'          
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '2', 'Y'          
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '3', 'Y'          
          
*/          
           
 SET NOCOUNT ON;          
 BEGIN TRY          
 SET NOCOUNT ON;          
  IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'          
   BEGIN          
    RAISERROR('This Report is not available for your type of Login', 16, 1)          
    RETURN          
   END          
  DECLARE @EXSEDATA VARCHAR(20),          
   @EXCHANGE VARCHAR(20),          
   @SEGMENT VARCHAR(20),          
   @ROWPOS INT,          
   @SQL VARCHAR(MAX),          
   @SHAREDB VARCHAR(25),          
   @COMPNAME VARCHAR(100),          
   @COMPADDR VARCHAR(400)          
          
            
  SET @ROWPOS = 1           
  CREATE TABLE #TEMP_DATA          
  (          
   ENTITY VARCHAR(25)          
  )          
  EXEC MAKE_UDT_STRUCTURE          
   '#TEMP_DATA',          
   'BOOKTYPE|VOUDT1|EFFDT1|VTYPE|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO|RUNNINGBALANCE|PROCID|REPDATE|MAINCODE|VCHDT|SRNO|SLML|DELVTYPE|COMPNAME|COMPADDR',          
   'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT|MONEY|BIGINT|VARCHAR|UDTPARTYCODE|DATETIME|INT|VARCHAR|UDTVTYPE|VARCHAR|V
  
    
      
        
ARCHAR',          
   '|10|10|6|||||||||||||||35||8||8||||1||100|500',          
   '0|0|0|1|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'          
  ALTER TABLE #TEMP_DATA ADD SRNUMBER INT IDENTITY(1,1)          
--  CREATE TABLE #TEMP_DATA          
--   (          
--    [ENTITY] VARCHAR(25),          
--    [BOOKTYPE] [UDTBOOKTYPE] NULL,--          
--    [VOUDT1] [VARCHAR] (10) NULL,          
--    [EFFDT1] [VARCHAR] (10) NULL,          
--    [VTYPE] [CHAR] (6) NOT NULL DEFAULT(' '),          
--    [DRAMT] [MONEY] NULL,          
--    [CRAMT] [MONEY] NULL,          
--    [VNO] [UDTVNO] NULL,          
--    [NARRATION] [UDTNARRATION] NULL,          
--    [DDNO] [UDTINSTNO] NULL,          
--    [CLTCODE] [UDTPARTYCODE] NOT NULL,          
--    [LONGNAME] [UDTACNAME] NULL,          
--    [VDT] [DATETIME] NULL,--          
--    [EDT] [DATETIME] NULL,--          
--    [VTYP] [UDTVTYPE] NULL,          
--    [ACCAT] [UDTACCAT] NULL,--          
--    [OPBAL] [MONEY] NULL,          
--    [CROSAC] [UDTPARTYCODE] NULL,          
--    [ACNAME] [UDTACNAME] NULL,          
--    [BRANCHCODE] VARCHAR(35) NULL,          
--    [MASTERSNO] BIGINT,          
--    RUNNINGBALANCE MONEY,          
--    --[SNO] INT IDENTITY(1,1)          
--    PROCID BIGINT NULL,--          
--    REPDATE VARCHAR (8) NULL,--          
--    MAINCODE [UDTPARTYCODE] NULL,--          
--    VCHDT DATETIME NULL,--          
--    SRNO INT NULL,--          
--    SLML VARCHAR(1) NULL,          
--    DELVTYPE UDTVTYPE NULL,          
--    COMPNAME VARCHAR(100),          
--    COMPADDR VARCHAR(500),          
--    SRNUMBER INT IDENTITY(1,1)          
--   )--to delete column sign  end with --          
          
   CREATE TABLE #COMPDATA          
   (          
    COMPNAME VARCHAR(100),          
    COMPADDR VARCHAR(500)          
   )              
        
   CREATE TABLE #CLIENTS        
   (          
    TRADER VARCHAR(20),          
    SUB_BROKER VARCHAR(20),          
    [L_ADDRESS1] VARCHAR(50) NOT NULL,            
    [L_ADDRESS2] VARCHAR(50) NOT NULL,            
    [L_ADDRESS3] VARCHAR(50) NOT NULL,            
    [L_CITY] VARCHAR(35) NOT NULL,            
    [L_STATE] VARCHAR(50) NOT NULL,            
    [L_NATION] VARCHAR(50) NOT NULL,            
    [L_ZIP] VARCHAR(6) NOT NULL,            
    [FAX] VARCHAR(20) NOT NULL,            
    [RES_PHONE1] VARCHAR(15) NOT NULL,            
    [RES_PHONE2] VARCHAR(15) NOT NULL,            
    [MOBILE_PAGER] VARCHAR(50) NOT NULL,            
    [PAN_GIR_NO] VARCHAR(10) NOT NULL,            
    [EMAIL] VARCHAR(50) NOT NULL,           
    [CL_TYPE] VARCHAR(3) NOT NULL,          
    [BANK_NAME] VARCHAR(50)NULL,          
    [ACC_NUM] VARCHAR(40)NULL        
   )          
          
   EXEC MAKE_UDT_STRUCTURE          
    '#CLIENTS',          
    'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',          
    'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',          
    '',          
    ''          
          
        
   DECLARE          
    @@SHAREDB VARCHAR(20),          
    @@SQL VARCHAR(1000)          
        
   WHILE 1 = 1          
    BEGIN          
     SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))          
     IF @EXSEDATA IS NULL OR @EXSEDATA = ''          
      BEGIN          
       BREAK          
      END          
          
     SET @EXCHANGE = .DBO.PIECE(@EXSEDATA, '-', 1)          
     SET @SEGMENT = .DBO.PIECE(@EXSEDATA, '-', 2)          
          
     SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1          
         
        
    SET @@SQL = "INSERT INTO #CLIENTS(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,   L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA, REGION, BANK_NAME, ACC_NUM) "          
    SET @@SQL = @@SQL + " SELECT * FROM " + @SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"          
    PRINT @@SQL        
    EXEC (@@SQL)        
               
     SET @SQL = "SELECT '', '', '', '', '', '', '<B>' + LTRIM(RTRIM(COMPANY)) + '</B>', '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '',"          
     SET @SQL =  @SQL + " '', '', '', '', '', '', '', '' FROM " + @SHAREDB + ".DBO.OWNER "          
        
          
          
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
     EXEC(@SQL)          
          
     IF @MEMBERADDR = 'Y'          
      BEGIN          
       SET @SQL = "SELECT '', '', '', '', '', '', ( '<B>' + ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE + '</B>'),  "           
       SET @SQL =  @SQL + " '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '', '', '', '', '', '', '', '', '' "          
       SET @SQL =  @SQL + " FROM " + @SHAREDB + ".DBO.OWNER "          
          
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
          DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
          BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
       EXEC(@SQL)          
      END          
               
               
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)           VALUES ('', '', '', '', '', '', '<B>' + ':: ' + @EXSEDATA + ' ::' + '</B>', '', '', '', '' , @EXSEDATA, '', '', '' , '', '', '', '',          
        '', '', '', '', '', '', '', '')          
        
     IF @ACCAT = '1'          
      BEGIN          
       -- EXEC RPT_ACCCBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'CAPITAL'          
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,          
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,          
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)          
       EXEC RPT_ACCCBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT          
       IF @@ROWCOUNT = 0          
        BEGIN          
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',          
            '', '', '', '', '', '', '', '')          
        END          
      END          
     ELSE IF @ACCAT = '2'          
      BEGIN          
       --EXEC RPT_ACCBBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'FUTURES'          
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,          
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,          
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)          
       EXEC RPT_ACCBBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT                
       IF @@ROWCOUNT = 0          
        BEGIN          
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',          
            '', '', '', '', '', '', '', '')          
        END          
      END          
     ELSE IF @ACCAT = '4'          
      BEGIN          
       -- EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'          
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
         DDNO, DRAMT,   
 RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)--, COMPNAME, COMPADDR          
       EXEC RPT_ACCPLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @SHOWMARGIN, @VTYPE, 'N', @CLTYPE          
    
    
       IF @@ROWCOUNT = 0          
        BEGIN          
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',          
            '', '', '', '', '', '', '', '')          
        END          
      SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "          
          
      INSERT INTO #COMPDATA(COMPNAME, COMPADDR)          
      EXEC(@SQL)          
          
      UPDATE D          
       SET D.COMPNAME = C.COMPNAME,          
        D.COMPADDR = C.COMPADDR          
      FROM #TEMP_DATA D, #COMPDATA C          
      WHERE ENTITY = @EXSEDATA          
          
      DELETE  FROM #COMPDATA          
          
      END          
     ELSE           
      BEGIN          
       --EXEC RPT_ACCGLREPORT_REV 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'          
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO)          
       EXEC RPT_ACCGLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT          
       IF @@ROWCOUNT = 0          
        BEGIN          
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',          
            '', '', '', '', '', '', '', '')          
        END          
      END          
              
          
          
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)          
     VALUES ('', '', '', '', '', '', '&nbsp;', '', '', '', '' , '', '', '', '' , '', '', '', '',          
        '', '', '', '', '', '', '', '')          
     SET @ROWPOS = @ROWPOS + 1              
   END          
 --SELECT * FROM #TEMP_DATA RETURN          
   INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)          
   SELECT VOUDT1 = '',          
     EFFDT1 = '',          
     VTYPE = '',          
     VNO = '',          
     CROSAC = '',          
     BRANCHCODE = '',          
     NARRATION = '<B>' + 'Net Closing Balance' + '</B>',          
     DDNO = '',          
     DRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) >= 0 THEN SUM(DRAMT) - SUM(CRAMT) ELSE 0 END,          
     CRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) < 0 THEN SUM(CRAMT) - SUM(DRAMT) ELSE 0 END,          
     RUNNINGBALANCE = 0,          
     ENTITY = '',          
     CLTCODE,          
     LONGNAME = '',          
     VTYP = '',          
     MASTERSNO = 0,          
     SLML = '3',          
     DELVTYPE = 0          
   FROM #TEMP_DATA          
   WHERE VTYP = 0 AND CLTCODE <> ''          
   GROUP BY CLTCODE          
          
--   SELECT VOUDT1, EFFDT1, vtype = VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,          
--        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,          
--        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO          
--     FROM #TEMP_DATA          
  IF @ACCAT = '4'          
   BEGIN--@WITHXML          
    IF @WITHXML = 'Y'           
     BEGIN  --SELECT SRNUMBER, VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, NARRATION, DDNO, DRAMT, CRAMT, RUNNINGBALANCE, MASTERSNO, VTYPE  FROM #TEMP_DATA          
      SELECT SRNUMBER,           
        VOUDT1 = CASE WHEN VOUDT1 <> '' AND VNO = '' THEN          
           '<B>' + VOUDT1 + '</B>'          
          ELSE VOUDT1 END,          
        EFFDT1 = CASE WHEN EFFDT1 <> '' AND VNO = '' THEN          
           '<B>' + EFFDT1 + '</B>'          
          ELSE EFFDT1 END,          
        VTYPE= CASE WHEN VTYPE <> '' AND VNO = '' THEN          
           '<B>' + VTYPE + '</B>'          
          ELSE VTYPE END,          
        VNO, CROSAC, NARRATION, DDNO,           
        DRAMT = CASE WHEN VOUDT1 = '' AND EFFDT1 = '' AND SLML <> 3 THEN ''           
           ELSE           
            CASE WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE <> '' THEN          
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'          
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN          
              CONVERT(VARCHAR(24), DRAMT )          
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN          
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'          
             ELSE ''          
             END          
          END,           
        CRAMT = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' AND SLML <> 3 THEN ''            
           ELSE           
            CASE WHEN (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN          
              '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'          
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN          
              CONVERT(VARCHAR(24), CRAMT )   
  
              
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN          
             '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'          
             ELSE ''          
            END          
          END,           
        RUNNINGBALANCE = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' OR (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN ''            
             ELSE           
              CONVERT(VARCHAR(24), RUNNINGBALANCE )          
            END,          
        MASTERSNO, VTYP          
      FROM #TEMP_DATA          
      --FOR XML RAW          
     END          
    ELSE          
     BEGIN           
              
      SELECT --D.*,          
        D.ENTITY ,  D.BOOKTYPE,          
        VOUDT1 = CASE WHEN D.VOUDT1 <> '' AND D.VNO = '' THEN          
           '<B>' + D.VOUDT1 + '</B>'          
           WHEN D.VOUDT1 = '' THEN '&nbsp;'          
           ELSE D.VOUDT1 END,          
        EFFDT1 = CASE WHEN D.EFFDT1 <> '' AND D.VNO = '' THEN          
           '<B>' + D.EFFDT1 + '</B>'          
          ELSE D.EFFDT1 END,          
        VTYPE= CASE WHEN D.VTYPE <> '' AND D.VNO = '' THEN          
           '<B>' + D.VTYPE + '</B>'          
          ELSE D.VTYPE END,                 
        DRAMT = CASE WHEN (D.VOUDT1 = '' AND D.EFFDT1 = '') AND D.SLML <> 3 THEN ''           
           ELSE           
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE <> '' THEN          
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'          
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN          
              CONVERT(VARCHAR(24), D.DRAMT )          
             WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE = '' AND D.SLML = 3 THEN          
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'          
             ELSE ''          
             END          
          END,           
        CRAMT = --d.cramt,          
         CASE WHEN (D.VOUDT1 = '' OR D.EFFDT1 = '') AND D.SLML <> 3 THEN ''            
           ELSE           
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN          
              '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'          
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN          
              CONVERT(VARCHAR(24), D.CRAMT )          
             WHEN  D.VTYPE = '' AND D.SLML = 3 THEN          
             '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'          
             ELSE ''          
            END          
          END,          
        D.VNO, D.NARRATION, D.DDNO ,D.CLTCODE, D.LONGNAME, D.VDT, D.EDT, D.VTYP,D.ACCAT,          
        D.OPBAL, D.CROSAC, D.ACNAME, D.BRANCHCODE, D.MASTERSNO,          
        RUNNINGBALANCE = CASE WHEN D.VOUDT1 = '' OR D.EFFDT1 = '' OR (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN ''            
             ELSE           
              CONVERT(VARCHAR(24), D.RUNNINGBALANCE )          
            END,           
        D.PROCID, D.REPDATE, D.MAINCODE, D.VCHDT, D.SRNO, D.SLML, D.DELVTYPE, D.COMPNAME, D.COMPADDR, D.SRNUMBER,          
        LTRIM(RTRIM(C.SUB_BROKER)) SUB_BROKER, LTRIM(RTRIM(C.TRADER)) TRADER,          
        LTRIM(RTRIM(C.L_ADDRESS1)) L_ADDRESS1, LTRIM(RTRIM(C.L_CITY)) L_CITY,          
        LTRIM(RTRIM(C.L_ADDRESS2)) L_ADDRESS2, LTRIM(RTRIM(C.L_STATE)) L_STATE,          
        LTRIM(RTRIM(C.L_ADDRESS3)) L_ADDRESS3, LTRIM(RTRIM(C.CL_TYPE)) CL_TYPE,          
        LTRIM(RTRIM(C.L_ZIP)) L_ZIP,-- LTRIM(RTRIM(C.PAN_GIR_NO)) PAN_GIR_NO,          
        LTRIM(RTRIM(C.RES_PHONE1)) RES_PHONE1, --LTRIM(RTRIM(C.RES_PHONE2)) RES_PHONE2,          
        --LTRIM(RTRIM(C.MOBILE_PAGER)) MOBILE_PAGER, LTRIM(RTRIM(C.EMAIL)) EMAIL,          
LTRIM(RTRIM(C.AREA)) AREA, LTRIM(RTRIM(C.BANK_NAME)) BANK_NAME,          
        LTRIM(RTRIM(C.FAMILY)) FAMILY, LTRIM(RTRIM(C.ACC_NUM)) AC_NUM          
      FROM #TEMP_DATA D LEFT JOIN  #CLIENTS C          
      ON  D.CLTCODE = C.CODE          
      ORDER BY D.SRNUMBER          
     END          
 --   SELECT * FROM MSAJAG.DBO.CLIENT_DETAILS          
   END          
  ELSE --IF IF @ACCAT = '4'          
   BEGIN           
print 'vin'    
select * from #TEMP_DATA    
return               
   SELECT ENTITY,BOOKTYPE,VOUDT1,EFFDT1,VTYPE,          
   DRAMT = CONVERT(VARCHAR(24), DRAMT ),          
   CRAMT = CONVERT(VARCHAR(24), CRAMT ),VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,EDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,MASTERSNO,          
   RUNNINGBALANCE = CONVERT(VARCHAR(24), RUNNINGBALANCE ),PROCID,REPDATE,MAINCODE,VCHDT,SRNO,SLML,DELVTYPE,COMPNAME,COMPADDR,SRNUMBER          
 FROM #TEMP_DATA ORDER BY SRNUMBER          
   END          
          
  DROP TABLE #TEMP_DATA          
          
END TRY          
BEGIN CATCH          
 DECLARE @ERRMSG VARCHAR(MAX)          
 SET @ERRMSG = ERROR_MESSAGE()          
 RAISERROR( @ERRMSG, 16, 1)          
END CATCH          
/*          
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2008', '31/03/2009', '010A141', '010A141', 'broker', 'broker', 'HO', 'VDT', 'codewise', 'NSE-CAPITAL| NSE-FUTURES', '4', 'Y', 'Y', '', 'n'          
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2009', '06/10/2009', '100', '100', 'broker', 'broker', 'ALL', 'VDT', 'codewise', 'NSE-CAPITAL', '3', '', 'Y', '', 'N'          
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCREPORT_MULTI_EXCHANGE_org
-- --------------------------------------------------
    
    
    
create  PROCEDURE [dbo].[RPT_ACCREPORT_MULTI_EXCHANGE_org]        
    
    
      
 @FDATE VARCHAR(11),              
 @TDATE VARCHAR(11),              
 @FCODE [UDTPARTYCODE],              
 @TCODE [UDTPARTYCODE],              
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @BRANCHCODE [UDTBRANCHCODE],              
 @SELECTON VARCHAR(3),              
 @SORTON VARCHAR(3),              
 @SEG_EXC VARCHAR(200),              
 @ACCAT UDTACCAT,              
 @MEMBERADDR VARCHAR(1),              
 @SHOWMARGIN VARCHAR(1) = 'N',              
 @VTYPE VARCHAR(70) = '',              
 @WITHXML VARCHAR(1) = 'N',              
 @CLTYPE VARCHAR(3) = ''              
AS              
/*              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '4', 'Y', 'Y', '', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '1', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '2', 'Y'              
RPT_ACCREPORT_MULTI_EXCHANGE 'APR  1 2007', 'MAR 31 2008', '100', '100', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE-CAPITAL|NSE-FUTURES', '3', 'Y'              
              
*/              
               
 SET NOCOUNT ON;              
 BEGIN TRY              
 SET NOCOUNT ON;              
  IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'              
   BEGIN              
    RAISERROR('This Report is not available for your type of Login', 16, 1)              
    RETURN              
   END              
  DECLARE @EXSEDATA VARCHAR(20),              
   @EXCHANGE VARCHAR(20),              
   @SEGMENT VARCHAR(20),              
   @ROWPOS INT,              
   @SQL VARCHAR(MAX),              
   @SHAREDB VARCHAR(25),              
   @COMPNAME VARCHAR(100),              
   @COMPADDR VARCHAR(400)              
              
                
  SET @ROWPOS = 1               
  CREATE TABLE #TEMP_DATA              
  (              
   ENTITY VARCHAR(25)              
  )              
  EXEC MAKE_UDT_STRUCTURE              
   '#TEMP_DATA',              
   'BOOKTYPE|VOUDT1|EFFDT1|VTYPE|DRAMT|CRAMT|VNO|NARRATION|DDNO|CLTCODE|LONGNAME|VDT|EDT|VTYP|ACCAT|OPBAL|CROSAC|ACNAME|BRANCHCODE|MASTERSNO|RUNNINGBALANCE|PROCID|REPDATE|MAINCODE|VCHDT|SRNO|SLML|DELVTYPE|COMPNAME|COMPADDR',              
   'UDTBOOKTYPE|VARCHAR|VARCHAR|CHAR|MONEY|MONEY|UDTVNO|UDTNARRATION|UDTINSTNO|UDTPARTYCODE|UDTACNAME|DATETIME|DATETIME|UDTVTYPE|UDTACCAT|MONEY|UDTPARTYCODE|UDTACNAME|VARCHAR|BIGINT|MONEY|BIGINT|VARCHAR|UDTPARTYCODE|DATETIME|INT|VARCHAR|UDTVTYPE|VARCHAR|V
  
RCHAR',              
   '|10|10|6|||||||||||||||35||8||8||||1||100|500',              
   '0|0|0|1|0|0|0|0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'              
  ALTER TABLE #TEMP_DATA ADD SRNUMBER INT IDENTITY(1,1)              
--  CREATE TABLE #TEMP_DATA              
--   (              
--    [ENTITY] VARCHAR(25),              
--    [BOOKTYPE] [UDTBOOKTYPE] NULL,--              
--    [VOUDT1] [VARCHAR] (10) NULL,              
--    [EFFDT1] [VARCHAR] (10) NULL,              
--    [VTYPE] [CHAR] (6) NOT NULL DEFAULT(' '),              
--    [DRAMT] [MONEY] NULL,              
--    [CRAMT] [MONEY] NULL,              
--    [VNO] [UDTVNO] NULL,              
--    [NARRATION] [UDTNARRATION] NULL,              
--    [DDNO] [UDTINSTNO] NULL,              
--    [CLTCODE] [UDTPARTYCODE] NOT NULL,              
--    [LONGNAME] [UDTACNAME] NULL,              
--    [VDT] [DATETIME] NULL,--              
--    [EDT] [DATETIME] NULL,--              
--    [VTYP] [UDTVTYPE] NULL,              
--    [ACCAT] [UDTACCAT] NULL,--              
--    [OPBAL] [MONEY] NULL,              
--    [CROSAC] [UDTPARTYCODE] NULL,              
--    [ACNAME] [UDTACNAME] NULL,              
--    [BRANCHCODE] VARCHAR(35) NULL,              
--    [MASTERSNO] BIGINT,              
--    RUNNINGBALANCE MONEY,              
--    --[SNO] INT IDENTITY(1,1)              
--    PROCID BIGINT NULL,--          
--    REPDATE VARCHAR (8) NULL,--              
--    MAINCODE [UDTPARTYCODE] NULL,--              
--    VCHDT DATETIME NULL,--              
--    SRNO INT NULL,--              
--    SLML VARCHAR(1) NULL,              
--    DELVTYPE UDTVTYPE NULL,              
--    COMPNAME VARCHAR(100),              
--    COMPADDR VARCHAR(500),              
--    SRNUMBER INT IDENTITY(1,1)              
--   )--to delete column sign  end with --              
              
   CREATE TABLE #COMPDATA              
   (              
    COMPNAME VARCHAR(100),              
    COMPADDR VARCHAR(500)              
   )                  
            
   CREATE TABLE #CLIENTS            
   (              
    TRADER VARCHAR(20),              
    SUB_BROKER VARCHAR(20),              
    [L_ADDRESS1] VARCHAR(50) NOT NULL,                
    [L_ADDRESS2] VARCHAR(50) NOT NULL,                
    [L_ADDRESS3] VARCHAR(50) NOT NULL,                
    [L_CITY] VARCHAR(35) NOT NULL,                
    [L_STATE] VARCHAR(50) NOT NULL,                
    [L_NATION] VARCHAR(50) NOT NULL,                
    [L_ZIP] VARCHAR(6) NOT NULL,                
    [FAX] VARCHAR(20) NOT NULL,                
    [RES_PHONE1] VARCHAR(15) NOT NULL,                
    [RES_PHONE2] VARCHAR(15) NOT NULL,                
    [MOBILE_PAGER] VARCHAR(50) NOT NULL,                
    [PAN_GIR_NO] VARCHAR(10) NOT NULL,                
    [EMAIL] VARCHAR(50) NOT NULL,               
    [CL_TYPE] VARCHAR(3) NOT NULL,              
    [BANK_NAME] VARCHAR(50)NULL,              
    [ACC_NUM] VARCHAR(40)NULL            
   )              
              
   EXEC MAKE_UDT_STRUCTURE              
    '#CLIENTS',              
    'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',              
    'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',              
    '',              
    ''              
              
            
   DECLARE              
    @@SHAREDB VARCHAR(20),              
    @@SQL VARCHAR(1000)              
            
   WHILE 1 = 1              
    BEGIN              
     SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))              
     IF @EXSEDATA IS NULL OR @EXSEDATA = ''              
      BEGIN              
       BREAK              
      END              
              
     SET @EXCHANGE = .DBO.PIECE(@EXSEDATA, '-', 1)              
     SET @SEGMENT = .DBO.PIECE(@EXSEDATA, '-', 2)              
              
     SELECT @SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1              
             
            
    SET @@SQL = "INSERT INTO #CLIENTS(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,     L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA, REGION, BANK_NAME, ACC_NUM) "              
        SET @@SQL = @@SQL + " SELECT * FROM " + @SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '" + @FCODE + "','" + @TCODE + "','" + @CLTYPE + "')"              
    PRINT @@SQL            
    EXEC (@@SQL)            
                   
     SET @SQL = "SELECT '', '', '', '', '', '', '<B>' + LTRIM(RTRIM(COMPANY)) + '</B>', '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '',"              
     SET @SQL =  @SQL + " '', '', '', '', '', '', '', '' FROM " + @SHAREDB + ".DBO.OWNER "              
            
              
              
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
     EXEC(@SQL)              
              
     IF @MEMBERADDR = 'Y'              
      BEGIN              
       SET @SQL = "SELECT '', '', '', '', '', '', ( '<B>' + ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE + '</B>'),  "               
       SET @SQL =  @SQL + " '', '', '', '' , '" + @EXSEDATA + "', '', '', '' , '', '', '', '', '', '', '', '', '', '', '', '' "              
       SET @SQL =  @SQL + " FROM " + @SHAREDB + ".DBO.OWNER "              
              
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
          DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
          BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
       EXEC(@SQL)              
      END              
                   
                   
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)           VALUES ('', '', '', '', '', '', '<B>' + ':: ' + @EXSEDATA + ' ::' + '</B>', '', '', '', '' , @EXSEDATA, '', '', '' , '', '', '', '',              
        '', '', '', '', '', '', '', '')              
            
     IF @ACCAT = '1'              
      BEGIN              
       -- EXEC RPT_ACCCBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'CASH01', 'CASH01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'CAPITAL'              
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,              
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,              
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)              
       EXEC RPT_ACCCBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT              
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      END              
     ELSE IF @ACCAT = '2'              
      BEGIN              
       --EXEC RPT_ACCBBREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'BANK01', 'BANK01', 'BROKER', 'BROKER', '', 'VDT', 'NSE', 'FUTURES'              
       INSERT INTO #TEMP_DATA (SRNO, BOOKTYPE, VOUDT1, EFFDT1, VTYPE, DRAMT, CRAMT, VNO, NARRATION, DDNO,              
         CLTCODE, LONGNAME, VDT, EDT, VTYP, ACCAT, OPBAL, CROSAC, ACNAME, BRANCHCODE, PROCID, REPDATE, MAINCODE,              
         VCHDT, ENTITY, MASTERSNO, RUNNINGBALANCE)              
       EXEC RPT_ACCBBREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @EXCHANGE, @SEGMENT                    
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      END              
     ELSE IF @ACCAT = '4'              
      BEGIN              
       -- EXEC RPT_ACCPLREPORT_REV 'APR  1 2007', 'MAR 31 2008', 'ALWC000001', 'ALWC000001', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL'              
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)--, COMPNAME, COMPADDR              
       EXEC RPT_ACCPLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @SHOWMARGIN, @VTYPE, 'N', @CLTYPE              
        
        
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      SET @SQL = "SELECT  COMPANY, (ADDR1 + ' ' + ADDR2 + ', ' + CITY + ' - ' + ZIP + ' Phone: ' + PHONE ) FROM " + @SHAREDB + ".DBO.OWNER "              
              
      INSERT INTO #COMPDATA(COMPNAME, COMPADDR)              
      EXEC(@SQL)              
              
      UPDATE D              
       SET D.COMPNAME = C.COMPNAME,              
        D.COMPADDR = C.COMPADDR              
      FROM #TEMP_DATA D, #COMPDATA C              
      WHERE ENTITY = @EXSEDATA              
              
      DELETE  FROM #COMPDATA              
              
      END              
     ELSE               
      BEGIN              
       INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO)              
       EXEC RPT_ACCGLREPORT_REV @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT              
       IF @@ROWCOUNT = 0              
        BEGIN              
         INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
            DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
            BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
         VALUES (@TDATE, @TDATE, '', '', '', '', 'NO RECORD FOUND', '', '', '', '' , '', '', '', '' , '', '', '', '',              
            '', '', '', '', '', '', '', '')              
        END              
      END              
                  
              
              
     INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO)              
     VALUES ('', '', '', '', '', '', '&nbsp;', '', '', '', '' , '', '', '', '' , '', '', '', '',              
        '', '', '', '', '', '', '', '')              
     SET @ROWPOS = @ROWPOS + 1                  
   END              
 --SELECT * FROM #TEMP_DATA RETURN              
   INSERT INTO #TEMP_DATA (VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
         DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO, SLML, DELVTYPE)              
   SELECT VOUDT1 = '',              
     EFFDT1 = '',              
     VTYPE = '',              
     VNO = '',              
     CROSAC = '',              
     BRANCHCODE = '',              
     NARRATION = '<B>' + 'Net Closing Balance' + '</B>',              
     DDNO = '',              
     DRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) >= 0 THEN SUM(DRAMT) - SUM(CRAMT) ELSE 0 END,              
     CRAMT = CASE WHEN SUM(DRAMT) - SUM(CRAMT) < 0 THEN SUM(CRAMT) - SUM(DRAMT) ELSE 0 END,              
     RUNNINGBALANCE = 0,              
     ENTITY = '',              
     CLTCODE,              
     LONGNAME = '',              
     VTYP = '',              
     MASTERSNO = 0,              
     SLML = '3',              
DELVTYPE = 0              
   FROM #TEMP_DATA              
   WHERE VTYP = 0 AND CLTCODE <> ''              
   GROUP BY CLTCODE              
              
--   SELECT VOUDT1, EFFDT1, vtype = VTYPE, VNO, CROSAC, BRANCHCODE, NARRATION,              
--        DDNO, DRAMT, CRAMT, RUNNINGBALANCE, ENTITY, CLTCODE, LONGNAME, VTYP, MASTERSNO,              
--        BOOKTYPE, VDT, EDT, ACCAT, OPBAL, ACNAME, PROCID, REPDATE, MAINCODE, VCHDT, SRNO              
--     FROM #TEMP_DATA              
  IF @ACCAT = '4'              
   BEGIN--@WITHXML              
    IF @WITHXML = 'Y'               
     BEGIN  --SELECT SRNUMBER, VOUDT1, EFFDT1, VTYPE, VNO, CROSAC, NARRATION, DDNO, DRAMT, CRAMT, RUNNINGBALANCE, MASTERSNO, VTYPE  FROM #TEMP_DATA              
      SELECT SRNUMBER,               
        VOUDT1 = CASE WHEN VOUDT1 <> '' AND VNO = '' THEN              
           '<B>' + VOUDT1 + '</B>'              
          ELSE VOUDT1 END,              
        EFFDT1 = CASE WHEN EFFDT1 <> '' AND VNO = '' THEN              
           '<B>' + EFFDT1 + '</B>'              
          ELSE EFFDT1 END,              
        VTYPE= CASE WHEN VTYPE <> '' AND VNO = '' THEN              
           '<B>' + VTYPE + '</B>'              
          ELSE VTYPE END,              
        VNO, CROSAC, NARRATION, DDNO,               
        DRAMT = CASE WHEN VOUDT1 = '' AND EFFDT1 = '' AND SLML <> 3 THEN ''               
           ELSE               
            CASE WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'              
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), DRAMT )              
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN              
              '<B>' + CONVERT(VARCHAR(24), DRAMT ) + '</B>'              
             ELSE ''              
             END              
          END,               
        CRAMT = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' AND SLML <> 3 THEN ''                
           ELSE               
            CASE WHEN (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'              
             WHEN (VTYP <> 0 OR VTYP <> 18 ) AND VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), CRAMT )              
             WHEN (VTYP = 0 OR VTYP = 18 ) AND VTYPE = '' AND SLML = 3 THEN              
             '<B>' + CONVERT(VARCHAR(24), CRAMT ) + '</B>'              
             ELSE ''              
            END              
          END,               
        RUNNINGBALANCE = CASE WHEN VOUDT1 = '' OR EFFDT1 = '' OR (VTYP = 0 OR VTYP = 18) AND VTYPE <> '' THEN ''                
             ELSE               
              CONVERT(VARCHAR(24), RUNNINGBALANCE )              
            END,              
        MASTERSNO, VTYP              
      FROM #TEMP_DATA              
      --FOR XML RAW              
     END              
    ELSE              
     BEGIN               
                  
      SELECT --D.*,              
        D.ENTITY ,  D.BOOKTYPE,              
        VOUDT1 = CASE WHEN D.VOUDT1 <> '' AND D.VNO = '' THEN              
           '<B>' + D.VOUDT1 + '</B>'              
           WHEN D.VOUDT1 = '' THEN '&nbsp;'              
           ELSE D.VOUDT1 END,              
        EFFDT1 = CASE WHEN D.EFFDT1 <> '' AND D.VNO = '' THEN              
           '<B>' + D.EFFDT1 + '</B>'              
          ELSE D.EFFDT1 END,              
        VTYPE= CASE WHEN D.VTYPE <> '' AND D.VNO = '' THEN              
           '<B>' + D.VTYPE + '</B>'              
          ELSE D.VTYPE END,                     
        DRAMT = CASE WHEN (D.VOUDT1 = '' AND D.EFFDT1 = '') AND D.SLML <> 3 THEN ''               
           ELSE               
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'              
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), D.DRAMT )                         WHEN (D.VTYP = 0 OR D.VTYP = 18 ) AND D.VTYPE = '' AND D.SLML = 3 THEN              
              '<B>' + CONVERT(VARCHAR(24), D.DRAMT ) + '</B>'              
             ELSE ''              
             END              
          END,               
        CRAMT = --d.cramt,              
         CASE WHEN (D.VOUDT1 = '' OR D.EFFDT1 = '') AND D.SLML <> 3 THEN ''                
           ELSE               
            CASE WHEN (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN              
              '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'              
             WHEN (D.VTYP <> 0 OR D.VTYP <> 18 ) AND D.VTYPE <> ''THEN              
              CONVERT(VARCHAR(24), D.CRAMT )              
             WHEN  D.VTYPE = '' AND D.SLML = 3 THEN              
             '<B>' + CONVERT(VARCHAR(24), D.CRAMT ) + '</B>'              
             ELSE ''              
            END              
          END,              
        D.VNO, D.NARRATION, D.DDNO ,D.CLTCODE, D.LONGNAME, D.VDT, D.EDT, D.VTYP,D.ACCAT,              
        D.OPBAL, D.CROSAC, D.ACNAME, D.BRANCHCODE, D.MASTERSNO,              
        RUNNINGBALANCE = CASE WHEN D.VOUDT1 = '' OR D.EFFDT1 = '' OR (D.VTYP = 0 OR D.VTYP = 18) AND D.VTYPE <> '' THEN ''                
             ELSE               
              CONVERT(VARCHAR(24), D.RUNNINGBALANCE )              
            END,               
        D.PROCID, D.REPDATE, D.MAINCODE, D.VCHDT, D.SRNO, D.SLML, D.DELVTYPE, D.COMPNAME, D.COMPADDR, D.SRNUMBER,              
        LTRIM(RTRIM(C.SUB_BROKER)) SUB_BROKER, LTRIM(RTRIM(C.TRADER)) TRADER,              
        LTRIM(RTRIM(C.L_ADDRESS1)) L_ADDRESS1, LTRIM(RTRIM(C.L_CITY)) L_CITY,              
        LTRIM(RTRIM(C.L_ADDRESS2)) L_ADDRESS2, LTRIM(RTRIM(C.L_STATE)) L_STATE,              
        LTRIM(RTRIM(C.L_ADDRESS3)) L_ADDRESS3, LTRIM(RTRIM(C.CL_TYPE)) CL_TYPE,              
        LTRIM(RTRIM(C.L_ZIP)) L_ZIP,-- LTRIM(RTRIM(C.PAN_GIR_NO)) PAN_GIR_NO,              
        LTRIM(RTRIM(C.RES_PHONE1)) RES_PHONE1, --LTRIM(RTRIM(C.RES_PHONE2)) RES_PHONE2,              
        --LTRIM(RTRIM(C.MOBILE_PAGER)) MOBILE_PAGER, LTRIM(RTRIM(C.EMAIL)) EMAIL,              
LTRIM(RTRIM(C.AREA)) AREA, LTRIM(RTRIM(C.BANK_NAME)) BANK_NAME,              
        LTRIM(RTRIM(C.FAMILY)) FAMILY, LTRIM(RTRIM(C.ACC_NUM)) AC_NUM              
      FROM #TEMP_DATA D LEFT JOIN  #CLIENTS C              
      ON  D.CLTCODE = C.CODE              
      ORDER BY D.SRNUMBER              
     END              
 --   SELECT * FROM MSAJAG.DBO.CLIENT_DETAILS              
   END              
  ELSE --IF IF @ACCAT = '4'              
   BEGIN               
                  
   SELECT ENTITY,BOOKTYPE,VOUDT1,EFFDT1,VTYPE,              
   DRAMT = CONVERT(VARCHAR(24), DRAMT ),              
   CRAMT = CONVERT(VARCHAR(24), CRAMT ),VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VDT,EDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,MASTERSNO,              
   RUNNINGBALANCE = CONVERT(VARCHAR(24), RUNNINGBALANCE ),PROCID,REPDATE,MAINCODE,VCHDT,SRNO,SLML,DELVTYPE,COMPNAME,COMPADDR,SRNUMBER              
 FROM #TEMP_DATA ORDER BY SRNUMBER              
   END              
              
  DROP TABLE #TEMP_DATA              
      
END TRY              
BEGIN CATCH              
 DECLARE @ERRMSG VARCHAR(MAX)              
 SET @ERRMSG = ERROR_MESSAGE()              
 RAISERROR( @ERRMSG, 16, 1)              
END CATCH              
/*              
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2008', '31/03/2009', '010A141', '010A141', 'broker', 'broker', 'HO', 'VDT', 'codewise', 'NSE-CAPITAL| NSE-FUTURES', '4', 'Y', 'Y', '', 'n'              
Exec RPT_ACCREPORT_MULTI_EXCHANGE '01/04/2009', '06/10/2009', '100', '100', 'broker', 'broker', 'ALL', 'VDT', 'codewise', 'NSE-CAPITAL', '3', '', 'Y', '', 'N'              
*/     
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCVOUCHER
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CHQPRINT_DETAILS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_COMBINED_MULTI_REPORT_SUM
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_COMBINED_PLREPORT_SUM
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MULTI_EXCHANGE_TRIAL_BALANCE
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[RPT_MULTI_EXCHANGE_TRIAL_BALANCE]  
 @FDATE VARCHAR(11),  
 @TDATE VARCHAR(11),  
 @STATUSID VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @BRANCHCODE [UDTBRANCHCODE],  
 @SELECTON VARCHAR(3),  
 @SORTON VARCHAR(10),  
 @SEG_EXC VARCHAR(300),  
 @VIEWOPTION VARCHAR(1),  
 @SHOWZEROCLOBAL VARCHAR(1),  
 @DISPLAY VARCHAR(1),--NORMAL,OP  
 @CLTYPE VARCHAR(3) = ''  
AS  
/*  
RPT_MULTI_EXCHANGE_TRIAL_BALANCE 'Apr  1 2007', 'Mar 31 2008', 'BROKER', 'BROKER', '', 'VDT', 'CODEWISE', 'NSE-CAPITAL|BSE-CAPITAL', 'A', 'Y' , 'O'  
RPT_MULTI_EXCHANGE_TRIAL_BALANCE 'Apr  1 2007', 'Jun  1 2007', 'BROKER', 'BROKER', '', 'VDT', 'CODEWISE', 'NSE-CAPITAL', 'P', 'Y' , 'N'  
EXEC RPT_MULTI_EXCHANGE_TRIAL_BALANCE '01/04/2009', '10/08/2009', 'broker', 'broker', '', 'VDT', 'CODEWISE', 'BSE-CAPITAL| NSE-CAPITAL', 'A', 'Y', 'O'  
SELECT * FROM ACMAST WHERE CLTCODE = '99969'  
SELECT * FROM ACC_TBL2 WHERE CLTCODE = '99969'  
BEGIN TRAN  
SELECT * FROM ACC_TBL2 WHERE MASTERSNO = 4242  
UPDATE ACC_TBL2 SET ACNAME = 'CESS TAX' WHERE MASTERSNO = 4242 AND CLTCODE = '99969'  
UPDATE ACC_TBL2 SET ACNAME = 'CESS TAX CESS TAX CESS TAX CESS TAX' WHERE MASTERSNO = 4242 AND CLTCODE = '99969'  
COMMIT  
ROLLBACK  
SELECT * FROM ACC_TBL3 WHERE CLTCODE = '99969'  
EXEC RPT_MULTI_EXCHANGE_TRIAL_BALANCE '01/04/2008', '31/03/2009', 'broker', 'broker', 'HO', 'VDT', 'CODEWISE', 'NSE-CAPITAL, NSE-FUTURES', 'A', 'Y', 'O'  
  
*/  
BEGIN TRY  
 SET NOCOUNT ON;  
  IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'  
   BEGIN  
    RAISERROR('This Report is not available for your type of Login', 16, 1)  
    RETURN  
   END  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0  
  BEGIN  
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)  
  END  
  
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0  
  BEGIN  
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)  
  END  
  
 DECLARE @EXSEDATA VARCHAR(20),  
   @EXCHANGE VARCHAR(20),  
   @SEGMENT VARCHAR(20),  
   @ROWPOS INT,  
   @SQL VARCHAR(MAX)  
  
 SET @ROWPOS = 1   
 CREATE TABLE #DATA_OUTER  
 (  
  ENTITY VARCHAR(20)  
 )  
 EXEC MAKE_UDT_STRUCTURE  
  '#DATA_OUTER',  
  'DRCLOSEBAL|CRCLOSEBAL|CLTCODE|ACNAME|ACCAT|BRANCHCODE|OP_DE|OP_CR|TR_DE|TR_CR|FDATE|TDATE|SELECTON|SORTON|EXCHANGE|SEGMENT|CLTRW|ACNRW',  
  'MONEY|MONEY|VARCHAR|UDTACNAME|UDTACCAT|UDTBRANCHCODE|MONEY|MONEY|MONEY|MONEY|VARCHAR|VARCHAR|VARCHAR|VARCHAR|UDTEXCHANGE|UDTSEGMENT|INT|INT',  
  '||45||||||||11|11|3|10||||',  
  '0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'  
 ALTER TABLE #DATA_OUTER ADD SRNO INT IDENTITY(1,1), VLINK INT DEFAULT 1  
-- CREATE TABLE #DATA_OUTER  
--  (  
--   ENTITY VARCHAR(20),  
--   DRCLOSEBAL MONEY NULL,  
--   CRCLOSEBAL MONEY NULL,  
--   CLTCODE VARCHAR(45) NOT NULL, -- Increased the Field Length for Branch Control Account Reverse Effect (Routed Entries)  
--   ACNAME UDTACNAME NULL,  
--   ACCAT UDTACCAT NULL,  
--   BRANCHCODE UDTBRANCHCODE NULL,  
--   OP_DE MONEY NULL,  
--   OP_CR MONEY NULL,  
--   TR_DE MONEY NULL,  
--   TR_CR MONEY NULL,  
--   FDATE VARCHAR(11) NULL,  
--   TDATE VARCHAR(11) NULL,  
--   SELECTON VARCHAR(3) NULL,  
--   SORTON VARCHAR(10) NULL,  
--   EXCHANGE UDTEXCHANGE NULL,  
--   SEGMENT UDTSEGMENT NULL,  
--   CLTRW INT NULL,  
--   ACNRW INT NULL,  
--   SRNO INT IDENTITY(1,1),  
--   VLINK INT DEFAULT 1  
--  )  
  CREATE TABLE #DATA_OUTER_SUM  
  (  
   ENTITY VARCHAR(20)  
  )  
  EXEC MAKE_UDT_STRUCTURE  
   '#DATA_OUTER_SUM',  
   'DRCLOSEBAL|CRCLOSEBAL|CLTCODE|ACNAME|ACCAT|BRANCHCODE|OP_DE|OP_CR|TR_DE|TR_CR|FDATE|TDATE|SELECTON|SORTON|EXCHANGE|SEGMENT|CLTRW|ACNRW',  
   'MONEY|MONEY|VARCHAR|UDTACNAME|UDTACCAT|UDTBRANCHCODE|MONEY|MONEY|MONEY|MONEY|VARCHAR|VARCHAR|VARCHAR|VARCHAR|UDTEXCHANGE|UDTSEGMENT|INT|INT',  
   '||45||||||||11|11|3|10||||',  
   '0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'  
  ALTER TABLE #DATA_OUTER_SUM ADD SRNO INT IDENTITY(1,1), VLINK INT DEFAULT 1  
--  CREATE TABLE #DATA_OUTER_SUM  
--  (  
--   ENTITY VARCHAR(20),  
--   DRCLOSEBAL MONEY NULL,  
--   CRCLOSEBAL MONEY NULL,  
--   CLTCODE VARCHAR(45) NOT NULL, -- Increased the Field Length for Branch Control Account Reverse Effect (Routed Entries)  
--   ACNAME UDTACNAME NULL,  
--   ACCAT UDTACCAT NULL,  
--   BRANCHCODE UDTBRANCHCODE NULL,  
--   OP_DE MONEY NULL,  
--   OP_CR MONEY NULL,  
--   TR_DE MONEY NULL,  
--   TR_CR MONEY NULL,  
--   FDATE VARCHAR(11) NULL,  
--   TDATE VARCHAR(11) NULL,  
--   SELECTON VARCHAR(3) NULL,  
--   SORTON VARCHAR(10) NULL,  
--   EXCHANGE UDTEXCHANGE NULL,  
--   SEGMENT UDTSEGMENT NULL,  
--   CLTRW INT NULL,  
--   ACNRW INT NULL,  
--   SRNO INT IDENTITY(1,1),  
--   VLINK INT DEFAULT 1  
--  )  
 WHILE 1 = 1  
  BEGIN  
   SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))  
   IF @EXSEDATA IS NULL OR @EXSEDATA = ''  
    BEGIN  
     BREAK  
    END  
  
   SET @EXCHANGE = .DBO.PIECE(@EXSEDATA, '-', 1)  
   SET @SEGMENT = .DBO.PIECE(@EXSEDATA, '-', 2)  
  
   PRINT @EXSEDATA  
   PRINT @EXCHANGE  
   PRINT @SEGMENT     
   IF @DISPLAY = 'N'  
    BEGIN  
     IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
      BEGIN PRINT 'P'  
       INSERT INTO #DATA_OUTER(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE,ACCAT, ACNAME, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, CLTRW, ACNRW)  
       EXEC RPT_ACCPLREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZZZZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @CLTYPE  
      END  
     IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
      BEGIN PRINT 'G'  
       INSERT INTO #DATA_OUTER(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE, ACNAME, ACCAT, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT)  
       EXEC RPT_ACCGLREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZZZZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT  
       -- CASH AND BANK BOOK  
       INSERT INTO #DATA_OUTER(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE, ACNAME, ACCAT, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, VLINK)  
       EXEC RPT_ACCBOOKSREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZZZZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, '0'  
       --PARTY TOTAL  
      END  
     IF @VIEWOPTION = 'G'-- OR @VIEWOPTION = 'A'  
      BEGIN 
      PRINT 'angelG'  
       INSERT INTO #DATA_OUTER(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE,ACCAT, ACNAME, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, CLTRW, ACNRW)  
       EXEC RPT_ACCPLREPORT_SUM_REV_TOTAL @FDATE, @TDATE, '0', 'ZZZZZZZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @CLTYPE  
      END  
    END  
   ELSE  
    BEGIN  
     INSERT INTO #DATA_OUTER(ENTITY, CLTCODE, ACNAME, OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK)  
     EXEC RPT_TRIAL_BALANCE @FDATE, @TDATE, @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @VIEWOPTION, @SHOWZEROCLOBAL, @DISPLAY, @CLTYPE  
    END  
  
   SET @ROWPOS = @ROWPOS + 1     
  END  
  
  UPDATE #DATA_OUTER  
  SET ACNAME = M.ACNAME  
  FROM  
   (SELECT CLTCODE, ACNAME = MIN(ACNAME) FROM #DATA_OUTER GROUP BY CLTCODE HAVING COUNT(DISTINCT ACNAME) > 1) M  
  WHERE  
   #DATA_OUTER.CLTCODE = M.CLTCODE  
  
  
  INSERT INTO #DATA_OUTER_SUM (ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE, ACNAME, ACCAT, BRANCHCODE,  
         OP_DE, OP_CR, TR_DE, TR_CR, FDATE, TDATE, SELECTON, SORTON, EXCHANGE,  
         SEGMENT, CLTRW, ACNRW, VLINK)  
  SELECT ENTITY, SUM(DRCLOSEBAL), SUM(CRCLOSEBAL), CLTCODE, ACNAME, ACCAT, BRANCHCODE,  
         SUM(OP_DE), SUM(OP_CR), SUM(TR_DE), SUM(TR_CR), FDATE, TDATE, SELECTON, SORTON, EXCHANGE,  
         SEGMENT, CLTRW, ACNRW, VLINK  
  FROM #DATA_OUTER GROUP BY ENTITY,CLTCODE, ACNAME, ACCAT, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE,  
         SEGMENT, CLTRW, ACNRW, VLINK  
  
  
--SELECT * FROM #DATA_OUTER_SUM RETURN  
  DROP TABLE #DATA_OUTER  
  
  --UPDATE BRANCH CODE  
  IF @BRANCHCODE = '' OR @BRANCHCODE = '%'   
   BEGIN  
    UPDATE D  
     SET D.BRANCHCODE = A.BRANCHCODE  
    FROM #DATA_OUTER_SUM D, ACMAST A  
     WHERE A.CLTCODE = D.CLTCODE AND D.BRANCHCODE = ''  
   END  
  
  
  SET @ROWPOS = 1   
  WHILE 1 = 1  
   BEGIN  
    SET @EXSEDATA = LTRIM(RTRIM(.DBO.PIECE(@SEG_EXC, '|', @ROWPOS)))  
    IF @EXSEDATA IS NULL OR @EXSEDATA = ''  
     BEGIN  
      BREAK  
     END  
  
    INSERT INTO #DATA_OUTER_SUM(ENTITY, CLTCODE, ACNAME, OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK)  
    SELECT DISTINCT @EXSEDATA, D.CLTCODE, D.ACNAME , 0, 0, 0, 0, 0, 0, D.BRANCHCODE, D.ACCAT, VLINK = 0 FROM #DATA_OUTER_SUM D  
    WHERE D.ENTITY <> @EXSEDATA AND NOT EXISTS (SELECT DISTINCT CLTCODE FROM #DATA_OUTER_SUM D1  
        WHERE D.CLTCODE = D1.CLTCODE AND D1.ENTITY = @EXSEDATA)         
  
    SET @ROWPOS = @ROWPOS + 1  
   END  
  
  -- GET SUM BY CLTCODE  
  INSERT INTO #DATA_OUTER_SUM(ENTITY, CLTCODE, ACNAME, OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK)  
  SELECT ENTITY = '', CLTCODE, ACNAME,  
    SUM(OP_DE), SUM(OP_CR), SUM(TR_DE), SUM(TR_CR), SUM(DRCLOSEBAL), SUM(CRCLOSEBAL) ,      
--    OP_DE = CASE WHEN SUM(OP_DE) - SUM(OP_CR) >= 0 THEN SUM(OP_DE) - SUM(OP_CR) ELSE 0 END,  
--    OP_CR = CASE WHEN SUM(OP_DE) - SUM(OP_CR) < 0 THEN SUM(OP_CR) - SUM(OP_DE) ELSE 0 END,  
--    TR_DE = CASE WHEN SUM(TR_DE) - SUM(TR_CR) >= 0 THEN SUM(TR_DE) - SUM(TR_CR) ELSE 0 END,  
--    TR_CR = CASE WHEN SUM(TR_DE) - SUM(TR_CR) < 0 THEN SUM(TR_CR) - SUM(TR_DE) ELSE 0 END,  
--    DRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) >= 0 THEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) ELSE 0 END,  
--    CRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) < 0 THEN SUM(CRCLOSEBAL) - SUM(DRCLOSEBAL) ELSE 0 END,  
    BRANCHCODE , ACCAT , VLINK = CASE WHEN SUM(VLINK) >=1 THEN 1 ELSE 0 END  
  FROM #DATA_OUTER_SUM  
  GROUP BY CLTCODE, ACNAME, BRANCHCODE, ACCAT  
  
  -- GET SUM BY ENTITY  
  INSERT INTO #DATA_OUTER_SUM(ENTITY, CLTCODE, ACNAME, OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK)  
  SELECT ENTITY , CLTCODE = 'ZZZZZZZZZZ', ACNAME = 'ZZZZZZZZZZ',  
    SUM(OP_DE), SUM(OP_CR), SUM(TR_DE), SUM(TR_CR), SUM(DRCLOSEBAL), SUM(CRCLOSEBAL) ,  
--    OP_DE = CASE WHEN SUM(OP_DE) - SUM(OP_CR) >= 0 THEN SUM(OP_DE) - SUM(OP_CR) ELSE 0 END,  
--    OP_CR = CASE WHEN SUM(OP_DE) - SUM(OP_CR) < 0 THEN SUM(OP_CR) - SUM(OP_DE) ELSE 0 END,  
--    TR_DE = CASE WHEN SUM(TR_DE) - SUM(TR_CR) >= 0 THEN SUM(TR_DE) - SUM(TR_CR) ELSE 0 END,  
--    TR_CR = CASE WHEN SUM(TR_DE) - SUM(TR_CR) < 0 THEN SUM(TR_CR) - SUM(TR_DE) ELSE 0 END,  
--    DRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) >= 0 THEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) ELSE 0 END,  
--    CRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) < 0 THEN SUM(CRCLOSEBAL) - SUM(DRCLOSEBAL) ELSE 0 END,  
    BRANCHCODE = '', ACCAT = '', VLINK = 0  
  FROM #DATA_OUTER_SUM  
  WHERE ENTITY <> ''  
  GROUP BY ENTITY  
  
  -- GET TOTAL SUM  
  INSERT INTO #DATA_OUTER_SUM(ENTITY, CLTCODE, ACNAME, OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK)  
  SELECT ENTITY = '', CLTCODE = 'ZZZZZZZZZZ', ACNAME = 'ZZZZZZZZZZ',  
    SUM(OP_DE), SUM(OP_CR), SUM(TR_DE), SUM(TR_CR), SUM(DRCLOSEBAL), SUM(CRCLOSEBAL) ,  
--    OP_DE = CASE WHEN SUM(OP_DE) - SUM(OP_CR) >= 0 THEN SUM(OP_DE) - SUM(OP_CR) ELSE 0 END,  
--    OP_CR = CASE WHEN SUM(OP_DE) - SUM(OP_CR) < 0 THEN SUM(OP_CR) - SUM(OP_DE) ELSE 0 END,  
--    TR_DE = CASE WHEN SUM(TR_DE) - SUM(TR_CR) >= 0 THEN SUM(TR_DE) - SUM(TR_CR) ELSE 0 END,  
--    TR_CR = CASE WHEN SUM(TR_DE) - SUM(TR_CR) < 0 THEN SUM(TR_CR) - SUM(TR_DE) ELSE 0 END,  
--    DRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) >= 0 THEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) ELSE 0 END,  
--    CRCLOSEBAL = CASE WHEN SUM(DRCLOSEBAL) - SUM(CRCLOSEBAL) < 0 THEN SUM(CRCLOSEBAL) - SUM(DRCLOSEBAL) ELSE 0 END,  
    BRANCHCODE = '', ACCAT = '', VLINK = 0  
  FROM #DATA_OUTER_SUM  
  WHERE ENTITY = ''  
  GROUP BY ENTITY  
  
  
  IF @SHOWZEROCLOBAL <> 'Y'  
   BEGIN      
    --DELETE FROM #DATA_OUTER WHERE CRCLOSEBAL = 0 AND DRCLOSEBAL = 0  
    DELETE FROM #DATA_OUTER_SUM WHERE CLTCODE IN (SELECT CLTCODE FROM #DATA_OUTER_SUM WHERE CRCLOSEBAL = 0 AND DRCLOSEBAL = 0 AND ENTITY = '')  
   END  
--  UPDATE #DATA_OUTER  
--  SET ACNAME = M.ACNAME  
--  FROM  
--   (SELECT CLTCODE, ACNAME = MIN(ACNAME) FROM #DATA_OUTER GROUP BY CLTCODE HAVING COUNT(DISTINCT ACNAME) > 1) M  
--  WHERE  
--   #DATA_OUTER.CLTCODE = M.CLTCODE  
  
  DECLARE @I INT  
  SELECT @I = COUNT(DISTINCT CLTCODE) FROM #DATA_OUTER_SUM  
    
  IF @DISPLAY = 'N'  
   BEGIN    
    SELECT * FROM  
    (  
     SELECT   
      NTILE(@I - 1) OVER (ORDER BY ACNAME) O_ACN_ASC,   
      NTILE(@I - 1) OVER (ORDER BY ACNAME DESC) O_ACN_DESC,  
      NTILE(@I - 1) OVER (ORDER BY CLTCODE) O_CLT_ASC,   
      NTILE(@I - 1) OVER (ORDER BY CLTCODE DESC) O_CLT_DESC,  
      upper(ENTITY) ENTITY, UPPER(CLTCODE) CLTCODE --= CASE WHEN CLTCODE = 'ZZZZZZZZZZ' THEN '' ELSE CLTCODE END,  
      ,UPPER(ACNAME) ACNAME --= CASE WHEN ACNAME = 'ZZZZZZZZZZ' THEN '' ELSE ACNAME END  
      , DRCLOSEBAL, CRCLOSEBAL, UPPER(BRANCHCODE) BRANCHCODE, ACCAT, VLINK  
    FROM #DATA_OUTER_SUM  
    WHERE CLTCODE <> 'ZZZZZZZZZZ'  
    UNION ALL  
    SELECT   
     O_ACN_ASC = @I,   
     O_ACN_DESC = @I,  
     O_CLT_ASC = @I,   
     O_CLT_DESC = @I,  
     upper(ENTITY) ENTITY, UPPER(CLTCODE) CLTCODE --= CASE WHEN CLTCODE = 'ZZZZZZZZZZ' THEN '' ELSE CLTCODE END,  
     ,UPPER(ACNAME) ACNAME --= CASE WHEN ACNAME = 'ZZZZZZZZZZ' THEN '' ELSE ACNAME END  
     , DRCLOSEBAL, CRCLOSEBAL, UPPER(BRANCHCODE) BRANCHCODE, ACCAT, VLINK  
    FROM #DATA_OUTER_SUM  
    WHERE CLTCODE = 'ZZZZZZZZZZ') A  
     ORDER BY CASE WHEN @SORTON = 'CODEWISE' THEN A.CLTCODE ELSE A.ACNAME END, A.ENTITY--, SRNO  
   END  
  ELSE  
   BEGIN  
    SELECT * FROM  
    (  
     SELECT   
      NTILE(@I - 1) OVER (ORDER BY ACNAME) O_ACN_ASC,   
      NTILE(@I - 1) OVER (ORDER BY ACNAME DESC) O_ACN_DESC,  
      NTILE(@I - 1) OVER (ORDER BY CLTCODE) O_CLT_ASC,   
      NTILE(@I - 1) OVER (ORDER BY CLTCODE DESC) O_CLT_DESC,  
     upper(ENTITY) ENTITY, UPPER(CLTCODE) CLTCODE--= CASE WHEN CLTCODE = 'ZZZZZZZZZZ' THEN '' ELSE CLTCODE END,  
     ,UPPER(ACNAME) ACNAME --= CASE WHEN ACNAME = 'ZZZZZZZZZZ' THEN '' ELSE ACNAME END  
     , OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, UPPER(BRANCHCODE) BRANCHCODE,  
     ACCAT, SRNO, VLINK  
    FROM #DATA_OUTER_SUM  
    WHERE CLTCODE <> 'ZZZZZZZZZZ'  
    UNION ALL  
    SELECT   
     O_ACN_ASC = @I,   
     O_ACN_DESC = @I,  
     O_CLT_ASC = @I,   
     O_CLT_DESC = @I,  
     upper(ENTITY) ENTITY, UPPER(CLTCODE) CLTCODE--= CASE WHEN CLTCODE = 'ZZZZZZZZZZ' THEN '' ELSE CLTCODE END,  
     ,UPPER(ACNAME) ACNAME --= CASE WHEN ACNAME = 'ZZZZZZZZZZ' THEN '' ELSE ACNAME END  
     , OP_DE, OP_CR, TR_DE, TR_CR, DRCLOSEBAL, CRCLOSEBAL, UPPER(BRANCHCODE) BRANCHCODE,  
     ACCAT, SRNO, VLINK  
    FROM #DATA_OUTER_SUM  
    WHERE CLTCODE = 'ZZZZZZZZZZ') A  
    ORDER BY CASE WHEN @SORTON = 'CODEWISE' THEN A.CLTCODE ELSE A.ACNAME END, A.ENTITY--, SRNO  
   END  
  DROP TABLE #DATA_OUTER_SUM  
END TRY  
BEGIN CATCH  
 DECLARE @ERRMSG VARCHAR(MAX)  
 SET @ERRMSG = ERROR_MESSAGE()  
 RAISERROR( @ERRMSG, 16, 1)  
END CATCH  
/*  
RPT_MULTI_EXCHANGE_TRIAL_BALANCE 'Jun  1 2007', 'BROKER', 'BROKER', '', 'VDT', 'CODEWISE', 'NSE-CAPITAL,BSE-CAPITAL,NSE-FUTURES', 'A', 'Y' , 'N'  
RPT_MULTI_EXCHANGE_TRIAL_BALANCE 'Jun  1 2007', 'BROKER', 'BROKER', '', 'VDT', 'CODEWISE', 'NSE-CAPITAL,BSE-CAPITAL,NSE-FUTURES', 'A', 'Y' , 'O'  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TRIAL_BALANCE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_TRIAL_BALANCE]  
 @FDATE VARCHAR(11),  
 @TDATE VARCHAR(11),  
 @STATUSID VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @BRANCHCODE [UDTBRANCHCODE],  
 @SELECTON VARCHAR(3),  
 @SORTON VARCHAR(10),  
 @EXCHANGE [UDTEXCHANGE],  
 @SEGMENT [UDTSEGMENT],  
 @VIEWOPTION VARCHAR(1),  
 @SHOWZEROCLOBAL VARCHAR(1),  
 @DISPLAY VARCHAR(1),  
 @CLTYPE VARCHAR(3) = ''  
AS  
BEGIN TRY  
 SET NOCOUNT ON;  
 IF @STATUSID <> 'BROKER' AND @STATUSID <> 'BRANCH'  
  BEGIN  
   RAISERROR('This Report is not available for your type of Login', 16, 1)  
   RETURN  
  END  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0  
  BEGIN  
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)  
  END  
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0  
  BEGIN  
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)  
  END  
  
 CREATE TABLE #DATA  
 (  
 ENTITY VARCHAR(20)  
 )  
 EXEC MAKE_UDT_STRUCTURE  
 '#DATA',  
 'DRCLOSEBAL|CRCLOSEBAL|CLTCODE|ACNAME|ACCAT|BRANCHCODE|OPDE|OPCR|TRDE|TRCR|FDATE|TDATE|SELECTON|SORTON|EXCHANGE|SEGMENT|CLTRW|ACNRW',  
 'MONEY|MONEY|VARCHAR|UDTACNAME|UDTACCAT|UDTBRANCHCODE|MONEY|MONEY|MONEY|MONEY|VARCHAR|VARCHAR|VARCHAR|VARCHAR|UDTEXCHANGE|UDTSEGMENT|INT|INT',  
 '||45||||||||11|11|3|10||||',  
 '0|0|1|0|0|0|0|0|0|0|0|0|0|0|0|0|0|0'  
 ALTER TABLE #DATA ADD SRNO INT IDENTITY(1,1), VLINK INT DEFAULT 1  
 /*CREATE TABLE #CLIENT  
 (  
 TRADER VARCHAR(20),  
 SUB_BROKER VARCHAR(20),  
 [L_ADDRESS1] VARCHAR(50) NOT NULL,  
 [L_ADDRESS2] VARCHAR(50) NOT NULL,  
 [L_ADDRESS3] VARCHAR(50) NOT NULL,  
 [L_CITY] VARCHAR(35) NOT NULL,  
 [L_STATE] VARCHAR(100) NOT NULL,  
 [L_NATION] VARCHAR(50) NOT NULL,  
 [L_ZIP] VARCHAR(12) NOT NULL,  
 [FAX] VARCHAR(20) NOT NULL,  
 [RES_PHONE1] VARCHAR(30) NOT NULL,  
 [RES_PHONE2] VARCHAR(30) NOT NULL,  
 [MOBILE_PAGER] VARCHAR(50) NOT NULL,  
 [PAN_GIR_NO] VARCHAR(10) NOT NULL,  
 [EMAIL] VARCHAR(100) NOT NULL,  
 [CL_TYPE] VARCHAR(3) NOT NULL,  
 [BANK_NAME] VARCHAR(100) NOT NULL,  
 [ACC_NUM] VARCHAR(40) NOT NULL  
 )  
  
 EXEC MAKE_UDT_STRUCTURE  
 '#CLIENT',  
 'CODE|SHORT_NAME|LONG_NAME|FAMILY|BRANCH_CD|AREA|REGION',  
 'UDTPARTYCODE|UDTACNAME|UDTACNAME|UDTPARTYCODE|UDTBRANCHCODE|UDTAREACODE|UDTREGIONCODE',  
 '',  
 ''*/  
  
 DECLARE  
 @@SHAREDB VARCHAR(20),  
 @@SQL VARCHAR(1000)  
  
 CREATE TABLE #CLIENT   
 (  
  [ACC_NUM] VARCHAR(40) NOT NULL  
 )  
  
 EXEC MAKE_UDT_STRUCTURE  
  '#CLIENT',  
  'CODE|LONG_NAME',  
  'UDTPARTYCODE|UDTACNAME',  
  '',  
  '1|0'  
  
  
 SELECT @@SQL = "ALTER TABLE [DBO].[#CLIENT] ADD  CONSTRAINT [PK_CLTMAST] PRIMARY KEY CLUSTERED ([CODE] ASC)"  
  
 EXEC (@@SQL)  
  
 SELECT @@SHAREDB = SHAREDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
  
/* SET @@SQL = "INSERT INTO #CLIENT(CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE,  
 L_NATION, L_ZIP, FAX, RES_PHONE1, RES_PHONE2, MOBILE_PAGER, PAN_GIR_NO, EMAIL, CL_TYPE,FAMILY,TRADER,SUB_BROKER,BRANCH_CD,AREA,REGION,BANK_NAME,ACC_NUM) "  
 SET @@SQL = @@SQL + " SELECT * FROM " + @@SHAREDB + ".DBO.UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '0','ZZZZ','" + @CLTYPE + "')"*/  
  
 SET @@SQL = "INSERT INTO #CLIENT(CODE,LONG_NAME, ACC_NUM)"  
 SET @@SQL = @@SQL + " SELECT CODE, LONG_NAME, ACC_NUM FROM " + @@SHAREDB + "..UFN_LOGINCHECK('" + @EXCHANGE + "','" + @SEGMENT + "','" + @STATUSID + "','" + @STATUSNAME + "', 'PARTY', '0','ZZZZ','" + @CLTYPE + "')"  
  
 EXEC (@@SQL)  
  
IF @DISPLAY = 'N'  
 BEGIN  
  IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
   BEGIN  
    INSERT INTO #DATA(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE,ACCAT, ACNAME, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, CLTRW, ACNRW)  
    EXEC RPT_ACCPLREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @CLTYPE  
   END  
  IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
   BEGIN  
    INSERT INTO #DATA(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE, ACNAME, ACCAT, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT)  
    EXEC RPT_ACCGLREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT  
    INSERT INTO #DATA(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE, ACNAME, ACCAT, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, VLINK)  
    EXEC RPT_ACCBOOKSREPORT_SUM_REV @FDATE, @TDATE, '0', 'ZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, '0'  
   END  
  
  IF @VIEWOPTION = 'G'  
   BEGIN PRINT 'G'  
    INSERT INTO #DATA_OUTER(ENTITY, DRCLOSEBAL, CRCLOSEBAL, CLTCODE,ACCAT, ACNAME, BRANCHCODE, FDATE, TDATE, SELECTON, SORTON, EXCHANGE, SEGMENT, CLTRW, ACNRW)  
    EXEC RPT_ACCPLREPORT_SUM_REV_TOTAL @FDATE, @TDATE, '0', 'ZZZZZZZZZZ', @STATUSID, @STATUSNAME, @BRANCHCODE, @SELECTON, @SORTON, @EXCHANGE, @SEGMENT, @CLTYPE  
   END  
 END  
ELSE  
 BEGIN  
  PRINT '1'  
  DECLARE  
   @YEARSTART VARCHAR(11),  
   @YEAREND VARCHAR(11)  
   SELECT  
    @YEARSTART = CONVERT(VARCHAR(11), SDTCUR, 109),  
    @YEAREND = CONVERT(VARCHAR(11), LDTCUR, 109)  
   FROM  
    PARAMETER  
   WHERE  
    @FDATE BETWEEN SDTCUR AND LDTCUR  
    AND @TDATE BETWEEN SDTCUR AND LDTCUR  
  
   IF @YEARSTART IS NULL OR @YEAREND IS NULL  
    BEGIN  
     RAISERROR('Invalid Financial Information...', 16, 1)  
     RETURN  
    END  
  
   IF @SELECTON = 'VDT'  
    BEGIN  
     IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
        SELECT  
        CLTCODE  
        , ACNAME  
        , DRAMOUNT  
        , CRAMOUNT  
        , TRDE = 0  
        , TRCR = 0  
        , ACCAT  
        , BRANCHCODE = ''  
        FROM ACC_LEDGER_GL  
        WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE = 18  
         AND VDT LIKE @YEARSTART + '%'  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
         AND @STATUSNAME =  
         (  
         CASE @STATUSID  
         WHEN 'BRANCH' THEN BRANCHCODE  
         ELSE  
         'BROKER'  
         END  
         )  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
        SELECT  
        CLTCODE  
        , ACNAME  
        , DRAMOUNT  
        , CRAMOUNT  
        , TRDE = 0  
        , TRCR = 0  
        , ACCAT  
        , BRANCHCODE = ''  
        FROM ACC_LEDGER_GL  
        WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND VDT >= @YEARSTART AND VDT < @FDATE  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
         AND @STATUSNAME =  
         (  
         CASE @STATUSID  
         WHEN 'BRANCH' THEN BRANCHCODE  
         ELSE  
         'BROKER'  
         END  
         )  
      END  
     IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , DRAMOUNT  
       , CRAMOUNT  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
        FROM ACC_LEDGER_PL (NOLOCK)  
        WHERE   
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE = 18  
         AND VDT LIKE @YEARSTART + '%'  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , DRAMOUNT  
       , CRAMOUNT  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
        FROM ACC_LEDGER_PL (NOLOCK)  
        WHERE   
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND VDT >= @YEARSTART AND VDT < @FDATE  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
      END  
  
     IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
        SELECT  
        CLTCODE  
        , ACNAME  
        , OPDE = 0  
        , OPCR = 0  
        , TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
        , TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
        , ACCAT  
        , BRANCHCODE  = ''  
        FROM ACC_LEDGER_GL  
        WHERE  
        EXCHANGE = @EXCHANGE  
        AND SEGMENT = @SEGMENT  
        AND VTYPE <> 18  
        AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
        AND VDT BETWEEN @FDATE AND @TDATE + ' 23:59'  
        AND @STATUSNAME =  
        (  
        CASE @STATUSID  
        WHEN 'BRANCH' THEN BRANCHCODE  
        ELSE  
        'BROKER'  
        END  
        )  
        GROUP BY  
        CLTCODE,  
        ACNAME,  
        ACCAT  
        ORDER BY  
        ACNAME,  
        CLTCODE  
      END  
     IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL   
         WHERE  
          EXCHANGE = @EXCHANGE  
          AND SEGMENT = @SEGMENT  
          AND VTYPE <> 18  
          AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
          AND VDT BETWEEN @FDATE AND @TDATE + ' 23:59') P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       L.CODE,  
       L.LONG_NAME,  
       ACCAT  
       ORDER BY  
       L.LONG_NAME,  
       L.CODE  
      END  
  
     IF @VIEWOPTION = 'G'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL   
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
         AND VDT BETWEEN @FDATE AND @TDATE + ' 23:59') P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       , OPCR = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE = 18  
         AND VDT LIKE @YEARSTART + '%'  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       , OPCR = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND VDT >= @YEARSTART AND VDT < @FDATE  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
      END  
  
     IF @BRANCHCODE <> '' AND @BRANCHCODE <> '%'  
      BEGIN  
       IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
        BEGIN  
         INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE, VLINK)  
         SELECT CLTCODE = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END  
         , ACNAME = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)'  
         , OPDE = 0  
         , OPCR = 0  
         , TRDE = SUM(CRAMOUNT) --CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
         , TRCR = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
         , ACCAT = 0  
         , BRANCHCODE  
         , VLINK = 0  
         FROM ACC_LEDGER_GL  
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND REFCODE = 'HO' AND REFCODE <> BRANCHCODE  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE  <> 'HO' THEN @BRANCHCODE ELSE BRANCHCODE  END  
         AND VDT BETWEEN @FDATE AND @TDATE + ' 23:59'  
         GROUP BY  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END,  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)',  
         ACCAT, BRANCHCODE  
         HAVING SUM(DRAMOUNT - CRAMOUNT) <> 0  
        END  
       IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
        BEGIN  
         INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE, VLINK)  
         SELECT CLTCODE = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END  
         , ACNAME = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)'  
         , OPDE = 0  
         , OPCR = 0  
         , TRDE = SUM(CRAMOUNT) --CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
         , TRCR = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
         , ACCAT = 0  
         , BRANCHCODE  
         , VLINK = 0  
         FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
           FROM ACC_LEDGER_PL  
           WHERE  
           EXCHANGE = @EXCHANGE  
           AND SEGMENT = @SEGMENT  
           AND REFCODE = 'HO' AND REFCODE <> BRANCHCODE  
           AND BRANCHCODE = CASE WHEN @BRANCHCODE  <> 'HO' THEN @BRANCHCODE ELSE BRANCHCODE  END  
           AND VDT BETWEEN @FDATE AND @TDATE + ' 23:59') P, #CLIENT L  
         WHERE  
         P.CLTCODE = L.CODE  
         GROUP BY  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END,  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)',  
         ACCAT, BRANCHCODE  
         HAVING SUM(DRAMOUNT - CRAMOUNT) <> 0  
        END  
  
      END  
    END  
   ELSE  
    BEGIN  
     IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE  
       , ACNAME  
       , DRAMOUNT  
       , CRAMOUNT  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM ACC_LEDGER_GL  
       WHERE  
       EXCHANGE = @EXCHANGE  
       AND SEGMENT = @SEGMENT  
       AND VTYPE = 18  
       AND EDT LIKE @YEARSTART + '%'  
       AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
       AND @STATUSNAME =  
       (  
       CASE @STATUSID  
       WHEN 'BRANCH' THEN BRANCHCODE  
       ELSE  
       'BROKER'  
       END  
       )  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE  
       , ACNAME  
       , CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
       , CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM ACC_LEDGER_GL  
       WHERE  
       EXCHANGE = @EXCHANGE  
       AND SEGMENT = @SEGMENT  
       AND VDT < @YEARSTART  
       AND EDT >= @YEARSTART  
       AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
       AND @STATUSNAME =  
       (  
       CASE @STATUSID  
       WHEN 'BRANCH' THEN BRANCHCODE  
       ELSE  
       'BROKER'  
       END  
       )  
       GROUP BY  
       CLTCODE  
       , ACNAME  
       , ACCAT  
      END  
     IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , DRAMOUNT  
       , CRAMOUNT  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE = 18  
         AND EDT LIKE @YEARSTART + '%'  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
       , CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VDT < @YEARSTART  
         AND EDT >= @YEARSTART  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       L.CODE  
       , L.LONG_NAME  
       , ACCAT  
      END  
     IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE  
       , ACNAME  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM ACC_LEDGER_GL  
       WHERE  
       EXCHANGE = @EXCHANGE  
       AND SEGMENT = @SEGMENT  
       AND VTYPE <> 18  
       AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
       AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'  
       AND @STATUSNAME =  
       (  
       CASE @STATUSID  
       WHEN 'BRANCH' THEN BRANCHCODE  
       ELSE  
       'BROKER'  
       END  
       )  
       GROUP BY  
       CLTCODE,  
       ACNAME,  
       ACCAT  
       ORDER BY  
       ACNAME,  
       CLTCODE  
      END  
     IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = L.CODE  
       , ACNAME = L.LONG_NAME  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE  
          EXCHANGE = @EXCHANGE  
          AND SEGMENT = @SEGMENT  
          AND VTYPE <> 18  
          AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
          AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59') P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       L.CODE,  
       L.LONG_NAME,  
       ACCAT  
       ORDER BY  
       L.LONG_NAME,  
       L.CODE  
      END  
  
     IF @VIEWOPTION = 'G'  
      BEGIN  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL   
         WHERE EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
         AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59') P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = 0  
       , OPCR = 0  
       ,TRDE = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       ,TRCR = SUM(CRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , ACCAT  
       , BRANCHCODE  = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL  
         WHERE EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND VTYPE <> 18  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
         AND VDT < @YEARSTART  
         AND EDT >= @YEARSTART) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
  
       INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE)  
       SELECT  
       CLTCODE = 'ZZZZZZZZ'  
       , ACNAME = 'PARTY TOTAL'  
       , OPDE = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) >= 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
       , OPCR = CASE WHEN SUM(DRAMOUNT - CRAMOUNT) <  0 THEN ABS(SUM(DRAMOUNT - CRAMOUNT)) ELSE 0 END  
       , TRDE = 0  
       , TRCR = 0  
       , ACCAT  
       , BRANCHCODE = ''  
       FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
         FROM ACC_LEDGER_PL   
         WHERE EXCHANGE = @EXCHANGE  
       AND SEGMENT = @SEGMENT  
       AND VTYPE = 18  
       AND VDT LIKE @YEARSTART + '%'  
       AND BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END) P, #CLIENT L  
       WHERE  
       P.CLTCODE = L.CODE  
       GROUP BY  
       ACCAT  
      END  
     IF @BRANCHCODE <> '' AND @BRANCHCODE <> '%'  
      BEGIN  
       IF @VIEWOPTION = 'G' OR @VIEWOPTION = 'A'  
        BEGIN  
         INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE, VLINK)  
         SELECT CLTCODE = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END  
         , ACNAME = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)'  
         , OPDE = 0  
         , OPCR = 0  
         , TRDE = SUM(CRAMOUNT) --CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
         , TRDR = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
         , ACCAT = 0  
         , BRANCHCODE  
         , VLINK = 0  
         FROM ACC_LEDGER_GL  
         WHERE  
         EXCHANGE = @EXCHANGE  
         AND SEGMENT = @SEGMENT  
         AND REFCODE = 'HO' AND REFCODE <> BRANCHCODE  
         AND BRANCHCODE = CASE WHEN @BRANCHCODE  <> 'HO' THEN @BRANCHCODE ELSE BRANCHCODE  END  
         AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59'  
         GROUP BY  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END,  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)',  
         ACCAT, BRANCHCODE  
         HAVING SUM(DRAMOUNT - CRAMOUNT) <> 0  
        END  
       IF @VIEWOPTION = 'P' OR @VIEWOPTION = 'A'  
        BEGIN  
         INSERT INTO #DATA(CLTCODE, ACNAME, OPDE, OPCR, TRDE, TRCR, ACCAT, BRANCHCODE, VLINK)  
         SELECT CLTCODE = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END  
         , ACNAME = CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)'  
         , OPDE = 0  
         , OPCR = 0  
         , TRDE = SUM(CRAMOUNT) --CASE WHEN SUM(CRAMOUNT - DRAMOUNT) >= 0 THEN SUM(CRAMOUNT - DRAMOUNT) ELSE 0 END  
         , TRCR = SUM(DRAMOUNT) --CASE WHEN SUM(DRAMOUNT - CRAMOUNT) > 0 THEN SUM(DRAMOUNT - CRAMOUNT) ELSE 0 END  
         , ACCAT = 0  
         , BRANCHCODE  
         , VLINK = 0  
         FROM (SELECT CLTCODE, DRAMOUNT, CRAMOUNT, ACCAT, BRANCHCODE   
           FROM ACC_LEDGER_PL   
           WHERE EXCHANGE = @EXCHANGE  
           AND SEGMENT = @SEGMENT  
           AND REFCODE = 'HO' AND REFCODE <> BRANCHCODE  
           AND BRANCHCODE = CASE WHEN @BRANCHCODE  <> 'HO' THEN @BRANCHCODE ELSE BRANCHCODE  END  
           AND EDT BETWEEN @YEARSTART AND @TDATE + ' 23:59')P, #CLIENT L  
         WHERE  
         P.CLTCODE = L.CODE  
         GROUP BY  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL' ELSE 'HOCTRL' END,  
         CASE WHEN @BRANCHCODE  = 'HO' THEN UPPER(LTRIM(RTRIM(BRANCHCODE))) + 'CTRL-' ELSE 'HOCTRL-' END + '(ROUTED TRANS)',  
         ACCAT, BRANCHCODE  
         HAVING SUM(DRAMOUNT - CRAMOUNT) <> 0  
        END  
      END  
    END  
  END  
 IF @BRANCHCODE = '' OR @BRANCHCODE = '%'  
  BEGIN  
   UPDATE D  
   SET D.BRANCHCODE = A.BRANCHCODE  
   FROM #DATA D, ACMAST A  
   WHERE A.CLTCODE = D.CLTCODE AND D.BRANCHCODE = ''  
  END  
  
 UPDATE #DATA  
 SET ACNAME = M.ACNAME  
 FROM  
 (SELECT CLTCODE, ACNAME = MIN(ACNAME) FROM #DATA GROUP BY CLTCODE HAVING COUNT(DISTINCT ACNAME) > 1) M  
 WHERE  
 #DATA.CLTCODE = M.CLTCODE  
  
 IF @DISPLAY = 'N'  
  BEGIN  
   IF @SHOWZEROCLOBAL = 'N'  
    BEGIN  
     DELETE FROM #DATA WHERE CRCLOSEBAL = 0 AND DRCLOSEBAL = 0  
    END  
   SELECT ENTITY, CLTCODE, ACNAME,  OP_DE = '', OP_CR =  '', TR_DE =  '', TR_CR =  '',DRCLOSEBAL, CRCLOSEBAL, BRANCHCODE, ACCAT, VLINK FROM #DATA  
   ORDER BY SRNO, CASE WHEN @SORTON = 'CODEWISE' THEN CLTCODE ELSE ACNAME END  
  END  
 ELSE  
  BEGIN  
   SELECT ENTITY = @EXCHANGE + '-' + @SEGMENT,  
   CLTCODE  
   , ACNAME  
   , OP_DE = CASE WHEN SUM(OPDE-OPCR) >= 0 THEN SUM(OPDE-OPCR) ELSE 0 END  
   , OP_CR = CASE WHEN SUM(OPDE-OPCR) < 0 THEN ABS(SUM(OPDE-OPCR)) ELSE 0 END  
   , TR_DE = SUM(TRDE) --CASE WHEN SUM(TRDE-TRCR) >= 0 THEN SUM(TRDE-TRCR) ELSE 0 END  
   , TR_CR = SUM(TRCR) --CASE WHEN SUM(TRDE-TRCR) < 0 THEN ABS(SUM(TRDE-TRCR)) ELSE 0 END  
   , DRCLOSEBAL = CASE WHEN (SUM(OPDE + TRDE - OPCR - TRCR)) >= 0 THEN SUM(OPDE + TRDE - OPCR - TRCR) ELSE 0 END  
   , CRCLOSEBAL = CASE WHEN (SUM(-OPDE - TRDE + OPCR + TRCR)) > 0 THEN  SUM(-OPDE - TRDE + OPCR + TRCR) ELSE 0 END  
   , BRANCHCODE = CASE WHEN @BRANCHCODE = '' OR @BRANCHCODE = '%' THEN BRANCHCODE ELSE @BRANCHCODE END  
   , ACCAT  
   , VLINK  
   FROM #DATA  
   GROUP BY CLTCODE, ACNAME, ACCAT, BRANCHCODE, VLINK  
   HAVING   0 <  CASE WHEN @SHOWZEROCLOBAL = 'N' THEN ABS(SUM(OPDE + TRDE - OPCR - TRCR)) ELSE 1 END  
   ORDER BY  
   CASE WHEN @SORTON = 'CODEWISE' THEN CLTCODE ELSE ACNAME END  
  END  
  
 DROP TABLE #DATA  
END TRY  
BEGIN CATCH  
 DECLARE @ERRMSG VARCHAR(MAX)  
 SET @ERRMSG = ERROR_MESSAGE()  
 RAISERROR( @ERRMSG, 16, 1)  
END CATCH  
/*  
SELECT * FROM ACMAST WHERE CLTCODE = 'SUSP'  
exec RPT_TRIAL_BALANCE 'APR  1 2009', 'MAR 31 2010', 'BROKER', 'BROKER', '', 'VDT', 'VDT', 'NSE', 'CAPITAL', 'A', 'N', 'O'  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Searchinall
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Searchinall]       
(@strFind AS VARCHAR(MAX))
AS
BEGIN
    SET NOCOUNT ON; 
    --TO FIND STRING IN ALL PROCEDURES        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) SP_Name
              ,OBJECT_DEFINITION(OBJECT_ID) SP_Definition
        FROM   sys.procedures
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL VIEWS        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) View_Name
              ,OBJECT_DEFINITION(OBJECT_ID) View_Definition
        FROM   sys.views
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@strFind+'%'
    END 

    --TO FIND STRING IN ALL FUNCTION        
    BEGIN
        SELECT ROUTINE_NAME           Function_Name
              ,ROUTINE_DEFINITION     Function_definition
        FROM   INFORMATION_SCHEMA.ROUTINES
        WHERE  ROUTINE_DEFINITION LIKE '%'+@strFind+'%'
               AND ROUTINE_TYPE = 'FUNCTION'
        ORDER BY
               ROUTINE_NAME
    END

    --TO FIND STRING IN ALL TABLES OF DATABASE.    
    BEGIN
        SELECT t.name      AS Table_Name
              ,c.name      AS COLUMN_NAME
        FROM   sys.tables  AS t
               INNER JOIN sys.columns c
                    ON  t.OBJECT_ID = c.OBJECT_ID
        WHERE  c.name LIKE '%'+@strFind+'%'
        ORDER BY
               Table_Name
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_BANK_BOOK_WEEKLY_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[SEBI_BANK_BOOK_WEEKLY_BALANCES]
	@DATE_FROM VARCHAR(11),
	@REPORT_DATE VARCHAR(11),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@REPORT_TYPE VARCHAR(3) = 'VDT'
AS

--SEBI_BANK_BOOK_WEEKLY_BALANCES_WRAPPER 'MAY 29 2020'


CREATE TABLE #BANK_BOOK_BAL
(
	BANK_CODE VARCHAR(30),
	BANK_IFSC VARCHAR(30),
	BANK_TYPE VARCHAR(10),
	REPORT_DATE DATETIME,
	AMOUNT MONEY,
	BANK_BALANCE MONEY,
	SNO INT IDENTITY(1, 1)
)

DECLARE
	@SDTCUR VARCHAR(11)

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @DATE_FROM BETWEEN SDTCUR AND LDTCUR
	
	
--SELECT * FROM #BANK_BOOK_BALANCES
IF @REPORT_TYPE = 'VDT'
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(DRAMOUNT - CRAMOUNT),BANK_BALANCE =  0
	FROM ACC_LEDGER_GL L, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE ACCAT = 2
	AND L.Cltcode = BANKCODE AND B.EXCHANGE + B.SEGMENT = L.EXCHANGE + L.SEGMENT AND L.EXCHANGE + L.SEGMENT = @EXCHANGE + @SEGMENT
	AND VDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), AMOUNT = SUM(DRAMOUNT - CRAMOUNT),BANK_BALANCE =  0
	FROM ACC_LEDGER_GL L, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE ACCAT = 2
	AND L.Cltcode = BANKCODE AND B.EXCHANGE + B.SEGMENT = L.EXCHANGE + L.SEGMENT AND L.EXCHANGE + L.SEGMENT = @EXCHANGE + @SEGMENT
	AND VDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
END
ELSE
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT = SUM(AMOUNT),BANK_BALANCE =  0
	FROM(
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(DRAMOUNT - CRAMOUNT)
	FROM LEDGER L, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE ACCAT = 2
	AND A.Cltcode = BANKCODE AND B.EXCHANGE + B.SEGMENT = L.EXCHANGE + L.SEGMENT AND L.EXCHANGE + L.SEGMENT = @EXCHANGE + @SEGMENT
	AND EDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE
	UNION ALL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(CRAMOUNT - DRAMOUNT)
	FROM LEDGER L, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE ACCAT = 2
	AND A.Cltcode = BANKCODE AND B.EXCHANGE + B.SEGMENT = L.EXCHANGE + L.SEGMENT AND L.EXCHANGE + L.SEGMENT = @EXCHANGE + @SEGMENT
	AND EDT >= @SDTCUR AND VDT < @SDTCUR
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE ) A
	GROUP BY BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109)), AMOUNT = SUM(DRAMOUNT - CRAMOUNT),BANK_BALANCE =  0
	FROM LEDGER L, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE ACCAT = 2
	AND A.Cltcode = BANKCODE AND B.EXCHANGE + B.SEGMENT = L.EXCHANGE + L.SEGMENT AND L.EXCHANGE + L.SEGMENT = @EXCHANGE + @SEGMENT
	AND EDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
END

INSERT INTO #BANK_BOOK_BAL
SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, CAL_DATES, AMOUNT = 0, BANK_BALANCE = 0 FROM
(
SELECT * FROM
(SELECT DISTINCT BANK_CODE, BANK_IFSC, BANK_TYPE FROM #BANK_BOOK_BAL) B , CAL_DATES C
) A
WHERE NOT EXISTS(SELECT BANK_CODE FROM #BANK_BOOK_BAL B1 WHERE A.BANK_CODE = B1.BANK_CODE AND A.CAL_DATES = B1.REPORT_DATE)


--UPDATE B SET B.BANK_BALANCE = B1.BANK_BALANCE FROM #BANK_BOOK_BAL B,
--(SELECT BANK_CODE,BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT,
--SUM (AMOUNT) OVER (ORDER BY BANK_CODE, REPORT_DATE) AS BANK_BALANCE
--FROM #BANK_BOOK_BAL) B1
--WHERE B.BANK_CODE = B1.BANK_CODE AND B.REPORT_DATE = B1.

UPDATE B SET BANK_BALANCE = (SELECT SUM(AMOUNT) FROM #BANK_BOOK_BAL B1 WHERE B.BANK_CODE = B1.BANK_CODE AND B1.SNO <= B.SNO) FROM #BANK_BOOK_BAL B

SELECT * FROM #BANK_BOOK_BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
CREATE PROC SP @spName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDBRANCH_EXECUTE
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tally_Acmast_Records
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------

CREATE PROC Tbl @TblName VARCHAR(25)AS           
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getMFLedgerBalance_IPartner
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_getMFLedgerBalance_IPartner]
--Declare 
@PartyCode Varchar(1000)='rp61'

AS
BEGIN

/*
EXEC [usp_getMFLedgerBalance_IPartner] 'ALWR2144'
EXEC [usp_getMFLedgerBalance_IPartner]'rp61'
*/

SELECT (DRAMOUNT) DRAMOUNT,CL_CODE As PartyCode 
INTO #Temp
FROM BBO_FA.dbo.MFSS_REL_DATA with (nolock) WHERE RELDT_DR ='' AND RELDT_CR =''
and VTYPE=2
and CL_CODE=@PartyCode 
--group by CL_CODE



--select * from #Temp


SELECT		Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - ISNULL(Sum(dramount),0) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #bse                   
     FROM   bbo_fa.dbo.mfss_ledger_bse with (nolock)                   
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
    -- WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       WHERE VDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
       and cltcode=@PartyCode
     GROUP  BY cltcode,                   
               edt                   
                 
     SELECT Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - ISNULL(Sum(dramount),0) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #nse                   
     FROM   bbo_fa.dbo.mfss_ledger_nse  with (nolock)                
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
     WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
     and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
     and cltcode=@PartyCode
     GROUP  BY cltcode,                   
               edt          

--select * from #bse A
--select * from  #nse B

--select A.BALANCE BSE_BALANCE,0 NSE_BALANCE,A.cltcode PartyCode 
--from #bse A
--UNION
--select 0 BSE_BALANCE,BALANCE NSE_BALANCE,A.cltcode PartyCode 
--from #nse A

Select (BALANCE) balance ,PartyCode  INTO #NSEBSEALL from 
(
select A.BALANCE BALANCE,A.cltcode PartyCode 
from #bse A
UNION ALL
select A.BALANCE BALANCE,A.cltcode PartyCode 
from #nse A
) T
--group by PartyCode 

--select * from #NSEBSEALL

--select A.BALANCE+B.BALANCE BALANCE,A.cltcode PartyCode INTO #NSEBSEALL
--from #bse A
--Inner join #nse B
--ON A.cltcode=B.cltcode


--select * from #NSEBSEALL

Select Amount,clientcode PartyCode INTO #MF_PO from [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS WITH (NOLOCK)
where clientcode=   @PartyCode                

--select * from #MF_PO

select ISNULL(sum(balance),0) balance,PartyCode Into #NSEBSEALLFinal from #NSEBSEALL Group by PartyCode
select ISNULL(Sum(DRAMOUNT),0) DRAMOUNT,PartyCode Into #TempFinal from #Temp Group by PartyCode
select Isnull(Sum(Amount),0)  Amount,PartyCode INTO #MF_POFinal from #MF_PO Group by PartyCode

--select * from #NSEBSEALLFinal
--select * from #TempFinal 
--select * from #MF_POFinal 


SELECT 
isnull((balance),0)-(ISNULL(B.DRAMOUNT,0))-(ISNULL(PO.Amount,0)) Balance,A.PartyCode   
 from #NSEBSEALLFinal A --order by edt    
left JOIN #TempFinal B  ON A.PartyCode  =B.PartyCode  
left join #MF_POFinal PO ON A.PartyCode  =PO.PartyCode  



DROP TABLE #bse
DROP TABLE #nse
Drop table #Temp
DROP TABLE #MF_PO
Drop table #NSEBSEALL
Drop table #NSEBSEALLFinal
Drop table #TempFinal
Drop table #MF_POFinal

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_getMFLedgerBalance_Test
-- --------------------------------------------------
create PROCEDURE usp_getMFLedgerBalance_Test
@PartyCode Varchar(1000)

AS
BEGIN
/*
EXEC usp_getMFLedgerBalance 'BL18999'
*/

SELECT (DRAMOUNT) DRAMOUNT,CL_CODE As PartyCode 
INTO #Temp
FROM BBO_FA.dbo.MFSS_REL_DATA with (nolock) WHERE RELDT_DR ='' AND RELDT_CR =''
and VTYPE=2
and CL_CODE=@PartyCode 
--group by CL_CODE



--select * from #Temp


SELECT		Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - ISNULL(Sum(dramount),0) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #bse                   
     FROM   bbo_fa.dbo.mfss_ledger_bse with (nolock)                   
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
    -- WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       WHERE VDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
       and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
       and cltcode=@PartyCode
     GROUP  BY cltcode,                   
               edt                   
                 
     SELECT Sum(cramount)                 AS CRAMOUNT,                   
            Sum(dramount)                 AS DRAMOUNT,                  
            Sum(cramount) - ISNULL(Sum(dramount),0) AS BALANCE,                   
            cltcode,                   
            edt                   
     INTO   #nse                   
     FROM   bbo_fa.dbo.mfss_ledger_nse  with (nolock)                
     --WHERE  CONVERT(DATETIME, CONVERT(VARCHAR(11), edt)) = CONVERT(DATETIME,CONVERT(VARCHAR(11), Getdate()))                   
     WHERE EDT BETWEEN (SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1) AND (SELECT LDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)  
     and EDT>=(SELECT SDTCUR FROM PARAMETER WITH (NOLOCK) WHERE CURYEAR=1)
     and cltcode=@PartyCode
     GROUP  BY cltcode,                   
               edt          




select A.BALANCE+B.BALANCE BALANCE,A.cltcode PartyCode INTO #NSEBSEALL
from #bse A
Inner join #nse B
ON A.cltcode=B.cltcode


Select Amount,clientcode PartyCode INTO #MF_PO from [196.1.115.132].risk.dbo.vw_MutualFundPendingOrder_NCMS WITH (NOLOCK)
where clientcode=   @PartyCode                

--select * from #MF_PO

select ISNULL(sum(balance),0) balance,PartyCode Into #NSEBSEALLFinal from #NSEBSEALL Group by PartyCode
select ISNULL(Sum(DRAMOUNT),0) DRAMOUNT,PartyCode Into #TempFinal from #Temp Group by PartyCode
select Isnull(Sum(Amount),0)  Amount,PartyCode INTO #MF_POFinal from #MF_PO Group by PartyCode






SELECT 
isnull((balance),0)-(ISNULL(B.DRAMOUNT,0))-(ISNULL(PO.Amount,0)) Balance,A.PartyCode   
 from #NSEBSEALLFinal A --order by edt    
left JOIN #TempFinal B  ON A.PartyCode  =B.PartyCode  
left join #MF_POFinal PO ON A.PartyCode  =PO.PartyCode  



--SELECT SUM(balance)-SUM(ISNULL(B.DRAMOUNT,0))-ISNULL(SUM(PO.Amount),0) Balance,A.cltcode  from #bse A --order by edt    
--left JOIN #Temp B  ON A.cltcode=B.PartyCode  
--left join #MF_PO PO ON A.cltcode=PO.clientcode       
--GROUP BY A.cltcode        

--select SUM(balance)-SUM(ISNULL(B.DRAMOUNT,0))-ISNULL(SUM(PO.Amount),0) Balance ,A.cltcode  from #nse A--order by edt
--left JOIN #Temp B  ON A.cltcode=B.PartyCode
--left join #MF_PO PO ON A.cltcode=PO.clientcode
--GROUP BY A.cltcode     


DROP TABLE #bse
DROP TABLE #nse
Drop table #Temp
DROP TABLE #MF_PO
Drop table #NSEBSEALL
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHQ_NEW_BANKFORMAT
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_CHQ_CANCELRETURN
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_VOUCHER_SAVEREC
-- --------------------------------------------------
  CREATE  PROCEDURE [dbo].[V2_OFFLINE_VOUCHER_SAVEREC] 
@SNO			VARCHAR(600),--varchar(1),
@VDATE			VARCHAR(700),--DATETIME,
@EDATE			VARCHAR(700),--DATETIME,
@CLTCODE		VARCHAR(600),--VARCHAR(10),
@CREDITAMT		VARCHAR(1500),--MONEY,
@DEBITAMT		VARCHAR(1500),--MONEY,
@NARRATION		VARCHAR(MAX),--VARCHAR(255),
@OPPCODE		VARCHAR(600),--VARCHAR(10),
@MARGINCODE		VARCHAR(600),
@ADDBY			VARCHAR(25),
@CATEGORY		VARCHAR(10),
@STATUSID		VARCHAR(25),
@STATUSNAME		VARCHAR(25),
@VOUCHERTYPE	VARCHAR(600),--SMALLINT,
@BOOKTYPE		VARCHAR(255),--VARCHAR(2),
@VNO			VARCHAR(12),--VARCHAR(12),			
@BANKNAME		VARCHAR(3000),
@BRANCHNAME		VARCHAR(3000),
@DDNO			VARCHAR(800),
@CHEQUEMODE		VARCHAR(150),
@CHEQUEDATE		VARCHAR(600),--DATETIME,
@CHEQUENAME		VARCHAR(3000),
@CLEAR_MODE		VARCHAR(150),
@BRANCHCODE		VARCHAR(600),
@TPACCOUNTNUMBER	VARCHAR(1500),
@EXCHANGE		UDTEXCHANGE,--VARCHAR(3),
@SEGMENT		UDTSEGMENT,--VARCHAR(20),
@TPFLAG			VARCHAR(600),--TINYINT,
@CLIENTNAME		VARCHAR(7000),
@OPPCODENAME	VARCHAR(7000),
@MARGINCODENAME	VARCHAR(7000),
@REVAMT			VARCHAR(1500),--MONEY,
@REVCODE		VARCHAR(600),--VARCHAR(10),
@MICR			VARCHAR(600),--VARCHAR(9),
@DISPLAY_FLAG   VARCHAR(200),--VARCHAR(1),
@COSTBRANCHPOSTING VARCHAR(MAX),
@FLDAUTO VARCHAR(600),
@IPADD VARCHAR(15),
@result varchar(100) out

AS

	DECLARE @VOLE_REFNO BIGINT,
			@COST_BRANCH_DATA VARCHAR(8000),
--			@COST_BRANCH VARCHAR(1000),
			@CBD_ID INT,
			@MAIN_LOOPID INT,
			@DEBIT_CB MONEY,
			@CREDIT_CB MONEY,
			@SNO_ INT,
			@VDATE_ VARCHAR(11),
			@EDATE_ VARCHAR(11),
			@CLTCODE_ UDTPARTYCODE,
			@DEBITAMT_ MONEY,
			@CREDITAMT_ MONEY,
			@NARRATION_ UDTNARRATION,
			@OPPCODE_ UDTPARTYCODE,
			@MARGINCODE_ UDTPARTYCODE,			
			@VOUCHERTYPE_ UDTVTYPE,
			@BOOKTYPE_ UDTBOOKTYPE,
			@VNO_ UDTVNO,
			@APPROVALFLAG UDTTINYINT,
			@BANKNAME_ UDTBANKNAME,
			@BRANCHNAME_ UDTBRANCHNAME,
			@DDNO_ VARCHAR(15),
			@CHEQUEMODE_ VARCHAR(1),
			@CHEQUEDATE_  VARCHAR(11),
			@CHEQUENAME_  VARCHAR(50),
			@CLEAR_MODE_ VARCHAR(1),
			@BRANCHCODE_ VARCHAR(10),
			@TPACCOUNTNUMBER_ VARCHAR(20),
--			@EXCHANGE_ VARCHAR(10),
--			@SEGMENT_ VARCHAR(20),
			@TPFLAG_ TINYINT,
			@CLIENTNAME_ VARCHAR(100),
			@OPPCODENAME_ VARCHAR(100),
			@MARGINCODENAME_ VARCHAR(100),
			@REVAMT_ MONEY,
			@REVCODE_ VARCHAR(10),
			@MICR_ VARCHAR(9),
			@DISPLAY_FLAG_ VARCHAR(1),
			@COSTBRANCHPOSTING_ VARCHAR(800),
			@TALLY_ACMAST INT,
			@ACCDB VARCHAR(25),
			@SQL VARCHAR(200),
			@PROCEED BIT,
			@FLDAUTO_ INT,
			@AUTOPOSTING BIT,
			@SRNO_ INT

SET @SRNO_ = 0


			CREATE TABLE #TOTCOUNT(	COUNTVAL INT )

			SET @MAIN_LOOPID = 1
			SET @PROCEED = 0
			
			SELECT @ACCDB = ACCOUNTDB FROM VW_MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1
WHILE 1 = 1
BEGIN
--	SET @EXCHANGE_ = .DBO.PIECE(@EXCHANGE, '', @MAIN_LOOPID)
--	SET @SEGMENT_ = .DBO.PIECE(@SEGMENT, '', @MAIN_LOOPID)
	SET @CLTCODE_ = .DBO.PIECE(@CLTCODE, '', @MAIN_LOOPID)
	SET @OPPCODE_ = .DBO.PIECE(@OPPCODE, '', @MAIN_LOOPID)
	SET @MARGINCODE_ = .DBO.PIECE(@MARGINCODE, '', @MAIN_LOOPID)

	IF @ACCDB = NULL AND @ACCDB = '' AND @CLTCODE_ = NULL
		AND @CLTCODE_ = '' AND @OPPCODE_ = NULL AND @OPPCODE_ = ''  AND .DBO.PIECE(@VOUCHERTYPE, '', @MAIN_LOOPID) = NULL AND .DBO.PIECE(@VOUCHERTYPE, '', @MAIN_LOOPID) = '' 
	BEGIN
		BREAK
	END

	SET @VOUCHERTYPE_ = CONVERT(SMALLINT, .DBO.PIECE(@VOUCHERTYPE, '', @MAIN_LOOPID))

	SET @SQL = " SELECT  COUNT(1) FROM " + @ACCDB + ".DBO.ACMAST WHERE "
	SET @SQL = @SQL + " LTRIM(RTRIM(CLTCODE)) IN ('" + @CLTCODE_ + "','" + @OPPCODE_ +  "','" + @MARGINCODE_ + "') AND LTRIM(RTRIM(CLTCODE)) <> ''"
	SET @SQL = @SQL + " AND EXCHANGE = '" + @EXCHANGE + "' AND SEGMENT = '" + @SEGMENT + "' "

	INSERT INTO #TOTCOUNT(COUNTVAL) 
	EXEC(@SQL)

	SELECT @TALLY_ACMAST = COUNTVAL FROM #TOTCOUNT
	
	
	IF @VOUCHERTYPE_ IN (1,2,3,4) AND @TALLY_ACMAST = 2
		BEGIN			
			SET @PROCEED = 1
		END
	
	IF @VOUCHERTYPE_ IN (5,6,7,8) AND @TALLY_ACMAST = 1
		BEGIN			
			SET @PROCEED = 1
		END
	
	IF @VOUCHERTYPE_ IN (19, 20, 22, 23, 24) AND @TALLY_ACMAST = 3
		BEGIN			
			SET @PROCEED = 1
		END
	
	IF @PROCEED = 0
	BEGIN
		BREAK
	END
					
	SET @SNO_ = CONVERT(INT, .DBO.PIECE(@SNO, '', @MAIN_LOOPID))
	IF @SNO_ = 1 
		SET @SRNO_ = @SRNO_ + 1

	SET @VDATE_ = CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(@VDATE, '', @MAIN_LOOPID), 103), 111)
	SET @EDATE_ = CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(@EDATE, '', @MAIN_LOOPID), 103), 111)
	SET @DEBITAMT_ = CONVERT(MONEY, .DBO.PIECE(@DEBITAMT, '', @MAIN_LOOPID))
	SET @CREDITAMT_ = CONVERT(MONEY, .DBO.PIECE(@CREDITAMT, '', @MAIN_LOOPID))
	SET @NARRATION_ = .DBO.PIECE(@NARRATION, '', @MAIN_LOOPID)
	SET @BOOKTYPE_ = .DBO.PIECE(@BOOKTYPE, '', @MAIN_LOOPID)
	SET @VNO_ = @VNO--.DBO.PIECE(@VNO, '', @MAIN_LOOPID)
	SET @BANKNAME_ = .DBO.PIECE(@BANKNAME, '', @MAIN_LOOPID)
	SET @BRANCHNAME_ = .DBO.PIECE(@BRANCHNAME, '', @MAIN_LOOPID)
	SET @DDNO_ = .DBO.PIECE(@DDNO, '', @MAIN_LOOPID)
	SET @CHEQUEMODE_ = .DBO.PIECE(@CHEQUEMODE, '', @MAIN_LOOPID)
	SET @CHEQUEDATE_ = CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(@CHEQUEDATE, '', @MAIN_LOOPID), 103), 111)
	SET @CHEQUENAME_ = .DBO.PIECE(@CHEQUENAME, '', @MAIN_LOOPID)
	SET @CLEAR_MODE_ = .DBO.PIECE(@CLEAR_MODE, '', @MAIN_LOOPID)
	SET @BRANCHCODE_ = .DBO.PIECE(@BRANCHCODE, '', @MAIN_LOOPID)


	SET @TPACCOUNTNUMBER_ = .DBO.PIECE(@TPACCOUNTNUMBER, '', @MAIN_LOOPID)
	SET @TPFLAG_ = CONVERT(TINYINT, .DBO.PIECE(@TPFLAG, '', @MAIN_LOOPID))
	SET @CLIENTNAME_ = .DBO.PIECE(@CLIENTNAME, '', @MAIN_LOOPID)
	SET @OPPCODENAME_ = .DBO.PIECE(@OPPCODENAME, '', @MAIN_LOOPID)
	SET @OPPCODENAME_ = .DBO.PIECE(@OPPCODENAME, '', @MAIN_LOOPID)
	SET @MARGINCODENAME_ = .DBO.PIECE(@MARGINCODENAME, '', @MAIN_LOOPID)
	SET @REVAMT_ = CONVERT( MONEY, ISNULL(.DBO.PIECE(@REVAMT, '', @MAIN_LOOPID), 0))
	SET @REVCODE_ = .DBO.PIECE(@REVCODE, '', @MAIN_LOOPID)
	SET @MICR_ = .DBO.PIECE(@MICR, '', @MAIN_LOOPID)
	SET @DISPLAY_FLAG_ = .DBO.PIECE(@DISPLAY_FLAG, '', @MAIN_LOOPID)
	SET @COSTBRANCHPOSTING_ = .DBO.PIECE(@COSTBRANCHPOSTING, '', @MAIN_LOOPID)
	SET @FLDAUTO_ = .DBO.PIECE(@FLDAUTO, '', @MAIN_LOOPID)

	SELECT @AUTOPOSTING = AUTOPOSTING FROM OFFLINE_VOUCHER_SETTING
	IF @FLDAUTO_ = '' --AND 
		BEGIN
				--print @VDATE_
--				print @EDATE_
				SELECT @APPROVALFLAG = (CASE WHEN MKCKFLAG = 4 THEN 1 ELSE 0 END) FROM .DBO.FN_USERRIGHTS(@VOUCHERTYPE_, @BOOKTYPE_, @EXCHANGE, @SEGMENT, @ADDBY, @CATEGORY)
				

				INSERT INTO V2_OFFLINE_LEDGER_ENTRIES (SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION,
					OPPCODE, MARGINCODE, ROWSTATE, ADDDT, ADDBY, STATUSID, STATUSNAME,
					VOUCHERTYPE, BOOKTYPE, VOUCHERNO, APPROVALFLAG, BANKNAME, BRANCHNAME,
					DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, BRANCHCODE,
					TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, LEDGERVNO, CLIENTNAME, OPPCODENAME,
					MARGINCODENAME, REVAMT, REVCODE, MICR, DISPLAY_FLAG,RESERVED2)
				VALUES
					(@SNO_, @VDATE_, @EDATE_, @CLTCODE_, @CREDITAMT_, @DEBITAMT_, @NARRATION_,
					@OPPCODE_, @MARGINCODE_, 0, CONVERT(VARCHAR, GETDATE(), 111), @ADDBY, @STATUSID, @STATUSNAME,
					@VOUCHERTYPE_, @BOOKTYPE_, @VNO_, @APPROVALFLAG, @BANKNAME_, @BRANCHNAME_,
					@DDNO_, @CHEQUEMODE_, @CHEQUEDATE_, @CHEQUENAME_, @CLEAR_MODE_, @BRANCHCODE_,
					@TPACCOUNTNUMBER_, @EXCHANGE, @SEGMENT, @TPFLAG_, '', CASE WHEN @VOUCHERTYPE_ = 5 THEN @OPPCODENAME_ ELSE @CLIENTNAME_ END, @OPPCODENAME_,
					@MARGINCODENAME_, @REVAMT_, @REVCODE_, @MICR_, @DISPLAY_FLAG_,@SRNO_)

					IF LEN(@COSTBRANCHPOSTING_) > 0
					BEGIN
						SELECT @VOLE_REFNO = IDENT_CURRENT('V2_OFFLINE_LEDGER_ENTRIES')
						
						SELECT @CBD_ID = 1--, @CB_LOOPID = 1
						WHILE 1 = 1
							BEGIN
								SET @COST_BRANCH_DATA = .DBO.PIECE(@COSTBRANCHPOSTING_, '~', @CBD_ID)
								IF @COST_BRANCH_DATA IS NULL OR @COST_BRANCH_DATA = ''
									BEGIN
										BREAK
									END
								
										IF @CREDITAMT_ = 0
											BEGIN
												SET @DEBIT_CB = .DBO.PIECE(@COST_BRANCH_DATA, '|', 4)
												SET @CREDIT_CB = 0
											END
										ELSE
											BEGIN
												SET @DEBIT_CB = 0
												SET @CREDIT_CB = .DBO.PIECE(@COST_BRANCH_DATA, '|', 4)
											END

										INSERT INTO V2_OFFLINE_CC_ENTRIES(VOLE_REFNO,SNO,CREDITAMT,DEBITAMT,CLTCODE,BRANCHCODE,
											CATCODE, COSTCODE,ADDBY,STATUSID,STATUSNAME,ADDDT)
										VALUES
										(@VOLE_REFNO, @CBD_ID, @CREDIT_CB, @DEBIT_CB, @CLTCODE_, @BRANCHCODE_,
											.DBO.PIECE(@COST_BRANCH_DATA, '|', 2), .DBO.PIECE(@COST_BRANCH_DATA, '|', 3),
											@ADDBY, @STATUSID, @STATUSNAME, GETDATE())
								SET @CBD_ID = @CBD_ID + 1
							END
					END

				--SET @PROCEED = 0
				--SET @MAIN_LOOPID = @MAIN_LOOPID + 1
		END
	ELSE
		BEGIN
--			PRINT @FLDAUTO
--			PRINT @VNO
--			PRINT @VOUCHERTYPE
--			PRINT @BOOKTYPE
--			PRINT @EXCHANGE
--			PRINT @SEGMENT
			SET @APPROVALFLAG = ''
			SELECT @APPROVALFLAG = (CASE WHEN MKCKFLAG = 4 THEN 1 ELSE 2 END) FROM .DBO.FN_USERRIGHTS(@VOUCHERTYPE_, @BOOKTYPE_, @EXCHANGE, @SEGMENT, @ADDBY, @CATEGORY)
		
			INSERT INTO V2_OFFLINE_LEDGER_ENTRIES_LOG(FLDAUTO,VOUCHERTYPE,BOOKTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,
					OPPCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,CHEQUEDATE,CHEQUENAME,
					CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,TPFLAG,ADDDT,ADDBY,STATUSID,STATUSNAME,ROWSTATE,
					APPROVALFLAG,APPROVALDATE,APPROVEDBY,VOUCHERNO,UPLOADDT,LEDGERVNO,CLIENTNAME,OPPCODENAME,
					MARGINCODENAME,SETT_NO,SETT_TYPE,PRODUCTTYPE,REVAMT,REVCODE,MICR,DISPLAY_FLAG,
					EDITED_BY, EDITED_ON, ACTION_FLAG, IP_ADD, RECORD_STATE, RESERVED2)
			SELECT FLDAUTO,VOUCHERTYPE,BOOKTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,
					OPPCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE,DDNO,CHEQUEMODE,CHEQUEDATE,CHEQUENAME,
					CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,TPFLAG,ADDDT,ADDBY,STATUSID,STATUSNAME,ROWSTATE,
					APPROVALFLAG,APPROVALDATE,APPROVEDBY,VOUCHERNO,UPLOADDT,LEDGERVNO,CLIENTNAME,OPPCODENAME,
					MARGINCODENAME,SETT_NO,SETT_TYPE,PRODUCTTYPE,REVAMT,REVCODE,MICR,DISPLAY_FLAG,
					@ADDBY, GETDATE(), 'E', @IPADD, 0, 1
			FROM V2_OFFLINE_LEDGER_ENTRIES WHERE FLDAUTO = @FLDAUTO_
				AND VOUCHERNO = @VNO_
				AND VOUCHERTYPE = @VOUCHERTYPE_
				AND BOOKTYPE = @BOOKTYPE_
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
			
			UPDATE V2_OFFLINE_LEDGER_ENTRIES
			SET CLTCODE = @CLTCODE_, CREDITAMT = @CREDITAMT_, DEBITAMT = @DEBITAMT_, NARRATION = @NARRATION_,
				MARGINCODE = @MARGINCODE_, ROWSTATE = 0, APPROVALFLAG = @APPROVALFLAG, BANKNAME = @BANKNAME_,
				BRANCHNAME = @BRANCHNAME_, DDNO = @DDNO_, CHEQUEMODE = @CHEQUEMODE_, CHEQUEDATE = @CHEQUEDATE_,
				CHEQUENAME = @CHEQUENAME_, CLEAR_MODE = @CLEAR_MODE_, BRANCHCODE = @BRANCHCODE_,
				TPACCOUNTNUMBER = @TPACCOUNTNUMBER_, TPFLAG = @TPFLAG_, CLIENTNAME = @CLIENTNAME_,
				MARGINCODENAME = @MARGINCODENAME_, REVAMT = @REVAMT_, REVCODE = @REVCODE_, MICR = @MICR_, DISPLAY_FLAG = @DISPLAY_FLAG_
			WHERE FLDAUTO = @FLDAUTO_
				AND VOUCHERNO = @VNO_
				AND VOUCHERTYPE = @VOUCHERTYPE_
				AND BOOKTYPE = @BOOKTYPE_
				AND EXCHANGE = @EXCHANGE
				AND SEGMENT = @SEGMENT
				AND OPPCODE = @OPPCODE_

			IF LEN(@COSTBRANCHPOSTING_) > 0
				BEGIN
					INSERT INTO V2_OFFLINE_CC_ENTRIES_LOG(FLDAUTO,VOLE_REFNO,SNO,CREDITAMT,DEBITAMT,
						CLTCODE,BRANCHCODE,CATCODE,COSTCODE,ADDBY,STATUSID,STATUSNAME,ADDDT)
					SELECT FLDAUTO,VOLE_REFNO,SNO,CREDITAMT,DEBITAMT,
						CLTCODE,BRANCHCODE,CATCODE,COSTCODE,@ADDBY,@STATUSID,@STATUSNAME,GETDATE()
					FROM V2_OFFLINE_CC_ENTRIES
					WHERE VOLE_REFNO = @FLDAUTO_

					DELETE FROM V2_OFFLINE_CC_ENTRIES WHERE VOLE_REFNO = @FLDAUTO_
					SELECT @CBD_ID = 1--, @CB_LOOPID = 1
					WHILE 1 = 1
						BEGIN
							SET @COST_BRANCH_DATA = .DBO.PIECE(@COSTBRANCHPOSTING_, '~', @CBD_ID)
							IF @COST_BRANCH_DATA IS NULL OR @COST_BRANCH_DATA = ''
								BEGIN
									BREAK
								END
							
									IF @CREDITAMT_ = 0
										BEGIN
											SET @DEBIT_CB = .DBO.PIECE(@COST_BRANCH_DATA, '|', 4)
											SET @CREDIT_CB = 0
										END
									ELSE
										BEGIN
											SET @DEBIT_CB = 0
											SET @CREDIT_CB = .DBO.PIECE(@COST_BRANCH_DATA, '|', 4)
										END

									INSERT INTO V2_OFFLINE_CC_ENTRIES(VOLE_REFNO,SNO,CREDITAMT,DEBITAMT,CLTCODE,BRANCHCODE,
										CATCODE, COSTCODE,ADDBY,STATUSID,STATUSNAME,ADDDT)
									VALUES
									(@FLDAUTO_, @CBD_ID, @CREDIT_CB, @DEBIT_CB, @CLTCODE_, @BRANCHCODE_,
										.DBO.PIECE(@COST_BRANCH_DATA, '|', 2), .DBO.PIECE(@COST_BRANCH_DATA, '|', 3),
										@ADDBY, @STATUSID, @STATUSNAME, GETDATE())


							SET @CBD_ID = @CBD_ID + 1
						END
					
				END
		END

	SET @PROCEED = 0
	SET @MAIN_LOOPID = @MAIN_LOOPID + 1

END

IF @AUTOPOSTING = 1  
 BEGIN
	--PRINT @VNO_ 
	EXEC FA_POSTING @VNO 
 END

SET @RESULT  = 'SAVED'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Validate_Cheque
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Validate_Cheque]
	@BRANCHNAME UDTBRANCHNAME,
	@DDNO UDTINSTNO,
	@BANKNAME UDTBANKNAME,
	@VTYPE UDTVTYPE,
	@CLTCODE UDTPARTYCODE
AS
/*
	 EXEC VALIDATE_CHEQUE 'BANK01', '102030', 'BANK01-ANI', 2, '99555'
	SELECT * FROM V2_OFFLINE_LEDGER_ENTRIES WHERE VDATE LIKE 'MAR 13 2010%'
SELECT * FROM MULTIBANKID WHERE CLTCODE = '100%'
*/
BEGIN
	SET NOCOUNT ON;


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT 
	COUNT(1) 
FROM 
	V2_OFFLINE_LEDGER_ENTRIES (NOLOCK)
WHERE 
	BRANCHNAME = CASE WHEN @BRANCHNAME = '' THEN BRANCHNAME ELSE @BRANCHNAME END
	AND DDNO = CASE WHEN @DDNO  = '' THEN DDNO ELSE @DDNO  END
	--AND MICR = CASE WHEN @MICR  = '' THEN MICR ELSE @MICR  END
	AND BANKNAME = CASE WHEN @VTYPE = '2' OR @VTYPE = '19' THEN 
							CASE WHEN @BANKNAME  = '' THEN BANKNAME ELSE @BANKNAME  END
						ELSE BANKNAME END	
	AND VOUCHERTYPE = CASE WHEN @VTYPE = '' THEN VOUCHERTYPE ELSE @VTYPE END 
	AND CLTCODE = CASE WHEN @CLTCODE = '' THEN CLTCODE ELSE @CLTCODE END  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Validate_Cheque_bak_30102018
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VOUCHER_UPLOAD_SP
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------

CREATE PROC Vw @VwName VARCHAR(25)AS                 
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION_SURESH
-- --------------------------------------------------
 CREATE  PROC YEAREND_VARIFICATION_SURESH 
 @MSG1 VARCHAR(234)='OPENING BALANCE',    
 @PNL_CODE VARCHAR(10) = '999999'     
AS    
  
DECLARE   
@@VNO  VARCHAR(12),  
@@SDTCURNEW VARCHAR(11),      
@@LDTCURNEW VARCHAR(11),  
@@SDTCUROLD VARCHAR(11),      
@@LDTCUROLD VARCHAR(11),  
@@MAXSDT  VARCHAR(11),  
@@BRFLAG INT   
  
--SELECT DISTINCT @@VNO=VNO FROM LEDGER WHERE  VDT like @VDT +'%' AND VTYP=18  
PRINT  @@VNO  
    
SELECT @@SDTCURNEW=SDTCUR,@@LDTCURNEW=LDTCUR FROM PARAMETER WHERE CURYEAR=1   
  
SELECT @@MAXSDT=MAX(SDTCUR) FROM PARAMETER WHERE CURYEAR<>1  
  
SELECT @@VNO=VNO FROM LEDGER WHERE VDT LIKE @@SDTCURNEW +'%' AND VTYP=18  
  
SELECT @@SDTCUROLD=SDTCUR ,@@LDTCUROLD=LDTCUR FROM PARAMETER WHERE SDTCUR LIKE @@MAXSDT +'%'   
  
SELECT @@BRFLAG=BRANCHFLAG FROM PARAMETER WHERE BRANCHFLAG=1  
  
  
PRINT @@SDTCURNEW  
PRINT @@MAXSDT  
PRINT @@VNO  
PRINT @@SDTCUROLD  
  
  
 SELECT 'LEDGER BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
  
IF @@BRFLAG = 1  
PRINT 'VIN'   
BEGIN     
 SELECT 'BRANCHWISE BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L    
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L     
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
END  
    
 SELECT 'PROFIT AND LOSS MISMATCH', 0    
 UNION ALL    
 SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM    
 (    
  SELECT AMOUNT = SUM(AMOUNT) FROM    
  (SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')      
   UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND L.CLTCODE = @PNL_CODE    
  ) L1    
  UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND L.CLTCODE = @PNL_CODE    
 ) L    
  
 SELECT 'LEDGER AND LEDGER2 MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE    
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE    
  WHERE L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
    
 SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0    
 UNION ALL    
 SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
 FROM LEDGER2    
 WHERE VNO = @@VNO AND VTYPE = '18' AND BOOKTYPE = '01'    
 GROUP BY CONVERT(VARCHAR, COSTCODE)    
 HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0    
  
SELECT 'MARGINLEDGER AMOUNT MISMATCH', 0 ,'',0   
UNION ALL  
SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
FROM MARGINLEDGER M, LEDGER L   
WHERE M.MCLTCODE=L.CLTCODE  
AND AMOUNT<>VAMT  
AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
GROUP BY MCLTCODE,CLTCODE  
  
   
SELECT 'MISMATCH BETWEEN MARGINLEDGER AND LEDGER AMOUNT', 0   
UNION ALL  
 SELECT CLTCODE, SUM(AMOUNT) FROM  (  
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
 GROUP BY MCLTCODE,CLTCODE  
UNION ALL   
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VTYP='18' AND M.VNO LIKE @@VNO + '%'  
 GROUP BY MCLTCODE,CLTCODE  
 )M  
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0

GO

-- --------------------------------------------------
-- TABLE dbo.acc_ledger_03013n
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_ledger_03013n]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_ledger_03014n
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_ledger_03014n]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_ledger_12052010
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_ledger_12052010]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_LEDGER_15062017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_LEDGER_15062017]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_LEDGER_20092013
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_LEDGER_20092013]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_LEDGER_27052016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_LEDGER_27052016]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_LEDGER_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_LEDGER_28122015]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_ledger_29122016
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_ledger_29122016]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_LEDGER_PL_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_LEDGER_PL_TBL]
(
    [ENTITY] VARCHAR(31) NULL,
    [DRAMT] MONEY NULL,
    [CRAMT] MONEY NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [FDATE] VARCHAR(11) NULL,
    [TDATE] VARCHAR(11) NULL,
    [SELECTON] VARCHAR(3) NULL,
    [SORTON] VARCHAR(3) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl_26042010
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl_26042010]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_01032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_01032018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_01042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_01042017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_01092018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_01092018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_04032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_04032018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl1_060918
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl1_060918]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_07072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_07072017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl1_07092015
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl1_07092015]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_09092010
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_09092010]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_09092017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_09092017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_10082018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_10082018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_11042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_11042017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl1_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl1_13Nov18]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_14032014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_14032014]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_14072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_14072017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_15062017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_15062017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_16092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_16092016]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl1_17072018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl1_17072018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_18092012
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_18092012]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_19092013
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_19092013]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl1_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl1_20012018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_20072018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_20072018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_20092013
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_20092013]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_201500000114
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_201500000114]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_201500000817
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_201500000817]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_201600000442
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_201600000442]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_22032017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_22032017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_22102018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_22102018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_23052012
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_23052012]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_24022018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_24022018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_24092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_24092016]
(
    [SNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_26022018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_26022018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_27052016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_27052016]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_27062018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_27062018]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_28122015]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_BAK]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_BAK_15062016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_BAK_15062016]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_CONTRA
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_CONTRA]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_D30163
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_D30163]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_M119214
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_M119214]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL1_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL1_TRIG]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_01042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_01042017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_01092018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_01092018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_01092018_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_01092018_BAK]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_04032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_04032018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl2_060918
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl2_060918]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_07072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_07072017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl2_07092015
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl2_07092015]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_09092010
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_09092010]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_09092017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_09092017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_10082018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_10082018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_11042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_11042017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl2_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl2_13Nov18]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_14032014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_14032014]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_14072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_14072017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_15062017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_15062017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_16092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_16092016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl2_17072018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl2_17072018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_18092012
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_18092012]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_19092013
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_19092013]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl2_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl2_20012018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_20072018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_20072018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_20092013
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_20092013]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_201500000114
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_201500000114]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_201500000817
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_201500000817]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_201600000442
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_201600000442]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_22032017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_22032017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_22102018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_22102018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_23052012
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_23052012]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_23062017_02014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_23062017_02014]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acc_Tbl2_23Jul2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Acc_Tbl2_23Jul2018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_24092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_24092016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_27052016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_27052016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_27062018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_27062018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_28122015]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_BAK]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_BAK_15062016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_BAK_15062016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_CONTRA
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_CONTRA]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_D30163
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_D30163]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL2_M119214
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL2_M119214]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_01042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_01042017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_04032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_04032018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl3_060918
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl3_060918]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_07072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_07072017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_09092017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_09092017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl3_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl3_13Nov18]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_14072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_14072017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_15062017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_15062017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_16092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_16092016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl3_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl3_20012018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_22032017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_22032017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_22102018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_22102018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_23052012
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_23052012]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(15) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_23062017_02014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_23062017_02014]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_24092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_24092016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_27062018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_27062018]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_28122015]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_BAK]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_BKP
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_BKP]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_D30163
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_D30163]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_M119214
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_M119214]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL3_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL3_TRIG]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_01032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_01032018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_04032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_04032018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_05032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_05032018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl4_060918
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl4_060918]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_07072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_07072017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_09092010
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_09092010]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(15) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_09092017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_09092017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_11042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_11042017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl4_13Nov18
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl4_13Nov18]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_14032014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_14032014]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_14072017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_14072017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_15062017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_15062017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_16092016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_16092016]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_16June2018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_16June2018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl4_17072018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl4_17072018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl4_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl4_20012018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_20072018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_20072018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_201500000817
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_201500000817]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_201600000442
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_201600000442]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_22022018_RECO
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_22022018_RECO]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_22032017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_22032017]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_22102018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_22102018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_23012018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_23012018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_23062017_02014
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_23062017_02014]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_24022018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_24022018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_27022018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_27022018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_27052016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_27052016]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_27062018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_27062018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_28022018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_28022018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acc_tbl4_29Oct18
-- --------------------------------------------------
CREATE TABLE [dbo].[Acc_tbl4_29Oct18]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_30Jun2018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_30Jun2018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_80032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_80032018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_BKUP_16June2018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_BKUP_16June2018]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_CONTRA
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_CONTRA]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL4_M119214
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL4_M119214]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(30) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL5
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL5]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [PARTYCODE] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [COSTCODE] VARCHAR(20) NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL5_04032018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL5_04032018]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [PARTYCODE] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [COSTCODE] VARCHAR(20) NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acc_tbl5_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acc_tbl5_20012018]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [PARTYCODE] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [COSTCODE] VARCHAR(20) NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACC_TBL5_201500000817
-- --------------------------------------------------
CREATE TABLE [dbo].[ACC_TBL5_201500000817]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [PARTYCODE] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [COSTCODE] VARCHAR(20) NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Acmast]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_03102016
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_03102016]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_08092017
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_08092017]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_13092013
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_13092013]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_14082015
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_14082015]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_16052017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_16052017]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_20012018]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_23102018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_23102018]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_28042017
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_28042017]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_31072018
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_31072018]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_D56643
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_D56643]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_DELL4097
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_DELL4097]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_DETAILS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [EXCHANGE] VARCHAR(500) NULL,
    [SEGMENT] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_M112038
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_M112038]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_r86384
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_r86384]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_S189064
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_S189064]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ACMAST_S199874
-- --------------------------------------------------
CREATE TABLE [dbo].[ACMAST_S199874]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AKSHAY
-- --------------------------------------------------
CREATE TABLE [dbo].[AKSHAY]
(
    [MASTERSNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARC_ACC_TBL1
-- --------------------------------------------------
CREATE TABLE [dbo].[ARC_ACC_TBL1]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARC_ACC_TBL2
-- --------------------------------------------------
CREATE TABLE [dbo].[ARC_ACC_TBL2]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARC_ACC_TBL3
-- --------------------------------------------------
CREATE TABLE [dbo].[ARC_ACC_TBL3]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARC_ACC_TBL4
-- --------------------------------------------------
CREATE TABLE [dbo].[ARC_ACC_TBL4]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(15) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] INT NULL,
    [CR_MICRNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARC_ACC_TBL5
-- --------------------------------------------------
CREATE TABLE [dbo].[ARC_ACC_TBL5]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [PARTYCODE] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [COSTCODE] VARCHAR(20) NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ARCHIVAL_HISTORY
-- --------------------------------------------------
CREATE TABLE [dbo].[ARCHIVAL_HISTORY]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FINYEAR_ID] INT NULL,
    [DATEFROM] DATETIME NULL,
    [DATETO] DATETIME NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TRANSFERREDON] DATETIME NULL,
    [TRANSFERREDBY] VARCHAR(25) NULL,
    [ACTIVESTATUS] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTOJV_MFSS_GLACCOUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTOJV_MFSS_GLACCOUNT]
(
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [SR_SEGMENT] VARCHAR(10) NULL,
    [GL_ACCOUNT] VARCHAR(10) NULL,
    [EQ_GL_ACCOUNT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_LEDGER_22072010
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_LEDGER_22072010]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_ledger_23072010
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_ledger_23072010]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(15) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_LEDGER1617098mf
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_LEDGER1617098mf]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_LEDGER201600000496
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_LEDGER201600000496]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_LEDGERmar102017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_LEDGERmar102017]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [MASTERSNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [EDT_C] VARCHAR(10) NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [CURRENCY] VARCHAR(3) NULL,
    [BNKNAME] VARCHAR(35) NOT NULL,
    [BRNNAME] VARCHAR(20) NOT NULL,
    [CHQDD] VARCHAR(1) NOT NULL,
    [INSTNO] VARCHAR(30) NOT NULL,
    [INSTDATE] DATETIME NOT NULL,
    [INSTDATE_C] VARCHAR(10) NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELDT_C] VARCHAR(10) NULL,
    [CR_RELDT_C] VARCHAR(10) NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [DR_MICRNO] BIGINT NULL,
    [CR_MICRNO] BIGINT NULL,
    [RECEIPTNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL120930
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL120930]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL124062
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL124062]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl1dec132016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl1dec132016]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL1mar102017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL1mar102017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl1mar292017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl1mar292017]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl1mar2920171
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl1mar2920171]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL1nov302016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL1nov302016]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [SNO] BIGINT NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL220930
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL220930]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL224062
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL224062]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL225783
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL225783]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL2dec132016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL2dec132016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL2mar102017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL2mar102017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl2mar292017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl2mar292017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl2nov182016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl2nov182016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl2nov302016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl2nov302016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL320930
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL320930]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_ACC_TBL324062
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_ACC_TBL324062]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL325783
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL325783]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL3dec132016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL3dec132016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ACC_TBL3mar102017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ACC_TBL3mar102017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl3mar292017
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl3mar292017]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_acc_tbl3nov142016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_acc_tbl3nov142016]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_acc_tbl3SEP82015
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_acc_tbl3SEP82015]
(
    [MASTERSNO] BIGINT NOT NULL,
    [EDT] DATETIME NOT NULL,
    [DRAMOUNT] MONEY NOT NULL,
    [CRAMOUNT] MONEY NOT NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [BALAMT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [OPP_BANK] VARCHAR(20) NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CURRENCY] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SNO
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SNO]
(
    [SNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_userrights_250418
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_userrights_250418]
(
    [CATEGORY] NCHAR(10) NULL,
    [USERID] VARCHAR(25) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [START_DATE] NUMERIC(8, 0) NOT NULL,
    [END_DATE] NUMERIC(8, 0) NOT NULL,
    [ADD_DAYS] INT NULL,
    [EDIT_DAYS] INT NULL,
    [DELETE_DAYS] INT NULL,
    [MKCKFLAG] TINYINT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIES216000012449
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIES216000012449]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIES216000012450
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIES216000012450]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIES216000012451
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIES216000012451]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIES216000012452
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIES216000012452]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIES216000013733
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIES216000013733]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_v2_offline_ledger_entriesdec62016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_v2_offline_ledger_entriesdec62016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIESnov182016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIESnov182016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIESnov302016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIESnov302016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_V2_OFFLINE_LEDGER_ENTRIESoct202016
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_V2_OFFLINE_LEDGER_ENTRIESoct202016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKBOOK_RECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKBOOK_RECO_LOG]
(
    [BNKNAME] VARCHAR(35) NULL,
    [BRNNAME] VARCHAR(20) NULL,
    [CHQDD] VARCHAR(1) NULL,
    [INSTNO] VARCHAR(50) NULL,
    [INSTDATE] DATETIME NULL,
    [DR_RELDT] DATETIME NULL,
    [CR_RELDT] DATETIME NULL,
    [DR_RELAMT] MONEY NULL,
    [CR_RELAMT] MONEY NULL,
    [DR_REFNO] VARCHAR(12) NULL,
    [CR_REFNO] VARCHAR(12) NULL,
    [RECEIPTNO] INT NULL,
    [DR_MICRNO] INT NULL,
    [CR_MICRNO] INT NULL,
    [SLIP_NO] INT NULL,
    [SLIP_DATE] DATETIME NULL,
    [CHQINNAME] VARCHAR(100) NULL,
    [CHQPRINTED] BIT NULL,
    [CLEARMODE] CHAR(1) NULL,
    [MASTERSNO] BIGINT NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [SNO] BIGINT NOT NULL,
    [UPDATED_BY] VARCHAR(50) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKLOCAT
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKLOCAT]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_04007_20180813
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_04007_20180813]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bankreco_10Oct18
-- --------------------------------------------------
CREATE TABLE [dbo].[bankreco_10Oct18]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankReco_14092018
-- --------------------------------------------------
CREATE TABLE [dbo].[BankReco_14092018]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bankreco_20012018
-- --------------------------------------------------
CREATE TABLE [dbo].[bankreco_20012018]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_30Jun2018
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_30Jun2018]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_LOG]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT NOT NULL,
    [CMS_SRNO] BIGINT NULL,
    [BAK_REFNO] INT NULL,
    [FUTURE_RELDT] DATETIME NULL,
    [RESERVED1] VARCHAR(20) NULL,
    [RESERVED2] VARCHAR(20) NULL,
    [RESERVED3] VARCHAR(20) NULL,
    [RESERVED4] VARCHAR(20) NULL,
    [RESERVED5] VARCHAR(20) NULL,
    [UPDATED_BY] VARCHAR(50) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankReco_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[BankReco_TRG]
(
    [Cltcode] VARCHAR(10) NULL,
    [BookDate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [DrCr] VARCHAR(1) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] VARCHAR(30) NULL,
    [StatusId] VARCHAR(15) NULL,
    [StatusName] VARCHAR(25) NULL,
    [LoginName] VARCHAR(25) NULL,
    [CrossReferenceNo] VARCHAR(20) NULL,
    [Status] VARCHAR(9) NULL,
    [MicrNo] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NULL,
    [CMS_SrNo] BIGINT NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(30) NULL,
    [APPLICATION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BBO_FA_ROUTE
-- --------------------------------------------------
CREATE TABLE [dbo].[BBO_FA_ROUTE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PAGECODE] VARCHAR(25) NULL,
    [PAGEPATH] VARCHAR(500) NULL,
    [PAGEDESCRIPTION] VARCHAR(150) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(1) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BOOKTYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[BOOKTYPE]
(
    [Vtyp] SMALLINT NOT NULL,
    [Booktype] VARCHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BOOKTYPE_18022010
-- --------------------------------------------------
CREATE TABLE [dbo].[BOOKTYPE_18022010]
(
    [Vtyp] SMALLINT NOT NULL,
    [Booktype] VARCHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CAL_DATES
-- --------------------------------------------------
CREATE TABLE [dbo].[CAL_DATES]
(
    [CAL_DATES] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CATEGORY
-- --------------------------------------------------
CREATE TABLE [dbo].[CATEGORY]
(
    [Category] CHAR(35) NOT NULL,
    [Catcode] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CATMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[CATMAST]
(
    [Accat] VARCHAR(10) NOT NULL,
    [Catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHEQUEFORMATS
-- --------------------------------------------------
CREATE TABLE [dbo].[CHEQUEFORMATS]
(
    [Bankstyle] VARCHAR(50) NOT NULL,
    [Formatcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_BANKRECO_LOG]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT NOT NULL,
    [CMS_SRNO] BIGINT NULL DEFAULT ((0)),
    [UPDATED_BY] VARCHAR(25) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL,
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(150) NULL,
    [Brnname] VARCHAR(150) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(160) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL,
    [Reset_EDT] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMPANY_MASTER_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[COMPANY_MASTER_SETTING]
(
    [COMPANYNAME] VARCHAR(100) NULL,
    [SEGMENT_DESCRIPTION] VARCHAR(100) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [SHAREDB] VARCHAR(20) NULL,
    [SHARESERVER] VARCHAR(15) NULL,
    [ACCOUNTDB] VARCHAR(20) NULL,
    [ACCOUNTSERVER] VARCHAR(15) NULL,
    [GROUPID] VARCHAR(10) NULL,
    [DEFAULTSEGMENT] BIT NULL,
    [ORDER_SEGMENT] INT NULL,
    [DISPLAY_EXCHANGE] VARCHAR(25) NULL,
    [DISPLAY_SEGMENT] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COSTMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[COSTMAST]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CREDITORS
-- --------------------------------------------------
CREATE TABLE [dbo].[CREDITORS]
(
    [CLTCODE] NVARCHAR(10) NOT NULL,
    [L_ADDRESS1] NVARCHAR(40) NULL,
    [L_ADDRESS2] NVARCHAR(40) NULL,
    [L_ADDRESS3] NVARCHAR(40) NULL,
    [L_CITY] NVARCHAR(20) NULL,
    [L_STATE] NVARCHAR(15) NULL,
    [L_NATION] NVARCHAR(15) NULL,
    [L_ZIP] NVARCHAR(10) NULL,
    [FAX] NVARCHAR(15) NULL,
    [OFF_PHONE1] NVARCHAR(15) NULL,
    [OFF_PHONE2] NVARCHAR(15) NULL,
    [EMAIL] NVARCHAR(50) NULL,
    [MOBILE_PAGER] NVARCHAR(40) NULL,
    [REGSUPPLIER] TINYINT NULL,
    [CSTNO] NVARCHAR(40) NULL,
    [SSTNO] NVARCHAR(40) NULL,
    [OMSFLAG] TINYINT NULL,
    [CRLIMIT] MONEY NULL,
    [CRDAYS] TINYINT NULL,
    [PAN_NO] VARCHAR(50) NULL,
    [SERVICETAX_NO] VARCHAR(50) NULL,
    [TDS_NO] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CURRENCY_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CURRENCY_MASTER]
(
    [CURRENCY_CD] VARCHAR(3) NOT NULL,
    [CURRENCY_DESC] VARCHAR(30) NULL,
    [DEF_FALG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXISTS_RECORDS
-- --------------------------------------------------
CREATE TABLE [dbo].[EXISTS_RECORDS]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [RECORDSTATUS] BIT NULL,
    [UPLOADID] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FA_JOB_HISTORY
-- --------------------------------------------------
CREATE TABLE [dbo].[FA_JOB_HISTORY]
(
    [HISTORY_DATE] DATETIME NULL,
    [STATUS] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_DATA]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [PROGID] VARCHAR(16) NULL,
    [FILEDATA] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_FORMAT
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_FORMAT]
(
    [SRNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [MAINCODE] VARCHAR(10) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [L1_SRNO] INT NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(30) NULL,
    [BRANCHNAME] VARCHAR(50) NULL,
    [CHQMODE] VARCHAR(10) NULL,
    [CHQDATE] DATETIME NULL,
    [CLMODE] VARCHAR(10) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [ACCCODE] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GRPMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[GRPMAST]
(
    [Grpname] VARCHAR(50) NULL,
    [Grpmain] VARCHAR(13) NULL,
    [Grpcode] VARCHAR(13) NULL,
    [Vtyp] FLOAT NULL,
    [Dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INPROCSNO
-- --------------------------------------------------
CREATE TABLE [dbo].[INPROCSNO]
(
    [ISGENERATE] BIT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INPROCVNO
-- --------------------------------------------------
CREATE TABLE [dbo].[INPROCVNO]
(
    [ISGENERATE] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LASTCHEQUENO
-- --------------------------------------------------
CREATE TABLE [dbo].[LASTCHEQUENO]
(
    [Bankcode] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Ddno] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LASTSNO
-- --------------------------------------------------
CREATE TABLE [dbo].[LASTSNO]
(
    [LASTSNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LASTVNO
-- --------------------------------------------------
CREATE TABLE [dbo].[LASTVNO]
(
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VDT] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNOFLAG] TINYINT NOT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_TRG]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1BANKRECO_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1BANKRECO_TRIG]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERMASTER_YAP
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERMASTER_YAP]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VDT] NUMERIC(8, 0) NOT NULL,
    [FINYEAR_ID] INT NOT NULL,
    [MKCKFLAG] TINYINT NULL,
    [VNO_MK] VARCHAR(12) NULL,
    [REMARK] VARCHAR(234) NULL,
    [REFSNO] BIGINT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_ON] DATETIME NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_AMT] MONEY NOT NULL,
    [SOURCE_MODULE] VARCHAR(100) NOT NULL,
    [ENTRY_TYPE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] TINYINT NULL,
    [LOCK_FLAG] BIT NOT NULL,
    [DISPLAY_FLAG] BIT NOT NULL,
    [RESERVED_1] VARCHAR(20) NULL,
    [RESERVED_2] VARCHAR(20) NULL,
    [RESERVED_3] VARCHAR(20) NULL,
    [RESERVED_4] VARCHAR(20) NULL,
    [RESERVED_5] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MASTERSNOS_2401
-- --------------------------------------------------
CREATE TABLE [dbo].[MASTERSNOS_2401]
(
    [MASTERSNO] BIGINT NULL,
    [AMT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_JVEXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_JVEXCEPTION]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFSS_TRF_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[MFSS_TRF_ENTRIES]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLIENT_NAME] VARCHAR(100) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [AMOUNT] MONEY NULL,
    [SR_SEGMENT] VARCHAR(10) NULL,
    [GL_ACCOUNT] VARCHAR(10) NULL,
    [EQ_GL_ACCOUNT] VARCHAR(10) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [TRANSFER_DATE] DATETIME NULL,
    [FLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIBANKID
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIBANKID]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(16) NOT NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL,
    [exchange] VARCHAR(3) NULL,
    [segment] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid_Other
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid_Other]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(16) NOT NULL,
    [Accno] VARCHAR(21) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICOMPANY]
(
    [BrokerId] VARCHAR(6) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Segment_Description] VARCHAR(50) NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [MemberType] VARCHAR(3) NOT NULL,
    [MemberCode] VARCHAR(15) NOT NULL,
    [ShareDb] VARCHAR(20) NOT NULL,
    [ShareServer] VARCHAR(15) NOT NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NOT NULL,
    [AccountServer] VARCHAR(15) NOT NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NOT NULL,
    [DefaultDbServer] VARCHAR(15) NOT NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [primaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [License] VARCHAR(500) NOT NULL,
    [AppShare_RootFldr_Name] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany_23042010
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany_23042010]
(
    [BrokerId] VARCHAR(6) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Segment_Description] VARCHAR(50) NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [MemberType] VARCHAR(3) NOT NULL,
    [MemberCode] VARCHAR(15) NOT NULL,
    [ShareDb] VARCHAR(20) NOT NULL,
    [ShareServer] VARCHAR(15) NOT NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NOT NULL,
    [AccountServer] VARCHAR(15) NOT NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NOT NULL,
    [DefaultDbServer] VARCHAR(15) NOT NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [primaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [License] VARCHAR(500) NOT NULL,
    [AppShare_RootFldr_Name] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OACMAST_V72507
-- --------------------------------------------------
CREATE TABLE [dbo].[OACMAST_V72507]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFLINE_UPLOAD_LOG_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFLINE_UPLOAD_LOG_NEW]
(
    [OUL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [OUL_FLDAUTO] INT NULL,
    [OUL_EXCHANGE] VARCHAR(3) NULL,
    [OUL_SEGMENT] VARCHAR(10) NULL,
    [OUL_VOUCHERTYPE] SMALLINT NULL,
    [OUL_ERRORCODE] INT NULL,
    [OUL_ERRORMSG] VARCHAR(255) NULL,
    [OUL_UPDATEBY] VARCHAR(25) NULL,
    [OUL_UPDATEDT] DATETIME NULL,
    [IP_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFLINE_VOUCHER_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFLINE_VOUCHER_SETTING]
(
    [MULTIPLECODE] INT NULL,
    [ACCNOFLAG] INT NULL,
    [OPFLAG] INT NULL,
    [AUTOPOSTING] BIT NULL DEFAULT ((1))
);

GO

-- --------------------------------------------------
-- TABLE dbo.oldnew
-- --------------------------------------------------
CREATE TABLE [dbo].[oldnew]
(
    [cltcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OWNER
-- --------------------------------------------------
CREATE TABLE [dbo].[OWNER]
(
    [Companyname] VARCHAR(80) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(12) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NOT NULL,
    [MULTI_MARGIN] CHAR(1) NULL,
    [ActiveDays] INT NULL,
    [MULTISEGMENT_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[Parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PARAMETER_31032010
-- --------------------------------------------------
CREATE TABLE [dbo].[PARAMETER_31032010]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter_31032011
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter_31032011]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT IDENTITY(1,1) NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PN81
-- --------------------------------------------------
CREATE TABLE [dbo].[PN81]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NOT NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(12) NULL,
    [Branchcode] VARCHAR(35) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_DELETION_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL,
    [ROWTYPE] NVARCHAR(25) NULL,
    [DRCR] NVARCHAR(5) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [AMOUNT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(100) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MATCHEDFLAG] BIT NOT NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(300) NULL,
    [LEDGERBALANCE] NVARCHAR(100) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(100) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(150) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [PERFORMDATE] DATETIME NULL,
    [ERROR1] NVARCHAR(MAX) NULL,
    [ERROR2] NVARCHAR(MAX) NULL,
    [ERROR3] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_FILEUPLOAD_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NOT NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NOT NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_CMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_CMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [RowType] NVARCHAR(50) NULL,
    [Valuedate] DATETIME NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Inst_no_Check] NVARCHAR(50) NULL,
    [Inst_Amt] DECIMAL(20, 2) NULL,
    [Drawer_Name] NVARCHAR(250) NULL,
    [CltCode] NVARCHAR(50) NULL,
    [CltAccNo] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_ENCRYPTION_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_ENCRYPTION_DETAILS]
(
    [ENCRY_SRNO] INT IDENTITY(1,1) NOT NULL,
    [ENCRY_NUMBER] NVARCHAR(50) NULL,
    [REFERENCESNUMBER] NVARCHAR(50) NULL,
    [INCRYPTIONDATE] DATETIME NULL,
    [ENCRY_DESCRIPTION] NVARCHAR(200) NULL,
    [ENCRY_AMOUNT] MONEY NULL,
    [ENCRY_STATUS] NVARCHAR(25) NULL,
    [ENCRY_CHEQUENUMBER] NVARCHAR(25) NULL,
    [UPLOADDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [MATCH_STATUS] INT NULL,
    [UPLOADTYPE] NVARCHAR(20) NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [SEGMENT] NVARCHAR(100) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [BANKCODE] NVARCHAR(100) NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [FILETYPE] NVARCHAR(100) NULL,
    [CROSS_NO] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_EXCLUDE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_EXCLUDE_MASTER]
(
    [EXCLUDEMASTERID] INT IDENTITY(1,1) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(100) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [FILEFORMATE] NVARCHAR(10) NULL,
    [EXCLUDEDATA] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_LOGS]
(
    [LOGID] INT IDENTITY(1,1) NOT NULL,
    [SERVERNAME] NVARCHAR(100) NULL,
    [DATABASENAME] NVARCHAR(100) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [LOGDATE] DATETIME NULL,
    [ERRORLOGS] NVARCHAR(250) NULL,
    [SOURCENAME] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_NONCMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_NONCMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [Description] NVARCHAR(150) NULL,
    [LedgerBalance] NVARCHAR(50) NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Amt] DECIMAL(20, 2) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CustomerReference] NVARCHAR(50) NULL,
    [TransaCtionDetail] NVARCHAR(800) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_REPORT_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_REPORT_STATUS]
(
    [MATCHCODE] INT NOT NULL,
    [FILETYPE] NVARCHAR(50) NULL,
    [MATCHEDBY] NVARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [ORGBRANCH] VARCHAR(10) NULL,
    [LNO] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table_Tmp]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RP61
-- --------------------------------------------------
CREATE TABLE [dbo].[RP61]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(15) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BAK_VNO
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BAK_VNO]
(
    [VNO] VARCHAR(12) NOT NULL,
    [VTYPE] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_CMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_CMS_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [ROWTYPE] NVARCHAR(50) NULL,
    [VALUEDATE] DATETIME NULL,
    [DRCR] NVARCHAR(50) NULL,
    [INST_NO_CHECK] NVARCHAR(50) NULL,
    [INST_AMT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(250) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(20) NULL,
    [VTYP] NVARCHAR(20) NULL,
    [BOOKTYPE] NVARCHAR(20) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] NVARCHAR(50) NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_NONCMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_NONCMS_DATA]
(
    [SRNONCMS] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(150) NULL,
    [LEDGERBALANCE] NVARCHAR(50) NULL,
    [DRCR] NVARCHAR(50) NULL,
    [AMT] DECIMAL(20, 2) NULL,
    [VALUEDATE] NVARCHAR(50) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(150) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(200) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMPOP
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMPOP]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [SEGMENT] VARCHAR(20) NOT NULL,
    [VNO] VARCHAR(1) NOT NULL,
    [VTYPE] INT NOT NULL,
    [BOOKTYPE] VARCHAR(2) NOT NULL,
    [VDT] DATETIME NULL,
    [VDT_C] VARCHAR(10) NOT NULL,
    [STDCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MKCKFLAG] INT NOT NULL,
    [VNO_MK] VARCHAR(1) NOT NULL,
    [MASTERSNO] INT NOT NULL,
    [REMARK] VARCHAR(1) NOT NULL,
    [REFSNO] INT NOT NULL,
    [POSTED_ON] DATETIME NOT NULL,
    [POSTED_BY] VARCHAR(6) NOT NULL,
    [CHECKED_BY] DATETIME NOT NULL,
    [ENTRY_AMT] INT NOT NULL,
    [SOURCE_MODULE] VARCHAR(6) NOT NULL,
    [ENTRY_TYPE] VARCHAR(1) NOT NULL,
    [SETT_NO] VARCHAR(1) NOT NULL,
    [SETT_TYPE] VARCHAR(1) NOT NULL,
    [BILL_NO] INT NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [LOCK_FLAG] INT NOT NULL,
    [DISPLAY_FLAG] INT NOT NULL,
    [EDT] DATETIME NULL,
    [EDT_C] VARCHAR(10) NOT NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(15) NOT NULL,
    [BALAMT] INT NOT NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(1) NOT NULL,
    [CURRENCY] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMPUSERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TMPUSERRIGHTS]
(
    [CATEGORY] NCHAR(10) NULL,
    [USERID] VARCHAR(25) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [START_DATE] NUMERIC(8, 0) NOT NULL,
    [END_DATE] NUMERIC(8, 0) NOT NULL,
    [ADD_DAYS] INT NULL,
    [EDIT_DAYS] INT NULL,
    [DELETE_DAYS] INT NULL,
    [MKCKFLAG] TINYINT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [CATEGORY] NCHAR(10) NULL,
    [USERID] VARCHAR(25) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [START_DATE] NUMERIC(8, 0) NOT NULL,
    [END_DATE] NUMERIC(8, 0) NOT NULL,
    [ADD_DAYS] INT NULL,
    [EDIT_DAYS] INT NULL,
    [DELETE_DAYS] INT NULL,
    [MKCKFLAG] TINYINT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS_16022011
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS_16022011]
(
    [CATEGORY] NCHAR(10) NULL,
    [USERID] VARCHAR(25) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [START_DATE] NUMERIC(8, 0) NOT NULL,
    [END_DATE] NUMERIC(8, 0) NOT NULL,
    [ADD_DAYS] INT NULL,
    [EDIT_DAYS] INT NULL,
    [DELETE_DAYS] INT NULL,
    [MKCKFLAG] TINYINT NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERWRITESTABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[USERWRITESTABLE]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_ChqPrint_Format
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_ChqPrint_Format]
(
    [CHQ_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CHQ_BANKNAME] VARCHAR(50) NULL,
    [CHQ_BANKFORMAT] INT NOT NULL,
    [CHQ_EXCHANGE] VARCHAR(3) NULL,
    [CHQ_SEGMENT] VARCHAR(20) NULL,
    [CHQ_INSTNO] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CHQPRINT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CHQPRINT_SETTING]
(
    [CHQ_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CHQ_CODE] VARCHAR(30) NULL,
    [CHQ_DESC] VARCHAR(500) NULL,
    [CHQ_XPOS] DECIMAL(10, 0) NULL,
    [CHQ_YPOS] DECIMAL(18, 0) NULL,
    [CHQ_WIDTH] DECIMAL(10, 0) NULL,
    [CHQ_ALIGN] CHAR(1) NULL,
    [CHQ_PRINTFLAG] SMALLINT NULL,
    [CHQ_ROUNDING] TINYINT NULL,
    [CHQ_TYPE] VARCHAR(10) NOT NULL,
    [CHQ_PRINTFORMAT] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_CC_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_CC_ENTRIES]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [VOLE_REFNO] BIGINT NOT NULL,
    [SNO] INT NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CATCODE] VARCHAR(35) NULL,
    [COSTCODE] VARCHAR(35) NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_CC_ENTRIES_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_CC_ENTRIES_LOG]
(
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NOT NULL,
    [VOLE_REFNO] BIGINT NOT NULL,
    [SNO] INT NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CATCODE] VARCHAR(35) NULL,
    [COSTCODE] VARCHAR(35) NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_01092015
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_01092015]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_07062016
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_07062016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_10052016
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_10052016]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_offline_ledger_entries_15112017
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_offline_ledger_entries_15112017]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_23052012
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_23052012]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(15) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_27042018
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_27042018]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_offline_ledger_entries_api
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_offline_ledger_entries_api]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_bak_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_bak_28122015]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_BKP2109
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_BKP2109]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(21) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_JRNL
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_JRNL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] INT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(35) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(16) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(10) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NOT NULL DEFAULT ((1)),
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL,
    [ACTION] VARCHAR(12) NULL,
    [MODIFIEDBY] VARCHAR(25) NULL,
    [MODIFIEDDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_LEDGER_ENTRIES_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_LEDGER_ENTRIES_LOG]
(
    [FLDAUTO] INT NOT NULL,
    [VOUCHERTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [OPPCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(30) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(50) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [TPFLAG] TINYINT NULL,
    [ADDDT] DATETIME NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ROWSTATE] TINYINT NULL,
    [APPROVALFLAG] TINYINT NULL,
    [APPROVALDATE] DATETIME NULL,
    [APPROVEDBY] VARCHAR(25) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [UPLOADDT] DATETIME NULL,
    [LEDGERVNO] VARCHAR(12) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PRODUCTTYPE] VARCHAR(3) NULL,
    [REVAMT] MONEY NULL,
    [REVCODE] VARCHAR(10) NULL,
    [MICR] VARCHAR(12) NULL,
    [REL_DATE] DATETIME NULL,
    [DISPLAY_FLAG] BIT NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL,
    [RESERVED6] VARCHAR(10) NULL,
    [RESERVED7] VARCHAR(10) NULL,
    [RESERVED8] VARCHAR(10) NULL,
    [RESERVED9] VARCHAR(10) NULL,
    [RESERVED10] VARCHAR(10) NULL,
    [EDITED_BY] VARCHAR(25) NULL,
    [EDITED_ON] DATETIME NULL,
    [ACTION_FLAG] CHAR(1) NULL,
    [IP_ADD] VARCHAR(20) NULL,
    [RECORD_STATE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Uploaded_Files
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Uploaded_Files]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vnodata
-- --------------------------------------------------
CREATE TABLE [dbo].[vnodata]
(
    [VDT] DATETIME NULL,
    [SDTCUR] DATETIME NULL,
    [LDTCUR] DATETIME NULL,
    [MASTERSNO] BIGINT NULL,
    [ENTRY_AMT] MONEY NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [EDT] DATETIME NULL,
    [DRAMOUNT] MONEY NULL,
    [CRAMOUNT] MONEY NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(20) NULL,
    [DDNO] VARCHAR(15) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [MICR] VARCHAR(9) NULL,
    [SNO] INT NULL,
    [FLDAUTO] BIGINT NULL,
    [FINYEARID] INT NULL,
    [REVCODE] VARCHAR(21) NULL,
    [POSTED_BY] VARCHAR(50) NULL,
    [CHECKED_BY] VARCHAR(50) NULL,
    [ENTRY_IDF] INT NULL,
    [IDNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [ACCAT] VARCHAR(10) NULL,
    [MAINLEDGER] VARCHAR(20) NULL,
    [MAINLEDGERNAME] VARCHAR(100) NULL,
    [MAINACCAT] SMALLINT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [REFCODE] VARCHAR(10) NULL,
    [ORGBRANCH] VARCHAR(10) NULL,
    [OPPACCOUNT] VARCHAR(20) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [VOUCHERNO] VARCHAR(12) NULL,
    [CHEQUENAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VOUCHER_UPLOAD
-- --------------------------------------------------
CREATE TABLE [dbo].[VOUCHER_UPLOAD]
(
    [SRNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [MAINCODE] VARCHAR(20) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [L1_SRNO] INT NULL,
    [CASHCODE] VARCHAR(20) NULL,
    [BANKCODE] VARCHAR(20) NULL,
    [MARGINCODE] VARCHAR(20) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(30) NULL,
    [BRANCHNAME] VARCHAR(50) NULL,
    [CHQMODE] VARCHAR(10) NULL,
    [CLMODE] VARCHAR(10) NULL,
    [CHQDATE] DATETIME NULL,
    [CHQNAME] VARCHAR(100) NULL,
    [ACCCODE] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [LNO] INT NULL,
    [PROGID] VARCHAR(16) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VOUCHER_UPLOAD_bak_28122015
-- --------------------------------------------------
CREATE TABLE [dbo].[VOUCHER_UPLOAD_bak_28122015]
(
    [SRNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [MAINCODE] VARCHAR(20) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [L1_SRNO] INT NULL,
    [CASHCODE] VARCHAR(20) NULL,
    [BANKCODE] VARCHAR(20) NULL,
    [MARGINCODE] VARCHAR(20) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(30) NULL,
    [BRANCHNAME] VARCHAR(50) NULL,
    [CHQMODE] VARCHAR(10) NULL,
    [CLMODE] VARCHAR(10) NULL,
    [CHQDATE] DATETIME NULL,
    [CHQNAME] VARCHAR(100) NULL,
    [ACCCODE] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [CLIENTNAME] VARCHAR(100) NULL,
    [OPPCODENAME] VARCHAR(100) NULL,
    [MARGINCODENAME] VARCHAR(100) NULL,
    [LNO] INT NULL,
    [PROGID] VARCHAR(16) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACC_TBL3_DEL
-- --------------------------------------------------






CREATE TRIGGER [dbo].[ACC_TBL3_DEL] ON [dbo].[ACC_TBL3] 
FOR DELETE 
AS
INSERT INTO ACC_TBL3_TRIG
SELECT MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY,COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'DELETED'
FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.ACC_TBL3_MOD
-- --------------------------------------------------






CREATE TRIGGER [dbo].[ACC_TBL3_MOD] ON [dbo].[ACC_TBL3] 
FOR UPDATE
AS

INSERT INTO ACC_TBL3_TRIG
SELECT MASTERSNO,EDT,DRAMOUNT,CRAMOUNT,CLTCODE,ACNAME,MAINLEDGER,MAINLEDGERNAME,MAINACCAT,NARRATION,REFSNO,BALAMT,BRANCHCODE,REFCODE,ACCAT,OPP_BANK,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,CURRENCY, COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'MODIFIED'
FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_DEL
-- --------------------------------------------------




CREATE TRIGGER [dbo].[LEDGER_DEL] ON [dbo].[ACC_TBL1] 
FOR DELETE 
AS
INSERT INTO ACC_TBL1_TRIG
SELECT *, COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'DELETED'
FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_MOD
-- --------------------------------------------------




CREATE TRIGGER [dbo].[LEDGER_MOD] ON [dbo].[ACC_TBL1] 
FOR UPDATE
AS

INSERT INTO ACC_TBL1_TRIG
SELECT *, COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'MODIFIED'
FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_CLIENTVIEW
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_COMPATIBLE
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_GL
-- --------------------------------------------------



CREATE	 VIEW [dbo].[ACC_LEDGER_GL]

AS

SELECT

	M.EXCHANGE,

	M.SEGMENT,

	M.VNO,

	M.VTYPE,

	M.BOOKTYPE,

	VDT = CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112),

	VDT_C = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112), 103),

	P.SDTCUR,

	P.LDTCUR,

	M.MKCKFLAG,

	M.VNO_MK,

	MASTERSNO = M.SNO,

	M.REMARK,

	M.REFSNO,

	M.POSTED_ON,

	M.POSTED_BY,

	M.CHECKED_ON,

	M.CHECKED_BY,

	M.ENTRY_AMT,

	M.SOURCE_MODULE,

	M.ENTRY_TYPE,

	M.SETT_NO,

	M.SETT_TYPE,

	M.BILL_NO,

	M.SELL_BUY,

	M.LOCK_FLAG,

	M.DISPLAY_FLAG,

	NODAYS = M.RESERVED_1,

	EDT = T.EDT,

	EDT_C = CONVERT(VARCHAR(10), T.EDT, 103),

	T.DRAMOUNT,

	T.CRAMOUNT,

	T.CLTCODE,

	T.ACNAME,

	T.ACCAT,

	MAINLEDGER = ISNULL(T.MAINLEDGER, T.CLTCODE),

	MAINLEDGERNAME = ISNULL(T.MAINLEDGERNAME, T.ACNAME),

	T.MAINACCAT,

	T.NARRATION,

	T.BALAMT,

	T.BRANCHCODE,

	T.REFCODE,

	OPPACCOUNT = T.OPP_BANK,

	T.CURRENCY,

	BNKNAME = ISNULL(C.BNKNAME, ''),

	BRNNAME = ISNULL(C.BRNNAME, ''),

	CHQDD = ISNULL(C.CHQDD, ''),

	INSTNO = ISNULL(C.INSTNO, ''),

	INSTDATE = ISNULL(C.INSTDATE, ''),

	INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(C.INSTDATE, ''), 103),

	C.DR_RELDT,

	C.CR_RELDT,

	DR_RELDT_C = CONVERT(VARCHAR(10), C.DR_RELDT, 103),

	CR_RELDT_C = CONVERT(VARCHAR(10), C.CR_RELDT, 103),

	C.DR_RELAMT,

	C.CR_RELAMT,

	C.DR_REFNO,

	C.CR_REFNO,

	C.DR_MICRNO,

	C.CR_MICRNO,

	C.RECEIPTNO,

	C.SLIP_NO,

	C.SLIP_DATE,

	C.CHQINNAME,

	C.CHQPRINTED,

	C.CLEARMODE,

	V.VDESC,

	V.SHORTDESC

FROM

	ACC_TBL1 M

	LEFT JOIN

		ACC_TBL4 C ON M.SNO = C.MASTERSNO

	INNER JOIN

		ACC_TBL2 T ON M.SNO = T.MASTERSNO

	INNER JOIN

		VMAST V ON M.VTYPE = V.VTYPE,

	PARAMETER P

WHERE

	M.SNO = T.MASTERSNO

	AND M.FINYEAR_ID = P.FLDAUTO

	AND M.VTYPE <> 5



UNION ALL



SELECT

	M.EXCHANGE,

	M.SEGMENT,

	M.VNO,

	M.VTYPE,

	M.BOOKTYPE,

	VDT = CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112),

	VDT_C = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112), 103),

	P.SDTCUR,

	P.LDTCUR,

	M.MKCKFLAG,

	M.VNO_MK,

	MASTERSNO = M.SNO,

	M.REMARK,

	M.REFSNO,

	M.POSTED_ON,

	M.POSTED_BY,

	M.CHECKED_ON,

	M.CHECKED_BY,

	M.ENTRY_AMT,

	M.SOURCE_MODULE,

	M.ENTRY_TYPE,

	M.SETT_NO,

	M.SETT_TYPE,

	M.BILL_NO,

	M.SELL_BUY,

	M.LOCK_FLAG,

	M.DISPLAY_FLAG,

	NODAYS = M.RESERVED_1,

	EDT = T.EDT,

	EDT_C = CONVERT(VARCHAR(10), T.EDT, 103),

	T.DRAMOUNT,

	T.CRAMOUNT,

	T.CLTCODE,

	T.ACNAME,

	T.ACCAT,

	MAINLEDGER = ISNULL(T.MAINLEDGER, T.CLTCODE),

	MAINLEDGERNAME = ISNULL(T.MAINLEDGERNAME, T.ACNAME),

	T.MAINACCAT,

	T.NARRATION,

	T.BALAMT,

	T.BRANCHCODE,

	T.REFCODE,

	OPPACCOUNT = T.OPP_BANK,

	T.CURRENCY,

	BNKNAME = ISNULL(C.BNKNAME, ''),

	BRNNAME = ISNULL(C.BRNNAME, ''),

	CHQDD = ISNULL(C.CHQDD, ''),

	INSTNO = ISNULL(C.INSTNO, ''),

	INSTDATE = ISNULL(C.INSTDATE, ''),

	INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(C.INSTDATE, ''), 103),

	C.DR_RELDT,

	C.CR_RELDT,

	DR_RELDT_C = CONVERT(VARCHAR(10), C.CR_RELDT, 103),

	CR_RELDT_C = CONVERT(VARCHAR(10), C.DR_RELDT, 103),

	C.CR_RELAMT,

	C.DR_RELAMT,

	C.DR_REFNO,

	C.CR_REFNO,

	C.DR_MICRNO,

	C.CR_MICRNO,

	C.RECEIPTNO,

	C.SLIP_NO,

	C.SLIP_DATE,

	C.CHQINNAME,

	C.CHQPRINTED,

	C.CLEARMODE,

	V.VDESC,

	V.SHORTDESC

FROM

	ACC_TBL1 M

	LEFT JOIN

		ACC_TBL4 C ON M.SNO = C.MASTERSNO

	INNER JOIN

		ACC_TBL2 T ON M.SNO = T.MASTERSNO

	INNER JOIN

		VMAST V ON M.VTYPE = V.VTYPE,

	PARAMETER P

WHERE

	M.SNO = T.MASTERSNO

	AND M.FINYEAR_ID = P.FLDAUTO

	AND M.VTYPE = 5

	AND T.DRAMOUNT = C.CR_RELAMT

	AND T.CRAMOUNT = C.DR_RELAMT

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_GL_ENTRY
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_PL
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_PL_ENTRY
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_suresh
-- --------------------------------------------------
  
CREATE VIEW [dbo].[ACC_LEDGER_SURESH]  
--WITH ENCRYPTION  
AS  
SELECT  
 M.EXCHANGE,  
 M.SEGMENT,  
 M.VNO,  
 M.VTYPE,  
 M.BOOKTYPE,  
 VDT = CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112),  
 VDT_C = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112), 103),  
 P.SDTCUR,  
 P.LDTCUR,  
 M.MKCKFLAG,  
 M.VNO_MK,  
 MASTERSNO = M.SNO,  
 M.REMARK,  
 M.REFSNO,  
 M.POSTED_ON,  
 M.POSTED_BY,  
 M.CHECKED_ON,  
 M.CHECKED_BY,  
 M.ENTRY_AMT,  
 M.SOURCE_MODULE,  
 M.ENTRY_TYPE,  
 M.SETT_NO,  
 M.SETT_TYPE,  
 M.BILL_NO,  
 M.SELL_BUY,  
 M.LOCK_FLAG,  
 M.DISPLAY_FLAG,  
 EDT = T.EDT,  
 EDT_C = CONVERT(VARCHAR(10), T.EDT, 103),  
 T.DRAMOUNT,  
 T.CRAMOUNT,  
 T.CLTCODE,  
 T.ACNAME,  
 T.ACCAT,  
 MAINLEDGER = ISNULL(T.MAINLEDGER, T.CLTCODE),  
 MAINLEDGERNAME = ISNULL(T.MAINLEDGERNAME, T.ACNAME),  
 T.MAINACCAT,  
 T.NARRATION,  
 T.BALAMT,  
 T.BRANCHCODE,  
 T.REFCODE,  
 OPPACCOUNT = T.OPP_BANK,  
 T.CURRENCY,  
 BNKNAME = ISNULL(C.BNKNAME, ''),  
 BRNNAME = ISNULL(C.BRNNAME, ''),  
 CHQDD = ISNULL(C.CHQDD, ''),  
 INSTNO = ISNULL(C.INSTNO, ''),  
 INSTDATE = ISNULL(C.INSTDATE, ''),  
 INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(C.INSTDATE, ''), 103),  
 C.DR_RELDT,  
 C.CR_RELDT,  
 DR_RELDT_C = CONVERT(VARCHAR(10), C.DR_RELDT, 103),  
 CR_RELDT_C = CONVERT(VARCHAR(10), C.CR_RELDT, 103),  
 C.DR_RELAMT,  
 C.CR_RELAMT,  
 C.DR_REFNO,  
 C.CR_REFNO,  
 C.DR_MICRNO,  
 C.CR_MICRNO,  
 C.RECEIPTNO,  
 C.SLIP_NO,  
 C.SLIP_DATE,  
 C.CHQINNAME,  
 C.CHQPRINTED,  
 C.CLEARMODE--,  
 --T.SRNO  
FROM  
 ACC_TBL1 M  
 LEFT JOIN  
  ACC_TBL4 C ON M.SNO = C.MASTERSNO,  
 --.dbo.LEDGER_VIEW() T,  
 (  
  SELECT * FROM ACC_TBL2  
  UNION ALL  
  SELECT * FROM ACC_TBL3  
 ) T,  
 PARAMETER P  
WHERE  
 M.SNO = T.MASTERSNO  
 AND M.FINYEAR_ID = P.FLDAUTO  
 AND M.VTYPE <> 5  
  
UNION ALL  
  
SELECT  
 M.EXCHANGE,  
 M.SEGMENT,  
 M.VNO,  
 M.VTYPE,  
 M.BOOKTYPE,  
 VDT = CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112),  
 VDT_C = CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(VARCHAR(8), M.VDT), 112), 103),  
 P.SDTCUR,  
 P.LDTCUR,  
 M.MKCKFLAG,  
 M.VNO_MK,  
 MASTERSNO = M.SNO,  
 M.REMARK,  
 M.REFSNO,  
 M.POSTED_ON,  
 M.POSTED_BY,  
 M.CHECKED_ON,  
 M.CHECKED_BY,  
 M.ENTRY_AMT,  
 M.SOURCE_MODULE,  
 M.ENTRY_TYPE,  
 M.SETT_NO,  
 M.SETT_TYPE,  
 M.BILL_NO,  
 M.SELL_BUY,  
 M.LOCK_FLAG,  
 M.DISPLAY_FLAG,  
 EDT = T.EDT,  
 EDT_C = CONVERT(VARCHAR(10), T.EDT, 103),  
 T.CRAMOUNT,  
 T.DRAMOUNT,  
 T.CLTCODE,  
 T.ACNAME,  
 T.ACCAT,  
 MAINLEDGER = ISNULL(T.MAINLEDGER, T.CLTCODE),  
 MAINLEDGERNAME = ISNULL(T.MAINLEDGERNAME, T.ACNAME),  
 T.MAINACCAT,  
 T.NARRATION,  
 T.BALAMT,  
 T.BRANCHCODE,  
 T.REFCODE,  
 OPPACCOUNT = T.OPP_BANK,  
 T.CURRENCY,  
 BNKNAME = ISNULL(C.BNKNAME, ''),  
 BRNNAME = ISNULL(C.BRNNAME, ''),  
 CHQDD = ISNULL(C.CHQDD, ''),  
 INSTNO = ISNULL(C.INSTNO, ''),  
 INSTDATE = ISNULL(C.INSTDATE, ''),  
 INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(C.INSTDATE, ''), 103),  
 C.DR_RELDT,  
 C.CR_RELDT,  
 DR_RELDT_C = CONVERT(VARCHAR(10), C.DR_RELDT, 103),  
 CR_RELDT_C = CONVERT(VARCHAR(10), C.CR_RELDT, 103),  
 C.DR_RELAMT,  
 C.CR_RELAMT,  
 C.DR_REFNO,  
 C.CR_REFNO,  
 C.DR_MICRNO,  
 C.CR_MICRNO,  
 C.RECEIPTNO,  
 C.SLIP_NO,  
 C.SLIP_DATE,  
 C.CHQINNAME,  
 C.CHQPRINTED,  
 C.CLEARMODE--,  
 --T.SRNO  
FROM  
 ACC_TBL1 M  
 LEFT JOIN  
  ACC_TBL4 C ON M.SNO = C.MASTERSNO,  
 --.dbo.LEDGER_VIEW() T,  
 (  
  SELECT * FROM ACC_TBL2  
  UNION ALL  
  SELECT * FROM ACC_TBL3  
 ) T,  
 PARAMETER P  
WHERE  
 M.SNO = T.MASTERSNO  
 AND M.FINYEAR_ID = P.FLDAUTO  
 AND M.VTYPE = 5  
 AND T.DRAMOUNT = C.CR_RELAMT  
 AND T.CRAMOUNT = C.DR_RELAMT

GO

-- --------------------------------------------------
-- VIEW dbo.AT_MFSS_LEDGER_BSE
-- --------------------------------------------------
CREATE VIEW AT_MFSS_LEDGER_BSE      
AS      
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO      AND  VTYPE <>'18'
WHERE EXCHANGE='BSE'      
union ALL     
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 ))AS VDT ,EDT  AS EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO      AND  VTYPE <>'18'  
WHERE EXCHANGE='BSE'

GO

-- --------------------------------------------------
-- VIEW dbo.AT_MFSS_LEDGER_NSE
-- --------------------------------------------------

CREATE VIEW AT_MFSS_LEDGER_NSE   

AS    

SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION    
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO   AND VTYPE <>'18' 
WHERE EXCHANGE='NSE'    
union all   
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION    
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO    AND VTYPE <>'18' 
WHERE EXCHANGE='NSE'

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_DETAILS
-- --------------------------------------------------



CREATE VIEW [dbo].[CLIENT_DETAILS]
AS
SELECT
PARTY_CODE, CL_TYPE, BRANCH_CD, SUB_BROKER, TRADER, AREA, REGION, FAMILY, ADDR1, ADDR2, ADDR3, CITY, ZIP, RES_PHONE, BANK_NAME, BANK_BRANCH, ACC_NO, PAYMODE, BANK_AC_TYPE, CLTDPID, EXCHANGE = 'NSE', SEGMENT = 'MFSS'
FROM NSEMFSS..MFSS_CLIENT
UNION ALL
SELECT
PARTY_CODE, CL_TYPE, BRANCH_CD, SUB_BROKER, TRADER, AREA, REGION, FAMILY, ADDR1, ADDR2, ADDR3, CITY, ZIP, RES_PHONE, BANK_NAME, BANK_BRANCH, ACC_NO, PAYMODE, BANK_AC_TYPE, CLTDPID, EXCHANGE = 'BSE', SEGMENT = 'MFSS'
FROM BSEMFSS..MFSS_CLIENT

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_RECON_ACC_LEDGER_GL
-- --------------------------------------------------
--SELECT * FROM CLS_RECON_ACC_LEDGER_GL







CREATE VIEW [dbo].[CLS_RECON_ACC_LEDGER_GL]  



AS



	SELECT DISTINCT    



	TV.EXCHANGE,TV.SEGMENT,TV.VNO,TV.VTYPE,TV.BOOKTYPE

	,TV.VDT,TV.VDT_C,TV.SDTCUR,TV.LDTCUR,TV.MKCKFLAG,TV.VNO_MK,TV.MASTERSNO,TV.REMARK,TV.REFSNO,TV.POSTED_ON,TV.POSTED_BY,TV.CHECKED_ON,TV.CHECKED_BY,TV.ENTRY_AMT,TV.SOURCE_MODULE,TV.

	ENTRY_TYPE,TV.SETT_NO,TV.SETT_TYPE,TV.BILL_NO,TV.SELL_BUY,TV.LOCK_FLAG,TV.DISPLAY_FLAG,NODAYS = 0,TV.EDT,TV.EDT_C,TV.DRAMOUNT,TV.CRAMOUNT,TV.CLTCODE,TV.ACNAME,TV.ACCAT,TV.

	MAINLEDGER,TV.MAINLEDGERNAME,TV.MAINACCAT,TV.NARRATION,TV.BALAMT,TV.BRANCHCODE,TV.REFCODE,TV.OPPACCOUNT,TV.CURRENCY,TV.BNKNAME,TV.BRNNAME,TV.CHQDD,TV.INSTNO,TV.INSTDATE,TV.

	INSTDATE_C,TV.DR_RELDT,TV.CR_RELDT,TV.DR_RELDT_C,TV.CR_RELDT_C,   TV.DR_RELAMT,TV.CR_RELAMT,DRCR=CASE WHEN TV.DR_RELAMT=0 THEN 'C' ELSE 'D' END, 

	RELAMT=CASE WHEN TV.DR_RELAMT=0 THEN TV.CR_RELAMT ELSE TV.DR_RELAMT END,TV.DR_REFNO,TV.CR_REFNO,

	TV.DR_MICRNO,TV.CR_MICRNO,TV.RECEIPTNO,TV.SLIP_NO,TV.SLIP_DATE,TV.CHQINNAME,TV.CHQPRINTED,TV.CLEARMODE,V.VDESC,V.SHORTDESC,T4.SNO,  LNO=1

	FROM ACC_LEDGER TV ,ACC_TBL4 T4, Vmast V 

	WHERE TV.MASTERSNO=T4.MASTERSNO 

	AND TV.CR_RELAMT = T4.CR_RELAMT AND TV.DR_RELAMT = T4.DR_RELAMT

	AND TV.DR_RELDT='' AND TV.CR_RELDT=''

	and tv.VTYPE = v.Vtype

	



--UNION ALL



--	SELECT DISTINCT    



--	TV.EXCHANGE	,TV.SEGMENT	,TV.VNO	,TV.VTYPE,TV.BOOKTYPE

--	,TV.VDT,TV.VDT_C,TV.SDTCUR,TV.LDTCUR,TV.MKCKFLAG,TV.VNO_MK,TV.MASTERSNO,TV.REMARK,TV.REFSNO,TV.POSTED_ON,TV.POSTED_BY,TV.CHECKED_ON,TV.CHECKED_BY,TV.ENTRY_AMT,TV.SOURCE_MODULE,TV.

--	ENTRY_TYPE,TV.SETT_NO,TV.SETT_TYPE,TV.BILL_NO,TV.SELL_BUY,TV.LOCK_FLAG,TV.DISPLAY_FLAG,'',TV.EDT,TV.EDT_C,TV.DRAMOUNT,TV.CRAMOUNT,TV.CLTCODE,TV.ACNAME,TV.ACCAT,TV.

--	MAINLEDGER,TV.MAINLEDGERNAME,TV.MAINACCAT,TV.NARRATION,TV.BALAMT,TV.BRANCHCODE,TV.REFCODE,TV.OPPACCOUNT,TV.CURRENCY,TV.BNKNAME,TV.BRNNAME,TV.CHQDD,TV.INSTNO,TV.INSTDATE,TV.

--	INSTDATE_C,TV.DR_RELDT,TV.CR_RELDT,TV.DR_RELDT_C,TV.CR_RELDT_C,   TV.DR_RELAMT,TV.CR_RELAMT,

--	DRCR=CASE WHEN TV.DR_RELAMT=0 THEN 'C' ELSE 'D' END, RELAMT=CASE WHEN TV.DR_RELAMT=0 THEN TV.CR_RELAMT ELSE TV.DR_RELAMT END,TV.DR_REFNO,TV.CR_REFNO,

--	TV.DR_MICRNO,TV.CR_MICRNO,TV.RECEIPTNO,TV.SLIP_NO,TV.SLIP_DATE,TV.CHQINNAME,TV.CHQPRINTED,TV.CLEARMODE,TV.VDESC,TV.SHORTDESC,T4.SNO,  LNO=1

--	FROM ACC_LEDGER_PL TV ,ACC_TBL4 T4

--	WHERE TV.MASTERSNO=T4.MASTERSNO 

--	AND TV.CR_RELAMT = T4.CR_RELAMT AND TV.DR_RELAMT = T4.DR_RELAMT

--	AND TV.DR_RELDT='' AND TV.CR_RELDT=''

	--AND EXCHANGE +'-'+ SEGMENT IN ('BSE-MFSS','NSE-MFSS')



	--and VNO='201800001349'--AND VTYPE=5



	--SELECT * FROM ACC_LEDGER_PL WHERE VNO='201800001349'

GO

-- --------------------------------------------------
-- VIEW dbo.COSTBRANCH
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.EXISTS_RECORDS_VW
-- --------------------------------------------------




CREATE VIEW [dbo].[EXISTS_RECORDS_VW] 
AS
SELECT * FROM ANAND1.ACCOUNT.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANAND.ACCOUNT_AB.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELFO.ACCOUNTCURFO.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELFO.ACCOUNTFO.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELCOMMODITY.ACCOUNTMCDX.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELCOMMODITY.ACCOUNTNCDX.dbo.EXISTS_RECORDS
UNION ALL
SELECT * FROM ANGELFO.BBO_FA.dbo.EXISTS_RECORDS

GO

-- --------------------------------------------------
-- VIEW dbo.MF_LED_SUM
-- --------------------------------------------------
CREATE VIEW MF_LED_SUM
AS

SELECT CLTCODE PARTY_CODE,
( CASE WHEN ISNULL(BALANCE,0)>=0 THEN ISNULL(BALANCE,0) ELSE 0 END)  AS DEBIT_BALANCE 
,( CASE WHEN ISNULL(BALANCE,0)<=0 THEN ISNULL(BALANCE,0)*-1 ELSE 0 END)  AS CREDIT_BALANCE 
--FROM  BSEMFSS.DBO.MFSS_CLIENT A
--LEFT OUTER JOIN
FROM (
SELECT  CLTCODE,SUM(DRAMOUNT-CRAMOUNT) BALANCE   FROM MFSS_LEDGER_BSE  B WITH(NOLOCK),Parameter P WITH(NOLOCK)
WHERE  GETDATE() BETWEEN  Sdtcur AND Ldtcur 
AND VDT>=Sdtcur AND VDT <=LDTCUR
 GROUP BY CLTCODE 
 HAVING SUM(DRAMOUNT-CRAMOUNT) <>0
)A
 --ON A.PARTY_CODE =B.CLTCODE

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_LEDGER_BSE
-- --------------------------------------------------
CREATE VIEW MFSS_LEDGER_BSE      
AS      
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO      
WHERE EXCHANGE='BSE'      
union ALL     
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 ))AS VDT ,EDT  AS EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO      
WHERE EXCHANGE='BSE'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_LEDGER_BSE_26112014
-- --------------------------------------------------
CREATE VIEW MFSS_LEDGER_BSE_26112014      
AS      
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,T1.VDT,T3.EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO      
WHERE EXCHANGE='BSE'      
union ALL     
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,T1.VDT,T2.EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION      
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO      
WHERE EXCHANGE='BSE'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_LEDGER_BSE_rcs
-- --------------------------------------------------
CREATE VIEW MFSS_LEDGER_BSE_rcs      

AS      

----------CREATED BY RAHUL FOR AUDIT PURPOSE TO IDENTIFY POSTING DATE 


SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,t1.POSTED_BY,t1.CHECKED_ON,t1.POSTED_ON,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION      

FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO      

WHERE EXCHANGE='BSE'      

union ALL     

SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 ))AS VDT ,EDT  AS EDT,t1.POSTED_BY,t1.CHECKED_ON,t1.POSTED_ON,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION      

FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO      

WHERE EXCHANGE='BSE'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_LEDGER_NSE
-- --------------------------------------------------
CREATE VIEW MFSS_LEDGER_NSE   

AS    

SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION    

FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO    

WHERE EXCHANGE='NSE'    

union all   

SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,CONVERT(DATETIME,CONVERT(VARCHAR(11),VDT,103 )) AS VDT,EDT AS EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION    

FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO    

WHERE EXCHANGE='NSE'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_LEDGER_NSE_26112014
-- --------------------------------------------------
CREATE VIEW MFSS_LEDGER_NSE_26112014    
AS    
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,T1.VDT,T3.EDT,T3.DRAMOUNT,T3.CRAMOUNT,T3.CLTCODE,T3.NARRATION    
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL3 T3 ON T1.SNO=T3.MASTERSNO    
WHERE EXCHANGE='NSE'    
union all   
SELECT T1.VNO,T1.VTYPE,T1.EXCHANGE,T1.SEGMENT,T1.VDT,T2.EDT,T2.DRAMOUNT,T2.CRAMOUNT,T2.CLTCODE,T2.NARRATION    
FROM ACC_TBL1 T1 INNER JOIN ACC_TBL2 T2 ON T1.SNO=T2.MASTERSNO    
WHERE EXCHANGE='NSE'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_REL_DATA
-- --------------------------------------------------


CREATE VIEW MFSS_REL_DATA AS 

SELECT EXCHANGE,
SEGMENT,
VNO,
VTYPE,
VDT,
B.EDT
,B.DRAMOUNT
,B.CRAMOUNT
,B.CLTCODE as GL_CODE,
B.ACNAME AS GL_CODE_ACNAME,
B.NARRATION AS GL_CODE_NARR,
C.DRAMOUNT AS GL_CODE_AMT_DR,
C.CRAMOUNT AS  GL_CODE_AMT_CR,
C.CLTCODE AS CL_CODE,
C.ACNAME AS CL_CODE_ACNAME,
C.NARRATION AS CL_CODE_NARR,
D.BNKNAME AS CL_CODE_BNKNAME,
D.BRNNAME AS CL_CODE_BRNNAME,
D.DR_RELDT AS RELDT_DR,
D.DR_RELAMT AS RELDT_DR_AMT,
D.CR_RELDT AS RELDT_CR,
D.CR_RELAMT AS RELDT_CR_AMT
 FROM  ACC_TBL1 A,ACC_TBL2 B,ACC_TBL3 C,ACC_TBL4 D
WHERE A.SNO=B.MASTERSNO
AND B.MASTERSNO=C.MASTERSNO
AND C.MASTERSNO=D.MASTERSNO
AND A.VTYPE IN (2,3)
AND CHECKED_BY NOT LIKE '%TPR%'

GO

-- --------------------------------------------------
-- VIEW dbo.MFSS_REL_DATA_NEW
-- --------------------------------------------------
CREATE VIEW MFSS_REL_DATA_NEW AS 

SELECT EXCHANGE,
SEGMENT,
VNO,
VTYPE,
VDT,
B.EDT
,B.DRAMOUNT
,B.CRAMOUNT
,B.CLTCODE as GL_CODE,
B.ACNAME AS GL_CODE_ACNAME,
B.NARRATION AS GL_CODE_NARR,
C.DRAMOUNT AS GL_CODE_AMT_DR,
C.CRAMOUNT AS  GL_CODE_AMT_CR,
C.CLTCODE AS CL_CODE,
C.ACNAME AS CL_CODE_ACNAME,
C.NARRATION AS CL_CODE_NARR,
D.BNKNAME AS CL_CODE_BNKNAME,
D.BRNNAME AS CL_CODE_BRNNAME,
D.DR_RELDT AS RELDT_DR,
D.DR_RELAMT AS RELDT_DR_AMT,
D.CR_RELDT AS RELDT_CR,
D.CR_RELAMT AS RELDT_CR_AMT,INSTNO,C.ACNAME,A.CHECKED_BY
FROM  ACC_TBL1 A,ACC_TBL2 B,ACC_TBL3 C,ACC_TBL4 D
WHERE A.SNO=B.MASTERSNO
AND B.MASTERSNO=C.MASTERSNO
AND C.MASTERSNO=D.MASTERSNO
AND A.VTYPE IN (2,3)
--AND CHECKED_BY NOT LIKE '%TPR%'

GO

-- --------------------------------------------------
-- VIEW dbo.POBANK
-- --------------------------------------------------
CREATE VIEW POBANK
AS
SELECT * FROM BSEMFSS.DBO.POBANK

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VIEW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VIEW]
AS
SELECT * FROM ACCOUNT.DBO.RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VW
-- --------------------------------------------------


CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VW]
AS
SELECT * FROM ANAND1.ACCOUNT.dbo.RECON_BANK_FILEUPLOAD_LOGS 
UNION ALL 
SELECT * FROM ANAND.ACCOUNT_AB.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELFO.ACCOUNTFO.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELFO.ACCOUNTCURFO.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELFO.BBO_FA.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELCOMMODITY.ACCOUNTMCDX.dbo.RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ANGELCOMMODITY.ACCOUNTNCDX.dbo.RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW
-- --------------------------------------------------




CREATE VIEW [dbo].[RECON_BANK_MASTER_VW] 
AS
SELECT * FROM   ANAND1.ACCOUNT.DBO.RECON_BANK_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW_F2
-- --------------------------------------------------





CREATE VIEW [dbo].[RECON_BANK_MASTER_VW_F2] 
AS
SELECT DISTINCT SEGMENT ,BANKNAME,BANKCODE FROM   ANAND1.ACCOUNT.DBO.RECON_BANK_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_EXCLUDE_MASTER_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_EXCLUDE_MASTER_VW]
AS
SELECT * FROM ACCOUNT.DBO.RECON_EXCLUDE_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_REPORT_STATUS_VW
-- --------------------------------------------------



CREATE VIEW [dbo].[RECON_REPORT_STATUS_VW]
AS
SELECT * FROM ANAND1.ACCOUNT.DBO.RECON_REPORT_STATUS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_TECH_PROCESS_MASTER_VW
-- --------------------------------------------------


CREATE VIEW [dbo].[RECON_TECH_PROCESS_MASTER_VW]
AS
SELECT * FROM ANAND1.ACCOUNT.DBO.RECON_TECH_PROCESS_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist
-- --------------------------------------------------

CREATE VIEW [dbo].[rpt_chequelist] AS                

SELECT L.ACNAME,L.CLTCODE,DRCR=case when CRAMOUNT>0 THEN 'C' ELSE 'D'END,L.INSTNO,VAMT= CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,VDT= LEFT(CONVERT(VARCHAR,L.VDT,109),11),            
EDT=LEFT(CONVERT(VARCHAR,L.EDT,109),11),
CR_RELDT= Case When CRAMOUNT>0 THEN  left(convert(varchar,CR_RELDT,109),11) ELSE  left(convert(varchar,DR_RELDT,109),11) end,
--DR_RELDT= Case When DRAMOUNT>0 AND  (DR_RELDT = '1900-01-01 00:00:00.000'   or   DR_RELDT > GetDate() ) Then 'Unrealized' else left(convert(varchar,DR_RELDT,109),11) end,
L.BNKNAME,L.BRNNAME,NAR = NARRATION,L.VNO,L.VTYPE                 
FROM ACC_LEDGER L (NOLOCK)      
WHERE    
INSTNO <> ''      
AND INSTNO IS NOT  NULL  
AND   EXISTS  (SELECT * FROM ACMAST A WHERE  A.CLTCODE = L.CLTCODE AND A.ACCAT in(4,3))

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist_bak
-- --------------------------------------------------

create VIEW [dbo].[rpt_chequelist_bak] AS                

SELECT L.ACNAME,L.CLTCODE,DRCR='',L.INSTNO,VAMT= CASE WHEN DR_RELAMT=0 THEN CR_RELAMT ELSE DR_RELAMT END,VDT= LEFT(CONVERT(VARCHAR,L.VDT,109),11),            
EDT=LEFT(CONVERT(VARCHAR,L.EDT,109),11),
CR_RELDT= Case When CRAMOUNT>0 AND  (CR_RELDT = '1900-01-01 00:00:00.000'   or   CR_RELDT > GetDate() ) Then 'Unrealized' else left(convert(varchar,CR_RELDT,109),11) end,
--DR_RELDT= Case When DRAMOUNT>0 AND  (DR_RELDT = '1900-01-01 00:00:00.000'   or   DR_RELDT > GetDate() ) Then 'Unrealized' else left(convert(varchar,DR_RELDT,109),11) end,
L.BNKNAME,L.BRNNAME,NAR = NARRATION,L.VNO,L.VTYPE                 
FROM ACC_LEDGER L (NOLOCK)      
WHERE    
INSTNO <> ''      
AND INSTNO IS NOT  NULL

GO

-- --------------------------------------------------
-- VIEW dbo.VIEW_USERRIGHTS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- VIEW dbo.VW_MULTICOMPANY
-- --------------------------------------------------
/* encrypted or not available */

GO

