-- DDL Export
-- Server: 10.253.33.94
-- Database: BSEFO
-- Exported: 2026-02-05T02:40:25.540309

USE BSEFO;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- INDEX dbo.BFoAccBill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycd] ON [dbo].[BFoAccBill] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOCLOSING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [bfoclos] ON [dbo].[BFOCLOSING] ([Trade_date], [Product_Code], [Series_code], [expirydate], [Product_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.bfoglobals
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxGl] ON [dbo].[bfoglobals] ([year_start_dt], [year_end_dt])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOSCRIP2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [iscrip] ON [dbo].[BFOSCRIP2] ([product_code], [series_code], [Expirydate], [product_type], [Maturitydate])

GO

-- --------------------------------------------------
-- INDEX dbo.bfotaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxTrdCat] ON [dbo].[bfotaxes] ([Trans_cat])

GO

-- --------------------------------------------------
-- INDEX dbo.BFOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxTrd] ON [dbo].[BFOTRADE] ([Party_code], [product_type], [product_code], [Series_Id], [Series_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Client2_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Indx_Log_Report] ON [dbo].[Client2_Log] ([Party_Code], [Logfld_When_109])

GO

-- --------------------------------------------------
-- INDEX dbo.Client2_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Party_Log_Ind] ON [dbo].[Client2_Log] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Rounding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Contract_Rounding] ([CR_Party_Code], [CR_Date_From], [CR_Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLIENTBROKSCHEME
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOCLIENTBROKSCHEME] ([PARTY_CODE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLIENTTAXES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOCLIENTTAXES] ([PARTY_CODE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement_09092020
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ix_sd] ON [dbo].[fosettlement_09092020] ([Trade_no], [Party_Code], [Symbol], [Expirydate], [Strike_price], [Order_no])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement_09092020
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Sdate] ON [dbo].[fosettlement_09092020] ([Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENTBROKSCHEME
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[FOTRD_CLIENTBROKSCHEME] ([DATE_FROM], [DATE_TO], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENTTAXES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[FOTRD_CLIENTTAXES] ([DATE_FROM], [DATE_TO], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.PartyMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxPartyMap] ON [dbo].[PartyMapping] ([OldParty_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Scheme_Mapping] ([SP_Party_Code], [SP_Date_From], [SP_Date_To], [SP_Product_Code], [SP_Series_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxS] ON [dbo].[Scheme_Mapping] ([SP_Brok_ComputeType])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxScheme] ON [dbo].[Scheme_Master] ([SM_Scheme_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.Stt_Clientdetail
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxStt] ON [dbo].[Stt_Clientdetail] ([Party_Code], [Rectype], [Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Stt_Exchg
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[Stt_Exchg] ([Stt_Date], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.taxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [tran] ON [dbo].[taxes] ([Trans_cat], [Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Mtompremiumbill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TblMtom] ON [dbo].[Tbl_Mtompremiumbill] ([Billdate], [Party_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__257187A8] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblcategory
-- --------------------------------------------------
ALTER TABLE [dbo].[tblcategory] ADD CONSTRAINT [PK_tblcategory] PRIMARY KEY ([fldcategorycode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblcatmenu
-- --------------------------------------------------
ALTER TABLE [dbo].[tblcatmenu] ADD CONSTRAINT [PK_tblcatmenu] PRIMARY KEY ([fldauto])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblGlobalParams
-- --------------------------------------------------
ALTER TABLE [dbo].[tblGlobalParams] ADD CONSTRAINT [PK_tblGlobalParams] PRIMARY KEY ([FLDPWDMINLENGTH], [FLDPWDMAXLENGTH], [FLDSPCLCHAR], [FLDENCRYPTION], [FLDBLOCKPWD], [FLDDELBLOCK], [fldlastins], [fldlastdel], [fldlastupdt])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblPradnyausers
-- --------------------------------------------------
ALTER TABLE [dbo].[tblPradnyausers] ADD CONSTRAINT [PK_tblPradnyausers] PRIMARY KEY ([fldauto])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblUserControlMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tblUserControlMaster] ADD CONSTRAINT [PK_tblUserControlMaster] PRIMARY KEY ([FLDAUTO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_Login_Log
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_Login_Log] ADD CONSTRAINT [PK_V2_Login_Log] PRIMARY KEY ([Sno])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_addacmast1
-- --------------------------------------------------

Create Procedure Acc_addacmast1 As     
Select Grpname, Grpcode , Grpmain ,     
Maingrpname = (Case     
  When  Left(Grpmain, 2) = 'A0' Then (Select Grpname From Grpmast Where Grpcode = 'A0000000000')     
         Else    
          (Case When  Left(Grpmain, 2) = 'L0' Then (Select Grpname From Grpmast Where Grpcode = 'L0000000000')      
   Else     
    (Case When  Left(Grpmain, 2) = 'N0' Then (Select Grpname From Grpmast Where Grpcode = 'N0000000000')    
    Else     
     (Case When  Left(Grpmain, 2) = 'X0' Then (Select Grpname From Grpmast Where Grpcode = 'X0000000000')    
      End)    
      End)       
    End )     
      End)    
From Grpmast Order By Grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update
-- --------------------------------------------------

create Proc Add_Client_Account_Proc_Update (    
@Exchange Varchar(3),     
@Segment Varchar(7),     
@Branch_Cd Varchar(10),     
@FromParty Varchar(10),    
@ToParty Varchar(10),    
@MainDate Varchar(30),    
@DetDate Varchar(30)    
) As    
    
Delete From AcMast    
Where CltCode In ( Select Party_Code     
                   From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D    
                   Where D.Exchange = @Exchange And D.Segment = @Segment      
     And C.Cl_Code = D.Cl_Code)    
    
Insert into AcMast    
Select ACName = Long_Name, LongName = Long_Name, ACTyp = 'ASSET',     
ACCat = '4', FamilyCd = '', CltCode = Party_Code, AccDtls = '', GrpCode = 'A0307000000',     
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,     
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No    
From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D    
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code     
  

Insert into MultiBankId
SELECT Party_code,BankID=P.BankID,CltDpId=AC_Num,      
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'       
                        When Ac_Type = 'C' Then 'CURRENT'       
                        Else 'OTHER' End), 'OTHER'),
Long_Name, DEF=1
From bsefo.DBO.Client_Details_Tmp C, bsefo.DBO.Client_Brok_Details_Tmp D, bsefo.DBO.POBank P      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code      
And Ac_Type <> ''      
And C.Party_Code Not In (Select CltCode From MultiBankId )
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Share_Proc_Insert
-- --------------------------------------------------

CREATE proc Add_Client_Share_Proc_Insert (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As
Update Owner Set MemberCode = MemberCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Share_Proc_Update
-- --------------------------------------------------


CREATE Proc Add_Client_Share_Proc_Update (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
/*      
Status = 'U', Imp_Status = '0' -- For Fresh Insert      
If Imp_Status = '0' Then --Don't Update Status Feild      
Else --Update Status Feild as 'U'And Imp_Status as '0'      
*/      
      
Truncate table Client_Details_Tmp      
Truncate table Client_Brok_Details_Tmp      
      
Insert into Client_Details_Tmp      
Select C.*       
       From Anand1.MSAJAG.DBO.Client_Details C, Anand1.MSAJAG.DBO.Client_Brok_Details D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code      
       And (C.Imp_Status = '0' Or D.Imp_Status = '0')       
       And C.Branch_Cd Like @Branch_Cd      
       And C.Party_Code Between @FromParty And @ToParty       
       And C.ModifidedOn <= @MainDate And D.ModifiedOn <= @DetDate      
      
Insert into Client_Brok_Details_Tmp      
Select D.*       
       From Anand1.MSAJAG.DBO.Client_Details C, Anand1.MSAJAG.DBO.Client_Brok_Details D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code      
       And (C.Imp_Status = '0' Or D.Imp_Status = '0')       
       And C.Branch_Cd Like @Branch_Cd      
       And C.Party_Code Between @FromParty And @ToParty       
       And C.ModifidedOn <= @MainDate And D.ModifiedOn <= @DetDate      
      
Delete From Client1 Where Cl_Code In ( Select C.Cl_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code)      
      
/* Client1 Insert Query */      
Insert Into Client1      
Select C.Cl_Code,Short_Name,Long_Name,L_Address1,L_Address2,L_city,L_State,L_Nation,L_Zip,Fax,Res_Phone1,      
Res_Phone2,Off_Phone1,Off_Phone2,Email,Branch_cd,Credit_Limit,Cl_type,Cl_Status,Gl_Code='',Fd_Code=Sebi_Regn_No,Family,      
Penalty=0,Sub_Broker,Confirm_fax=0,PhoneOld='',L_Address3,Mobile_Pager,pan_gir_no,trader,WARD_NO,Region,Area,ClRating=''      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
      
Delete From Client2 Where Party_Code In ( Select Party_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code )      
      
/* Client2 Insert Query */      
Insert Into Client2      
Select C.Cl_Code,D.Exchange,Tran_Cat='TRD',Scrip_cat=0,Party_code=C.Cl_Code,Trd_Brok,Del_Brok,Margin=0,      
Turnover_tax=Fut_Tran_Chrgs,      
Sebi_Turn_tax=Fut_Sebi_Fees,      
Insurance_Chrg=Fut_STT,      
Ser_tax,Std_rate=Fut_Brok,P_To_P=0,      
exposure_lim=0,demat_tableno=Del_Brok,BankId=Participant_code,CltDpNo=Custodian_Code,Printf=Print_Options,      
ALBMDelchrg=0,ALBMDelivery=0,AlbmCF_tableno=0,MF_tableno=Del_Brok,SB_tableno=0,      
brok1_tableno=Fut_Fut_Fin_Brok,brok2_tableno=Fut_Opt_Brok,brok3_tableno=0,      
BrokerNote=Fut_Stamp_Duty,      
Other_chrg=Fut_Other_Chrgs,      
D.brok_scheme,Contcharge=0,MinContAmt=0,AddLedgerBal=0,Dummy1=Fut_Brok_Applicable,      
Dummy2=Fut_Opt_Brok,InsCont=(Case When Inst_contract = '' or Inst_contract is Null Then 'N' Else Inst_contract End),
SerTaxMethod=Ser_Tax_Method,Dummy6=Stp_Provider,      
Dummy7=Stp_Rp_Style,Dummy8=rel_mgr,Dummy9=c_group,Dummy10=sbu, ParentCode, ProductCode  
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
      
Delete From Client3 Where Party_Code In ( Select Party_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code)      
      
/* Client3 Insert Query */      
Insert Into Client3      
Select C.cl_code,C.Party_Code,exchange,markettype=Segment,margin=0,nooftimes=Multiplier,margin_recd=Charged,MtoM=0,      
pmarginrate=0,MtoMdate=GetDate(),InitialMargin=0,MainenancetMargin=Maintenance,MarginExchange=Reqd_By_Exch,MarginBroker=0,      
Dummy1=0,Dummy2=0      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
    
      
Insert Into Client4      
SELECT C.Cl_code,Party_code,Instru=0,BankID=DPID1,CltDpId1,Depository1,DEF=1       
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId1 <> '' And CltDpId1 <> ''       
And Depository1 IN ('NSDL', 'CDSL')       
And C.Party_Code Not In (Select Party_Code From Client4 Where Depository IN ('NSDL', 'CDSL') )      
      
Insert Into MultiCltId      
Select Party_code, CltDpId1, DpId1, Long_Name, Depository1, POA1       
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId1 <> '' And CltDpId1 <> ''       
And Depository1 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId1 And CltDpNo = CltDpId1)      
      
/* MultiCltId Insert Query */      
Insert Into MultiCltId      
Select Party_code, CltDpId2, DpId2, Long_Name, Depository2, POA2       
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId2 <> '' And CltDpId2 <> ''      
And Depository2 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId2 And CltDpNo = CltDpId2)      
      
/* MultiCltId Insert Query */      
Insert Into MultiCltId      
Select Party_code, CltDpId3, DpId3, Long_Name, Depository3, POA3       
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId3 <> '' And CltDpId3 <> ''      
And Depository3 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId3 And CltDpNo = CltDpId3)      
      
Delete From Client4 Where Cl_Code In ( Select C.Cl_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code )      
       And Depository Not In ('NSDL', 'CDSL')      
      
Insert into POBank (Bank_Name,Branch_Name)      
Select Distinct Bank_Name, Branch_Name       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code      
       And Bank_Name not in (Select Bank_Name From POBank Where POBank.Bank_Name = C.Bank_Name And POBank.Branch_Name = C.Branch_Name )      
      
/* Client4 Insert Query */      
Insert Into Client4      
SELECT C.Cl_code,Party_code,Instru=1,BankID=P.BankID,CltDpId=AC_Num,      
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'       
                        When Ac_Type = 'C' Then 'CURRENT'       
                        Else 'OTHER' End), 'OTHER'),      
DEF=0      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D, POBank P      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code      
And Ac_Type <> ''      
And C.Party_Code Not In (Select Party_Code From Client4 Where Depository Not In ('CDSL','NSDL'))      
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name      
       
Delete From Client5 Where Cl_Code In ( Select C.Cl_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code)      
      
/* Client5 Insert Query */      
Insert Into Client5      
Select C.cl_code,BirthDate=dob,Sex,ActiveFrom=ACTIVE_DATE,InteractMode,      
RepatriatAC=(Case When len(repatriat_bank) = 0 Then 1 Else 0 End),      
RepatriatBank=repatriat_bank,RepatriatACNO=repatriat_bank_ac_no,      
Introducer,Approver,KYCForm=chk_kyc_form,BankCert=chk_bank_certificate,      
Passport=(Case When passport_no <> '' Then 1 Else 0 End), Passportdtl=passport_no,      
VotersID=(Case When votersid_no <> '' Then 1 Else 0 End), VotersIDdtl = votersid_no,      
ITReturn=(Case When it_return_yr <> '' Then 1 Else 0 End), ITReturndtl=it_return_yr,      
Drivelicen=(Case When licence_no <> '' Then 1 Else 0 End), Drivelicendtl = licence_no,      
Rationcard=(Case When rat_card_no <> '' Then 1 Else 0 End), Rationcarddtl = rat_card_no,      
Corpdtlrecd=chk_corporate_deed,Corpdeed=chk_corp_dtls_recd,      
Anualreport=chk_annual_report,Networthcert=chk_networth_cert,InactiveFrom=InActive_From,      
P_Address1,P_Address2,P_Address3,P_City,P_State,P_Nation,P_Phone,P_Zip,AddEmailId,      
PassportDateOfIssue=passport_issued_on,PassportPlaceOfIssue=passport_issued_at,      
VoterIdDateOfIssue=votersid_issued_on,VoterIdPlaceOfIssue=votersid_issued_at,      
ITReturnDateOfFiling=it_return_filed_on,LicenceNoDateOfIssue=licence_issued_on,      
LicenceNoPlaceOfIssue=licence_issued_at,RationCardDateOfIssue=rat_card_issued_on,      
RationCardPlaceOfIssue=rat_card_issued_at,Client_AGRE_DT=client_agreement_on,REGR_NO=regr_no,      
REGR_PLACE=regr_at,REGR_DATE=regr_on,REGR_AUTH=regr_authority,INTROD_CLIENT_ID=introducer_id,      
INTROD_RELATION=introducer_relation,      
ANY_OTHER_ACC=other_ac_no,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(dealing_with_other_tm,''),      
systumdate=SystemDate,PASSPORTEXPDATE=passport_expires_on,DRIVEEXPDATE=licence_expires_on  
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code      
      
Delete From InstClient_Tbl Where PartyCode In ( Select Party_Code       
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code )      
      
/* InstClient_Tbl Insert Query */      
Insert Into InstClient_Tbl      
Select Party_Code, RoundMarketRate, RoundBrokerage, RoundNetRate, No_Of_Copies, Res1 = 0, Res2 = 0, Res3 = 0, Res4 = 0      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D, RoundParam R      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And D.Round_Style = R.RoundStyle      
      
Update ClientBrok_Scheme Set To_Date = Left(Brok_Eff_Date - 1,11) + ' 23:59:59'  
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
     Where D.Exchange = @Exchange And D.Segment = @Segment      
     And C.Cl_Code = D.Cl_Code       
     And C.Party_Code = ClientBrok_Scheme.Party_Code      
     And To_Date Like 'Dec 31 2049%'      
      
/* ClientBrok_Scheme Insert Query For TRD Normal */      
Insert Into ClientBrok_Scheme      
Select PARTY_CODE, Table_No = Trd_Brok, Scheme_Type = 'TRD', Scrip_Cd = 'ALL',       
Trade_Type = 'NRM', Brok_Scheme, From_Date = Left(Brok_Eff_Date,11), To_Date = 'Dec 31 2049 23:59:59'      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
      
/* ClientBrok_Scheme Insert Query For DEL Normal */      
Insert Into ClientBrok_Scheme      
Select PARTY_CODE, Table_No = Del_Brok, Scheme_Type = 'DEL', Scrip_Cd = 'ALL',       
Trade_Type = 'NRM', Brok_Scheme, From_Date = Left(Brok_Eff_Date,11), To_Date = 'Dec 31 2049 23:59:59'      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
      
/* ClientBrok_Scheme Insert Query For TRD Ins */      
Insert Into ClientBrok_Scheme      
Select PARTY_CODE, Table_No = Trd_Brok, Scheme_Type = 'TRD', Scrip_Cd = 'ALL',       
Trade_Type = 'INS', Brok_Scheme, From_Date = Left(Brok_Eff_Date,11), To_Date = 'Dec 31 2049 23:59:59'      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
      
/* ClientBrok_Scheme Insert Query For DEL Ins */      
Insert Into ClientBrok_Scheme      
Select PARTY_CODE, Table_No = Del_Brok, Scheme_Type = 'DEL', Scrip_Cd = 'ALL',       
Trade_Type = 'INS', Brok_Scheme, From_Date = Left(Brok_Eff_Date,11), To_Date = 'Dec 31 2049 23:59:59'      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
      
Update ClientTaxes_New Set ToDate = Trd_Eff_Dt - 1       
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
     Where D.Exchange = @Exchange And D.Segment = @Segment      
     And C.Cl_Code = D.Cl_Code       
     And C.Party_Code = ClientTaxes_New.Party_Code      
     And ClientTaxes_New.ToDate Like 'Dec 31 2049%'      
        
/* ClientTaxes_New Insert Query For TRD */      
Insert Into ClientTaxes_New      
Select D.Exchange, 1, Party_code, Cl_type, Trans_cat = 'TRD', Insurance_Chrg = TRD_STT,      
Turnover_tax = Trd_Tran_Chrgs, Other_chrg = Trd_Other_Chrgs, Sebiturn_tax = Trd_Sebi_Fees,       
Broker_note = Trd_Stamp_Duty, Demat_Insure = 0, Service_tax = 0, Tax1 = 0, Tax2 = 0, Tax3 = 0, Tax4 = 0,       
Tax5 = 0, Tax6 = 0, Tax7 = 0, Tax8 = 0, Tax9 = 0, Tax10 = 0, Latest = 1, State = '', FromDate = Left(Trd_Eff_Dt,11),      
ToDate = 'Dec 31 2049 23:59',       
Round_To = 2, RoFig = Round_To_Paise,       
ErrNum = (Case When Rounding_Method = 'ACTUAL'       
               Then 0.5      
               When Rounding_Method = 'NEXT'      
               Then (Case When Round_To_Paise = 1       
                          Then -0.01      
                          Else -0.1      
                     End)                     
        When Rounding_Method = 'PREVIOUS'       
               Then (Case When Round_To_Paise = -1  
                          Then 0.01      
                          Else 0.1      
                     End)                     
        When Rounding_Method = 'BANKER' Or Rounding_Method = 'BANKERS'  
               Then (Case When Round_To_Paise = 5      
                          Then -2.5      
                          Else 2.5      
                     End)                     
          End ),       
NoZero = (Case When Round_To_Paise <> 0 Then 0 Else 1 End)      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
      
/* ClientTaxes_New Insert Query For DEL */      
Insert Into ClientTaxes_New      
Select D.Exchange, 1, Party_code, Cl_type, Trans_cat = 'DEL', Insurance_Chrg = Del_STT,      
Turnover_tax = Del_Tran_Chrgs, Other_chrg = Del_Other_Chrgs, Sebiturn_tax = Del_Sebi_Fees,       
Broker_note = Del_Stamp_Duty, Demat_Insure = 0, Service_tax = 0, Tax1 = 0, Tax2 = 0, Tax3 = 0, Tax4 = 0,       
Tax5 = 0, Tax6 = 0, Tax7 = 0, Tax8 = 0, Tax9 = 0, Tax10 = 0, Latest = 1, State = '', FromDate = Left(Del_Eff_Dt,11),       
ToDate = 'Dec 31 2049 23:59',       
Round_To = 2, RoFig = Round_To_Paise,       
ErrNum = (Case When Rounding_Method = 'ACTUAL'       
               Then 0.5      
               When Rounding_Method = 'NEXT'      
               Then (Case When Round_To_Paise = 1       
                          Then -0.01      
                          Else -0.1      
                     End)                     
        When Rounding_Method = 'PREVIOUS'       
               Then (Case When Round_To_Paise = -1       
                          Then 0.01      
                          Else 0.1      
                     End)                     
        When Rounding_Method = 'BANKER' Or Rounding_Method = 'BANKERS'  
               Then (Case When Round_To_Paise = 5      
                          Then -2.5      
                          Else 2.5      
                     End)                     
          End ),       
NoZero = (Case When Round_To_Paise <> 0 Then 0 Else 1 End)      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code      
    
Delete From UCC_Client      
Where Party_Code In ( Select Party_Code       
      From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
      Where D.Exchange = @Exchange And D.Segment = @Segment      
      And C.Cl_Code = D.Cl_Code)       
      
Insert Into UCC_Client      
Select Party_code, Long_Name, Contract_Person = Introducer, ClearingNo1 = '', ClearingNo2 = '', ClearingNo3 = '',      
ClearingNo4 = '', MapidId = Mapin_Id, FMCode = '', DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = Other_Ac_No,       
Family_code1 = '', Family_code2 = '', Family_code3 = '', Family_code4 = '', Remark = '', Ucc_Code,       
StpProvider = '', dummy1 = '', dummy2 = ''      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code  
  
Delete From DelPartyFlag     
Where Party_Code In ( Select Party_Code       
      From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
      Where D.Exchange = @Exchange And D.Segment = @Segment      
      And C.Cl_Code = D.Cl_Code)       
  
Insert Into DelPartyFlag  
Select Party_Code, Debit_Balance, Inter_Sett  
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment      
And C.Cl_Code = D.Cl_Code  
  
IF @SEGMENT = 'FUTURES'    
BEGIN  
  
	UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT
	AND C.CL_CODE = D.CL_CODE     
	AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE    
	AND DATE_TO LIKE 'DEC 31 2049%'

	INSERT INTO FOCLIENTBROKSCHEME    
	SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',
	FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK, 
	FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,
	COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME, 
	OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0
	    			   THEN 'PRICE' 
				   WHEN FUT_BROK_APPLICABLE = 1
				   THEN 'SPRICE'   
	    			   ELSE 'SSPRICE' 
			       END)
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE

	UPDATE FOCLIENTTAXES SET DATE_TO = TRD_EFF_DT - 1     
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE     
	AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE    
	AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'

	INSERT INTO FOCLIENTTAXES    
	SELECT PARTY_CODE, DATE_FROM = LEFT(TRD_EFF_DT,11), DATE_TO = 'DEC 31 2049 23:59',
	FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS, 
	FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,     
	FUT_BROKER_NOTE = TRD_STAMP_DUTY,
	OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS, 
	OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,     
	OPT_BROKER_NOTE = DEL_STAMP_DUTY,
	ROUND_TO = ROUND_TO_DIGIT, ROFIG = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 0 ELSE ROUND_TO_PAISE END),     
	ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'     
	               THEN 0.5    
	               WHEN ROUNDING_METHOD = 'NEXT'    
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1     
	                          THEN -0.01    
	                          ELSE -0.1    
	                     END)                   
	        WHEN ROUNDING_METHOD = 'PREVIOUS'     
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1
	                          THEN 0.000001 
	                          ELSE 0.000001  
	                     END)                   
	        WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5    
	                          THEN -2.5    
	                          ELSE 2.5    
	                     END)      
	          END ),     
	NOZERO = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 1 
				  ELSE 0 END)
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE

	DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO
	DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO  
  
END

/*----------------------------------------------------- END OF THE PROC ---------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADDCOSTMAST
-- --------------------------------------------------

CREATE PROCEDURE ADDCOSTMAST
AS

DECLARE
@@ERRCOUNT INT,
@@CATCODE TINYINT

SELECT @@ERRCOUNT = COUNT(1) FROM CATEGORY WHERE CATEGORY = 'BRANCH'

IF @@ERRCOUNT = 0 
BEGIN
	SELECT @@CATCODE = ISNULL(MAX(CATCODE),0) + 1 FROM CATEGORY
	INSERT INTO CATEGORY VALUES('BRANCH', @@CATCODE)
END

CREATE TABLE #COSTMAST
(
	COSTNAME VARCHAR(10),
	COSTCODE INT IDENTITY(1,1),
	CATCODE INT,
	GRPCODE VARCHAR(12)
)

INSERT INTO #COSTMAST 
SELECT BRANCH_CODE, @@CATCODE, '100000000000'
FROM BSEFO.DBO.BRANCH

INSERT INTO COSTMAST SELECT * FROM #COSTMAST 

INSERT INTO BRANCHACCOUNTS
SELECT BRANCH_CODE, LEFT(BRANCH_CODE + 'CTRL', 10), 'HOCTRL', 0
FROM BSEFO.DBO.BRANCH

UPDATE BRANCHACCOUNTS SET DEFAULTAC = 1 WHERE LTRIM(RTRIM(BRANCHNAME)) = 'HO'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_fo_bkg
-- --------------------------------------------------
CREATE procedure angel_fo_bkg  (@fdate as varchar(11), @tdate as varchar(11), @sb as varchar(10),@Op as varchar(1))                  
as                    


--DROP TABLE  #fo_a          
set nocount on                    
select * into #file from mis.FOBKG.dbo.FO_BKGMASTER                    
           
 select DISTINCT B.SUB_BROKER,a.party_code,a.brokapplied,A.SETT_TYPE,                    
 sauda_date=convert(datetime,convert(varchar(11),a.Sauda_date)),                    
 A.product_code,a.series_code,a.User_id,a.Trade_no,                    
 a.Tradeqty,A.SELL_BUY,a.Strike_price,a.marketrate,                    
 a.brokapplied AS BROKCHRG,(a.brokapplied * a.Tradeqty) AS BROK_AMT,expirydate,c.Percentage,product_type                  
 --drop table #fo_t170_a                    
 into #fo_a                  
 from bfosettlement a                    
 left outer join INTRANET.RISK.DBO.client_details b                     
 on a.party_code=b.cl_code                    
 left outer join mis.FOBKG.dbo.FO_BKGMASTER  c                    
 on b.SUB_BROKER=c.SB_CODE                    
 where sauda_Date >=@fdate+' 00:00:00' and sauda_DAte <=@tdate+' 23:59:59'                  
 --where sauda_Date >='aug 26 2005 00:00:00' and sauda_DAte <='sep 25 2005 23:59:59'                  
 and sub_broker=@sb              
 --and sub_broker='ru'             
 --and party_code='g961'               
 and sub_Broker in(select distinct sb_code from #file)                  
 and b.cl_code=c.cl_code          
                  
--select * from #fo_t170_a where party_code='g961' order by sauda_date          
-- select * from #fo_t170_1 where party_code='g961' order by sauda_date             
select party_code,series_code,product_code,strike_price,sauda_date,sett_type,expirydate,product_type,                    
Bprice=sum(case when sell_buy='1' then marketrate*tradeqty else 0 end),                    
bqty=sum(case when sell_buy='1' then tradeqty else 0 end),                    
Sprice=sum(case when sell_buy='2' then marketrate*tradeqty else 0 end),                    
sqty=sum(case when sell_buy='2' then tradeqty else 0 end) ,                    
bmarkup=0,                    
smarkup=0                    
--drop table #fo_t170_1                  
into #fo_1                    
from #fo_a                     
group by party_code,series_code,product_code,strike_price,sauda_date,sett_type,expirydate ,product_type                   
                    
                
update #fo_1 set bprice=bprice/bqty where bqty > 0                    
update #fo_1 set sprice=sprice/sqty where sqty > 0                    
                
update #fo_1 set bmarkup =                     
case                     
when bqty=sqty and bprice >= sprice and bqty > 0 then 1                     
when bqty=sqty and bprice < sprice and bqty > 0 then 2                    
when bqty>sqty and bqty > 0 then 1                     
when bqty<sqty and bqty > 0 then 2                    
else 0                    
end,                    
smarkup =                     
case                     
when bqty=sqty and bprice >= sprice and sqty > 0 then 2                    
when bqty=sqty and bprice < sprice and sqty > 0 then 1                    
when bqty>sqty and sqty > 0 then 2                    
when bqty<sqty and sqty > 0 then 1                    
else 0                    
end                    
                  
--drop table #temp1                    
select a.*,b.bmarkup,b.smarkup                    
--,brok_per_share=convert(money,0.00)                    
into #temp1                    
from #fo_a a left outer join #fo_1 b                 
on a.party_code=b.party_code and a.series_code=b.series_code and a.product_code=b.product_code and a.strike_price=b.strike_price and                    
a.sauda_date=b.sauda_Date and a.sett_Type=b.sett_Type and a.expirydate=b.expirydate                    
                    
--select * from #temp1  where party_code='g961' order by sauda_date             
update #temp1 set bmarkup = 0 where sell_buy = 2                    
                
update #temp1 set smarkup = 0 where sell_buy = 1                    
                  
drop table temp_calc_fo               
              
---------- Calculate First Leg on Buyside above minimum                    
                
--insert into temp_calc                
-- select * from temp_calc             
select a.*,brok_per_share =            
(                  
case when                  
(case when pva='p' then ((marketrate+strike_price)*slabamax)/100 else isnull(slabamax,0) end)   < slabamin then isnull(slabamin,0)            
else (case when pva='p' then ((marketrate+strike_price)*slabamax)/100 else isnull(slabamax,0) end)                     
end                  
)                  
into temp_calc_fo                     
from                    
(select * from #temp1 where bmarkup = 1) a                    
left outer join                    
#file b  on a.party_code=b.cl_code                    
and marketrate+strike_price >= sslabamin and marketrate+strike_price <= sslabamax                    
                    
delete from temp_calc_fo where brok_per_share is null                    
                    
----------- Calculate First Leg on Buyside less then or equaL TO minimum                    
                    
/*                    
insert into temp_calc                     
select a.*,brok_per_share=slabamin                     
from                    
(select * from #temp1 where bmarkup = 1) a                    
left outer join                    
#brokfile b  on a.party_code=b.cl_code                    
and price+strike_price < sslabamin                     
                    
delete from temp_calc where brok_per_share is null                    
*/                    
---------- Calculate Second Leg on Buyside above minimum                    
                    
insert into temp_calc_fo                     
select a.*,brok_per_share=                  
(                  
case when                   
(case when pvb='p' then ((marketrate+strike_price)*slabbmax)/100 else isnull(slabbmax,0) end)   < slabbmin then isnull(slabbmin,0)              
else (case when pvb='p' then ((marketrate+strike_price)*slabbmax)/100 else isnull(slabbmax,0) end)    end                  
)                  
 from                    
(select * from #temp1 where bmarkup = 2) a                    
left outer join                    
#file b  on a.party_code=b.cl_code                    
and marketrate+strike_price >= sslabbmin and marketrate+strike_price <= sslabbmax                    
                    
delete from temp_calc_fo where brok_per_share is null                    
                    
----------- Calculate Second Leg on Buyside less then or equaL TO minimum                    
/*                    
insert into temp_calc                     
select a.*,brok_per_share=slabbmin                     
from                    
(select * from #temp1 where bmarkup = 2) a                    
left outer join                    
#brokfile b  on a.party_code=b.cl_code                    
and price+strike_price < sslabbmin                     
                    
delete from temp_calc where brok_per_share is null                    
  */                  
------------ Calculate First Leg on Sellside above minimum                    
                    
insert into temp_calc_fo                     
select a.*,brok_per_share=                  
(case when                   
(case when pva='p' then ((marketrate+strike_price)*slabamax)/100 else isnull(slabamax,0) end)  < slabamin then isnull(slabamin,0) else                  
(case when pva='p' then ((marketrate+strike_price)*slabamax)/100 else isnull(slabamax,0) end)  end)                  
 from                    
(select * from #temp1 where smarkup = 1) a                    
left outer join                    
#file b  on a.party_code=b.cl_code                    
and marketrate+strike_price >= sslabamin and marketrate+strike_price <= sslabamax                    
                    
delete from temp_calc_fo where brok_per_share is null                    
                    
----------- Calculate First Leg on Sellside less then or equaL TO minimum                    
/*                    
insert into temp_calc                     
select a.*,brok_per_share=slabamin                     
from                    
(select * from #temp1 where smarkup = 1) a                    
left outer join                    
#brokfile b  on a.party_code=b.cl_code                    
and price+strike_price < sslabamin                     
                    
delete from temp_calc where brok_per_share is null                 
*/                  
---------- Calculate Second Leg on Sellside above minimum                    
                    
insert into temp_calc_fo                     
select a.*,brok_per_share=                  
(case when                  
(case when pvb='p' then ((marketrate+strike_price)*slabbmax)/100 else isnull(slabbmax,0) end)  < slabbmin then isnull(slabbmin,0)              
else (case when pvb='p' then ((marketrate+strike_price)*slabbmax)/100 else isnull(slabbmax,0) end)  end)                  
 from                    
(select * from #temp1 where smarkup = 2) a                    
left outer join                    
#file b  on a.party_code=b.cl_code                    
and marketrate+strike_price >= sslabbmin and marketrate+strike_price <= sslabbmax                    
             
delete from temp_calc_fo where brok_per_share is null                
                
                    
----------- Calculate Second Leg on Sellside less then or equaL TO minimum                    
/*             
insert into temp_calc                     
select a.*,brok_per_share=slabbmin                     
from                    
(select * from #temp1 where smarkup = 2) a                    
left outer join                    
#brokfile b  on a.party_code=b.cl_code                    
and price+strike_price < sslabbmin                     
*/                  
                  
--delete from temp_calc where brok_per_share is null                    
                   
--select * from temp_calc  where party_code='se51'                   
      
if upper(@Op)='Y'      
Begin                  
 insert into temp_calc_fo                  
 select *,brok_per_share=convert(money,0.00) from #temp1 where party_code not in (select party_Code from temp_calc_fo)                  
 and product_type = ''      
end      
ELSE      
Begin      
 insert into temp_calc_fo                  
 select *,brok_per_share=convert(money,0.00) from #temp1 where party_code not in (select party_Code from temp_calc_fo)                  
End                
    
   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_updCliPswd
-- --------------------------------------------------
CREATE procedure Angel_updCliPswd
(
    @username as varchar(15),
    @pswd as varchar(15)
)
as
begin
    declare @fld1 as int,@fldadm as int
    select @fld1=fldauto,@fldadm=fldadminauto 
    from tblPradnyausers (nolock) 
    where fldusername=@username

    update tblPradnyausers set fldpassword =@pswd 
    where fldauto =@fld1 and fldadminauto = fldadminauto

    INSERT INTO TBLUSERCONTROLMASTER_JRNL SELECT *,'10',GETDATE() 
    FROM TBLUSERCONTROLMASTER WHERE FLDUSERID = @fld1

    if not exists (Select emp_no from intranet.risk.dbo.emp_info a(nolock)
    where emp_no=@username and Status<>'A')
    begin
        update TBLUSERCONTROLMASTER set FLDPWDEXPIRY = 30, FLDMAXATTEMPT = 5, FLDSTATUS = 0,
        --FLDATTEMPTCNT = (CASE WHEN (0 = 1 AND 0 = 0) THEN 0 ELSE FLDATTEMPTCNT END),
        FLDATTEMPTCNT = 0 ,
        FLDFIRSTLOGIN = 'Y', FLDFORCELOGOUT = 0 WHERE FLDUSERID = @fld1
    end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_VandhaScripSearch_BSEFO
-- --------------------------------------------------
CREATE Proc Angel_VandhaScripSearch_BSEFO  
(  
@fdate as varchar(11),  
@partyCode as varchar(11),  
@Type as varchar(2),  
@ScripRet as varchar(25)  
)  
as  
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
  
select * into #Bill from fobillvalan(nolock)   
where sauda_Date >= @fdate  
and sauda_Date <= @fdate+' 23:59:59'  
and Party_Code = @partyCode  
  
select * into #Settlement from fosettlement(nolock)   
where sauda_Date >= @fdate  
and sauda_Date <= @fdate+' 23:59:59'  
and Party_Code = @partyCode  
  
--select Distinct Scrip_cd from #bill  
  
-----Intraday  
If @Type = 'I'  
begin  
 if(@ScripRet is not Null or @ScripRet <> '' )  
 begin  
  
        select * from #Bill where PQty <> 0 and SQty <> 0   
  and Inst_type+Symbol+convert(varchar(11),expirydate)+option_type+convert(varchar(11),strike_price) = @ScripRet  
  
  select * from #Settlement(nolock) where sauda_date >= @fdate  
  and sauda_date <= @fdate+' 23:59:59' and Party_Code = @partyCode and   
  Inst_type+Symbol+convert(varchar(11),expirydate)+option_type+convert(varchar(11),strike_price) = @ScripRet  
   
 end  
 else  
  select distinct Inst_type,Symbol,expirydate,option_type,strike_price from #Bill  
End  
  
-----Delivery  
If @Type = 'D'  
Begin  
if(@ScripRet is not Null )  
  begin  
  
   select * from #Bill where (PQty > 0 or SQty <> 0) and   
   Inst_type+Symbol+convert(varchar(11),expirydate)+option_type+convert(varchar(11),strike_price) = @ScripRet  
  
   select * from #Settlement(nolock) where sauda_date >= @fdate  
   and sauda_date <= @fdate+' 23:59:59' and Party_Code = @partyCode and   
   Inst_type+Symbol+convert(varchar(11),expirydate)+option_type+convert(varchar(11),strike_price) = @ScripRet  
  
  end   
 else  
  select distinct Inst_type,Symbol,expirydate,option_type,strike_price from #Bill  
End  
  
drop table #Bill  
drop table #Settlement

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOAfterContCursor
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFOAfterContCursor    Script Date: 04/02/2002 2:48:09 PM ******/
/****** Object:  Stored Procedure dbo.BFOAfterContCursor    Script Date: 2/14/02 1:43:05 PM ******/
/****** Object:  Stored Procedure dbo.BFOAfterContCursor    Script Date: 01/04/1980 1:05:02 AM ******/
/****** Object:  Stored Procedure dbo.BFOAfterContCursor    Script Date: 09/25/2001 6:15:59 AM ******/
/*  Recent changes done by vaishali on 06/08/2001 - Added 2 parameters marketrate & marketrateflag. (If marketrate is selected then marketrateflag = 1 else 0)*/
/*  Recent changes done by vaishali  changes the type of expiry date to varchar instead of datetime on 25/07/2001*/
/****** Object:  Stored Procedure dbo.FOAfterContCursor    Script Date: 4/3/01 12:58:39 PM ******/
CREATE proc [dbo].[BFOAfterContCursor] 
@uid varchar(30),
@partycd VARCHAR(10),
@tdate varchar(11),
@product_type varchar(3),
@product_code varchar(10),
@series_code varchar(13),
@expirydate varchar(11),
@series_id int,
@sellbuy varchar(2),
@trade_no varchar(10),
@order_no varchar(15),
@ToParty as Varchar(10),
@TQty Int,
@marketrate money,
@mktrateflag int,
@flag INT
 As
Declare 
@@ContractNo Varchar(5),
@@Cont Cursor,
@@CNo Cursor,
@@TNo Cursor,
@@ttradeno Varchar(14),
@@trade_no Varchar(14),
@@Xtradeno Varchar(14),
@@tradeqty int,
@@marketrate money,
@@netrate money,
@@TFlag Int,
@@product_type varchar(3),
@@product_code varchar(10),
@@series_code varchar(13),
@@expirydate varchar(12),
@@series_id int,
@@sell_buy varchar(1),
@@remqty int
Set @@Cno = Cursor For 
        select distinct contractno from Bfosettlement 
        where party_code = @Toparty
        and left(convert(varchar,sauda_date,109),11)= @TDate
	
Open @@CNo 
Fetch Next from @@CNo into @@ContractNo
if @@Fetch_Status <> 0 
Begin
	Close @@CNo
	DeAllocate @@CNo
	Set @@Cno = Cursor For 
   		select Isnull(max(contractno),'00001') from Bfosettlement 
	  	where left(convert(varchar,sauda_date,109),11)= @TDate
	Open @@CNo
	Fetch Next from @@CNo into @@ContractNo
End
Close @@CNo
DeAllocate @@CNo
IF @FLAG =1
BEGIN
Set @@Cont = Cursor For
       Select trade_no ,tradeqty,marketrate,netrate,product_type,product_code,series_code,expirydate,series_id,sell_buy
       from Bfosettlement where  billno = 0 
       and party_code like @partycd
       and  left(convert(varchar,sauda_date,109),11) = @TDate 
       order by tradeqty desc 
END
IF @FLAG =2
BEGIN
Set @@Cont = Cursor For
       Select trade_no ,tradeqty,marketrate,netrate,product_type,product_code,series_code,expirydate,series_id,sell_buy
       from Bfosettlement where  billno = 0 
       and party_code like @partycd
       and  left(convert(varchar,sauda_date,109),11) like @TDate 
       and product_type =  @product_type 
       and product_code = @product_code
       and series_code = @series_code 
       and  left(convert(varchar,expirydate,109),11) = @expirydate
       and series_id = @series_id				
       order by tradeqty desc 
END
IF @FLAG = 3
BEGIN
Set @@Cont = Cursor For
       Select trade_no ,tradeqty,marketrate,netrate,product_type,product_code,series_code,expirydate,series_id,sell_buy
       from Bfosettlement where  billno = 0 
       and party_code like @partycd
       and  left(convert(varchar,sauda_date,109),11) like @TDate 
        and product_type =  @product_type 
       and product_code = @product_code
       and series_code = @series_code 
       and  left(convert(varchar,expirydate,109),11) = @expirydate
       and series_id = @series_id		
       and sell_buy = @sellbuy		
       order by tradeqty desc 
END
IF @FLAG = 4
BEGIN
	If @mktrateflag = 0   /*  If Condition Added by vaishali on 06/08/2001*/ 
	Begin
		Set @@Cont = Cursor For
       		Select trade_no ,tradeqty,marketrate,netrate,product_type,product_code,series_code,expirydate,series_id,sell_buy
       		from Bfosettlement where  billno = 0 
       		and party_code like @partycd
       		and  left(convert(varchar,sauda_date,109),11) like @TDate 
        		and product_type =  @product_type 
       		and product_code = @product_code
       		and series_code = @series_code 
       		and  left(convert(varchar,expirydate,109),11) = @expirydate
       		and series_id = @series_id		
       		and sell_buy = @sellbuy	
       		and trade_no like @trade_no 
       		and order_no like @order_no 
       		order by tradeqty desc
	end
	Else If @mktrateflag = 1
	Begin
		Set @@Cont = Cursor For        		
		Select trade_no ,tradeqty,marketrate,netrate,product_type,product_code,series_code,expirydate,series_id,sell_buy
       		from Bfosettlement where  billno = 0 
       		and party_code like @partycd
       		and  left(convert(varchar,sauda_date,109),11) like @TDate 
        		and product_type =  @product_type 
       		and product_code = @product_code
       		and series_code = @series_code 
       		and  left(convert(varchar,expirydate,109),11) = @expirydate
       		and series_id = @series_id		
       		and sell_buy = @sellbuy	
       		and trade_no like @trade_no 
       		and order_no like @order_no
		and marketrate = @marketrate
       		order by tradeqty desc
	end
END 
Open @@Cont 
Fetch Next from @@Cont Into @@trade_no ,@@tradeqty,@@marketrate,@@netrate,@@product_type,@@product_code,@@series_code,@@expirydate,@@series_id,@@sell_buy  
/*select @@trade_no ,@@tradeqty,@@marketrate,@@netrate,@@product_type,@@product_code,@@series_code,@@expirydate,@@series_id,@@sell_buy  */
While @@Fetch_Status = 0 and @TQty > 0
begin
	Select @@TTradeNo = 'R' + @@trade_no
	Select @@TFlag = 1 
	Select @@XTradeNo = '0'
	while  @@TFlag = 1 	
	Begin		 		
		Set @@TNo = Cursor for
		select trade_no from Bfosettlement 
    		where trade_no like @@ttradeno
	    	
		Open @@TNo 
		Fetch next from @@Tno into @@XTradeNo
		if @@Fetch_Status = 0 and @@XTradeNo <> '0' 
			Select @@TTRadeno = 'R' +  @@XTradeNo
		else
			Select @@TFlag = 0 
	End
	
	
	if @@TradeQty = @TQty 
	Begin
		
		Insert into Bfosettlement select
		@@contractno,BillNo,@@ttradeno,@toparty,product_type,product_code,series_code,series_id,Expirydate,multiplier,
                		User_id,@@TradeQty,AuctionPart,MarketType,Series,Order_no,marketrate,strike_price,Sauda_date,Table_No,Line_No,
		Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount = (@Tqty *@@NetRate),
		Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount= (@tqty * @@marketrate),Billflag,
		sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_Rate,GroupId,TraderCode,
		reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,Pro_cli,ParticipantCode,CpId,Instrument,
		BookType,Branch_Id,Scheme,TMark,dummy1,dummy2
		from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and  left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		
		
		insert into contlogin select @uid,@partycd,@toparty,product_type,product_code,series_code,expirydate,series_id,
		@tqty,sell_buy,sauda_date,contractno,getdate(),0,@@ttradeno from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
	     	update Bfosettlement set tradeqty= 0,Normal = 0,Day_puc = 0,day_sales = 0,Sett_purch = 0,Sett_sales  = 0, 
         		marketrate = 0,Brokapplied = 0,NetRate = 0,Amount = 0,Ins_chrg = 0,turn_tax = 0,other_chrg = 0,
    		sebi_tax = 0,Broker_chrg = 0,Service_tax = 0,Trade_amount = 0,NBrokApp = 0,NSerTax = 0,N_NetRate = 0
    		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id and 
 		left(convert(varchar,sauda_date,109),11) = @TDate  and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		Select @TQty = 0
	end
	else if @@TradeQty > @TQty 
	Begin
		select @@remQty = @@TradeQty - @TQty
	
		
		Insert into Bfosettlement select
		@@contractno,BillNo,@@ttradeno,@toparty,product_type,product_code,series_code,series_id,Expirydate,multiplier,
                		User_id,@tqty,AuctionPart,MarketType,Series,Order_no,marketrate,strike_price,Sauda_date,Table_No,Line_No,
		Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount = (@Tqty *@@NetRate),
		Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount= (@tqty * @@marketrate),Billflag,
		sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_Rate,GroupId,TraderCode,
		reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,Pro_cli,ParticipantCode,CpId,Instrument,
		BookType,Branch_Id,Scheme,TMark,dummy1,dummy2
		from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and  left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		insert into contlogin select @uid,@partycd,@toparty,product_type,product_code,series_code,expirydate,series_id,
		@tqty,sell_buy,sauda_date,contractno,getdate(),0,@@ttradeno from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		update Bfosettlement set TradeQty =@@remqty , amount = (@@remqty * @@netrate ) ,
		trade_amount = @@remqty * @@marketrate 
    		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id  
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate  and marketrate = @@marketrate
		
		Select @TQty = 0 	
	end
	else if @@TradeQty < @TQty 
	Begin
		/*select @@tradeqty,@tqty,@toparty
		select  @@trade_no ,@@tradeqty,@@marketrate,@@netrate,@@product_type,@@product_code,@@series_code,@@expirydate,@@series_id,@@sell_buy  */
		Insert into Bfosettlement select
		@@contractno,BillNo,@@ttradeno,@toparty,product_type,product_code,series_code,series_id,Expirydate,multiplier,
                		User_id,@@TradeQty,AuctionPart,MarketType,Series,Order_no,marketrate,strike_price,Sauda_date,Table_No,Line_No,
		Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount = (@@TradeQty *@@NetRate),
		Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount= (@@TradeQty * @@marketrate),Billflag,
		sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_Rate,GroupId,TraderCode,
		reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,Pro_cli,ParticipantCode,CpId,Instrument,
		BookType,Branch_Id,Scheme,TMark,dummy1,dummy2
		from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and  left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		insert into contlogin select @uid,@partycd,@toparty,product_type,product_code,series_code,expirydate,series_id,
		@@TradeQty,sell_buy,sauda_date,contractno,getdate(),0,@@ttradeno from Bfosettlement 
		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id 
		and left(convert(varchar,sauda_date,109),11) = @TDate and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate   and marketrate = @@marketrate
		update Bfosettlement set tradeqty= 0,Normal = 0,Day_puc = 0,day_sales = 0,Sett_purch = 0,Sett_sales  = 0, 
             		marketrate = 0,Brokapplied = 0,NetRate = 0,Amount = 0,Ins_chrg = 0,turn_tax = 0,other_chrg = 0,
    		sebi_tax = 0,Broker_chrg = 0,Service_tax = 0,Trade_amount = 0,NBrokApp = 0,NSerTax = 0,N_NetRate = 0
    		where trade_no = @@trade_no and product_type = @@product_type and product_code = @@product_code 
		and series_code = @@series_code and left(convert(varchar,expirydate,109),11) = @@expirydate and series_id = @@series_id and 
 		left(convert(varchar,sauda_date,109),11) = @TDate  and sell_buy =@@sell_buy  and party_code = @partycd
  		and netrate= @@NetRate  and marketrate = @@marketrate
	
		Select @TQty = @TQty - @@TradeQty 
	end
	Fetch Next from @@Cont Into @@trade_no ,@@tradeqty,@@marketrate,@@netrate,@@product_type,@@product_code,@@series_code,@@expirydate,@@series_id,@@sell_buy  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoAupdbilltax
-- --------------------------------------------------

CREATE  proc [dbo].[BFoAupdbilltax](@ExpiryDate  varchar(11)) as    
update BFosettlement set    
BrokApplied = (  case      
	when ( BFosettlement.billflag = 4  and broktable.val_perc ='V' )    
	Then     
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( bFosettlement.billFlag=4 and broktable.val_perc ='P' )    
	Then     
		((floor(( ((broktable.Normal/100) * (bfoclosing.cl_rate)) *     
		power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( bFosettlement.billflag = 5  and broktable.val_perc ='V' )    
	Then     
		((floor(( broktable.Normal * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))                           
	when ( BFosettlement.billflag = 5  and broktable.val_perc ='P' )    
	Then     
		((floor(( (broktable.Normal/100 *bfoclosing.cl_rate)* power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))                             
	Else      
		BrokApplied  
	End     
	),    
NetRate = (  case      
	when ( BFosettlement.billflag = 4  and broktable.val_perc ='V' )    
	Then     
		((floor(( (broktable.normal + bfoclosing.cl_rate) * power(10,Broktable.round_to)+broktable.roFig +     
		broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( bFosettlement.billflag = 4  and broktable.val_perc ='P' )    
	then    
		((floor(( ( ( bfoclosing.cl_rate+((broktable.normal/100)*bfoclosing.cl_rate))) * power(10,Broktable.round_to)+broktable.roFig +     
		broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    	
	when ( bFosettlement.billflag =5  and broktable.val_perc ='V' )    	
	then    
		((floor((  (bfoclosing.cl_rate- broktable.normal)* power(10,Broktable.round_to)+broktable.roFig +     
		broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    	
	when ( bFosettlement.billflag =5  and broktable.val_perc ='P' )    	
	then    
		((floor((  ((   (bfoclosing.cl_rate -((broktable.normal/100) * bfoclosing.cl_rate))    )) *     
		power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) *     
		(broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))    
	Else      
		NetRate     
	End     
	),    
Service_Tax  =  (case      	
	when ( bfosettlement.SettFlag = 4  and broktable.val_perc ='V' )    
	Then      
		((floor((     
		(((((floor((( broktable.normal)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /    
		power(10,Broktable.round_to))) * bfosettlement.Tradeqty * bFOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /    
		(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))        
	when ( bfosettlement.SettFlag = 4  and broktable.val_perc ='P' )    
	Then     
		((floor((     
		(((((floor((( (broktable.normal/100) *  (bfoclosing.cl_rate)) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /    
		power(10,Broktable.round_to))) * bfosettlement.Tradeqty * bFOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /    
		(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))        
	when ( bfosettlement.SettFlag = 5  and broktable.val_perc ='V' )    
	Then       
		((floor((     
		(((((floor((( broktable.normal)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /    
		power(10,Broktable.round_to))) * bfosettlement.Tradeqty * bFOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /    
		(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))        
	when ( bfosettlement.SettFlag = 5  and broktable.val_perc ='P' )    
	Then      
		((floor((     
		(((((floor((( (broktable.normal/100) * (bfoclosing.cl_rate)) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /    
		power(10,Broktable.round_to))) * bfosettlement.Tradeqty * bFOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /    
		(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))        
	Else  0     
	End  ),    
        Ins_chrg  = ((floor(( ((bfotaxes.insurance_chrg * (bfoclosing.cl_rate) * bfosettlement.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
			(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),    
        turn_tax  =  ((floor(( ((bfotaxes.turnover_tax * (bfoclosing.cl_rate) * bfosettlement.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
			  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    
			  power(10,broktable.round_to)),    
        other_chrg = ((floor(( ((bfotaxes.other_chrg * (bfoclosing.cl_rate) * bfosettlement.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  power(10,broktable.round_to)),    
        sebi_tax =     ((floor(( ((bfotaxes.sebiturn_tax *(bfoclosing.cl_rate) * bfosettlement.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),    
        Broker_chrg =  ((floor(( ((bfotaxes.broker_note * (bfoclosing.cl_rate) * bfosettlement.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to))    
        FROM 
		BrokTable,Client2,bFoTaxes,bFoGlobals,bFoScrip2,client1,bfoclosing    
        WHERE
		bFosettlement.Party_Code = Client2.Party_code    
		and client1.cl_code=client2.cl_code               
		and bfoSETTLEMENT.series_code = bfoscrip2.series_code    
		and bfoclosing.trade_Date=bfoscrip2.maturitydate    
		and bfoclosing.series_code=bfoscrip2.series_code    	
		AND Broktable.Table_no = ( case when (client2.Tran_cat = 'TRD')  then     
			client2.brok1_tableno              
			END )    
		And  Broktable.Line_no = ( case when (client2.Tran_cat = 'TRD')   then     
		(Select min(Broktable.line_no) from broktable where    
		Broktable.table_no = client2.brok1_tableno        
		and bFosettlement.Party_Code =  Client2.Party_code        
		And Trd_Del = 'D'    
		and bfoclosing.cl_rate <= Broktable.upper_lim )                
		end )
		And    
			(Client2.Tran_cat = bFoTaxes.Trans_cat)    
		And    
			(bFoTaxes.exchange = 'BSE')    	
		and client2.Tran_cat = 'TRD'    
		And (billflag = 4 or billflag = 5)    
		and bFosettlement.tradeqty > 0
		and bFosettlement.expirydate like  @expirydate  + '%'      
		and sauda_date between year_start_dt and year_end_dt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFODupRecCheck
-- --------------------------------------------------

CREATE proc [dbo].[BFODupRecCheck] As
insert into BFOtrade select * from BFOfttrade where trade_no not in 
(
	select tm.trade_no from BFOTrade tm
	where convert(varchar,BFOfttrade.sauda_date,106) = convert(varchar,tm.sauda_date,106)
	and BFOfttrade.trade_no = tm.trade_no
	 and BFOfttrade.order_no = tm.order_no
	and BFOfttrade.series_code = tm.series_code
	and BFOfttrade.tradeqty = tm.tradeqty
	and BFOfttrade.marketrate = tm.marketrate
	and BFOfttrade.sell_buy = tm.sell_buy
)


Update BFOtrade Set Party_Code = NewParty_Code From PartyMapping
Where Party_Code = OldParty_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bfoduprecinstTrade
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bfoduprecinstTrade    Script Date: 01/10/2003 7:33:13 PM ******/
CREATE proc [dbo].[bfoduprecinstTrade] as 
insert into BFOfttrade 
select Product_type,Product_code,'',TraderCode,Trade_no,Series_Id,Series_Code,Sell_Buy,tradeqty,marketrate,PartyCode,Cl_type,'','','',Sauda_date,Sauda_date,order_no,'','*',Reserved1,Reserved2,Reserved3,'','',MemberCode,'',''
from BFOinsttrade 
where trade_no not in 
 ( select tm.trade_no from BFOftTrade tm
      where convert(varchar,BFOinsttrade.sauda_date,106) = convert(varchar,tm.sauda_date,106)
         and BFOinsttrade.trade_no = tm.trade_no
         and BFOinsttrade.order_no = tm.order_no
 and BFOinsttrade.series_code = tm.series_code
 and BFOinsttrade.tradeqty = tm.tradeqty
 and BFOinsttrade.marketrate = tm.marketrate
 and BFOinsttrade.sell_buy = tm.sell_buy
  )
and  BFOinsttrade.status = 'C'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BfoDupRecSettCheck
-- --------------------------------------------------

CREATE proc [dbo].[BfoDupRecSettCheck] As
delete BFoTrade From BFoSettlement S where 
convert(varchar,bfotrade.Sauda_Date,106) = convert(varchar,s.sauda_date,106)
and replace(replace(REPLACE(replace(replace(replace(replace(replace(REPLACE(bfotrade.trade_no,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') = replace(replace(replace(replace(replace(replace(replace(replace(REPLACE(s.trade_no,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','')
and bfotrade.order_no =  S.Order_no
and bFOtrade.product_type=s.product_type
and bfotrade.product_code=s.product_code
and bfotrade.Series_Id = s.Series_Id
and bfotrade.Series_Code =s.Series_Code
and bfotrade.sell_buy = s.sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGENBILLNO
-- --------------------------------------------------

CREATE proc [dbo].[BFOGENBILLNO] (@BILLDATE VARCHAR(11)) AS
DECLARE @@BILLFLAG INT,
@@PARTY_CODE VARCHAR(10),
@@BILLNO INT,
@@BILLCUR CURSOR
print "test"
UPDATE BFOACCBILL SET BILL_NO = 0 WHERE BILLDATE LIKE @BILLDATE + '%'
select "test1"
update bfoaccbill set Start_Date=@BILLDATE +' 23:59:00',End_Date=@BILLDATE +' 23:59:00',PayIn_Date=@BILLDATE +' 23:59:00',PayOut_Date=@BILLDATE +' 23:59:00'  
where billdate  LIKE @BILLDATE + '%'
  select "test2"
SELECT @@BILLNO = 0 
SET @@BILLCUR = CURSOR FOR
SELECT ISNULL(COUNT(*),0) FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
OPEN @@BILLCUR 
FETCH NEXT FROM @@BILLCUR INTO @@BILLFLAG 
CLOSE @@BILLCUR
select "billflag" , @@BILLFLAG
IF @@BILLFLAG = 0 
BEGIN
  select "test3"
	SET  @@BILLCUR = CURSOR FOR
	SELECT A.PARTY_CODE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
	AND C.PARTY_CODE = A.PARTY_CODE ORDER BY A.PARTY_CODE
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
             select   "test4" ,@@PARTY_CODE
	SELECT @@BILLNO = 1
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		UPDATE BFOACCBILL SET BILL_NO = @@BILLNO WHERE BILLDATE LIKE @BILLDATE + '%' AND PARTY_CODE = @@PARTY_CODE
		SELECT @@BILLNO = @@BILLNO + 1
		FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	END	
END
ELSE
BEGIN
select "test5"
	UPDATE BFOACCBILL SET BILL_NO = bFOBILLNO.BILL_NO FROM bFOBILLNO WHERE bFOACCBILL.BILLDATE LIKE @BILLDATE + '%' 
	AND bFOACCBILL.BILLDATE = bFOBILLNO.BILLDATE AND BFOACCBILL.PARTY_CODE = BFOBILLNO.PARTY_CODE 
	
	SELECT @@BILLNO = 0 
	SET @@BILLCUR = CURSOR FOR
	SELECT ISNULL(MAX(BILL_NO),0)+1 FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@BILLNO
	CLOSE @@BILLCUR
           --  deallocate @@BILLCUR
	SET @@BILLCUR = CURSOR FOR
	SELECT A.PARTY_CODE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
	AND C.PARTY_CODE = A.PARTY_CODE AND BILL_NO = 0 ORDER BY A.PARTY_CODE
	OPEN @@BILLCUR 
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		UPDATE BFOACCBILL SET BILL_NO = @@BILLNO WHERE BILLDATE LIKE @BILLDATE + '%' AND PARTY_CODE = @@PARTY_CODE
		SELECT @@BILLNO = @@BILLNO + 1
		FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE
	END
END
INSERT INTO BFOBILLNO
SELECT DISTINCT A.PARTY_CODE,A.BILL_NO,BILLDATE FROM BFOACCBILL A,CLIENT2 C WHERE BILLDATE LIKE @BILLDATE + '%'
AND C.PARTY_CODE = A.PARTY_CODE AND A.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM BFOBILLNO WHERE 
BILLDATE = A.BILLDATE )
SET @@BILLCUR = CURSOR FOR
SELECT PARTY_CODE,BILL_NO FROM BFOBILLNO WHERE BILLDATE LIKE @BILLDATE + '%'
AND PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM BFOACCBILL WHERE BILLDATE = BFOBILLNO.BILLDATE )
OPEN @@BILLCUR 
FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE,@@BILLNO
WHILE @@FETCH_STATUS = 0 
BEGIN
	INSERT INTO BFOACCBILL
	/*SELECT @@PARTY_CODE,@@BILLNO,1,Sett_No,Sett_Type,BillDate,Start_Date,End_Date,PayIn_Date,PayOut_Date,0,expiryflag,Reserved1,Reserved2,Reserved3,Branchcd,Narration FROM FOACCBILL 
	WHERE PARTY_CODE = '99885' AND BILLDATE LIKE @BILLDATE + '%'*/
        
        SELECT @@PARTY_CODE,@@BILLNO,1,Sett_No,Sett_Type,BillDate,Start_Date,End_Date,PayIn_Date,PayOut_Date,Amount,MTM,PREMIUMPAYABLE,PREMIUMRECEIVABLE,NETPREMIUM,BROKERAGE,SERVICETAX,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5,branchcd,Narration FROM BFOACCBILL 
	WHERE PARTY_CODE = ( select AcCode from ValanAccount A where
                               EffDate = (Select mAX(EffDate) from valanAccount V
                                          Where EffDate <=@BILLDATE AND A.ACNAME=V.ACNAME) 
                             and acName ='CLEARING HOUSE') AND BILLDATE LIKE @BILLDATE + '%'
        
	FETCH NEXT FROM @@BILLCUR INTO @@PARTY_CODE,@@BILLNO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGenContract
-- --------------------------------------------------

CREATE procEDURE BFOGenContract  
AS   
Declare @@Party varchar(12),  
	@@Sett_Type varchar(2),    
	@@ContNo varchar(7),  
	@@ContNoPartiPant varchar(7),  
	@@ParticiPantCode Varchar(15),  
	@@MemberCode Varchar(15),  
	@@Sauda_Date Varchar(11),  
	@@Order_no Varchar(16),  
	@@Scrip_Cd Varchar(12),  
	@@Series Varchar(2),  
	@@Sell_buy Int,  
	@@Style int,  
	@@StartDate varchar(11),  
	@@EndDate Varchar(11),  
	@@Flag int,  
	@@Cont Cursor  ,    
	@@PartyCont Cursor    ,  
	@@CurSettType Varchar(2), 	
	@@inscontno varchar(7),  
	@@expirydate datetime,  
	@@strikeprice money,  
	@@optiontype varchar(2),        
	@@product_type varchar(6),  
	@@product_code varchar(12),  
	@@series_code varchar(12),  
	@@series_id int,	
	@@MaxContNoS Int,  
	@@MaxConnoI  Int,  
	@@BBGcontcur Cursor,  
	@@getmaxcontno cursor,  
	@@Inscont   Varchar(4),  
	@@Cl_Rate Numeric(18,4)  
  
Set @@PartyCont = Cursor for  
     Select Distinct sauda_date = Left(Convert(Varchar,Sauda_date,109),11) from bfotrade   
     Open @@PartyCont  
     Fetch next from @@PartyCont into @@sauda_date  
Close @@PartyCont  
       
Set @@PartyCont = cursor for   
    Select MemberCode,Style=IsNull(Style,0) from BfoOwner  
    Open @@PartyCont  
    Fetch next  from @@PartyCont into @@MemberCode,@@Style  
Close @@PartyCont  
  
Truncate table bbgbfosettlement  



insert into bbgbfosettlement  
select '0000000',MarketLot,Trade_no, Party_Code,product_type,product_code,Series_code,Series_id,expirydate,multiplier,  
user_id,tradeqty,0,trans_type,0, order_no, MarketRate,strikeprice,Sauda_date, Table_No, Line_No, Val_perc,   
Normal ,  Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy,settflag, Brokapplied,NetRate,Amount, Ins_chrg,  
turn_tax,other_chrg,sebi_tax, Broker_chrg,Service_tax, Trade_amount, 1, 0,0 , 0 ,0 ,  
0,cl_type,order_date,OppMemCode,OppTradercode,0,groupid,tradercode,  
(Case When Cl_Type = 'I' Then 1 Else 0 End),0,0,0,0,'0','0','0','0','0','0','0','0','0','0',0,MarketRate  
from bfoconfirmview  
  
If @@Style = 0  
Begin  
     Set @@BBGContcur =  Cursor for  
     Select isnull(Max(Convert(Int,Contractno)),0) From bfosettlement  
     Where sauda_Date like  @@Sauda_date +'%'  
     and convert(int,contractno) <> 0  
End  
  
If @@Style = 1   
Begin  
     Set @@BBGContcur = Cursor for   
     Select isnull(Convert(int,Contractno),0) From ContGen Where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date       
End   
                     
Open @@BBGcontcur  
Fetch next from @@BBGcontcur into @@MaxcontNos  
Close @@BBGcontCur  
     Set @@Partycont = cursor for  
     Select Distinct I.Party_code,I.Contractno,I.Order_no,product_type,product_code,  
     Series_code,Series_id,expirydate,i.strike_price,InsCont   
     From bfosettlement I ,Client2 C2   
     Where I.Sauda_date like @@Sauda_date +'%'    
     and I.Party_code = C2.Party_code   
     and convert(int,i.contractno) <> 0  
     Order by I.Party_code,product_type,product_code,Series_code,Series_id,expirydate,i.strike_price,I.Order_no,I.Contractno  
     open @@PartyCont  
     Fetch next from @@PartyCont into @@Party,@@contno,@@Order_no,@@product_type,@@product_code,@@series_code,  
     @@series_id,@@expirydate,@@strikeprice,@@Inscont  
     While @@fetch_status = 0  
     Begin  
          If @@InsCont = 'N' or @@inscont is null or @@inscont = ''  
          Begin  
               Update bbgbfosettlement set Contractno = @@Contno   
               Where  
               Party_code = @@Party  
          End  
          If @@InsCont = 'O'   
    Begin   
               Update bbgbfosettlement set Contractno = @@Contno   
               Where  
               Party_code = @@Party  
               and  
              Order_no = @@Order_no  
          End  
          If @@InsCont = 'S'   
          Begin   
               Update bbgbfosettlement set Contractno = @@Contno   
		Where  
		Party_code = @@Party  
		and  
		product_type = @@product_type  
		and  
		product_code = @@product_code  
		and  
		Series_code = @@Series_code   
		and   
		Series_id   = @@Series_id  
		and  
		expirydate = @@expirydate  
		and  
		strike_price = @@strikeprice               
          End  
     Fetch next from @@PartyCont into @@Party,@@contno,@@Order_no,@@product_type,@@product_code,@@series_code,  
     @@series_id,@@expirydate,@@strikeprice,@@Inscont  
     End       
     Close @@Partycont  
     Select @@Party=''  
          
     Set @@PartyCont = cursor for   
     Select Distinct bbgbfosettlement.Party_Code  From bbgbfosettlement,Client2,client1   
     Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code   
     and inscont = 'N' and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
     order by bbgbfosettlement.party_code   
     open @@PartyCont  
     Fetch next  from @@PartyCont into   @@Party  
     While @@fetch_status = 0  
     Begin  
          Select @@ContNo =@@Maxcontnos +1  
          Select @@Maxcontnos = @@Maxcontnos + 1  
          Select @@Party,@@ContNo  
          Update bbgbfosettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where  
          Party_code =@@Party   
          fetch next  from @@PartyCont into @@Party  
     End  
     Close @@PartyCont  
     Select @@Party=''  
  
     Set @@PartyCont = cursor for   
     Select distinct bbgbfosettlement.Party_Code,bbgbfosettlement.Order_no From bbgbfosettlement,Client2,client1  
     Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code  
     and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
     and inscont  =  'O'  
     Order by bbgbfosettlement.party_code,bbgbfosettlement.Order_no    
     Open @@PartyCont  
     Fetch next  from @@PartyCont into @@Party,@@Order_no  
     While @@fetch_status = 0  
     Begin  
          Select @@ContNo = 0  
          Select @@ContNo =@@Maxcontnos +1  
          Select @@Maxcontnos = @@Maxcontnos + 1  
          Update bbgbfosettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where  
          Party_code =@@Party   
          and Order_no = @@Order_no  
          Fetch next  from @@PartyCont into  @@Party,@@Order_no  
     End  
  
     Close @@PartyCont  
     Select @@Party=''  
     select @@order_no = ''   
        
        Set @@PartyCont = cursor for   
        Select Distinct bbgbfosettlement.Party_Code,product_type,product_code,  
        Series_code,Series_id,expirydate,strike_price   
 from bbgbfosettlement,Client2,client1  
 Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code and inscont =  'S'  
      and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
        order by bbgbfosettlement.party_code,product_type,product_code,  
        Series_code,Series_id,expirydate,strike_price  
        open @@PartyCont  
        Fetch next from @@PartyCont into @@Party,@@product_type,@@product_code,@@series_code,  
        @@series_id,@@expirydate,@@strikeprice  
        While @@fetch_status = 0  
        Begin  
		Select @@ContNo = 0  
		Select @@ContNo =@@Maxcontnos +1  
		Select @@Maxcontnos = @@Maxcontnos + 1  
		Update bbgbfosettlement set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) where  
		Party_code = @@Party  
		and  
		product_type = @@product_type  
		and  
		product_code = @@product_code  
		and  
		Series_code = @@Series_code   
		and   
		Series_id   = @@Series_id  
		and  
		expirydate = @@expirydate  
		and  
		strike_price = @@strikeprice    
        Fetch next from @@PartyCont into @@Party,@@product_type,@@product_code,@@series_code,  
        @@series_id,@@expirydate,@@strikeprice  
        End  
        Close @@PartyCont  
 DeAllocate @@PartyCont  
 Update Bfoowner set contno = @@ContNo   

If @@style = 1   
	begin   
	Update ContGen set ContractNo = @@ContNo Where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date   
	end  
insert into bfosettlement select * from bbgbfosettlement  
  
Set @@PartyCont = Cursor for  
select distinct series_code from bfotrade  
Open @@PartyCont  
Fetch Next From @@PartyCont into @@Series_Code  
While @@Fetch_Status = 0   
Begin  
    Select @@Cl_Rate = 0      
    Set @@BBGcontcur = Cursor For    
    select distinct s1.cl_rate from bfoclosing s1   
    where s1.series_code = @@Series_Code AND trade_date Like @@sauda_Date + '%'  
    Open @@BBGcontcur  
    Fetch Next From @@BBGcontcur into @@Cl_Rate      
    If @@Fetch_Status <> 0  
 Select @@cl_rate = 0  
    Close @@BBGcontcur  
    DeAllocate @@BBGcontcur   
    Update bfosettlement   
    Set cl_rate= @@Cl_Rate  
    Where series_code = @@Series_Code AND Sauda_Date Like @@sauda_Date + '%'  
    Fetch Next From @@PartyCont into @@Series_Code  
End  
Close @@PartyCont  
DeAllocate @@PartyCont  
  
truncate table  bfotrade

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOGenContract_Expiry
-- --------------------------------------------------

CREATE  procEDURE BFOGenContract_Expiry  
AS   
Declare @@Party varchar(12),  
	@@Sett_Type varchar(2),    
	@@ContNo varchar(7),  
	@@ContNoPartiPant varchar(7),  
	@@ParticiPantCode Varchar(15),  
	@@MemberCode Varchar(15),  
	@@Sauda_Date Varchar(11),  
	@@Order_no Varchar(16),  
	@@Scrip_Cd Varchar(12),  
	@@Series Varchar(2),  
	@@Sell_buy Int,  
	@@Style int,  
	@@StartDate varchar(11),  
	@@EndDate Varchar(11),  
	@@Flag int,  
	@@Cont Cursor  ,    
	@@PartyCont Cursor    ,  
	@@CurSettType Varchar(2), 	
	@@inscontno varchar(7),  
	@@expirydate datetime,  
	@@strikeprice money,  
	@@optiontype varchar(2),        
	@@product_type varchar(6),  
	@@product_code varchar(12),  
	@@series_code varchar(12),  
	@@series_id int,	
	@@MaxContNoS Int,  
	@@MaxConnoI  Int,  
	@@BBGcontcur Cursor,  
	@@getmaxcontno cursor,  
	@@Inscont   Varchar(4),  
	@@Cl_Rate Numeric(18,4)  
  
Set @@PartyCont = Cursor for  
     Select Distinct sauda_date = Left(Convert(Varchar,Sauda_date,109),11) from bbgbfosettlement   
     Open @@PartyCont  
     Fetch next from @@PartyCont into @@sauda_date  
Close @@PartyCont  
       
Set @@PartyCont = cursor for   
    Select MemberCode,Style=IsNull(Style,0) from BfoOwner  
    Open @@PartyCont  
    Fetch next  from @@PartyCont into @@MemberCode,@@Style  
Close @@PartyCont  
  
 
If @@Style = 0  
Begin  
     Set @@BBGContcur =  Cursor for  
     Select isnull(Max(Convert(Int,Contractno)),0) From bfosettlement  
     Where sauda_Date like  @@Sauda_date +'%'  
     and convert(int,contractno) <> 0  
End  
  
If @@Style = 1   
Begin  
     Set @@BBGContcur = Cursor for   
     Select isnull(Convert(int,Contractno),0) From ContGen Where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date       
End   
                     
Open @@BBGcontcur  
Fetch next from @@BBGcontcur into @@MaxcontNos  
Close @@BBGcontCur  
     Set @@Partycont = cursor for  
     Select Distinct I.Party_code,I.Contractno,I.Order_no,product_type,product_code,  
     Series_code,Series_id,expirydate,i.strike_price,InsCont   
     From bfosettlement I ,Client2 C2   
     Where I.Sauda_date like @@Sauda_date +'%'    
     and I.Party_code = C2.Party_code   
     and convert(int,i.contractno) <> 0  
     Order by I.Party_code,product_type,product_code,Series_code,Series_id,expirydate,i.strike_price,I.Order_no,I.Contractno  
     open @@PartyCont  
     Fetch next from @@PartyCont into @@Party,@@contno,@@Order_no,@@product_type,@@product_code,@@series_code,  
     @@series_id,@@expirydate,@@strikeprice,@@Inscont  
     While @@fetch_status = 0  
     Begin  
          If @@InsCont = 'N' or @@inscont is null or @@inscont = ''  
          Begin  
               Update bbgbfosettlement set Contractno = @@Contno   
               Where  
               Party_code = @@Party  
          End  
          If @@InsCont = 'O'   
    Begin   
               Update bbgbfosettlement set Contractno = @@Contno   
               Where  
               Party_code = @@Party  
               and  
              Order_no = @@Order_no  
          End  
          If @@InsCont = 'S'   
          Begin   
               Update bbgbfosettlement set Contractno = @@Contno   
		Where  
		Party_code = @@Party  
		and  
		product_type = @@product_type  
		and  
		product_code = @@product_code  
		and  
		Series_code = @@Series_code   
		and   
		Series_id   = @@Series_id  
		and  
		expirydate = @@expirydate  
		and  
		strike_price = @@strikeprice               
          End  
     Fetch next from @@PartyCont into @@Party,@@contno,@@Order_no,@@product_type,@@product_code,@@series_code,  
     @@series_id,@@expirydate,@@strikeprice,@@Inscont  
     End       
     Close @@Partycont  
     Select @@Party=''  
          
     Set @@PartyCont = cursor for   
     Select Distinct bbgbfosettlement.Party_Code  From bbgbfosettlement,Client2,client1   
     Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code   
     and inscont = 'N' and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
     AND bbgbfosettlement.product_code not like 'OPT%'
     order by bbgbfosettlement.party_code   
     open @@PartyCont  
     Fetch next  from @@PartyCont into   @@Party  
     While @@fetch_status = 0  
     Begin  
          Select @@ContNo =@@Maxcontnos +1  
          Select @@Maxcontnos = @@Maxcontnos + 1  
          Select @@Party,@@ContNo  
          Update bbgbfosettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where  
          Party_code =@@Party   
          fetch next  from @@PartyCont into @@Party  
     End  
     Close @@PartyCont  
     Select @@Party=''  
  
     Set @@PartyCont = cursor for   
     Select distinct bbgbfosettlement.Party_Code,bbgbfosettlement.Order_no From bbgbfosettlement,Client2,client1  
     Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code  
     and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
     AND bbgbfosettlement.product_code not like 'OPT%'
     and inscont  =  'O'  
     Order by bbgbfosettlement.party_code,bbgbfosettlement.Order_no    
     Open @@PartyCont  
     Fetch next  from @@PartyCont into @@Party,@@Order_no  
     While @@fetch_status = 0  
     Begin  
          Select @@ContNo = 0  
          Select @@ContNo =@@Maxcontnos +1  
          Select @@Maxcontnos = @@Maxcontnos + 1  
          Update bbgbfosettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where  
          Party_code =@@Party   
          and Order_no = @@Order_no  
          Fetch next  from @@PartyCont into  @@Party,@@Order_no  
     End  
  
     Close @@PartyCont  
     Select @@Party=''  
     select @@order_no = ''   
        
        Set @@PartyCont = cursor for   
	Select Distinct bbgbfosettlement.Party_Code,product_type,product_code,  
	Series_code,Series_id,expirydate,strike_price   
	from bbgbfosettlement,Client2,client1  
	Where convert(int,contractno) = 0  and bbgbfosettlement.party_code = client2.party_code and inscont =  'S'  
	and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'  
	AND bbgbfosettlement.product_code not like 'OPT%'
	order by bbgbfosettlement.party_code,product_type,product_code,  

        Series_code,Series_id,expirydate,strike_price  
        open @@PartyCont  
        Fetch next from @@PartyCont into @@Party,@@product_type,@@product_code,@@series_code,  
        @@series_id,@@expirydate,@@strikeprice  
        While @@fetch_status = 0  
        Begin  
		Select @@ContNo = 0  
		Select @@ContNo =@@Maxcontnos +1  
		Select @@Maxcontnos = @@Maxcontnos + 1  
		Update bbgbfosettlement set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) where  
		Party_code = @@Party and  
		product_type = @@product_type and  
		product_code = @@product_code and  
		Series_code = @@Series_code and   
		Series_id   = @@Series_id and  
		expirydate = @@expirydate and  
		strike_price = @@strikeprice    
        Fetch next from @@PartyCont into @@Party,@@product_type,@@product_code,@@series_code,  
        @@series_id,@@expirydate,@@strikeprice  
        End  
        Close @@PartyCont  
 DeAllocate @@PartyCont  
 Update Bfoowner set contno = @@ContNo   

If @@style = 1   
	begin   
	Update ContGen set ContractNo = @@ContNo Where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date   
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bfoImpTrdSpChg
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.bfoImpTrdSpChg    Script Date: 01/10/2003 7:33:12 PM ******/
/****** Object:  Stored Procedure dbo.bfoImpTrdSpChg    Script Date: 10/13/2001 3:50:04 AM ******/
CREATE proc  [dbo].[bfoImpTrdSpChg] 
 (@partycode varchar(7),
  @userid varchar(5)
  )
 as
 /*Used in bSE FO */ 
 /*Control Name :bFoImportTrade Module Name :CmdPSave_Click()*/
 /*table used :write only foTrade*/
 /*Function:This used to missing client i.e the clients partycode prsernt in the fotrade table but not in client2 table*/            
 /*Written By :Ranjeet Choudhary */
 update bfotrade set party_code = @partycode
 where user_id =@userid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BfoInsertInstTrd
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BfoInsertInstTrd    Script Date: 01/10/2003 7:33:00 PM ******/
CREATE procedure [dbo].[BfoInsertInstTrd]
       @FileDate                 datetime            = null,   
       @Product_Code             varchar(7)          = null,   
       @Product_Type             varchar(5)          = null,   
       @Series_Id                int                 = null,   
       @SeriesCode               varchar(14)         = null,   
       @SellBuy                  int                 = null,   
       @Quantity                 int                 = null,   
       @Price                    money               = null,   
       @PartyCode                varchar(10)         = null,   
       @MemberCode               varchar(10)         = null,   
       @TraderCode               varchar(10)         = null,   
       @Trade_no                 varchar(20)         = null,   
       @Sauda_date               datetime            = null,   
       @Status                   varchar(5)          = null,   
       @order_no                 varchar(20)         = null,   
       @cl_type             varchar(3)  = null,
       @Reserved1                varchar(10)         = null,   
       @Reserved2                varchar(10)         = null,   
       @Reserved3                varchar(10)         = null    
as
       declare @procname varchar(50)
       select @procname = object_name(@@procid)
       begin transaction trnInstrade
              begin
                     insert into bfoinsttrade(
                                          FileDate,
                                          Product_Code,
                                          Product_Type,
                                          Series_Id,
                                          Series_Code,
                                          Sell_Buy,
                                          Tradeqty,
                                         Marketrate,
                                          PartyCode,
                                          MemberCode,
                                          TraderCode,
                                          Trade_no,
                                          Sauda_date,
                                          Status,
                                          order_no,
                                          cl_type, 
                                          Reserved1,
                                          Reserved2,
                                          Reserved3
                                          )
                     select
                                          @FileDate,
                                          @Product_Code,
                                          @Product_Type,
                                          @Series_Id,
                                          @SeriesCode,
                                          @SellBuy,
                                          @Quantity,
                                          @Price,
                                          @PartyCode,
                                          @MemberCode,
                                          @TraderCode,
                                          @Trade_no,
                                          @Sauda_date,
                                          @Status,
                                          @order_no,
                                          @cl_type,
                                          @Reserved1,
                                          @Reserved2,
                                          @Reserved3
                     if @@error != 0
                            begin
                                   rollback transaction trnInstrade
                                   raiserror('Error inserting into table bfoinsttrade.  Error occurred in procedure %s.  Rolling back transaction...', 16, 1, @procname)
                                   return
                            end
                     else
                            begin
                                   commit transaction trnInstrade
                            end
              end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOINSTRearrangeAfterContflag
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFOINSTRearrangeAfterContflag    Script Date: 01/10/2003 7:32:58 PM ******/
CREATE procEDURE [dbo].[BFOINSTRearrangeAfterContflag] 
@Party_code Varchar(10),
@product_type varchar(3),
@product_code varchar(10),
@series_code varchar(13),
@expirydate varchar(11),
@series_id int,
@TDate Varchar(11)
AS 
declare 
 @@trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@loop cursor
	Update BFosettlement set settflag = (case when s.sell_buy = 1 then 2
						else 3 end )
	from BFosettlement s,BFOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.product_code = b.product_code
	and b.product_type = b.product_type
	and b.series_code = s.series_code
	and b.expirydate = s.expirydate
	and b.series_id = b.series_id
	AND b.sqty<> 0 and b.pqty <>  0 
	and s.party_code = @party_code
	and s.product_code = @product_code
	and s.product_type = @product_type
	and s.series_code = @series_code
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and s.series_id = @series_id
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   
	
	Update BFosettlement set settflag = 4 from BFosettlement s,BFOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.product_code = b.product_code
	and b.product_type = b.product_type
	and b.series_code = s.series_code
	and b.expirydate = s.expirydate
	and b.series_id = b.series_id
	AND  b.sqty = 0 and b.pqty >  0 
	and s.party_code = @party_code
	and s.product_code = @product_code
	and s.product_type = @product_type
	and s.series_code = @series_code
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and s.series_id = @series_id
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   
	Update BFosettlement set settflag = 5 from BFosettlement s,BFOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.product_code = b.product_code
	and b.product_type = b.product_type
	and b.series_code = s.series_code
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and b.series_id = b.series_id
	AND  b.sqty > 0 and b.pqty =  0 
	and s.party_code = @party_code
	and s.product_code = @product_code
	and s.product_type = @product_type
	and s.series_code = @series_code
	and s.expirydate = @expirydate
	and s.series_id = @series_id
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   
set @@Flag = cursor for
	 select pqty,sqty from BFOCursorContUnEqualSalePur
	 where party_code = @party_code and product_code = @product_code
	 and product_type = @product_type and series_code = @series_code
	 and left(convert(varchar,expirydate,109),11) = @expirydate
	 and series_id = @series_id
	 and left(convert(varchar,sauda_date,109),11) = @Tdate   
	 and pqty <> 0 AND  sqty <> 0 and isnull(pqty,0) <> isnull(sqty,0)
	 group by pqty,sqty
open @@flag
fetch next from @@Flag into @@Pqty,@@sqty
if @@fetch_status = 0 	
	begin
		While @@fetch_status = 0 
		begin
			if @@Pqty > @@Sqty 
		        	begin 
				select @@pdiff = @@Pqty - @@Sqty 
				  /*Find a trade whose tradeqty = the diff in paty and sqty and update it with setflag = 4 */	
				set @@Loop  = cursor for 
					select trade_no,tradeqty from BFosettlement 
					where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 1 and tradeqty = @@Pdiff 
				 open @@loop
				 fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				 if @@fetch_status = 0 
				 begin 
					update BFosettlement set settflag = 4   
					where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  
				close @@Loop
				deallocate @@Loop 
			  	end
			  	else if @@fetch_status <> 0  
			 	begin 
					close @@Loop
				   	deallocate @@Loop  
				   	set @@Loop  = cursor for 
						select trade_no,tradeqty from BFosettlement 
					   	where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
		   			        and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id 
						and left(convert(varchar,sauda_date,109),11) = @Tdate   and sell_buy = 1 
						order by tradeqty Desc
				   	open @@loop
				  	fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				  	while @@pdiff > 0       
				  	begin
						if @@pdiff >= @@Lqty 	
	                                        begin
					     		update BFosettlement set settflag = 4   
							where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  
					     		select @@pdiff = @@Pdiff - @@Lqty
						end    
					        else if @@pdiff < @@Lqty 
			    			begin
							
 							
							Insert into Bfosettlement select Contractno,BillNo,'B'+Trade_no,Party_Code,product_type,product_code,series_code,series_id,Expirydate,multiplier,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,marketrate,strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,4,Brokapplied,NetRate,Amount = (@@Pdiff * NetRate),Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount= (@@Pdiff * marketrate),Billflag,
							sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_Rate,GroupId,TraderCode,reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,Pro_cli,ParticipantCode,CpId,Instrument,BookType,Branch_Id,Scheme,TMark ,dummy1,dummy2  
							from Bfosettlement where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
							and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty   	
				     		        update BFosettlement set settflag = 2,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*marketrate    
				    		        where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty 
							select @@Pdiff = 0   
						end 
			    			fetch next from @@Loop into @@Ltrade_no,@@Lqty
			   		end
		   			close @@Loop
				end    
 			end
			else if @@Pqty < @@Sqty
			begin 
				select @@pdiff = @@sqty - @@pqty
 				set @@Loop  = cursor for 
				select trade_no,tradeqty from BFosettlement 
        	     	        where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
				and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
				and sell_buy = 2 and tradeqty = @@Pdiff 
 				
				open @@loop
			  	 fetch next from @@Loop into @@Ltrade_no,@@Lqty     
			 	 if @@fetch_status = 0 
				 begin
 				 	update BFosettlement set settflag = 5  
  				  	where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 
			 		
					close @@Loop
				 	deallocate @@Loop 
			  	end
				else if @@fetch_status <> 0  
			 	begin 
					close @@Loop
				   	deallocate @@Loop  
				   	set @@Loop  = cursor for 
				    	select trade_no,tradeqty from BFosettlement 
					where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
		   			and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 2 
					order by tradeqty Desc
				   	open @@loop
					fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				  	while @@pdiff > 0       
				   	begin
						if @@pdiff >= @@Lqty 
						begin
							update BFosettlement set settflag = 5   
						    	where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
							and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  
						     	
							select @@pdiff = @@Pdiff - @@Lqty
					   	 end    
					    	 else if @@pdiff < @@Lqty 
					    	 begin	
							
	     						
						     	Insert into Bfosettlement select Contractno,BillNo,'B'+Trade_no,Party_Code,product_type,product_code,series_code,series_id,Expirydate,multiplier,User_id,@@Pdiff,AuctionPart,MarketType,Series,Order_no,marketrate,strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,5,Brokapplied,NetRate,Amount = (@@Pdiff * NetRate),Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount= (@@Pdiff * marketrate),Billflag,
							sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_Rate,GroupId,TraderCode,reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,Pro_cli,ParticipantCode,CpId,Instrument,BookType,Branch_Id,Scheme,TMark ,dummy1,dummy2  
							from Bfosettlement where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
							and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty   	
							update BFosettlement set settflag = 3,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*marketrate    
				    		        where party_code = @party_code and product_code = @product_code and product_type = @product_type and series_code = @series_code
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and series_id = @series_id and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 
     						    	select @@Pdiff = 0   
					   	 end 
					    	fetch next from @@Loop into @@Ltrade_no,@@Lqty
				   	end
 				  	close @@Loop
				  end	
			 end 
			 fetch next from @@Flag into @@Pqty,@@sqty
		end 
		close @@Flag
		deallocate @@Flag
	end
/**exec BFOSettBrokUpdate @TDate,@Party_code,@product_code,@product_type,@series_code,@expirydate,@series_id*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoRearrangeBillflag
-- --------------------------------------------------

CREATE   PROCEDURE BFoRearrangeBillflag
(@ExpiryDate smalldatetime) 

AS 


declare  
@@expdate varchar(11),  
@@selfotrade Cursor,  
@@MyPKey  Int,  
@@Product_Type varchar(2),
@@Product_Code varchar(10),
@@series_code varchar(13),      
@@series_id varchar(10),
@@SecName varchar(20),  
@@expirydate smalldatetime,  
@@MySettno Int,  
@@participantcode varchar(15),  
@@branchid varchar(10),  
@@activitytime smalldatetime,  
@@sellbuy int,  
@@procli int,  
@@price money,  
@@partycode varchar(10),  
@@membercode varchar(6),  
@@tradeqty as int,  
@@GetExpiryDate as cursor,  
@@TempExpirydate as smalldatetime,  
@@TempSaudadate as varchar(11)

SET @@membercode = (select ltrim(rtrim(isnull(membercode,''))) from Bfoowner)  

UPDATE BFOSCRIP2 SET maturitydate = left(convert(varchar,maturitydate,109),11) + ' 23:59'  
WHERE maturitydate <> left(convert(varchar,maturitydate,109),11) + ' 23:59'  

 
SET @@GetExpiryDate=CURSOR FOR 
SELECT DISTINCT 
	left(convert(varchar,EXPIRYDATE,109),11), 
	left(convert(varchar,maturitydate,109),11) 
From 
	BFoscrip2 
Where 
	Maturitydate=@ExpiryDate 

OPEN @@GetExpiryDate  
FETCH NEXT FROM @@GetExpiryDate into @@TempExpirydate,@@TempSaudadate  
  
While @@Fetch_Status=0 and @@TempExpirydate=@@TempExpirydate and @@TempSaudadate=@@TempSaudadate  
  
 Begin  
		SET @ExpiryDate=''  
		SET @ExpiryDate=@@TempExpirydate  
		
		SET @@expdate = (select left(convert(varchar,@expirydate,109),11))  
		SET @@MyPkey = 0  
		
		truncate table bfoSettlementExpiry    
		
		
		insert into BFosettlementExpiry 
		Select
			ContractNo,BillNo,Trade_no,Party_Code,product_type,
			product_code,Series_code,Series_id,expirydate,multiplier,
			User_id,Tradeqty,AuctionPart,MarketType,Series,Order_no,MarketRate,
			strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,
			Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,
			Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,
			Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,
			Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_rate,GroupId,TraderCode,
			reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,pro_cli,
			participantcode,cpid,instrument,booktype,branch_id,scheme,tmark,dummy1,dummy2
		From
			BFosettlement 
		where
			sauda_date like @@TempSaudadate + '%' 
			and expirydate like @@expdate +'%' 
			and ((auctionpart = 'EA' and Product_Code like '%FUT') 
				or (auctionpart = 'CA' and Product_Code like '%OPT'))
		

		Delete from 
			BFosettlement 
		where 
			Sauda_date like @@TempSaudadate + '%' 
			and expirydate like @@expdate +'%' 
			and ((auctionpart = 'EA' and Product_Code like '%FUT') 
				or (auctionpart = 'CA' and Product_Code like '%OPT'))
		
		truncate table BFoTrade   
		
		select 
			product_type,
			product_code,
			Series_code,
			Series_id,
			ExpiryDate,
			cl_rate 
		into
			#BFoClosing
		from 
			bFoClosing
		where 
			trade_date  like @@TempSaudadate +'%'  
			and expiryDate like  @@expdate+'%'

		Set @@selFoTrade = cursor for  
		Select e.Product_Type,e.Product_Code,e.Series_Code,e.Series_Id,e.ExpiryDate,
		sbflag = (case when sum(pqty-sqty) > 0 then 2 else 1 end),  
		netqty= abs(sum(pqty-sqty)),  
		price = Case Right(e.Product_Code,3) when 'FUT' then
		isnull(#BFoClosing.Cl_rate,0) else 0 end,  
		pro_cli = (case when ltrim(rtrim(party_code))=@@membercode then '2' else '1' end),  
		party_code,participantcode,@@expdate+' 23:30:00',party_code
		from 
		(
			Select
				S.Party_Code,s.Product_Type,s.Product_Code,s.Series_Code,s.Series_Id,
				s.Expirydate,
				Pqty = sum( Case When Sell_Buy = 1 Then S.Tradeqty Else 0 End ),  
				Sqty = sum( Case When Sell_Buy = 2 Then S.Tradeqty Else 0 End ),
				Participantcode = @@membercode
			From 
				BFoSettlement S,
				Bfoscrip2 F    
			where  
				 f.expirydate like  @@expdate+'%'  
				and f.Product_Type = s.Product_Type 
				and F.Product_Code=s.Product_Code   
				and F.Series_Code=s.Series_Code 
				and F.Series_Id =s.Series_Id   
				and Left(s.ExpiryDate,11)=Left(f.ExpiryDate,11)
				and f.maturitydate like @@TempSaudadate +'%'  
				And s.Sauda_Date <= @@TempSaudadate + ' 23:59'
				and S.Reserved1 = '0' 
				and S.expirydate like  @@expdate+'%'  
			Group By 
				S.Party_Code,s.Product_Type,s.Product_Code,s.Series_Code,s.Series_Id,s.Expirydate 
		) E 
		left outer join 
		#BFoClosing
		on 
		(
			#BFoClosing.Product_Type = E.Product_Type 
			and #BFoClosing.Product_Code=E.Product_Code   
			and #BFoClosing.Series_Code=E.Series_Code 
			and #BFoClosing.Series_Id =E.Series_Id   
			and left(#BFoClosing.ExpiryDate,11)=Left(E.ExpiryDate,11)
		)
		group by party_code,E.Product_Type,e.Product_Code,e.Series_Code,e.Series_Id,
			e.expirydate,participantcode,#BFoClosing.Cl_rate
		having sum(pqty - sqty)  <> 0  
		order by party_code,E.Product_Type,e.Product_Code,e.Series_Code,e.Series_Id	
		
		Open @@SelFoTrade  
		Fetch next from @@SelFoTrade into 
		@@Product_Type,@@Product_Code,@@Series_Code,@@Series_Id,@@expirydate,
		@@sellbuy,@@tradeqty,@@price,@@procli,@@partycode,@@participantcode,@@activitytime,@@branchid  
		
		set @@Mypkey = @@Mypkey + 1  
		
		While @@Fetch_Status = 0 and  @@partycode=@@partycode AND @@Series_Code = @@Series_Code
		begin  
		
			Insert into Bfotrade values(@@Product_Type,@@Product_Code,'1','',9000000000+@@MyPkey,
				@@Series_Id,@@Series_Code,@@SellBuy,@@TradeQty,@@Price,@@PartyCode,'',
				@@MemberCode,@@participantcode,'L',@@ActivityTime,@@ActivityTime,'',
				Case When @@sellbuy = 1 then 4 else 5 end,'',0,0,0,0,0,@@MemberCode,'',@@PartyCode)
	
			Fetch next from @@SelFoTrade into 
			@@Product_Type,@@Product_Code,@@Series_Code,@@Series_Id,@@expirydate,
			@@sellbuy,@@tradeqty,@@price,@@procli,@@partycode,@@participantcode,@@activitytime,@@branchid  

		end  
		deallocate @@SelFoTrade  
		
		truncate table bbgbfosettlement    		

		insert into bbgbfosettlement  
		Select
			'0000000',MarketLot,Trade_no, Party_Code,product_type,product_code,Series_code,Series_id,expirydate,multiplier,  
			user_id,tradeqty,AuctionPart,trans_type,0, order_no, MarketRate,strikeprice,Sauda_date, Table_No, Line_No, Val_perc,   
			Normal ,  Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy,settflag, Brokapplied,NetRate,Amount, Ins_chrg,  
			turn_tax,other_chrg,sebi_tax, Broker_chrg,Service_tax, Trade_amount, 1, 0,0 , 0 ,0 ,  
			0,cl_type,order_date,OppMemCode,OppTradercode,0,groupid,tradercode,  
			(Case When Cl_Type = 'I' Then 1 Else 0 End),0,0,0,0,'0','0','0','0','0','0','0','0','0','0',0,MarketRate  
		From
			BFoconfirmview_expiry

		insert into bbgbfosettlement  
		Select
			'0000000',MarketLot,Trade_no, Party_Code,BFoTrade.product_type,BFoTrade.product_code,
			BfoTrade.Series_code,BfoTrade.Series_id,expirydate,multiplier,  
			user_id,tradeqty,Case When Right(BfoTrade.Product_Code,3) ='OPT' Then 'CA' else 'EA' end,
			trans_type,0, order_no, MarketRate,strikeprice,Sauda_date, 0, 0, 'V',   
			0 ,  0, 0, 0, 0, Sell_buy,settflag, 0,MarketRate,MarketRate*TradeQty, 0,  
			0,0,0, 0,0, MarketRate*TradeQty, 1, 0,0 , 0 ,0 ,  
			0,cl_type,order_date,OppMemCode,OppTradercode,0,groupid,tradercode,  
			(Case When Cl_Type = 'I' Then 1 Else 0 End),0,0,0,0,'0','0','0','0','0','0','0','0','0','0',0,MarketRate  
		From
			BFoTrade,BFoScrip2
		Where 
			BFoTrade.Product_Type = BFoScrip2.Product_Type and 
			BFoTrade.Product_Code = BFoScrip2.Product_Code and 
			BFoTrade.Series_Code = BFoScrip2.Series_Code and 
			BFoTrade.Series_Id = BFoScrip2.Series_Id and 
			BfoTrade.Trade_No Not In (Select distinct Trade_no from BFoconfirmView_Expiry) 

                Insert into BFoSettlement 
		Select 
			ContractNo,BillNo,Trade_no,Party_Code,product_type,product_code,Series_code,Series_id,
			expirydate,multiplier,User_id,Tradeqty,AuctionPart,MarketType,Series,Order_no,MarketRate,
			strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,
			Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,
			sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,
			sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_rate,GroupId,TraderCode,
			reserved1,reserved2,reserved3,reserved4,reserved5,status,branch_cd,pro_cli,participantcode,
			cpid,instrument,booktype,branch_id,scheme,tmark,dummy1,dummy2
		From bfoSettlementExpiry

		Truncate table Bfosettlementexpiry    
		
		exec BFOGenContract_Expiry  		

		Update bbgbfosettlement set contractno =0 where Product_Code like '%OPT' and auctionpart ='CA'
		
		Insert into BfoexpiryBackup select *,getdate() from BfoSettlement 
		where 
			sauda_date like @@TempSaudadate + '%' 
			and Expirydate like @@expdate +'%' 
			and (auctionpart = 'EA' and Product_Code like '%FUT' or auctionpart = 'CA' 
				and Product_Code like '%OPT')
		
		delete from BfoSettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))	
		
		delete from BfoExpirySettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%'
		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))		
		
		insert into BfoExpirySettlement select * from bbgBfoSettlement where sauda_date like @@TempSaudadate + '%' 
		and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))
		
		insert into BfoSettlement Select * from bbgBfoSettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%'
		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))
		
		if (select isnull(membertype,'') from Bfoowner) = 'CM'  
		begin  
        		delete from Bfotmclchrg where orderno like '99999999%' and sauda_date like @@TempSaudadate + '%' and dummy2 in ('EA','CA')
        		
        		insert into bfotmclchrg select Party_code,order_no,Sauda_date,Clearingcharges = (brokapplied*tradeqty),dummy1='0',
        		dummy2=Case Right(Product_Code,3) when 'OPT' then 'CA' else 'EA' end,trade_no,sell_buy  
        		from bbgbfosettlement  
        		where order_no like '99999999%' and sauda_date like @@TempSaudadate + '%'
        		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))
        		
        		update Bfoexpirysettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0 where expirydate like @@expdate +'%' 
        		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))

        		update Bfosettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0 where expirydate like @@expdate +'%' 
        		and ((auctionpart = 'EA' and Product_Code like '%FUT') or (auctionpart = 'CA' and Product_Code like '%OPT'))
		end  

       		Update Bfosettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0,
                ins_Chrg=0,Turn_Tax=0,Other_Chrg=0,Sebi_Tax=0,Broker_Chrg=0,NetRate = 0
                where expirydate like @@expdate +'%' and auctionpart = 'CA' and Product_Code like '%OPT'	

		truncate table bbgBfosettlement    
		truncate table bfotrade   
		truncate table bfofttrade    
		drop table #BFoClosing
		
		FETCH NEXT FROM @@GetExpiryDate into @@TempExpirydate,@@TempSaudadate  
   END         
  
CLOSE @@GetExpiryDate  
Deallocate @@GetExpiryDate

Set @@TempSaudadate = Left(@ExpiryDate,11)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSettBrokEditUp
-- --------------------------------------------------

CREATE procedure [dbo].[BFOSettBrokEditUp]  
@product_type varchar(5),  
@product_code varchar(10),  
@series_code varchar(13),  
@expirydate varchar(11),  
@series_id int,  
@party_code varchar(10),  
@trade_no varchar(14),  
@Order_No Varchar(16),  
@MarketRate Numeric(18,9),  
@Brok Numeric(18,8),  
@Val_Perc Varchar(1),  
@Sell_Buy Int,  
@NetRate Numeric(18,9),   
@Sauda_date varchar(11),  
@Flag Int   
AS  
if @flag = 1   
begin   
 Update bfosettlement set  
 /*select bfosettlement.partY_code,bfosettlement.SettFlag,product_code,product_type,series_code,expirydate,trade_no,order_no,*/  
 BrokApplied = (  case    
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                    Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                   
  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                 Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                 when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                 Then    
                 ((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))  
                  
                when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                Then   
  ((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                  
         when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                Then   
  ((floor(( ((@Brok*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                Then           
  ((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 5  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 5  and @val_perc ='P' )  
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
   Else  0   
                        End   
                         ),  
  
       
NetRate = (  case    
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                  Then   
                  (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
     
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                  Then   
       (bfosettlement.marketrate)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                  Then   
                  (bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /
 power(10,broktable.round_to))  
                    
                  when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
     when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                  Then   
                  (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
    when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
         Then   
                  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag =5  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag =5  and @val_perc ='P' )  
                  Then   
                  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
   Else  0   
                        End   
                         ),  
  
  
   Amount =   
            (  case    
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                         Then   
                   bfosettlement.TradeQty  *  ( (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))  
                   
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                        Then   
                   bfosettlement.TradeQty  * ((bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate)+ ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
                                         
                   when (bfosettlement.SettFlag = 2  and @val_perc ='P' )                          Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( ((@Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                        Then   
                   bfosettlement.TradeQty * (  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
  
                   when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
   
                   when ( bfosettlement.SettFlag =5  and @val_perc ='V' )  
                         Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )  
    
                   when ( bfosettlement.SettFlag =5  and @val_perc ='P' )  
                         Then   
                   bfosettlement.TradeQty  * (  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))  
   Else  0   
                        End   
                         ),  
  
        Ins_chrg  = ((floor(( ((BFOTAXES.insurance_chrg * (f.Taxprice) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),  
  
  
        turn_tax  =  ((floor(( ((BFOTAXES.turnover_tax * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  
  power(10,broktable.round_to)),  
  
        other_chrg = ((floor(( ((BFOTAXES.other_chrg * (f.Taxprice) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  power(10,broktable.round_to)),  
  
        sebi_tax =     ((floor(( ((BFOTAXES.sebiturn_tax * (f.Taxprice) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),  
  
        Broker_chrg =  ((floor(( ((BFOTAXES.broker_note * (f.Taxprice) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),  
  
        Service_tax =  (case    
                        when ( bfosettlement.SettFlag = 1 and @val_perc ='V')  
                             Then   
                                 ((floor((   
                                        (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                      power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
                        when (bfosettlement.SettFlag = 1 and @val_perc ='P')  
                             Then   
                                      ((floor((   
                                                   (((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) )
 /  
                                                          power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))  
  
  
                        when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                             Then    
                                       ((floor((   
                                                    (((((floor(( (@Brok*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
                        when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                             Then    
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 5  and @val_perc ='V' )  
                             Then     
  
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 5  and @val_perc ='P' )  
                             Then    
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / 
 
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
   Else  0   
                        End   
                         ),  
  
  
  
  
      Trade_amount = bfosettlement.TradeQty * bfosettlement.marketrate, Status = 'E'  
      FROM bfosettlement,BrokTable,BFOTAXES,Client2,BFOGLOBALS,BFoSettView F  
      WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */  
            bfosettlement.product_code = @product_code   
  and bfosettlement.product_type = @product_type  
            AND bfosettlement.series_code = @series_code    
            AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate   
            and bfosettlement.series_id = @series_id                
            and bfosettlement.party_code = @party_code   
 and bfosettlement.Trade_no Like @Trade_no  
 and bfosettlement.Order_no Like @Order_no   
 and Client2.Party_code = @party_code   
 and Client2.Tran_cat = BFOTAXES.Trans_cat and  
 bfosettlement.party_code = F.party_code and  
            bfosettlement.product_type=F.product_type and    
 bfosettlement.product_code = F.product_code and      
            bfosettlement.series_code=F.series_code and  
            bfosettlement.expirydate=F.expirydate  AND  
            bfosettlement.series_id = F.series_id and                  
            bfosettlement.sauda_date = F.sauda_date AND  
 bfosettlement.Trade_No = F.Trade_No AND   
 bfosettlement.Order_No = F.Order_No AND  
 bfosettlement.Sell_Buy = F.Sell_Buy     
    /*and Client2.Table_no = BrokTable.Table_no*/  
 and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))  
            and Broktable.Line_no = 1 /*  ( select min(line_no) from broktable where broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End)) */  
 And (BFOTAXES.exchange = 'BSE')   
   
end         
               
if @flag = 2   
begin  
 Update bfosettlement set  
 BrokApplied = (  case    
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                    Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                   
  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                 Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                 when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                 Then    
                 ((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))  
                  
                when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                Then   
  ((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                  
         when (bfosettlement.SettFlag = 2  and @val_perc ='V' )                  Then   
  ((floor(( ((@Brok*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                Then           
  ((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 5  and @val_perc ='V' )  
                Then   
  ((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                when ( bfosettlement.SettFlag = 5  and @val_perc ='P' )  
                Then   
  ((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
   Else  0   
                        End   
                         ),  
  
       
NetRate = (  case    
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                  Then   
                  (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
     
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                  Then         (bfosettlement.marketrate)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                  Then   
                  (bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
     when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                  Then   
                  (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
    when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                  Then   
                  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                  Then   
                  (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag =5  and @val_perc ='V' )  
                  Then   
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
                    
                  when ( bfosettlement.SettFlag =5  and @val_perc ='P' )  
                  Then   
                  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
   Else  0    
                        End   
                         ),  
  
  
   Amount =   
            (  case    
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 1)  
                         Then   
                   bfosettlement.TradeQty  *  ( (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='V' and bfosettlement.Sell_Buy = 2)  
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))  
                   
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 1)  
                        Then   
                   bfosettlement.TradeQty  * ((bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ='P' and bfosettlement.Sell_Buy = 2)  
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                        Then   
                   bfosettlement.TradeQty * ((bfosettlement.marketrate)+ ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
                                         
                   when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( ((@Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                        Then   
                   bfosettlement.TradeQty * (  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
                   when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
  
   when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                        Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))  
   
                   when ( bfosettlement.SettFlag =5  and @val_perc ='V' )  
                         Then   
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /   (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )  
    
                   when ( bfosettlement.SettFlag =5  and @val_perc ='P' )  
                         Then   
                   bfosettlement.TradeQty  * (  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))  
   Else  0   
                        End   
                         ),  
  
  
        Ins_chrg  = ((floor(( ((BFOTAXES.insurance_chrg * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),  
  
  
        turn_tax  =  ((floor(( ((BFOTAXES.turnover_tax * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  
  power(10,broktable.round_to)),  
  
        other_chrg = ((floor(( ((BFOTAXES.other_chrg * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  power(10,broktable.round_to)),  
  
        sebi_tax =     ((floor(( ((BFOTAXES.sebiturn_tax *(f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),  
  
        Broker_chrg =  ((floor(( ((BFOTAXES.broker_note * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),  
  
  
        Service_tax =  (case    
                        when ( bfosettlement.SettFlag = 1 and @val_perc ='V')  
                             Then   
                                 ((floor((   
                                        (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                      power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
                        when (bfosettlement.SettFlag = 1 and @val_perc ='P')  
                             Then   
                                      ((floor((   
                                                   (((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) )
 /  
                                                          power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))  
  
  
                        when (bfosettlement.SettFlag = 2  and @val_perc ='V' )   
                             Then    
                                       ((floor((   
                                                    (((((floor(( (@Brok*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
                        when (bfosettlement.SettFlag = 2  and @val_perc ='P' )   
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when (bfosettlement.SettFlag = 3  and @val_perc ='V' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when (bfosettlement.SettFlag = 3  and @val_perc ='P' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 4  and @val_perc ='V' )  
                             Then    
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
  
                        when ( bfosettlement.SettFlag = 4  and @val_perc ='P' )  
                             Then   
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 5  and @val_perc ='V' )  
                             Then     
  
                                       ((floor((   
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
  
                        when ( bfosettlement.SettFlag = 5  and @val_perc ='P' )  
                             Then    
                                       ((floor((   
                                                    (((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / 
 
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
  
   Else  0   
                        End   
                         ),  
  
      Trade_amount = bfosettlement.TradeQty * bfosettlement.marketrate,  
      Status = 'E'  
      FROM bfosettlement,BrokTable,BFOTAXES,Client2,BFOGLOBALS,BFoSettView F  
      WHERE   
 left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */  
            bfosettlement.product_code = @product_code   
 and bfosettlement.product_type = @product_type  
            AND bfosettlement.series_code = @series_code    
            AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate    
            and bfosettlement.series_id = @series_id                  
            and bfosettlement.party_code = @party_code   
 and bfosettlement.Trade_no Like @Trade_no  
 and bfosettlement.Order_no Like @Order_no   
 and bfosettlement.marketrate = @MarketRate   
 and Client2.Party_code = @party_code   
 and Client2.Tran_cat = BFOTAXES.Trans_cat  
 and bfosettlement.party_code = F.party_code and  
            bfosettlement.product_code = F.product_code and                    
 bfosettlement.product_type=F.product_type and    
            bfosettlement.series_code=F.series_code and  
            bfosettlement.expirydate=F.expirydate  AND  
            bfosettlement.series_id = F.series_id and                  
            bfosettlement.sauda_date = F.sauda_date AND  
 bfosettlement.Trade_No = F.Trade_No AND   
 bfosettlement.Order_No = F.Order_No AND  
 bfosettlement.Sell_Buy = F.Sell_Buy      
/*    and Client2.Table_no = BrokTable.Table_no And*/  
 and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                                        Then Client2.std_rate  
                                          Else Client2.Brok2_TableNo  
                       End))  
             
            and Broktable.Line_no =  1 /*( select min(line_no) from broktable where broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))*/  
 And (BFOTAXES.exchange = 'BSE')   
   
end      
  
else If @Flag = 3  
Begin  
 update bfosettlement set   
 NetRate = Round(@NetRate,Round_To), N_NetRate =Round(@NetRate,Round_to),  
 BrokApplied = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To), NBrokApp = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To),  
 Service_Tax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To), NSerTax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To),  
 Amount = Round(@NetRate*bfosettlement.TradeQty,BrokTable.Round_To) , Status = 'E'  
 From Client2,BFOGLOBALS,BrokTable,bfosettlement,BFoSettView F  
 WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */  
 bfosettlement.product_code = @product_code   
 and bfosettlement.product_type = @product_type  
 AND bfosettlement.series_code = @series_code    
 AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate    
 and bfosettlement.series_id = @series_id                   
 and bfosettlement.party_code = @party_code   
 and bfosettlement.Trade_no Like @Trade_no  
 and bfosettlement.Order_no Like @Order_no   
 and client2.party_code = @party_code  
 and bfosettlement.Sell_Buy = @Sell_Buy  
 and bfosettlement.party_code = F.party_code and  
 bfosettlement.product_type=F.product_type and    
         bfosettlement.series_code=F.series_code and  
         bfosettlement.expirydate=F.expirydate  AND  
         bfosettlement.strike_price = F.strike_price and                  
         bfosettlement.product_code = F.product_code and                    
 bfosettlement.sauda_date = F.sauda_date AND  
 bfosettlement.Trade_No = F.Trade_No AND   
 bfosettlement.Order_No = F.Order_No AND  
 bfosettlement.Sell_Buy = F.Sell_Buy     
   
/*and BrokTable.Table_no = Client2.Table_no*/  
 and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))  
  
 and Broktable.Line_no = 1 /* ( Select min(line_no) from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))*/  
end     
               
else If @Flag =4  
Begin  
 update bfosettlement set   
 NetRate = Round(@NetRate,Round_To), N_NetRate =Round(@NetRate,Round_to),  
 BrokApplied = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To), NBrokApp = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To),  
 Service_Tax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To), NSerTax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To),  
 Amount = Round(@NetRate*bfosettlement.TradeQty,BrokTable.Round_To) , Status = 'E'  
 From Client2,BFOGLOBALS,BrokTable,bfosettlement,BFoSettView F  
 WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */  
 bfosettlement.product_code = @product_code   
 and bfosettlement.product_type = @product_type  
 AND bfosettlement.series_code = @series_code    
 AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate    
 and bfosettlement.series_id = @series_id                   
 and bfosettlement.party_code = @party_code   
 and bfosettlement.Trade_no Like @Trade_no  
 and bfosettlement.Order_no Like @Order_no   
 and bfosettlement.marketrate = @MarketRate   
 and client2.party_code = @party_code  
 and bfosettlement.Sell_Buy = @Sell_Buy  
 and bfosettlement.party_code = F.party_code and  
         bfosettlement.product_type=F.product_type and    
         bfosettlement.series_code=F.series_code and  
         bfosettlement.expirydate=F.expirydate  AND  
         bfosettlement.strike_price = F.strike_price and                  
         bfosettlement.product_code = F.product_code and                    
 bfosettlement.sauda_date = F.sauda_date AND  
 bfosettlement.Trade_No = F.Trade_No AND   
 bfosettlement.Order_No = F.Order_No AND  
 bfosettlement.Sell_Buy = F.Sell_Buy   and 
 bfosettlement.sauda_date between year_start_dt and year_end_dt
 /*and BrokTable.Table_no = Client2.Table_no*/  
 and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))  
 and Broktable.Line_no = 1 /* ( Select min(line_no) from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'    
                             Then Client2.std_rate  
                               Else Client2.Brok2_TableNo  
                       End))*/  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSettBrokEditUp1
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFOSettBrokEditUp1    Script Date: 01/10/2003 7:32:58 PM ******/
/****** Object:  Stored Procedure dbo.BFOSettBrokEditUp1    Script Date: 2/12/02 12:20:47 PM ******/
/****** Object:  Stored Procedure dbo.BFOSettBrokEditUp1    Script Date: 1/29/02 7:45:04 PM ******/
CREATE procedure [dbo].[BFOSettBrokEditUp1]
@product_type varchar(5),
@product_code varchar(10),
@series_code varchar(13),
@expirydate varchar(11),
@series_id int,
@party_code varchar(10),
@trade_no varchar(14),
@Order_No Varchar(16),
@MarketRate Numeric(18,9),
@Brok Numeric(18,8),
@Val_Perc Varchar(1),
@Sell_Buy Int,
@NetRate Numeric(18,9), 
@Sauda_date varchar(11),
@Flag Int 
AS
if @flag = 1 
begin 
  Update bfosettlement set
	/*
    BrokApplied = (  case  
                when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                Then 
		((floor(( 50 * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                Then 
		((floor(( ((50/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                 Else  0 
                        End 
                         ),
  
      Trade_amount = bfosettlement.TradeQty * bfosettlement.marketrate, Status = 'E'*/
BrokApplied = (  case  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                    Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                 
		when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                 Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                 when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                 Then  
                 ((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))
                
                when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                Then 
		((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                
	        when (bfosettlement.SettFlag = 2  and @val_perc ="V" )                  Then 
		((floor(( ((@Brok*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                Then         
		((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 5  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 5  and @val_perc ="P" )
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
     
NetRate = (  case  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                  Then 
                  (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                  Then     		  (bfosettlement.marketrate)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                  Then 
                  (bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
 		  when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                  Then 
                  (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
		  when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag =5  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag =5  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
   Amount = 
            (  case  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                         Then 
                   bfosettlement.TradeQty  *  ( (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                 
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                        Then 
                   bfosettlement.TradeQty  * ((bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate)+ ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                       
                   when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( ((@Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                        Then 
                   bfosettlement.TradeQty * (  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                    when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
 
                   when ( bfosettlement.SettFlag =5  and @val_perc ="V" )
                         Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
  
                   when ( bfosettlement.SettFlag =5  and @val_perc ="P" )
                         Then 
                   bfosettlement.TradeQty  * (  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End 
                         ),
        Ins_chrg  = ((floor(( ((BFOTAXES.insurance_chrg * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((BFOTAXES.turnover_tax * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
		power(10,broktable.round_to)),
        other_chrg = ((floor(( ((BFOTAXES.other_chrg * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / 	power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((BFOTAXES.sebiturn_tax *(f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /	power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((BFOTAXES.broker_note * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        Service_tax =  (case  
                        when ( bfosettlement.SettFlag = 1 and @val_perc ="V")
                             Then 
                                 ((floor(( 
                                        (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                      power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 1 and @val_perc ="P")
                             Then 
                                      ((floor(( 
                                                   (((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                          power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
                        when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                             Then  
                                       ((floor(( 
                                                    (((((floor(( (@Brok*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 5  and @val_perc ="V" )
                             Then   
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 5  and @val_perc ="P" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
   Else  0 
                        End 
                         ),
      Trade_amount = bfosettlement.TradeQty * bfosettlement.marketrate,
      Status = 'E'
      FROM bfosettlement,BrokTable,BFOTAXES,Client2,BFOGLOBALS,BFoSettView F
      WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */
           	bfosettlement.product_code = @product_code 
	 and bfosettlement.product_type = @product_type
           	AND bfosettlement.series_code = @series_code  
           	AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate 
           	and bfosettlement.series_id = @series_id              
           	and bfosettlement.party_code = @party_code 
	and bfosettlement.Trade_no Like @Trade_no
	and bfosettlement.Order_no Like @Order_no	
	and Client2.Party_code = @party_code	
	and Client2.Tran_cat = BFOTAXES.Trans_cat and
	bfosettlement.party_code = F.party_code and
           	bfosettlement.product_type=F.product_type and  
	bfosettlement.product_code = F.product_code and    
           	bfosettlement.series_code=F.series_code and
           	bfosettlement.expirydate=F.expirydate  AND
           	bfosettlement.series_id = F.series_id and                
           	bfosettlement.sauda_date = F.sauda_date AND
	bfosettlement.Trade_No = F.Trade_No AND 
	bfosettlement.Order_No = F.Order_No AND
	bfosettlement.Sell_Buy = F.Sell_Buy  	and
 bfosettlement.sauda_date between year_start_dt and year_end_dt
	   /*and Client2.Table_no = BrokTable.Table_no*/
	and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When Right(F.product_code,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End) and Broktable.Line_no = 1)
           	and Broktable.Line_no = 1 /*  ( select min(line_no) from broktable where broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)) */
	And (BFOTAXES.exchange = 'BSE') 
	
end 				  
             
if @flag = 2 
begin
	Update bfosettlement set
	BrokApplied = (  case  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                    Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                 
		when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                 Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                 when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                 Then  
                 ((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))
                
                when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                Then 
		((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                
	        when (bfosettlement.SettFlag = 2  and @val_perc ="V" )                  Then 
		((floor(( ((@Brok*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                Then         
		((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 5  and @val_perc ="V" )
                Then 
		((floor(( @Brok*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                when ( bfosettlement.SettFlag = 5  and @val_perc ="P" )
                Then 
		((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
     
NetRate = (  case  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                  Then 
                  (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                  Then     		  (bfosettlement.marketrate)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                  Then 
                  (bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
 		  when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                  Then 
                  (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
		  when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag =5  and @val_perc ="V" )
                  Then 
                  (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                  
                  when ( bfosettlement.SettFlag =5  and @val_perc ="P" )
                  Then 
                  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
   Amount = 
            (  case  
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 1)
                         Then 
                   bfosettlement.TradeQty  *  ( (bfosettlement.marketrate) + ((floor((  (( @Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="V" and bfosettlement.Sell_Buy = 2)
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                 
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 1)
                        Then 
                   bfosettlement.TradeQty  * ((bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 1 and @val_perc ="P" and bfosettlement.Sell_Buy = 2)
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                        Then 
                   bfosettlement.TradeQty * ((bfosettlement.marketrate)+ ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                       
                   when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( ((@Brok*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                        Then 
                   bfosettlement.TradeQty * (  (bfosettlement.marketrate) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ((@Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                    when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                        Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
 
                   when ( bfosettlement.SettFlag =5  and @val_perc ="V" )
                         Then 
                   bfosettlement.TradeQty * ( (bfosettlement.marketrate) - ((floor(( (( @Brok*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
  
                   when ( bfosettlement.SettFlag =5  and @val_perc ="P" )
                         Then 
                   bfosettlement.TradeQty  * (  (bfosettlement.marketrate) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End 
                         ),
        Ins_chrg  = ((floor(( ((BFOTAXES.insurance_chrg * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((BFOTAXES.turnover_tax * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
		power(10,broktable.round_to)),
        other_chrg = ((floor(( ((BFOTAXES.other_chrg * (f.marketrate) * bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / 	power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((BFOTAXES.sebiturn_tax *(f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /	power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((BFOTAXES.broker_note * (f.marketrate) * bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        Service_tax =  (case  
                        when ( bfosettlement.SettFlag = 1 and @val_perc ="V")
                             Then 
                                 ((floor(( 
                                        (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                      power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 1 and @val_perc ="P")
                             Then 
                                      ((floor(( 
                                                   (((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                          power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
                        when (bfosettlement.SettFlag = 2  and @val_perc ="V" ) 
                             Then  
                                       ((floor(( 
                                                    (((((floor(( (@Brok*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 2  and @val_perc ="P" ) 
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 3  and @val_perc ="V" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (bfosettlement.SettFlag = 3  and @val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 4  and @val_perc ="V" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 4  and @val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 5  and @val_perc ="V" )
                             Then   
                                       ((floor(( 
                                                    (((((floor((( @Brok*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( bfosettlement.SettFlag = 5  and @val_perc ="P" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * bfosettlement.TradeQty * BFOGLOBALS.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
   Else  0 
                        End 
                         ),
      Trade_amount = bfosettlement.TradeQty * bfosettlement.marketrate,
      Status = 'E'
      FROM bfosettlement,BrokTable,BFOTAXES,Client2,BFOGLOBALS,BFoSettView F
      WHERE 
	left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */
           	bfosettlement.product_code = @product_code 
	and bfosettlement.product_type = @product_type
           	AND bfosettlement.series_code = @series_code  
           	AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate  
           	and bfosettlement.series_id = @series_id                
           	and bfosettlement.party_code = @party_code 
	and bfosettlement.Trade_no Like @Trade_no
	and bfosettlement.Order_no Like @Order_no	
	and bfosettlement.marketrate = @MarketRate	
	and Client2.Party_code = @party_code	
	and Client2.Tran_cat = BFOTAXES.Trans_cat
	and bfosettlement.party_code = F.party_code and
           	bfosettlement.product_code = F.product_code and                  
	bfosettlement.product_type=F.product_type and  
           	bfosettlement.series_code=F.series_code and
           	bfosettlement.expirydate=F.expirydate  AND
           	bfosettlement.series_id = F.series_id and                
           	bfosettlement.sauda_date = F.sauda_date AND
	bfosettlement.Trade_No = F.Trade_No AND 
	bfosettlement.Order_No = F.Order_No AND
	bfosettlement.Sell_Buy = F.Sell_Buy  		and
 bfosettlement.sauda_date between year_start_dt and year_end_dt
/*	   and Client2.Table_no = BrokTable.Table_no And*/
	and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When right(F.product_code,3) = 'FUT'  
			            					                    Then Client2.std_rate
			              					                    Else Client2.Brok2_TableNo
							                End)and Broktable.Line_no = 1)
           
           	and Broktable.Line_no =  1 /*( select min(line_no) from broktable where broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))*/
	And (BFOTAXES.exchange = 'BSE') 
	
end 			
else If @Flag = 3
Begin
	update bfosettlement set 
	NetRate = Round(@NetRate,Round_To), N_NetRate =Round(@NetRate,Round_to),
	BrokApplied = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To), NBrokApp = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To),
	Service_Tax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To), NSerTax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To),
	Amount = Round(@NetRate*bfosettlement.TradeQty,BrokTable.Round_To) , Status = 'E'
	From Client2,BFOGLOBALS,BrokTable,bfosettlement,BFoSettView F
	WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */
	bfosettlement.product_code = @product_code 
	and bfosettlement.product_type = @product_type
	AND bfosettlement.series_code = @series_code  
	AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate  
	and bfosettlement.series_id = @series_id                 
	and bfosettlement.party_code = @party_code 
	and bfosettlement.Trade_no Like @Trade_no
	and bfosettlement.Order_no Like @Order_no	
	and client2.party_code = @party_code
	and bfosettlement.Sell_Buy = @Sell_Buy
	and bfosettlement.party_code = F.party_code and
	bfosettlement.product_type=F.product_type and  
        	bfosettlement.series_code=F.series_code and
        	bfosettlement.expirydate=F.expirydate  AND
        	bfosettlement.strike_price = F.strike_price and                
        	bfosettlement.product_code = F.product_code and                  
	bfosettlement.sauda_date = F.sauda_date AND
	bfosettlement.Trade_No = F.Trade_No AND 
	bfosettlement.Order_No = F.Order_No AND
	bfosettlement.Sell_Buy = F.Sell_Buy  	and
 bfosettlement.sauda_date between year_start_dt and year_end_dt	
/*and BrokTable.Table_no = Client2.Table_no*/
	and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When right(F.product_code,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)and Broktable.Line_no = 1)
	and Broktable.Line_no = 1 /* ( Select min(line_no) from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))*/
end	  
             
else If @Flag =4
Begin
	update bfosettlement set 
	NetRate = Round(@NetRate,Round_To), N_NetRate =Round(@NetRate,Round_to),
	BrokApplied = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To), NBrokApp = Round(Abs(@NetRate - F.MPrice),BrokTable.Round_To),
	Service_Tax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To), NSerTax = Round(bfosettlement.TradeQty*Abs(@NetRate - F.MPrice)*BFOGLOBALS.service_tax/100,BrokTable.Round_To),
	Amount = Round(@NetRate*bfosettlement.TradeQty,BrokTable.Round_To) , Status = 'E'
	From Client2,BFOGLOBALS,BrokTable,bfosettlement,BFoSettView F
	WHERE left(convert(varchar,bfosettlement.sauda_date,109),11) = @Sauda_date and    /* Added by vaishali on 26/07/2001 */
	bfosettlement.product_code = @product_code 
	and bfosettlement.product_type = @product_type
	AND bfosettlement.series_code = @series_code  
	AND left(convert(varchar,bfosettlement.expirydate,109),11) = @expirydate  
	and bfosettlement.series_id = @series_id                 
	and bfosettlement.party_code = @party_code 
	and bfosettlement.Trade_no Like @Trade_no
	and bfosettlement.Order_no Like @Order_no	
	and bfosettlement.marketrate = @MarketRate	
	and client2.party_code = @party_code
	and bfosettlement.Sell_Buy = @Sell_Buy
	and bfosettlement.party_code = F.party_code and
        	bfosettlement.product_type=F.product_type and  
        	bfosettlement.series_code=F.series_code and
        	bfosettlement.expirydate=F.expirydate  AND
        	bfosettlement.strike_price = F.strike_price and                
        	bfosettlement.product_code = F.product_code and                  
	bfosettlement.sauda_date = F.sauda_date AND
	bfosettlement.Trade_No = F.Trade_No AND 
	bfosettlement.Order_No = F.Order_No AND
	bfosettlement.Sell_Buy = F.Sell_Buy  	and
 bfosettlement.sauda_date between year_start_dt and year_end_dt
	/*and BrokTable.Table_no = Client2.Table_no*/
	and Broktable.table_no = ( Select table_no from Broktable Where Table_no = (Case When right(F.product_code,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)and Broktable.Line_no = 1)
	and Broktable.Line_no = 1 /* ( Select min(line_no) from Broktable Where Table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))*/
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoSettBrokReCal
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFoSettBrokReCal    Script Date: 01/10/2003 7:32:58 PM ******/
/****** Object:  Stored Procedure dbo.BFoSettBrokReCal    Script Date: 2/12/02 12:20:47 PM ******/
/****** Object:  Stored Procedure dbo.BFoSettBrokReCal    Script Date: 09/25/2001 6:15:59 AM ******/
CREATE procedure [dbo].[BFoSettBrokReCal]
@sauda_date varchar(11),
@Party_code varchar(10),
@Flag int 
As
if @flag = 1
begin
	select 
	S.Trade_No,S.Party_Code,s.product_type,s.product_code,s.expirydate,s.series_code,s.series_id ,
	 Brok=S.brokapplied,NewBork=Convert(Numeric(9,4), C.Brokapplied),S.TradeQty,S.marketrate,s.Sell_buy,s.BillNo 
	From BfoSettlement S, vBfosettbrokrecal C
	where s.expirydate = c.expirydate		
	and s.product_type = c.product_type
	and s.product_code = c.product_code
	and s.series_code = c.series_code
	and s.series_id = c.series_id
	and s.party_code = c.party_code
	and s.trade_no = c.trade_no
	and s.tradeqty = c.tradeqty
	and s.sell_buy = c.sell_buy 
	and s.sauda_date = c.sauda_date
	and left(convert(varchar,s.sauda_date,109),11) = @sauda_date
	/*and Status <>  'E'*/
end 
if @flag = 2
begin
	select 
	S.Trade_No,S.Party_Code,s.product_type,s.product_code,s.expirydate,s.series_code,s.series_id ,
	 Brok=S.brokapplied,NewBork=Convert(Numeric(9,4), C.Brokapplied),S.TradeQty,S.marketrate,s.Sell_buy,s.BillNo 
	From BfoSettlement S, vBfosettbrokrecal C
	where s.expirydate = c.expirydate		
	and s.product_type = c.product_type
	and s.product_code = c.product_code
	and s.series_code = c.series_code
	and s.series_id = c.series_id
	and s.party_code = c.party_code
	and s.trade_no = c.trade_no
	and s.tradeqty = c.tradeqty
	and s.sell_buy = c.sell_buy 
	and s.sauda_date = c.sauda_date
	and left(convert(varchar,s.sauda_date,109),11) = @sauda_date
	and s.party_code = @party_code
	/*and Status <>  'E'*/
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoSettBrokReCalUp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFoSettBrokReCalUp    Script Date: 01/10/2003 7:32:58 PM ******/
/****** Object:  Stored Procedure dbo.BFoSettBrokReCalUp    Script Date: 09/25/2001 6:15:59 AM ******/
CREATE procedure [dbo].[BFoSettBrokReCalUp]
@sauda_date varchar(11),
@party_code varchar(10),
@Flag Int
As
If @Flag = 1 
Begin 
       Update BFosettlement set 
       Table_no = BrokTable.Table_No,Line_no = BrokTable.Line_No,
       Val_perc = BrokTable.Val_perc,Normal = broktable.Normal,Day_puc = Broktable.Day_puc,Day_Sales = Broktable.day_sales,
       Sett_Purch = Broktable.Sett_purch, Sett_sales = Broktable.Sett_sales,  
 BrokApplied = (  case  
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                             Then 
		((floor(( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                            Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.day_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then /*round((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice ,broktable.round_to) */
		((floor(( ((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_purch*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   		Else  0 
                        End 
                         ),
     
NetRate = (  case  
                  when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                       Then 
                  (BFosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                           when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                                                       Then 
                                                                  (BFosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                                                        Then 
                                                             (BFosettlement.marketrate)+ ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                                                       Then 
                                                                   (BFosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                                                    Then 
                                                         (BFosettlement.marketrate) + ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                                                    Then 
                                                         (BFosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                                                     Then 
                                                         (BFosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                                                    Then 
                                                        (BFosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                                                     Then 
                                                                (BFosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                                                      Then 
                                                           (BFosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( BFosettlement.SettFlag =5  and broktable.val_perc ="V" )
                                                      Then 
                                                                   (BFosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag =5  and broktable.val_perc ="P" )
                                                     Then 
                                                                (BFosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
   Amount = 
            (  case  
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                         Then 
                   BFosettlement.Tradeqty  *  ( (BFosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                 
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                        Then 
                   BFosettlement.Tradeqty  * ((BFosettlement.marketrate) + ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate)+ ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                       
                   when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                        Then 
                   BFosettlement.Tradeqty * (  (BFosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))) 
                   when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
 
                   when ( BFosettlement.SettFlag =5  and broktable.val_perc ="V" )
                         Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
  
                   when ( BFosettlement.SettFlag =5  and broktable.val_perc ="P" )
                         Then 
                   BFosettlement.Tradeqty  * (  (BFosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End 
                         ),
        Ins_chrg  = ((floor(( ((Bfotaxes.insurance_chrg * (f.Taxprice) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((Bfotaxes.turnover_tax * (f.Taxprice) * BFosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
		power(10,broktable.round_to)),
        other_chrg = ((floor(( ((Bfotaxes.other_chrg * (f.Taxprice) * BFosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / 	power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((Bfotaxes.sebiturn_tax * (f.Taxprice) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /	power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((Bfotaxes.broker_note * (f.Taxprice) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        Service_tax =  (case  
                        when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V")
                             Then 
                                 ((floor(( 
                                        (((((floor((( broktable.Normal*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                      power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 1 and broktable.val_perc ="P")
                             Then 
                                      ((floor(( 
                                                   (((((floor((   ((broktable.Normal*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                          power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
                        when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                             Then  
                                       ((floor(( 
                                                    (((((floor(( (Broktable.Day_puc*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Day_puc*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( Broktable.day_sales*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.day_sales*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_purch*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
 
                        when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_purch*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then   
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_sales*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
   Else  0 
                        End 
                         ),
      Trade_amount = BFosettlement.Tradeqty * BFosettlement.marketrate
      FROM BrokTable,BFosettlement,Bfotaxes,BfoScrip2,client1,Client2,Bfoglobals,Bfosettsalepur1 s,BFoSettView F
      WHERE BFosettlement.party_code = Client2.Party_code and 
	   client1.cl_code=client2.cl_code and           
           Bfosettlement.product_type = BfoScrip2.product_type and
           BFosettlement.product_code = BfoScrip2.product_code and
           BFosettlement.expirydate=BfoScrip2.expirydate and
           BFosettlement.series_code = BfoScrip2.series_code and
	   BFosettlement.series_id = BfoScrip2.series_id and
           BFosettlement.party_code = s.party_code and
           Bfosettlement.product_type=S.product_type and  
           BFosettlement.product_code=S.product_code and
           BFosettlement.expirydate=S.expirydate  AND
           BFosettlement.series_code = s.series_code and                  
	   BFosettlement.series_id = s.series_id and             
	   BFosettlement.sauda_date like S.sdate + '%' AND
           BFosettlement.party_code = F.party_code and
           Bfosettlement.product_type=F.product_type and  
           BFosettlement.product_code=F.product_code and
           BFosettlement.expirydate=F.expirydate  AND
           BFosettlement.series_code = F.series_code and                  
           BFosettlement.series_id = F.series_id and                
	   BFosettlement.sauda_date = F.sauda_date AND
	   BFosettlement.Trade_No = F.Trade_No AND 
	   BFosettlement.Order_No = F.Order_No AND
	   BFosettlement.Sell_Buy = F.Sell_Buy AND 	
 bfosettlement.sauda_date between year_start_dt and year_end_dt and
           Broktable.Table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            Then Client2.std_rate
			             Else Client2.Brok2_TableNo
		 	 End) 
And   
           Broktable.Line_no =  ( case when (client2.brok_scheme = 1 or client2.brok_scheme = 5) then					
			         (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                            						
				                	    and Trd_Del = ( Case When s.Pqty >= s.Sqty 
										 then ( Case When ( BFosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( BFosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                                	    and BFosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)							    
			   	        when (client2.brok_scheme = 3 or client2.brok_scheme = 6) then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                    						
				                	    and Trd_Del = ( Case When s.Pqty > s.Sqty 
										 then ( Case When ( BFosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( BFosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                        	            and BFosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)		
				    else 
                                       (  select min(line_no) from broktable 
                                          where F.MPrice <= Broktable.upper_lim 
			                  and broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))
				   end )
             and                (Client2.Tran_cat = Bfotaxes.Trans_cat)
           And
             (Bfotaxes.exchange = 'BSE') 
	and left(convert(varchar,BFosettlement.sauda_date,109),11) = @sauda_date
	and Status <>  'E'
end
if @flag = 2 
begin
	 Update BFosettlement set 
       Table_no = BrokTable.Table_No,Line_no = BrokTable.Line_No,
       Val_perc = BrokTable.Val_perc,Normal = broktable.Normal,Day_puc = Broktable.Day_puc,Day_Sales = Broktable.day_sales,
       Sett_Purch = Broktable.Sett_purch, Sett_sales = Broktable.Sett_sales,
  
 BrokApplied = (  case  
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                               Then  
                                          ((floor ( (((broktable.Normal*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                             Then 
		((floor(( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                            Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.day_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then /*round((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice ,broktable.round_to) */
		((floor(( ((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_purch*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   		Else  0 
                        End 
                         ),
     
NetRate = (  case  
                  when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                       Then 
                  (BFosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                           when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                                                       Then 
                                                                  (BFosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                                                        Then 
                                                             (BFosettlement.marketrate)+ ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                                                       Then 
                                                                   (BFosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                                                    Then 
                                                         (BFosettlement.marketrate) + ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                                                    Then 
                                                         (BFosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                                                     Then 
                                                         (BFosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                                                    Then 
                                                        (BFosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                                                     Then 
                                                                (BFosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                                                      Then 
                                                           (BFosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( BFosettlement.SettFlag =5  and broktable.val_perc ="V" )
                                                      Then 
                                                                   (BFosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( BFosettlement.SettFlag =5  and broktable.val_perc ="P" )
                                                     Then 
                                                                (BFosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
   Amount = 
            (  case  
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 1)
                         Then 
                   BFosettlement.Tradeqty  *  ( (BFosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V" and BFosettlement.sell_buy = 2)
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                 
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 1)
                        Then 
                   BFosettlement.Tradeqty  * ((BFosettlement.marketrate) + ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="P" and BFosettlement.sell_buy = 2)
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                        Then 
                   BFosettlement.Tradeqty * ((BFosettlement.marketrate)+ ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                       
                   when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                        Then 
                   BFosettlement.Tradeqty * (  (BFosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))) 
                   when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                        Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
 
                   when ( BFosettlement.SettFlag =5  and broktable.val_perc ="V" )
                         Then 
                   BFosettlement.Tradeqty * ( (BFosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
  
                   when ( BFosettlement.SettFlag =5  and broktable.val_perc ="P" )
                         Then 
                   BFosettlement.Tradeqty  * (  (BFosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End 
                         ),
        Ins_chrg  = ((floor(( ((Bfotaxes.insurance_chrg * (f.marketrate) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((Bfotaxes.turnover_tax * (f.marketrate) * BFosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
		power(10,broktable.round_to)),
        other_chrg = ((floor(( ((Bfotaxes.other_chrg * (f.marketrate) * BFosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / 	power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((Bfotaxes.sebiturn_tax *(f.marketrate) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /	power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((Bfotaxes.broker_note * (f.marketrate) * BFosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        Service_tax =  (case  
                        when ( BFosettlement.SettFlag = 1 and broktable.val_perc ="V")
                             Then 
                                 ((floor(( 
                                        (((((floor((( broktable.Normal*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                      power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 1 and broktable.val_perc ="P")
                             Then 
                                      ((floor(( 
                                                   (((((floor((   ((broktable.Normal*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                          power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
                        when (BFosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                             Then  
                                       ((floor(( 
                                                    (((((floor(( (Broktable.Day_puc*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Day_puc*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( Broktable.day_sales*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (BFosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.day_sales*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_purch*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_purch*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))     
                        when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then   
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_sales*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( BFosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * BFosettlement.Tradeqty * Bfoglobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
   Else  0 
                        End 
                         ),
      Trade_amount = BFosettlement.Tradeqty * BFosettlement.marketrate
      FROM BrokTable,BFosettlement,Bfotaxes,BfoScrip2,client1,Client2,Bfoglobals,Bfosettsalepur1 s,BFoSettView F
      WHERE BFosettlement.party_code = Client2.Party_code and 
	    client1.cl_code=client2.cl_code and           
           Bfosettlement.product_type = BfoScrip2.product_type and
           BFosettlement.product_code = BfoScrip2.product_code and
           BFosettlement.expirydate=BfoScrip2.expirydate and
           BFosettlement.series_code = BfoScrip2.series_code and
	   BFosettlement.series_id = BfoScrip2.series_id and
           BFosettlement.party_code = s.party_code and
           Bfosettlement.product_type=S.product_type and  
           BFosettlement.product_code=S.product_code and
           BFosettlement.expirydate=S.expirydate  AND
           BFosettlement.series_code = s.series_code and                  
	   BFosettlement.series_id = s.series_id and             
	   BFosettlement.sauda_date like S.sdate + '%' AND
           BFosettlement.party_code = F.party_code and
           Bfosettlement.product_type=F.product_type and  
           BFosettlement.product_code=F.product_code and
           BFosettlement.expirydate=F.expirydate  AND
           BFosettlement.series_code = F.series_code and                  
           BFosettlement.series_id = F.series_id and                
	   BFosettlement.sauda_date = F.sauda_date AND
	   BFosettlement.Trade_No = F.Trade_No AND 
	   BFosettlement.Order_No = F.Order_No AND
	   BFosettlement.Sell_Buy = F.Sell_Buy AND 	
 bfosettlement.sauda_date between year_start_dt and year_end_dt and
           BFosettlement.series_code = s.series_code    and                         /*   Added By BBG  on 4 Jul 2001   We need this to set up relationship  */ 
	   BFosettlement.series_id = s.series_id and                 /*   Added By BBG  on 4 Jul 2001   We need this to set up relationship  */ 
           Broktable.Table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            Then Client2.std_rate
			             Else Client2.Brok2_TableNo
		                    End) And   
           Broktable.Line_no =  ( case when (client2.brok_scheme = 1 or client2.brok_scheme = 5) then					
					       		   (Select min(Broktable.line_no) from broktable where                                                		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                            						
				                	    and Trd_Del = ( Case When s.Pqty >= s.Sqty 
										 then ( Case When ( BFosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( BFosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                                	    and BFosettlement.Party_Code = Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)							    
			   	        when (client2.brok_scheme = 3 or client2.brok_scheme = 6) then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                    						
				                	    and Trd_Del = ( Case When s.Pqty > s.Sqty 
										 then ( Case When ( BFosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( BFosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                        	            and BFosettlement.Party_Code =  Client2.Party_code   	
							and F.MPrice <= Broktable.upper_lim)	
				    else 
                                       (  select min(line_no) from broktable 
                                          where F.MPrice <= Broktable.upper_lim 
			                  and broktable.table_no =(Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))
				   end )
             and                (Client2.Tran_cat = Bfotaxes.Trans_cat)
           And
             (Bfotaxes.exchange = 'BSE') 
	and left(convert(varchar,BFosettlement.sauda_date,109),11) = @sauda_date
	and BFosettlement.party_code = @party_code
	and Status <>  'E'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFOSettBrokUpdate
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.BFOSettBrokUpdate    Script Date: 01/10/2003 7:32:58 PM ******/
/****** Object:  Stored Procedure dbo.BFOSettBrokUpdate    Script Date: 09/25/2001 6:15:59 AM ******/
CREATE procedure [dbo].[BFOSettBrokUpdate]
@sauda_date varchar(11),
@party_code varchar(10),
@product_code varchar(10),
@product_type varchar(5),
@series_code varchar(13),
@expirydate varchar(11),
@series_id int
as 
       Update Bfosettlement set 
       Table_no = BrokTable.Table_No,Line_no = BrokTable.Line_No,
       Val_perc = BrokTable.Val_perc,Normal = broktable.Normal,Day_puc = Broktable.Day_puc,Day_Sales = Broktable.day_sales,
       Sett_Purch = Broktable.Sett_purch, Sett_sales = Broktable.Sett_sales,
       BrokApplied = (  case  
                         when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 1)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 2)
                              Then 
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 1)
                               Then   
                                          ((floor ( (((broktable.Normal*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 2)
                             Then 
		((floor(( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                            Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                      when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
		((floor(( ((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                   when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.day_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                  when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then /*round((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice ,broktable.round_to) */
		((floor(( ((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_purch*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
             when ( Bfosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then 
		((floor(( Broktable.Sett_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
                         when ( Bfosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then 
		((floor(( ((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
		power(10,broktable.round_to))
   		Else  0 
                        End 
                         ),
     
NetRate = (  case  
                  when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 1)
                       Then 
                  (bfosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                           when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 2)
                                                       Then 
                                                                  (bfosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
                                           when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 1)
                                                        Then 
                                                             (bfosettlement.marketrate)+ ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 2)
                                                       Then 
                                                                   (bfosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                                                    Then 
                                                         (bfosettlement.marketrate) + ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                                                    Then 
                                                         (bfosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                          when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                                                     Then 
                                                         (bfosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                                                    Then 
                                                        (bfosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                                                     Then 
                                                                (bfosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                                                      Then 
                                                           (bfosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                        when ( Bfosettlement.SettFlag =5  and broktable.val_perc ="V" )
                                                      Then 
                                                                   (bfosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                                         when ( Bfosettlement.SettFlag =5  and broktable.val_perc ="P" )
                                                     Then 
                                                                (bfosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to))
   Else  0 
                        End 
                         ),
   Amount = 
            (  case  
                   when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 1)
                         Then 
                   Bfosettlement.Tradeqty  *  ( (bfosettlement.marketrate) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V" and Bfosettlement.sell_buy = 2)
                        Then                     Bfosettlement.Tradeqty * ((bfosettlement.marketrate) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
                 
                   when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 1)
                        Then 
                   Bfosettlement.Tradeqty  * ((bfosettlement.marketrate) + ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="P" and Bfosettlement.sell_buy = 2)
                        Then 
                   Bfosettlement.Tradeqty * ((bfosettlement.marketrate) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                        Then 
                   Bfosettlement.Tradeqty * ((bfosettlement.marketrate)+ ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                                       
                   when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                        Then 
                   Bfosettlement.Tradeqty * ( (bfosettlement.marketrate) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                        Then 
                   Bfosettlement.Tradeqty * ( (bfosettlement.marketrate) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                        Then 
                   Bfosettlement.Tradeqty * (  (bfosettlement.marketrate) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
                   when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                        Then 
                   Bfosettlement.Tradeqty * ( (bfosettlement.marketrate) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))) 
                   when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                        Then 
                   Bfosettlement.Tradeqty * ( (bfosettlement.marketrate) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
 
                   when ( Bfosettlement.SettFlag =5  and broktable.val_perc ="V" )
                         Then 
                   Bfosettlement.Tradeqty * ( (bfosettlement.marketrate) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  	(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)) )
  
                   when ( Bfosettlement.SettFlag =5  and broktable.val_perc ="P" )
                         Then 
                   Bfosettlement.Tradeqty  * (  (bfosettlement.marketrate) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 	power(10,broktable.round_to)))
   Else  0 
                        End 
                         ),
        Ins_chrg  = ((floor(( ((BFoTaxes.insurance_chrg * (f.Taxprice) * Bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((BFoTaxes.turnover_tax * (f.Taxprice) * Bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
		power(10,broktable.round_to)),
        other_chrg = ((floor(( ((BFoTaxes.other_chrg * (f.Taxprice) * Bfosettlement.TradeQty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / 	power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((BFoTaxes.sebiturn_tax *(f.Taxprice) * Bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /	power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((BFoTaxes.broker_note * (f.Taxprice) * Bfosettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        Service_tax =  (case  
                        when ( Bfosettlement.SettFlag = 1 and broktable.val_perc ="V")
                             Then 
                                 ((floor(( 
                                        (((((floor((( broktable.Normal*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                      power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (Bfosettlement.SettFlag = 1 and broktable.val_perc ="P")
                             Then 
                                      ((floor(( 
                                                   (((((floor((   ((broktable.Normal*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                          power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
                        when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="V" ) 
                             Then  
                                       ((floor(( 
                                                    (((((floor(( (Broktable.Day_puc*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (Bfosettlement.SettFlag = 2  and broktable.val_perc ="P" ) 
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Day_puc*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="V" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( Broktable.day_sales*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when (Bfosettlement.SettFlag = 3  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.day_sales*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="V" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_purch*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /                                                             power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( Bfosettlement.SettFlag = 4  and broktable.val_perc ="P" )
                             Then 
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_purch*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( Bfosettlement.SettFlag = 5  and broktable.val_perc ="V" )
                             Then   
                                       ((floor(( 
                                                    (((((floor((( Broktable.Sett_sales*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
                        when ( Bfosettlement.SettFlag = 5  and broktable.val_perc ="P" )
                             Then  
                                       ((floor(( 
                                                    (((((floor((( (Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
                                                            power(10,Broktable.round_to))) * Bfosettlement.Tradeqty * BFoGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
                                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
   Else  0 
                        End 
                         ),
      Trade_amount = Bfosettlement.Tradeqty * bfosettlement.marketrate
      FROM BrokTable,Bfosettlement,BFoTaxes,BFoScrip2,client1,Client2,BFoGlobals,Bfosettsalepur1 s,BFoSettView F
      WHERE Bfosettlement.party_code = Client2.Party_code
	   and client1.cl_code=client2.cl_code            
           and Bfosettlement.product_type = BFoScrip2.product_type 
           AND Bfosettlement.series_code = BFoScrip2.series_code      
           AND Bfosettlement.expirydate=BFoScrip2.expirydate and
           Bfosettlement.product_code = BFoScrip2.product_code and
           Bfosettlement.party_code = s.party_code and
           Bfosettlement.product_type=S.product_type and  
           Bfosettlement.series_code=S.series_code and
           Bfosettlement.expirydate=S.expirydate  AND
           Bfosettlement.series_id = s.series_id and                
           Bfosettlement.product_code = s.product_code and                  
           Bfosettlement.sauda_date like S.sdate + '%' AND
           Bfosettlement.party_code = F.party_code and
           Bfosettlement.product_type=F.product_type and  
           Bfosettlement.series_code=F.series_code and
           Bfosettlement.expirydate=F.expirydate  AND
           Bfosettlement.series_id = F.series_id and                
           Bfosettlement.product_code = F.product_code and                  
	   Bfosettlement.sauda_date = F.sauda_date AND
	   Bfosettlement.Trade_No = F.Trade_No AND 
	   Bfosettlement.Order_No = F.Order_No AND
	   Bfosettlement.Sell_Buy = F.Sell_Buy AND 	
     bfosettlement.sauda_date between year_start_dt and year_end_dt and
           Broktable.Table_no = (Case When Left(F.product_type,3) = 'FUT'  
			           Then Client2.std_rate
			            Else Client2.Brok2_TableNo
			 End) And   
           Broktable.Line_no =  ( case when client2.brok_scheme = 1 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                            						
				                	    and Trd_Del = ( Case When s.Pqty >= s.Sqty 
										 then ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                                	    and Bfosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)							    
			   	        when client2.brok_scheme = 3 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                    						
				                	    and Trd_Del = ( Case When s.Pqty > s.Sqty 
										 then ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )					
									    End )
                                        	            and Bfosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)	
 /*bROKSCHEME IS FLAT BROKERAGE SCHEME ON THE PRODUCT TYPE*/
					when client2.brok_scheme = 4 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                            						
				                	    and Trd_Del = ( Case When s.Pqty <= s.Sqty and upper(left(s.product_type,3))='OPT'
										 then ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 When s.Pqty > s.Sqty and upper(left(s.product_type,3))='OPT'
										  then    ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										            End )	
										When s.Pqty >= s.Sqty and upper(left(s.product_type,3))='FUT'
										 then     ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										           End )
										When s.Pqty < s.Sqty and upper(left(s.product_type,3))='FUT'
										then     ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										           End )									         				
										
								                end)					
                                                                               
                                                	    and Bfosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)	
/*bROKSCHEME IS FLAT BROKERAGE SCHEME ON THE PRODUCT TYPE*/
					when client2.brok_scheme =5 then					
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    Broktable.table_no = (Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End)                                            						
				                	    and Trd_Del = ( Case When s.Pqty <= s.Sqty and upper(left(s.product_type,3))='OPT'
										 then ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										       End )
									     	 When s.Pqty > s.Sqty and upper(left(s.product_type,3))='OPT'
										  then    ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										            End )	
										When s.Pqty >= s.Sqty and upper(left(s.product_type,3))='FUT'
										 then     ( Case When ( Bfosettlement.Sell_Buy = 1 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										           End )
										When s.Pqty < s.Sqty and upper(left(s.product_type,3))='FUT'
										then     ( Case When ( Bfosettlement.Sell_Buy = 2 ) 
							    			 	    Then 'F'  
							    			 	    Else 'S'
										           End )									         				
										
								                end)					
                                                                               
                                                	              and Bfosettlement.Party_Code =  Client2.Party_code   	
                                               		    and F.MPrice <= Broktable.upper_lim)	
				    else 
                                       (  select min(line_no) from broktable 
                                          where F.MPrice <= Broktable.upper_lim 
			                  and broktable.table_no =(Case When Left(F.product_type,3) = 'FUT'  
			            					         Then Client2.std_rate
			              					         Else Client2.Brok2_TableNo
							                End))
				   end )
             and                (Client2.Tran_cat = BFoTaxes.Trans_cat)
           And
             (BFoTaxes.exchange = 'BSE') 
	and left(convert(varchar,Bfosettlement.sauda_date,109),11) = @sauda_date
	and Bfosettlement.party_code = @party_code
	and Bfosettlement.product_code = @product_code
	and Bfosettlement.product_type = @product_type
	and Bfosettlement.series_code = @series_code
	and left(convert(varchar,Bfosettlement.expirydate,109),11) = @expirydate
	and Bfosettlement.series_id = @series_id
/*	and Bfosettlement.Status <>  'E'*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoValanAccount
-- --------------------------------------------------

CREATE proc [dbo].[BFoValanAccount] (@Sdate Varchar(11))as
 declare
     /*Declaring OutPut Parameters*/
     @@varOptionExercise as varchar(10),
     @@varInclusiveSerTax as varchar(10),
     @@varInclusiveTurnTax as varchar(10),
     @@varInclusiveSebiTax as varchar(10),
     @@varInclusiveStampDuty as varchar(10),
     @@varClearingHouse as varchar(10),
     @@varRemissorAccount as varchar(10),
     @@varServiceTaxPayable as varchar(10),
     @@varServiceTaxAccount as varchar(10),
     @@varBrokerageRealised as varchar(10),
     @@varCarryForwardCharge as varchar(10),
     @@varSebiTax as varchar(10),
     @@varTurnOverTax as varchar(10),
     @@varClearingCharges as varchar(10),
     @@varReverseClearingCharges as varchar(10),
     @@varClearingPremiumAccount as varchar(10),
     @@varStampDuty as varchar(10),
     @@varRounding as varchar(10),
     /*Declaring variables that hold the values from the query*/
     @@varAcCode as varchar(10),
     @@varAcName as varchar(50),
     @@intReserved as int,
     @@varRevCode as varchar(10),
     @@varOppCode as varchar(10),
     @@dtEffDate as datetime,   
     /*Declaring Cursor Flag*/
     @@flag as cursor
/* setting the output Parameters fields as zero here*/
 select @@varOptionExercise=0
 select @@varInclusiveSerTax=0
 select @@varInclusiveTurnTax=0
 select @@varInclusiveSebiTax=0
 select @@varInclusiveStampDuty=0
 select @@varClearingHouse=0
 select @@varRemissorAccount=0
 select @@varServiceTaxPayable=0
 select @@varServiceTaxAccount=0
 select @@varBrokerageRealised=0
 select @@varCarryForwardCharge=0
 select @@varSebiTax=0
 select @@varTurnOverTax=0
 select @@varClearingCharges=0
 select @@varReverseClearingCharges=0
 select @@varClearingPremiumAccount=0
 select @@varStampDuty=0
 select @@varRounding=0
 select @@varAccode=0 
set @@flag=cursor for 
   --select AcCode,AcName,Reversed,RevCode,OppCode,EffDate from ValanAccount v where
   --EffDate = (Select Min(EffDate) from valanAccount
   --Where EffDate >=@Sdate)
 select AcCode,AcName,Reversed,RevCode,OppCode,EffDate from ValanAccount v where
   EffDate = (Select Max(EffDate) from valanAccount a 
   Where EffDate<=@Sdate and v.acname=a.acname)
open @@flag
  fetch next from @@flag into
     @@varAcCode ,
     @@varAcName ,
     @@intReserved,
     @@varRevCode,
     @@varOppCode,
     @@dtEffDate
  while @@fetch_status =0
    begin 	
      /*select  @@varAcName*/
     
      If @@varAcName ='OPTION EXERCISE'
          begin
             select @@varOptionExercise = @@varAcCode
          end
      Else
         If @@varAcName ='INCLUSIVE SERVICE TAX'
          begin
             select @@varInclusiveSerTax =@@varAcCode
          end
      Else
         If @@varAcName ='INCLUSIVE TURN TAX'
          begin
             select @@varInclusiveTurnTax =@@varAcCode
          end
      Else
         If @@varAcName ='INCLUSIVE SEBI TAX'
          begin
             select @@varInclusiveSebiTax =@@varAcCode
          end
      Else
         If @@varAcName ='INCLUSIVE STAMP TAX'
          begin
             select @@varInclusiveStampDuty =@@varAcCode
          end
      Else
         If @@varAcName ='CLEARING HOUSE'
          begin
             select @@varClearingHouse =@@varAcCode
          end
      Else
         If @@varAcName ='REMISSOR ACCOUNT'
          begin
             select @@varRemissorAccount =@@varAcCode
          end
      Else
         If @@varAcName ='SERVICE TAX PAYABLE'
          begin
             select @@varServiceTaxPayable =@@varAcCode
          end
      Else
         If @@varAcName ='SERVICE TAX'
          begin
             select @@varServiceTaxAccount =@@varAcCode
          end
      Else
         If @@varAcName ='BROKERAGE REALISED'
          begin
             select @@varBrokerageRealised =@@varAcCode
          end
      Else
         If @@varAcName='CARRY FORWARD CHARGE'
          begin
             select @@varCarryForwardChargE =@@varAcCode
          end
      Else
       If @@varAcName ='SEBI TAX'
          begin
             select @@varSebiTax =@@varAcCode
          end
      Else
         If @@varAcName ='TURN OVER TAX'
          begin
             select @@varTurnOverTax =@@varAcCode
          end
      Else
         If @@varAcName ='CLEARING CHARGES'
          begin
             select @@varClearingCharges =@@varAcCode
          end
      Else
         If @@varAcName ='REVERSE CLEARING CHARGES'
          begin
             select @@varReverseClearingCharges =@@varAcCode
          end
     Else
         If @@varAcName ='CLEARING PREMIUM ACCOUNT'
          begin
             select @@varClearingPremiumAccount =@@varAcCode
          end
     Else
         If @@varAcName ='STAMP DUTY'
          begin
             select @@varStampDuty =@@varAcCode
          end    
     Else
        If @@varAcName ='ROUNDING OFF'
          begin
             select @@varRounding =@@varAcCode
          end   
        
         
          
     fetch next from @@flag into
     @@varAcCode ,
     @@varAcName ,
     @@intReserved,
     @@varRevCode,
     @@varOppCode,
     @@dtEffDate  
    end
   
   select @@varOptionExercise AS OptionExercise ,
  @@varInclusiveSerTax AS InclusiveSerTax,
  @@varInclusiveTurnTax AS InclusiveTurnTax,
  @@varInclusiveSebiTax AS InclusiveSebiTax,
  @@varInclusiveStampDuty AS InclusiveStampDuty,
  @@varClearingHouse AS ClearingHouse,
  @@varRemissorAccount AS RemissorAccount,
  @@varServiceTaxPayable AS ServiceTaxPayable,
  @@varServiceTaxAccount AS ServiceTaxAccount,
  @@varBrokerageRealised AS BrokerageRealised,
  @@varCarryForwardCharge AS CarryForwardCharge,
  @@varSebiTax AS SebiTax,
  @@varTurnOverTax AS TurnOverTax,
  @@varClearingCharges AS ClearingCharges,
  @@varReverseClearingCharges AS ReverseClearingCharges,
  @@varClearingPremiumAccount AS ClearingPremiumAccount,
  @@varStampDuty AS StampDuty ,
  @@varRounding AS Rounding
close @@flag
deallocate @@flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoValanGenerate
-- --------------------------------------------------


CREATE proc [dbo].[BFoValanGenerate] (@Sauda_Date Varchar(11)) As      
Declare       
@@Start_Date Datetime,      
@@ExpiryDate Datetime,      
@@Sett_No Varchar(12),      
@@Sett_Type Varchar(2),      
      
@@BillNo int,      
@@FromParty Varchar(10),      
@@ToParty Varchar(10),      
      
@@ACName Varchar(50),      
@@ACCode Varchar(10),      
@@OppCode Varchar(10),      
@@RevCode Varchar(10),      
@@DummyOppCode Varchar(10),      
@@DummyRevCode Varchar(10),      
      
@@ClrHsgParty Varchar(10) ,      
@@BrkRelParty Varchar(10) ,      
@@SerTaxParty Varchar(10) ,      
@@CESSTaxParty Varchar(10) ,            
@@OptExeParty Varchar(10) ,      
@@RndOffParty Varchar(10) ,      
@@CarForParty Varchar(10) ,      
@@SerTaxPayParty Varchar(10) ,      
@@CESSTaxPayParty Varchar(10),            
@@InsSerTaxParty Varchar(10) ,      
@@InsSebiTaxParty Varchar(10) ,      
@@InsTurnTaxParty Varchar(10) ,      
@@InsBrkNoteParty Varchar(10) ,      
@@RemAccParty Varchar(10) ,      
@@SebiTaxParty Varchar(10) ,      
@@TurnTaxParty Varchar(10) ,      
@@BrkNoteParty Varchar(10) ,      
@@RevClrHsgParty Varchar(10) ,       
@@ConClrHsgParty Varchar(10) ,      
@@ClrPreParty Varchar(10) ,      
@@ClrChrgParty Varchar(10) ,      
@@RevClrChrgParty Varchar(10) ,      
@@inschrgParty varchar(10),            
    
@@MaturityDate Varchar(17),      
@@ExpDate Varchar(11),      
      
@@DummyBranch_Cd Varchar(10),      
@@Branch_cd Varchar(10),      
@@Sell_buy int,      
@@MTOM numeric(18,6),      
@@Premium numeric(18,6),      
@@ExeAssign numeric(18,6),      
@@Brokerage numeric(18,6),      
@@Service_Tax numeric(18,6),      
@@CESS_Tax numeric(18,6),            
@@TService_Tax numeric(18,6),              
@@TCESS_Tax numeric(18,6),              
@@TBrokerage numeric(18,6),          
@@ExService_Tax numeric(18,6),      
@@Turn_Tax numeric(18,6),      
@@Sebi_Tax numeric(18,6),      
@@Broker_Chrg numeric(18,6),      
@@Cl_Chrg numeric(18,6),      
@@ExCl_Chrg numeric(18,6),      
@@DiffAmt numeric(18,6),      
@@TrdAmt  numeric(18,6),      
@@DelAmt  numeric(18,6),      
@@OppAmt  numeric(18,6),      
@@RevAmt  numeric(18,6),      
@@AccAmt  numeric(18,6),      
@@CalSerAmt  numeric(18,6),      
@@inschrg numeric(18,6),            
@@TExService_Tax numeric(18,6),            
@@TExCESS_Tax numeric(18,6),            
      
@@NetMTOM numeric(18,6),      
@@NetPremium numeric(18,6),      
@@NetExeAssign numeric(18,6),      
@@NetBrokerage numeric(18,6),      
@@NetService_Tax numeric(18,6),      
@@NetCESS_Tax numeric(18,6),              
@@NetExCESS_Tax numeric(18,6),              
@@NetExService_Tax numeric(18,6),      
@@NetTurn_Tax numeric(18,6),      
@@NetSebi_Tax numeric(18,6),      
@@NetBroker_Chrg numeric(18,6),      
@@NetCl_Chrg numeric(18,6),      
@@NetExCl_Chrg numeric(18,6),      
@@NetDiffAmt numeric(18,6),      
@@GrossDiffAmt numeric(18,6),      
@@NetTrdAmt  numeric(18,6),      
@@NetDelAmt  numeric(18,6),      
@@Netinschrg numeric(18,6),            
      
@@TrdStDuty numeric(18,6),      
@@DelStDuty numeric(18,6),      
@@StDuty numeric(18,6),      
@@TrdTTDuty numeric(18,6),      
@@DelTTDuty numeric(18,6),      
@@TTDuty numeric(18,6),      
@@Trans_Cat Varchar(3),      
@@Service_Chrg numeric(18,6),      
@@CESS_Chrg numeric(18,6),            
      
@@Sub_Broker varchar(10),      
@@Com_Per numeric(18,6),      
@@BrokShare numeric(18,6),      
@@NetBrokShare numeric(18,6),      
@@GrossBrokShare numeric(18,6),      
      
@@SetMstCur Cursor,      
@@ValanAccCur Cursor,      
@@ValanAmtCur CurSor      
      
Select @@NetMTOM = 0       
Select @@NetPremium = 0       
Select @@NetExeAssign = 0       
Select @@NetBrokerage = 0       
Select @@NetService_Tax = 0       
Select @@NetCESS_Tax = 0               
Select @@TBrokerage = 0           
Select @@TService_Tax = 0              
Select @@TCESS_Tax = 0              
Select @@TExService_Tax = 0              
Select @@TExCESS_Tax = 0            
Select @@NetExService_Tax = 0       
Select @@NetExCESS_Tax = 0               
Select @@NetTurn_Tax = 0       
Select @@NetSebi_Tax = 0       
Select @@NetBroker_Chrg = 0       
Select @@NetCl_Chrg = 0       
Select @@NetExCl_Chrg = 0       
Select @@NetDiffAmt = 0       
Select @@GrossDiffAmt = 0       
Select @@NetTrdAmt  = 0       
Select @@NetDelAmt  = 0      
Select @@Netinschrg  = 0            
      
Set @@SetMstCur = Cursor for              
Select service_tax, CESS_Tax from BFoGlobals  Where @Sauda_Date >= year_start_dt and @Sauda_Date <=  year_end_dt             
Open @@SetMstCur               
Fetch Next From @@SetMstCur into @@Service_Chrg, @@CESS_Chrg              
Close @@SetMstCur              
DeAllocate @@SetMstCur              
    

Select @@FromParty = Min(Party_Code),@@ToParty=Max(Party_Code) From Client2       
      
Exec BFoValanPop @Sauda_Date,@@FromParty,@@ToParty      
      
select @@MaturityDate = left(convert(varchar,Maturitydate,109),11) + ' 23:59',@@ExpDate = left(convert(varchar,Expirydate,109),11)       
from Bfoscrip2 where  left(convert(varchar,maturitydate,109),11) like @Sauda_Date + '%'      
     
  
   
If @@MaturityDate Is Not Null  
 begin     
   Exec BFoRearrangeBillflag @@MaturityDate      
 end  
      
Delete from BFoAccBill where BillDate Like @Sauda_Date + '%'      
      
Set @@ValanAccCur = Cursor For      
select Top 1 Sett_no,Sett_Type,Start_Date=Left(Convert(Varchar,Start_Date,109),11),ExpiryDate=Left(Convert(Varchar,ExpiryDate,109),11)      
from bfosett_mst where maturitydate >= @Sauda_Date      
Open @@ValanAccCur      
Fetch Next From @@ValanAccCur into @@Sett_No,@@Sett_Type,@@Start_Date,@@ExpiryDate      
Close @@ValanAccCur      
DeAllocate @@ValanAccCur      
      
Select @@Sett_No='0',@@Sett_Type='F',@@Start_Date=@Sauda_Date,@@ExpiryDate=@Sauda_Date

/* Start of Party Bill Amount */      
      
insert into BFoAccBill        
Select Party_Code,BillNo='0',      
Sell_buy = (Case When Sum(Case When ParticipantCode = MemberCode       
          Then SBillAmt - PBillAmt - (service_tax - ExSer_Tax + turn_tax + ins_chrg + sebi_tax + broker_note + cl_chrg-excl_chrg) 
          Else -1 End ) > 0       
   Then 2      
          Else 1      
     End),      
sett_no=@@Sett_No,sett_type=@@Sett_Type,Sauda_Date,Start_Date=Sauda_Date,End_Date=Sauda_Date,Sec_Payin=Sauda_Date,Sec_Payout=Sauda_Date,      
Amount = Round(Abs(Sum(Case When ParticipantCode = MemberCode       
                    Then SBillAmt - PBillAmt - (service_tax - ExSer_Tax + turn_tax + ins_chrg + sebi_tax + broker_note + cl_chrg-excl_chrg)      
                                         Else SBillAmt + PBillAmt + (service_tax - ExSer_Tax + turn_tax + ins_chrg + sebi_tax + broker_note + cl_chrg-excl_chrg)       
          End)),2) ,      
MTM = Round(Abs(Sum(Case When ParticipantCode = MemberCode       
                    Then SBillAmt - PBillAmt + SBrokAmt - PBrokAmt       
                                         Else SBillAmt + PBillAmt - SBrokAmt - PBrokAmt       
          End)),2) ,      
0,0,0,      
Brokerage=Round(Sum(SBrokAmt + PBrokAmt),2),      
Service_Tax=Round(Sum(service_tax - ExSer_Tax),4),      
0,0,0,0,0,      
Branch_code,'Bill Posted'      
from BFoBillValan, BFOOwner where Sauda_Date Like @Sauda_Date + '%'      
Group By Branch_code,Party_code,Sauda_Date, Product_Type, AuctionPart  
      
/* End of Party Bill Amount */      
      
Set @@ValanAccCur = Cursor For      
 Select ACName,ACCode from valanaccount V where Effdate = (Select Max(EffDate) from ValanAccount A      
 Where A.EffDate <= @Sauda_Date and V.AcName = A.AcName) Order By AcName      
Open @@ValanAccCur      
Fetch Next From @@ValanAccCur into @@ACName,@@ACCode      
while @@Fetch_Status = 0       
Begin      
 if @@ACName = 'CLEARING HOUSE'        
  Select @@ClrHsgParty = @@ACCode      
 if @@ACName = 'BROKERAGE REALISED'   
  Select @@BrkRelParty = @@ACCode      
 if @@ACName = 'SERVICE TAX'        
  Select @@SerTaxParty = @@ACCode      
 if @@ACName = 'CESS TAX'                
   Select @@CESSTaxParty = @@ACCode              
 if @@ACName = 'OPTION EXERCISE'        
  Select @@OptExeParty = @@ACCode      
 if @@ACName = 'ROUNDING OFF'        
  Select @@RndOffParty = @@ACCode      
 if @@ACName = 'CARRY FORWARD CHARGE'        
  Select @@CarForParty = @@ACCode      
 if @@ACName = 'SERVICE TAX PAYABLE'        
  Select @@SerTaxPayParty = @@ACCode      
 if @@ACName = 'INCLUSIVE SERVICE TAX'        
  Select @@InsSerTaxParty = @@ACCode      
 if @@ACName = 'INCLUSIVE SEBI TAX'        
  Select @@InsSebiTaxParty = @@ACCode      
 if @@ACName = 'INCLUSIVE TURN TAX'        
  Select @@InsTurnTaxParty = @@ACCode      
 if @@ACName = 'INCLUSIVE STAMP TAX'        
  Select @@InsBrkNoteParty = @@ACCode      
 if @@ACName = 'REMISSOR ACCOUNT'        
  Select @@RemAccParty = @@ACCode      
 if @@ACName = 'SEBI TAX'        
  Select @@SebiTaxParty = @@ACCode      
 if @@ACName = 'CESS TAX PAYABLE'                
   Select @@CESSTaxPayParty = @@ACCode              
 if @@ACName = 'TURN OVER TAX'        
  Select @@TurnTaxParty = @@ACCode      
 if @@ACName = 'STAMP DUTY'        
  Select @@BrkNoteParty = @@ACCode      
 if @@ACName = 'REVERSE CLRG HOUSE'        
  Select @@RevClrHsgParty = @@ACCode       
 if @@ACName = 'CONS. CLRG HOUSE'        
  Select @@ConClrHsgParty = @@ACCode      
 if @@ACName = 'CLEARING CHARGES'        
  Select @@ClrChrgParty = @@ACCode      
 if @@ACName = 'REVERSE CLEARING CHARGES'        
  Select @@RevClrChrgParty = @@ACCode      
 if @@ACName = 'CLEARING PREMIUM ACCOUNT'        
  Select @@ClrPreParty = @@ACCode      
 if @@ACName = 'SECURITY TRANSACTION TAX'              
  Select @@InschrgParty = @@ACCode            
      
 Fetch Next From @@ValanAccCur into @@ACName,@@ACCode      
End      
Close @@ValanAccCur      
DeAllocate @@ValanAccCur      
      
/* Exchange and levis Branch wise Obligation Amount */      
Set @@ValanAmtCur = Cursor for       
 Select Branch_Code,      
 MTOM      = IsNull(Sum(Case When Product_Code Like '%FUT' AND ParticipantCode = MemberCode       
        Then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT       
        Else 0       
          End),0),      
 Premium   = IsNull(Sum(Case When Product_Code Like '%OPT' And AuctionPart <> 'EA' And TradeType = 'BT' AND ParticipantCode = MemberCode       
        Then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT       
        Else 0       
          End),0),      
 ExeAssign = IsNull(Sum(Case When Product_Code Like '%OPT' And AuctionPart = 'EA' And TradeType = 'BT' AND ParticipantCode = MemberCode       
        Then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT       
        Else 0       
          End),0),      
 Brokerage=Sum(SBrokAmt + PBrokAmt),      
 Service_Tax=Sum(Service_Tax),ExService_Tax=Sum(ExSer_Tax),      
 Turn_Tax=Sum(Turn_Tax),Sebi_Tax=Sum(Sebi_Tax), ins_chrg=Sum(ins_chrg),      
 Broker_Chrg=Sum(Broker_Note),Cl_Chrg = Sum(Cl_Chrg),ExCl_Chrg = Sum(ExCl_Chrg)       
 From BFoBillValan, BFOOwner Where Sauda_Date Like @Sauda_Date + '%'      
 Group By Branch_Code      
 Order By Branch_Code      
Open @@ValanAmtCur       
Fetch Next From @@ValanAmtCur into @@Branch_cd,@@MTOM,@@Premium,@@ExeAssign,@@Brokerage,@@Service_Tax,      
                @@ExService_Tax,@@Turn_Tax,@@Sebi_Tax,@@Inschrg,@@Broker_Chrg,@@Cl_Chrg,@@ExCl_Chrg      
While @@Fetch_Status = 0       
Begin       
 Select @@NetMTOM = @@NetMTOM + @@MTOM            
 Select @@NetPremium = @@NetPremium + @@Premium            
 Select @@NetExeAssign = @@NetExeAssign + @@ExeAssign             
 Select @@NetTurn_Tax = @@NetTurn_Tax + @@Turn_Tax            
 Select @@NetSebi_Tax = @@NetSebi_Tax + @@Sebi_Tax            
 Select @@NetBroker_Chrg = @@NetBroker_Chrg + @@Broker_Chrg             
 Select @@NetCl_Chrg = @@NetCl_Chrg + @@Cl_Chrg            
 Select @@NetExCl_Chrg = @@NetExCl_Chrg + @@ExCl_Chrg            
 Select @@NetInschrg  = @@NetInschrg + @@Inschrg            
 Select @@TService_Tax =  @@Service_Tax              
 Select @@TExService_Tax =  @@ExService_Tax               
            
 Select @@TCESS_Tax = @@Service_Tax - Round(( @@Service_Tax * 100 ) / ( 100 + @@CESS_Chrg ),2)          
 Select @@TService_Tax = @@Service_Tax - @@TCESS_Tax          
              
 Select @@TExCESS_Tax = @@TExService_Tax - Round(( @@TExService_Tax * 100 ) / ( 100 + @@CESS_Chrg ),2)            
 Select @@TExService_Tax = @@TExService_Tax - @@TExCESS_Tax            
            
 Select @@NetCESS_Tax = @@NetCESS_Tax + @@TCESS_Tax              
 Select @@NetExCESS_Tax = @@NetExCESS_Tax + @@TExCESS_Tax               
            
 Select @@NetExService_Tax = @@NetExService_Tax + @@TExService_Tax              
 Select @@NetService_Tax = @@NetService_Tax + @@TService_Tax            
 Select @@TBrokerage = @@Brokerage          
 Select @@NetBrokerage = @@NetBrokerage + @@TBrokerage            
       
 If @@MTOM > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@ClrHsgParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@MTOM),2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')       
          
 If @@Premium > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@ClrPreParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@Premium),2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 If @@ExeAssign > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@OptExeParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@ExeAssign),2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 insert into BFoAccBill Values ( @@BrkRelParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@TBrokerage,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 insert into BFoAccBill Values ( @@SerTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@TService_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
        
 insert into BFoAccBill Values (@@InsSerTaxParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@ExService_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 if Round(@@TCESS_Tax,2) <> 0             
 begin            
   insert into BFOAccBill Values (@@CESSTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@TCESS_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
 end            
            
            
  if Round(@@TExCESS_Tax,2) <> 0            
   begin            
    insert into BFOAccBill Values (@@CESSTaxPayParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@TExCESS_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
  end            
            
    
 insert into BFoAccBill Values ( @@TurnTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@Turn_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
       
 insert into BFoAccBill Values ( @@SebiTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@Sebi_Tax,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 insert into BFoAccBill Values ( @@BrkNoteParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@Broker_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
      
 insert into BFoAccBill Values ( @@ClrChrgParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@Cl_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
        
 insert into BFoAccBill Values ( @@RevClrChrgParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@ExCl_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
    
    
 insert into BFOAccBill Values ( @@InschrgParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@Inschrg,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
    
    
      
 Fetch Next From @@ValanAmtCur into @@Branch_cd,@@MTOM,@@Premium,@@ExeAssign,@@Brokerage,@@Service_Tax,      
                      @@ExService_Tax,@@Turn_Tax,@@Sebi_Tax,@@Inschrg,@@Broker_Chrg,@@Cl_Chrg,@@ExCl_Chrg      
      
End      
Close @@ValanAmtCur      
DeAllocate @@ValanAmtCur      
      
Select @@NetBrokShare = 0      
Select @@GrossBrokShare = 0      
      
Set @@ValanAmtCur = Cursor for      
select sb.sub_broker,com_perc, BRANCH_CD, Brokerage = Sum(PBrokAmt+SBrokAmt)*com_perc/100      
from BFoBillValan s, client2 c2,client1 c1,subbrokers sb      
Where s.party_code = c2.party_code and c1.cl_code = c2.cl_code       
and c1.Sub_Broker = sb.sub_broker       
and sb.com_perc > 0       
and s.sauda_date Like @Sauda_Date + '%'      
Group By sb.sub_broker,com_perc,BRANCH_CD      
Order By sb.sub_broker,BRANCH_CD      
Open @@ValanAmtCur       
Fetch Next From @@ValanAmtCur into @@Sub_Broker,@@Com_Per,@@Branch_Cd,@@BrokShare      
While @@Fetch_Status = 0        
Begin      
 Select @@DummyBranch_Cd = @@Branch_Cd      
 While @@DummyBranch_Cd = @@Branch_Cd and @@Fetch_Status = 0        
 Begin      
  Select @@NetBrokShare = @@NetBrokShare + @@BrokShare      
  Select @@GrossBrokShare = @@GrossBrokShare + @@BrokShare      
      
  insert into BFoAccBill Values ( @@Sub_Broker,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
               Round(@@BrokShare,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
         
  Fetch Next From @@ValanAmtCur into @@Sub_Broker,@@Com_Per,@@Branch_Cd      
 End      
 /*    
insert into BFoAccBill Values ( @@RemAccParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
       Round(@@NetBrokShare,2),0,0,0,0,0,0,0,0,0,0,0,@@Branch_cd,'Bill Posted')      
 Select @@NetBrokShare = 0      
*/    
End      
      
Set @@ValanAmtCur = Cursor for      
 Select Amount = Isnull(Sum(Amount),0),BranchCd,Sell_Buy From BFoAccBill Where       
 BillDate Like @Sauda_Date + '%' and Branchcd <> 'ZZZ'      
 Group by BranchCD,Sell_Buy       
 Order by BranchCD,Sell_Buy      
Open @@ValanAmtCur       
Fetch Next from @@ValanAmtCur into @@DiffAmt,@@Branch_Cd,@@Sell_Buy      
While @@Fetch_Status = 0        
Begin      
 Select @@DummyBranch_Cd = @@Branch_Cd      
 Select @@NetDiffAmt = 0      
 While @@DummyBranch_Cd = @@Branch_Cd and @@Fetch_Status = 0       
 Begin      
  If @@Sell_Buy = 1       
  Begin      
   Select @@NetDiffAmt = @@NetDiffAmt + @@DiffAmt      
   Select @@GrossDiffAmt = @@GrossDiffAmt + @@DiffAmt      
  End       
  Else      
  Begin                              
   Select @@NetDiffAmt = @@NetDiffAmt - @@DiffAmt       
   Select @@GrossDiffAmt = @@GrossDiffAmt - @@DiffAmt      
  End      
  Fetch Next from @@ValanAmtCur into @@DiffAmt,@@Branch_Cd,@@Sell_Buy        
 End      
 if @@NetDiffAmt > 0       
  insert into BFoAccBill Values ( @@RndOffParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@NetDiffAmt),2),0,0,0,0,0,0,0,0,0,0,0,@@DummyBranch_Cd,'Bill Posted')      
 Else if @@NetDiffAmt < 0       
  insert into BFoAccBill Values ( @@RndOffParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@NetDiffAmt),2),0,0,0,0,0,0,0,0,0,0,0,@@DummyBranch_Cd,'Bill Posted')      
       
End      
Close @@ValanAmtCur      
DeAllocate @@ValanAmtCur      
      
 If @@NetMTOM > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@ClrHsgParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@NetMTOM),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')       
          
 If @@NetPremium > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@ClrPreParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@NetPremium),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 If @@NetExeAssign > 0       
  Select @@Sell_Buy = 1        
 Else      
  Select @@Sell_Buy = 2      
    insert into BFoAccBill Values ( @@OptExeParty,0,@@Sell_buy,@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@NetExeAssign),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 insert into BFoAccBill Values ( @@BrkRelParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetBrokerage,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 insert into BFoAccBill Values ( @@SerTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetService_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')       
        
 if Round(@@NetCESS_Tax,2) <> 0             
  begin            
   insert into BFOAccBill Values ( @@CESSTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@NetCESS_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')       
  end            
 if Round(@@NetExCESS_Tax,2) <> 0             
  begin            
   insert into BFOAccBill Values ( @@CESSTaxPayParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@NetExCESS_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')       
  end            
    
 insert into BFoAccBill Values ( @@InsSerTaxParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetExService_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 insert into BFoAccBill Values ( @@TurnTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetTurn_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
       
 insert into BFoAccBill Values ( @@SebiTaxParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetSebi_Tax,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 insert into BFoAccBill Values ( @@BrkNoteParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetBroker_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 insert into BFoAccBill Values ( @@ClrChrgParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetCl_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
        
 insert into BFoAccBill Values ( @@RevClrChrgParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@NetExCl_Chrg,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
 /*insert into BFoAccBill Values ( @@RemAccParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(@@GrossBrokShare,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
*/  
      
 insert into BFOAccBill Values ( @@InschrgParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,            
         Round(@@NetInschrg,2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
    
Select @@OppAmt = 0      
      
Set @@ValanAmtCur = Cursor for      
 Select OppCode,RevCode,AcCode from valanAccount where Reversed = 1       
 and EffDate = (Select Min(EffDate) from valanAccount      
 Where EffDate <= @Sauda_Date ) Order by OppCode,RevCode      
Open @@ValanAmtCur       
Fetch Next From @@ValanAmtCur into @@OppCode,@@RevCode,@@AcCode       
While @@Fetch_Status =  0      
Begin      
 Select @@DummyOppCode = @@OppCode      
 While @@DummyOppCode = @@OppCode and @@Fetch_Status =  0      
 Begin      
  Select @@RevAmt = 0      
  Select @@DummyRevCode = @@RevCode      
  While @@DummyRevCode = @@RevCode and @@DummyOppCode = @@OppCode and @@Fetch_Status =  0      
  Begin      
   Set @@ValanAccCur = Cursor for      
    Select Amount,Sell_Buy From BFoAccBill where BillDate Like @Sauda_Date + '%'      
    and Party_Code = @@AcCode And BranchCd = 'ZZZ'      
   Open @@ValanAccCur       
   Fetch Next from @@ValanAccCur into @@AccAmt,@@Sell_Buy      
      
   if @@Fetch_Status =  0      
   Begin      
    if @@Sell_Buy = 1       
    Begin      
     Select @@RevAmt = @@RevAmt + @@AccAmt      
     Select @@OppAmt = @@OppAmt + @@AccAmt      
    End      
    Else      
    Begin      
     Select @@RevAmt = @@RevAmt - @@AccAmt      
     Select @@OppAmt = @@OppAmt - @@AccAmt      
    End      
   End      
   Else      
   Close @@ValanAccCur      
 DeAllocate @@ValanAccCur      
   Fetch Next From @@ValanAmtCur into @@OppCode,@@RevCode,@@AcCode       
  End      
  if @@RevAmt > 0       
   insert into BFoAccBill Values ( @@DummyRevCode,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
          Round(Abs(@@RevAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
  Else      
   insert into BFoAccBill Values ( @@DummyRevCode,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
          Round(Abs(@@RevAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
 End       
 if @@OppAmt > 0      
  insert into BFoAccBill Values ( @@DummyOppCode,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@OppAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')        
 Else      
  insert into BFoAccBill Values ( @@DummyOppCode,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
         Round(Abs(@@OppAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
End      
Close @@ValanAmtCur      
DeAllocate @@ValanAmtCur      
      
Select @@GrossDiffAmt = 0      
      
Set @@ValanAmtCur = Cursor for      
      
Select Amount = Isnull(Sum(Amount),0),Sell_Buy From BFoAccBill A,accountBFO.Dbo.AcMAst M       
Where BillDate Like @Sauda_Date + '%'      
and A.Party_code = M.CltCode And (BranchCd = 'ZZZ' or AcCat = 4 )      
Group by Sell_buy      
      
Open @@ValanAmtCur       
Fetch Next from @@ValanAmtCur into @@DiffAmt,@@Sell_Buy      
While @@Fetch_Status = 0        
Begin      
 Begin      
  If @@Sell_Buy = 1       
  Begin        
   Select @@GrossDiffAmt = @@GrossDiffAmt + @@DiffAmt      
  End        
  Else      
  Begin                          
   Select @@GrossDiffAmt = @@GrossDiffAmt - @@DiffAmt               
  End      
  Fetch Next from @@ValanAmtCur into @@DiffAmt,@@Sell_Buy      
 End      
End      
Close @@ValanAmtCur      
DeAllocate @@ValanAmtCur      
      
if @@GrossDiffAmt > 0       
 insert into BFoAccBill Values ( @@RndOffParty,0,'2',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
        Round(Abs(@@GrossDiffAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
Else       
 insert into BFoAccBill Values ( @@RndOffParty,0,'1',@@Sett_No,@@Sett_Type,@Sauda_Date,@@Start_Date,@@ExpiryDate,@@ExpiryDate,@@ExpiryDate,      
        Round(Abs(@@GrossDiffAmt),2),0,0,0,0,0,0,0,0,0,0,0,'ZZZ','Bill Posted')      
      
--Delete From BFoAccBill Where Amount = 0 And BillDate Like @Sauda_Date + '%'      
      
--Exec FOGENBILLNO @Sauda_Date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BFoValanPop
-- --------------------------------------------------

CREATE proc BFoValanPop   
(  
 @SDate Varchar(11),  
 @fParty Varchar(12) ='0',  
 @tParty Varchar(12) ='zzzzzzz'  
) As       
      
Delete From TBL_MtomPremiumBill Where BillDate Like @Sdate + '%' And Party_code Between @FParty And @TParty      
                  
Select * Into #BFoClosing  
From  BFoClosing  
where BFoClosing.trade_date = ( select max(trade_date) from BFoClosing  
                    where BFoClosing.trade_date < @Sdate)  
  
Select * Into #BFoClosingtoday                 
From  BFoClosing                   
where BFoClosing.trade_date Like @Sdate+ '%'                  
  
  
/*---------------------------------------------------------------------------------------*/
Update BFoSettlement Set 
Service_Tax = ((TradeQty*Brokapplied)+
	      (Case When G.Insurance_Chrg_Ac = 1 And C2.Insurance_Chrg = 1 
		    Then BFoSettlement.Ins_Chrg
	            Else 0 
	       End)+
	      (Case When G.TurnOver_Ac = 1 And C2.Turnover_tax = 1 
		    Then BFoSettlement.Turn_Tax
	            Else 0 
	       End)+
	      (Case When G.Sebi_Turn_Ac = 1 And C2.Sebi_Turn_tax = 1 
		    Then BFoSettlement.Sebi_Tax
	            Else 0 
	       End)+
	      (Case When G.Broker_Note_Ac = 1 And C2.BrokerNote = 1 
		    Then BFoSettlement.Broker_Chrg
	            Else 0 
	       End)+
	      (Case When G.Other_Chrg_Ac = 1 And C2.Other_chrg = 1
		    Then BFoSettlement.Other_Chrg
	            Else 0 
	       End)) * G.Service_tax /100
From BFoGlobals G, Client2 C2
Where 
	Sauda_Date Like @SDate + '%' And
	Sauda_Date Between Year_Start_Dt and Year_End_Dt And
	BFoSettlement.Party_Code = C2.Party_Code And
	1 <> (Case When Service_chrg = 1 And SerTaxMethod = 1 
	       Then 1 Else 0 End) 
/*---------------------------------------------------------------------------------------*/

Insert Into TBL_MtomPremiumBill                  
Select billdate =@Sdate + ' 23:59:00' ,                  
pqty = (case when s.sell_buy = 1                  
then (case when s.reserved1 <> 1                   
          then sum(s.tradeqty)                   
          else 0                  
            end )                  
             else 0                  
        end),                  
sqty = (case when s.sell_buy = 2                  
             then (case when s.reserved1 <> 1                   
          then sum(s.tradeqty)                   
   else 0                   
                   end)                  
             else 0                   
        end )  ,                  
netrate = isnull(( Select   
    BFoClosing.cl_rate   
   from   
    #BFoClosing BFoClosing  
   Where  
    BFoClosing.Product_Type = S.Product_Type  
    And BFoClosing.Product_Code = S.Product_Code  
    And BFoClosing.Series_Code = S.Series_Code  
    And BFoClosing.Series_Id = S.Series_Id  
                ),0),  
cl_rate  = isnull(( Select   
    BFoClosing.cl_rate   
   from   
    #BFoClosingtoday BFoClosing  
   Where  
    BFoClosing.Product_Type = S.Product_Type  
    And BFoClosing.Product_Code = S.Product_Code  
    And BFoClosing.Series_Code = S.Series_Code  
    And BFoClosing.Series_Id = S.Series_Id  
                ),0),  
s.Party_Code,  
S.Product_Type,S.Product_Code,S.Series_Code,S.Series_Id,  
S.EXPIRYDATE,S.Strike_Price,  
sdate = @Sdate,                  
sell_buy ,                  
service_tax=0,                  
Brok= 0,                  
nonexpiryservice_tax=0,                  
nonexpirybrok = 0,                  
sebi_tax=0,turn_tax=0,stampduty=0,                  
inex_Service_tax=0,                  
inex_Sebi_tax=0,                  
inex_turn_tax=0,                  
inex_stampduty=0,                  
expiryBrok= 0,                  
expiryservice_tax= 0,                  
insurance_chrg = 0,                  
inex_insurance_chrg = 0,                  
other_chrg = 0,                  
inex_other_chrg = 0,                  
auctionpart = '',                  
netwithbrok  = isnull(( Select   
    BFoClosing.cl_rate   
   from   
    #BFoClosing BFoClosing  
   Where  
    BFoClosing.Product_Type = S.Product_Type  
    And BFoClosing.Product_Code = S.Product_Code  
    And BFoClosing.Series_Code = S.Series_Code  
    And BFoClosing.Series_Id = S.Series_Id  
                ),0),  
bfdayflag = 'B-F',                  
s.reserved1 ,                  
actbuyqty = (  case when s.sell_buy = 1                  
               then                    
                  sum(s.tradeqty)                  
            else                  
               0                   
             end                   
),                  
actsellqty = ( case when s.sell_buy = 2                  
               then                   
    sum(s.tradeqty)       
   else                  
  0                   
           end )                  
from BFOSettlement s,  Bfoscrip2                   
where   
 sauda_date < @Sdate                  
 And BfoScrip2.Product_Type = S.Product_Type  
 And BfoScrip2.Product_Code = S.Product_Code  
 And BfoScrip2.Series_Code = S.Series_Code  
 And BfoScrip2.Series_Id = S.Series_Id  
 And s.Product_Code like '%FUT'                  
 and Bfoscrip2.maturitydate >= @SDate     
Group by   
 s.party_code,s.Product_Type,s.Product_Code,s.Series_Code,S.Series_Id,  
 S.EXPIRYDATE,S.Strike_Price,sell_Buy,convert(varchar,s.expirydate,103),  
 s.expirydate,Bfoscrip2.maturitydate,s.reserved1                 
                
  
Select  ContractNo,BillNo,Trade_no=Pradnya.DBO.ReplaceTradeNo(Trade_No),  
 Party_Code,product_type,product_code,Series_code,Series_id,  
 expirydate,multiplier,Tradeqty,AuctionPart,  
 MarketRate,strike_price,Sauda_date,Sell_buy,NetRate,  
 Ins_chrg=sum(ins_chrg),turn_tax=sum(turn_tax),  
 other_chrg=sum(other_chrg),sebi_tax=sum(sebi_tax),Broker_chrg=sum(Broker_chrg),  
 Service_tax=sum(Service_tax),Cl_type,participantcode,  
 TotalBrok = sum(BrokApplied * TradeQty),  
 billflag,reserved1,NSerTax  
into #BFoSettlement   
from  
 BFoSettlement   
where   
 Sauda_date like  @Sdate + '%'   
 And tradeqty * MarketRate > 0  
Group by  
 ContractNo,BillNo,Pradnya.DBO.ReplaceTradeNo(Trade_No),  
 Party_Code,product_type,product_code,Series_code,Series_id,  
 expirydate,multiplier,Tradeqty,AuctionPart,  
 MarketRate,strike_price,Sauda_date,Sell_buy,NetRate,  
 Cl_type,participantcode,billflag,reserved1,NSerTax  
  
Update  
 #BFoSettlement  
Set   
 TotalBrok = CD_Tot_Brok,   
 Service_tax = Service_tax+CD_Tot_SerTax  
From  
 Charges_Detail  
Where  
 Left(CD_Sauda_Date,11) = @Sdate  
 And Left(CD_Sauda_Date,11) = Left(Sauda_Date,11)  
 And CD_Party_Code = Party_Code  
 And CD_Product_Type = Product_Type  
 And CD_Product_Code = Product_Code  
 And CD_Series_Code = Series_Code  
 And CD_Series_Id = Series_Id  
 And CD_Trade_No = Trade_No  
  
  
    
  
  
Insert Into Tbl_MtomPremiumBill                  
select billdate = @SDate + ' 23:59:00' ,                  
pqty = (  case when s.sell_buy = 1                  
               then                    
                case when s.reserved1<>1 then                  
                  sum(s.tradeqty) else 0                  
              end                   
            else                  
               0                   
             end  
),  
sqty = ( case when s.sell_buy = 2                  
               then                   
                   case when s.reserved1 <> 1 then                   
                           sum(s.tradeqty) else 0                   
                     end                  
             else                  
              0                   
                end ) ,  
isnull(s.MarketRate,0),                  
Cl_Rate  = isnull(( Select   
    BFoClosing.cl_rate   
   from   
    #BFoClosingtoday BFoClosing  
   Where  
    BFoClosing.Product_Type = S.Product_Type  
    And BFoClosing.Product_Code = S.Product_Code  
    And BFoClosing.Series_Code = S.Series_Code  
    And BFoClosing.Series_Id = S.Series_Id  
                ),0),  
s.Party_Code,                  
S.Product_Type,S.Product_Code,S.Series_Code,S.Series_Id,  
S.EXPIRYDATE,S.Strike_Price,  
sdate=left(convert(varchar,sauda_date,109),11) + ' 00:00:00',                  
sell_buy,  
service_tax=(case when (c2.service_chrg=1 or  c2.service_chrg=0) then                  
                                    sum(Service_tax)                   
                          else                  
                 0                  
                       end),                  
                  
Brok=  Sum(TotalBrok),                  
                  
nonexpiryservice_tax=(case when (c2.service_chrg=1 or  c2.service_chrg=0) then                  
                              sum(Service_tax)                   
                          else                  
                             0                  
                       end),                  
                  
nonexpiryBrok= Sum(TotalBrok),                  
                  
sebi_tax=(case when ( c2.Sebi_Turn_tax=1 ) then                  
                 isnull(sum(s.sebi_tax),0)                    
             else                  
                0                    
           end ) ,                  
turn_tax=(case when( c2.TurnOver_Tax=1) then                  
  isnull(sum(s.turn_tax),0)                  
 else 0                   
 end ),                  
stampduty=(case when( c2.brokernote=1) then                  
                    sum(s.broker_chrg)           
             else                  
                0                    
           end ) ,                  
inex_Service_tax=(case when c2.service_chrg=2 then                  
  Isnull(sum(Service_tax),0)                   
             else                  
                0                    
           end ),                  
inex_Sebi_tax=(case when c2.Sebi_Turn_tax=1 then                  
                 isnull(sum(s.sebi_tax),0)                    
             else                  
                0                    
           end ),                  
inex_turn_tax=(case when c2.Turnover_tax=1 then                  
                 isnull(sum(s.turn_tax),0)                  
             else                  
                0                    
           end ),                  
inex_stampduty=(case when c2.brokernote=1 then                  
                    sum(s.broker_chrg)                  
             else                  
                0                    
           end ),                  
                  
expiryBrok= Sum(abs(Service_tax)*tradeqty),                  
expiryservice_tax=(case when (c2.service_chrg=1 or  c2.service_chrg=0) then                  
                                    Isnull(Sum( NSerTax  ),0)                   
                          else                  
                             0                 
                       end),                  
insurance_chrg=(case when( c2.insurance_chrg=1) then                  
                    sum(s.ins_chrg)                  
             else                  
                0                    
           end ) ,                  
inex_insurance_chrg=(case when c2.insurance_chrg=1 then                  
                    sum(s.ins_chrg)                  
          else                  
                0                    
           end ),                  
                  
other_chrg=(case when( c2.other_chrg=1) then                  
           sum(s.other_chrg)         
 else                  
           0                    
        end ) ,                  
inex_other_chrg=(case when c2.other_chrg=1 then                  
            sum(s.other_chrg)                  
         else                  
              0                    
         end ),                  
auctionpart = s.auctionpart,                  
netwithbrok = s.netrate,                  
bfdayflag = '',                  
s.reserved1  ,                  
actbuyqty = (  case when s.sell_buy = 1                  
               then                    
                  sum(s.tradeqty)                  
            else                  
               0                   
             end                   
),                  
actsellqty = ( case when s.sell_buy = 2                  
               then                   
                           sum(s.tradeqty)                   
   else                  
  0                   
                end )                  
from Client2 c2, #BFoSettlement s , Bfoscrip2                  
where   
 sauda_date Like @SDate + '%'  
 And BfoScrip2.Product_Type = S.Product_Type  
 And BfoScrip2.Product_Code = S.Product_Code  
 And BfoScrip2.Series_Code = S.Series_Code  
 And BfoScrip2.Series_Id = S.Series_Id  
 AND s.party_code=c2.party_code    
group by   
 left(convert(varchar,sauda_date,109),11) + ' 00:00:00',s.MarketRate,s.party_code,  
 s.Product_Type,s.Product_Code,s.Series_Code,S.Series_Id,S.Strike_Price,  
 S.EXPIRYDATE,left(convert(varchar,sauda_date,109),11),sell_Buy ,                  
 convert(varchar,s.expirydate,103),sebi_tax,s.expirydate,s.billflag,  
 c2.service_chrg,c2.sebi_turn_tax,c2.turnover_tax,c2.brokernote,s.reserved1,  
 c2.insurance_chrg,c2.other_chrg,s.auctionpart,s.netrate,Bfoscrip2.maturitydate                
  
  
/*=========================================================================================*/  
Delete From BFOBILLVALAN Where Sauda_Date Like @Sdate + '%' And Party_code Between @FParty And @TParty      
      
/* Brought Forward Trades */        
Insert into BFOBILLVALAN       
select S.Party_Code,Long_Name=Left(Long_Name,50),Client_Type=C1.Cl_Type,BillNo,0 ContractNo,s.Product_Code,s.Series_Code,s.expirydate,s.Product_Type,S.Series_ID,s.Strike_Price,F.MarketLot,      
'0' AuctionPart,F.MaturityDate,Sauda_date=@SDate + ' 23:59',IsIn='',      
PQty=Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End),               
SQty=Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End),      
PRate=Round((Case When Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End) > 0 Then Sum(Case When Sell_buy = 1 Then s.TradeQty*MarketRate Else 0 End)/Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End) Else 0 End ),4),      
SRate=Round((Case When Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End) > 0 Then Sum(Case When Sell_buy = 2 Then s.TradeQty*MarketRate Else 0 End)/Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End) Else 0 End),4) ,        
PAmt =Round(Sum(Case When Sell_buy = 1 Then (s.TradeQty*NetRate) + (Case When C2.Service_Chrg = 1 Then Service_Tax Else 0 End) Else 0 End),4),       
SAmt =Round(Sum(Case When Sell_buy = 2 Then (s.TradeQty*NetRate) + (Case When C2.Service_Chrg = 1 Then Service_Tax Else 0 End) Else 0 End),4),      
PBrokAmt=0, SBrokAmt=0, PBillAmt=0, SBillAmt=0, Cl_Rate = 0,Cl_Chrg=0,ExCl_Chrg=0,service_tax=0,ExSer_Tax=0,InExSerFlag=Service_Chrg,      
sebi_tax=0,turn_tax=0,Broker_note=0,Ins_Chrg=0,Other_Chrg=0,TradeType='BF',ParticiPantCode=MemberCode,Terminal_Id='',      
Family,FamilyName='',Trader,Branch_Code=C1.Branch_Cd,Sub_Broker,StatusName='',Exchange='BSEFO',Segment='FUTURE',MemberType,      
CompanyName='',Region=c1.Region,UpdateDate=Left(Convert(Varchar,GetDate(),109),11),      
EMail='',SBU='',RELMGR='',Grp='',Sector='',      
CmClosing=0,      
Track='',C1.Area      
from Bfoscrip2 F,BFosettlement s, BFoOwner, Client1 C1, Client2 C2         
where         
     sauda_date < @SDate       
     and F.Product_Code=s.Product_Code        
     and F.Series_Code=s.Series_Code      
     and F.Series_Id=s.Series_Id      
     and convert(varchar,s.expirydate,103) = convert(varchar,F.expirydate,103)       
     and F.strikeprice=s.strike_price       
     and F.Product_Type=s.Product_Type        
     and F.maturitydate >= @SDate       
     And Ltrim(Rtrim(S.Party_Code)) >= @FParty and Ltrim(Rtrim(S.Party_Code)) <= @TParty      
     And S.Party_Code = C2.Party_Code And C2.Cl_Code = C1.Cl_Code And s.reserved1<>1      
group by S.party_code,s.Product_Code,s.Product_Code,f.maturitydate,s.strike_price,s.Product_Type,s.expirydate,      
Long_Name,C1.Cl_Type,BillNo,Service_Chrg,ParticipantCode,Family,Trader,C1.Branch_Cd,Sub_Broker,  
MemberType,MemberCode,S.Series_Code,S.Series_Id, F.MarketLot,C1.Area,c1.Region   
Having Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End) <> Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End)       
      
/* Brought Forward Trades */        
      
/* Todays Trade */        
      
Insert into BFOBILLVALAN      
select S.Party_Code,Long_Name=Left(Long_Name,50),Client_Type=C1.Cl_Type,BillNo,ContractNo,s.Product_Code,s.Series_Code,s.expirydate,s.Product_Type,S.Series_ID,s.Strike_Price,F.MarketLot,      
S.AuctionPart,F.MaturityDate,Sauda_date=@SDate + ' 23:59',IsIn='',      
PQty=Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End),        
SQty=Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End),        
PRate=Round((Case When Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End) > 0 Then Sum(Case When Sell_buy = 1 Then s.TradeQty*MarketRate Else 0 End)/Sum(Case When Sell_buy = 1 Then s.TradeQty Else 0 End) Else 0 End ),4),      
SRate=Round((Case When Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End) > 0 Then Sum(Case When Sell_buy = 2 Then s.TradeQty*MarketRate Else 0 End)/Sum(Case When Sell_buy = 2 Then s.TradeQty Else 0 End) Else 0 End),4) ,        
PAmt =Round(Sum(Case When Sell_buy = 1 Then (s.TradeQty*(MarketRate+Brokapplied)) Else 0 End),4),       
SAmt =Round(Sum(Case When Sell_buy = 2 Then (s.TradeQty*(MarketRate-Brokapplied)) Else 0 End),4),      
PBrokAmt =Round(Sum(Case When Sell_buy = 1 Then (s.TradeQty*Brokapplied) Else 0 End),4),       
SBrokAmt =Round(Sum(Case When Sell_buy = 2 Then (s.TradeQty*Brokapplied) Else 0 End),4),       
PBillAmt= Round(Sum(Case When Sell_buy = 1 Then (s.TradeQty*(MarketRate+Brokapplied)) Else 0 End),4),       
SBillAmt= Round(Sum(Case When Sell_buy = 2 Then (s.TradeQty*(MarketRate-Brokapplied)) Else 0 End),4),      
Cl_Rate = 0, Cl_Chrg=0,ExCl_Chrg=0,service_tax=Sum(Service_Tax),      
ExSer_Tax=(Case When C2.Service_Chrg = 2 Then Sum(Service_Tax) Else 0 End ),      
InExSerFlag=Service_Chrg,      
sebi_tax=(Case When Sebi_Turn_tax = 1 Then Sum(sebi_tax) Else 0 End),        
turn_tax=(Case When C2.Turnover_tax = 1 Then Sum(turn_tax) Else 0 End),        
Broker_note=(Case When BrokerNote = 1 Then Sum(Broker_chrg) Else 0 End),      
Ins_Chrg=(Case when c2.Insurance_Chrg=1 then sum(ins_chrg) else  0 end ),      
Other_Chrg=(Case when c2.other_chrg=1 then sum(s.other_chrg) else  0 end ),      
TradeType='BT',      
ParticiPantCode=(Case When s.reserved1 = 1 Then ParticiPantCode Else MemberCode End),      
Terminal_Id='',      
Family,FamilyName='',Trader,Branch_Code=C1.Branch_Cd,Sub_Broker,StatusName='',Exchange='BSEFO',Segment='FUTURE',MemberType,      
CompanyName='',Region=c1.Region,UpdateDate=Left(Convert(Varchar,GetDate(),109),11),      
EMail='',SBU='',RELMGR='',Grp='',Sector='',      
CmClosing=0,      
Track='',C1.Area  
from Bfoscrip2 F,BFosettlement s, BFoOwner, Client1 C1, Client2 C2         
where sauda_date Like @SDate + '%'        
     and F.Product_Code=s.Product_Code        
     and F.Series_Code=s.Series_Code      
     and F.Series_Id=s.Series_Id      
     and convert(varchar,s.expirydate,103) = convert(varchar,F.expirydate,103)       
     and F.strikeprice=s.strike_price       
     and F.Product_Type=s.Product_Type        
     and F.maturitydate >= @SDate         
     And Ltrim(Rtrim(S.Party_Code)) >= @FParty and Ltrim(Rtrim(S.Party_Code)) <= @TParty      
     And S.Party_Code = C2.Party_Code And C2.Cl_Code = C1.Cl_Code And TradeQty > 0       
group by S.party_code,s.Product_Code,s.Product_Code,f.maturitydate,s.strike_price,s.Product_Type,s.expirydate,S.Series_Id, F.MarketLot,      
Long_Name,C1.Cl_Type,BillNo,ContractNo,AuctionPart,Service_Chrg,ParticipantCode,Family,Trader,C1.Branch_Cd,Sub_Broker,      
MemberType,Sebi_Turn_tax,C2.Other_chrg,C2.Turnover_tax,BrokerNote,MemberCode,S.Reserved1,S.Series_Code  ,Insurance_Chrg ,C1.Area,c1.Region  
      
Insert into BFOBILLVALAN     
Select  
 Party_Code=CD_Party_Code,Long_Name=Short_Name,Client_Type=Cl_Type,BillNo=0,  
 ContractNo=CD_Contract_No,  
 s.Cd_Product_Code,s.Cd_Series_Code,s.CD_expiry_date,s.CD_Product_Type,S.CD_Series_ID,0,  
 MarketLot,AuctionPart=CD_AuctionPart,  
 IsNull(F.MaturityDate,'1900-01-01'),Sauda_Date=CD_Sauda_Date +' 23:59',IsIn='',  
 PQty=0,  
 SQty=0,  
 PRate=0,  
 SRate=0,  
 PAmt=0,  
 SAmt=0,  
 PBrokamt=Sum(CD_Tot_BuyBrok),  
 SBrokAmt=Sum(CD_Tot_SellBrok),  
 PBillAmt=Sum(CD_Tot_BuyBrok+CD_Tot_SellBrok),  
 SBillAmt=Sum(0),  
 Cl_Rate = 0, Cl_Chrg=0,ExCl_Chrg=0,  
 Service_Tax = Sum(CD_Tot_SerTax),  
 ExSer_Tax=(Case When C2.Service_Chrg = 2 Then Sum(CD_Tot_SerTax) Else 0 End ),                  
 InExSerFlag=Service_Chrg,     
 sebi_tax=0,  
 turn_tax =0,  
 Broker_chrg =0,  
 ins_chrg = 0,  
 Other_Chrg = 0,  
 TradeType='BT',ParticiPantCode=MemberCode,  
 Terminal_Id='',  
 Family,FamilyName='',Trader,Branch_Code=Branch_Cd,Sub_Broker,StatusName='BRK',  
 Exchange='BSEFO',Segment='FUTURE',MemberType,                  
 CompanyName='',Region,UpdateDate=Left(Convert(Varchar,GetDate(),109),11),                  
 EMail=C1.EMail,Dummy2='',Dummy3='',Dummy4=0,Dummy5=0,                  
 CmClosing=0,Track='',C1.Area  
From Charges_Detail S Left Outer Join BFoScrip2 F  
On (F.Product_Type = S.CD_Product_type  
 And F.Product_Code = S.CD_Product_Code  
 And F.Series_Code = S.CD_Series_Code  
 And F.Series_id = S.CD_Series_id  
 And Convert(varchar,F.ExpiryDate,103) = Convert(varchar,S.Cd_Expiry_Date,103) ),  
Client1 C1, Client2 C2, BFoOwner  
Where   
 S.CD_Sauda_Date Like @SDate + '%'  
 And S.CD_Party_Code = C2.Party_Code  
 And C1.Cl_Code = C2.Cl_Code  
   
Group By  
 CD_Party_Code,CD_Sauda_Date,CD_Contract_No,  
 CD_Product_Type,CD_Product_Code,CD_Series_Code,Cd_Series_Id,CD_Expiry_Date,  
 CD_AuctionPart, C1.Area,C1.Short_Name,C1.Cl_Type,F.Maturitydate,C2.Service_Chrg,C1.Family,  
 C1.Trader,C1.Branch_Cd,C1.Sub_Broker,BFoOwner.Membertype,C1.Region,C1.Email,  
 MemberCode,MarketLot          
  
Update BFOBILLVALAN Set Product_Type = F.Product_Type,Product_Code = F.Product_Code,  
Series_Code = F.Series_Code,Series_Id = F.Series_Id, ExpiryDate = F.ExpiryDate   
From bfoscrip2 F  
Where BFOBILLVALAN.Product_Code = '' And F.Series_Code = 'BROKERAGE'  
And BFOBILLVALAN.Party_Code >= @FParty  And BFOBILLVALAN.Party_Code <= @TParty      
And BFOBILLVALAN.Sauda_Date Like @SDate + '%'      
/* Todays Trade */          
    
Update BFOBILLVALAN Set ExCl_Chrg = Cl_Chrg From BFoOwner       
Where ( ClrgChg = 1 And chmclchrg = 1 ) Or ( ClrgChg = 4 And chmclchrg = 1 )       
Or ( ClrgChg = 2 And chmclchrg = 0 )  Or ( ClrgChg = 0 And chmclchrg = 0 )       
And BFOBILLVALAN.TradeType = 'BT'      
And BFOBILLVALAN.Party_Code >= @FParty  And BFOBILLVALAN.Party_Code <= @TParty      
And BFOBILLVALAN.Sauda_Date Like @SDate + '%'      
      
Update BFOBILLVALAN Set PBillAmt=PQty*BFoClosing.cl_rate,SBillAmt=SQty*BFoClosing.cl_rate,      
PAmt=PQty*BFoClosing.cl_rate,SAmt=SQty*BFoClosing.cl_rate      
from BFoClosing where BFoClosing.trade_date = ( select max(trade_date) from BFoClosing         
                   where BFoClosing.trade_date < @SDate + ' 23:59' )         
and BFoClosing.Product_Code = BFOBILLVALAN.Product_Code      
and BFoClosing.Series_Code=BFOBILLVALAN.Series_Code      
and BFoClosing.Product_Type=BFOBILLVALAN.Product_Type      
and BFoClosing.Series_Id=BFOBILLVALAN.Series_Id And BFOBILLVALAN.TradeType = 'BF'       
And BFOBILLVALAN.Sauda_Date Like @SDate + '%'        
And BFOBILLVALAN.Product_Code Like '%FUT'      
And BFOBILLVALAN.Party_Code >= @FParty  And BFOBILLVALAN.Party_Code <= @TParty      
      
Update BFOBILLVALAN Set Cl_Rate = BFoClosing.cl_rate from BFoClosing        
where BFoClosing.trade_date Like @SDate + '%'         
and BFoClosing.Product_Code = BFOBILLVALAN.Product_Code      
and BFoClosing.Series_Code=BFOBILLVALAN.Series_Code      
and BFoClosing.Product_Type=BFOBILLVALAN.Product_Type      
and BFoClosing.Series_Id=BFOBILLVALAN.Series_Id      
And BFOBILLVALAN.Sauda_Date Like @SDate + '%'        
And BFOBILLVALAN.Party_Code >= @FParty  And BFOBILLVALAN.Party_Code <= @TParty      
      
Update BFOBILLVALAN Set       
PBillAmt= (Case When ParticiPantCode = MemberCode       
  Then (Case When PBillAmt-PQty*Cl_Rate+SQty*Cl_Rate-SBillAmt > 0       
              Then PBillAmt-PQty*Cl_Rate+SQty*Cl_Rate-SBillAmt       
                           Else 0 End)      
        Else PBrokAmt End),      
SBillAmt= (Case When ParticiPantCode = MemberCode       
         Then (Case When PBillAmt-PQty*Cl_Rate+SQty*Cl_Rate-SBillAmt < 0       
                           Then Abs(PBillAmt-PQty*Cl_Rate+SQty*Cl_Rate-SBillAmt)       
                    Else 0 End)      
        Else SBrokAmt End)      
From BFoOwner Where Sauda_Date Like @Sdate + '%' And Product_Code Like '%FUT'      
And Party_code Between @FParty And @TParty       
      
Update BFOBILLVALAN Set       
PBillAmt= PBrokAmt ,      
SBillAmt= SBrokAmt      
From BFoOwner Where Sauda_Date Like @Sdate + '%' And Product_Code Like '%OPT'      
And Party_code Between @FParty And @TParty And ParticiPantCode <> MemberCode       
      
Update BFOBILLVALAN Set FamilyName = Left(C1.Long_Name,50) From Client1 C1, Client2 C2      
Where C1.Cl_Code = C2.Cl_Code And C2.Party_Code = BFOBILLVALAN.Family       
      
Update BFOBILLVALAN Set EMail = (CASE WHEN Len(C1.EMail) = 0 THEN '_' ELSE c1.email END) From Client1 C1, Client2 C2      
Where C1.Cl_Code = C2.Cl_Code And C2.Party_Code = BFOBILLVALAN.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9T72WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '@=${1`@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16072014
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@Z'
SET @ERRCODE2 = '7=99S52WJ759S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_17072018
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-#3 8*!@ZF>2!/##''@>T=>''!]2(2>({7:2# :VL'
SET @ERRCODE2 = '0=>9R12WJ719S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_20042012
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_20042012]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-0>@/!{1'')6T([(.$)&H'  
SET @ERRCODE2 = '<<!9R12WJYY9S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '///\3?0'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J6Z'  
SET @ERRCODE11 = 'R7X'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'R5X'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_20042012z
-- --------------------------------------------------
  
CREATE PROC [DBO].[CHECKVERSION_20042012z]  
AS  
  
DECLARE   
@ERRCODE1 VARCHAR(100),  
@ERRCODE2 VARCHAR(20),  
@ERRCODE3 VARCHAR(2),  
@ERRCODE4 VARCHAR(10),  
@ERRCODE5 VARCHAR(10),  
@ERRCODE6 VARCHAR(100),  
@ERRCODE7 VARCHAR(100),  
@ERRCODE8 VARCHAR(100),  
@ERRCODE9 VARCHAR(100),  
@ERRCODE10 VARCHAR(10),  
@ERRCODE11 VARCHAR(10),  
@ERRCODE12 VARCHAR(100),  
@ERRCODE13 VARCHAR(10),  
@ERRCODE14 VARCHAR(100)  
  
SET @ERRCODE1 = '<&{:9-0>@/!{1'')6T([(.$)&H'  
SET @ERRCODE2 = '<<!9R12WJYY9S8xTKD2 '  
SET @ERRCODE3 = 'R4'  
SET @ERRCODE4 = '$!'''  
SET @ERRCODE5 = '///\3?0'  
SET @ERRCODE6 = 'LICENSE PERIOD OVER '  
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'  
SET @ERRCODE8 = ''  
SET @ERRCODE9 = 'LICENSE NOT VALID'  
SET @ERRCODE10 = 'J6Z'  
SET @ERRCODE11 = 'R7X'  
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'  
SET @ERRCODE13 = 'R5X'  
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'  
  
SELECT  
 ERRCODE1 = @ERRCODE1,  
 ERRCODE2 = @ERRCODE2,  
 ERRCODE3 = @ERRCODE3,  
 ERRCODE4 = @ERRCODE4,  
 ERRCODE5 = @ERRCODE5,  
 ERRCODE6 = @ERRCODE6,  
 ERRCODE7 = @ERRCODE7,  
 ERRCODE8 = @ERRCODE8,  
 ERRCODE9 = @ERRCODE9,  
 ERRCODE10 = @ERRCODE10,  
 ERRCODE11 = @ERRCODE11,  
 ERRCODE12 = @ERRCODE12,  
 ERRCODE13 = @ERRCODE13,  
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26102024
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_26102024]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9T72WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '@=${1`@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientMargin_Upd
-- --------------------------------------------------

CREATE  Proc ClientMargin_Upd (@mdate varchar(11) ) AS      
       
 Declare @@opendate  as varchar(11)        
       
 set transaction isolation level read uncommitted      
 Select * into #tbl_clientmargin from tbl_clientMargin where 1=2      
       
 insert into #tbl_clientmargin       
       
 Select distinct c2.party_code,@mdate + ' 00:00',0,0,0,0,0,getdate(),c1.short_name,       
 Left(c1.long_name,50),ltrim(rtrim(c1.branch_cd)),ltrim(rtrim(c1.family)),ltrim(rtrim(c1.sub_broker)),      
 ltrim(rtrim(c1.trader)),0 from client2 c2, client1 c1      
 Where LTrim(RTrim(c1.cl_code)) = LTrim(RTrim(c2.cl_code))      
       
 Select party_code,amount=isnull(sum((case when sell_buy=2 then    
 isnull(amount,0) else (0-isnull(amount,0)) end)),0)        
 into #PartyBill      
 from bfoaccbill where       
 party_code in (select distinct party_code from #tbl_clientmargin) and billdate like @mdate +'%'      
 group by party_code      
       
 Update t set billamount=amount from #tbl_clientmargin t, #PartyBill p where p.Party_Code = t.Party_Code      
       
      
       
 /*Getting Closing balance from Ledger with out  today's bill*/      
       
 Select * into #Ledger  from AccountBFO.dbo.ledger where cltcode in    
(select distinct party_code from #tbl_clientmargin)      
       
 Select @@opendate = ( Select left(convert(varchar,isnull(max(vdt),0),109),11) from #Ledger where vtyp= 18       
            and vdt <= @mdate +' 23:59' )        
       
 Select CltCode,oppbal=Vamt into #OppBalance From #Ledger where 1=2        
       
 if @@opendate <> ''      
  begin        
      Insert into  #OppBalance         
       
    Select CltCode,Sum(OppBal) OppBal From       
    (      
      select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)        
      from #Ledger b where   b.vdt like @@opendate + '%' and vtyp = 18    
      Group By CltCode        
       
    Union All      
       
      Select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)          
      from #Ledger b  where b.vdt >=  @@opendate and vdt < @mdate and vtyp <> 18       
      Group By CltCode    
    )    
    t      
    Group By CltCode        
  end      
 else      
  begin      
      Insert into  #OppBalance         
      select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)          
      from #Ledger b  where  vdt < @mdate       
      Group By CltCode        
  end      
       
 Select CltCode,round(Sum(OppBal),2) OppBal       
 into  #OppBalanceFinal      
 From      
   (      
   Select cltcode,Sum(OppBal) OppBal  from #OppBalance        
     Group By CltCode        
        
   Union All      
       
     select CltCode,oppbal = IsNull(sum( case when upper(b.drcr) = 'C' then b.vamt else -b.vamt end),0)          
     from #Ledger b  where  vdt like  @mdate + '%'  and  vtyp not in (18,15)       
     Group By CltCode        
   ) t      
 Group By CltCode        
         
 Update t set ledgeramount=OppBal from #tbl_clientmargin t,#OppBalanceFinal p where p.cltcode = t.Party_Code      
       
      
 /*getting collateral from msajag*/      
       
 Select party_code,actcash = isnull(cash,0),actnoncash=isnull(noncash,0)       
 into #collateral      
 from msajag.dbo.collateral        
 where exchange = 'BSE'        
 and segment like 'FUT%'        
 and party_code in (select distinct party_code from #tbl_clientmargin)    
 and trans_date like @mdate + '%'        
       
 Update t set cash_coll=actcash,noncash_coll=actnoncash from #tbl_clientmargin t, #collateral p     
 where p.Party_Code = t.Party_Code      
       
      
 /*getting margin details*/      
       
 Select  party_code,abs(sum(init_margin)) marginamount, mtmmargin = sum(0)    
 into #Margin      
 from bfomargincoll  
 where cl_type like 'N%' and file_date like  (select Left(max(file_date),11) from bfomargincoll  where file_date <=  @mdate + ' 23:59') + '%'    
 group by party_code       
       
 update t set initialmargin=p.marginamount,MTMMargin=p.mtmmargin from #tbl_clientmargin t, #Margin p     
 where p.Party_Code = t.Party_Code      
       
       
 /*updating tbl_clientmargin*/      
 Delete tbl_clientmargin  where margindate like @mdate + '%'      
       
 Insert  into tbl_clientmargin Select * from #tbl_clientmargin  where    
 (billamount<>0 or initialmargin <> 0 or ledgeramount <> 0 or  cash_coll <> 0 or noncash_coll <> 0)      
 order by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientMargin_Upd_New
-- --------------------------------------------------

CREATE  Proc  ClientMargin_Upd_New (@DateFrom VARCHAR (20),@DateTo as varchar(20))
As      
  
Declare      
@mdate  varchar(11),
@DateCur Cursor      
      
Set @DateCur = Cursor for      
Select  Distinct  left(File_Date,11)  from BFoMarginColl where File_Date between @DateFrom and @DateTo
Open @DateCur      
      
Fetch Next From @DateCur into @mdate
While @@Fetch_Status = 0       
Begin      
      
 EXECUTE ClientMargin_Upd  @mdate
    
 Fetch Next From @DateCur into @mdate
End      
Close @DateCur      
DeAllocate @DateCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CONFIRMATION
-- --------------------------------------------------



--- EXEC [CLS_CONFIRMATION] '30/04/2015','S116725','S116725','','ZZZZZZ','','ZZZZZZZ','BROKER','BROKER',0


CREATE PROCEDURE [CLS_CONFIRMATION] 
	(
	@FDATEFROM	VARCHAR(11),
	@FPARTYCODE VARCHAR(20),
	@TPARTYCODE VARCHAR(20),
	@FBRANCH	VARCHAR(20),
	@TBRANCH	VARCHAR(20),
	@FSUBBROKER VARCHAR(20),
	@TSUBBROKER VARCHAR(20),
	@STATUSID	VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@RPT_TYPE	INT = 1
	)

AS

IF @TBRANCH = ''
BEGIN
	SET @TBRANCH = 'zzzzzzzzzzzz'
END

IF @TSUBBROKER = ''
BEGIN
	SET @TSUBBROKER = 'zzzzzzzzzzzz'
END

IF @TPARTYCODE = ''
BEGIN
	SET @TPARTYCODE = 'zzzzzzzzzzzz'
END

IF LEN(@FDATEFROM) = 10 AND CHARINDEX('/',@FDATEFROM) > 0    
BEGIN
	SET @FDATEFROM = CONVERT(VARCHAR (11), CONVERT(DATETIME,@FDATEFROM,103),109)
END

DECLARE @MYRECCOUNT INT

SET @MYRECCOUNT = 0

SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT	ORDER_NO,
		TRADE_NO,
		SAUDA_DATE,
		PARTY_CODE,
		CONTRACTNO,
		TRADEQTY,
		PRICE,
		AUCTIONPART,
		SELL_BUY,
		BROKAPPLIED,
		SERVICE_TAX,
		NETRATE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		BROKER_CHRG,
		TURN_TAX,
		SEBI_TAX,
		INS_CHRG,
		OTHER_CHRG,
		PARTICIPANTCODE,
		USER_ID
INTO	#FOSETT 
FROM	FOSETTLEMENT (NOLOCK)
WHERE	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
		AND PARTY_CODE >= @FPARTYCODE 
		AND PARTY_CODE <= @TPARTYCODE 
		AND TRADEQTY <> 0 

SELECT	@MYRECCOUNT = COUNT(1)
FROM	PRADNYA.DBO.DATAIN_HISTORY_FOSETTLEMENT_NSEFO
WHERE	SAUDA_DATE = @FDATEFROM

IF @MYRECCOUNT > 0
BEGIN
	INSERT	INTO #FOSETT
	SELECT	ORDER_NO,
			TRADE_NO,
			SAUDA_DATE,
			PARTY_CODE,
			CONTRACTNO,
			TRADEQTY,
			PRICE,
			AUCTIONPART,
			SELL_BUY,
			BROKAPPLIED,
			SERVICE_TAX,
			NETRATE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			BROKER_CHRG,
			TURN_TAX,
			SEBI_TAX,
			INS_CHRG,
			OTHER_CHRG,
			PARTICIPANTCODE,
			USER_ID
	FROM	PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
			AND PARTY_CODE >= @FPARTYCODE 
			AND PARTY_CODE <= @TPARTYCODE 
			AND TRADEQTY <> 0 
END


SELECT C2.PARTY_CODE,
	C1.LONG_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_STATE,
	C1.L_ZIP,
	C1.BRANCH_CD,
	C1.SUB_BROKER,
	C1.TRADER,
	C1.PAN_GIR_NO,
	C1.RES_PHONE1,
	C1.RES_PHONE2,
	C2.SERVICE_CHRG,
	BROKERNOTE,
	TURNOVER_TAX,
	SEBI_TURN_TAX,
	C2.OTHER_CHRG,
	INSURANCE_CHRG
INTO #CLIENTMASTER
FROM 
	CLIENT1 C1 WITH (NOLOCK),
	CLIENT2 C2 WITH (NOLOCK)
WHERE C2.CL_CODE = C1.CL_CODE 
	AND C2.PARTY_CODE BETWEEN @FPARTYCODE AND @TPARTYCODE 
	AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = C2.PARTY_CODE)
	AND @STATUSNAME = (
		CASE 
			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY
			WHEN @STATUSID = 'AREA'			THEN C1.AREA
			WHEN @STATUSID = 'REGION'		THEN C1.REGION
			WHEN @STATUSID = 'CLIENT'		THEN C2.PARTY_CODE
			ELSE 'BROKER'
			END
		) 
		AND BRANCH_CD BETWEEN @FBRANCH AND @TBRANCH
		AND SUB_BROKER BETWEEN @FSUBBROKER AND @TSUBBROKER


IF @RPT_TYPE = 1
BEGIN
	SELECT
		CLIENT_CODE = PARTY_CODE,
		CLIENT_NAME = LONG_NAME
	FROM
		#CLIENTMASTER
	ORDER BY
		PARTY_CODE
	
	RETURN
END

---===================================================================---

SELECT 
	ORDER_NO = (
		CASE 
			WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 2	THEN 'EXERCISE'
			WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 1	THEN 'ASSIGNMENT'
			ELSE ORDER_NO
			END
		),
	TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
	TRADETIME = CONVERT(VARCHAR, SAUDA_DATE, 108),
	TRADEQTY,
	PRICE = ISNULL(PRICE, 0),
	PQTY = (
		CASE 
			WHEN SELL_BUY = 1
				THEN TRADEQTY
			ELSE 0
			END
		),
	SQTY = (
		CASE 
			WHEN SELL_BUY = 2
				THEN TRADEQTY
			ELSE 0
			END
		),
	BROKAPPLIED = CONVERT(MONEY, ISNULL(BROKAPPLIED + (
				CASE 
					WHEN C.SERVICE_CHRG = 1
						THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)
					ELSE 0
					END
				), 0)),
	TOTBROKAPPLIED = CONVERT(MONEY, ISNULL((BROKAPPLIED * TRADEQTY) + (
				CASE 
					WHEN C.SERVICE_CHRG = 1
						THEN ISNULL(F.SERVICE_TAX, 0)
					ELSE 0
					END
				), 0)),
	NETRATE = NETRATE,
	INST_TYPE = F.INST_TYPE,
	SYMBOL = F.SYMBOL,
	AMT = (
		CASE 
			WHEN SELL_BUY = 1
				THEN - (
						(TRADEQTY * NETRATE) + (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL(F.SERVICE_TAX, 0)
								ELSE 0
								END
							)
						)
			ELSE (
					(TRADEQTY * NETRATE) - (
						CASE 
							WHEN C.SERVICE_CHRG = 1
								THEN ISNULL(F.SERVICE_TAX, 0)
							ELSE 0
							END
						)
					)
			END
		),
	EXPIRYDATE = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 106), 11),
	EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 101), 11),
	F.PARTY_CODE,
	SELL_BUY = (
		CASE 
			WHEN SELL_BUY = 1	THEN 'B'
			ELSE 'S'
			END
		),
	CONTRACTNO,
	SAUDA_DATE = CONVERT(VARCHAR, SAUDA_DATE, 103),
	STRIKE_PRICE = ISNULL(F.STRIKE_PRICE, 0),
	F.OPTION_TYPE,
	YY = YEAR(SAUDA_DATE),
	MM = MONTH(SAUDA_DATE),
	DD = DAY(SAUDA_DATE),
	SERVICE_TAX = (
		CASE 
			WHEN C.SERVICE_CHRG = 0
				THEN (F.SERVICE_TAX)
			ELSE 0
			END
		),
	BROKER_CHRG = (
		CASE 
			WHEN BROKERNOTE = 1
				THEN (BROKER_CHRG)
			ELSE 0
			END
		),
	TURN_TAX = (
		CASE 
			WHEN TURNOVER_TAX = 1
				THEN (TURN_TAX)
			ELSE 0
			END
		),
	SEBI_TAX = (
		CASE 
			WHEN SEBI_TURN_TAX = 1
				THEN (SEBI_TAX)
			ELSE 0
			END
		),
	INSURANCE_CHRG = (
		CASE 
			WHEN INSURANCE_CHRG = 1
				THEN (INS_CHRG)
			ELSE 0
			END
		),
	OTHER_CHRG = (
		CASE 
			WHEN C.OTHER_CHRG = 1
				THEN (F.OTHER_CHRG)
			ELSE 0
			END
		),
	STAX = FOGLOBALS.SERVICE_TAX,
	CESSTAX = FOGLOBALS.CESS_TAX,
	PARTYNAME = C.LONG_NAME,
	C.L_ADDRESS1,
	C.L_ADDRESS2,
	C.L_ADDRESS3,
	C.L_CITY,
	C.L_STATE,
	C.L_ZIP,
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	C.PAN_GIR_NO,
	C.RES_PHONE1,
	C.RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID
INTO #CONFIRMATION_TEMP
FROM #FOSETT F(NOLOCK),
	#CLIENTMASTER C(NOLOCK),
	FOSCRIP2 FOS2(NOLOCK),
	FOGLOBALS(NOLOCK)
WHERE 
	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
	AND F.PARTY_CODE >= @FPARTYCODE 
	AND F.PARTY_CODE <= @TPARTYCODE 
	AND TRADEQTY <> 0 
	AND F.SYMBOL = FOS2.SYMBOL 
	AND F.INST_TYPE = FOS2.INST_TYPE 
	AND F.EXPIRYDATE = FOS2.EXPIRYDATE 
	AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE 
	AND F.OPTION_TYPE = FOS2.OPTION_TYPE 
	AND F.PARTY_CODE = C.PARTY_CODE 
	AND F.AUCTIONPART <> 'CA' 
	AND F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT


IF @MYRECCOUNT > 0
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO #CONFIRMATION_TEMP
	SELECT ORDER_NO = (
			CASE 
				WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 2	THEN 'EXERCISE'
				WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 1	THEN 'ASSIGNMENT'
				ELSE ORDER_NO
				END
			),
		TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
		TRADETIME = CONVERT(VARCHAR, SAUDA_DATE, 108),
		TRADEQTY,
		PRICE = ISNULL(PRICE, 0),
		PQTY = (
			CASE 
				WHEN SELL_BUY = 1
					THEN TRADEQTY
				ELSE 0
				END
			),
		SQTY = (
			CASE 
				WHEN SELL_BUY = 2
					THEN TRADEQTY
				ELSE 0
				END
			),
		BROKAPPLIED = CONVERT(MONEY, ISNULL(BROKAPPLIED + (
					CASE 
						WHEN C.SERVICE_CHRG = 1
							THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)
						ELSE 0
						END
					), 0)),
		TOTBROKAPPLIED = CONVERT(MONEY, ISNULL((BROKAPPLIED * TRADEQTY) + (
					CASE 
						WHEN C.SERVICE_CHRG = 1
							THEN ISNULL(F.SERVICE_TAX, 0)
						ELSE 0
						END
					), 0)),
		NETRATE = NETRATE,
		INST_TYPE = F.INST_TYPE,
		SYMBOL = F.SYMBOL,
		AMT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (
							(TRADEQTY * NETRATE) + (
								CASE 
									WHEN C.SERVICE_CHRG = 1
										THEN ISNULL(F.SERVICE_TAX, 0)
									ELSE 0
									END
								)
							)
				ELSE (
						(TRADEQTY * NETRATE) - (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL(F.SERVICE_TAX, 0)
								ELSE 0
								END
							)
						)
				END
			),
		EXPIRYDATE = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 106), 11),
		EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 101), 11),
		F.PARTY_CODE,
		SELL_BUY = (
			CASE 
				WHEN SELL_BUY = 1
					THEN 'B'
				ELSE 'S'
				END
			),
		CONTRACTNO,
		SAUDA_DATE = CONVERT(VARCHAR, SAUDA_DATE, 103),
		STRIKE_PRICE = ISNULL(F.STRIKE_PRICE, 0),
		F.OPTION_TYPE,
		YY = YEAR(SAUDA_DATE),
		MM = MONTH(SAUDA_DATE),
		DD = DAY(SAUDA_DATE),
		SERVICE_TAX = (
			CASE 
				WHEN C.SERVICE_CHRG = 0
					THEN (F.SERVICE_TAX)
				ELSE 0
				END
			),
		BROKER_CHRG = (
			CASE 
				WHEN BROKERNOTE = 1
					THEN (BROKER_CHRG)
				ELSE 0
				END
			),
		TURN_TAX = (
			CASE 
				WHEN TURNOVER_TAX = 1
					THEN (TURN_TAX)
				ELSE 0
				END
			),
		SEBI_TAX = (
			CASE 
				WHEN SEBI_TURN_TAX = 1
					THEN (SEBI_TAX)
				ELSE 0
				END
			),
		INSURANCE_CHRG = (
			CASE 
				WHEN INSURANCE_CHRG = 1
					THEN (INS_CHRG)
				ELSE 0
				END
			),
		OTHER_CHRG = (
			CASE 
				WHEN C.OTHER_CHRG = 1
					THEN (F.OTHER_CHRG)
				ELSE 0
				END
			),
		STAX = FOGLOBALS.SERVICE_TAX,
		CESSTAX = FOGLOBALS.CESS_TAX,
		PARTYNAME = C.LONG_NAME,
		C.L_ADDRESS1,
		C.L_ADDRESS2,
		C.L_ADDRESS3,
		C.L_CITY,
		C.L_STATE,
		C.L_ZIP,
		C.BRANCH_CD,
		C.SUB_BROKER,
		C.TRADER,
		C.PAN_GIR_NO,
		C.RES_PHONE1,
		C.RES_PHONE2,
		PARTICIPANTCODE,
		USER_ID
	FROM #FOSETT F(NOLOCK),
		#CLIENTMASTER C(NOLOCK),
		FOSCRIP2 FOS2(NOLOCK),
		FOGLOBALS(NOLOCK)
	WHERE F.SYMBOL = FOS2.SYMBOL 
		AND F.INST_TYPE = FOS2.INST_TYPE 
		AND F.EXPIRYDATE = FOS2.EXPIRYDATE 
		AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE 
		AND F.OPTION_TYPE = FOS2.OPTION_TYPE 
		AND F.PARTY_CODE >= @FPARTYCODE AND F.PARTY_CODE <= @TPARTYCODE 
		AND SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59' 
		AND TRADEQTY <> 0 
		AND F.PARTY_CODE = C.PARTY_CODE 
		AND F.AUCTIONPART <> 'CA' 
		AND F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
END

---===================================================================---      
SELECT ORDER_NO = ORDER_NO,
	TRADE_NO = TRADE_NO,
	TRADETIME = TRADETIME,
	TRADEQTY = SUM(TRADEQTY),
	PRICE = SUM(PRICE * TRADEQTY) / SUM(TRADEQTY),
	PQTY = SUM(PQTY),
	SQTY = SUM(SQTY),
	BROKAPPLIED = SUM(BROKAPPLIED),
	TOTBROKAPPLIED = SUM(TOTBROKAPPLIED),
	NETRATE = SUM(NETRATE * TRADEQTY) / SUM(TRADEQTY),
	INST_TYPE = INST_TYPE,
	SYMBOL = SYMBOL,
	AMT = SUM(AMT),
	EXPIRYDATE = EXPIRYDATE,
	EXPIRYDATE_ANX = EXPIRYDATE_ANX,
	CLIENT_CODE = PARTY_CODE,
	SELL_BUY = SELL_BUY,
	CONTRACTNO = CONTRACTNO,
	SAUDA_DATE = SAUDA_DATE,
	STRIKE_PRICE = STRIKE_PRICE,
	OPTION_TYPE = OPTION_TYPE,
	YY,
	MM,
	DD,
	SERVICE_TAX = SUM(SERVICE_TAX),
	BROKER_CHRG = SUM(BROKER_CHRG),
	TURN_TAX = SUM(TURN_TAX),
	SEBI_TAX = SUM(SEBI_TAX),
	INSURANCE_CHRG = SUM(INSURANCE_CHRG),
	OTHER_CHRG = SUM(OTHER_CHRG),
	STAX = STAX,
	CESSTAX = CESSTAX,
	CLIENT_NAME = PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PAN_GIR_NO,
	RES_PHONE1,
	RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID,
	TOT_SERVICE_TAX = CONVERT(NUMERIC(20,4),0),
	EDUCESS_TAX = CONVERT(NUMERIC(20,4),0),
	SBC_CHRG = CONVERT(NUMERIC(20,4),0),
	KRISHICESS_CHRG = CONVERT(NUMERIC(20,4),0)	
INTO #CONFIRMATION
FROM #CONFIRMATION_TEMP(NOLOCK)
GROUP BY ORDER_NO,
	TRADE_NO,
	TRADETIME,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	EXPIRYDATE_ANX,
	PARTY_CODE,
	SELL_BUY,
	CONTRACTNO,
	SAUDA_DATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	YY,
	MM,
	DD,
	STAX,
	CESSTAX,
	PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PAN_GIR_NO,
	RES_PHONE1,
	RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID

---===================================================================---      
UPDATE #CONFIRMATION
SET NETRATE = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN PRICE + CD_TOT_BUYBROK / TRADEQTY + CASE 
						WHEN SERVICE_CHRG = 1
							THEN CD_TOT_BUYSERTAX / TRADEQTY
						ELSE 0
						END
			ELSE PRICE - CD_TOT_SELLBROK / TRADEQTY - CASE 
					WHEN SERVICE_CHRG = 1
						THEN CD_TOT_SELLSERTAX / TRADEQTY
					ELSE 0
					END
			END
		),
	TOTBROKAPPLIED = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN CD_TOT_BUYBROK
			ELSE CD_TOT_SELLBROK
			END + CASE 
			WHEN SERVICE_CHRG = 1
				THEN CASE 
						WHEN SELL_BUY = 'B'
							THEN CD_TOT_BUYSERTAX
						ELSE CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 'B'
							THEN SERVICE_TAX + CD_TOT_BUYSERTAX
						ELSE SERVICE_TAX + CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	AMT = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN - (
						PRICE * TRADEQTY + CD_TOT_BUYBROK + CASE 
							WHEN SERVICE_CHRG = 1
								THEN CD_TOT_BUYSERTAX
							ELSE 0
							END
						)
			ELSE PRICE * TRADEQTY - CD_TOT_SELLBROK - CASE 
					WHEN SERVICE_CHRG = 1
						THEN CD_TOT_SELLSERTAX
					ELSE 0
					END
			END
		)
FROM CHARGES_DETAIL D(NOLOCK),
	#CLIENTMASTER C(NOLOCK)
WHERE CONVERT(VARCHAR, CD_SAUDA_DATE, 103) = CONVERT(VARCHAR, SAUDA_DATE, 103) 
	AND CD_PARTY_CODE = C.PARTY_CODE 
	AND CD_PARTY_CODE = #CONFIRMATION.CLIENT_CODE 
	AND CD_INST_TYPE = INST_TYPE 
	AND CD_SYMBOL = SYMBOL 
	AND CONVERT(VARCHAR, CD_EXPIRY_DATE, 106) = EXPIRYDATE 
	AND CD_OPTION_TYPE = OPTION_TYPE 
	AND CD_STRIKE_PRICE = STRIKE_PRICE 
	AND CD_TRADE_NO = TRADE_NO 
	AND CD_ORDER_NO = (
		CASE 
			WHEN ORDER_NO = 'EXERCISE' OR ORDER_NO = 'ASSIGNMENT'
				THEN CD_ORDER_NO
			ELSE ORDER_NO
			END
		)

---===================================================================---      
INSERT INTO #CONFIRMATION
SELECT ORDER_NO = CD_ORDER_NO,
	TRADE_NO = CD_TRADE_NO,
	TRADETIME = '',
	TRADEQTY = 0,
	PRICE = 0,
	PQTY = 0,
	SQTY = 0,
	BROKAPPLIED = 0,
	TOTBROKAPPLIED = CD_TOT_BROK + (
		CASE 
			WHEN SERVICE_CHRG = 1 THEN CD_TOT_SERTAX
			ELSE 0
			END
		),
	NETRATE = 0,
	INST_TYPE = CD_INST_TYPE,
	SYMBOL = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN 'CONT BROK'
			ELSE CD_SYMBOL
			END
		),
	AMT = 0,
	EXPIRYDATE = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 106), 11)
			END
		),
	EXPIRYDATE_ANX = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 101), 11)
			END
		),
	PARTY_CODE = CD_PARTY_CODE,
	SELL_BUY = (
		CASE
			WHEN CD_TOT_BUYBROK > 0 THEN 'B'
			ELSE 'S'
		END),
	CONTRACTNO = CD_CONTRACT_NO,
	SAUDA_DATE = CONVERT(VARCHAR, CD_SAUDA_DATE, 103),
	STRIKE_PRICE = ISNULL(F.CD_STRIKE_PRICE, 0),
	OPTION_TYPE = CD_OPTION_TYPE,
	YY = YEAR(CD_SAUDA_DATE),
	MM = MONTH(CD_SAUDA_DATE),
	DD = DAY(CD_SAUDA_DATE),
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_SERTAX
			ELSE 0
			END
		),
	BROKER_CHRG = 0,
	TURN_TAX = 0,
	SEBI_TAX = 0,
	INSURANCE_CHRG = 0,
	OTHER_CHRG = 0,
	STAX = 0,
	CESSTAX = 0,
	PARTYNAME = C.LONG_NAME,
	C.L_ADDRESS1,
	C.L_ADDRESS2,
	C.L_ADDRESS3,
	C.L_CITY,
	C.L_STATE,
	C.L_ZIP,
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	C.PAN_GIR_NO,
	C.RES_PHONE1,
	C.RES_PHONE2,
	PARTICIPANTCODE = '',
	USER_ID = '',
	TOT_SERVICE_TAX = 0,
	EDUCESS_TAX = 0,
	SBC_CHRG = 0,
	KRISHICESS_CHRG = 0	
FROM CHARGES_DETAIL F,
	#CLIENTMASTER C
WHERE 
	CD_SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59' 
	AND CD_PARTY_CODE >= '0' AND CD_PARTY_CODE <= 'zzzzzzzzz' 
	AND CD_CONTRACT_NO BETWEEN (
				CASE 
					WHEN LEFT(CD_INST_TYPE,3) = 'OPT' AND CD_AUCTIONPART = 'EA' THEN 0
					ELSE '0'
					END
				)
		AND '9999' 
		AND CD_PARTY_CODE = C.PARTY_CODE 
		AND CD_TRADE_NO = '' 



SELECT	CLIENT_CODE,
		SAUDA_DATE,
		SERVICE_TAX = SUM(SERVICE_TAX)
INTO	#SUMMARY		
FROM	#CONFIRMATION
GROUP BY
		CLIENT_CODE,
		SAUDA_DATE
		

UPDATE	#CONFIRMATION
SET		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S,#CONFIRMATION
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE


UPDATE	#CONFIRMATION
SET		EDUCESS_TAX = (
		CASE
			--WHEN ISNULL(CESS_TAX,0) <> 0 THEN ((S.SERVICE_TAX * 100 / G.SERVICE_TAX) * CESS_TAX / 100)
			WHEN ISNULL(CESS_TAX,0) <> 0 THEN (S.SERVICE_TAX - (S.SERVICE_TAX*100/(100+CESS_TAX)))
			ELSE 0
		END),
		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S, FOGLOBALS G
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE
		AND (CONVERT(DATETIME,S.SAUDA_DATE,103) BETWEEN YEAR_START_DT AND YEAR_END_DT)
		AND ISNULL(CESS_TAX,0) <> 0


UPDATE	#CONFIRMATION
SET		SBC_CHRG = (
		CASE
			WHEN ISNULL(SBCCHARGE,0) <> 0 THEN ((S.SERVICE_TAX * 100 / G.SERVICE_TAX) * SBCCHARGE / 100)
			ELSE 0
		END),
		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S, FOGLOBALS G
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE
		AND (CONVERT(DATETIME,S.SAUDA_DATE,103) BETWEEN YEAR_START_DT AND YEAR_END_DT)
		AND ISNULL(SBCCHARGE,0) <> 0
		

UPDATE	#CONFIRMATION
SET		TOT_SERVICE_TAX = (TOT_SERVICE_TAX - (ISNULL(EDUCESS_TAX,0)+ISNULL(SBC_CHRG,0)))


SELECT *
FROM #CONFIRMATION
ORDER BY YY,
	MM,
	DD,
	CLIENT_CODE,
	INST_TYPE,
	SYMBOL,
	OPTION_TYPE,
	STRIKE_PRICE,
	TRADETIME,
	ORDER_NO,
	TRADE_NO,
	SELL_BUY
	
	
DROP TABLE #FOSETT
DROP TABLE #CONFIRMATION
DROP TABLE #CLIENTMASTER
DROP TABLE #CONFIRMATION_TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_SHORTAGE_PENALTY
-- --------------------------------------------------

create PROCEDURE [dbo].[CLS_MARGIN_SHORTAGE_PENALTY]
(
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),
	@MARGIN_DATE_FROM VARCHAR(11),
	@MARGIN_DATE_TO VARCHAR(11),
	@PARTY_FROM VARCHAR(11),
	@PARTY_TO VARCHAR(11)
)
--EXEC CLS_MARGIN_SHORTAGE_PENALTY 'BROKER','BROKER','AUG 24 2010','AUG 24 2022','00','zzz'
AS

IF @PARTY_TO = ''
BEGIN
	SET @PARTY_TO = 'ZZZZZZZZZ'
END

IF LEN(@MARGIN_DATE_FROM) = 10 AND CHARINDEX('/',@MARGIN_DATE_FROM) > 0    
BEGIN
	SET @MARGIN_DATE_FROM = CONVERT(VARCHAR (11), CONVERT(DATETIME,@MARGIN_DATE_FROM,103),109)
END

IF LEN(@MARGIN_DATE_TO) = 10 AND CHARINDEX('/',@MARGIN_DATE_TO) > 0    
BEGIN
	SET @MARGIN_DATE_TO = CONVERT(VARCHAR (11), CONVERT(DATETIME,@MARGIN_DATE_TO,103),109)
END

DECLARE @EXCHANGE VARCHAR(15)

SELECT TOP 1 @EXCHANGE = EXCHANGE +' - FUTURES' FROM FOGLOBALS (NOLOCK)

SELECT 
	MARGINDATE = CONVERT(VARCHAR,P.MARGIN_DATE,103),
	CLIENT_CODE = P.PARTY_CODE,
	CLIENT_NAME = LONG_NAME,
	SHORTAGE,
	PENALTY_PERC,
	PENALTY_AMT,
	DAYS_3_COUNT,MONTH_5_COUNT,
	SHORTAGE_COUNT = M.NCOUNT,
	LEDGER_POST_FLAG = CASE WHEN LEDGER_POST_FLAG = 0 THEN 'N' ELSE 'Y' END,
	MDAY = DAY(P.MARGIN_DATE),
	MMONTH = DAY(P.MARGIN_DATE),
	MYEAR = DAY(P.MARGIN_DATE),
	L_ADDRESS1 = ISNULL(L_ADDRESS1,''),
	L_ADDRESS2 = ISNULL(L_ADDRESS2,''),
	L_ADDRESS3 = ISNULL(L_ADDRESS3,''),
	L_CITY = ISNULL(L_CITY,''),
	L_ZIP = ISNULL(L_ZIP,''),
	L_STATE = ISNULL(L_STATE,''),
	L_NATION = ISNULL(L_NATION,''),
	PAN_GIR_NO = ISNULL(PAN_GIR_NO,''),
	EXCHANGE = @EXCHANGE	
FROM 
	FOMARGIN_PENALTY P (NOLOCK),
	CLIENT1 C1 (NOLOCK),
	CLIENT2 C2 (NOLOCK),
	 BFOMARGIN_PENALTY_POST_STAT L (NOLOCK),
	(
		SELECT PARTY_CODE, NCOUNT = COUNT(1),
		COUNTMONTH = MONTH(MARGIN_DATE)
		FROM FOMARGIN_PENALTY (NOLOCK) 
		--WHERE MARGIN_DATE BETWEEN  LEFT(DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,MARGIN_DATE),0))+1,11) AND DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,MARGIN_DATE)+1,0))
		WHERE MARGIN_DATE BETWEEN @MARGIN_DATE_FROM AND @MARGIN_DATE_TO + ' 23:59'
		GROUP BY PARTY_CODE,MONTH(MARGIN_DATE)
	) M
WHERE 
	P.MARGIN_DATE = L.MARGIN_DATE
	AND COUNTMONTH = MONTH(P.MARGIN_DATE)
	AND P.PARTY_CODE = C2.PARTY_CODE
	AND C1.CL_CODE = C2.CL_CODE
	AND M.PARTY_CODE = P.PARTY_CODE
	AND L.MARGIN_DATE BETWEEN @MARGIN_DATE_FROM AND @MARGIN_DATE_TO + ' 23:59'
	AND M.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO
    AND @STATUSNAME = (       
    CASE       
		WHEN @STATUSID = 'BRANCH'       THEN C1.BRANCH_CD       
		WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER       
		WHEN @STATUSID = 'TRADER'       THEN C1.TRADER       
		WHEN @STATUSID = 'FAMILY'       THEN C1.FAMILY       
		WHEN @STATUSID = 'AREA'         THEN C1.AREA       
		WHEN @STATUSID = 'REGION'		THEN C1.REGION       
		WHEN @STATUSID = 'CLIENT'       THEN C2.PARTY_CODE       
		ELSE 'BROKER' 
	END)       
ORDER BY 
	MDAY,MMONTH,MYEAR,
	P.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW_SUMMARY
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[CLS_PARTYDETDAILYNEW_SUMMARY]    
 (    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @FPARTY VARCHAR(20),    
 @TPARTY VARCHAR(20),    
 @SAUDA VARCHAR(11),    
 @BRANCHCD VARCHAR(16) ='%',  
 @DIGIFLAG INT = 0  
 )    
   
 AS    
  
 IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END    
 IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END 
 
 DECLARE @SAUDADATE VARCHAR(11)
 SET  @SAUDADATE=@SAUDA
 
IF LEN(@SAUDA) = 10 AND CHARINDEX('/',@SAUDA) > 0    
SET @SAUDA=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SAUDA,103),109)    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 
 SELECT     
      
  [CLIENT CODE]=C2.CL_CODE,  
  [CLIENT NAME]=C1.LONG_NAME, 
  [TRADE DATE] =  @SAUDADATE 
 /* C2.EXCHANGE,    
  C2.TRAN_CAT,    
  C1.EMAIL,    
  C1.RES_PHONE1,    
  C1.SHORT_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.FAMILY,    
  C1.BRANCH_CD,
  C2.PARTY_CODE,     
  TRADER = ISNULL(C1.TRADER,''),  
  C1.PAN_GIR_NO */   
 FROM    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK),    
  (    
   SELECT    
    DISTINCT PARTY_CODE = FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)    
   WHERE     
    FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
    AND ((FOPDD_OPENING_PQTY+FOPDD_TODAY_PQTY)-(FOPDD_OPENING_SQTY+FOPDD_TODAY_SQTY)) <> 0  
   
   UNION  
     
   SELECT    
    DISTINCT PARTY_CODE = FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)    
   WHERE     
    FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
  ) F
  ,  CLIENT_PRINT_SETTINGS CP (NOLOCK)  
 WHERE    
  F.PARTY_CODE = C2.PARTY_CODE         
  AND C1.CL_CODE = C2.CL_CODE    
  AND C1.BRANCH_CD LIKE @BRANCHCD    
  AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
  AND C2.PRINTF = CP.PRINT_FLAG  
  AND CP.VALID_REPORT LIKE (CASE   
      WHEN @DIGIFLAG = 0 THEN '%'   
      WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
      WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
      ELSE CP.VALID_REPORT   
      END) 
  AND @STATUSNAME =(CASE     
            WHEN @STATUSID = 'BRANCH'     
            THEN C1.BRANCH_CD     
            WHEN @STATUSID = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            WHEN @STATUSID = 'TRADER'     
            THEN C1.TRADER     
            WHEN @STATUSID = 'FAMILY'     
            THEN C1.FAMILY     
            WHEN @STATUSID = 'AREA'     
            THEN C1.AREA     
            WHEN @STATUSID = 'REGION'     
            THEN C1.REGION     
            WHEN @STATUSID = 'CLIENT'     
            THEN C2.PARTY_CODE     
            ELSE 'BROKER'   
     END)  
 ORDER BY   
  C2.PARTY_CODE
   
   
  
 /*
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = @SAUDADATE 
  /*,
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE*/      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE 
  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOCLIENTTAXESPOP
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[FOCLIENTTAXESPOP] 
	(
		@IMPORTDATE VARCHAR(11)='DEC 31 2049',
		@INTMODE INT =1
	) AS
/*
	-----------------------------------------------------------
	 THIS PROC HAS COMMNENTED FOR THE VERSION COMPATABILITY
	 -----------------------------------------------------------
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT
-- --------------------------------------------------
 
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT]      
 @EFFDATE VARCHAR(11), 
  @CLTCODE VARCHAR(12),
 @SESSIONID VARCHAR(500),    
 @PROCESS_CODE VARCHAR(10),    
 @REPORT_FORMULA VARCHAR(MAX),  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(50),
 @TABLE_NAME VARCHAR(20) = '' 
AS      
    
DECLARE      
 @START_DATE VARCHAR(11)      
      
IF LEN(@EFFDATE) = 10      
BEGIN      
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)      
END      
      
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)      
FROM PARAMETER      
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR      
    
    
--CREATE TABLE #REPORT_DATA    
--(    
-- CLTCODE VARCHAR(10),    
-- PARTY_NAME VARCHAR(100),       
-- ENTITY_LEVEL VARCHAR(20),    
-- ENTITY_CODE VARCHAR(25),      
-- VDTBAL MONEY,      
-- EDTBAL MONEY,      
-- FDT_RECEIPT MONEY,      
-- FDT_PAYMENTS MONEY,  
-- MARGIN_BAL MONEY    
--)    
    
DECLARE    
 @@SQL VARCHAR(MAX)    
    
SELECT       
 CLTCODE = L.CLTCODE,    
 VDTBAL = SUM(CASE WHEN VDT >= @START_DATE THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),      
 EDTBAL = SUM(CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END       
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN (CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),      
 FDT_RECEIPT = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN (VAMT) ELSE 0 END) ,      
 FDT_PAYMENTS = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN (VAMT) ELSE 0 END ) INTO #LEDGER
FROM       
 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT  CLTCODE,VDT,VTYP,EDT,DRCR,VAMT  FROM LEDGER (NOLOCK) WHERE 
 --(VDT >= @START_DATE OR 
 CLTCODE =@CLTCODE AND
 EDT >= @START_DATE
  AND CDT <= DATEADD(MI, -15, GETDATE())
 --)      
 AND VDT <= @EFFDATE + ' 23:59' --AND CDT <= DATEADD(MI, -15, GETDATE())
 )    L 
 GROUP BY CLTCODE /*    
 LEFT OUTER JOIN (SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1  
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,  */
 
 
 
 --INSERT INTO #REPORT_DATA      
SELECT       
 L.CLTCODE,    
 PARTY_NAME,       
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = SUM(VDTBAL),      
 EDTBAL = SUM(EDTBAL),      
 FDT_RECEIPT = SUM(FDT_RECEIPT),      
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),  
 MARGIN_BAL = 0  INTO #REPORT_DATA      
FROM      
 #LEDGER L (Nolock)  ,
 FORMULA_CLIENT_MASTER A    (Nolock)  
WHERE      
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID    
 GROUP BY       
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE --, L1.RELDT      
      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0 
/*
UPDATE R SET R.FDT_RECEIPT = A.FDT_RECEIPT, R.FDT_PAYMENTS = A.FDT_PAYMENTS
FROM #REPORT_DATA R, (SELECT CLTCODE, FDT_RECEIPT = SUM(CASE WHEN L1.VTYP = 2 THEN VAMT ELSE 0 END),
FDT_PAYMENTS = SUM(CASE WHEN L1.VTYP = 3 THEN VAMT ELSE 0 END) FROM
(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE VDT <= @EFFDATE + ' 23:59')    L,    
(SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '') and CLEAR_MODE <> 'C') L1  
 WHERE L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO
AND L1.VTYP IN(2, 3)  
GROUP BY CLTCODE ) A
WHERE R.CLTCODE = A.CLTCODE
 */ 
/*  
UPDATE RD SET MARGIN_BAL = ML.AMOUNT  
FROM #REPORT_DATA RD, (  
 SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)  
 FROM MARGINLEDGER ML  
 WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'  
 GROUP BY PARTY_CODE  
)ML  
WHERE RD.CLTCODE = PARTY_CODE  
*/  
--IF @TABLE_NAME <> ''
--BEGIN
--	SET @@SQL = " TRUNCATE TABLE " + @TABLE_NAME  
--	EXEC (@@SQL)
--END

--IF @TABLE_NAME <> ''
--   SET @@SQL = " INSERT INTO " + @TABLE_NAME + " SELECT "    
--ELSE
SET @@SQL = " SELECT "   
 
SET @@SQL = @@SQL + " CLTCODE, "    
SET @@SQL = @@SQL + " PARTY_NAME, "    
SET @@SQL = @@SQL + " ENTITY_LEVEL,"    
SET @@SQL = @@SQL + " ENTITY_CODE, "    
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "    
SET @@SQL = @@SQL + " FROM "    
SET @@SQL = @@SQL + " #REPORT_DATA"    

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newUserWithPswd
-- --------------------------------------------------
CREATE procedure newUserWithPswd (@sbcd as varchar(10),@pswd as varchar(10),@flName as varchar(50),@ctgry as int,@admn as int)    
as    
/*declare @sbcd as varchar(10),@pswd as varchar(10),@flName as varchar(50),@ctgry as int,@admn as int    
    
set @sbcd='aa'    
set @pswd='aa'    
set @flName='ab ac'    
set @ctgry=14    
set @admn=9*/    
    
declare @fldat as int,@p as int    
    
select @p=count(*) from tblPradnyausers with (nolock) where fldusername=@sbcd    
if(@p=0)     
begin    
    
 insert into tblPradnyausers     
 (Fldusername,Fldpassword,Fldfirstname,Fldlastname,Fldcategory,Fldadminauto,Fldstname,Pwd_Expiry_Date )    
 values     
 (@sbcd,@pswd,(substring(ltrim(rtrim(@flName)),0,charindex(' ',ltrim(rtrim(@flName))))),    
 substring(ltrim(rtrim(@flName)),charindex(' ',ltrim(rtrim(@flName))),25),    
 @ctgry,@admn,@sbcd,(getdate()+10))    
    
 Select @fldat=FLDAUTO from tblPradnyaUsers  where fldUsername = @sbcd    
    
 insert into tblUserControlMaster Values (@fldat,10,10,0,0,0,'F','127.0.0.1',20,'Y',0)    
    
 Insert into TBLUSERCONTROLMASTER     
 select a.FLDAUTO, b.FLDPWDEXPIRY, b.FLDMAXATTEMPT,0,0,0,b.FLDACCESSLVL,'',b.FLDTIMEOUT,b.FLDFIRSTLOGIN,b.FLDFORCELOGOUT     
 FROM TBLPRADNYAUSERS A left OUTER JOIN TBLUSERCONTROLMASTER X     
 ON (A.FLDAUTO = X.FLDUSERID) , TBLUSERCONTROLGLOBALS B     
 WHERE B.FLDCATEGORYID = A.FLDCATEGORY AND ISNULL(X.FLDUSERID,0) = 0    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_Charges_Detail
-- --------------------------------------------------



CREATE   Procedure [dbo].[PR_Charges_Detail]     
(    
	@Sauda_Date_FROM Varchar(11),    
	@Sauda_Date_To Varchar(11) ,    
	@Party_FROM Varchar(10),    
	@Party_To Varchar(10)     
) As     
    
     

/*
	Procedure Name  : Calculate_VolumnBrok
	Description : Compute Volumn (Value/Quantity/Lot Size)
	Tables Using  : 
	1. Scheme_Master - Scheme Definition Master Table 
	2. Scheme_Mapping - Scheme Mapping to END Client 
	3. Contract_Rounding - Client's Contract Level Roundings
	4. Charges_Detail - Keeping Computed Brokerage
*/

/*---------------------------------------------------------------------------------------------------------------
    Creating Temp Table for Process
----------------------------------------------------------------------------------------------------------------*/

CREATE TABLE [dbo].[#Charges_Detail_Temp]
(
	[CD_Party_Code]   		[varchar] (10),
	[CD_Sauda_Date]   		[datetime],
	[CD_Contract_No] 		[varchar] (14),
	[CD_Trade_No]   		[varchar] (15),
	[CD_Order_No]   		[varchar] (15),
	[CD_Product_Type] 		[varchar] (5),
	[CD_Product_Code] 		[varchar] (10),
	[CD_Series_Code] 		[varchar] (20),
	[CD_Series_Id] 			[int],
	[CD_Expiry_Date]  		[datetime],
	[CD_AuctionPart]  		[varchar] (2),
	[CD_MarketLot]   		[int],
	[CD_Scheme_Id]   		[int] ,
	[CD_ComputationLevel]  		[char] (1),
	[CD_ComputationOn]  		[char] (1),
	[CD_ComputationType]  		[char] (1),
	[CD_BuyRate]   			[money],
	[CD_SellRate]   		[money],
	[CD_Tot_BuyQty]   		[int],
	[CD_Tot_SellQty]  		[int],
	[CD_Tot_BuyTurnOver]  		[money],
	[CD_Tot_SellTurnOver]  		[money],
	[CD_Tot_BuyTurnOver_Rounded] 	[money],
	[CD_Tot_SellTurnOver_Rounded] 	[money],
	[CD_Tot_TurnOver]  		[money],
	[CD_Tot_TurnOver_Rounded] 	[money],
	[CD_Tot_Lot]   			[int],
	[CD_Tot_Res_TurnOver]  		[money],
	[CD_Tot_Res_TurnOver_Rounded] 	[money],
	[CD_Tot_Res_Lot]  		[int],
	[CD_Tot_BuyBrok]  		[money],
	[CD_Tot_SellBrok]  		[money],
	[CD_Tot_Brok]   		[money],
	[CD_Tot_SerTax]   		[money],
	[CD_Tot_Stt]   			[money],
	[CD_Tot_Turn_Tax] 		[money],
	[CD_Tot_Other_Chrg]  		[money],
	[CD_Tot_Sebi_Tax]  		[money],
	[CD_Tot_StampDuty]  		[money],
	[CD_Exch_BuyRate]  		[money],
	[CD_Exch_SellRate]  		[money],
	[CD_Min_BrokAmt]  		[numeric](18, 4),
	[CD_Max_BrokAmt]  		[numeric](18, 4),
	[CD_Min_ScripAmt]  		[numeric](18, 4),
	[CD_Max_ScripAmt]  		[numeric](18, 4),
)

SELECT * INTO #Charges_Detail_Temp1 FROM #Charges_Detail_Temp WHERE 1 = 2

SELECT * INTO #Charges_Detail_Final FROM #Charges_Detail_Temp WHERE 1 = 2

CREATE INDEX [idxSDate] ON [dbo].[#Charges_Detail_Temp] 
(
	[CD_Sauda_Date], [CD_Party_Code], [CD_Product_Code], [CD_Series_Code]
)

CREATE INDEX [idxSDate] ON [dbo].[#Charges_Detail_Temp1] 
(
	[CD_Sauda_Date], [CD_Party_Code], [CD_Product_Code], [CD_Series_Code]
)

CREATE INDEX [idxSDate] ON [dbo].[#Charges_Detail_Final] 
(
	[CD_Sauda_Date], [CD_Party_Code], [CD_Product_Code], [CD_Series_Code]
)

/*---------------------------------------------------------------------------------------------------------------
    Fetching Data for Flat Value Based Brokerage
----------------------------------------------------------------------------------------------------------------*/

IF @Party_To='' BEGIN SET @Party_To ='zzzzz' END

INSERT INTO #Charges_Detail_Temp
(
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	CD_Product_Type,CD_Product_Code,CD_Series_Code,CD_Series_Id,
	CD_Expiry_Date,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,
	CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,CD_BuyRate,CD_SellRate,
	CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,CD_Tot_BuyTurnOver_Rounded,
	CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,
	CD_Tot_Lot,CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,
	CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,CD_Tot_Brok,
	CD_Tot_SerTax,CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,CD_Tot_StampDuty,
	CD_Exch_BuyRate,CD_Exch_SellRate,CD_Min_BrokAmt,CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt
)

SELECT
	Party_Code,Sauda_Date,ContractNo,Trade_No,Order_No,
	Product_Type,Product_Code,Series_Code,Series_Id,
	ExpiryDate,AuctionPart,MarketLot,SP_Scheme_Id,
	SP_Computation_Level,Sp_Brok_ComputeOn,Sp_Brok_ComputeType,
	BuyRate,SellRate,
	Buy_Qty, Sell_Qty, 
	Buy_TurnOver, Sell_TurnOver,
	RND_Buy_TurnOver, RND_Sell_TurnOver, 
	TotalTurnOver, RND_TurnOver,
	TotalLot,
	TotalTurnOver_Res,RND_TurnOver_Res,TotalLot_Res,
	BuyBrokerage = (Case When Sp_Brok_ComputeOn = 'V'
			     Then (Case WHEN BuyBrokerage > 0 
				THEN (Case WHEN SP_Max_BrokAmt = - 1 
					THEN (Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,BuyBrokerage) 
						ELSE BuyBrokerage
						END)
					ELSE Pradnya.Dbo.fnMin(SP_Max_BrokAmt,
						(Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,BuyBrokerage) 
						ELSE BuyBrokerage
						END))
					END)
				ELSE 0 
				END)* Buy_Qty/TotalLot
			 Else BuyBrokerage End),
        SellBrokerage = (Case When Sp_Brok_ComputeOn = 'V'
			     Then (Case WHEN SellBrokerage > 0 
				THEN (Case WHEN SP_Max_BrokAmt = - 1 
					THEN (Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,SellBrokerage) 
						ELSE SellBrokerage
						END)
					ELSE Pradnya.Dbo.fnMin(SP_Max_BrokAmt,
						(Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,SellBrokerage) 
						ELSE SellBrokerage
						END))
					END)
				ELSE 0 
				END) * Sell_Qty/TotalLot
			 Else SellBrokerage End),
	TotalBrokerage = Case When Sp_Brok_ComputeOn = 'V' Then 0 Else  
			(Case WHEN (BuyBrokerage+SellBrokerage) > 0 
				THEN (Case WHEN SP_Max_BrokAmt = - 1 
					THEN (Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,(BuyBrokerage+SellBrokerage)) 
						ELSE (BuyBrokerage+SellBrokerage)
						END)
					ELSE Pradnya.Dbo.fnMin(SP_Max_BrokAmt,
						(Case WHEN SP_Min_BrokAmt <> 0 
						THEN Pradnya.Dbo.fnMax(SP_Min_BrokAmt,(BuyBrokerage+SellBrokerage)) 
						ELSE (BuyBrokerage+SellBrokerage)
						END))
					END)
				ELSE 0 
				END) End,
	CD_Tot_SerTax = 0,CD_Tot_Stt,CD_Tot_Turn_Tax,
	CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,
	CD_Exch_SellRate,SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt
FROM
(
 SELECT 
	Party_Code,
	Sauda_Date,
	ContractNo ,
	Trade_No = (Case WHEN Sp_Computation_Level = 'T' THEN Trade_No ELSE '' END),
	Order_No = (Case WHEN Sp_Computation_Level In ('T', 'O') THEN Order_No ELSE '' END),
	Product_Type = (Case WHEN Sp_Computation_Level <> 'C' THEN Product_Type ELSE '' END),
	Product_Code = (Case WHEN Sp_Computation_Level <> 'C' THEN Product_Code ELSE Right(Product_Code,3) END),
	Series_Code = (Case WHEN Sp_Computation_Level <> 'C' THEN Series_Code ELSE '' END),
	Series_Id = (Case WHEN Sp_Computation_Level <> 'C' THEN Series_Id ELSE '' END),
	ExpiryDate = (Case WHEN Sp_Computation_Level <> 'C' THEN ExpiryDate ELSE '' END),
	AuctionPart ,
	MarketLot = Sum(LotSize*TradeQty)/Sum(TradeQty),
	SP_Computation_Level,
	Sp_Brok_ComputeOn,
	Sp_Brok_ComputeType,
	Sp_Scheme_Type,
	SP_Scheme_Id,
	BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
					THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
						Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
					ELSE 0 
					END),
	SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
					THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
					Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
					ELSE 0 
					END),
	Buy_Qty = Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END),
	Sell_Qty = Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END),
	TotalQty = Sum(TradeQty),
	TotalTurnOver = Sum(Total_TurnOver),
	Buy_TurnOver = Sum(Buy_TurnOver),
	RND_Buy_TurnOver = Pradnya.DBO.RoundedTurnover(Sum(Buy_TurnOver),Sp_Multiplier) ,
	Sell_TurnOver = Sum(Sell_TurnOver),
	RND_Sell_TurnOver = Pradnya.DBO.RoundedTurnover(Sum(Sell_TurnOver),Sp_Multiplier) ,
	RND_TurnOver = Pradnya.DBO.RoundedTurnover(Sum(Total_TurnOver),Sp_Multiplier) ,	
	TotalLot = (Case WHEN Sp_Brok_ComputeOn = 'T' 
			THEN Convert(BigInt,Pradnya.DBO.RoundedTurnover(Sum(Total_TurnOver), Sp_Multiplier) / Sp_Multiplier)
			WHEN Sp_Brok_ComputeOn = 'Q'  
			THEN Convert(BigInt,Pradnya.DBO.RoundedTurnover(Sum(TradeQty), Sp_Multiplier) / Sp_Multiplier)
			WHEN Sp_Brok_ComputeOn = 'L'
			THEN Convert(BigInt,Pradnya.DBO.RoundedTurnover(Sum(TradeQty), 
				(Sp_Multiplier*Sum(LotSize*TradeQty)/Sum(TradeQty))) / 
				(Sp_Multiplier*Sum(LotSize*TradeQty)/Sum(TradeQty)))
			ELSE
				Sum(LotSize*TradeQty)/Sum(TradeQty)
			END),
	TotalTurnOver_Res = 0,
	RND_TurnOver_Res = 0,
	TotalLot_Res = 0,
	BuyBrokerage = (Case WHEN Sp_Scheme_Type = 0 
			      THEN (Pradnya.DBO.RoundedTurnover(
			           (Case When Sp_Brok_ComputeOn = 'V' And Sp_Buy_Brok_Type = 'P' 
				         Then (Case When Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
	                                            Then Sum(Buy_TurnOver)
	                                                /Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
	                                            Else 0
	                                       End)
					 When Sp_Brok_ComputeOn = 'V' And Sp_Buy_Brok_Type = 'V' 
					 Then 1
	                                 Else Sum(Buy_TurnOver) 
                                    End),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Buy_Brok_Type = 'P' 
	                                 THEN Sp_Buy_Brok/100 
	                                 ELSE Sp_Buy_Brok 
	                            END))
	                      WHEN (Sum(Buy_TurnOver) >= Sum(Sell_TurnOver) AND Sp_Scheme_Type = 1) 
	                           Or (Sum(Buy_TurnOver) > Sum(Sell_TurnOver) AND Sp_Scheme_Type = 3)
	                           THEN (Pradnya.DBO.RoundedTurnover(Sum(Buy_TurnOver),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Buy_Brok_Type = 'P' 
	                                 THEN Sp_Buy_Brok/100 
	                                 ELSE Sp_Buy_Brok 
	                            END))
	                      ELSE (Pradnya.DBO.RoundedTurnover(Sum(Buy_TurnOver),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Sell_Brok_Type = 'P' 
	                                 THEN Sp_Sell_Brok/100 
	                                 ELSE Sp_Sell_Brok 
	                            END))
	                  END),

	SellBrokerage = (Case WHEN Sp_Scheme_Type = 0 
			      THEN (Pradnya.DBO.RoundedTurnover(
			           (Case When Sp_Brok_ComputeOn = 'V' And Sp_Sell_Brok_Type = 'P' 
				         Then (Case When Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
	                                            Then Sum(Sell_TurnOver)
	                                                /Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
	                                            Else 0
	                                       End)
					 When Sp_Brok_ComputeOn = 'V' And Sp_Sell_Brok_Type = 'V' 
					 Then 1
	                                 Else Sum(Sell_TurnOver) 
                                    End),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Sell_Brok_Type = 'P' 
	                                 THEN Sp_Sell_Brok/100 
	                                 ELSE Sp_Sell_Brok 
	                            END))
	                      WHEN (Sum(Buy_TurnOver) >= Sum(Sell_TurnOver) AND Sp_Scheme_Type = 1) 
	                           Or (Sum(Buy_TurnOver) > Sum(Sell_TurnOver) AND Sp_Scheme_Type = 3)
	                           THEN (Pradnya.DBO.RoundedTurnover(Sum(Sell_TurnOver),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Sell_Brok_Type = 'P' 
	                                 THEN Sp_Sell_Brok/100 
	                                 ELSE Sp_Sell_Brok 
	                            END))
	                      ELSE (Pradnya.DBO.RoundedTurnover(Sum(Sell_TurnOver),Sp_Multiplier)/Sp_Multiplier * 
	                           (Case WHEN Sp_Buy_Brok_Type = 'P' 
	                                 THEN Sp_Buy_Brok/100 
	                                 ELSE Sp_Buy_Brok 
	                            END))
	                  END),
	TotalBrokerage = 0, 
	CD_Tot_SerTax = 0 ,
	CD_Tot_Stt = Sum(Ins_Chrg),
	CD_Tot_Turn_Tax = Sum(Turn_Tax),
	CD_Tot_Other_Chrg = Sum(Other_Chrg) ,
	CD_Tot_Sebi_Tax = Sum(Sebi_Tax) ,
	CD_Tot_StampDuty = Sum(Broker_Chrg) ,
	CD_Exch_BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
				THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
					Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
			ELSE 0 
			END),
	CD_Exch_SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
				THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
					Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
				ELSE 0 
				END),
	SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt
 FROM 
 (
	SELECT 
	Trade_No=Pradnya.dbo.ReplaceTradeNo(Trade_No),Order_No,F.Party_Code,ContractNo,Sell_Buy,
	Product_Type,Product_Code,Series_Code,Series_Id,ExpiryDate,
	TradeQty,LotSize = Convert(BigInt,BillNo),Sauda_Date=Left(Sauda_Date,11),MarketRate,   
	SP_Party_Code,SP_Computation_Level,SP_Scheme_Id,SP_Trd_Type,
	SP_Scheme_Type,SP_Multiplier,SP_Buy_Brok,SP_Sell_Brok,SP_Res_Multiplier,
	SP_Res_Buy_Brok,SP_Res_Sell_Brok,SP_Value_FROM,SP_Value_To,SP_Brok_ComputeOn,
	SP_Brok_ComputeType,SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt,
	SP_Buy_Brok_Type,SP_Sell_Brok_Type,AuctionPart,
	Ins_Chrg = (Ins_Chrg),
	Turn_Tax = (Turn_Tax), 
	Other_Chrg = (F.Other_Chrg),
	Sebi_Tax = (Sebi_Tax),
	Broker_Chrg = (Broker_Chrg),
	Buy_TurnOver = 
		Case WHEN Sell_Buy = 1 THEN 
				Case WHEN Sp_Brok_ComputeOn = 'T' 
				THEN TradeQty * MarketRate
				WHEN Sp_Brok_ComputeOn = 'Q'
					THEN TradeQty
				WHEN Sp_Brok_ComputeOn = 'L'
					Then TradeQty / Convert(BigInt,BillNo)
				ELSE MarketRate*TradeQty*Convert(BigInt,BillNo)
				END
		ELSE 0 END,
	Sell_TurnOver =
		Case WHEN Sell_Buy = 2 THEN
			Case WHEN Sp_Brok_ComputeOn = 'T' 
			THEN TradeQty * MarketRate
			WHEN Sp_Brok_ComputeOn = 'Q'
				THEN TradeQty
			WHEN Sp_Brok_ComputeOn = 'L'
					Then TradeQty / Convert(BigInt,BillNo)
				ELSE MarketRate*TradeQty*Convert(BigInt,BillNo)
			END
		ELSE 0 END,
	Total_TurnOver =
		Case WHEN Sp_Brok_ComputeOn = 'T' 
			THEN TradeQty * MarketRate
			WHEN Sp_Brok_ComputeOn = 'Q'
				THEN TradeQty
			WHEN Sp_Brok_ComputeOn = 'L'
					Then TradeQty / Convert(BigInt,BillNo)
				ELSE MarketRate*TradeQty*Convert(BigInt,BillNo)
		END
	FROM
		BFoSettlement F,
		Scheme_Mapping S,
		Client1 C1,
		Client2 C2
	WHERE
		Sauda_Date BETWEEN @Sauda_Date_FROM AND @Sauda_Date_To +' 23:59:59'
		AND F.Party_Code BETWEEN @Party_FROM AND @Party_To
		AND Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
		AND F.Party_Code = Sp_Party_Code
		AND Right(Product_Code,3) = Sp_Product_Code
		AND F.Series_Id Between Sp_Series_Id and Case When Sp_Series_Id = 0 Then 999999 Else Sp_Series_Id End
		AND  1 = Case
				WHEN Sp_Series_Id = 0 AND Series_Id NOT IN 
				( 
				SELECT Sp_Series_Id FROM Scheme_Mapping S
				WHERE Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
				AND F.Party_Code = Sp_Party_Code
				AND Right(Product_Code,3) = Sp_Product_Code
				) 
			THEN 1   
			ELSE Case WHEN Sp_Series_Id = 0 THEN 0 ELSE 1  END END
		AND SP_Trd_Type = Case WHEN AuctionPart ='0'
				THEN 'TRD' ELSE 'DEL' END
	AND AuctionPart <> 'CA'
	AND TradeQty > 0 
	AND SP_Brok_ComputeType = 'V'
	AND C1.Cl_Code = C2.Cl_Code 
	AND C2.Party_Code = F.Party_Code
	AND C1.Cl_Type <> 'INS' AND Reserved1 = 0 	
	AND Status <> 'E'
 ) FoSett 
 Group BY 
	Party_Code,
	Sauda_Date,
	Contractno,
	(Case WHEN Sp_Computation_Level = 'T' THEN Trade_No ELSE '' END),
	(Case WHEN Sp_Computation_Level In ('T', 'O') THEN Order_No ELSE '' END),	
	(Case WHEN Sp_Computation_Level <> 'C' THEN Product_Type ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Product_Code ELSE Right(Product_Code,3) END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Series_Code ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Series_Id ELSE '' END),	
	(Case WHEN Sp_Computation_Level <> 'C' THEN ExpiryDate ELSE '' END),
	Sp_Multiplier,SP_Computation_Level,Sp_Brok_ComputeOn,Sp_Scheme_Type,
	Sp_Brok_ComputeType,Sp_Value_FROM,Sp_Value_To,SP_Scheme_Id,
	SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt,    
	Sp_Sell_Brok, Sp_Buy_Brok, Sp_Buy_Brok_Type, Sp_Sell_Brok_Type,
	AuctionPart    	
 Having 
	(Case 
		WHEN Sp_Brok_ComputeOn = 'T' THEN Sum(TradeQty*MarketRate)   
		WHEN Sp_Brok_ComputeOn = 'Q' THEN Sum(TradeQty)   
		WHEN Sp_Brok_ComputeOn = 'L' THEN Sum(TradeQty/LotSize) 
		Else (Sum(TradeQty*MarketRate)/Sum(TradeQty))*Sum(TradeQty*LotSize)/Sum(TradeQty)
	END) > Sp_Value_FROM   
	AND   
	(Case
		WHEN Sp_Brok_ComputeOn = 'T' THEN Sum(TradeQty*MarketRate)   
		WHEN Sp_Brok_ComputeOn = 'Q' THEN Sum(TradeQty)   
		WHEN Sp_Brok_ComputeOn = 'L' THEN Sum(TradeQty/LotSize) 	
		Else (Sum(TradeQty*MarketRate)/Sum(TradeQty))*Sum(TradeQty*LotSize)/Sum(TradeQty)
	END)
		<= 
				(Case WHEN Sp_Value_To = -1 
					THEN (Case WHEN Sp_Brok_ComputeOn = 'T' THEN Sum(TradeQty*MarketRate)   
						WHEN Sp_Brok_ComputeOn = 'Q' THEN Sum(TradeQty)   
						WHEN Sp_Brok_ComputeOn = 'L' THEN Sum(TradeQty/LotSize) 
						Else (Sum(TradeQty*MarketRate)/Sum(TradeQty))*Sum(TradeQty*LotSize)/Sum(TradeQty)
					END)
				ELSE Sp_Value_To
				END)
) FoSettChrg



UPDATE 
	 #Charges_Detail_Temp
SET
	 CD_Tot_SellBrok=CD_Tot_Brok , CD_Tot_BuyBrok=0
WHERE
	 CD_Tot_Brok <> CD_Tot_SellBrok + CD_Tot_BuyBrok
	 AND CD_Tot_SellBrok > CD_Tot_BuyBrok
	 And CD_ComputationOn <> 'V'


UPDATE 
	 #Charges_Detail_Temp
SET
	 CD_Tot_BuyBrok=CD_Tot_Brok , CD_Tot_SellBrok=0
WHERE
	 CD_Tot_Brok <> CD_Tot_SellBrok + CD_Tot_BuyBrok
	 AND CD_Tot_BuyBrok > CD_Tot_SellBrok 
	 And CD_ComputationOn <> 'V'

UPDATE 
	 #Charges_Detail_Temp
SET
	 CD_Tot_Brok =CD_Tot_SellBrok+ CD_Tot_BuyBrok
WHERE    CD_ComputationOn = 'V'

/*---------------------------------------------------------------------------------------------------------------
    Fetching Data for Incremental Value Based Brokerage
----------------------------------------------------------------------------------------------------------------*/

Declare @SETtCur Cursor,
	@Party_Code varchar(10),
	@Sauda_Date varchar(11),
	@ContractNo varchar(14),
	@Trade_No varchar(15),
	@Order_No varchar(15),
	@Product_Type varchar(5),
	@Product_Code varchar(10),
	@Series_Code varchar(20),
	@Series_Id int,
	@ExpiryDate Datetime,
	@AuctionPart varchar(2),
	@Buy_TurnOver money,
	@Sell_TurnOver money,
	@LotSize BigInt,
	@BuyRate money,
	@SellRate money,
	@BuyQty BigInt,
	@SellQty BigInt,
	@Tot_Stt Money,
	@Tot_Turn_Tax Money,
	@Tot_Other_Chrg Money,
	@Tot_Sebi_Tax Money,
	@Tot_StampDuty Money,
	@Exch_BuyRate Money,
	@Exch_SellRate Money,
	@Min_BrokAmt Money,
	@Max_BrokAmt Money,
	@Min_ScripAmt Money,
	@Max_ScripAmt Money,
	@Sp_ComputationLevel Char(1),
	@Sp_ComputationOn char(1),
	@Sp_ComputationType char(1),
	@SchemeId Int

Declare @SchemeCur Cursor,
	@SP_Computation_Level char(1),
	@SP_Multiplier money,
	@SP_Buy_Brok_Type char(1),
	@SP_Sell_Brok_Type char(1),
	@SP_Buy_Brok numeric (18,4),
	@SP_Sell_Brok numeric (18,4),
	@SP_Value_FROM numeric (18,4),
	@SP_Value_To numeric (18,4),
	@BuyFlag BigInt,
	@SellFlag BigInt,
	@Sp_Scheme_Type int

Declare 
	@NewBuyTurnOver Money,
	@NewBuyTurnOverOrg Money,
	@NewSellTurnOver Money,
	@NewSellTurnOverOrg Money,
	@BuyBrokerage Money,
	@SellBrokerage Money

SET @SETtCur = Cursor For
	SELECT 
	Party_Code,
	Sauda_Date,
	ContractNo,
	Trade_No = (Case WHEN Sp_Computation_Level = 'T' THEN Trade_No ELSE '' END),
	Order_No = (Case WHEN Sp_Computation_Level In ('T', 'O') THEN Order_No ELSE '' END),
	Product_Type = (Case WHEN Sp_Computation_Level <> 'C' THEN Product_Type ELSE '' END),
	Product_Code = (Case WHEN Sp_Computation_Level <> 'C' THEN Product_Code ELSE Right(Product_Code,3) END),
	Series_Code = (Case WHEN Sp_Computation_Level <> 'C' THEN Series_Code ELSE '' END),
	Series_Id = (Case WHEN Sp_Computation_Level <> 'C' THEN Series_Id ELSE '' END),
	ExpiryDate = (Case WHEN Sp_Computation_Level <> 'C' THEN ExpiryDate ELSE '' END),
	AuctionPart,
	Buy_TurnOver = Sum(Buy_TurnOver),
	Sell_TurnOver = Sum(Sell_TurnOver),
	LotSize=Sum(LotSize*TradeQty)/Sum(TradeQty),
	BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
			ELSE 0 
		END),
	SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
			ELSE 0 
		END),
	BuyQty = Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END),
	SellQty = Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END),
	CD_Tot_Stt = Sum(Ins_Chrg),
	CD_Tot_Turn_Tax = Sum(Turn_Tax),
	CD_Tot_Other_Chrg = Sum(Other_Chrg) ,
	CD_Tot_Sebi_Tax = Sum(Sebi_Tax) ,
	CD_Tot_StampDuty = Sum(Broker_Chrg) ,
	CD_Exch_BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
				THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
					Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
				ELSE 0 
				END),
	CD_Exch_SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
				THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
					Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
					ELSE 0
				END),
	SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt,
	Sp_Computation_Level,Sp_Brok_ComputeOn,SP_ComputationType,Sp_Scheme_Id
 FROM 
 (
	SELECT 
		Trade_No=Pradnya.dbo.ReplaceTradeNo(Trade_No),Order_No,F.Party_Code,ContractNo,Sell_Buy,
		Product_Type,Product_Code,Series_Code,Series_Id,ExpiryDate,
		TradeQty,LotSize = Convert(BigInt,BillNo),Sauda_Date=Left(Sauda_Date,11),MarketRate,
		Buy_TurnOver = Case WHEN Sell_Buy = 1 THEN
					Case WHEN Sp_Brok_ComputeOn = 'T' 
						THEN TradeQty * MarketRate
					WHEN Sp_Brok_ComputeOn = 'Q'
						THEN TradeQty
					ELSE TradeQty / Convert(BigInt,BillNo)
					END
				ELSE 0 END,
		Sell_TurnOver = Case WHEN Sell_Buy = 2 THEN
					Case WHEN Sp_Brok_ComputeOn = 'T' 
						THEN TradeQty*MarketRate
					WHEN Sp_Brok_ComputeOn = 'Q'
						THEN TradeQty
					ELSE TradeQty / Convert(BigInt,BillNo)
					END
				ELSE 0 END,
		Sp_Computation_Level,Sp_Brok_ComputeOn,
		SP_ComputationType = SP_Brok_ComputeType,SP_Scheme_Id,
		SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt,
		Sp_Multiplier,AuctionPart,
		Ins_Chrg = (Ins_Chrg),
		Turn_Tax = (Turn_Tax), 
		Other_Chrg = (F.Other_Chrg),
		Sebi_Tax = (Sebi_Tax),
		Broker_Chrg = (Broker_Chrg)    
	FROM
		BFoSettlement F,
		Scheme_Mapping S,
		Client1 C1,
		Client2 C2
	WHERE
		Sauda_Date BETWEEN @Sauda_Date_FROM AND @Sauda_Date_To + ' 23:59:59'
		AND F.Party_Code BETWEEN @Party_FROM AND @Party_To
		AND Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
		AND F.Party_Code = Sp_Party_Code
		AND Right(Product_Code,3) = Sp_Product_Code
		AND Series_Id Between Sp_Series_Id and Case When Sp_Series_Id = 0 Then 999999 Else Sp_Series_Id End
		AND  1 = Case
			WHEN Sp_Series_Id = 0 AND Series_Id NOT IN 
			( 
				SELECT Sp_Series_Id FROM Scheme_Mapping S
				WHERE Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
				AND F.Party_Code = Sp_Party_Code
				AND Right(Product_Code,3) = Sp_Product_Code
			) 
			THEN 1   
			ELSE Case WHEN Sp_Series_Id = 0 THEN 0 ELSE 1  END END
	AND SP_Trd_Type = Case WHEN AuctionPart ='0'
				THEN 'TRD' ELSE 'DEL' END
	AND AuctionPart <> 'CA'
	AND TradeQty > 0 
	AND SP_Brok_ComputeType = 'I'
	AND Sp_Value_FROM = (SELECT Min(Sp_Value_FROM) FROM 
				Scheme_Mapping S
				WHERE Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
				AND F.Party_Code = Sp_Party_Code
				AND Right(Product_Code,3) = Sp_Product_Code)
	AND C1.Cl_Code = C2.Cl_Code AND C2.Party_Code = F.Party_Code
	AND C1.Cl_Type <> 'INS' AND Reserved1 = 0 	
	AND Status <> 'E'
 ) FoSETt
 
 Group BY 
	Party_Code,
	Sauda_Date,
	Contractno,
	(Case WHEN Sp_Computation_Level = 'T' THEN Trade_No ELSE '' END),
	(Case WHEN Sp_Computation_Level In ('T', 'O') THEN Order_No ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Product_Type ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Product_Code ELSE Right(Product_Code,3) END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Series_Code ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN Series_Id ELSE '' END),
	(Case WHEN Sp_Computation_Level <> 'C' THEN ExpiryDate ELSE '' END),
	AuctionPart,SP_Min_BrokAmt,SP_Max_BrokAmt,SP_Min_SeriesIdAmt,SP_Max_SeriesIdAmt,
	Sp_Computation_Level,Sp_Brok_ComputeOn,SP_ComputationType,Sp_Scheme_Id

Open @SETtCur


 Fetch Next FROM @SETtCur INTO @Party_Code,@Sauda_Date,@ContractNo,@Trade_No,@Order_No,
	@Product_Type,@Product_Code,@Series_Code,@Series_Id,@ExpiryDate,
	@AuctionPart,@Buy_TurnOver,@Sell_TurnOver,@LotSize,@BuyRate,@SellRate,@BuyQty,
	@SellQty,@Tot_Stt,@Tot_Turn_Tax,@Tot_Other_Chrg,@Tot_Sebi_Tax,@Tot_StampDuty,@Exch_BuyRate,@Exch_SellRate,
	@Min_BrokAmt,@Max_BrokAmt,@Min_ScripAmt,@Max_ScripAmt,@Sp_ComputationLevel,@Sp_ComputationOn,
	@Sp_ComputationType,@SchemeId

	WHILE @@Fetch_Status = 0 
	BEGIN   
		SELECT @BuyFlag = 0 
		SELECT @SellFlag = 0 

		/*-----------------------------------------------------------------------------------------------------------*/
		SET @SchemeCur = Cursor For
		SELECT
			SP_Computation_Level,
			SP_Multiplier,
			SP_Buy_Brok_Type,
			SP_Sell_Brok_Type,
			SP_Buy_Brok,
			SP_Sell_Brok,
			SP_Value_FROM,
			SP_Value_To,
			SP_Scheme_Type
		FROM
			Scheme_Mapping
		WHERE
			@Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
			AND Sp_Party_Code = @Party_Code  
			AND Sp_Product_Code = Left(@Product_Code,3)
			AND Sp_Series_Id Between 0 and Case When Sp_Series_Id = 0 Then 999999 Else Sp_Series_Id End
			AND  1 = Case
				WHEN Sp_Series_Id = 0 AND @Series_Id NOT IN 
				( 
					SELECT Sp_Series_Id FROM Scheme_Mapping S
					WHERE @Sauda_Date BETWEEN Sp_Date_FROM AND Sp_Date_To
					AND Sp_Party_Code = @Party_Code  
					AND Sp_Product_Code = Left(@Product_Code,3)  
				) 
				THEN 1   
				ELSE Case WHEN Sp_Series_Id = 0 THEN 0 ELSE 1  END END  
			AND SP_Trd_Type = Case WHEN @AuctionPart ='0'
					THEN 'TRD' ELSE 'DEL' END
			AND SP_Brok_ComputeType = 'I'
		Order By SP_Value_FROM

		Open @SchemeCur
		Fetch Next FROM 
			@SchemeCur INTO @SP_Computation_Level,@SP_Multiplier,@SP_Buy_Brok_Type,@SP_Sell_Brok_Type,
			@SP_Buy_Brok,@SP_Sell_Brok,@SP_Value_FROM,@SP_Value_To,@Sp_Scheme_Type

			SET @NewBuyTurnOver = @Buy_TurnOver 
			SET @NewSellTurnOver = @Sell_TurnOver 
			SET @NewBuyTurnOverOrg = 0 
			SET @NewSellTurnOverOrg = 0 
			SET @BuyBrokerage = 0
			SET @SellBrokerage = 0

		WHILE @@Fetch_Status = 0 AND (@NewBuyTurnOver > 0 Or @NewSellTurnOver > 0)     
		BEGIN

		/*--------------------------------------------------------------------*/
		SET @BuyBrokerage = 0
		SET @SellBrokerage = 0
		IF @NewBuyTurnOver > 0 
		BEGIN
			IF @Buy_TurnOver >= @SP_Value_To AND @SP_Value_To > -1
			BEGIN 
				SET @NewBuyTurnOver = (@SP_Value_To - @SP_Value_FROM)/@SP_Multiplier
				SET @NewBuyTurnOverOrg = @NewBuyTurnOver * @SP_Multiplier
			END
			ELSE 
			BEGIN
				SET @NewBuyTurnOver = @Buy_TurnOver - @SP_Value_FROM
				IF @NewBuyTurnOver < 0 	SET @NewBuyTurnOver = 0 
				SET @NewBuyTurnOverOrg  = @NewBuyTurnOver  
				SELECT @NewBuyTurnOver = Pradnya.DBO.RoundedTurnover(@NewBuyTurnOver,@SP_Multiplier)
				SELECT @NewBuyTurnOver = @NewBuyTurnOver / @SP_Multiplier
				SELECT @BuyFlag = 1
			END
			IF @NewBuyTurnOver > 0 
			BEGIN 
				SELECT @BuyBrokerage = 
					Case WHEN @Sp_Scheme_Type = 0 THEN
					Case WHEN @Sp_Buy_Brok_Type ='P'
					THEN @NewBuyTurnOver * @SP_Buy_Brok  /100
					ELSE @NewBuyTurnOver * @SP_Buy_Brok END
					ELSE
						Case WHEN (@NewBuyTurnOver >= @NewSellTurnOver AND @Sp_Scheme_Type=1)
							OR   (@NewBuyTurnOver >= @NewSellTurnOver AND @Sp_Scheme_Type=3)
						THEN
							Case WHEN @Sp_Buy_Brok_Type ='P'   
							THEN @NewBuyTurnOver * @SP_Buy_Brok  /100
							ELSE @NewBuyTurnOver * @SP_Buy_Brok END
						ELSE
							Case WHEN @Sp_Sell_Brok_Type ='P'
							THEN @NewBuyTurnOver * @SP_Sell_Brok  /100
							ELSE @NewBuyTurnOver * @SP_Sell_Brok END
						END
					END
			END  
			ELSE   
				SELECT @BuyBrokerage = 0   
			END

			IF @NewSellTurnOver > 0 
			BEGIN
				IF @Sell_TurnOver >= @SP_Value_To AND @SP_Value_To > -1
				BEGIN 
					SET @NewSellTurnOver = (@SP_Value_To - @SP_Value_FROM)/@SP_Multiplier
					SET @NewSellTurnOverOrg = @NewSellTurnOver * @SP_Multiplier
				END
				ELSE 
				BEGIN
					SET @NewSellTurnOver = @Sell_TurnOver - @SP_Value_FROM
					IF @NewSellTurnOver < 0 SET @NewSellTurnOver = 0  
					SET @NewSellTurnOverOrg  = @NewSellTurnOver   
					SELECT @NewSellTurnOver = Pradnya.DBO.RoundedTurnover(@NewSellTurnOver,@SP_Multiplier)
					SELECT @NewSellTurnOver = @NewSellTurnOver / @SP_Multiplier
					SELECT @SellFlag = 1
				END
				IF @NewSellTurnOver > 0
				BEGIN  
					SELECT @SellBrokerage = 
						Case WHEN @Sp_Scheme_Type = 0 THEN
							Case WHEN @Sp_Sell_Brok_Type ='P'
							THEN @NewSellTurnOver * @SP_Sell_Brok  /100
							ELSE @NewSellTurnOver * @SP_Sell_Brok END
						ELSE
							Case WHEN (@NewBuyTurnOver >= @NewSellTurnOver AND @Sp_Scheme_Type=1)
							OR   (@NewBuyTurnOver >= @NewSellTurnOver AND @Sp_Scheme_Type=3)
							THEN
								Case WHEN @Sp_Sell_Brok_Type ='P'
								THEN @NewSellTurnOver * @SP_Sell_Brok  /100
								ELSE @NewSellTurnOver * @SP_Sell_Brok END
							ELSE
								Case WHEN @Sp_Buy_Brok_Type ='P'
								THEN @NewSellTurnOver * @SP_Buy_Brok  /100
								ELSE @NewSellTurnOver * @SP_Buy_Brok END
							END
						END
				END
			ELSE
				SELECT @SellBrokerage = 0   
			END


		INSERT INTO #Charges_Detail_Temp1 
		(
			CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
			Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,CD_Expiry_Date,
			CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,
			CD_ComputationOn,CD_ComputationType,CD_BuyRate,CD_SellRate,
			CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,
			CD_Tot_BuyTurnOver_Rounded,CD_Tot_SellTurnOver_Rounded,
			CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,
			CD_Tot_Lot,CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,
			CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,CD_Tot_Brok,CD_Tot_SerTax,
			CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,
			CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate,CD_Min_BrokAmt,
			CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt
		)
		Values 
		(
			@Party_Code,@Sauda_Date,@ContractNo,@Trade_No,@Order_No,
			@Product_Type,@Product_Code,@Series_Code,@Series_Id,@ExpiryDate,
			@AuctionPart,@LotSize,@SchemeId,
			@Sp_ComputationLevel,@Sp_ComputationOn,@Sp_ComputationType,@BuyRate,@SellRate,
			@BuyQty,@SellQty,@NewBuyTurnOverOrg,@NewSellTurnOverOrg,
			(@NewBuyTurnOver*@SP_Multiplier),
			(@NewSellTurnOver*@SP_Multiplier),0,0,
			(@BuyQty+@SellQty)/@SP_Multiplier ,0,0,0,@BuyBrokerage,@SellBrokerage,0,0,
			@Tot_Stt,@Tot_Turn_Tax,@Tot_Other_Chrg,@Tot_Sebi_Tax,@Tot_StampDuty,
			@Exch_BuyRate,@Exch_SellRate,
			@Min_BrokAmt,@Max_BrokAmt,@Min_ScripAmt,@Max_ScripAmt
		) 
		
		IF @SP_Value_To = -1   
		BEGIN  
			SELECT @NewBuyTurnOver = 0   
			SELECT @NewSellTurnOver = 0  
		END   
		/*--------------------------------------------------------------------*/
		Fetch Next FROM 
		@SchemeCur INTO @SP_Computation_Level,@SP_Multiplier,@SP_Buy_Brok_Type,@SP_Sell_Brok_Type,
		@SP_Buy_Brok,@SP_Sell_Brok,@SP_Value_FROM,@SP_Value_To,@Sp_Scheme_Type
	END
	Close @SchemeCur
	DeAllocate @SchemeCur
	 /*-----------------------------------------------------------------------------------------------------------*/
 Fetch Next FROM @SETtCur INTO @Party_Code,@Sauda_Date,@ContractNo,@Trade_No,@Order_No,
	@Product_Type,@Product_Code,@Series_Code,@Series_Id,@ExpiryDate,
	@AuctionPart,@Buy_TurnOver,@Sell_TurnOver,@LotSize,@BuyRate,@SellRate,@BuyQty,
	@SellQty,@Tot_Stt,@Tot_Turn_Tax,@Tot_Other_Chrg,@Tot_Sebi_Tax,@Tot_StampDuty,@Exch_BuyRate,@Exch_SellRate,
	@Min_BrokAmt,@Max_BrokAmt,@Min_ScripAmt,@Max_ScripAmt,@Sp_ComputationLevel,@Sp_ComputationOn,
	@Sp_ComputationType,@SchemeId

END
Close @SETtCur
DeAllocate @SETtCur

INSERT INTO #Charges_Detail_Temp
 (
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,
	CD_Expiry_Date,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,
	CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,CD_BuyRate,CD_SellRate,
	CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,CD_Tot_BuyTurnOver_Rounded,
	CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,
	CD_Tot_Lot,CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,
	CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,CD_Tot_Brok,
	CD_Tot_SerTax,
	CD_Tot_Stt,CD_Tot_Turn_Tax,
	CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate,
	CD_Min_BrokAmt,CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt
 )
SELECT 
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,
	CD_Expiry_Date,CD_AuctionPart,
	CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,
	CD_BuyRate,CD_SellRate,CD_Tot_BuyQty,CD_Tot_SellQty,
	CD_Tot_BuyTurnOver,
	CD_Tot_SellTurnOver,
	CD_Tot_BuyTurnOver_Rounded,
	CD_Tot_SellTurnOver_Rounded,
	CD_Tot_TurnOver=CD_Tot_BuyTurnOver+CD_Tot_SellTurnOver,
	CD_Tot_TurnOver_Rounded=CD_Tot_BuyTurnOver_Rounded+CD_Tot_SellTurnOver_Rounded,
	CD_Tot_Lot,
	CD_Tot_Res_TurnOver=0,
	CD_Tot_Res_TurnOver_Rounded=0,
	CD_Tot_Res_Lot,
	CD_Tot_BuyBrok=(Case WHEN CD_Tot_BuyBrok > 0 
				THEN (Case WHEN CD_Max_BrokAmt = - 1 
				THEN (Case WHEN CD_Min_BrokAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_BuyBrok) 
					ELSE CD_Tot_BuyBrok
					END)
				ELSE Pradnya.Dbo.fnMin(CD_Max_BrokAmt,
					(Case WHEN CD_Min_BrokAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_BuyBrok) 
					ELSE CD_Tot_BuyBrok
					END))
				END)
			ELSE 0 
			END),
	CD_Tot_SellBrok=(Case WHEN CD_Tot_SellBrok > 0 
				THEN (Case WHEN CD_Max_BrokAmt = - 1 
				THEN (Case WHEN CD_Min_BrokAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_SellBrok) 
					ELSE CD_Tot_SellBrok
					END)
				ELSE Pradnya.Dbo.fnMin(CD_Max_BrokAmt,
					(Case WHEN CD_Min_BrokAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_SellBrok) 
					ELSE CD_Tot_SellBrok
					END))
				END)
			ELSE 0 
			END),
	CD_Tot_Brok=(Case WHEN CD_Tot_Brok > 0 
			THEN (Case WHEN CD_Max_BrokAmt = - 1 
			THEN (Case WHEN CD_Min_BrokAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_Brok) 
				ELSE CD_Tot_Brok
				END)
			ELSE Pradnya.Dbo.fnMin(CD_Max_BrokAmt,
				(Case WHEN CD_Min_BrokAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CD_Min_BrokAmt,CD_Tot_Brok) 
				ELSE CD_Tot_Brok
				END))
			END)
		ELSE 0 
		END),     
	CD_Tot_SerTax=0,
	CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,CD_Tot_StampDuty,
	CD_Exch_BuyRate,CD_Exch_SellRate,CD_Min_BrokAmt,CD_Max_BrokAmt,
	CD_Min_ScripAmt,CD_Max_ScripAmt
FROM
(
 SELECT 
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,CD_Expiry_Date,
	CD_AuctionPart,CD_MarketLot,
	CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,CD_BuyRate,CD_SellRate,
	CD_Tot_BuyQty= CD_Tot_BuyQty,
	CD_Tot_SellQty= CD_Tot_SellQty,
	CD_Tot_BuyTurnOver=Sum(CD_Tot_BuyTurnOver),
	CD_Tot_BuyTurnOver_Rounded=Sum(CD_Tot_BuyTurnOver_Rounded),
	CD_Tot_SellTurnOver=Sum(CD_Tot_SellTurnOver),
	CD_Tot_SellTurnOver_Rounded=Sum(CD_Tot_SellTurnOver_Rounded),
	CD_Tot_Lot,
	CD_Tot_Res_TurnOver=Sum(CD_Tot_Res_TurnOver),
	CD_Tot_Res_TurnOver_Rounded=Sum(CD_Tot_Res_TurnOver_Rounded),
	CD_Tot_Res_Lot,
	CD_Tot_BuyBrok=Sum(CD_Tot_BuyBrok),
	CD_Tot_SellBrok=Sum(CD_Tot_SellBrok),
	CD_Tot_Brok=Sum(CD_Tot_BuyBrok+CD_Tot_SellBrok),
	CD_Tot_SerTax = 0 ,
	CD_Tot_Stt=(CD_Tot_Stt),
	CD_Tot_Turn_Tax=(CD_Tot_Turn_Tax),
	CD_Tot_Other_Chrg=(CD_Tot_Other_Chrg),
	CD_Tot_Sebi_Tax=(CD_Tot_Sebi_Tax),
	CD_Tot_StampDuty=(CD_Tot_StampDuty),
	CD_Exch_BuyRate,CD_Exch_SellRate,CD_Min_BrokAmt,
	CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt
 FROM 
	#Charges_Detail_Temp1
 Group By
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,
	CD_Expiry_Date,CD_AuctionPart,CD_MarketLot,
	CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,CD_BuyRate,CD_SellRate,
	CD_Tot_Lot,CD_Tot_Res_Lot,CD_Exch_BuyRate,CD_Exch_SellRate,CD_Min_BrokAmt,
	CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt, CD_Tot_BuyQty, CD_Tot_SellQty,
	CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,CD_Tot_Sebi_Tax,CD_Tot_StampDuty
)FoSETtChrg

UPDATE 
	#Charges_Detail_Temp
SET
	CD_Tot_SellBrok=CD_Tot_Brok , CD_Tot_BuyBrok=0
WHERE
	CD_Tot_SellBrok > CD_Tot_BuyBrok
	AND CD_Tot_Brok <>  (CD_Tot_SellBrok+CD_Tot_BuyBrok)

UPDATE 
	#Charges_Detail_Temp
SET
	CD_Tot_BuyBrok=CD_Tot_Brok , CD_Tot_SellBrok=0
WHERE
	CD_Tot_BuyBrok >= CD_Tot_SellBrok 
	AND CD_Tot_Brok <>  (CD_Tot_SellBrok+CD_Tot_BuyBrok)

/*---------------------------------------------------------------------------------------------------------------
    Taking Data for Scrip Level + Contract Level Rounding
----------------------------------------------------------------------------------------------------------------*/

 /*Scrip Level Rounding*/
 INSERT INTO #Charges_Detail_Final
 SELECT 
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,
	CD_Trade_No='',
	CD_Order_No='',
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,CD_Expiry_Date,CD_AuctionPart,
	CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,
	CD_BuyRate = Case WHEN Sum(CD_Tot_BuyQty) >0 THEN Sum(CD_BuyRate*CD_Tot_BuyQty)/Sum(CD_Tot_BuyQty) ELSE 0 END,
	CD_SellRate = Case WHEN Sum(CD_Tot_SellQty) >0 THEN Sum(CD_SellRate*CD_Tot_SellQty)/Sum(CD_Tot_SellQty) ELSE 0 END,
	CD_Tot_BuyQty = Sum(CD_Tot_BuyQty),
	CD_Tot_SellQty = Sum(CD_Tot_SellQty),
	CD_Tot_BuyTurnOver = Sum(CD_Tot_BuyTurnOver),
	CD_Tot_SellTurnOver = Sum(CD_Tot_SellTurnOver),
	CD_Tot_BuyTurnOver_Rounded = Sum(CD_Tot_BuyTurnOver_Rounded),
	CD_Tot_SellTurnOver_Rounded = Sum(CD_Tot_SellTurnOver_Rounded),
	CD_Tot_TurnOver=sum(CD_Tot_TurnOver),
	CD_Tot_TurnOver_Rounded=Sum(CD_Tot_TurnOver_Rounded),
	CD_Tot_Lot=Sum(CD_Tot_Lot),
	CD_Tot_Res_TurnOver=Sum(CD_Tot_Res_TurnOver),
	CD_Tot_Res_TurnOver_Rounded=Sum(CD_Tot_Res_TurnOver_Rounded),
	CD_Tot_Res_Lot=Sum(CD_Tot_Res_Lot),
	CD_Tot_BuyBrok = Sum(CD_Tot_BuyBrok),
	CD_Tot_SellBrok =Sum(CD_Tot_SellBrok),
	CD_Tot_Brok = (Case WHEN Sum(CD_Tot_Brok) > 0 
				THEN (Case WHEN CD_Max_ScripAmt = - 1 
					THEN (Case WHEN CD_Min_ScripAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_ScripAmt,Sum(CD_Tot_Brok)) 
					ELSE Sum(CD_Tot_Brok)
					END)
				ELSE Pradnya.Dbo.fnMin(CD_Max_ScripAmt,
					(Case WHEN CD_Min_ScripAmt <> 0 
					THEN Pradnya.Dbo.fnMax(CD_Min_ScripAmt,Sum(CD_Tot_Brok)) 
					ELSE Sum(CD_Tot_Brok)
					END))
				END)
			ELSE 0 
			END),
	CD_Tot_SerTax=0,
	CD_Tot_Stt=Sum(CD_Tot_Stt),
	CD_Tot_Turn_Tax=Sum(CD_Tot_Turn_Tax),
	CD_Tot_Other_Chrg=Sum(CD_Tot_Other_Chrg),
	CD_Tot_Sebi_Tax=Sum(CD_Tot_Sebi_Tax),
	CD_Tot_StampDuty=Sum(CD_Tot_StampDuty),
	CD_Exch_BuyRate=Case WHEN Sum(CD_Tot_BuyQty) >0 THEN Sum(CD_Exch_BuyRate*CD_Tot_BuyQty) / Sum(CD_Tot_BuyQty) ELSE 0 END ,
	CD_Exch_SellRate =Case WHEN Sum(CD_Tot_SellQty) >0 THEN Sum(CD_Exch_SellRate*CD_Tot_SellQty) / Sum(CD_Tot_SellQty) ELSE 0 END ,
	0,0,CD_Min_ScripAmt,CD_Max_ScripAmt
 FROM 
	 #Charges_Detail_Temp
 WHERE
	 CD_ComputationLevel NOT IN ('C','S')
 Group By
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,
	Cd_Product_Type,Cd_Product_Code,Cd_Series_Code,Cd_Series_Id,CD_Expiry_Date,CD_AuctionPart,
	CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,
	CD_Min_ScripAmt,CD_Max_ScripAmt
 Having  
	Sum(CD_Tot_Brok) <> (Case WHEN Sum(CD_Tot_Brok) > 0 
				THEN (Case WHEN CD_Max_ScripAmt = - 1 
					THEN (Case WHEN CD_Min_ScripAmt <> 0 
						THEN Pradnya.Dbo.fnMax(CD_Min_ScripAmt,Sum(CD_Tot_Brok)) 
						ELSE Sum(CD_Tot_Brok)
						END)
					ELSE Pradnya.Dbo.fnMin(CD_Max_ScripAmt,
						(Case WHEN CD_Min_ScripAmt <> 0 
						THEN Pradnya.Dbo.fnMax(CD_Min_ScripAmt,Sum(CD_Tot_Brok)) 
						ELSE Sum(CD_Tot_Brok)
						END))
					END)
				ELSE 0 
				END)

UPDATE 
	#Charges_Detail_Final
SET
	CD_Tot_SellBrok=CD_Tot_Brok , CD_Tot_BuyBrok=0
WHERE
	CD_Tot_SellBrok > CD_Tot_BuyBrok

UPDATE 
	#Charges_Detail_Final
SET
	CD_Tot_BuyBrok=CD_Tot_Brok , CD_Tot_SellBrok=0
WHERE
	CD_Tot_BuyBrok >= CD_Tot_SellBrok 


Delete 
	#Charges_Detail_Temp 
FROM 
	#Charges_Detail_Final
WHERE
	Convert(Varchar,#Charges_Detail_Temp.CD_Sauda_Date,103) = Convert(Varchar,#Charges_Detail_Final.CD_Sauda_Date,103)
	AND #Charges_Detail_Temp.CD_Party_Code = #Charges_Detail_Final.CD_Party_Code
	AND #Charges_Detail_Temp.CD_Contract_No = #Charges_Detail_Final.CD_Contract_No
	AND #Charges_Detail_Temp.Cd_Product_Type = #Charges_Detail_Final.Cd_Product_Type
	AND #Charges_Detail_Temp.Cd_Product_Code = #Charges_Detail_Final.Cd_Product_Code
	AND #Charges_Detail_Temp.Cd_Series_Code = #Charges_Detail_Final.Cd_Series_Code
	AND #Charges_Detail_Temp.Cd_Series_Id = #Charges_Detail_Final.Cd_Series_Id
	AND convert(varchar,#Charges_Detail_Temp.CD_Expiry_Date,103) = Convert(varchar,#Charges_Detail_Final.CD_Expiry_Date,103)
	AND  #Charges_Detail_Temp.CD_AuctionPart = #Charges_Detail_Final.CD_AuctionPart


 INSERT INTO #Charges_Detail_Temp SELECT * FROM #Charges_Detail_Final


 /*Contract Level Rounding*/
 Truncate Table #Charges_Detail_Final

 INSERT INTO #Charges_Detail_Temp
 SELECT
	CD_Party_Code=F.Party_Code,
	CD_Sauda_Date=Left(Sauda_Date,11),
	CD_Contract_No=ContractNo,
	CD_Trade_No=Trade_No,
	CD_Order_No=Order_No,
	CD_Product_Type=Product_Type,
	Cd_Product_Code=Product_Code,
	CD_Series_Code=Series_Code,
	CD_Series_Id=Series_Id,
	CD_Expiry_Date=ExpiryDate,
	CD_AuctionPart=AuctionPart,
	CD_MarketLot=Convert(BigInt,BillNo),
	CD_Scheme_Id=0,
	CD_ComputationLevel='',
	CD_ComputationOn='',
	CD_ComputationType='',
	CD_BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
			ELSE 0 
			END),
	CD_SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
			ELSE 0 
			END),
	CD_Tot_BuyQty = Sum(Case WHEN Sell_Buy=1 THEN TradeQty ELSE 0 END),
	CD_Tot_SellQty = Sum(Case WHEN Sell_Buy=2 THEN TradeQty ELSE 0 END),
	CD_Tot_BuyTurnOver = Sum(Case WHEN Sell_Buy=1 THEN TradeQty*MarketRate ELSE 0 END),
	CD_Tot_SellTurnOver = Sum(Case WHEN Sell_Buy=2 THEN TradeQty*MarketRate ELSE 0 END),
	CD_Tot_BuyTurnOver_Rounded = Sum(Case WHEN Sell_Buy=1 THEN TradeQty*MarketRate ELSE 0 END),
	CD_Tot_SellTurnOver_Rounded = Sum(Case WHEN Sell_Buy=2 THEN TradeQty*MarketRate ELSE 0 END),
	CD_Tot_TurnOver=Sum(TradeQty*MarketRate),
	CD_Tot_TurnOver_Rounded=Sum(TradeQty*MarketRate),
	CD_Tot_Lot=0,
	CD_Tot_Res_TurnOver=0,
	CD_Tot_Res_TurnOver_Rounded=0,
	CD_Tot_Res_Lot=0,
	CD_Tot_BuyBrok =  Sum(Case WHEN Sell_buy=1 THEN TradeQty * BrokApplied ELSE 0 END ),
	CD_Tot_SellBrok = Sum(Case WHEN Sell_buy=1 THEN TradeQty * BrokApplied ELSE 0 END ),
	CD_Tot_Brok = Sum(TradeQty*BrokApplied),
	CD_Tot_SerTax=Sum(Service_Tax),
	CD_Tot_Stt=Sum(Ins_Chrg),
	CD_Tot_Turn_Tax=Sum(Turn_Tax),
	CD_Tot_Other_Chrg=Sum(F.Other_Chrg),
	CD_Tot_Sebi_Tax=Sum(Sebi_Tax),
	CD_Tot_StampDuty=Sum(Broker_Chrg),	
	CD_Exch_BuyRate = (Case WHEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 1 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 1 THEN TradeQty ELSE 0 END)
			ELSE 0 
			END),
	CD_Exch_SellRate = (Case WHEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END) > 0 
			THEN Sum(Case WHEN Sell_Buy = 2 THEN TradeQty*MarketRate ELSE 0 END) / 
				Sum(Case WHEN Sell_Buy = 2 THEN TradeQty ELSE 0 END)
			ELSE 0 
			END),
	0,0,0,0
 FROM
	BFoSettlement F
 WHERE 
	Sauda_Date BETWEEN @Sauda_Date_FROM AND @Sauda_Date_To + ' 23:59:59'
	AND F.Party_Code BETWEEN @Party_FROM AND @Party_To
	AND F.Party_Code In (SELECT CR_Party_Code FROM Contract_Rounding
	WHERE Sauda_Date BETWEEN CR_Date_FROM AND CR_Date_To)
	AND F.Party_Code NOT IN
	(
	SELECT F.Party_Code FROM #Charges_Detail_Temp
	WHERE    
		Convert(Varchar,CD_Sauda_Date,103) = Convert(Varchar,Sauda_Date,103) 
		AND Cd_Party_Code = F.Party_Code
		AND CD_Product_Type = Product_Type
		AND CD_Product_Code = Product_Code
		AND CD_Series_Code = Series_Code
		AND CD_Series_Id = Series_Id
		AND Convert(Varchar,CD_Expiry_Date,103) = Convert(Varchar,ExpiryDate,103)
		AND CD_AuctionPart = AuctionPart
	) 
 Group By
	Left(Sauda_Date,11),     
	F.Party_Code,
	Product_Type,
	Product_Code,
	Series_Code,
	Series_Id,
	ExpiryDate,
	AuctionPart,
	Contractno,
	Order_No,
	Trade_No,
	Convert(BigInt,BillNo)

 INSERT INTO #Charges_Detail_Final 
 SELECT
	CD_Party_Code,CD_Sauda_Date,
	CD_Contract_No=0,
	CD_Trade_No='',CD_Order_No='',
	CD_Product_Type='',
	CD_Product_Code= 'FUTOPT',
	CD_Series_Code='BROKERAGE',
	CD_Series_Id=0,
	CD_Expiry_Date='Dec 31 2049 23:59',
	CD_AuctionPart='0',CD_MarketLot=0,
	CD_Scheme_Id=0,CD_ComputationLevel='',CD_ComputationOn='',CD_ComputationType='',
	CD_BuyRate = 0,
	CD_SellRate = 0,
	CD_Tot_BuyQty = 0,
	CD_Tot_SellQty = 0,
	CD_Tot_BuyTurnOver = 0,
	CD_Tot_SellTurnOver = 0,
	CD_Tot_BuyTurnOver_Rounded = 0,
	CD_Tot_SellTurnOver_Rounded = 0,
	CD_Tot_TurnOver=0,
	CD_Tot_TurnOver_Rounded=0,
	CD_Tot_Lot=0,
	CD_Tot_Res_TurnOver=0,
	CD_Tot_Res_TurnOver_Rounded=0,
	CD_Tot_Res_Lot=0,
	CD_Tot_BuyBrok = 0,
	CD_Tot_SellBrok =0,
	CD_Tot_Brok = Case WHEN CR_Max_ContractAmt = - 1 
			THEN (Case WHEN CR_Min_ContractAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
				ELSE Sum(CD_Tot_Brok)
				END)
			ELSE Pradnya.Dbo.fnMin(CR_Max_ContractAmt,
				(Case WHEN CR_Min_ContractAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
				ELSE Sum(CD_Tot_Brok)
				END))
			END,
	CD_Tot_SerTax=0,
	CD_Tot_Stt=0,
	CD_Tot_Turn_Tax=0,
	CD_Tot_Other_Chrg=0,
	CD_Tot_Sebi_Tax=0,
	CD_Tot_StampDuty=0,
	CD_Exch_BuyRate=0 ,
	CD_Exch_SellRate =0,
	0,0,0,0
FROM
	#Charges_Detail_Temp  Left Outer Join Contract_Rounding 
	On (CR_Party_Code = CD_Party_Code 
		AND CD_Sauda_Date BETWEEN CR_Date_FROM AND CR_Date_To)  
Group By
	CD_Party_Code,CR_Min_ContractAmt,
	CR_Max_ContractAmt,CD_Sauda_Date
Having 
	Sum(CD_Tot_Brok) > Case WHEN CR_Max_ContractAmt = - 1 
		THEN (Case WHEN CR_Min_ContractAmt <> 0 
			THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
			ELSE Sum(CD_Tot_Brok)
			END)
		ELSE Pradnya.Dbo.fnMin(CR_Max_ContractAmt,
			(Case WHEN CR_Min_ContractAmt <> 0 
			THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
			ELSE Sum(CD_Tot_Brok)
			END))
		END 

UPDATE 
	#Charges_Detail_Temp SET CD_Tot_BuyBrok = 0, CD_Tot_SellBrok =0, CD_Tot_Brok = 0 
FROM 
	#Charges_Detail_Final
WHERE
	Convert(Varchar,#Charges_Detail_Temp.CD_Sauda_Date,103) = Convert(Varchar,#Charges_Detail_Final.CD_Sauda_Date,103)
	AND #Charges_Detail_Temp.CD_Party_Code = #Charges_Detail_Final.CD_Party_Code  

INSERT INTO #Charges_Detail_Final 
SELECT
	CD_Party_Code,CD_Sauda_Date,
	CD_Contract_No=0,
	CD_Trade_No='',CD_Order_No='',
	CD_Product_Type='',
	CD_Product_Code= 'FUTOPT',
	CD_Series_Code='BROKERAGE',
	CD_Series_Id=0,
	CD_Expiry_Date='Dec 31 2049 23:59',
	CD_AuctionPart='0',CD_MarketLot=0,
	CD_Scheme_Id=0,CD_ComputationLevel='',CD_ComputationOn='',CD_ComputationType='',
	CD_BuyRate = 0,
	CD_SellRate = 0,
	CD_Tot_BuyQty = 0,
	CD_Tot_SellQty = 0,
	CD_Tot_BuyTurnOver = 0,
	CD_Tot_SellTurnOver = 0,
	CD_Tot_BuyTurnOver_Rounded = 0,
	CD_Tot_SellTurnOver_Rounded = 0,
	CD_Tot_TurnOver=0,
	CD_Tot_TurnOver_Rounded=0,
	CD_Tot_Lot=0,
	CD_Tot_Res_TurnOver=0,
	CD_Tot_Res_TurnOver_Rounded=0,
	CD_Tot_Res_Lot=0,
	CD_Tot_BuyBrok =  Sum(CD_Tot_BuyBrok),
	CD_Tot_SellBrok = Sum(CD_Tot_SellBrok),
	CD_Tot_Brok = Case WHEN CR_Max_ContractAmt = - 1 
			THEN (Case WHEN CR_Min_ContractAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
				ELSE Sum(CD_Tot_Brok)
				END)
			ELSE Pradnya.Dbo.fnMin(CR_Max_ContractAmt,
				(Case WHEN CR_Min_ContractAmt <> 0 
				THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
				ELSE Sum(CD_Tot_Brok)
				END))
			END,
	CD_Tot_SerTax=0,
	CD_Tot_Stt=0,
	CD_Tot_Turn_Tax=0,
	CD_Tot_Other_Chrg=0,
	CD_Tot_Sebi_Tax=0,
	CD_Tot_StampDuty=0,
	CD_Exch_BuyRate=0 ,
	CD_Exch_SellRate =0,
	0,0,0,0
 FROM
	#Charges_Detail_Temp  Left Outer Join Contract_Rounding 
	On (CR_Party_Code = CD_Party_Code 
		AND CD_Sauda_Date BETWEEN CR_Date_FROM AND CR_Date_To)
		AND CD_Party_Code NOT IN (SELECT CD_Party_Code FROM #Charges_Detail_Final )
Group By   
	CD_Party_Code,CR_Min_ContractAmt,
	CR_Max_ContractAmt,CD_Sauda_Date
Having 
	Sum(CD_Tot_Brok) < Case WHEN CR_Max_ContractAmt = - 1 
		THEN (Case WHEN CR_Min_ContractAmt <> 0 
			THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
			ELSE Sum(CD_Tot_Brok)
			END)
		ELSE Pradnya.Dbo.fnMin(CR_Max_ContractAmt,
			(Case WHEN CR_Min_ContractAmt <> 0 
			THEN Pradnya.Dbo.fnMax(CR_Min_ContractAmt,Sum(CD_Tot_Brok))
			ELSE Sum(CD_Tot_Brok)
			END))
		END

UPDATE 
	#Charges_Detail_Final
SET
	CD_Tot_Brok = CD_Tot_Brok - (CD_Tot_SellBrok + CD_Tot_BuyBrok)

UPDATE 
	#Charges_Detail_Final
SET
	CD_Tot_SellBrok=CD_Tot_Brok , CD_Tot_BuyBrok=0
WHERE
	CD_Tot_SellBrok > CD_Tot_BuyBrok

UPDATE 
	#Charges_Detail_Final
SET
	CD_Tot_BuyBrok=CD_Tot_Brok , CD_Tot_SellBrok=0
WHERE
	CD_Tot_BuyBrok >= CD_Tot_SellBrok

 INSERT INTO #Charges_Detail_Temp SELECT * FROM #Charges_Detail_Final

 /*Final OutPut*/
DELETE FROM Charges_Detail 
WHERE
	CD_Sauda_Date >= @Sauda_Date_FROM  
	AND CD_Sauda_Date <= @Sauda_Date_To + ' 23:59:59'
	AND CD_Party_Code >= @Party_FROM
	AND CD_Party_Code <= @Party_To

INSERT INTO Charges_Detail 
SELECT 
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,CD_Product_Type,
	CD_Product_Code=  (Case WHEN CD_ComputationLevel <> 'C' THEN CD_Product_Code ELSE '' END),    
	CD_Series_Code,Cd_Series_Id,CD_Expiry_Date,CD_AuctionPart,
	CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,
	CD_BuyRate = Case WHEN Sum(CD_Tot_BuyQty) >0 THEN Sum(CD_BuyRate*CD_Tot_BuyQty)/Sum(CD_Tot_BuyQty) ELSE 0 END,
	CD_SellRate = Case WHEN Sum(CD_Tot_SellQty) >0 THEN Sum(CD_SellRate*CD_Tot_SellQty)/Sum(CD_Tot_SellQty) ELSE 0 END,
	CD_Tot_BuyQty = Sum(CD_Tot_BuyQty),
	CD_Tot_SellQty = Sum(CD_Tot_SellQty),
	CD_Tot_BuyTurnOver = Sum(CD_Tot_BuyTurnOver),
	CD_Tot_SellTurnOver = Sum(CD_Tot_SellTurnOver),
	CD_Tot_BuyTurnOver_Rounded = Sum(CD_Tot_BuyTurnOver_Rounded),
	CD_Tot_SellTurnOver_Rounded = Sum(CD_Tot_SellTurnOver_Rounded),
	CD_Tot_TurnOver=sum(CD_Tot_TurnOver),
	CD_Tot_TurnOver_Rounded=Sum(CD_Tot_TurnOver_Rounded),
	CD_Tot_Lot=Sum(CD_Tot_Lot),
	CD_Tot_Res_TurnOver=Sum(CD_Tot_Res_TurnOver),
	CD_Tot_Res_TurnOver_Rounded=Sum(CD_Tot_Res_TurnOver_Rounded),
	CD_Tot_Res_Lot=Sum(CD_Tot_Res_Lot),
	CD_Tot_BuyBrok =  Sum(CD_Tot_BuyBrok),
	CD_Tot_SellBrok = Sum(CD_Tot_SellBrok),
	CD_Tot_Brok = Sum(CD_Tot_Brok),
	CD_Tot_BuySerTax= Sum(CD_Tot_BuyBrok * Service_Tax/100 ),
	CD_Tot_SellSerTax= Sum(CD_Tot_SellBrok * Service_Tax/100 ),
	CD_Tot_SerTax= Sum(CD_Tot_Brok * Service_Tax/100 ),
	CD_Tot_Stt=Sum(CD_Tot_Stt),
	CD_Tot_Turn_Tax=Sum(CD_Tot_Turn_Tax),
	CD_Tot_Other_Chrg=Sum(CD_Tot_Other_Chrg),
	CD_Tot_Sebi_Tax=Sum(CD_Tot_Sebi_Tax),
	CD_Tot_StampDuty=Sum(CD_Tot_StampDuty),
	CD_Exch_BuyRate=Case WHEN Sum(CD_Tot_BuyQty) >0 THEN Sum(CD_Exch_BuyRate*CD_Tot_BuyQty) / Sum(CD_Tot_BuyQty) ELSE 0 END ,
	CD_Exch_SellRate =Case WHEN Sum(CD_Tot_SellQty) >0 THEN Sum(CD_Exch_SellRate*CD_Tot_SellQty) / Sum(CD_Tot_SellQty) ELSE 0 END ,
	GetDate()
FROM 
	#Charges_Detail_Temp , BFoGlobals
WHERE 
	CD_Sauda_Date BETWEEN Year_Start_Dt AND Year_END_Dt
Group By
	CD_Party_Code,CD_Sauda_Date,CD_Contract_No,CD_Trade_No,CD_Order_No,
	CD_Product_Type,
	(Case WHEN CD_ComputationLevel <> 'C' THEN CD_Product_Code ELSE '' END),    
	CD_Series_Code,CD_Series_Id,CD_Expiry_Date,CD_AuctionPart,
	CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,CD_ComputationType,
	CD_Min_ScripAmt,CD_Max_ScripAmt


/*---------------------------------------------------------------------------------------------------------------
   Cleaning Temporary Tables
----------------------------------------------------------------------------------------------------------------*/

Drop Table #Charges_Detail_Temp
Drop Table #Charges_Detail_Temp1
Drop Table #Charges_Detail_Final


/*---------------------------------------------------------------------------------------------------------------
   Keeping Dummy Contract Descriptor at the master
----------------------------------------------------------------------------------------------------------------*/
DECLARE @intCount BigInt,
	@intMaxCount int
SET @intCount = 0

SELECT @IntCount = Count(1) FROM BFoScrip2 WHERE Product_Code ='FUTOPT' AND Series_Code ='BROKERAGE'
	AND ExpiryDate LIKE  'Dec 31 2049%'

IF @intCount =0 
BEGIN

	INSERT INTO BFoScrip1 
	Select Top 1  ProductName,UnderlyingAsset,product_type,Product_Code='FUTOPT',Series_Code='BROKERAGE',
	series_id,scripmap_cd,reserved1,reserved2 
	From BfoScrip1

	INSERT INTO BFoScrip2 
	Select Top 1 product_type='',Product_Code='FUTOPT',Series_Code='BROKERAGE',
	Series_id,series_type,sec_name,Expirydate='Dec 31 2049 23:59',Maturitydate,OpeningDay,Lifetime,
	Isin_Code,Base_Price,Multiplier,marketsegment,marketlot,ceilingdepth,callput,optionstyle,
	strikeprice,nearseriesid,farseriesid,cor_act_level,reserved1,reserved2,reserved3,reserved4,reserved5
	From BfoScrip2


END

/*--------------------------------------------------------------------------------------------------------------
   Updating BFoSettlement Brok Appled & Service Chrg to zero for the given criteria
----------------------------------------------------------------------------------------------------------------*/

UPDATE 
	BFoSettlement
SET
	BrokApplied = 0,
	Service_Tax = 0
FROM
	Charges_Detail 
WHERE
	Convert(Varchar,CD_Sauda_Date,11) = Convert(Varchar,Sauda_Date,11)
	AND Cd_Party_Code = Party_Code
	AND CD_Product_Type = Product_Type
	AND CD_Product_Code = Product_Code
	AND CD_Series_Code = Series_Code
	AND CD_Series_Id = Series_Id
	AND Convert(Varchar,CD_Expiry_Date,103) = Convert(Varchar,ExpiryDate,103)
	AND CD_AuctionPart = AuctionPart
	AND Status <> 'E'
	AND Sauda_Date Between @Sauda_Date_FROM AND @Sauda_Date_To +' 23:59'
	AND Party_Code Between @Party_FROM AND @Party_To


UPDATE 
	BFoSettlement
SET
	BrokApplied = 0,
	Service_Tax = 0,
	NetRate = MarketRate
FROM
	Charges_Detail 
WHERE
	Convert(Varchar,CD_Sauda_Date,11) = Convert(Varchar,Sauda_Date,11)
	AND Cd_Party_Code = Party_Code
	AND Status <> 'E'
	AND Sauda_Date Between @Sauda_Date_FROM AND @Sauda_Date_To +' 23:59'
	AND Party_Code Between @Party_FROM AND @Party_To
	AND Cd_ComputationLevel ='C'
	AND BrokApplied <> 0
/*---------------------------------------------------------------------------------------------------------------
     END of Procedure
----------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_RECAL
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[PROC_TRADE_TRANSFER_RECAL] 
                @SAUDA_DATE   VARCHAR(11), 
                @PARTY_CODE   VARCHAR(10), 
                @PRODUCT_TYPE VARCHAR(6), 
                @PRODUCT_CODE VARCHAR(12), 
                @EXPIRY_DATE  VARCHAR(11), 
                @SERIESID     MONEY, 
                @SERIESCODE   VARCHAR(20) 
                 
AS 

  UPDATE BFOSETTLEMENT 
  SET    TABLE_NO = BROKTABLE.TABLE_NO, 
         LINE_NO = BROKTABLE.LINE_NO, 
         VAL_PERC = BROKTABLE.VAL_PERC, 
         NORMAL = BROKTABLE.NORMAL, 
         DAY_PUC = BROKTABLE.DAY_PUC, 
         DAY_SALES = BROKTABLE.DAY_SALES, 
         SETT_PURCH = BROKTABLE.SETT_PURCH, 
         SETT_SALES = BROKTABLE.SETT_SALES, 
         BROKAPPLIED = (CASE 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL *
						F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER))
						* POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO) 
						+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * F.MULTIPLIER * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * F.MULTIPLIER *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') 
						THEN ((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
					  ELSE 0 
					END), 
          
         NETRATE = (CASE 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.MARKETRATE) +
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.MARKETRATE) -
						((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + 
						FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) +
						((FLOOR(((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG 
						+ FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
						FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) + 
						((FLOOR(((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
						FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') THEN (BFOSETTLEMENT.MARKETRATE) - 
						((FLOOR(((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO)) 
                      ELSE 0 
                    END), 
         AMOUNT = (CASE 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'V' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 1) THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						AND BROKTABLE.VAL_PERC = 'P' 
						AND BFOSETTLEMENT.SELL_BUY = 2) THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY *
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 2 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 3 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE)) * 
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 4 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) + ((FLOOR(((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'V') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
						AND BROKTABLE.VAL_PERC = 'P') THEN BFOSETTLEMENT.TRADEQTY * 
						((BFOSETTLEMENT.MARKETRATE) - ((FLOOR(((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE)) *
						POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
						(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
						POWER(10,FOCLIENTTAXES.ROUND_TO))) 
                     ELSE 0 
                   END), 
         INS_CHRG = 0, 
         TURN_TAX = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX 
					ELSE OPT_TURNOVER_TAX 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         OTHER_CHRG = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG 
					ELSE OPT_OTHER_CHRG 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         SEBI_TAX = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX 
					ELSE OPT_SEBITURN_TAX 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         BROKER_CHRG = ((FLOOR((((CASE 
					WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE 
					ELSE OPT_BROKER_NOTE 
					END * (F.MARKETRATE) * BFOSETTLEMENT.TRADEQTY) / 100) * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         SERVICE_TAX = CASE 
					 WHEN CLIENT2.SERVICE_CHRG = 1 
						  AND CLIENT2.SERTAXMETHOD = 1 THEN 0 
					 ELSE (CASE 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
						   AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.NORMAL * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 1 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.NORMAL * F.MULTIPLIER / 100) * F.MPRICE) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_PUC * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 2 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_PUC * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.DAY_SALES * F.MULTIPLIER) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 3 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.DAY_SALES * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_PURCH * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) * 
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 4 
							AND BROKTABLE.VAL_PERC = 'P') THEN
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_PURCH * F.MULTIPLIER / 100) * F.MPRICE) *
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'V') THEN 
							((FLOOR(((((((FLOOR(((BROKTABLE.SETT_SALES * F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))) *
							BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
							FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 WHEN (BFOSETTLEMENT.SETTFLAG = 5 
							AND BROKTABLE.VAL_PERC = 'P') THEN 
							((FLOOR(((((((FLOOR((((BROKTABLE.SETT_SALES * F.MULTIPLIER / 100) * F.MPRICE) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
							POWER(10,FOCLIENTTAXES.ROUND_TO))) * BFOSETTLEMENT.TRADEQTY * BFOGLOBALS.SERVICE_TAX) / 100) * 
							POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
							(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
							POWER(10,FOCLIENTTAXES.ROUND_TO)) 
						 ELSE 0 
						 END) 
				   END, 
         TRADE_AMOUNT = BFOSETTLEMENT.TRADEQTY * BFOSETTLEMENT.MARKETRATE 
  FROM   BROKTABLE, 
         (SELECT SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                 F.TRADE_NO, 
                 F.PRODUCT_CODE, 
                 F.PRODUCT_TYPE, 
                 F.PARTY_CODE, 
                 F.SERIES_CODE, 
                 F.SERIES_ID, 
                 S2.EXPIRYDATE, 
                 F.USER_ID, 
                 F.SELL_BUY, 
                 F.TRADEQTY, 
                 F.MARKETRATE, 
                 F.CL_TYPE, 
                 F.OPPMEMCODE, 
                 F.OPPTRADERCODE, 
                 S2.STRIKEPRICE, 
                 F.SAUDA_DATE, 
                 F.ORDER_DATE, 
                 F.ORDER_NO, 
                 F.SETTFLAG, 
                 F.GROUPID, 
                 F.TRADERCODE, 
                 TRAN_CAT, 
                 OFF_PHONE1, 
                 MPRICE = (CASE 
                         WHEN C2.DUMMY1 = 0 THEN MARKETRATE 
                         ELSE (
							CASE 
                             WHEN C2.DUMMY1 = 1 THEN (
								CASE 
                                WHEN S2.STRIKEPRICE = 0 THEN F.MARKETRATE 
                                ELSE S2.STRIKEPRICE 
                                END) 
                             ELSE S2.STRIKEPRICE + MARKETRATE 
                           END) 
                       END), 
                 MULTIPLIER = 1, 
                 MARKETLOT 
          FROM   BFOSETTLEMENT F, 
                 CLIENT2 C2, 
                 BFOSCRIP2 S2, 
                 CLIENT1 C1 
          WHERE  C2.PARTY_CODE = F.PARTY_CODE 
                 AND C1.CL_CODE = C2.CL_CODE 
                 AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE 
                 AND F.PRODUCT_CODE = S2.PRODUCT_CODE 
                 AND F.SERIES_CODE = S2.SERIES_CODE 
                 AND F.SERIES_ID = S2.SERIES_ID 
                                    
                 AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
                 AND F.STATUS <> 'E' 
                 AND F.PARTY_CODE LIKE @PARTY_CODE 
                 AND F.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
                 AND F.PRODUCT_CODE LIKE @PRODUCT_CODE 
                 AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                 AND F.SERIES_ID = (CASE 
                                      WHEN @SERIESID = 0 THEN F.SERIES_ID 
                                      ELSE @SERIESID 
                                    END) 
                 AND F.SERIES_CODE LIKE @SERIESCODE) F, 
         BFOGLOBALS, 
         CLIENT1, 
         CLIENT2, 
    (SELECT   SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), 
                   T1.PARTY_CODE, 
                   T1.PRODUCT_TYPE, 
                   T1.PRODUCT_CODE, 
                   T1.SERIES_CODE, 
                   T1.SERIES_ID, 
                   PQTY = SUM(CASE 
                                WHEN SELL_BUY = 1 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   SQTY = SUM(CASE 
                                WHEN SELL_BUY = 2 THEN TRADEQTY 
                                ELSE 0 
                              END), 
                   STRIKEPRICE = ISNULL((SELECT DISTINCT BS.STRIKEPRICE 
                                         FROM   BFOSCRIP2 BS 
                                         WHERE  BS.PRODUCT_CODE = T1.PRODUCT_CODE 
                                                AND BS.PRODUCT_TYPE = T1.PRODUCT_TYPE 
                                                AND BS.SERIES_CODE = T1.SERIES_CODE 
                                                AND BS.SERIES_ID = T1.SERIES_ID), 
                                        0), 
                   PRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 1 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 1 THEN TRADEQTY * MARKETRATE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 1 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END), 
                   SRATE = (CASE 
                              WHEN SUM(CASE 
                                         WHEN SELL_BUY = 2 THEN TRADEQTY 
                                         ELSE 0 
                                       END) > 0 THEN SUM(CASE 
                                                           WHEN SELL_BUY = 2 THEN TRADEQTY * MARKETRATE 
                                                           ELSE 0 
                                                         END) / SUM(CASE 
                                                                      WHEN SELL_BUY = 2 THEN TRADEQTY 
                                                                      ELSE 0 
                                                                    END) 
                              ELSE 0 
                            END) 
          FROM     BFOSETTLEMENT T1 
          WHERE    T1.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
                   AND T1.STATUS <> 'E' 
                   AND T1.PARTY_CODE LIKE @PARTY_CODE 
                   AND T1.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
                   AND T1.PRODUCT_CODE LIKE @PRODUCT_CODE 
                   AND T1.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
                   AND T1.SERIES_ID = (CASE 
                                         WHEN @SERIESID = 0 THEN T1.SERIES_ID 
                                         ELSE @SERIESID 
                                       END) 
                   AND T1.SERIES_CODE LIKE @SERIESCODE 
          GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),T1.PARTY_CODE,T1.PRODUCT_TYPE,T1.PRODUCT_CODE, 
                   T1.SERIES_CODE,T1.SERIES_ID) S, 
         FOCLIENTTAXES, 
         FOCLIENTBROKSCHEME 
  WHERE  BFOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
         AND BFOSETTLEMENT.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO 
         AND 
          
          F.PARTY_CODE = CLIENT2.PARTY_CODE 
         AND CLIENT1.CL_CODE = CLIENT2.CL_CODE 
         AND F.PARTY_CODE = S.PARTY_CODE 
         AND F.PRODUCT_TYPE = S.PRODUCT_TYPE 
         AND F.PRODUCT_CODE = S.PRODUCT_CODE 
         AND F.SERIES_CODE = S.SERIES_CODE 
         AND F.SERIES_ID = S.SERIES_ID 
         AND BROKTABLE.TABLE_NO = (CASE 
                                     WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                     ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                   END) 
         AND BROKTABLE.LINE_NO = (CASE 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 1 
		                            OR FOCLIENTBROKSCHEME.BROK_SCHEME = 5) THEN 
									(SELECT MIN(BROKTABLE.LINE_NO) 
									FROM   BROKTABLE 
									WHERE  BROKTABLE.TABLE_NO = (CASE 
									WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE -- F.STD_RATE       
									ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
									END) 
									AND TRD_DEL = (CASE 
													WHEN S.PQTY >= S.SQTY THEN (CASE 
														  WHEN (F.SELL_BUY = 1) THEN 'F' 
														  ELSE 'S' 
														END) 
													ELSE (CASE 
															WHEN (F.SELL_BUY = 2) THEN 'F' 
															ELSE 'S' 
														  END) 
												  END) 
									AND F.PARTY_CODE = S.PARTY_CODE 
                                                   AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN (FOCLIENTBROKSCHEME.BROK_SCHEME = 3 
                                           OR FOCLIENTBROKSCHEME.BROK_SCHEME = 6) THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
										WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
										ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
										END) 
										AND TRD_DEL = (CASE 
										WHEN S.PQTY > S.SQTY THEN (CASE 
													 WHEN (F.SELL_BUY = 1) THEN 'F' 
													 ELSE 'S' 
												   END) 
										ELSE (CASE 
										WHEN (F.SELL_BUY = 2) THEN 'F' 
										ELSE 'S' 
										END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN FOCLIENTBROKSCHEME.BROK_SCHEME = 2 THEN 
										(SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = (CASE 
											 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE 
											 ELSE OPT_BROKTABLE 
										   END)-- F.STD_RATE                                                         
										AND TRD_DEL = (CASE 
										WHEN S.PQTY = S.SQTY THEN (CASE 
										   WHEN S.PRATE >= S.SRATE THEN (CASE 
													   WHEN (F.SELL_BUY = 1) THEN 'F' 
													   ELSE 'S' 
													 END) 
										   ELSE (CASE 
												   WHEN (F.SELL_BUY = 2) THEN 'F' 
												   ELSE 'S' 
												 END) 
										 END) 
										ELSE (CASE 
											  WHEN S.PQTY >= S.SQTY THEN (
													CASE 
													WHEN (F.SELL_BUY = 1) THEN 'F' 
													ELSE 'S' 
												  END) 
											  ELSE (CASE 
													  WHEN (F.SELL_BUY = 2) THEN 'F' 
													  ELSE 'S' 
													END) 
											END) 
										END) 
										AND F.PARTY_CODE = S.PARTY_CODE 
										AND F.MARKETRATE <= BROKTABLE.UPPER_LIM) 
                                    ELSE (SELECT MIN(LINE_NO) 
                                          FROM   BROKTABLE 
                                          WHERE  F.MPRICE <= BROKTABLE.UPPER_LIM 
                                                 AND BROKTABLE.TABLE_NO = (
												CASE 
                                                 WHEN RIGHT(F.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE --F.STD_RATE       
                                                 ELSE OPT_BROKTABLE --F.BROK2_TABLENO       
                                               END)) 
                              END) 
         AND BFOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE F.SDATE + '%' 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE S.SDATE + '%' 
         AND BFOSETTLEMENT.TRADE_NO = F.TRADE_NO 
         AND BFOSETTLEMENT.ORDER_NO = F.ORDER_NO 
         AND BFOSETTLEMENT.SELL_BUY = F.SELL_BUY 
         AND BFOSETTLEMENT.PARTY_CODE = F.PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE = F.PRODUCT_TYPE 
         AND BFOSETTLEMENT.PRODUCT_CODE = F.PRODUCT_CODE 
         AND BFOSETTLEMENT.SERIES_ID = F.SERIES_ID 
         AND BFOSETTLEMENT.SERIES_CODE = F.SERIES_CODE 
         AND BFOSETTLEMENT.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
         AND BFOSETTLEMENT.STATUS <> 'E' 
         AND BFOSETTLEMENT.PARTY_CODE LIKE @PARTY_CODE 
         AND BFOSETTLEMENT.PRODUCT_TYPE LIKE @PRODUCT_TYPE 
         AND BFOSETTLEMENT.PRODUCT_CODE LIKE @PRODUCT_CODE 
         AND BFOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%' 
         AND BFOSETTLEMENT.SERIES_ID = (CASE 
                                          WHEN @SERIESID = 0 THEN F.SERIES_ID 
                                          ELSE @SERIESID 
                                        END) 
         AND BFOSETTLEMENT.SERIES_CODE LIKE @SERIESCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_Trade_Transfer_Setl
-- --------------------------------------------------

CREATE proc [dbo].[Proc_Trade_Transfer_Setl] 
(
	@Sauda_Date      Varchar(11),
	@PartyFrom       Varchar(10), 
	@PartyTo         Varchar(10),
	@product_type    Varchar(6) ,
	@product_code    Varchar(12),
	@SeriesCode  	 Varchar(20)      ,
	@Expiry_Date     Varchar(11),
	@Sell_Buy   	 Int        ,
	@ParticipantCode Varchar(15), 
	@ContractNo      Varchar(7) , 
	@Order_No	 Varchar(16),
	@Trade_No        Varchar(14),
	@ActualQty       Int        ,
	@QtyToTransfer   Int        
) As

Declare 
	@TradeCursor     Cursor     ,
	@ContractNoCur   Cursor     ,
	@QtyInTrade      Int        ,
	@New_Trade_No    Varchar(14),
	@New_ContractNo  Varchar(7) ,
	@BillNo		 int        ,
	@Style           Int

Select @New_ContractNo = 0 
Set @ContractNoCur = Cursor For
Select ContractNo From BFoSettlement 
Where Sauda_Date Like @Sauda_Date + '%'
And Party_Code = @PartyTo And Reserved1 = 0 
Open @ContractNoCur
Fetch Next From @ContractNoCur into @New_ContractNo
Close @ContractNoCur
DeAllocate @ContractNoCur
If @@Fetch_Status <> 0 
Begin
	Select @New_ContractNo = Convert(Int,Contractno) + 1  From ContGen 
                Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date
	Update ContGen Set Contractno = @New_ContractNo 
                Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date
	Select @New_ContractNo = STUFF('0000000', 8 - Len(@New_ContractNo), Len(@New_ContractNo), @New_ContractNo)		
End
Select @BillNo = 0 
If @ActualQty = @QtyToTransfer 
Begin
	Insert Into BFoSettlement 
	Select @New_ContractNo,@BillNo,Left('R'+Trade_no,14),@PartyTo,product_type,product_code,Series_code,Series_id,expirydate,multiplier,User_id,Tradeqty,
	AuctionPart,MarketType,Series,Order_no,MarketRate,strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,
	Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,
	NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_rate,GroupId,TraderCode,reserved1,reserved2,reserved3,reserved4,
	reserved5,status,branch_cd,pro_cli,participantcode,cpid,instrument,booktype,branch_id,scheme,tmark,dummy1,dummy2
	From BFoSettlement 
	Where Sauda_Date Like @Sauda_Date + '%'
        And Party_Code = @PartyFrom
        And product_type = @product_type
        And product_code = @product_code
        And ExpiryDate Like @Expiry_Date + '%'
        And Series_Code = @SeriesCode
	And Reserved1 = 0 
        And Sell_Buy = @Sell_Buy
        And ParticipantCode = @ParticipantCode
        And ContractNo = @ContractNo
        And Order_No Like @Order_No
        And Trade_No Like @Trade_No
	Update BFoSettlement Set TradeQty = 0, marketrate = 0, NetRate = 0, Brokapplied = 0, 
	NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,
	Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0 
	Where Sauda_Date Like @Sauda_Date + '%'
        And Party_Code = @PartyFrom
        And product_type = @product_type
        And product_code = @product_code
        And ExpiryDate Like @Expiry_Date + '%'
        And Series_Code = @SeriesCode
	And Reserved1 = 0 
        And Sell_Buy = @Sell_Buy
        And ParticipantCode = @ParticipantCode
        And ContractNo = @ContractNo
        And Order_No Like @Order_No
        And Trade_No Like @Trade_No
End
Else
Begin
        Set @TradeCursor = Cursor For
        Select TradeQty, Trade_No From BFoSettlement
        Where Sauda_Date Like @Sauda_Date + '%'
        And Party_Code = @PartyFrom
        And product_type = @product_type
        And product_code = @product_code
        And ExpiryDate Like @Expiry_Date + '%'
        And Series_Code = @SeriesCode
	And Reserved1 = 0 
        And Sell_Buy = @Sell_Buy
        And ParticipantCode = @ParticipantCode
        And ContractNo = @ContractNo
        And Order_No Like @Order_No
        And Trade_No Like @Trade_No
	Order By TradeQty Desc 
        Open @TradeCursor 
        Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No
	While @@Fetch_Status = 0 And @QtyToTransfer > 0 
	Begin
		If @QtyToTransfer >= @QtyInTrade
		Begin
			Insert Into BFoSettlement 
			Select @New_ContractNo,@BillNo,Left('R'+Trade_no,14),@PartyTo,product_type,product_code,Series_code,Series_id,expirydate,multiplier,User_id,Tradeqty,
			AuctionPart,MarketType,Series,Order_no,MarketRate,strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,
			Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,
			NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_rate,GroupId,TraderCode,reserved1,reserved2,reserved3,reserved4,
			reserved5,status,branch_cd,pro_cli,participantcode,cpid,instrument,booktype,branch_id,scheme,tmark,dummy1,dummy2
			From BFoSettlement 
			Where Sauda_Date Like @Sauda_Date + '%'
		        And Party_Code = @PartyFrom
		        And product_type = @product_type
		        And product_code = @product_code
		        And ExpiryDate Like @Expiry_Date + '%'
		        And Series_Code = @SeriesCode
			And Reserved1 = 0 
		        And Sell_Buy = @Sell_Buy
		        And ParticipantCode = @ParticipantCode
		        And ContractNo = @ContractNo
		        And Order_No Like @Order_No
		        And Trade_No Like @New_Trade_No
			And TradeQty = @QtyInTrade
			Update BFoSettlement Set TradeQty = 0, marketrate = 0, NetRate = 0, Brokapplied = 0, 
			NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,
			Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0 
			Where Sauda_Date Like @Sauda_Date + '%'
		        And Party_Code = @PartyFrom
		        And product_type = @product_type
		        And product_code = @product_code
		        And ExpiryDate Like @Expiry_Date + '%'
		        And Series_Code = @SeriesCode
			And Reserved1 = 0 
		        And Sell_Buy = @Sell_Buy
	        	And ParticipantCode = @ParticipantCode
		        And ContractNo = @ContractNo
	        	And Order_No Like @Order_No
		        And Trade_No Like @New_Trade_No
			And TradeQty = @QtyInTrade
			Select @QtyToTransfer = @QtyToTransfer - @QtyInTrade
		End
		Else
		Begin
			Insert Into BFoSettlement 
			Select @New_ContractNo,@BillNo,Left('R'+Trade_no,14),@PartyTo,product_type,product_code,Series_code,Series_id,expirydate,multiplier,User_id,Tradeqty,
			AuctionPart,MarketType,Series,Order_no,MarketRate,strike_price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,
			Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,
			NSerTax,N_NetRate,sett_type,Cl_type,Order_Date,OppMemCode,OppTraderCode,Cl_rate,GroupId,TraderCode,reserved1,reserved2,reserved3,reserved4,
			reserved5,status,branch_cd,pro_cli,participantcode,cpid,instrument,booktype,branch_id,scheme,tmark,dummy1,dummy2
			From BFoSettlement 
			Where Sauda_Date Like @Sauda_Date + '%'
		        And Party_Code = @PartyFrom
		        And product_type = @product_type
		        And product_code = @product_code
		        And ExpiryDate Like @Expiry_Date + '%'
		        And Series_Code = @SeriesCode
			And Reserved1 = 0 
		        And Sell_Buy = @Sell_Buy
		        And ParticipantCode = @ParticipantCode
		        And ContractNo = @ContractNo
		        And Order_No Like @Order_No
		        And Trade_No Like @New_Trade_No
			And TradeQty = @QtyInTrade
			Update BFoSettlement Set TradeQty = TradeQty - @QtyToTransfer, Amount = (TradeQty - @QtyToTransfer)*marketrate
			Where Sauda_Date Like @Sauda_Date + '%'
		        And Party_Code = @PartyFrom
		        And product_type = @product_type
		        And product_code = @product_code
		        And ExpiryDate Like @Expiry_Date + '%'
		        And Series_Code = @SeriesCode
			And Reserved1 = 0 
		        And Sell_Buy = @Sell_Buy
		        And ParticipantCode = @ParticipantCode
		        And ContractNo = @ContractNo
		        And Order_No Like @Order_No
		        And Trade_No Like @New_Trade_No
			Select @QtyToTransfer = 0
		End
	        Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No	
	End
	Close @TradeCursor
	DeAllocate @TradeCursor
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ReCalcBrok
-- --------------------------------------------------



CREATE  Proc  ReCalcBrok 
(
	@sauda_date 	VARCHAR (11),
	@Partycode  	varchar(12)
)
As    


if @Partycode=''
	begin
		set @Partycode = '%'
	end

Exec PROC_TRADE_TRANSFER_RECAL  @sauda_date,@Partycode,'%','%','%',0,'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger
-- --------------------------------------------------









CREATE    Procedure Rpt_acc_partyledger      
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Fcode Varchar(10),      
	@Tcode Varchar(10),      
	@Strorder Varchar(6),      
	@Selectby Varchar(3),      
	@Statusid Varchar(15),      
	@Statusname Varchar(15),      
	@Strbranch Varchar(10)      
)

As      
      
/*========================================================================
      Exec rpt_acc_partyledger_all 
            'Nov  1 2005',
            'Dec 31 2005',
            'a',
            'zzz',
            'ACCODE',
            'vdt',
            'broker',
            'undefined',
            ''
========================================================================*/

Declare 
	@@Opendate   As Varchar(11)      
      
Set Transaction Isolation Level Read Uncommitted      
      
      
/*getting Last Opening Date */      
      If Upper(@Selectby) = 'Vdt'      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Vdt < = @Fdate 
                  ) 
      End      
      Else      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Edt < = @Fdate 
                  ) 
      End      
            
      
      /*creating Blank Table For Opening Balance*/      
            SELECT 
                  Cltcode, 
                  Oppbal = Vamt 
            INTO #oppbalance 
            FROM Ledger WITH(NoLock) 
            WHERE 1 = 2 
            
      
      /*getting Opening Balance*/      
      If @Selectby = 'Vdt'      
      Begin      
            If @@Opendate = @Fdate       
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt Like @Fdate + '%' 
                        AND Vtyp = 18 
                  GROUP BY Cltcode 
            End      
            Else      
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt > = @@Opendate + ' 00:00:00' 
                        AND Vdt < @Fdate 
                  GROUP BY Cltcode 
            End      
      End       
      Else      
      Begin       
            If @@Opendate = @Fdate       
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
        Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
                                          ELSE -b.Vamt 
                                    END
                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
            Else    
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt > = @@Opendate + ' 00:00:00' 
                                    AND Edt < @Fdate 
                                    AND Vtyp <> 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
      ELSE -b.Vamt 
                                    END
                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate 
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
      End      
            
      
      /*generating Blank Structure For Filtered Ledger */      
            SELECT 
                  L.*, 
                  Shortdesc = Space(35) 
            INTO #ledgerdata 
            FROM Ledger L WITH(NoLock) 
            WHERE 1 = 2 
            
      
      
      /*getting Fiiltered Ledger*/      
      If @Selectby = 'Vdt'      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Vdt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Vdt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End       
      Else      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Edt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Edt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End      
      


/*getting Client List*/      
      SELECT 
            C2.Party_code, 
            Bank_name = Isnull(C4.Bankid, ''), 
            L_address1, 
            L_address2, 
            L_address3, 
            L_city, 
            L_zip, 
            Res_phone1, 
            C1.Branch_cd, 
            Family, 
            C1.Sub_broker, 
            Trader, 
            Cl_type, 
            Cltdpid = Isnull(Cltdpid, '') 
      INTO #ledgerclients 
      FROM bsefo.Dbo.Client1 C1 WITH(NoLock), 
            bsefo.Dbo.Client2 C2 WITH(NoLock) 
      LEFT OUTER JOIN 
            bsefo.Dbo.Client4 C4 WITH(NoLock) 
            ON 
            (
                  C2.Party_code = C4.Party_code 
                  AND Depository Not In ('Nsdl', 'Cdsl') 
                  AND Defdp = 1
            ) 
      WHERE C1.Cl_code = C2.Cl_code 
            AND C1.Branch_cd Like (
            CASE 
                  WHEN @Statusid = 'Branch' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Sub_broker Like (
            CASE 
                  WHEN @Statusid = 'Sub_broker' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
	    AND Sub_broker Like (
            CASE 
                  WHEN @Statusid = 'Subbroker' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Trader Like (
            CASE 
                  WHEN @Statusid = 'Trader' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Family Like (
            CASE 
                  WHEN @Statusid = 'Family' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C2.Party_code Like (
            CASE 
                  WHEN @Statusid = 'Client' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Branch_cd Like @Strbranch +'%' 
            AND C2.Party_code > = @Fcode 
            AND C2.Party_code < = @Tcode 


      CREATE TABLE [#tmpledger] (
      	[Booktype] [char] (2)  NULL ,
      	[Voudt] [datetime] NULL ,
      	[Effdt] [datetime] NULL ,
      	[Shortdesc] [varchar] (35)  NULL ,
      	[Dramt] [money] NULL ,
      	[Cramt] [money] NULL ,
      	[Vno] [varchar] (12)  NULL ,
      	[Ddno] [varchar] (15)  NULL ,
      	[Narration] [varchar] (234)  NULL ,
      	[Cltcode] [varchar] (10)  NOT NULL ,
      	[Vtyp] [smallint] NULL ,
      	[Vdt] [varchar] (30)  NULL ,
      	[Edt] [varchar] (30)  NULL ,
      	[Acname] [varchar] (100)  NULL ,
      	[Opbal] [money] NULL ,
      	[L_address1] [varchar] (40)  NOT NULL ,
      	[L_address2] [varchar] (40)  NULL ,
      	[L_address3] [varchar] (40)  NULL ,
      	[L_city] [varchar] (40)  NULL ,
      	[L_zip] [varchar] (10)  NULL ,
      	[Res_phone1] [varchar] (15)  NULL ,
      	[Branch_cd] [varchar] (10)  NOT NULL ,
      	[Crosac] [varchar] (10)  NULL ,
      	[Ediff] [int] NULL ,
      	[Family] [varchar] (10)  NOT NULL ,
      	[Sub_broker] [varchar] (10)  NOT NULL ,
      	[Trader] [varchar] (20)  NOT NULL ,
      	[Cl_type] [varchar] (3)  NOT NULL ,
      	[Bank_name] [varchar] (16)  NOT NULL ,
      	[Cltdpid] [varchar] (16)  NOT NULL ,
      	[Lno] [int] NULL 
      ) ON [PRIMARY]

      
/*getting Lddger Entries*/      
      INSERT 
            INTO #tmpledger 
      SELECT 
            L.Booktype, 
            Voudt = L.Vdt, 
            Effdt = L.Edt, 
            L.Shortdesc, 
            Dramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'D' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            Cramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'C' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            L.Vno, 
            Ddno = Space(15), 
            L.Narration, 
            C.Party_code Cltcode, 
            L.Vtyp, 
            Convert(Varchar, L.Vdt, 103) Vdt, 
            Convert(Varchar, L.Edt, 103) Edt, 
            L.Acname , 
            Opbal = Vamt, 
            C.L_address1, 
            C.L_address2, 
            C.L_address3, 
            C.L_city, 
            C.L_zip, 
            C.Res_phone1, 
            C.Branch_cd, 
            L.Cltcode Crosac , 
            Ediff = Datediff(D, L.Edt, Getdate()), 
            C.Family, 
            C.Sub_broker, 
            C.Trader, 
            C.Cl_type, 
            C.Bank_name, 
            C.Cltdpid, 
            L.Lno 
      FROM #ledgerdata L WITH(NoLock) 
      RIGHT OUTER JOIN 
            #ledgerclients C WITH(NoLock) 
            ON 
            (
                  L.Cltcode = C.Party_code
            ) 


      
/*updating Opening Blanace*/      
      UPDATE 
            #tmpledger 
            SET Opbal = 0 

      UPDATE 
            #tmpledger 
            SET Opbal = T.Oppbal 
      FROM #tmpledger L WITH(NoLock), 
            #oppbalance T WITH(NoLock) 
      WHERE L.Cltcode = T.Cltcode 
      


/*updating Cheque Number*/      
      UPDATE 
            #tmpledger 
            SET Ddno = L1.Ddno 
      FROM Ledger1 L1 WITH(NoLock) 
      WHERE L1.Vno = #tmpledger.Vno 
            AND L1.Vtyp = #tmpledger.Vtyp 
            AND L1.Booktype = #tmpledger.Booktype 
            AND L1.Lno = #tmpledger.Lno 
      


/*updating Cross Account Code*/      
      UPDATE 
            #tmpledger 
            SET #tmpledger.Crosac = B.Cltcode 
      FROM Ledger B WITH(NoLock), 
            Acmast V WITH(NoLock) 
      WHERE B.Cltcode = V.Cltcode 
            AND V.Accat = 2 
            AND #tmpledger.Booktype = B.Booktype 
            AND #tmpledger.Vno = B.Vno 
            AND #tmpledger.Vtyp = B.Vtyp 
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23') 
      


/*updating Bank Name*/                     
      UPDATE 
            #tmpledger 
            SET #tmpledger.Bank_name = B.Bank_name 
      FROM bsefo.Dbo.Pobank B WITH(NoLock) 
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name)) 

      
      If @Strorder = 'Accode'      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
				AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
                  ORDER BY L.Cltcode, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Cltcode, 
                        Effdt 
            End      
      End      
      Else      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Effdt 
            End      
      End      
      
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accallpartyledvoucherdisp
-- --------------------------------------------------

/* Report : Allpartyledger           
    Filename :  Voucherdisp.Asp          
*/          
/* Displays Details Of A Voucher For A Party For A Date */          
--exec Rpt_accallpartyledvoucherdisp '3', '200400001901', 'May  5 2004', '41', '', '10100063'        
CREATE Procedure Rpt_accallpartyledvoucherdisp          
@Vtyp Smallint ,          
@Vno Varchar (12),          
@Vdt Varchar(12) ,          
@Booktype Varchar(2),          
@Branch Varchar(10),          
@Cltcode Varchar(10)          
          
As          
If @Branch = 'Full' Or @Branch = '' Or @Branch = '%'          
Begin          
 Select  Vamt , L.Vtyp , L.Vno , L.Vdt , L.Drcr , Cltcode, Acname,  L.Lno , Drcrflag = (Case When Upper(L.Drcr) = 'D' Then 'Dr' Else 'Cr' End) ,           
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,           
 Dddt  =  Convert(Varchar, Dddt, 103)            
 From Accountbfo.Dbo.Ledger L Left Outer Join Accountbfo.Dbo.Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno       
--and L.Lno = L1.Lno          
 Where L.Vtyp = @Vtyp          
 And L.Vno = @Vno            
 And L.Vdt Like  Ltrim(Vdt) + '%'          
 And L.Booktype = @Booktype --and L.Cltcode = @Cltcode          
 Order By L.Drcr Desc , L.Lno           
End          
Else          
Begin          
 Select  Vamt = L2.Camt , L.Vtyp , L2.Vno , Vdt , L2.Drcr , L2.Cltcode, A.Acname, L2.Lno ,           
 Drcrflag = (Case When Upper(L2.Drcr) = 'D' Then 'Dr' Else 'Cr' End),           
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,           
 Dddt  =  Convert(Varchar, Dddt, 103)            
 From Accountbfo.Dbo.Ledger L Left Outer Join Accountbfo.Dbo.Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno,       
--and L.Lno = L1.Lno,          
 Accountbfo.Dbo.Ledger2 L2 Left Outer Join Accountbfo.Dbo.Acmast A On L2.Cltcode = A.Cltcode          
 Where L.Vtyp = @Vtyp          
 And L.Vno = @Vno            
 And L.Vdt Like  Ltrim(Vdt) + '%'          
 And L.Booktype = @Booktype and L.Cltcode = @Cltcode          
 And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype And L.Vno = L2.Vno And L.Lno = L2.Lno          
        And Costcode = (Select Costcode From Accountbfo.Dbo.Costmast Where Costname = Rtrim(@Branch))          
 Order By L2.Drcr Desc , L2.Lno           
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acccompanyname
-- --------------------------------------------------

Create Proc Rpt_acccompanyname
@Sharedb Varchar(15)
As
Select Companyname From Pradnya.dbo.Multicompany Where Sharedb = @Sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accpandl
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 01/15/2005 1:26:21 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 12/16/2003 2:31:41 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 06/26/2002 6:15:44 Pm ******/  
/* Ch By Mousami On 15 Apr 2002   
     Added Branch Login Effect */  
  
  
Create  Procedure  Rpt_accpandl  
  
@fromdt Varchar(11),  
@todt Varchar(11),  
@statusid Varchar(15),  
@statusname Varchar(25)  
  
  
As  
  
If @statusid='broker'  
Begin  
 Select G1.grpname,g1.grpcode,   
 Vamt=isnull(( Select Sum(case When Drcr ='c' Then Vamt*-1 Else Vamt End )from AccountBfo.dbo.ledger L ,AccountBfo.dbo.AcMast A ,AccountBfo.dbo.grpmast G   
       Where L.cltcode = A.cltcode And G.grpcode =g1.grpcode And L.vdt >= @fromdt + ' 00:00:00'  
       And L.vdt <=@todt + ' 23:59:59' And Substring(a.grpcode,1,1) = Substring(g.grpcode,1,1)),0)   
 From AccountBfo.dbo.grpmast G1   
 Where G1.grpcode='n0000000000' Or  G1.grpcode='x0000000000'   
 Order By G1.grpcode  
End  
Else  
Begin  
 Select G1.grpname,g1.grpcode,   
 Vamt=isnull(( Select Sum(case When L.drcr ='c' Then Vamt*-1 Else Vamt End )from  
  AccountBfo.dbo.ledger L ,AccountBfo.dbo.AcMast A ,AccountBfo.dbo.grpmast G ,  AccountBfo.dbo.ledger2_Report L2 ,  AccountBfo.dbo.costmast C , AccountBfo.dbo.category C1  
   Where L.cltcode = A.cltcode And G.grpcode =g1.grpcode And L.vdt >= @fromdt + ' 00:00:00'  
     And L.vdt <=@todt  + ' 23:59:59'   
     And L.vno=l2.vno And L.vtyp=l2.vtype And L.lno=l2.lno And L.drcr=l2.drcr  
 And C.costcode=l2.costcode  
 And C.catcode=c1.catcode  
 And L.booktype=l2.booktype  
 And C1.category='branch'  
    And C.costname=@statusname  
  And Substring(a.grpcode,1,1) = Substring(g.grpcode,1,1)),0)   
  From AccountBfo.dbo.grpmast G1   
  Where G1.grpcode='n0000000000' Or  G1.grpcode='x0000000000'   
  Order By G1.grpcode  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------
/*this Procedure Gives Us The Discription For Supplied Vtype*/  
Create Procedure   
Rpt_accvdesc   
@Vtype Smallint  
As  
Select Vdesc From Accountbfo.Dbo.Vmast Where   
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_branchloginclinentlist
-- --------------------------------------------------
  
CREATE procedure  rpt_branchloginclinentlist  
        
@order_by as varchar(9),        
@statusid varchar(15),        
@statusname varchar(25)        
as    
select c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,        
 c1.branch_cd,c1.family,c1.sub_broker,c1.trader,        
 c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,        
 c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,        
 convert(varchar(11),ActiveFrom) as ActiveFrom ,      
 convert(varchar(11),InactiveFrom) as InactiveFrom,        
 CL5.Introducer,CL5.Approver,   
 ORDERBYFLAG = (CASE WHEN @order_by='Branch' THEN C1.BRANCH_CD  
      WHEN @order_by='SubBroker' THEN C1.SUB_BROKER  
      WHEN @order_by='Client' THEN C1.SHORT_NAME  
      WHEN @order_by='FAMILY' THEN C1.FAMILY        
      ELSE '1'  
    END),  
ORDERBYFLAG1 = (CASE WHEN @order_by='ACTIVE' THEN ActiveFrom   
      WHEN @order_by='InActive' THEN InactiveFrom  
      ELSE 'DEC 31 2049'  
    END)  
 from client1 c1 with( /* index(clcode), */ nolock), Client5 CL5 with( /* index(PK_Client5), */ nolock)   
 ,client2 c2 with(/* index(PK_Client2),*/ nolock) ,branch c3 with(/* Index(PK_BRANCH_CODE),*/ nolock) ,branches c4 (nolock) ,subbrokers c5 (nolock)         
 where c1.cl_code=c2.cl_code and        
 c1.branch_cd=c3.branch_code and        
 c1.trader=c4.short_name and        
 c1.sub_broker=c5.sub_broker and        
 c3.branch_code=c4.branch_cd  
 and CL5.Cl_Code = C1.Cl_Code  
 And @StatusName =             
                  (case             
                        when @StatusId = 'BRANCH' then c1.branch_cd            
                        when @StatusId = 'SUBBROKER' then c1.sub_broker            
                        when @StatusId = 'Trader' then c1.Trader            
                        when @StatusId = 'Family' then c1.Family            
                        when @StatusId = 'Area' then c1.Area            
                        when @StatusId = 'Region' then c1.Region            
                        when @StatusId = 'Client' then c2.party_code            
                  else             
                        'BROKER'            
                  End)            
 order by ORDERBYFLAG,ORDERBYFLAG1,c2.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_broktabledetails
-- --------------------------------------------------

CREATE procedure rpt_broktabledetails
@tabno as int

As

select table_no,upper_lim,day_puc,day_sales,sett_purch,sett_sales,normal,trd_del,val_perc,line_no,table_name,round_to,
RoFig,ErrNum,NoZero,

rt = ( case when ( RoFig =0  and  ErrNum=0.5 and  NoZero=1) then 'ACTUAL'  else 
      		( case when ( RoFig =1  and  ErrNum=-0.1 and  NoZero=0) then 'NEXT 1P' else 
      			( case when ( RoFig =5  and  ErrNum=-0.1 and  NoZero=0) then 'NEXT 5P' else
				( case when ( RoFig =-1  and  ErrNum=0.1 and  NoZero=0) then 'PREV 1P' else
					( case when ( RoFig =-5  and  ErrNum=0.1 and  NoZero=0) then 'PREV 5P' else 
						( case when ( RoFig =5  and  ErrNum=-2.5 and  NoZero=0) then 'BANKERS'
	
						end )end )end )end )end )end )
from broktable
where table_no = @tabno
order by table_no,line_no,upper_lim

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ClosingRate
-- --------------------------------------------------

CREATE procEDURE [dbo].[rpt_ClosingRate] (@seriescode varchar(50), @fromdate varchar(10), @todate varchar(10))  AS
Select
distinct left(convert(varchar,trade_date,106),11),
product_type,product_code,series_code,cl_rate,series_id,
left(convert(varchar,expirydate,109),11) as expdate,
year(trade_date), month(trade_date), day(trade_date)
from bfoclosing
where 
series_code like  @seriescode  + '%'
and trade_date >= (convert(datetime,@fromdate,105))
and trade_date <= (convert(datetime,@todate,105)+1)
order by  series_code,day(trade_date), month(trade_date), year(trade_date)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_conpath
-- --------------------------------------------------
/*report :  allparty ledger   
    file : allparty.asp  
    file : ledgerview.asp  
*/  
  
/* selects conpath from owner for a exchange and segment */  
  
CREATE PROCEDURE rpt_conpath  
  
@exch varchar(3),  
@segment varchar(20)  
  
AS  
  
select conpath from accountbfo.dbo.owner where exchange=@exch and segment like ltrim(@segment)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_finyearlist
-- --------------------------------------------------
CREATE PROCEDURE  rpt_finyearlist  
  
AS  
  
select distinct  smonth=datename(month, sdtcur), syear=datename(year, sdtcur), emonth=datename(month, ldtcur),  
 lyear=datename(year, ldtcur) ,sdt=convert(varchar,sdtcur,103),  
ldt=convert(varchar,ldtcur,103), curyear from accountbfo.dbo.parameter  
order by curyear desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_FoRms_Report
-- --------------------------------------------------


CREATE  Proc  rpt_FoRms_Report (@MarginDateFrom Varchar(11),@MarginDateTo Varchar(11),
@IntMarType Varchar(20),@BranchCd Varchar(10), @SubBroker Varchar(10),@PartyFrom Varchar(10),@PartyTo Varchar(10),
@StatusName Varchar(25),@StatusId varchar(10), @RiskShortage Varchar(10)
)
As

Delete FoRms_TBL Where SrNo = @@SpId

set transaction isolation level read uncommitted

Insert into FoRms_TBL

SELECT foriskmanagement_tbl.*,
	left(convert(varchar,margindate,109),11) as mmargindate,
	spanmargin , 0, initialmargin_MG13, 50, initialmargin_MG13, @@SpId

From 
	foriskmanagement_tbl
Where
	MarginDate Between @MarginDateFrom and @MarginDateTo
	And Party_Code Between @PartyFrom and @PartyTo
	And Branch_Cd Like Case When @BranchCd <> 'ALL' Then @BranchCd Else '%' End
	And Sub_Broker Like Case When @SubBroker <> 'ALL' Then @SubBroker Else '%' End
	And @StatusName = 
          (case 
                when @StatusId = 'BRANCH' then Branch_Cd
                when @StatusId = 'SUBBROKER' then Sub_Broker
                when @StatusId = 'Trader' then Trader
                when @StatusId = 'Family' then Family
                when @StatusId = 'Client' then Party_Code
          else 
                'BROKER'
          End)
	And
	
	(
		(@RiskShortage = 'Excess' and EffectiveColl + LedgerAmount - InitialMargin_MG13 > 1 )
	
		OR
	
		(@RiskShortage = 'Short' And EffectiveColl + LedgerAmount - InitialMargin_MG13 <= 1)
	
		Or
	
		(@RiskShortage = 'Both' And  1= 1)
	
	)

	
if @IntMarType <> 'mgimar'
	Begin

		set transaction isolation level read uncommitted

		Update FoRms_TBL
			Set finalimargin = finaliMargin *(1+PmarginRate/100),
				TotMarginForReporting = TotMarginForReporting *(1+PmarginRate/100),
				finalspamargin = finalspamargin *(1+PmarginRate/100)
		From 
			Client3 
		Where
			SrNo = @@SpId
			And Client3.Party_Code = FoRms_TBL.Party_Code
			

	End

Update FoRms_TBL Set finalTotal = finaliMargin - optionsMTOM Where SrNo = @@SpId

set transaction isolation level read uncommitted

Update FoRms_TBL
		Set TotMarginForReporting = -TotMarginForReporting - isnull(Init_Margin,0) - isnull(Mtm_Margin,0)
From  BFomarginColl 
Where
	SrNo = @@SpId 
	And FoRms_TBL.Party_Code = BFomarginColl.Party_Code
	And left(File_Date,11) = left(FoRms_TBL.mmargindate,11) 
	

set transaction isolation level read uncommitted

Select 
	Sum(case when drcr = 'C' then vamt else -vamt end) Payment, 
	CltCode 
Into #Payment
From 
	Accountfo.dbo.ledger ,  FoRms_TBL 
where 
	vdt Like left(FoRms_TBL.mmargindate,11) + '%'
	and CltCode = Party_Code
	and Vtyp in (1,2,3,4,24) 
	and SrNo = @@SpId
	
group by CltCode


Select 
	f.long_futuresexposure Prv_long_futuresexposure,
	f.short_futuresexposure Prv_short_futuresexposure,
	f.long_optionsexposure Prv_long_optionsexposure ,
	f.short_optionsexposure Prv_short_optionsexposure,
	f.Party_Code Prv_Party_Code,
	f.margindate
Into #PrvFoRms
from 
	foriskmanagement_tbl f  , FoRms_TBL 
where 
	F.margindate in
		(select top 1 margindate 
		from foriskmanagement_tbl 
		where margindate < FoRms_TBL.mmargindate
		and party_code = FoRms_TBL.Party_Code order by 1 desc) 
	and SrNo = @@SpId
	and F.party_code = FoRms_TBL.Party_Code





Select FoRms_TBL.*,
	isnull(#Payment.Payment,0) Payment, 
	isnull(Prv_long_futuresexposure,0)  Prv_long_futuresexposure,
	isnull(Prv_short_futuresexposure,0) Prv_short_futuresexposure,
	isnull(Prv_long_optionsexposure,0)  Prv_long_optionsexposure,
	isnull(Prv_short_optionsexposure,0) Prv_short_optionsexposure,
	isnull(Mtm_Margin,0) exposuremtom ,-isnull(Init_Margin,0)OptBuyPrem
 from 	
	FoRms_TBL 
		Left Outer Join  #Payment On (FoRms_TBL.Party_Code = Cltcode)
		Left Outer Join  #PrvFoRms On (left(#PrvFoRms.margindate,11) = Left(FoRms_TBL.MMarginDate,11)
						and Prv_Party_Code = FoRms_TBL.Party_Code)
		Left Outer Join  
			(
			Select File_Date,Party_code,
			MTM_Margin=sum(MTM_Margin),Init_Margin=sum(Init_Margin)
			from BFomarginColl group by File_Date,Party_code
			) F  
						on ( F.Party_Code = FoRms_TBL.Party_Code
						and Left(F.File_Date,11) = Left(FoRms_TBL.MMarginDate,11) )
Where SrNo = @@SpId
Order By MMarginDate,FoRms_TBL.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_FoSpanMargin
-- --------------------------------------------------

CREATE  Proc Rpt_FoSpanMargin
	(
		@Sauda_Date Varchar(11),
		@StatusId varchar(15),
		@StatusName varchar(25),
		@PartyFrom Varchar(10),
		@PartyTo Varchar(10)
	)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

If @PartyTo ='' Begin Set @PartyTo = 'zzzzzzzzzz' End

	Select
		Party_Code = FoMargin_Span.Party_Code,
		PartyName = Long_Name,
		Symbol = FoMargin_Span.Symbol,
		S_SpanMargin = SpanMargin,
		S_Premium = Premium,
		S_AddMarginPerc = PMarginRate,
		S_TotalMargin = TotalMargin
	From
		FoMargin_Span,Client1 , Client2
	Where
		Client1.Cl_Code = Client2.Cl_Code
		And Client2.Party_Code = FoMargin_Span.Party_Code	
		And FoMargin_Span.Cl_Type ='CL'
		And MDate Like @Sauda_Date +'%'
		And Client2.Party_Code Between @PartyFrom and @PartyTo
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN Client1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN Client1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN Client1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN Client1.FAMILY
			WHEN @STATUSID = 'AREA' THEN Client1.AREA
			WHEN @STATUSID = 'REGION' THEN Client1.REGION
			WHEN @STATUSID = 'CLIENT' THEN Client2.PARTY_CODE
			ELSE 
		'BROKER'
		END)

Order By 1,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_FTpartydetails
-- --------------------------------------------------

CREATE procedure rpt_FTpartydetails     
@partycode as varchar(20)    
        
As     
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
select cl2.cl_code,cl2.party_code,cl2.dummy1,      
turnover_tax =  (case when cl2.Turnover_tax=0 then 'N'      
   when cl2.Turnover_tax=1 then 'Y'      
  end),      
sebi_turn_tax =  (case when cl2.sebi_turn_tax=0 then 'N'      
   when cl2.sebi_turn_tax=1 then 'Y'      
  end),      
Service_chrg = (case when cl2.service_chrg=0 then 'Exclusive'      
   when cl2.service_chrg=1 then 'Incl in Brok'      
   when cl2.service_chrg=2 then 'Inclusive'      
  end),      
Insurance_Chrg = (case when cl2.Insurance_Chrg=0 then 'N'      
   when cl2.Insurance_Chrg =1 then 'Y'      
  end),      
Other_chrg =(case when cl2.Other_chrg=0 then 'N'      
   when cl2.Other_chrg=1 then 'Y'      
  end),      
cl2.table_no,cl2.sub_tableno,cl2.demat_tableno,cl2.p_to_p    
,cl2.Std_rate,cl2.demat_tableno,cl2.ALBMDelchrg,cl2.ALBMDelivery,cl2.AlbmCF_tableno,cl2.MF_tableno,cl2.SB_tableno,     
cl2.brok1_tableno,cl2.brok2_tableno,    
brok3_table_no= (case when cl2.brok3_tableno=0 then 'Treat as Brokerage'    
when cl2.brok3_tableno=1 then 'Treat as Charges' else 'Not Selected' end),    
dummy1= (case when cl2.dummy1=0 then 'Premium' when cl2.dummy1=1 then 'Strike'    
 when cl2.dummy1=2 then 'Strike + Premium'     
else   'Not Selected' end), cl2.Dummy2 ,    
    
brokernote= (case when cl2.brokernote=0 then 'N'      
   when cl2.brokernote=1 then 'Y'      
  end),      
brok_scheme = (case when cl2.brok_scheme=0 then 'Default'      
   when cl2.brok_scheme=1 then 'Max Logic (F/S) - Buy Side'      
   when cl2.brok_scheme=2 then 'Max Rate'    
   when cl2.brok_scheme=3 then 'Max Logic (F/S) - Sell Side'      
   when cl2.brok_scheme=4 then 'Flat Brokerage Default'      
   when cl2.brok_scheme=5 then 'Flat Brokerage (Max Logic) - Buy Side'      
   when cl2.brok_scheme=6 then 'Flat Brokerage (Max Logic) - Sell Side'      
  end),      
brok3_table_no= (case when cl2.brok3_tableno=0 then 'Treat as Brokerage'      
   when cl2.brok3_tableno=1 then 'Treat as Charges'      
  else      
   'Not Selected'      
  end),      
dummy1= (case when cl2.dummy1=0 then 'Premium'      
   when cl2.dummy1=1 then 'Strike'      
   when cl2.dummy1=2 then 'Strike + Premium'      
  else      
   'Not Selected'      
  end),      
cl2.Dummy2,      
cl1.long_name,cl1.l_address1,cl1.l_address2, cl1.l_address3,     
cl1.L_city,cl1.L_State,cl1.L_Nation,cl1.L_Zip,cl1.Fax,cl1.Res_Phone1, Res_Phone2, Off_Phone1, Off_Phone2, cl1.Email,      
cl1.Branch_cd,cl1.Cl_type,cl1.Cl_Status,cl1.Family,cl1.Sub_Broker,cl1.Mobile_Pager,cl1.pan_gir_no,cl1.trader,      
s1.name,b1.branch  ,    
conttype= (case when cl2.InsCont='S' then 'Scripwise'      
   when cl2.InsCont='O' then 'Orderwise'      
   when cl2.InsCont='N' then 'Normal'      
  else      
   'Not available'      
  end),    
participant = (case when cl1.Cl_type='INS' then cl2.BankId    
   else  ''     
                            end) ,     
    
custodian = (case when cl1.Cl_type='INS' then CL2.CLTDPNO    
   else  ''     
                            end) ,     
    
Printf = (case when cl2.Printf=0 then 'Print'      
   else      
                'Dont Print'      
              end) ,    
    
contprt = (case when cl2.Printf =0 then 'Detail Bill And Contract'      
   when cl2.Printf =1 then 'Dont Print Bill And Contract'      
   when cl2.Printf =2 then 'Summarised Contract and Detail Bill'      
   when cl2.Printf =3 then 'Summarised Bill and Detail Contract'      
   when cl2.Printf =4 then 'Both Summarised'      
  end) ,    
convert(varchar(11),c5.ActiveFrom) as ActiveFrom ,      
InactiveFrom = (case when convert(varchar(11),c5.InactiveFrom) ='Jan  1 1900' then 'N.A.'      
   else      
               convert(varchar(11),c5.InactiveFrom)    
              end),    
/*convert(varchar(11),c5.InactiveFrom)   as InactiveFrom,*/    
C5.Introducer,C5.Approver ,     
isnull(c5.Passportdtl,'') as Passportdtl, isnull(c5.PassportDateOfIssue,'') as PassportDateOfIssue,  isnull(c5.PassportPlaceOfIssue,'') as PassportPlaceOfIssue,  isnull(c5.PASSPORTEXPDATE,'') as PASSPORTEXPDATE,    
isnull(c5.Drivelicendtl,'') as Drivelicendtl, isnull(c5.LicenceNoDateOfIssue,'') as LicenceNoDateOfIssue, isnull(c5.LicenceNoPlaceOfIssue,'') as LicenceNoPlaceOfIssue, isnull(c5.DRIVEEXPDATE,'') as DRIVEEXPDATE,    
isnull(c5.Rationcarddtl,'') as Rationcarddtl, isnull(c5.RationCardDateOfIssue,'') as RationCardDateOfIssue, isnull(c5.RationCardPlaceOfIssue,'') as RationCardPlaceOfIssue,    
isnull(c5.VotersIDdtl,'') as VotersIDdtl, isnull(c5.VoterIdDateOfIssue,'') as VoterIdDateOfIssue, isnull(c5.VoterIdPlaceOfIssue,'') as VoterIdPlaceOfIssue    
    
from client2 cl2, client1 cl1 Left Outer Join Client5 C5 On ( C5.Cl_Code = cl1.Cl_Code ) ,    
subbrokers s1,branch b1    
where cl1.cl_code = cl2.cl_code      
and s1.sub_broker = cl1.sub_broker      
and cl2.party_code =@partycode    
and b1.branch_code = cl1.branch_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_listclient
-- --------------------------------------------------

CREATE PROCEDURE  rpt_listclient   
@statusid varchar(15),  
@statusname varchar(25),  
@partycode varchar(15),  
@topartycode varchar(15)  
AS  
  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
  Select distinct c2.party_code Party_Code  
  FROM CLIENT1 C1 WITH(NOLOCK),   
       CLIENT2 C2 WITH(NOLOCK)   
  WHERE C2.CL_CODE = C1.CL_CODE   
        AND @STATUSNAME =   
                  (CASE   
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
                  ELSE   
                        'BROKER'  
                END)  
        And c2.party_code >= @partycode  and c2.party_code <= @topartycode     
 Order by c2.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ListClientName
-- --------------------------------------------------

CREATE  PROCEDURE rpt_ListClientName
@statusid varchar(15),
@statusname varchar(25),
@partyName varchar(50),
@TopartyName varchar(50)
AS

  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

  Select distinct c2.Party_Code, c1.Long_Name
  FROM CLIENT1 C1 WITH(NOLOCK), 
       CLIENT2 C2 WITH(NOLOCK) 
  WHERE C2.CL_CODE = C1.CL_CODE 
        AND @STATUSNAME = 
                  (CASE 
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                        WHEN @STATUSID = 'AREA' THEN C1.AREA
                        WHEN @STATUSID = 'REGION' THEN C1.REGION
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
                  ELSE 
                        'BROKER'
                END)
    and C1.Long_Name Between ltrim(rtrim(@partyName))  and ltrim(rtrim(@TopartyName))
    order by c1.Long_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_loginclient
-- --------------------------------------------------

CREATE PROCEDURE rpt_loginclient   
@statusid varchar(15),  
@statusname varchar(25)  

AS  

if @statusid='broker'  
  begin  
    select distinct  party_code  
    from client2  
    order by party_code  
  end  
if @statusid='branch'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2, client1 c1, branches b  
    where ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and  
   c1.cl_code = c2.cl_code and  
   ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname))   
    order by c2.Party_Code  
  end    
if @statusid='subbroker'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2,client1 c1,subbrokers sb  
    where c1.cl_code = c2.cl_code and  
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and  
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))    
   order by c2.Party_Code  
  end   
if @statusid='trader'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2, client1 c1  
    where c1.cl_code = c2.cl_code and ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))    
    order by c2.Party_Code  
  end   
if @statusid='client'  
  begin  
    select distinct c2.Party_Code  
    from client2 c2, client1 c1   
    where c1.cl_code=c2.cl_code and  
  c2.party_code=@statusname   
 order by c2.Party_Code  
  end  
if @statusid='family'  
  begin  
    select distinct c2.Party_Code  
    from client2 c2, client1 c1  
    where c1.cl_code = c2.cl_code and ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname))  
    order by c2.Party_Code  
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_Loginclientname
-- --------------------------------------------------

Create Procedure Rpt_Loginclientname  
@Statusid Varchar(15),   
@Statusname Varchar(25)  
  
As  
If @Statusid = 'Broker'  
  Begin  
    Select Distinct C2.Party_Code, C1.Long_Name  
    From Client1 C1, Client2 C2  
    Where C1.Cl_Code = C2.Cl_Code  
    Order By C1.Long_Name  
  End  
If @Statusid = 'Branch'  
  Begin  
    Select Distinct  C2.Party_Code, C1.Long_Name  
    From Client2 C2, Client1 C1, Branches B  
    Where Ltrim(Rtrim(B.Short_Name)) = Ltrim(Rtrim(C1.Trader)) And  
    C1.Cl_Code = C2.Cl_Code And  
    Ltrim(Rtrim(B.Branch_Cd)) = Ltrim(Rtrim(@Statusname))   
    Order By C1.Long_Name  
  End    
If @Statusid = 'Subbroker'  
  Begin  
    Select Distinct  C2.Party_Code, C1.Long_Name  
    From Client2 C2, Client1 C1, Subbrokers Sb  
    Where C1.Cl_Code = C2.Cl_Code And  
   Ltrim(Rtrim(Sb.Sub_Broker)) = Ltrim(Rtrim(@Statusname)) And  
   Ltrim(Rtrim(Sb.Sub_Broker)) = Ltrim(Rtrim(C1.Sub_Broker))    
   Order By C1.Long_Name  
  End   
If @Statusid = 'Trader'  
  Begin  
    Select Distinct  C2.Party_Code, C1.Long_Name  
    From Client2 C2, Client1 C1  
    Where C1.Cl_Code = C2.Cl_Code And Ltrim(Rtrim(C1.Trader))  = Ltrim(Rtrim(@Statusname))    
    Order By C1.Long_Name  
  End   
If @Statusid = 'Client'  
  Begin  
    Select Distinct C2.Party_Code, C1.Long_Name  
    From Client2 C2, Client1 C1   
    Where C1.Cl_Code = C2.Cl_Code And  
  C2.Party_Code = @Statusname   
 Order By C1.Long_Name  
  End  
If @Statusid = 'Family'  
  Begin  
    Select Distinct C2.Party_Code, C1.Long_Name  
    From Client2 C2, Client1 C1  
    Where C1.Cl_Code = C2.Cl_Code And Ltrim(Rtrim(C1.Family))  = Ltrim(Rtrim(@Statusname))  
    Order By C1.Long_Name  
  End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_netbalancesbs
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 01/15/2005 1:42:25 Pm ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 12/16/2003 2:31:55 Pm ******/    
--rpt_netBalancesBS 'Apr 1 2005','May 31 2005','A0314020000','broker','broker'  
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 06/26/2002 6:15:44 Pm ******/    
/* Query To Get Net Income And Expenses For The Given Period */    
/* Written On 13-06-2002 By Vns */    
/* Flag Can Have Values 'a' - For Income */    
/*                      'l' - For Expenses */    
--rpt_netBalancesBS_2 'Apr  1 2005','May 31 2005','A0307000000','broker','broker'    
CREATE Proc Rpt_netbalancesbs  
@fromdt Varchar(11),    
@todt Varchar(11),    
@grpcode Varchar(11),    
@statusid Varchar(15),    
@statusname Varchar(25)    
  
As    
--Print len(rtrim(@grpcode))  
If Len(@GrpCode) < 11  
 Begin  
  Select Type='G', Grp=substring(a.grpcode,1,len(rtrim(@grpcode))), Grpname=grpname, Bal= Isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
  From Accountbfo.dbo.ledger L, Accountbfo.dbo.acmast A, Accountbfo.dbo.grpmast G    
  Where L.cltcode = A.cltcode And Substring(a.grpcode,1,len(rtrim(@grpcode))) = Rtrim(@grpcode)     
  And Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
  And G.grpcode = Substring(a.grpcode, 1, len(rtrim(@grpcode)))        --+ )   rtrim(@grpcode) + Right('0000000000', 11-(len(rtrim(@grpcode))+2))  
  Group By Substring(a.grpcode,1,len(rtrim(@grpcode))), Grpname    
  Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
      
  Union All    
      
  Select Type = 'D', Grp=l.cltcode, Grpname=l.acname, Bal= Isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
  From Accountbfo.dbo.ledger L, Accountbfo.dbo.acmast A    
  Where Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
  And L.cltcode = A.cltcode And A.grpcode = @grpcode  +rtrim(right('0000000000',11-len(rtrim(@grpcode))))     
  Group By L.cltcode, L.acname    
  Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
      
  Order By Type,grp, Grpname  
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_netbs01
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 01/15/2005 1:42:24 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 12/16/2003 2:31:55 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 06/26/2002 6:15:44 Pm ******/  
/* Query To Get Net Income And Expenses For The Given Period */  
/* Written On 22-06-2002 By Vns */  
/* Flag Can Have Values 'a' - For Assets */  
/*                      'l' - For Liabilities */  
  
Create  Proc Rpt_netbs01  
@fromdt Varchar(11),  
@todt Varchar(11),  
@statusid Varchar(15),  
@statusname Varchar(25)  
  
As  
  
Select Type='g', Grp=substring(a.grpcode,1,3), Grpname=grpname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)  
From AccountBfo.dbo.ledger L, AccountBfo.dbo.acmast A, AccountBfo.dbo.grpmast G  
Where L.cltcode = A.cltcode And Substring(a.grpcode,1,1) In ('a','l')  
And Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'  
And G.grpcode = Substring(a.grpcode,1,3)+ '00000000' And A.cltcode <> '99999'  
Group By Substring(a.grpcode,1,3), Grpname  
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0  
  
Union All  
  
Select Type = 'd', Grp=l.cltcode, Grpname=l.acname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)  
From AccountBfo.dbo.ledger L, AccountBfo.dbo.acmast A  
Where Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'  
And L.cltcode = A.cltcode And A.grpcode In ('a0000000000', 'l0000000000')   
Group By L.cltcode, L.acname  
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0  
Order By Grp, Grpname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_proc_addclient_log
-- --------------------------------------------------

/****** Object:  Stored Procedure Dbo.rpt_proc_addclient_log    Script Date: 01/15/2005 1:44:06 Pm ******/  
  
Create  Procedure Rpt_proc_addclient_log  
  
 @partycode Varchar(10),  
 @viewtype Varchar(20),  
 @datefrom Datetime,  
 @dateto Datetime  
  
As  
  
 Print @datefrom  
 Print @dateto  
  
 Declare @reccount Int  
  
-- Set @viewtype = 'most_recent_change'  
-- Set @partycode = 'test10'  
-- Set @partycode = 'test18'  
  
 If Upper(ltrim(rtrim(@viewtype))) = 'most_recent_change'  
  Begin  /*if Upper(ltrim(rtrim(@viewtype))) = 'most_recent_change'*/  
   Select @reccount = Count(party_code) From Client2_log Where Party_code = @partycode  
   Print @reccount  
   
   If @reccount > 1  
    Begin  /*if @reccount > 1*/  
     Select  
      Top 2  
       Tran_cat As Transaction_category,   
       Scrip_cat As Auction,   
       Party_code As Party_code,   
       Table_no As Trading_table_no,   
       Sub_tableno As Del_table_no,   
       Margin As Margin,   
       Turnover_tax As Transaction_charges_flag,   
       Sebi_turn_tax As Sebi_fees_flag,   
       Insurance_chrg As Insurance_charges_flag,   
       Service_chrg As Service_tax_flag,   
       Std_rate As Futurebrokerage,   
       /*p_to_p As 0 ,*/  
       /*exposure_lim As 0 ,*/  
       Demat_tableno As Demat_table_no,   
       Bankid As Participant_code,   
       Cltdpno As Custodian_code,   
       Printf As Print_option,   
       /*albmdelchrg As 0 ,*/  
       Albmdelivery As Option_carry_forward,   
       /*albmcf_tableno As 0 ,*/  
       Mf_tableno As Future_carry_forward,   
       /*sb_tableno As 0 ,*/  
       Brok1_tableno As Future_final_day_brokerage,   
       Brok2_tableno As Option_brokerage,   
       Brok3_tableno As Carry_forward_flag,   
       Brokernote As Stamp_duty_flag,   
       Other_chrg As Other_charges_flag,   
       Brok_scheme As Brok_scheme,   
       Contcharge As Cont_charge_flag,   
       Mincontamt As Min_cont_amt,   
       /*addledgerbal As 0 ,*/  
       Dummy1 As Brokerage_applicable,   
       Dummy2 As Option_excercise,   
       Inscont As Inst_contract,   
       Sertaxmethod As Service_tax_method,   
       Dummy6 As Clearing,   
       Dummy7 As Reporting_style,   
       Dummy8 As Sbu,   
       Dummy9 As Relmgr,   
       Dummy10 As Group_code,   
       Convert(varchar, Activefrom, 109) As Active_from,   
       Convert(varchar, Inactivefrom, 109) As Inactive_from,   
       Debitbalflag As Debitbal_flag,   
       Intersettflag As Intersett_flag,   
       Logfld_statusname As Logfld_statusname,  
       Logfld_username As Logfld_username,   
       Logfld_when_109,   
       Logfld_action  
     From  
      Client2_log  
     Where  
      Party_code = @partycode  
     Order By  
      Logfld_when_109 Desc  
    End /*if @reccount > 1*/  
   
   Else /*if @reccount > 1*/  
   
    Begin  /*else Of  If @reccount > 1*/  
     Select  
      Top 1  
       Tran_cat As Transaction_category,   
       Scrip_cat As Auction,   
       Party_code As Party_code,   
       Table_no As Trading_table_no,   
       Sub_tableno As Del_table_no,   
       Margin As Margin,   
       Turnover_tax As Transaction_charges_flag,   
       Sebi_turn_tax As Sebi_fees_flag,   
       Insurance_chrg As Insurance_charges_flag,   
       Service_chrg As Service_tax_flag,   
       Std_rate As Futurebrokerage,   
       /*p_to_p As 0 ,*/  
       /*exposure_lim As 0 ,*/  
       Demat_tableno As Demat_table_no,   
       Bankid As Participant_code,   
       Cltdpno As Custodian_code,   
       Printf As Print_option,   
       /*albmdelchrg As 0 ,*/  
       Albmdelivery As Option_carry_forward,   
       /*albmcf_tableno As 0 ,*/  
       Mf_tableno As Future_carry_forward,   
       /*sb_tableno As 0 ,*/  
       Brok1_tableno As Future_final_day_brokerage,   
       Brok2_tableno As Option_brokerage,   
       Brok3_tableno As Carry_forward_flag,   
       Brokernote As Stamp_duty_flag,   
       Other_chrg As Other_charges_flag,   
       Brok_scheme As Brok_scheme,   
       Contcharge As Cont_charge_flag,   
       Mincontamt As Min_cont_amt,   
       /*addledgerbal As 0 ,*/  
       Dummy1 As Brokerage_applicable,   
       Dummy2 As Option_excercise,   
       Inscont As Inst_contract,   
       Sertaxmethod As Service_tax_method,   
       Dummy6 As Clearing,   
       Dummy7 As Reporting_style,   
       Dummy8 As Sbu,   
       Dummy9 As Relmgr,   
       Dummy10 As Group_code,   
       Convert(varchar, Activefrom, 109) As Active_from,   
       Convert(varchar, Inactivefrom, 109) As Inactive_from,   
       Debitbalflag As Debitbal_flag,   
       Intersettflag As Intersett_flag,   
       Logfld_statusname As Logfld_statusname,  
       Logfld_username As Logfld_username,   
       Logfld_when_109,   
       Logfld_action   
     From  
      Client2_log  
     Where  
      Party_code = @partycode  
     Order By  
      Logfld_when_109 Desc  
    End  /*else Of  If @reccount > 1*/  
  End  /*if Upper(ltrim(rtrim(@viewtype))) = 'most_recent_change'*/  
  
 If Upper(ltrim(rtrim(@viewtype))) = 'for_a_date'  
  Begin  /*if Upper(ltrim(rtrim(@viewtype))) = 'for_a_date'*/  
   Select  
    Tran_cat As Transaction_category,   
    Scrip_cat As Auction,   
    Party_code As Party_code,   
    Table_no As Trading_table_no,   
    Sub_tableno As Del_table_no,   
    Margin As Margin,   
    Turnover_tax As Transaction_charges_flag,   
    Sebi_turn_tax As Sebi_fees_flag,   
    Insurance_chrg As Insurance_charges_flag,   
    Service_chrg As Service_tax_flag,   
    Std_rate As Futurebrokerage,   
    /*p_to_p As 0 ,*/  
    /*exposure_lim As 0 ,*/  
    Demat_tableno As Demat_table_no,   
    Bankid As Participant_code,   
    Cltdpno As Custodian_code,   
    Printf As Print_option,   
    /*albmdelchrg As 0 ,*/  
    Albmdelivery As Option_carry_forward,   
    /*albmcf_tableno As 0 ,*/  
    Mf_tableno As Future_carry_forward,   
    /*sb_tableno As 0 ,*/  
    Brok1_tableno As Future_final_day_brokerage,   
    Brok2_tableno As Option_brokerage,   
    Brok3_tableno As Carry_forward_flag,   
    Brokernote As Stamp_duty_flag,   
    Other_chrg As Other_charges_flag,   
    Brok_scheme As Brok_scheme,   
    Contcharge As Cont_charge_flag,   
    Mincontamt As Min_cont_amt,   
    /*addledgerbal As 0 ,*/  
    Dummy1 As Brokerage_applicable,   
    Dummy2 As Option_excercise,   
    Inscont As Inst_contract,   
    Sertaxmethod As Service_tax_method,   
    Dummy6 As Clearing,   
    Dummy7 As Reporting_style,   
    Dummy8 As Sbu,   
    Dummy9 As Relmgr,   
    Dummy10 As Group_code,   
    Convert(varchar, Activefrom, 109) As Active_from,   
    Convert(varchar, Inactivefrom, 109) As Inactive_from,   
    Debitbalflag As Debitbal_flag,   
    Intersettflag As Intersett_flag,   
    Logfld_statusname As Logfld_statusname,  
    Logfld_username As Logfld_username,   
    Logfld_when_109,   
    Logfld_action   
   From  
    Client2_log  
   Where  
    Party_code = @partycode  And  
    Logfld_when_109 Like Left(convert(varchar, @datefrom, 109), 11) + '%'  
   Order By  
    Logfld_when_109 Desc  
  End  /*if Upper(ltrim(rtrim(@viewtype))) = 'for_a_date'*/  
  
 If Upper(ltrim(rtrim(@viewtype))) = 'for_a_period'  
  Begin  /*if Upper(ltrim(rtrim(@viewtype))) = 'for_a_period'*/  
   Select  
    Tran_cat As Transaction_category,   
    Scrip_cat As Auction,   
    Party_code As Party_code,   
    Table_no As Trading_table_no,   
    Sub_tableno As Del_table_no,   
    Margin As Margin,   
    Turnover_tax As Transaction_charges_flag,   
    Sebi_turn_tax As Sebi_fees_flag,   
    Insurance_chrg As Insurance_charges_flag,   
    Service_chrg As Service_tax_flag,   
    Std_rate As Futurebrokerage,   
    /*p_to_p As 0 ,*/  
    /*exposure_lim As 0 ,*/  
    Demat_tableno As Demat_table_no,   
    Bankid As Participant_code,   
    Cltdpno As Custodian_code,   
    Printf As Print_option,   
    /*albmdelchrg As 0 ,*/  
    Albmdelivery As Option_carry_forward,   
    /*albmcf_tableno As 0 ,*/  
    Mf_tableno As Future_carry_forward,   
    /*sb_tableno As 0 ,*/  
    Brok1_tableno As Future_final_day_brokerage,   
    Brok2_tableno As Option_brokerage,   
    Brok3_tableno As Carry_forward_flag,   
    Brokernote As Stamp_duty_flag,   
    Other_chrg As Other_charges_flag,   
    Brok_scheme As Brok_scheme,   
    Contcharge As Cont_charge_flag,   
    Mincontamt As Min_cont_amt,   
    /*addledgerbal As 0 ,*/  
    Dummy1 As Brokerage_applicable,   
    Dummy2 As Option_excercise,   
    Inscont As Inst_contract,   
    Sertaxmethod As Service_tax_method,   
    Dummy6 As Clearing,   
    Dummy7 As Reporting_style,   
    Dummy8 As Sbu,   
    Dummy9 As Relmgr,   
    Dummy10 As Group_code,   
    Convert(varchar, Activefrom, 109) As Active_from,   
    Convert(varchar, Inactivefrom, 109) As Inactive_from,   
    Debitbalflag As Debitbal_flag,   
    Intersettflag As Intersett_flag,   
    Logfld_statusname As Logfld_statusname,  
    Logfld_username As Logfld_username,   
    Logfld_when_109,   
    Logfld_action   
   From  
    Client2_log  
   Where  
    Party_code = @partycode  And  
    Logfld_when_109 >= @datefrom And  
    Logfld_when_109 <= @dateto + ' 23:59:59'  
   Order By  
    Logfld_when_109 Desc  
  End  /*if Upper(ltrim(rtrim(@viewtype))) = 'for_a_period'*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_proc_client2_log
-- --------------------------------------------------
Create   Procedure  
  
Rpt_proc_client2_log  
  
@cl_code Varchar (10),  
@party_code Varchar (10),  
  
@script_name Varchar (500),  
@session_id Varchar (30),  
@local_addr Varchar (20),  
@remote_addr Varchar (20),  
@remote_host Varchar (50),  
--@request_method Varchar (20),  
--@content_type Varchar (50),  
--@content_length Int,  
@status_name Varchar (50),  
@user_name Varchar (100),  
--@module Varchar (50),  
@action Varchar (100)  
  
As  
  
Insert Into  
 Client2_log  
  Select  
   C2.cl_code,   
   C2.exchange,   
   C2.tran_cat,   
   C2.scrip_cat,   
   C2.party_code,   
   C2.table_no,   
   C2.sub_tableno,   
   C2.margin,   
   C2.turnover_tax,   
   C2.sebi_turn_tax,   
   C2.insurance_chrg,   
   C2.service_chrg,   
   C2.std_rate,   
   C2.p_to_p,   
   C2.exposure_lim,   
   C2.demat_tableno,   
   C2.bankid,   
   C2.cltdpno,   
   C2.printf,   
   C2.albmdelchrg,   
   C2.albmdelivery,   
   C2.albmcf_tableno,   
   C2.mf_tableno,   
   C2.sb_tableno,   
   C2.brok1_tableno,   
   C2.brok2_tableno,   
   C2.brok3_tableno,   
   C2.brokernote,   
   C2.other_chrg,   
   C2.brok_scheme,   
   C2.contcharge,   
   C2.mincontamt,   
   C2.addledgerbal,   
   C2.dummy1,   
   C2.dummy2,   
   C2.inscont,   
   C2.sertaxmethod,   
   C2.dummy6,   
   C2.dummy7,   
   C2.dummy8,   
   C2.dummy9,   
   C2.dummy10,   
   C5.activefrom,   
   C5.inactivefrom,   
   Dpf.debitflag,   
   Dpf.interflag,   
   @script_name,   
   @session_id,   
   @local_addr,   
   @remote_addr,   
   @remote_host,   
--   @request_method,   
--   @content_type,   
--   @content_length,   
   @status_name,   
   @user_name,   
--   Getdate(),   
   Left(convert(varchar, Getdate(), 109), 50),   
--   @module,   
   @action   
  From  
   Client2 C2, Client5 C5, Delpartyflag Dpf  
  Where  
   C2.cl_code = C5.cl_code And  
   C2.cl_code = Dpf.party_code And  
   C2.cl_code = @cl_code And   
   C2.party_code = @party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBill
-- --------------------------------------------------

CREATE       PROC    rpt_proc_FO_NewBill    
    
 @ReportName VarChar(50),    
 @StatusID VarChar(20),    
 @StatusName VarChar(50),    
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT    
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS    
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
    
 @FromDate VarChar(11),    
 @ToDate VarChar(11),    
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
 @FromCode VarChar(20),    
 @ToCode VarChar(20),    
    
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES    
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
    
 @OneOrMany VarChar(20),    
    
 @ProductCode VarChar(20),  --]    
 @ProductType VarChar(20), --]    
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.    
 @ExpiryDate VarChar(11), --]    
 @Symbol VarChar(20),  --]    
    
 --REPORT SPECIFIC SEARCH FEILDS    
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]    
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]    
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]    
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]    
 --END REPORT SPECIFIC SEARCH FEILDS    
    
 @WithNetPos VarChar(50),    
 @Dummy002 VarChar(50),    
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),    
 @Dummy005 VarChar(50),    
 @Dummy006 VarChar(50),    
 @Dummy007 VarChar(50),    
 @Dummy008 VarChar(50),    
 @Dummy009 VarChar(50),    
 @Dummy010 VarChar(50)    
AS    
    
Declare    
    
 @strSelect VarChar(8000),    
 @strSelectTemp VarChar(8000),    
 @strFrom VarChar(8000),    
 @strWhere VarChar(8000),    
 @strGroupBy VarChar(8000),    
 @strOrderBy VarChar(8000),    
 @strCompute VarChar(8000),    
 @strComputeSub VarChar(8000),    
    
 @IsSubLevel VarChar(3),    
 @CodeID VarChar(20),    
 @Comma VarChar(1)    
    
 Set @ProductCode = @ProductCode+"%"     
 If @ProductType = '' Begin Set @ProductType = "%" End    
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE    
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End    
 If @Symbol = '' Begin Set @Symbol = "%" End    
     
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End    
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End    
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End    
    
 Set @strSelect = ''    
 Set @strSelectTemp = ''    
 Set @strFrom = ''     
 Set @strWhere = ''    
 Set @strGroupBy = ''    
 Set @strOrderBy = ''    
 Set @strCompute = ''    
 Set @strCompute = ''    
 Set @strComputeSub = ''    
 Set @IsSubLevel = 'YES'    
    
 If (@ReportName = 'BILL')    
 Begin    
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End    
      
  Set @strSelect = @strSelect + "SELECT "    
  Set @strCompute = @strCompute + "COMPUTE "    
    
  --@WhatCode WILL ALWAYS BE 'CLIENT', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  If ((@WhatCode = 'CLIENT') AND (@OneOrMany = 'SUMMARY'))    
  Begin    
   Set @strSelectTemp = ''    
   --@GroupLevel/@SubGroupLevel WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS    
   --PASSES FRM THE ASP PAGE.    
   --THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP    
   --STRUCTURE FOR ALL REPORTS    
   --THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.    
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name, 25) AS party_name, client_type, Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "    
    Set @strComputeSub = @strComputeSub + "party_code "    
   End    
    
   Set @strSelect = @strSelect + @strSelectTemp    
   Set @strSelectTemp = ''    
    
  End /*If (@WhatCode = 'CLIENT')*/    
    
  --@Ex_Rate AND @Ex_ReportBy WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  If (@Ex_Rate = 'MKTRATE')    
  Begin    
   If (@Ex_ReportBy = 'PRICE')    
   Begin    
    --AMT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum((SBillAmt - PBillAmt) - ((service_tax) + (turn_tax) + (sebi_tax) + (broker_note) + "    
    Set @strSelectTemp = @strSelectTemp + " (ins_chrg) + (other_chrg) + (cl_chrg-excl_chrg))) "    
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* AMT */ " --FOR THE SUB TOTAL    
    Set @strSelectTemp = @strSelectTemp + "AS billamt "    
    Set @strSelect = @strSelect + @strSelectTemp    
   End    
  End /*If (@Ex_Rate = 'NETRATE')*/    
    
  Set @strFrom = @strFrom + "FROM "    
  Set @strFrom = @strFrom + "BFoBillValan "    
     
  Set @strWhere = @strWhere + "WHERE "    
    
    
  If (@FromCode = '' AND @ToCode = '')    
  Begin    
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "    
  End    
  Else     
  Begin    
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "    
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "    
  End    
    
  If (@FromDate = '' AND @ToDate = '')    
  Begin    
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "    
  End    
  Else    
  Begin    
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "    
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "    
  End    
    
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))    
  Begin    
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "    
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "    
  End    
    
  /*LOGIN CONDITIONS*/    
  Set @strWhere = @strWhere + "area LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "branch_code LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "    
  /*END - LOGIN CONDITIONS*/    
    
  Set @Comma = ''    
    
    
  Set @strGroupBy = @strGroupBy + @Comma    
    
  --AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))    
  Begin    
   --AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strGroupBy = @strGroupBy + "party_code, Left(party_name, 25), client_type, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date "    
   End    
  End /*If (@OneOrMany = 'DETAIL')*/    
    
  Set @strOrderBy = @strGroupBy    
  Set @strGroupBy = "GROUP BY " + @strGroupBy    
  Set @strOrderBy = "ORDER BY " + @strOrderBy    
    
 End/*If (@ReportName = "NETPOSITION")*/    
    
    
 
    
 If @strComputeSub <> ''     
 Begin     
  Set @strComputeSub = "BY " + @strComputeSub     
  Set @strComputeSub = @strCompute + @strComputeSub    
 End    
    
 If (@IsSubLevel = 'YES')    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)    
 End    
 Else    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)    
 End    
    
 Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBillDetail
-- --------------------------------------------------

CREATE proc    
[dbo].[rpt_proc_FO_NewBillDetail]    
    
 @StatusID VarChar(20),    
 @StatusName VarChar(50),    
    
 @FromDate VarChar(11),    
 @ToDate VarChar(11),    
    
 @FromPartyCode VarChar(20),    
 @ToPartyCode VarChar(20),    
    
 @ClientType VarChar (20),    
    
 @Dummy001 VarChar(50),    
 @Dummy002 VarChar(50),    
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),    
 @Dummy005 VarChar(50),    
 @Dummy006 VarChar(50),    
 @Dummy007 VarChar(50),    
 @Dummy008 VarChar(50),    
 @Dummy009 VarChar(50),    
 @Dummy010 VarChar(50)    
AS    
    
If @ClientType = '' Begin Set @ClientType = '%' End    
If @FromPartyCode = '' Begin Set @FromPartyCode = '%' End    
If @ToPartyCode = '' Begin Set @ToPartyCode = '%' End    
    
If (@FromDate = '' OR @ToDate = '')    
Begin     
 Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From BFoBillValan     
End    
    
If (@FromPartyCode = '' OR @ToPartyCode = '' OR @FromPartyCode = '%' OR @ToPartyCode = '%')    
Begin     
 Select @FromPartyCode = Min(party_code), @ToPartyCode = Max(party_code) From BFoBillValan     
End     
    
SELECT    
 Left(f.party_name, 25) AS party_name,    
 f.party_code,     
 f.client_type,     
 c1.l_address1,     
 c1.l_address2,    
  c1.l_address3,      
  c1.L_city,    
  c1.L_State,    
  c1.L_Nation,    
  c1.L_Zip,    
 c1.res_phone1,    
 Case When Len(c1.email) = 0 Then '_' Else c1.email End AS email,    
 f.product_code,     
 f.series_code,    
 Convert(VarChar, f.expirydate, 103) AS expirydate,    
 f.strike_price,     
 Case When f.product_type = '' Then '' Else f.product_type End AS product_type,    
 Convert(VarChar, f.sauda_date, 103) AS saudadate,    
 Cl_Rate AS closingrate,     
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End End AS prate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End End AS srate,    
    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,    
    
 Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End AS pbillamt,    
 Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End AS sbillamt,    
 Sum((f.pbillamt)) - Sum((f.sbillamt) ) AS diff,    
 Sum(((f.cl_chrg - f.excl_chrg) + (f.service_tax - f.exser_tax) + (f.sebi_tax) + (f.turn_tax) + (f.broker_note) + (f.ins_chrg) + (f.other_chrg)) ) AS chrg_total,    
 Sum((f.pbillamt) + ((f.service_tax) + (f.turn_tax) + (f.sebi_tax) + (f.broker_note) +  (f.ins_chrg) + (f.other_chrg) + (f.cl_chrg-f.excl_chrg)) ) - Sum((f.sbillamt)  ) AS finalfigure,    
    
 Sum(((f.cl_chrg - f.excl_chrg)) ), /* CLEARING CHARGES */    
 Sum(((f.service_tax - f.exser_tax)) ), /* SERVICE TAX */    
 Sum(((f.sebi_tax)) ), /* SEBI TAX */    
 Sum(((f.turn_tax)) ), /* TURNOVER TAX */    
 Sum(((f.broker_note)) ), /* STAMP DUTY */    
 Sum(((f.ins_chrg)) ), /* INS CHARGES */    
 Sum(((f.other_chrg)) ), /* OTHERCHARGES */    
    
 Case When f.tradetype = 'BF' Then '<FONT Style="COLOR: #ff0000;">' + f.tradetype + '</FONT>'     
               Else Case When AuctionPart = 'EA' And product_code Like 'FUT%'     
                                  Then '<FONT Style="COLOR:BLUE;">' + 'FF'  + '</FONT>'     
        Else Case When AuctionPart = 'EA' And product_code Like 'OPT%'     
                                                     Then '<FONT Style="COLOR:GREEN;">' + 'EA'  + '</FONT>'     
                           Else f.tradetype     
                 End     
                                  End     
               End AS tradetype,    
 Case When f.tradetype = 'BF' Then f.tradetype    
               Else Case When AuctionPart = 'EA' And product_code Like 'FUT%'     
                                  Then  'FF'     
        Else Case When AuctionPart = 'EA' And product_code Like 'OPT%'     
                                                     Then  'EA'     
                           Else f.tradetype     
                 End     
                                  End     
               End AS tradetypeprint    
FROM    
 BFoBillValan F,     
 client1 c1,     
 client2 c2    
    
WHERE    
 c1.cl_code = c2.cl_code AND    
 c2.party_code = f.party_code AND    
 f.client_type LIKE @ClientType AND    
 f.party_code >= @FromPartyCode AND    
 f.party_code <= @ToPartyCode AND    
 f.sauda_date >= @FromDate + ' 00:00:00' AND    
 f.sauda_date <= @ToDate + ' 23:59:59' AND    
 f.tradetype like (Case When product_code Like 'OPT%' Then 'BT' Else '%' End ) and    
  C1.Branch_Cd Like (Case When @StatusId = 'branch' Then @statusname else '%' End) AND     
  C1.sub_broker Like (Case When @StatusId = 'subbroker' Then @statusname else '%' End) AND     
  C1.trader Like (Case When @StatusId = 'trader' Then @statusname else '%' End) AND     
  C1.family Like (Case When @StatusId = 'family' Then @statusname else '%' End) AND     
  C2.party_code Like (Case When @StatusId = 'client' Then @statusname else '%' End)     
    
GROUP BY     
 f.party_code,     
 f.party_name,     
 f.client_type,     
 f.series_code,     
 f.product_code,     
 f.expirydate,     
 f.strike_price,     
 f.product_type,    
 c1.l_address1,     
 c1.l_address2,     
 f.tradetype,     
 c1.res_phone1,    
 f.sauda_date,    
 c1.email,    
 cl_rate,    
 AuctionPart,    
  c1.l_address3,      
  c1.L_city,    
  c1.L_State,    
  c1.L_Nation,    
  c1.L_Zip    
    
    
    
ORDER BY     
 f.party_code,     
 f.party_name,     
 f.client_type,     
 f.series_code,     
 f.product_code,     
 f.expirydate,     
 f.strike_price,     
 f.product_type,     
 f.tradetype,     
 f.sauda_date    
    
COMPUTE    
 Sum(Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End), /* PAMT */     
 Sum(Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End), /* SAMT */    
 Sum(Sum((f.pbillamt) ) - Sum((f.sbillamt) )),  /*DIFF = PAMT-SAMT*/    
 Sum(Sum(((f.cl_chrg - f.excl_chrg) + (f.service_tax - f.exser_tax) + (f.sebi_tax) + (f.turn_tax) + (f.broker_note) + (f.ins_chrg) + (f.other_chrg)) )), /* TOTAL OF CHARGES */    
 Sum(Sum((f.pbillamt) + ((f.service_tax) + (f.turn_tax) + (f.sebi_tax) + (f.broker_note) +  (f.ins_chrg) + (f.other_chrg) + (f.cl_chrg-f.excl_chrg)) ) - Sum((f.sbillamt)  )), /* DIFF - TOTAL OF CHARGES */    
 Sum(Sum(((f.cl_chrg - f.excl_chrg)) )), /* TOTAL OF CLEARING CHARGES */    
 Sum(Sum(((f.service_tax - f.exser_tax)) )), /* TOTAL OF SERVICE TAX */    
 Sum(Sum(((f.sebi_tax)) )), /* TOTAL OF SEBI TAX */    
 Sum(Sum(((f.turn_tax)) )), /* TOTAL OF TURNOVER TAX */    
 Sum(Sum(((f.broker_note)) )), /* TOTAL OF STAMP DUTY */    
 Sum(Sum(((f.ins_chrg)) )), /* TOTAL OF INS CHARGES */    
 Sum(Sum(((f.other_chrg)) )) /* TOTAL OF OTHERCHARGES */    
    
 BY f.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBillDetail_New
-- --------------------------------------------------




CREATE   PROC      
rpt_proc_FO_NewBillDetail_New      
      
 @StatusID VarChar(20),      
 @StatusName VarChar(50),      
      
 @FromDate VarChar(11),      
 @ToDate VarChar(11),      
      
 @FromPartyCode VarChar(20),      
 @ToPartyCode VarChar(20),      
      
 @ClientType VarChar (20),      
      
 @Dummy001 VarChar(50),      
 @Dummy002 VarChar(50),      
 @Dummy003 VarChar(50),      
 @Dummy004 VarChar(50),      
 @Dummy005 VarChar(50),      
 @Dummy006 VarChar(50),      
 @Dummy007 VarChar(50),      
 @Dummy008 VarChar(50),      
 @Dummy009 VarChar(50),      
 @Dummy010 VarChar(50)      
AS      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

      
If @ClientType = '' Begin Set @ClientType = '%' End      
If @FromPartyCode = '' Begin Set @FromPartyCode = '%' End      
If @ToPartyCode = '' Begin Set @ToPartyCode = '%' End      
      
If (@FromDate = '' OR @ToDate = '')      
Begin       
 Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), 
	@ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From BFoBillValan       
End      
      
If (@FromPartyCode = '' OR @ToPartyCode = '' OR @FromPartyCode = '%' OR @ToPartyCode = '%')      
Begin       
 Select @FromPartyCode = Min(party_code), @ToPartyCode = Max(party_code) From BFoBillValan       
End       
      
SELECT      
 Left(C1.Long_name, 25) AS party_name,      
 f.party_code,       
 C1.cl_type,       
 c1.l_address1,       
 c1.l_address2,      
 c1.l_address3,      
 c1.L_city,    
 c1.L_State,    
 c1.L_Nation,    
 c1.L_Zip,    
 c1.res_phone1,      
 Case When Len(c1.email) = 0 Then '_' Else c1.email End AS email,      
 f.Product_Code,       
 f.Series_Code,      
 Convert(VarChar, f.expirydate, 103) AS expirydate,      
 f.strike_price,       
 Case When f.Product_Type = '' Then '' Else f.Product_Type End AS Product_Type,      
 Convert(VarChar, f.billdate, 103) AS saudadate,      
 f.Cl_Rate AS ClosingRate,      
 Case When Sum(pqty)-Sum(Sqty) > 0 Then (Netwithbrok) Else 0 End AS prate,      
 Case When Sum(pqty)-Sum(Sqty) < 0 Then (Netwithbrok) Else 0 End AS srate,      
 (Case When Sum(pqty)-Sum(Sqty) > 0 Then Sum(pqty)-Sum(Sqty) Else 0 End) AS pqty,      
 (Case When Sum(pqty)-Sum(Sqty) < 0 Then Abs(Sum(pqty)-Sum(Sqty)) Else 0 End) AS sqty,          
 Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) > 0     
      Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))    
      Else 0     
 End      
 AS sbillamt,      
 Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) < 0     
      Then Abs(Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)))    
      Else 0     
 End      
 AS pbillamt ,    
 Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS diff,    
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) AS chrg_total,      
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) - Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS finalfigure,        
   0 clchrg, /* CLEARING CHARGES */      
   Sum(Service_Tax), /* SERVICE TAX */      
   Sum(f.sebi_tax), /* SEBI TAX */      
   Sum(f.turn_tax), /* TURNOVER TAX */      
   Sum(f.stampduty), /* STAMP DUTY */      
   Sum(f.insurance_chrg), /* INS CHARGES */      
   Sum(f.other_chrg), /* OTHERCHARGES */            
 Case When f.bfdayflag = 'B-F' Then '<FONT Style="COLOR: #ff0000;">' + f.bfdayflag + '</FONT>'       
        Else Case When AuctionPart = 'EA' And f.Product_Code Like 'FUT%'       
            Then '<FONT Style="COLOR:BLUE;">' + 'FF'  + '</FONT>'       
        Else Case When AuctionPart = 'EA' And f.Product_Code Like 'OPT%'       
            Then '<FONT Style="COLOR:GREEN;">' + 'EA'  + '</FONT>'       
                  Else f.bfdayflag       
             End       
       End       
        End AS tradetype,      
 Case When f.bfdayflag = 'B-F' Then  f.bfdayflag 
        Else Case When AuctionPart = 'EA' And f.Product_Code Like 'FUT%'       
	     Then  'FF' 
        Else Case When AuctionPart = 'EA' And f.Product_Code Like 'OPT%'       
                Then  'EA'
        Else f.bfdayflag       
                End       
        End       
        End AS tradetypeprint     
FROM      
	tbl_mtompremiumbill F (nolock),       
	client1 c1 (nolock),       
	client2 c2 (nolock)      
WHERE      
	c1.cl_code = c2.cl_code AND      
	c2.party_code = f.party_code AND       
	f.party_code >= @FromPartyCode AND      
	f.party_code <= @ToPartyCode AND      
	f.billdate >= @FromDate + ' 00:00:00' AND      
	f.billdate <= @ToDate + ' 23:59:59' AND    
	@statusName = (case 	when @Statusid = 'branch' then isnull(c1.branch_cd,'')
				when @Statusid = 'subbroker' then isnull(c1.sub_broker,'')
				when @Statusid = 'trader' then isnull(c1.trader,'')
				when @Statusid = 'family' then isnull(c1.Family,'')
				when @Statusid = 'area' then isnull(c1.area,'')
				when @Statusid = 'region' then isnull(c1.region,'')
				when @Statusid = 'client' then isnull(c2.party_code,'')
				when @Statusid = 'broker' then @statusname
			end)
	
Group By      
	f.party_code,       
	c1.long_name,       
	c1.cl_type,       
	f.Series_Code,       
	f.Product_Code,       
	f.expirydate,       
	f.strike_price,       
	f.Product_Type,       
	f.bfdayflag,       
	f.billdate,    
	C1.Email,    
	F.AuctionPart,    
	C1.L_Address1,    
	C1.L_Address2,    
	C1.L_Address3,    
	c1.L_city,    
	c1.L_State,    
	c1.L_Nation,    
	c1.L_Zip,    
	C1.Res_Phone1,    
	Cl_Rate,    
	Netwithbrok  ,
 Case When f.bfdayflag <> 'B-F' then PQty else '' end,
 Case When f.bfdayflag <> 'B-F' then sQty else '' end

    
Having Case When  bfdayflag = 'B-F' Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))  Else 1 End <> 0
OR
Case When  bfdayflag = 'B-F' Then Sum(SQty-PQty)  Else 1 End <> 0
    
ORDER BY       
	f.party_code,       
	c1.long_name,       
	c1.cl_type,       
	f.Series_Code,       
	f.Product_Code,       
	f.expirydate,       
	f.strike_price,       
	f.Product_Type,       
	f.bfdayflag DESC,       
	f.billdate       
    
COMPUTE      
 Sum(Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) < 0     
      Then Abs(Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)))    
      Else 0     
 End), /* PAMT */      
 Sum(Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) > 0     
      Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))    
      Else 0     
 End), /* SAMT */       

 Sum(Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))),  /*DIFF = PAMT-SAMT*/      
    
 Sum(Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)), /* TOTAL OF CHARGES */      
 Sum(Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg) - Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))), /* DIFF - TOTAL OF CHARGES */      
 Sum(0), /* TOTAL OF CLEARING CHARGES */      
 Sum(Sum(Service_Tax)), /* TOTAL OF SERVICE TAX */      
 Sum(Sum(f.sebi_tax)), /* TOTAL OF SEBI TAX */      
 Sum(Sum(f.turn_tax)), /* TOTAL OF TURNOVER TAX */      
 Sum(Sum(f.stampduty)), /* TOTAL OF STAMP DUTY */      
 Sum(Sum(f.insurance_chrg)),/* TOTAL OF INS CHARGES */      
 Sum(Sum(f.Other_Chrg)) /* TOTAL OF OTHERCHARGES */       
   
 BY f.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary
-- --------------------------------------------------

CREATE proc    
rpt_proc_FO_NewClientSummary    
 @ReportName VarChar(50),    
 @StatusID VarChar(20),    
 @StatusName VarChar(50),    
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT    
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS    
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @FromDate VarChar(11),    
 @ToDate VarChar(11),    
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
 @FromCode VarChar(20),    
 @ToCode VarChar(20),    
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES    
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
 @OneOrMany VarChar(20),    
 @Productcode VarChar(20),  --]    
 @ProductType VarChar(20), --]    
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.    
 @ExpiryDate VarChar(11), --]    
 @Series_code VarChar(20),  --]    
 --REPORT SPECIFIC SEARCH FEILDS    
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]    
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]    
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]    
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]    
 --END REPORT SPECIFIC SEARCH FEILDS    
 @WithNetPos VarChar(50),    
 @Dummy002 VarChar(50),    
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),    
 @Dummy005 VarChar(50),    
 @Dummy006 VarChar(50),    
 @Dummy007 VarChar(50),    
 @Dummy008 VarChar(50),    
 @Dummy009 VarChar(50),    
 @Dummy010 VarChar(50)    
AS    
Declare    
 @strSelect VarChar(8000),    
 @strSelectTemp VarChar(8000),    
 @strFrom VarChar(8000),    
 @strWhere VarChar(8000),    
 @strGroupBy VarChar(8000),    
 @strOrderBy VarChar(8000),    
 @strCompute VarChar(8000),    
 @strComputeSub VarChar(8000),    
 @IsSubLevel VarChar(3),    
 @CodeID VarChar(20),    
 @Comma VarChar(1)    
 Set @Productcode = @Productcode+"%"     
 If @ProductType = '' Begin Set @ProductType = "%" End    
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE    
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End    
 If @Series_code = '' Begin Set @Series_code = "%" End    
     
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End    
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End    
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End    
 Set @strSelect = ''    
 Set @strSelectTemp = ''    
 Set @strFrom = ''    
 Set @strWhere = ''    
 Set @strGroupBy = ''    
 Set @strOrderBy = ''    
 Set @strCompute = ''    
 Set @strCompute = ''    
 Set @strComputeSub = ''    
 Set @IsSubLevel = 'NO'    
 If (@ReportName = 'CLIENTSUMMARY')    
 Begin   
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End    
      
  Set @strSelect = @strSelect + "SELECT "    
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))    
  Begin    
   Set @strSelectTemp = ''    
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strSelectTemp = @strSelectTemp + "party_code, party_name AS party_name, client_type, email, "    
   End    
   Set @strSelect = @strSelect + @strSelectTemp    
   Set @strSelectTemp = ''    
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))*/    
  --@Ex_Rate AND @Ex_ReportBy WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS    
  --PASSES FRM THE ASP PAGE.    
  --THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP    
  --STRUCTURE FOR ALL REPORTS    
  If (@Ex_Rate = 'MKTRATE')    
  Begin    
   If (@Ex_ReportBy = 'PRICE')    
   Begin    
    --DAILY MARK TO MARKET SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND product_code LIKE 'FUT%') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS dailymtomsettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --FINAL FUTURES SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND product_code LIKE 'FUT%') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS finalfuturessettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --PREMIUM SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND product_code LIKE 'OPT%' And TradeType = 'BT') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS premiumsettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --OPTIONS EXERCISE/ASSIGNMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND product_code LIKE 'OPT%' And TradeType = 'BT') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS optionsexerciseassignment, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --BROKERAGE + ALL CHARGES EXCEPT CLEARING    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "-(Sum(pbrokamt + sbrokamt) + Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) "    
    Set @strSelectTemp = @strSelectTemp + "+ Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "    
    Set @strSelectTemp = @strSelectTemp + "AS brokandmisc, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --CLEARING CHARGES    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "-(Sum(cl_chrg) - Sum(ExCl_Chrg)) "    
    Set @strSelectTemp = @strSelectTemp + "AS clearingcharges "    
    Set @strSelect = @strSelect + @strSelectTemp    
   End    
  End /*If (@Ex_Rate = 'NETRATE')*/    
  If (@Ex_Rate = 'NETRATE')    
  Begin    
   If (@Ex_ReportBy = 'PRICE')    
   Begin    
    --DAILY MARK TO MARKET SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND product_code LIKE 'FUT%') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS dailymtomsettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --FINAL FUTURES SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND product_code LIKE 'FUT%') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS finalfuturessettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --PREMIUM SETTLEMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND product_code LIKE 'OPT%' And TradeType = 'BT') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS premiumsettlement, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --OPTIONS EXERCISE/ASSIGNMENT    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND product_code LIKE 'OPT%' And TradeType = 'BT') Then "    
    Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "    
    Set @strSelectTemp = @strSelectTemp + "AS optionsexerciseassignment, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --BROKERAGE + ALL CHARGES EXCEPT CLEARING    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "-(Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) "    
    Set @strSelectTemp = @strSelectTemp + "+ Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "    
    Set @strSelectTemp = @strSelectTemp + "AS brokandmisc, "    
    Set @strSelect = @strSelect + @strSelectTemp    
    --CLEARING CHARGES    
    Set @strSelectTemp = ''    
    Set @strSelectTemp = @strSelectTemp + "-(Sum(cl_chrg) - Sum(ExCl_Chrg)) "    
    Set @strSelectTemp = @strSelectTemp + "AS clearingcharges "    
    Set @strSelect = @strSelect + @strSelectTemp    
   End    
  End /*If (@Ex_Rate = 'NETRATE')*/    
  Set @strFrom = @strFrom + "FROM "    
  Set @strFrom = @strFrom + "bfobillvalan  "    
     
  Set @strWhere = @strWhere + "WHERE "    
  If (@FromCode = '' AND @ToCode = '')    
  Begin    
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "    
  End    
  Else    
  Begin    
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "    
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "    
  End    
  If (@FromDate = '' AND @ToDate = '')    
  Begin    
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "    
  End    
  Else    
  Begin    
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "    
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "    
  End    
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))    
  Begin    
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "    
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "    
  End    
  /*LOGIN CONDITIONS*/    
  Set @strWhere = @strWhere + "area LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "branch_code LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "    
  Set @strWhere = @strWhere + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "    
  /*END - LOGIN CONDITIONS*/    
  Set @Comma = ''    
  Set @strGroupBy = @strGroupBy + @Comma    
  --AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))    
  Begin    
   --AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT     
   If (@GroupLevel = 'PARTY')    
   Begin    
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "    
    Set @Comma = ', '    
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_code, product_code, expirydate, strike_price, Product_type " End    
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End    
    If (@GroupSubLevel = 'Productcode') Begin Set @strGroupBy = @strGroupBy + @Comma + "product_code " End    
   End    
  End /*If (@OneOrMany = 'DETAIL')*/    
  Set @strOrderBy = @strGroupBy    
  Set @strGroupBy = "GROUP BY " + @strGroupBy    
  Set @strOrderBy = "ORDER BY " + @strOrderBy    
 End/*If (@ReportName = "NETPOSITION")*/    
 If @strComputeSub <> ''     
 Begin     
  Set @strComputeSub = "BY " + @strComputeSub     
  Set @strComputeSub = @strCompute + @strComputeSub    
 End    
 If (@IsSubLevel = 'YES')    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)    
 End    
 Else    
 Begin    
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)    
 End    
 Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary_Ledger
-- --------------------------------------------------


CREATE  proc [dbo].[rpt_proc_FO_NewClientSummary_Ledger]  
@PARTY_CODE VARCHAR(10),@RPTDATE VARCHAR(11),@EXCHANGE VARCHAR(3),@SEGMENT VARCHAR(10)      
AS      
      
DECLARE       
@OPENBALANCE  MONEY,      
@LEDBALANCE   MONEY,      
@PAYREC       MONEY,      
@MINLEDBAL   MONEY,      
@MINMARGIN   MONEY,      
@MARGIN           MONEY,      
@AVLCOLL      MONEY,      
@SPANMAR      MONEY,      
@VARMARGIN     MONEY,      
@TOTCASH     MONEY,      
@TOTNONCASH   MONEY,      
@TOTCOLL  MONEY,      
@EFFCOLL    MONEY,      
@SPREADMARGIN MONEY,      
@NONSPREADMARGIN MONEY,      
@MarginPer MONEY,      
@DATACUR   CURSOR      
      
      
SET @LEDBALANCE   = 0       
SET @PAYREC       = 0       
SET @MINLEDBAL   = 0      
SET @AVLCOLL      = 0       
SET @SPANMAR      = 0       
SET @VARMARGIN       = 0       
SET @TOTCASH     = 0       
SET @TOTNONCASH      = 0       
SET @TOTCOLL    = 0       
SET @EFFCOLL      = 0       
SET @MINMARGIN = 0      
SET @SPREADMARGIN =0    
SET @NONSPREADMARGIN =0  
     
/* LEDGER BALANCE */      
SELECT @LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L, ACCOUNTBFO.DBO.PARAMETER P      
WHERE VDT < @RPTDATE AND VDT >= SDTCUR AND VDT<= ldtcur      
AND CLTCODE = @PARTY_CODE And @RPTDATE BetWeen SDTCUR And ldtcur       
      
/* OPEN BALANCE */      
SELECT @OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L      
WHERE VDT LIKE @RPTDATE + '%' AND VTYP = 18 AND CLTCODE = @PARTY_CODE       
      
SELECT @LEDBALANCE = @LEDBALANCE + @OPENBALANCE      
      
/* PAYMENT RECEIVED FOR THE DAY */      
SELECT @PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTBFO.DBO.LEDGER L WHERE VDT LIKE @RPTDATE + '%' AND CLTCODE = @PARTY_CODE       
AND VTYP NOT IN (15,18)      
      
/* MARGIN AMOUNT */      
SELECT @MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)      
FROM ACCOUNTBFO.DBO.MARGINLEDGER L, ACCOUNTBFO.DBO.PARAMETER P  WHERE VDT <= @RPTDATE + ' 23:59' AND PARTY_CODE = @PARTY_CODE       
AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VDT < @RPTDATE AND VDT >= SDTCUR AND CURYEAR = 1       
      
      
/* COLLATERAL DETAILS */      
SELECT @TOTCASH = ISNULL(SUM(CASH),0), @TOTNONCASH = ISNULL(SUM(NONCASH),0), @TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),       
@EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), @AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0) FROM MSAJAG.DBO.COLLATERAL       
WHERE PARTY_CODE = @PARTY_CODE AND TRANS_DATE LIKE @RPTDATE + '%' AND EXCHANGE = @EXCHANGE      
AND SEGMENT = @SEGMENT       
SELECT @MarginPer = 0       

/* SPAN AND VAR MARGIN */    
SELECT 
@SPANMAR = 0, 
@VARMARGIN = ISNULL(SUM(init_margin),0) , 
@SPREADMARGIN = 0, 
@NONSPREADMARGIN = 0,
@MARGIN = ISNULL(SUM(init_margin),0)
 FROM BFOMARGINCOLL
WHERE file_date LIKE @RPTDATE + '%' AND PARTY_CODE = @PARTY_CODE AND CL_TYPE like 'N%'   

          
If @MarginPer = 0 OR @MarginPer Is Null      
 SELECT @MarginPer = 100      
      
SELECT       
PARTY_CODE              = @PARTY_CODE,      
MARGINDATE                = @RPTDATE,       
LEDBALANCE  = @LEDBALANCE,      
PAYREC   = @PAYREC,      
MINLEDBAL         = @MINLEDBAL,      
MINMARGIN        = @SPREADMARGIN + @NONSPREADMARGIN + @VARMARGIN,      
MARGIN              = @MARGIN,      
AVLCOLL  = @AVLCOLL,      
SPANMAR  = @SPANMAR,      
VARMARGIN   = @VARMARGIN,      
TOTCASH  = @TOTCASH,      
TOTCOLLNONCASH        = @TOTNONCASH,      
TOTNONCASH  = Case When @LEDBALANCE + @PAYREC + @TOTCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
    Then Case When @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          Then @LEDBALANCE + @TOTCASH      
          Else @TOTNONCASH       
             End      
    Else                Case When @TOTNONCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)          
                     Then abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
          Else @TOTNONCASH       
             End       
        End,      
TOTCOLL  = @TOTCOLL,      
EFFCOLL  = Case When @LEDBALANCE + @PAYREC + @TOTCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
    Then Case When @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          Then @LEDBALANCE + @TOTCASH      
          Else @TOTNONCASH       
             End      
    Else      
            Case When @TOTNONCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
                     Then abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
          Else @TOTNONCASH       
             End       
        End + @TOTCASH ,      
SPREADMARGIN  = @SPREADMARGIN+ @VARMARGIN,      
NONSPREADMARGIN = @NONSPREADMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary_NetPos
-- --------------------------------------------------

CREATE proc  
[dbo].[rpt_proc_FO_NewClientSummary_NetPos]  
 @StatusID VarChar(20),  
 @StatusName VarChar(50),  
 @SaudaDate VarChar(11),  
 @PartyCode VarChar(20),  
 @Dummy001 VarChar(50),  
 @Dummy002 VarChar(50),  
 @Dummy003 VarChar(50),  
 @Dummy004 VarChar(50),  
 @Dummy005 VarChar(50)  
AS  
 SELECT  
  product_code, series_Code,   
  Left(expirydate,11) AS expirydate,   
  strike_price,   
  product_type,   
  Sum(pqty-sqty) AS openposition,  
  Sum(sbillamt-pbillamt) - (Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg))  AS profitorloss  
 FROM  
  Bfobillvalan  
 WHERE  
  party_code = @PartyCode AND  
  sauda_date LIKE @SaudaDate + '%'  
 GROUP BY  
  product_code, series_Code, expirydate, strike_price, product_type     
 HAVING Sum(pqty-sqty) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewInTheMoney
-- --------------------------------------------------

CREATE     PROC        
rpt_proc_FO_NewInTheMoney        
 @ReportName VarChar(50),        
 @StatusID VarChar(20),        
 @StatusName VarChar(50),        
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT        
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FromDate VarChar(11),        
 @ToDate VarChar(11),        
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FromCode VarChar(20),        
 @ToCode VarChar(20),        
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @OneOrMany VarChar(20),        
 @ProductCode VarChar(20),  --]        
 @ProductType VarChar(20), --]        
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.        
 @ExpiryDate VarChar(11), --]        
 @SeriesCode VarChar(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]        
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @Dummy001 VarChar(50),        
 @Dummy002 VarChar(50),        
 @Dummy003 VarChar(50),        
 @Dummy004 VarChar(50),        
 @Dummy005 VarChar(50),        
 @Dummy006 VarChar(50),        
 @Dummy007 VarChar(50),        
 @Dummy008 VarChar(50),        
 @Dummy009 VarChar(50),        
 @Dummy010 VarChar(50)        
AS        
Declare        
 @strSelect VarChar(8000),        
 @strSelectTemp VarChar(8000),        
 @strFrom VarChar(8000),        
 @strWhere VarChar(8000),        
 @strGroupBy VarChar(8000),        
 @strOrderBy VarChar(8000),        
 @strCompute VarChar(8000),        
 @strComputeSub VarChar(8000),        
 @IsSubLevel VarChar(3),        
 @CodeID VarChar(20),        
 @Comma VarChar(1)        
 Set @ProductCode = @ProductCode+"%"         
 If @ProductType = '' Begin Set @ProductType = "%" End        
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE        
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End        
 If @SeriesCode = '' Begin Set @SeriesCode = "%" End        
         
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End        
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End        
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End        
 Set @strSelect = ''        
 Set @strSelectTemp = ''        
 Set @strFrom = ''        
 Set @strWhere = ''        
 Set @strGroupBy = ''        
 Set @strOrderBy = ''        
 Set @strCompute = ''        
 Set @strCompute = ''        
 Set @strComputeSub = ''        
 Set @IsSubLevel = 'NO'        
 If (@FromDate = '' AND @ToDate = '')        
 Begin         
  Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From BFoBillValan         
 End         
 If (@ReportName = 'INTHEMONEY')        
 Begin        
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End        
  If (@WhatCode = 'AREA') Begin Set @CodeID = 'area' End        
  If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End        
  If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End        
  If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End        
  If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End        
  If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End        
          
  Set @strSelect = @strSelect + "SELECT "        
  Set @strCompute = @strCompute + "COMPUTE "        
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))        
  Begin        
   Set @strSelectTemp = ''        
   If (@GroupLevel = 'PARTY')        
  Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_Type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
            
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "party_code "        
    End        
   End        
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Series_Code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_Type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "Series_Code, product_code, expirydate, strike_price, product_type, "        
    End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_Type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "sauda_date "        
    End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "product_code, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_Type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "product_code, "        
    End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, Series_Code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "        
    Set @strSelectTemp = @strSelectTemp + "Product_Type, Convert(VarChar,sauda_date,103) AS sauda_date, "        
    Set @IsSubLevel = 'YES'        
   End        
   Set @strSelect = @strSelect + @strSelectTemp        
   Set @strSelectTemp = ''        
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
   If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,25) AS party_name, client_type, email, " End        
   If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "area, " End        
   If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End        
   If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End        
   If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End        
   If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End        
  End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
          
  If (@Ex_Rate = 'MKTRATE')        
  Begin        
   --If (@Ex_ReportBy = 'BOTH') ARE OMITED        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " Sum(pqty) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* P.QTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
          
    --SQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(sqty) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* S.QTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS sqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --CLOSING RATE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " Sum(cmclosing) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSING RATE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS closingrate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Abs(Sum((cmclosing-strike_price)))) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET RATE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netrate, "        
    Set @strSelect = @strSelect + @strSelectTemp     
    --SETTLEMENT AMT.        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Abs(Sum((cmclosing-strike_price))) * (Sum(pqty) - Sum(sqty))) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* SETTLEMENT AMT. */ " --FOR THE SUB TOTAL - LAST ONE W/O THE COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS settlementamt "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/         
  Set @strSelectTemp = ""        
          
  Set @strFrom = @strFrom + "FROM "        
  Set @strFrom = @strFrom + "BFoBillValan "        
         
  Set @strWhere = @strWhere + "WHERE "        
         
  /* MONEY TYPE OPTIONS */        
  If (@Ex_MoneyType = "I")        
  Begin        
   Set @strWhere = @strWhere + "Convert(money, cmclosing) > Convert(money, strike_price) AND "        
  End        
  If (@Ex_MoneyType = "O")        
  Begin        
   Set @strWhere = @strWhere + "Convert(money, cmclosing) < Convert(money, strike_price) AND "        
  End        
  If (@Ex_MoneyType = "A")        
  Begin        
   Set @strWhere = @strWhere + "Convert(money, cmclosing) = Convert(money, strike_price) AND "        
  End        
  If (@Ex_Position = "L")        
  Begin        
   Set @strWhere = @strWhere + "pqty > 0 AND sqty = 0 AND "        
  End        
  If (@Ex_Position = "S")        
  Begin        
   Set @strWhere = @strWhere + "sqty > 0 AND pqty = 0 AND "        
  End        
  /* END POSITION TYPE OPTIONS */        
  Set @strWhere = @strWhere + "ltrim(right(product_code,3)) LIKE '" + @ProductCode + "' AND "        
  Set @strWhere = @strWhere + "product_type LIKE '" + @ProductType + "' AND "        
  If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End        
  Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "        
  Set @strWhere = @strWhere + "Series_Code LIKE '" + @SeriesCode + "' AND /*expirydate >= getdate() AND*/ "        
  If (@FromCode = '' AND @ToCode = '')        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "        
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "        
  End        
  If (@FromDate = '' AND @ToDate = '')        
  Begin        
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "        
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "        
  End        
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))        
  Begin        
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "        
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "        
  End        
  /*LOGIN CONDITIONS*/        
  Set @strWhere = @strWhere + "area LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "branch_code LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "        
  /*END - LOGIN CONDITIONS*/        
  Set @Comma = ''        
  Set @strGroupBy = @strGroupBy + @Comma        
          
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))        
  Begin        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "product_code " End        
   End        
           
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Series_Code, product_code, expirydate, strike_price, product_type, "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "product_code "*/ End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "sauda_date "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "product_code " End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strGroupBy = @strGroupBy + "product_code "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, Series_Code, product_code, expirydate, strike_price, "        
    Set @strGroupBy = @strGroupBy + "Product_Type ,sauda_date "        
   End        
  End /*If (@OneOrMany = 'DETAIL')*/        
  Else /*If (@OneOrMany = 'DETAIL')*/        
  Begin /*Else OF If (@OneOrMany = 'DETAIL')*/        
   If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End        
   If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "area " End        
   If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End        
   If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End        
   If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End        
   If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End        
  End /*Else OF If (@OneOrMany = 'DETAIL')*/        
  Set @strOrderBy = @strGroupBy        
  Set @strGroupBy = "GROUP BY " + @strGroupBy + " Having Sum(pqty) - Sum(sqty) <> 0 "        
  Set @strOrderBy = "ORDER BY " + @strOrderBy        
 End/*If (@ReportName = "NETPOSITION")*/        
 If @strComputeSub <> ''         
 Begin         
  Set @strComputeSub = "BY " + @strComputeSub         
  Set @strComputeSub = @strCompute + @strComputeSub        
 End        
 If (@IsSubLevel = 'YES')        
 Begin        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)        
 End        
 Else        
 Begin        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)        
 End        
 Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewM2M
-- --------------------------------------------------


Create      PROC          
rpt_proc_FO_NewM2M          
          
 @ReportName VarChar(50),          
 @StatusID VarChar(20),          
 @StatusName VarChar(50),          
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT          
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS          
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY          
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY          
          
 @FromDate VarChar(11),          
 @ToDate VarChar(11),          
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT          
 @FromCode VarChar(20),          
 @ToCode VarChar(20),          
          
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES          
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'          
          
 @OneOrMany VarChar(20),          
          
 @ProductCode VarChar(20),  --]          
 @ProductType VarChar(20), --]          
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.          
 @ExpiryDate VarChar(11), --]          
 @SeriesCodel VarChar(20),  --]          
          
 --REPORT SPECIFIC SEARCH FEILDS          
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)              
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]          
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]          
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC          
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS          
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]          
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]          
 --END REPORT SPECIFIC SEARCH FEILDS          
          
 @M2MType VarChar(50),          
 @M2MFor VarChar(50),          
 @Dummy003 VarChar(50),          
 @Dummy004 VarChar(50),          
 @Dummy005 VarChar(50),          
 @Dummy006 VarChar(50),          
 @Dummy007 VarChar(50),          
 @Dummy008 VarChar(50),          
 @Dummy009 VarChar(50),          
 @Dummy010 VarChar(50)          
AS          
          
 Declare   @MemberCode Varchar(15)          
          
 Select @MemberCode = MemberCode From bFoOwner           
          
 Set @ProductCode = @ProductCode +'%'           
 If @ProductType = '' Begin Set @ProductType = '%' End          
 If @ExpiryDate = '' Begin Set @ExpiryDate = '%' End          
 If @SeriesCodel = '' Begin Set @SeriesCodel = '%' End          
           
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = '%' End          
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = '%' End          
 If @Ex_Rate = '' Begin Set @Ex_Rate = '%' End          
          
 If @M2MType = 'M2M'           
  Set @ProductCode = '%FUT'             
          
 If @M2MType = 'PRE'           
 Begin          
  Set @ProductCode = '%OPT'           
  Set @Ex_AuctionPart = '%'          
 End          
          
          
 If (@ReportName = 'M2M')          
 Begin          
  If (@Ex_Rate = 'MKTRATE')          
  Begin          
   If (@Ex_ReportBy = 'PRICE')          
   Begin          
    --If @M2MType = 'ALL'          
    --Begin          
     If @M2MFor = 'SCRIP'          
     Begin          
      Print 'IN ' + @M2MType + ' -- ' + @M2MFor          
      SELECT          
       ISNULL(bfoe.bfoea_series_code, bfob.series_code) AS series_code,           
       ISNULL(bfoe.bfoea_Product_code,bfob.product_code) AS product_code,           
       ISNULL(Left(Convert(VarChar, bfoe.bfoea_expirydate, 109),11), Left(Convert(VarChar, bfob.expirydate, 109),11)) AS expiry_date,           
       ISNULL(bfoe.bfoea_strike_price, bfob.strike_price) AS strike_price,           
       ISNULL(bfoe.bfoea_Product_Type, bfob.product_type) AS product_type,           
          
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)) AS sauda_date,          
          
       ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0) AS m_exe,          
       ISNULL(bfoe.bfoea_NetPremium,0) AS m_prem,          
       ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0) AS m_daily,          
                 
       Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,          
       Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem,           
       Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily,          
                
       0 diff_exe,0 diff_prem,0  diff_daily          
      FROM          
       rpt_View_NewM2MScrip bfoe,bfobillvalan bfob          
      WHERE    
       bfoe.bfoea_series_code = bfob.series_code          
       AND bfoe.bfoea_Product_code =bfob.product_code          
       AND bfoe.bfoea_expirydate LIKE Left(Convert(VarChar, bfob.expirydate, 109),11) + '%'          
       AND bfoe.bfoea_strike_price = bfob.strike_price          
       AND bfoe.bfoea_Product_Type = ( Case When bfob.Product_Type = '' Then 'FF' Else bfob.Product_Type End )          
       AND bfoe.bfoea_position_date LIKE Left(Convert(VarChar, bfob.sauda_date, 109),11) + '%'                
       AND LEFT(Convert(VarChar,bfob.sauda_date),11) LIKE @FromDate + '%' AND          
       /*LOGIN CONDITIONS*/          
       area LIKE (Case When '' + @StatusID + '' = 'area' Then '' + @StatusName + '' Else '%' End) AND          
       region LIKE (Case When '' + @StatusID + '' = 'region' Then '' + @StatusName + '' Else '%' End) AND          
       branch_code LIKE (Case When '' + @StatusID + '' = 'branch' Then '' + @StatusName + '' Else '%' End) AND          
       sub_broker LIKE (Case When '' + @StatusID + '' = 'subbroker' Then '' + @StatusName + '' Else '%' End) AND          
       trader LIKE (Case When '' + @StatusID + '' = 'trader' Then '' + @StatusName + '' Else '%' End) AND          
       family LIKE (Case When '' + @StatusID + '' = 'family' Then '' + @StatusName + '' Else '%' End) AND          
       party_code LIKE (Case When '' + @StatusID + '' = 'client' Then '' + @StatusName + '' Else '%' End) AND          
       Product_code Like (Case When @M2MType = 'M2M'            
                 Then '%FUT'           
                 Else (Case When @M2MType = 'ALL'            
                       Then '%'           
           Else '%OPT'           
             End )          
                    End ) And          
       AuctionPart Like (Case When @M2MType = 'EXE'            
                 Then 'EA'           
                 Else '%'          
                    End )          
       And ParticipantCode = @MemberCode          
       /*END - LOGIN CONDITIONS*/          
      GROUP BY           
       ISNULL(bfoe.bfoea_series_code, bfob.series_code),           
       ISNULL(bfoe.bfoea_Product_code,bfob.product_code),           
       ISNULL(Left(Convert(VarChar, bfoe.bfoea_expirydate, 109),11), Left(Convert(VarChar, bfob.expirydate, 109),11)),           
       ISNULL(bfoe.bfoea_strike_price, bfob.strike_price),           
       ISNULL(bfoe.bfoea_Product_Type, bfob.Product_Type),           
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)),          
       bfoe.bfoea_Exercised_Assigned_Value,  bfoe.bfoea_NetPremium, bfoe.bfoea_Daily_MTM_Settlement_Value , bfoea_Futures_Final_Settlement_Value          
      COMPUTE          
       Sum(ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0)),           
       Sum(ISNULL(bfoe.bfoea_NetPremium,0)),           
       Sum(ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0)),           
       Sum(Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)),           
       Sum(Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)),           
       Sum(Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End))          
     End /*If @M2MFor = 'SCRIP'*/          
          
     If @M2MFor = 'PARTY'          
     Begin          
      Print 'IN ' + @M2MType + ' -- ' + @M2MFor          
          
      If @FromCode = '' OR @ToCode = ''          
      Begin          
       SELECT @FromCode = Min(party_code), @ToCode = Max(party_code)          
        FROM          
         bfobillvalan          
        WHERE          
           sauda_date LIKE @FromDate + '%'          
      End          
          
      SELECT          
       ISNULL(bfob.party_code,bfoe.bfoea_party_code) AS party_code,          
       Left(bfob.party_name,20) as party_name,          
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)) AS sauda_date,          
          
       ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0) AS m_exe,          
       ISNULL(bfoe.bfoea_NetPremium,0) AS m_prem,          
       ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0) AS m_daily,          
                 
       Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,          
       Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem,           
       Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily,          
     ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0) -Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)  diff_exe,
ISNULL(bfoe.bfoea_NetPremium,0) - sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)  diff_prem,
ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0) - Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) diff_daily ,
email          
          
      FROM          
       rpt_View_NewM2MParty bfoe,bfobillvalan bfob          
      WHERE    
       bfoe.bfoea_party_code = bfob.party_code          
       AND bfoe.bfoea_position_date LIKE Left(Convert(VarChar, bfob.sauda_date, 109),11) + '%'         
       AND bfob.party_code >= @FromCode AND bfob.party_code <= @ToCode    
       AND LEFT(Convert(VarChar,bfob.sauda_date),11) LIKE @FromDate + '%' AND          
       /*LOGIN CONDITIONS*/          
       area LIKE (Case When '' + @StatusID + '' = 'area' Then '' + @StatusName + '' Else '%' End) AND          
       region LIKE (Case When '' + @StatusID + '' = 'region' Then '' + @StatusName + '' Else '%' End) AND          
       branch_code LIKE (Case When '' + @StatusID + '' = 'branch' Then '' + @StatusName + '' Else '%' End) AND          
       sub_broker LIKE (Case When '' + @StatusID + '' = 'subbroker' Then '' + @StatusName + '' Else '%' End) AND          
       trader LIKE (Case When '' + @StatusID + '' = 'trader' Then '' + @StatusName + '' Else '%' End) AND          
       family LIKE (Case When '' + @StatusID + '' = 'family' Then '' + @StatusName + '' Else '%' End) AND          
       party_code LIKE (Case When '' + @StatusID + '' = 'client' Then '' + @StatusName + '' Else '%' End) AND          
       Product_code Like (Case When @M2MType = 'M2M'            
                 Then '%FUT'           
                 Else (Case When @M2MType = 'ALL'            
                       Then '%'           
           Else '%OPT'           
             End )          
                    End ) And          
       AuctionPart Like (Case When @M2MType = 'EXE'            
                 Then 'EA'           
                 Else '%'          
                    End )          
       And ParticipantCode = @MemberCode          
       /*END - LOGIN CONDITIONS*/          
      GROUP BY           
       ISNULL(bfob.party_code,bfoe.bfoea_party_code),          
       bfob.party_name,          
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)),          
       bfoe.bfoea_Exercised_Assigned_Value,  bfoe.bfoea_NetPremium, bfoe.bfoea_Daily_MTM_Settlement_Value , bfoea_Futures_Final_Settlement_Value,          
       email          
      COMPUTE          
       Sum(ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0)),          
       Sum(ISNULL(bfoe.bfoea_NetPremium,0)),         
       Sum(ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0)),          
       Sum(Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) ),          
       Sum(Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)),           
       Sum(Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End))          
    
     End /*If @M2MFor = 'PARTY'*/          
          
     If @M2MFor = 'BOTH'          
     Begin          
      Print 'IN ' + @M2MType + ' -- ' + @M2MFor          
          
      If @FromCode = '' OR @ToCode = ''          
      Begin          
       SELECT @FromCode = Min(party_code), @ToCode = Max(party_code)          
        FROM          
         bfobillvalan          
        WHERE          
           sauda_date LIKE @FromDate + '%'          
      End          
          
      SELECT          
       ISNULL(bfob.party_code,bfoe.bfoea_party_code) AS party_code,          
       Left(bfob.party_name,20) as party_name,          
       ISNULL(bfoe.bfoea_series_code, bfob.series_code) AS series_code,           
       ISNULL(bfoe.bfoea_Product_code,bfob.product_code) AS Product_code,           
       ISNULL(Left(Convert(VarChar, bfoe.bfoea_expirydate, 109),11), Left(Convert(VarChar, bfob.expirydate, 109),11)) AS expiry_date,           
       ISNULL(bfoe.bfoea_strike_price, bfob.strike_price) AS strike_price,           
       ISNULL(bfoe.bfoea_Product_Type, bfob.Product_Type) AS Product_Type,           
          
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)) AS sauda_date,          
          
       ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0) AS m_exe,          
       ISNULL(bfoe.bfoea_NetPremium,0) AS m_prem,          
       ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0) AS m_daily,          
                 
       Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_exe,          
       Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_prem,           
       Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End) AS f_daily,          
          
 0 diff_exe,0 diff_prem,0  diff_daily           
      FROM          
       Rpt_View_NewM2MScripParty bfoe, bfobillvalan bfob          
      WHERE     
       bfoe.bfoea_series_code = bfob.series_code          
       AND bfoe.bfoea_Product_code =bfob.product_code          
       AND bfoe.bfoea_expirydate LIKE Left(Convert(VarChar, bfob.expirydate, 109),11) + '%'          
       AND bfoe.bfoea_strike_price = bfob.strike_price          
       AND bfoe.bfoea_Product_Type = ( Case When bfob.Product_Type = '' Then 'FF' Else bfob.Product_Type End )          
       AND bfoe.bfoea_position_date LIKE Left(Convert(VarChar, bfob.sauda_date, 109),11) + '%'          
       AND bfoe.bfoea_party_code = bfob.party_code          
       AND bfob.party_code >= @FromCode AND bfob.party_code <= @ToCode    
       AND LEFT(Convert(VarChar,bfob.sauda_date),11) LIKE @FromDate + '%' AND          
       /*LOGIN CONDITIONS*/          
       region LIKE (Case When '' + @StatusID + '' = 'region' Then '' + @StatusName + '' Else '%' End) AND          
       area LIKE (Case When '' + @StatusID + '' = 'area' Then '' + @StatusName + '' Else '%' End) AND          
       branch_code LIKE (Case When '' + @StatusID + '' = 'branch' Then '' + @StatusName + '' Else '%' End) AND          
       sub_broker LIKE (Case When '' + @StatusID + '' = 'subbroker' Then '' + @StatusName + '' Else '%' End) AND          
       trader LIKE (Case When '' + @StatusID + '' = 'trader' Then '' + @StatusName + '' Else '%' End) AND          
       family LIKE (Case When '' + @StatusID + '' = 'family' Then '' + @StatusName + '' Else '%' End) AND          
       party_code LIKE (Case When '' + @StatusID + '' = 'client' Then '' + @StatusName + '' Else '%' End) AND          
       Product_code Like (Case When @M2MType = 'M2M'            
                 Then '%FUT'           
                 Else (Case When @M2MType = 'ALL'            
                       Then '%'           
           Else '%OPT'           
             End )          
                    End ) And          
       AuctionPart Like (Case When @M2MType = 'EXE'            
                 Then 'EA'           
                 Else '%'          
                    End )          
       And ParticipantCode = @MemberCode          
       /*END - LOGIN CONDITIONS*/          
      GROUP BY           
       ISNULL(bfob.party_code,bfoe.bfoea_party_code),          
       bfob.party_name,          
       ISNULL(bfoe.bfoea_series_code, bfob.series_code),           
       ISNULL(bfoe.bfoea_Product_code,bfob.product_code),           
       ISNULL(Left(Convert(VarChar, bfoe.bfoea_expirydate, 109),11), Left(Convert(VarChar, bfob.expirydate, 109),11)),           
       ISNULL(bfoe.bfoea_strike_price, bfob.strike_price),           
       ISNULL(bfoe.bfoea_Product_Type, bfob.Product_Type),           
       ISNULL(Left(Convert(VarChar,bfoea_position_date,109),11),Left(Convert(VarChar,bfob.sauda_date,109),11)),          
       bfoe.bfoea_Exercised_Assigned_Value,  bfoe.bfoea_NetPremium, bfoe.bfoea_Daily_MTM_Settlement_Value , bfoea_Futures_Final_Settlement_Value          
      COMPUTE          
       Sum(ISNULL(bfoe.bfoea_Exercised_Assigned_Value,0)),          
       Sum(ISNULL(bfoe.bfoea_NetPremium,0)),          
       Sum(ISNULL(bfoe.bfoea_Daily_MTM_Settlement_Value,0)+ISNULL(bfoea_Futures_Final_Settlement_Value,0)),          
       Sum(Sum(Case When (auctionpart = 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)),          
       Sum(Sum(Case When (auctionpart <> 'EA' AND Product_code LIKE '%OPT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End)),           
       Sum(Sum(Case When (Product_code LIKE '%FUT') Then sbillamt - pbillamt + (pbrokamt + sbrokamt) Else 0 End))          
     End /*If @M2MFor = 'BOTH'*/          
          
    --End /*If @M2MType = 'ALL'*/          
   End /*If (@Ex_ReportBy = 'PRICE')*/          
  End /*If (@Ex_Rate = 'MKTRATE')*/          
 End /*If (@ReportName = 'M2M')*/          
          
          
          
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewNetPosition
-- --------------------------------------------------

CREATE proc        
 rpt_proc_FO_NewNetPosition        
 @ReportName VarChar(50),        
 @StatusID VarChar(20),        
 @StatusName VarChar(50),        
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT        
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FromDate VarChar(11),        
 @ToDate VarChar(11),        
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FromCode VarChar(20),        
 @ToCode VarChar(20),        
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @OneOrMany VarChar(20),        
 @Product_Code VarChar(20),  --]        
 @Product_type VarChar(20), --]        
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.        
 @ExpiryDate VarChar(11), --]        
 @Series_Code VarChar(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]        
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]        
 @CmClosing VarChar (2), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @Dummy001 VarChar(50),        
 @Dummy002 VarChar(50),        
 @Dummy003 VarChar(50),        
 @Dummy004 VarChar(50),        
 @Dummy005 VarChar(50),        
 @Dummy006 VarChar(50),        
 @Dummy007 VarChar(50),        
 @Dummy008 VarChar(50),        
 @Dummy009 VarChar(50),        
 @Dummy010 VarChar(50)        
AS        
Declare        
 @strSelect VarChar(8000),        
 @strSelectTemp VarChar(8000),        
 @strFrom VarChar(8000),        
 @strWhere VarChar(8000),        
 @strGroupBy VarChar(8000),        
 @strOrderBy VarChar(8000),        
 @strCompute VarChar(8000),        
 @strComputeSub VarChar(8000),        
 @IsSubLevel VarChar(3),        
 @CodeID VarChar(20),        
 @Comma VarChar(1)        
 Set @Product_Code = @Product_Code+"%"         
 If @Product_type = '' Begin Set @Product_type = "%" End        
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE        
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End        
 If @Series_Code = '' Begin Set @Series_Code = "%" End        
         
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End        
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End        
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End        
 Set @strSelect = ''        
 Set @strSelectTemp = ''        
 Set @strFrom = ''        
 Set @strWhere = ''        
 Set @strGroupBy = ''        
 Set @strOrderBy = ''        
 Set @strCompute = ''        
 Set @strCompute = ''        
 Set @strComputeSub = ''        
 Set @IsSubLevel = 'NO'        
 If (@FromDate = '' AND @ToDate = '')        
 Begin         
  Select @FromDate = Left(Convert(Varchar,Max(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From bfobillvalan         
 End         
 If (@ReportName = 'NETPOSITION')        
 Begin        
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End        
  If (@WhatCode = 'AREA') Begin Set @CodeID = 'area' End        
  If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End        
  If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End        
  If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End        
  If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End        
  If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End        
         
  if @CmClosing <> ''         
   begin        
    Set @strSelect = @strSelect + "SELECT CMClosing, "         
   end        
  else        
   begin        
    Set @strSelect = @strSelect + "SELECT "         
   end        
  Set @strCompute = @strCompute + "COMPUTE "        
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))        
  Begin        
   Set @strSelectTemp = ''        
 If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
            
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "party_code "        
    End        
   End        
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Series_Code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "Series_Code, Product_code, expirydate, strike_price, Product_type "        
    End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "sauda_date "        
    End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Product_code, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Series_Code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, Product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "Product_code "        
    End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name,client_type, email,Series_Code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price "        
    Set @strSelectTemp = @strSelectTemp + "Product_type, Convert(VarChar,sauda_date,103) AS sauda_date, "        
    Set @IsSubLevel = 'YES'        
   End        
   Set @strSelect = @strSelect + @strSelectTemp        
   Set @strSelectTemp = ''        
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
   If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,25) AS party_name, client_type, email, " End        
   If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "area, " End        
   If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End        
   If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End        
   If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End        
   If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End        
  End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  --PQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + " Sum(pqty) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* P.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS pqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --SQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(sqty) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* S.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS sqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --Ex_ReportBy IS ALYAYS 'PRICE' FOR THIS REPORT, SO THE CODE BLOCS FOR 'If (@Ex_ReportBy = 'PRICE')' AND        
  If (@Ex_ReportBy = 'STRIKE')        
  Begin        
   --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(pqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (pqty*PRate) End)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
   Set @strSelect = @strSelect + @strSelectTemp        
   --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(sqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (sqty*SRate) End)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   Set @strSelectTemp = @strSelectTemp + "AS samt, "        
   Set @strSelect = @strSelect + @strSelectTemp        
   --NETQTY - FOR THE NET POS REPORT        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
   Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
   Set @strSelect = @strSelect + @strSelectTemp        
   --NET VALUE- FOR THE NET POS REPORT        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(pqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (pqty*PRate) End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(sqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (sqty*SRate) End)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
   Set @strSelectTemp = @strSelectTemp + "AS NetValue, "        
   Set @strSelect = @strSelect + @strSelectTemp        
   --AVG. PRICE - FOR THE NET POS REPORT        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Case When Sum(pqty) - Sum(sqty) <> 0 "        
   Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(pqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (pqty*PRate) End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE 'OPT%' Then "        
   Set @strSelectTemp = @strSelectTemp + "(sqty*Strike_Price) "           
   Set @strSelectTemp = @strSelectTemp + "Else (sqty*SRate) End)) ) /  "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) Else 0 End) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
   Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
   Set @strSelect = @strSelect + @strSelectTemp        
  End        
          
  If (@Ex_Rate = 'MKTRATE')        
  Begin        
   --If (@Ex_ReportBy = 'BOTH') ARE OMITED        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(prate*Pqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(SRate*SQty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        

    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NET VALUE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Sum(PRate*PQty) - Sum(SRate*SQty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS NetValue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(pqty) - Sum(sqty) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then (Sum(PRate*PQty) - Sum(SRate*SQty))/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum((strike_price+PRate) *pqty) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum((strike_price+SRate) *sqty) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NET VALUE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Sum((strike_price+PRate) *pqty) - Sum((strike_price+SRate) *sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS NetValue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(pqty) - Sum(sqty) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then (Sum((strike_price+PRate) *pqty) - Sum((strike_price+SRate) *sqty))/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/        
  /*Ex_Rate IS ALYAYS 'NETRATE' IN THIS REPORT, SO THE CODE BLOC FOR 'If (@Ex_Rate = 'NETRATE') IS OMITTED*/        
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   --If (@Ex_ReportBy = 'BOTH') ARE OMITED        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pamt)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(samt)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
            
    --NETQTY - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --net value- FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Sum(pamt) - Sum(samt)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* net value - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS netvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(pqty) - Sum(sqty) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then (Sum(pamt) - Sum(samt))/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum((strike_price*pqty)+PAmt) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum((strike_price*sqty)+SAmt) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NET VALUE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + " (Sum((strike_price*pqty)+PAmt) - Sum((strike_price*sqty)+SAmt)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS netvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE - FOR THE NET POS REPORT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(pqty) - Sum(sqty) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then (Sum((strike_price*pqty)+PAmt) - Sum((strike_price*sqty)+SAmt))/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/     
  --NET OPEN VALUE (CL. PRICE)        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + " Sum((pqty - sqty)*Cl_Rate)  "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET OPEN VALUE (CL. PRICE) */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS netopenvalue, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --CL. PRICE        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "  (Case When Sum(PQty+SQty) <> 0 Then  Abs(Sum((pqty + sqty)*Cl_Rate) / Sum(pqty + sqty)) Else 0 End )"        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* CL. PRICE */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS closeprice "          
  Set @strSelect = @strSelect + @strSelectTemp        
  Set @strSelectTemp = ''        
  Set @strFrom = @strFrom + "FROM "        
 Set @strFrom = @strFrom + "bfobillvalan "        
         
  Set @strWhere = @strWhere + "WHERE "        
         
  Set @strWhere = @strWhere + "Product_code LIKE '" + @Product_Code + "' AND "        
  Set @strWhere = @strWhere + "Product_type LIKE '" + @Product_type + "' AND "        
  If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End        
  Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "        
  Set @strWhere = @strWhere + "Series_Code LIKE '" + @Series_Code + "' AND "        
  If (@FromCode = '' AND @ToCode = '')        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "        
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "        
  End        
  If (@FromDate = '' AND @ToDate = '')        
  Begin        
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "        
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "        
  End        
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))        
  Begin        
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "        
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "        
  End        
  /*LOGIN CONDITIONS*/        
  Set @strWhere = @strWhere + "area LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "branch_code LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "        
  /*END - LOGIN CONDITIONS*/        
  Set @Comma = ''        
  Set @strGroupBy = @strGroupBy + @Comma        
          
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))        
  Begin        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, Product_code, expirydate, strike_price, Product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "Product_code " End        
   End        
          
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Series_Code, Product_code, expirydate, strike_price, Product_type "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "Product_code "*/ End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "sauda_date "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, Product_code, expirydate, strike_price, Product_type " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "Product_code " End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Product_code "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "Series_Code, expirydate, strike_price, Product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, Series_Code, Product_code, expirydate, strike_price, "        
    Set @strGroupBy = @strGroupBy + "sauda_date "        
   End        
  End /*If (@OneOrMany = 'DETAIL')*/        
  Else /*If (@OneOrMany = 'DETAIL')*/        
  Begin /*Else OF If (@OneOrMany = 'DETAIL')*/        
   If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End        
   If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "area " End        
   If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End        
   If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End        
   If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End        
   If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End        
  End /*Else OF If (@OneOrMany = 'DETAIL')*/        
  Set @strOrderBy = @strGroupBy         
  if @CmClosing <> ''         
   begin        
    set @strGroupBy = @strGroupBy  + ",CMClosing "        
   end        
  Set @strGroupBy = "GROUP BY " + @strGroupBy  + " Having Sum(pqty - sqty) <> 0 "        
  Set @strOrderBy = "ORDER BY " + @strOrderBy        
 End/*If (@ReportName = "NETPOSITION")*/        
 If @strComputeSub <> ''         
 Begin         
  Set @strComputeSub = "BY " + @strComputeSub         
  Set @strComputeSub = @strCompute + @strComputeSub        
 End        
        
 If (@IsSubLevel = 'YES')        
 Begin        
  Print (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)        
 End        
 Else        
 Begin        
  Print (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)        
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewReports
-- --------------------------------------------------

CREATE proc        
rpt_proc_FO_NewReports        
 @ReportName VarChar(50),        
 @StatusID VarChar(20),        
 @StatusName VarChar(50),        
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT        
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FromDate VarChar(11),        
 @ToDate VarChar(11),        
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FromCode VarChar(20),        
 @ToCode VarChar(20),        
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @OneOrMany VarChar(20),        
 @ProductCode VarChar(20),  --]        
 @SeriesCode VarChar(20), --]        
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.        
 @ExpiryDate VarChar(11), --]        
 @ProductType VarChar(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]        
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @Dummy001 VarChar(50),        
 @Dummy002 VarChar(50),        
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),        
 @Dummy005 VarChar(50),        
 @Dummy006 VarChar(50),        
 @Dummy007 VarChar(50),        
 @Dummy008 VarChar(50),        
 @Dummy009 VarChar(50),        
 @Dummy010 VarChar(50)        
AS        
Declare        
 @strSelect VarChar(8000),        
 @strSelectTemp VarChar(8000),        
 @strFrom VarChar(8000),        
 @strWhere VarChar(8000),        
 @strGroupBy VarChar(8000),        
 @strOrderBy VarChar(8000),        
 @strCompute VarChar(8000),        
 @strComputeSub VarChar(8000),        
 @strHaving Varchar(2000),        
 @IsSubLevel VarChar(3),        
 @CodeID VarChar(20),        
 @Comma VarChar(1)        
 Set @ProductCode = @ProductCode+"%"         
 If @SeriesCode = '' Begin Set @SeriesCode = "%" End        
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE        
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End        
 If @ProductType = '' Begin Set @ProductType = "%" End        
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End        
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End        
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End        
 Set @strSelect = ''        
 Set @strSelectTemp = ''        
 Set @strFrom = ''        
 Set @strWhere = ''        
 Set @strGroupBy = ''        
 Set @strOrderBy = ''        
 Set @strCompute = ''        
 Set @strComputeSub = ''        
 Set @IsSubLevel = 'NO'        
         
 If (@FromDate = '' AND @ToDate = '')        
 Begin         
  Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From BFoBillValan         
 End         
 If (@ReportName = 'SAUDASUMMARY')        
 Begin        
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End        
  If (@WhatCode = 'AREA') Begin Set @CodeID = 'area' End        
  If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End        
  If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End        
  If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End        
  If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End        
  If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End        
          
  Set @strSelect = @strSelect + "SELECT "        
  Set @strCompute = @strCompute + " COMPUTE "        
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))        
  Begin        
   Set @strSelectTemp = ''        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type, email, "        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "series_code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
            
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "party_code "        
    End        
   End        
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "series_code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     --Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "series_code, product_code, expirydate, strike_price, product_type "        
    End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "        
If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "series_code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + " Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date) "        
    End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "product_code, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     --Set @strSelectTemp = @strSelectTemp + "series_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @strSelectTemp = @strSelectTemp + "series_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "product_code "        
    End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type, email, series_code, product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "        
    Set @strSelectTemp = @strSelectTemp + "product_type, Convert(VarChar,sauda_date,103) AS sauda_date,Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date), "        
    Set @IsSubLevel = 'YES'        
   End        
   Set @strSelect = @strSelect + @strSelectTemp        
   Set @strSelectTemp = ''        
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
   If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,20) AS party_name, client_type, email, " End        
   If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End        
   If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "area, " End        
   If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End        
   If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End        
   If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End        
  End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  --OPENQTY        
  Set @strSelectTemp = ''        
  if @GroupSubLevel = 'DATE'         
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When /*sauda_date like '" + @FromDate + "%' And*/ tradetype = 'BF' Then pqty-sqty Else 0 End)) "         
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  End        
  Else        
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When sauda_date like '" + @FromDate + "%' And tradetype = 'BF' Then pqty-sqty Else 0 End)) "         
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  End        
  Set @strSelectTemp = @strSelectTemp + "AS openqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --PQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* P.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS pqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --SQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* S.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS sqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  If (@Ex_Rate = 'MKTRATE')        
  Begin        
   If (@Ex_ReportBy = 'STRIKE')        
   Begin        
    --PAMT - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
          
    --PRATE - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + " Then ((Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End)) ) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SRATE - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT'  Then ((strike_price+prate)*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
   Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End)) )/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'MKTRATE')*/        
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   If (@Ex_ReportBy = 'STRIKE')        
   Begin        
    --PAMT - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --PRATE - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SRATE - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End)) ) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SAMT - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SQTY - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*pqty)+pamt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT'  Then ((strike_price*pqty)+pamt) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*pqty)+pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then ((strike_price*pqty)+pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/        
  --CLOSEQTY        
  Set @strSelectTemp = ''        
  if @GroupSubLevel = 'DATE'         
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When /*sauda_date like '" + @FromDate + "%' And*/ tradetype = 'BF' Then pqty-sqty Else 0 End)) + "         
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "         
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
  End        
  Else        
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When sauda_date like '" + @FromDate + "%' And tradetype = 'BF' Then pqty-sqty Else 0 End)) + "         
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "         
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
  End        
    Set @strSelectTemp = @strSelectTemp + "AS closeqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --PROFIT/LOSS        
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp +" Sum(SBillAmt - PBillAmt)  - (Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* PROFIT/LOSS */ "        
   Set @strSelectTemp = @strSelectTemp + "AS profitorloss, "        
   if (@GroupSubLevel ='SCRIP' or @GroupLevel = 'SCRIP') 
     begin      
        Set @strSelectTemp = @strSelectTemp + " cl_rate = (Case When Sum(PQty+SQty) <> 0 Then  Abs(Sum((pqty + sqty)*Cl_Rate) / Sum(pqty + sqty)) Else 0 End ) "       
     end      
  else      
   begin      
       Set @strSelectTemp = @strSelectTemp + " cl_rate = 0 "       
   end      
   Set @strSelect = @strSelect + @strSelectTemp        
  End        
  Else        
  Begin        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp +" Sum(SBillAmt - PBillAmt + PBrokAmt + SBrokAmt) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* PROFIT/LOSS */ "        
   Set @strSelectTemp = @strSelectTemp + "AS profitorloss, "        
     if (@GroupSubLevel ='SCRIP' or @GroupLevel = 'SCRIP')  
     begin      
          Set @strSelectTemp = @strSelectTemp + " cl_rate = (Case When Sum(PQty+SQty) <> 0 Then  Abs(Sum((pqty + sqty)*Cl_Rate) / Sum(pqty + sqty)) Else 0 End ) "       
     end      
     else      
     begin      
          Set @strSelectTemp = @strSelectTemp + " cl_rate = 0 "       
     end      
   Set @strSelect = @strSelect + @strSelectTemp        
  End        
  Set @strSelectTemp = ""        
  Set @strFrom = @strFrom + "FROM "        
  Set @strFrom = @strFrom + "BFoBillValan "        
         
  Set @strWhere = @strWhere + "WHERE "         
  Set @strWhere = @strWhere + "product_code LIKE '" + @ProductCode + "' AND "        
  Set @strWhere = @strWhere + "product_type LIKE '" + @SeriesCode + "' AND "        
  If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End        
  Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "        
  Set @strWhere = @strWhere + "series_code LIKE '" + @ProductType + "' AND "        
  Set @strWhere = @strWhere + "AuctionPart Like '" + @Ex_AuctionPart + "' AND  "        
  If (@FromCode = '' AND @ToCode = '')        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "        
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "        
  End        
  If (@FromDate = '' AND @ToDate = '')        
  Begin        
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "        
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "        
  End        
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))        
  Begin        
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "        
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "        
  End        
          
 /*LOGIN CONDITIONS*/      	
	
	Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "
	Set @strWhere = @strWhere + "		(CASE "
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	Set @strWhere = @strWhere + "			ELSE "
	Set @strWhere = @strWhere + "		'BROKER'"
	Set @strWhere = @strWhere + "		END)    "

/*END - LOGIN CONDITIONS*/
  Set @Comma = ''        
  Set @strGroupBy = @strGroupBy + @Comma        
          
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))        
  Begin        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "product_code " End        
   End        
           
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strGroupBy = @strGroupBy + "series_code, product_code, expirydate, strike_price, product_type "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "product_code "*/ End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "product_code " End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strGroupBy = @strGroupBy + "product_code"        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, series_code, product_code, expirydate, strike_price, "        
    Set @strGroupBy = @strGroupBy + "product_type,Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date) ,sauda_date "        
   End        
  End /*If (@OneOrMany = 'DETAIL')*/        
  Else /*If (@OneOrMany = 'DETAIL')*/        
  Begin /*Else OF If (@OneOrMany = 'DETAIL')*/        
   If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End        
   If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "area " End        
   If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End        
   If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End        
   If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End        
   If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family,FamilyName " End        
  End /*Else OF If (@OneOrMany = 'DETAIL')*/        
  Set @strOrderBy = @strGroupBy        
  Set @strGroupBy = "GROUP BY " + @strGroupBy        
  Set @strOrderBy = " ORDER BY  " + @strOrderBy        
         
  Set @strHaving = ' Having '         
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   Set @strHaving = @strHaving +" Sum(SBillAmt - PBillAmt) - (Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) <> 0 "        
  End        
  Else        
  Begin        
   Set @strHaving = @strHaving + " Sum(SBillAmt - PBillAmt + PBrokAmt + SBrokAmt) <> 0 "        
  End         
 End/*If (@ReportName = "SAUDASUMMARY")*/        
 If @strComputeSub <> ''         
 Begin         
  Set @strComputeSub = "BY " + @strComputeSub         
  Set @strComputeSub = @strCompute + @strComputeSub        
 End        
 If (@IsSubLevel = 'YES')        
 Begin        
  Print (@strSelect + @strFrom + @strWhere + @strGroupBy  + @strOrderBy + @strComputeSub + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy  + @strOrderBy + @strComputeSub + @strCompute)        
 End        
 Else        
 Begin        
  print (@strSelect + @strFrom + @strWhere + @strGroupBy  + @strOrderBy + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy  + @strOrderBy + @strCompute)        
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewReportsSearch
-- --------------------------------------------------

CREATE    PROC
[dbo].[rpt_proc_FO_NewReportsSearch]
@strStatusID VarChar (20),
@strStatusName VarChar (20),
@strIdentifier VarChar(20),
@strSearchString VarChar(50),
@strReportFor VarChar(25),
@strFromCode VarChar(25),
@strToCode VarChar(25),
@strFromPartyCode VarChar(25),
@strToPartyCode VarChar(25),
@strFromDate VarChar(25),
@strToDate VarChar(25),
@strProductcode VarChar(25),
@strSeriescode VarChar(25),
@strExpiryDate VarChar(25),
@strProducttype VarChar(25),
@strStrikePrice Money,
@strAuctionPart VarChar(25),
@strDummy001 VarChar(25),
@strDummy002 VarChar(25),
@strDummy003 VarChar(25),
@strDummy004 VarChar(25),
@strDummy005 VarChar(25),
@strDummy006 VarChar(25),
@strDummy007 VarChar(25),
@strDummy008 VarChar(25),
@strDummy009 VarChar(25),
@blnFromUpdatePage VarChar(25)
AS
Declare
	@strSQL VarChar(8000),
	@strWhatToList VarChar(50)
	Set @strProductcode = @strProductcode+"%" 
	If (@strReportFor = 'AREA')  Begin Set @strWhatToList = "area" End
	If (@strReportFor = 'REGION')  Begin Set @strWhatToList = "region" End
	If (@strReportFor = 'BRANCH')  Begin Set @strWhatToList = "branch_code" End
	If (@strReportFor = 'SUBBROKER')  Begin Set @strWhatToList = "sub_broker" End
	If (@strReportFor = 'TRADER')  Begin Set @strWhatToList = "trader" End
	If (@strReportFor = 'FAMILY')  Begin Set @strWhatToList = "family" End
	If (@strReportFor = 'CLIENT')  Begin Set @strWhatToList = "party_code" End
	If (@blnFromUpdatePage = 'FALSE')
	Begin
		--FROM CODE
		If (@strIdentifier = 'FROMCODE')
		Begin
			If (@strReportFor = 'CLIENT')
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code, party_name FROM bfobillvalan WHERE "
			End
			Else
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM bfobillvalan WHERE "
			End
			--Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM bfobillvalan WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
		
			If @strToCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		--TO CODE
		If (@strIdentifier = 'TOCODE')
		Begin
			If (@strReportFor = 'CLIENT')
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code, party_name FROM bfobillvalan WHERE "
			End
			Else
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM bfobillvalan WHERE "
			End
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		--FROM DATE
		If (@strIdentifier = 'FROMDATE')
		Begin
			--Set @strWhatToList = 'sauda_date'
			Set @strSQL = "SELECT DISTINCT sauda_date, Convert(VarChar, sauda_date, 103) AS from_code FROM bfobillvalan WHERE "
			Set @strSQL = @strSQL + "sauda_date LIKE '" + @strSearchString + "%' "
		
			If @strToDate <> '' Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
		
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
		
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--TO DATE
		If (@strIdentifier = 'TODATE')
		Begin
			--Set @strWhatToList = 'sauda_date'
			Set @strSQL = "SELECT DISTINCT sauda_date, Convert(VarChar, sauda_date, 103) AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "sauda_date LIKE '" + @strSearchString + "%' "
		
			If @strFromDate <> '' Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
	
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + "' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + "' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--INSTTYPE
		If (@strIdentifier = 'PRODUCTCODE')
		Begin
			--Set @strWhatToList = 'Product_code'
			Set @strSQL = "SELECT DISTINCT Product_code AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "Product_code LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			--If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--Series_code
		If (@strIdentifier = 'SERIESCODE')
		Begin
			--Set @strWhatToList = 'Series_code'
			Set @strSQL = "SELECT DISTINCT Series_code AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "Series_code LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			--If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--EXPIRY DATE
		If (@strIdentifier = 'EXPIRYDATE')
		Begin
			--Set @strWhatToList = 'expirydate'
			Set @strSQL = "SELECT DISTINCT Convert(VarChar, expirydate, 103) AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "expirydate LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			--If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate = '" + @strExpiryDate + "' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--OPTION TYPE
		If (@strIdentifier = 'PRODUCTTYPE')
		Begin
			--Set @strWhatToList = 'Product_code'
			Set @strSQL = "SELECT DISTINCT Product_TYPE AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "Product_TYPE LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			--If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--STRIKE PRICE
		If (@strIdentifier = 'STRIKEPRICE')
		Begin
			--Set @strWhatToList = 'strike_price'
			Set @strSQL = "SELECT DISTINCT strike_price AS from_code FROM bfobillvalan  WHERE "
			Set @strSQL = @strSQL + "Convert(VarChar, strike_price) LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strProductcode <> '') Begin Set @strSQL = @strSQL + " AND Product_code Like  '" + @strProductcode + "' " End
			If (@strSeriescode <> '') Begin Set @strSQL = @strSQL + " AND Series_code = '" + @strSeriescode + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strProducttype <> '') Begin Set @strSQL = @strSQL + " AND Product_code = '" + @strProducttype + "' " End
			--If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		/*LOGIN CONDITIONS*/
		Set @strSQL = @strSQL + "AND area LIKE (Case When '" + @strStatusID + "' = 'area' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND region LIKE (Case When '" + @strStatusID + "' = 'region' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND branch_code LIKE (Case When '" + @strStatusID + "' = 'branch' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND sub_broker LIKE (Case When '" + @strStatusID + "' = 'subbroker' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND trader LIKE (Case When '" + @strStatusID + "' = 'trader' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND family LIKE (Case When '" + @strStatusID + "' = 'family' Then '" + @strStatusName + "' Else '%' End) "
		Set @strSQL = @strSQL + "AND party_code LIKE (Case When '" + @strStatusID + "' = 'client' Then '" + @strStatusName + "' Else '%' End) "
		/*END - LOGIN CONDITIONS*/
	End --If (@blnFromUpdatePage = 'FALSE')
	Else --If (@blnFromUpdatePage = 'FALSE')
	Begin
		If (@strIdentifier = 'FROMCODE')
		Begin
			Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM client2 WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strToCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
		End
		If (@strIdentifier = 'TOCODE')
		Begin
			Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM client2 WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
		End
	End --Else Of If (@blnFromUpdatePage = 'FALSE')
	Set @strSQL = @strSQL + "ORDER BY (1)"
	Print @strSQL
	Exec(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewTurnOver
-- --------------------------------------------------


CREATE      PROC        
rpt_proc_FO_NewTurnOver        
 @ReportName VarChar(50),        
 @StatusID VarChar(20),        
 @StatusName VarChar(50),        
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT        
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FromDate VarChar(11),        
 @ToDate VarChar(11),        
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FromCode VarChar(20),        
 @ToCode VarChar(20),        
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @OneOrMany VarChar(20),        
 @productcode VarChar(20),  --]        
 @productType VarChar(20), --]        
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.        
 @ExpiryDate VarChar(11), --]        
 @SeriesCode VarChar(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]        
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @ULCLRate VarChar(50),        
 @ClTransactions VarChar(50),        
 @Dummy003 VarChar(50),        
 @Dummy004 VarChar(50),        
 @Dummy005 VarChar(50),        
 @Dummy006 VarChar(50),        
 @Dummy007 VarChar(50),        
 @Dummy008 VarChar(50),        
 @Dummy009 VarChar(50),        
 @Dummy010 VarChar(50)        
AS        

set transaction isolation level read uncommitted

Declare        
 @strSelect VarChar(8000),        
 @strSelectTemp VarChar(8000),        
 @strFrom VarChar(8000),        
 @strWhere VarChar(8000),        
 @strGroupBy VarChar(8000),        
 @strOrderBy VarChar(8000),        
 @strCompute VarChar(8000),        
 @strComputeSub VarChar(8000),        
 @IsSubLevel VarChar(3),        
 @CodeID VarChar(20),        
 @Comma VarChar(1)        
 Set @productcode = @productcode+"%"         
 If @productType = '' Begin Set @productType = "%" End        
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE        
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End        
 If @SeriesCode = '' Begin Set @SeriesCode = "%" End        
         
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End        
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End        
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End        
 Set @strSelect = ''        
 Set @strSelectTemp = ''        
 Set @strFrom = ''        
 Set @strWhere = ''        
 Set @strGroupBy = ''        
 Set @strOrderBy = ''        
 Set @strCompute = ''        
 Set @strCompute = ''        
 Set @strComputeSub = ''        
 Set @IsSubLevel = 'NO'        
 If (@FromDate = '' AND @ToDate = '')        
 Begin    
  Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From BFoBillValan         
 End         
 If (@ReportName = 'TURNOVER')        
 Begin        
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End        
  If (@WhatCode = 'AREA') Begin Set @CodeID = 'area' End        
  If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End        
  If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End        
  If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End        
  If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End        
  If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End        
          
  Set @strSelect = @strSelect + "SELECT "        
  Set @strCompute = @strCompute + "COMPUTE "        
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))        
  Begin        
   Set @strSelectTemp = ''        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "series_code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
            
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "party_code "        
    End        
   End        
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "series_code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "series_code, Product_code, expirydate, strike_price, product_type "        
    End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "series_code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'PRODUCT')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Product_code, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "sauda_date "        
    End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Product_code, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "series_code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, product_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "Product_code "        
    End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, series_code, Product_code, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "        
    Set @strSelectTemp = @strSelectTemp + "product_type, Convert(VarChar,sauda_date,103) AS sauda_date, "        
    Set @IsSubLevel = 'YES'        
   End        
   Set @strSelect = @strSelect + @strSelectTemp        
   Set @strSelectTemp = ''        
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
   If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,25) AS party_name, client_type, email, " End        
   If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End        
   If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "area, " End        
   If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End        
   If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End        
   If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End        
  End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
          
  If (@Ex_Rate = 'MKTRATE')        
  Begin        
   --FUTURES TRADED VALUE - MKTRATE - COMMON        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%FUT' AND auctionpart <> 'EA'  /*AND auctionpart <> 'CA'*/ "        
   Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
   Set @strSelectTemp = @strSelectTemp + "AS futurestradedvalue, "        
   Set @strSelect = @strSelect + @strSelectTemp        
   If (@Ex_ReportBy = 'STRIKE')        
   Begin        
    --OPTIONS TRADED AMT - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "        
    Set @strSelectTemp = @strSelectTemp + "Then ((pqty+sqty)*strike_price ) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE        
    If (@ULCLRate = 'EX')        
    Begin        
     Set @strSelectTemp = ''        
     Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
     Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price ) Else 0 End)) "        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
     Set @strSelectTemp = '0 '        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
    End        
    Else /*Of If (@ULCLRate = 'EX')*/        
    Begin        
     --ASSIGNED AMT - ASG/BOTH + STRIKE        
     If (@ULCLRate = 'ASG')        
     Begin        
      Set @strSelectTemp = '0 '        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
         
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End        
     Else /*Of If (@ULCLRate = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate        
         
     Begin        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
      Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End /*Of the Else Of If (@ULCLRate = 'ASG')*/        
    End /*Of The Else Of If (@ULCLRate = 'EX')*/        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%FUT' AND auctionpart = 'EA' AND auctionpart <> 'CA' "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%FUT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) + "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull((pqty+sqty)*Strike_Price ,0) Else 0 End))  "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS total, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --OPTIONS TRADED AMT - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "        
    Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate )+(sqty*srate ))) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE        
    If (@ULCLRate = 'EX')        
    Begin        
     Set @strSelectTemp = ''        
     Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
     Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate ) Else 0 End)) "        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
     Set @strSelectTemp = '0 '        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
    End        
    Else /*Of If (@ULCLRate = 'EX')*/        
    Begin        
     --ASSIGNED AMT - ASG/BOTH + PRICE        
     If (@ULCLRate = 'ASG')        
     Begin        
      Set @strSelectTemp = '0 '        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
         
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End        
     Else /*Of If (@ULCLRate = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate        
         
     Begin        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
      Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End /*Of the Else Of If (@ULCLRate = 'ASG')*/        
    End /*Of The Else Of If (@ULCLRate = 'EX')*/        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%FUT' AND auctionpart = 'EA' AND auctionpart <> 'CA' "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%FUT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) + "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End))  "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS total, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --OPTIONS TRADED AMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "        
    Set @strSelectTemp = @strSelectTemp + "Then (((pqty+sqty)*strike_price ) + (pqty*prate )+(sqty*srate )) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH        
    If (@ULCLRate = 'EX')        
    Begin        
     Set @strSelectTemp = ''        
     Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
     Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate) ) Else 0 End)) "        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
     Set @strSelectTemp = '0 '        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
    End        
    Else /*Of If (@ULCLRate = 'EX')*/        
    Begin        
     --ASSIGNED AMT - ASG/BOTH + BOTH        
     If (@ULCLRate = 'ASG')        
     Begin        
      Set @strSelectTemp = '0 '        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
         
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+PRate) ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End        
     Else /*Of If (@ULCLRate = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate        
         
     Begin        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
      Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate) ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+pRate) ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End /*Of the Else Of If (@ULCLRate = 'ASG')*/        
    End /*Of The Else Of If (@ULCLRate = 'EX')*/        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%FUT' AND auctionpart = 'EA' AND auctionpart <> 'CA' "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%FUT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) + "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS total, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'EXCHG')        
   Begin        
    --OPTIONS TRADED AMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "        
    Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate )+(sqty*srate ))) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH        
    If (@ULCLRate = 'EX')        
    Begin        
     Set @strSelectTemp = ''        
     Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
     Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price ) Else 0 End)) "         
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
     Set @strSelectTemp = '0 '        
     Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
     Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
     Set @strSelect = @strSelect + @strSelectTemp        
    End        
    Else /*Of If (@ULCLRate = 'EX')*/        
    Begin        
     --ASSIGNED AMT - ASG/BOTH + BOTH        
     If (@ULCLRate = 'ASG')        
     Begin        
      Set @strSelectTemp = '0 '        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
         
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End        
     Else /*Of If (@ULCLRate = 'ASG')*/        
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate        
         
     Begin        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code LIKE '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
      Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
      Set @strSelectTemp = ''        
      Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA')"        
      Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price ) Else 0 End)) "        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL        
      Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "        
      Set @strSelect = @strSelect + @strSelectTemp        
     End /*Of the Else Of If (@ULCLRate = 'ASG')*/        
    End /*Of The Else Of If (@ULCLRate = 'EX')*/        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Product_code LIKE '%FUT' AND auctionpart = 'EA' AND auctionpart <> 'CA' "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%FUT' AND auctionpart <> 'CA' ) "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) + "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart <> 'EA') "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty  + srate*sqty ,0) Else 0 End)) + "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (Product_code like '%OPT' AND auctionpart <> 'CA' AND auctionpart = 'EA') "        
    Set @strSelectTemp = @strSelectTemp + "Then IsNull(Strike_Price*pqty  + Strike_Price*sqty ,0) Else 0 End))  "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS total, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/        
  --BROKERAGE        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "isnull(Sum(pbrokamt + sbrokamt),0) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* BROKERAGE */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS brokerage, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --SERVICE TAX        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "isnull(Sum(service_tax- ExSer_Tax),0) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS servicetax, "        
  Set @strSelect = @strSelect + @strSelectTemp      
    
   --Ins_chrg       
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(Ins_chrg) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS Ins_chrg, "        
  Set @strSelect = @strSelect + @strSelectTemp        
   
  --TURNOVER TAX        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(turn_tax) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* TURNOVER TAX */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS turnovertax, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --SEBI TAX        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(sebi_tax) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SEBI TAX */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS sebitax, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --STAMP DUTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(broker_note) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* STAMP DUTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS stampduty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --CLEARING CHARGES        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "Sum(cl_chrg - excl_chrg) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* CLEARING CHARGES */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS clearingcharges "        
  Set @strSelect = @strSelect + @strSelectTemp        
  Set @strFrom = @strFrom + "FROM "        
  Set @strFrom = @strFrom + "BFoBillValan (nolock) "        
         
  Set @strWhere = @strWhere + "WHERE "        
  Set @strWhere = @strWhere + "tradetype = 'BT' AND "        
         
  Set @strWhere = @strWhere + "Product_code LIKE '" + @productcode + "' AND "        
  Set @strWhere = @strWhere + "product_type LIKE '" + @productType + "' AND "        
  If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End        
  Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "        
  Set @strWhere = @strWhere + "series_code LIKE '" + @SeriesCode + "' AND "        
  If (@FromCode = '' AND @ToCode = '')        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + @CodeID + " >= '" + @FromCode + "' AND "        
   Set @strWhere = @strWhere + @CodeID + " <= '" + @ToCode + "' AND "        
  End        
  If (@FromDate = '' AND @ToDate = '')        
  Begin        
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "        
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "        
  End        
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))        
  Begin        
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "        
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "        
  End        
  /*LOGIN CONDITIONS*/        
  Set @strWhere = @strWhere + "area LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "region LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "branch_code LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "sub_broker LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "trader LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "family LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "        
  Set @strWhere = @strWhere + "party_code LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "        
  /*END - LOGIN CONDITIONS*/        
  Set @Comma = ''        
  Set @strGroupBy = @strGroupBy + @Comma        
          
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))        
  Begin        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, Product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "Product_code " End        
   End        
           
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strGroupBy = @strGroupBy + "series_code, Product_code, expirydate, strike_price, product_type "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "Product_code "*/ End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "sauda_date "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, Product_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'PRODUCT') Begin Set @strGroupBy = @strGroupBy + @Comma + "Product_code " End        
   End        
         
   If (@GroupLevel = 'PRODUCT')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Product_code "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "series_code, expirydate, strike_price, product_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, series_code, Product_code, expirydate, strike_price, "        
    Set @strGroupBy = @strGroupBy + "product_type, sauda_date "        
   End        
  End /*If (@OneOrMany = 'DETAIL')*/        
  Else /*If (@OneOrMany = 'DETAIL')*/        
  Begin /*Else OF If (@OneOrMany = 'DETAIL')*/        
   If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End        
   If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "area " End        
   If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End        
   If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End        
   If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End        
   If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End        
  End /*Else OF If (@OneOrMany = 'DETAIL')*/        
  Set @strOrderBy = @strGroupBy        
  Set @strGroupBy = "GROUP BY " + @strGroupBy        
  Set @strOrderBy = "ORDER BY " + @strOrderBy        
 End/*If (@ReportName = "NETPOSITION")*/        
 If @strComputeSub <> ''         
 Begin         
  Set @strComputeSub = "BY " + @strComputeSub         
  Set @strComputeSub = @strCompute + @strComputeSub        
 End        
 If (@IsSubLevel = 'YES')        
 Begin        
  Print (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)        
 End        
 Else        
 Begin        
  Print (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)        
  Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)        
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_StampDuty_New
-- --------------------------------------------------

CREATE proc Rpt_StampDuty_New (@Start_Date Varchar(11), @End_Date Varchar(11))    
 
  
As    
Select    
 Totamt = Sum(TradeQty * MarketRate),
 Client1.Cl_Type,     
 L_State       
Into  
 #StampDuty    
From    
 Bfosettlement, Client2, Client1       
where    
 Sauda_date >= @Start_Date and Sauda_date <= @End_Date + ' 23:59'      
 and Bfosettlement.party_code = Client2.party_code           
 and Client1.Cl_code = Client2.Cl_code           
 and auctionpart not like 'C%'    
 And TradeQty > 0          
group by    
 Client1.Cl_Type, L_State        
  
    
Select       
	TotalAmt = convert(numeric(18,4), sum(totamt)),    
	Cl_Type, L_State    
Into
	#StampDuty_Report    
From   
	#StampDuty   
Where
	L_State = 'MAHARASHTRA'    
Group by  
	Cl_Type, L_State    
Insert Into #StampDuty_Report    
Select       
	TotalAmt = sum(totamt),    
	Cl_Type,  
	L_State = BFoOwner.State    
From   
	#StampDuty, BFoOwner
Where
	Not Exists (Select State From State_Master Where State = L_State )    
Group by   
	Cl_Type, BFoOwner.State    
Insert Into #StampDuty_Report    
Select       
	TotalAmt = sum(totamt),    
	Cl_Type,  
	L_State = 'OTHER'    
From
	#StampDuty  
Where
	Exists (Select State_Master.State From State_Master, BFoOwner 
		Where State_Master.State = L_State And State_Master.State <> BFoOwner.State)    
Group by
	Cl_Type, L_State    
    
Select     
	TotTurn              = isnull(Sum(TotalAmt),0),    
	TotTurnOtherState    = isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0),    
	TotTurnMahState      = isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0),    
	  
	TotTurnMahPro        = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type = 'PRO' Then TotalAmt Else 0 End),0)),    
	TotTurnMahProStamp   = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type = 'PRO' Then TotalAmt Else 0 End),0))*.001/100,    
	  
	TotTurnMahTrd        = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type <> 'PRO' Then TotalAmt Else 0 End),0)),    
	TotTurnMahTrdStamp   = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type <> 'PRO' Then TotalAmt Else 0 End),0))*.002/100,    
	  
	  
	TotalMahStamp        = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type = 'PRO' Then TotalAmt Else 0 End),0))*.001/100    
	                     + Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type <> 'PRO' Then TotalAmt Else 0 End),0))*.002/100,    
	  
	TotTurnOthTrd        = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0)),    
	TotTurnOthTrdStamp   = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.002/100,    
	  
	TotalOthStamp        = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.002/100,    
	  
	TotalStamp           = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type = 'PRO' Then TotalAmt Else 0 End),0))*.001/100    
	                     + Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' And Cl_Type <> 'PRO' Then TotalAmt Else 0 End),0))*.002/100    
	                     + Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.002/100 ,   
	  
	TotTurnMahTrd_B      = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0)),    
	TotTurnMahTrdStamp_B = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.002/100,    
	TotalMahStamp_B      = Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.001/100    
	                     + Pradnya.DBO.RoundedToThousand(isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0))*.002/100    
From
	#StampDuty_Report    
    
Drop Table #StampDuty_Report    
Drop Table #StampDuty

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_Stt_Annexure
-- --------------------------------------------------


CREATE PROCEDURE Rpt_Stt_Annexure    
    
 @dateFrom Varchar(11),    
 @dateTo Varchar(20),    
 @partyFrom Varchar(10),    
 @partyTo Varchar(10),    
 @contnofrom Varchar(15),    
 @contnoto Varchar(15),      
 @statusid varchar(15),      
 @statusname varchar(25),    
 @strbranch varchar(12),      
 @strbranchto varchar(12),      
 @strsubbrokfrom varchar(12),      
 @strsubbrokto varchar(12)         
    
AS    
set @datefrom = ltrim(rtrim(@datefrom)) + ' 00:00:00'      
set @dateto = ltrim(rtrim(@dateto)) + ' 23:59:59'      
set @partyfrom = ltrim(rtrim(@partyfrom))      
set @partyto = ltrim(rtrim(@partyto))      
set @contnofrom = ltrim(rtrim(@contnofrom))      
set @contnoto = ltrim(rtrim(@contnoto))      
set @statusid = ltrim(rtrim(@statusid))      
set @statusname = ltrim(rtrim(@statusname))      
set @strbranch   = ltrim(rtrim(@strbranch))      
set @strbranchto   = ltrim(rtrim(@strbranchto))      
set @strsubbrokfrom = ltrim(rtrim(@strsubbrokfrom))      
set @strsubbrokto = ltrim(rtrim(@strsubbrokto))      
    
if @partyto =''  
        begin  
                Set @partyto = 'zzzzzzzzzzz'  
        end   
if @contnoto = ''  
        begin  
                set @contnoto = '0'  
        end  
if @contnoto=''  
        begin  
                set @contnoto = '99999999999'  
        end      
      
if len(ltrim(rtrim(@strbranchto))) = ''       
begin       
 set @strbranchto = 'zzzzzzzzzzzz'       
       
end      
      
if len(ltrim(rtrim(@strsubbrokto))) = ''      
begin       
 set @strsubbrokto = 'zzzzzzzzzzzz'       
       
end      
      
set transaction isolation level read uncommitted  
      
select    
	Company,Addr1,Addr2,City,Zip,Phone,'BSE FO' ExchangeCode,MemberCode,        
	st.Party_Code,    
	c1.Long_Name,    
	c1.pan_gir_no,    
	left(st.sauda_date,11) sauda_date,    
	st.contractno,    
	isnull(uc.mapidid,'') mapidid,    
	st.Product_Type,    
	st.Product_code,    
	st.Series_Code,    
	st.Series_Id,
	Left(st.Expirydate,11) Expirydate,    
	st.SAmtTrd,    
	st.SSTTTrd,    
	st.TotalSTT,    
	branch_cd,    
	sub_broker,
	L_Address1,
	L_Address2,
	L_Address3,
	L_city,
	L_State,
	L_Nation,
	L_Zip    
from 
	BFoOwner,STT_ClientDetail st, Client1 C1,    
	Client2 C2 left outer join ucc_client uc on C2.Party_Code = uc.Party_Code    
where     
	st.Party_Code = c2.Party_code     
	and C1.cl_code = C2.cl_code    
	and st.sauda_date >= @dateFrom     
	and st.sauda_date <= @dateTo     
	and st.party_code BETWEEN @partyFrom AND @partyTo     
	and st.contractno >= @contnofrom     
	and st.contractno <= @ContnoTo    
	and c2.insurance_chrg = 1     
	
	and branch_cd >= @strbranch and  branch_cd <= @strbranchto         
	and sub_broker >= @strsubbrokfrom  and sub_broker <= @strsubbrokto              
	and @STATUSNAME =   
		(CASE   
		WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
		WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
		WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
		WHEN @STATUSID = 'AREA' THEN C1.AREA  
		WHEN @STATUSID = 'REGION' THEN C1.REGION  
		WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
		ELSE   
			'BROKER'  
		END)   
	and st.TotalSTT > 0    
	and RecType = 30    
	
order by st.sauda_date,branch_cd,sub_broker,st.party_code,st.contractno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_Stt_Certificate
-- --------------------------------------------------

CREATE  proc Rpt_Stt_Certificate   (@datefrom varchar(11),@dateto varchar(11), @partyfrom varchar(10),    
  @partyto varchar(10), @statusid varchar(15), @statusname varchar(25),  @strbranch varchar(12),     
  @strbranchto varchar(12),  @strsubbrokfrom varchar(12),  @strsubbrokto varchar(12) )            
  AS    
           
if len(ltrim(rtrim(@partyto))) = 0     
 begin            
  Set @partyto = 'zzzzzzzz'        
 end    
            
if len(ltrim(rtrim(@strbranchto))) = ''             
 begin             
  set @strbranchto = 'zzzzzzz'  
 end            
            
if len(ltrim(rtrim(@strsubbrokto))) = ''            
 begin             
  set @strsubbrokto = 'zzzzzzzzz'                  
 end            
            
Set transaction isolation level read uncommitted             
       
    
Select Party_code,  TransactionCode = '04', TurnOver = sum(SAmtTrd), Stt = sum(SSTTTrd)        
into #Stt04 from STT_ClientDetail    
where party_code between @partyfrom and @partyto and  sauda_date between @datefrom and  @dateto +' 23:59'     
and  recType = 30 
and  right(Product_Code,3) = 'OPT'    
Group By Party_code Order By Party_code          
    
Select Party_code,  TransactionCode = '05', TurnOver = sum(SAmtTrd), Stt = sum(SSTTTrd)        
into #Stt05 from STT_ClientDetail    
where party_code between @partyfrom and @partyto and  sauda_date between @datefrom and  @dateto +' 23:59'     
and  recType = 30 
and  right(Product_Code,3) = 'FUT'    
Group By Party_code Order By Party_code          
    


Select       
	Company, addr1, addr2, city, zip, phone, 'BSE F&O' exchangecode,       
	membercode,C2.Party_code, long_name,      
	L_address1,      
	L_address2,     
	L_address3,     
	L_City ,    
	Branch_Cd,
	pan_gir_no,' ' mapidid            

into #Client      
      
From       
Client1 C1,Client2 C2,BFoOwner      
Where       
 C1.Cl_Code =c2.Cl_Code and       
 party_code >= @partyfrom and party_code <= @partyto  and           
 branch_cd >= @strbranch and  branch_cd <= @strbranchto  and           
 @STATUSNAME =   
  (CASE   
   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
   WHEN @STATUSID = 'AREA' THEN C1.AREA  
   WHEN @STATUSID = 'REGION' THEN C1.REGION  
   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
   ELSE   
  'BROKER'  
  END)
    
CREATE INDEX [PartyCd] ON [dbo].[#Client] ([Party_Code])


Select Party_Code,'01' TransactionCode ,0 TurnOver,0 STT into #Stt01  From #Client        
Select Party_Code,'02' TransactionCode ,0 TurnOver,0 STT into #Stt02  From #Client        
Select Party_Code,'03' TransactionCode ,0 TurnOver,0 STT into #Stt03  From #Client        


CREATE INDEX [PartyCd] ON [dbo].[#Stt04] ([Party_Code])

CREATE INDEX [PartyCd] ON [dbo].[#Stt05] ([Party_Code])


Insert into #Stt04 Select Party_Code,'04',0,0 From #Client Where Party_Code         
not in (Select Party_Code from #Stt04)        
        
Insert into #Stt05 Select Party_Code,'05',0,0 From #Client Where Party_Code         
not in (Select Party_Code from #Stt05)        
        
    
Select s.Party_code,TransactionCode, TurnOver,  STT           
into #Stt00        
        
From        
        
(         
  Select Party_code,TransactionCode, TurnOver, STT  From #Stt01            
  Union        
  Select Party_code,TransactionCode,TurnOver, STT   From #Stt02        
  Union         
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt03        
  Union         
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt04        
  Union         
  Select Party_code,TransactionCode, TurnOver,  STT  From #Stt05        
        
) S        
        
Order By s.Party_code,TransactionCode        
    
Drop table #Stt01
Drop table #Stt02
Drop table #Stt03
Drop table #Stt04
Drop table #Stt05

CREATE INDEX [PartyCd] ON [dbo].[#Stt00] ([Party_Code])

Select Company, addr1, addr2, city, zip, phone, exchangecode,       
 membercode,long_name, L_address1,L_address2,L_address3, L_City,branch_cd, pan_gir_no, isnull(u.mapidid, '') mapinid,       
 s.Party_code,TransactionCode, TurnOver,  STT, convert(varchar, getdate(), 103) CurDate        
From  #Client C  , #Stt00 S left outer join ucc_client u on (u.party_code = s.party_code)      
where S.Party_Code = C.Party_Code        
and s.party_code in ( select party_code from #Stt00 group by party_code having sum(stt) > 0)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_todaydate
-- --------------------------------------------------
CREATE PROCEDURE rpt_todaydate
AS
select convert(varchar,getdate(),103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addbranch_Execute
-- --------------------------------------------------

--insert into delsegment select * from gunavatta.msajag.dbo.delsegment
  /****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 01/15/2005 4:39:22 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
  
Create Proc Sp_Addbranch_Execute  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddClient_Execute
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.sp_AddClient_Execute    Script Date: 01/15/2005 5:31:32 PM ******/


/****** Object:  Stored Procedure dbo.sp_AddClient_Execute    Script Date: 12/16/2003 2:37:13 PM ******/

CREATE  PROC sp_AddClient_Execute
@strSQL VarChar(8000)
AS
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddEditScrip_Execute
-- --------------------------------------------------
-- Alter this sp under SRE-34143
CREATE PROC [dbo].[sp_AddEditScrip_Execute]
@strSQL VarChar(8000)
AS
SET NOCOUNT ON;
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_clientmargindetails
-- --------------------------------------------------

CREATE proc sp_clientmargindetails      
@statusid varchar(15),        
@statusname varchar(25),        
@fromparty varchar(20),        
@toparty varchar(20),        
@fromdate varchar(11),        
@todate varchar(11),        
@branch varchar(10),        
@trader varchar (10),      
@orderby int        
        
As        
    
if @fromparty = ''    
      begin    
            set @fromparty = '0'    
      end     
    
if @toparty = ''    
      begin    
            set @toparty = 'zzzzzzz'    
      end       
If @orderby = 1      
      
 Begin  
 Select  
  margindate = left(convert(varchar,margindate,109),11),Billdate = left(Convert(Varchar,margindate,103),11),fo.party_code,        
  fo.branch_cd,fo.sub_broker,fo.trader,fo.short_name,billamount = isnull(billamount,0),ledgeramount = isnull(ledgeramount,0),        
  cash_coll = isnull(cash_coll,0),noncash_coll=isnull(noncash_coll,0),        
  initialmargin = isnull(initialmargin,0), MTMMargin = IsNull(MTMMargin,0),year(margindate),month(margindate),day(margindate)        
 From  
   tbl_clientmargin fo,client2 c2, client1 c1, branches b, subbrokers sb        
 Where  
  fo.party_code >= @fromparty        
  And fo.party_code <= @toparty        
  And margindate >= @fromdate        
  And margindate <= @todate + ' 23:59:00'        
  And fo.branch_cd like @branch      
  And fo.trader like @trader      
  And fo.Party_Code = c2.party_code         
  And C1.cl_code = c2.cl_code         
  And ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader))         
  And ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))        
  AND @STATUSNAME =   
  (CASE   
   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
   WHEN @STATUSID = 'AREA' THEN C1.AREA  
   WHEN @STATUSID = 'REGION' THEN C1.REGION  
   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
   ELSE   
  'BROKER'  
  END)        
  Order By   
 fo.party_code,year(margindate),month(margindate),day(margindate)         
 End       
      
If @orderby = 2      
      
 Begin      
      
   Select  
  margindate = left(convert(varchar,margindate,109),11),Billdate = left(Convert(Varchar,margindate,103),11),fo.party_code,        
  fo.branch_cd,fo.sub_broker,fo.trader,fo.short_name,billamount = isnull(billamount,0),ledgeramount = isnull(ledgeramount,0),        
  cash_coll = isnull(cash_coll,0),noncash_coll=isnull(noncash_coll,0),        
  initialmargin = isnull(initialmargin,0), MTMMargin = IsNull(MTMMargin,0),year(margindate),month(margindate),day(margindate)        
   From  
  tbl_clientmargin fo,client2 c2, client1 c1, branches b, subbrokers sb        
   Where  
  fo.party_code >= @fromparty        
  And fo.party_code <= @toparty        
  And margindate >= @fromdate        
  And margindate <= @todate + ' 23:59:00'        
  And fo.branch_cd like @branch      
  And fo.trader like @trader      
  And fo.Party_Code = c2.party_code         
  And C1.cl_code = c2.cl_code         
  AND @STATUSNAME =   
  (CASE   
   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
   WHEN @STATUSID = 'AREA' THEN C1.AREA  
   WHEN @STATUSID = 'REGION' THEN C1.REGION  
   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
   ELSE   
  'BROKER'  
  END)              
   Order By  
  year(margindate),month(margindate),day(margindate),fo.party_code          
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------- 
-- http://vyaskn.tripod.com/code.htm#inserts 
------------------------------------------------------------------------------------------------------------------------ 
--SET NOCOUNT ON 
--GO 
-- 
--PRINT 'Using Master database' 
--USE master 
--GO 
-- 
--PRINT 'Checking for the existence of this procedure' 
--IF (SELECT OBJECT_ID('sp_generate_inserts','P')) IS NOT NULL --means, the procedure already exists 
-- BEGIN 
-- PRINT 'Procedure already exists. So, dropping it' 
-- DROP PROC sp_generate_inserts 
-- END 
--GO 
-- 
----Turn system object marking on 
--EXEC master.dbo.sp_MS_upd_sysobj_category 1 
--GO 
create PROC [dbo].[sp_generate_inserts] 
( 
@table_name varchar(776), -- The table/view for which the INSERT statements will be generated using the existing data 
@target_table varchar(776) = NULL, -- Use this parameter to specify a different table name into which the data will be inserted 
@include_column_list bit = 1, -- Use this parameter to include/ommit column list in the generated INSERT statement 
@from varchar(800) = NULL, -- Use this parameter to filter the rows based on a filter condition (using WHERE) 
@include_timestamp bit = 0, -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement 
@debug_mode bit = 0, -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination 
@owner varchar(64) = NULL, -- Use this parameter if you are not the owner of the table 
@ommit_images bit = 0, -- Use this parameter to generate INSERT statements by omitting the 'image' columns 
@ommit_identity bit = 0, -- Use this parameter to ommit the identity columns 
@top int = NULL, -- Use this parameter to generate INSERT statements only for the TOP n rows 
@cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement 
@cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement 
@disable_constraints bit = 0, -- When 1, disables foreign key constraints and enables them after the INSERT statements 
@ommit_computed_cols bit = 0 -- When 1, computed columns will not be included in the INSERT statement 
) 
AS 
BEGIN 
/*********************************************************************************************************** 
Procedure: sp_generate_inserts (Build 22) 
(Copyright  2002 Narayana Vyas Kondreddi. All rights reserved.) 
Purpose: To generate INSERT statements from existing data. 
These INSERTS can be executed to regenerate the data at some other location. 
This procedure is also useful to create a database setup, where in you can 
script your data along with your table definitions. 
Written by: Narayana Vyas Kondreddi 
http://vyaskn.tripod.com 
Acknowledgements: 
Divya Kalra -- For beta testing 
Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values 
Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables 
Joris Laperre -- For reporting a regression bug in handling text/ntext columns 
Tested on: SQL Server 7.0 and SQL Server 2000 
Date created: January 17th 2001 21:52 GMT 
Date modified: May 1st 2002 19:50 GMT 
Email: vyaskn@hotmail.com 
NOTE: This procedure may not work with tables with too many columns. 
Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types 
Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results 
IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed 
you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts 
like nchar and nvarchar 
Example 1: To generate INSERT statements for table 'titles': 
EXEC sp_generate_inserts 'titles' 
Example 2: To ommit the column list in the INSERT statement: (Column list is included by default) 
IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below, 
to avoid erroneous results 
EXEC sp_generate_inserts 'titles', @include_column_list = 0 
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table: 
EXEC sp_generate_inserts 'titles', 'titlesCopy' 
Example 4: To generate INSERT statements for 'titles' table for only those titles 
which contain the word 'Computer' in them: 
NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter 
EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'" 
Example 5: To specify that you want to include TIMESTAMP column's data as well in the INSERT statement: 
(By default TIMESTAMP column's data is not scripted) 
EXEC sp_generate_inserts 'titles', @include_timestamp = 1 
Example 6: To print the debug information: 
EXEC sp_generate_inserts 'titles', @debug_mode = 1 
Example 7: If you are not the owner of the table, use @owner parameter to specify the owner name 
To use this option, you must have SELECT permissions on that table 
EXEC sp_generate_inserts Nickstable, @owner = 'Nick' 
Example 8: To generate INSERT statements for the rest of the columns excluding images 
When using this otion, DO NOT set @include_column_list parameter to 0. 
EXEC sp_generate_inserts imgtable, @ommit_images = 1 
Example 9: To generate INSERT statements excluding (ommiting) IDENTITY columns: 
(By default IDENTITY columns are included in the INSERT statement) 
EXEC sp_generate_inserts mytable, @ommit_identity = 1 
Example 10: To generate INSERT statements for the TOP 10 rows in the table: 
EXEC sp_generate_inserts mytable, @top = 10 
Example 11: To generate INSERT statements with only those columns you want: 
EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'" 
Example 12: To generate INSERT statements by omitting certain columns: 
EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'" 
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements: 
EXEC sp_generate_inserts titles, @disable_constraints = 1 
Example 14: To exclude computed columns from the INSERT statement: 
EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1 
***********************************************************************************************************/ 
SET NOCOUNT ON 
--Making sure user only uses either @cols_to_include or @cols_to_exclude 
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL)) 
BEGIN 
RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1) 
RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified 
END 
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format 
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_include property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property 
END 
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_exclude property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property 
END 
--Checking to see if the database name is specified along wih the table name 
--Your database context should be local to the table for which you want to generate INSERT statements 
--specifying the database name is not allowed 
IF (PARSENAME(@table_name,3)) IS NOT NULL 
BEGIN 
RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1) 
RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed 
END 
--Checking for the existence of 'user table' or 'view' 
--This procedure is not written to work on system tables 
--To script the data in system tables, just create a view on the system tables and script the view instead 
IF @owner IS NULL 
BEGIN 
IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL)) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
ELSE 
BEGIN 
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
--Variable declarations 
DECLARE @Column_ID int, 
@Column_List varchar(8000), 
@Column_Name varchar(128), 
@Start_Insert varchar(786), 
@Data_Type varchar(128), 
@Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements 
@IDN varchar(128) --Will contain the IDENTITY column's name in the table 
--Variable Initialization 
SET @IDN = '' 
SET @Column_ID = 0 
SET @Column_Name = '' 
SET @Column_List = '' 
SET @Actual_Values = '' 
IF @owner IS NULL 
BEGIN 
SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
ELSE 
BEGIN 
SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
--To get the first column's ID 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop through all the columns of the table, to get the column names and their data types 
WHILE @Column_ID IS NOT NULL 
BEGIN 
SELECT @Column_Name = QUOTENAME(COLUMN_NAME), 
@Data_Type = DATA_TYPE 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE ORDINAL_POSITION = @Column_ID AND 
TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
IF @cols_to_include IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1 
BEGIN 
IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column 
SET @IDN = @Column_Name 
ELSE 
GOTO SKIP_LOOP 
END 
--Making sure whether to output computed columns or not 
IF @ommit_computed_cols = 1 
BEGIN 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Tables with columns of IMAGE data type are not supported for obvious reasons 
IF(@Data_Type in ('image')) 
BEGIN 
IF (@ommit_images = 0) 
BEGIN 
RAISERROR('Tables with image columns are not supported.',16,1) 
PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.' 
PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.' 
RETURN -1 --Failure. Reason: There is a column with image data type 
END 
ELSE 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Determining the data type of the column and depending on the data type, the VALUES part of 
--the INSERT statement is generated. Care is taken to handle columns with NULL values. Also 
--making sure, not to lose any data from flot, real, money, smallmomey, datetime columns 
SET @Actual_Values = @Actual_Values + 
CASE 
WHEN @Data_Type IN ('char','varchar','nchar','nvarchar') 
THEN 
'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('datetime','smalldatetime') 
THEN 
'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')' 
WHEN @Data_Type IN ('uniqueidentifier') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('text','ntext') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('binary','varbinary') 
THEN 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
WHEN @Data_Type IN ('timestamp','rowversion') 
THEN 
CASE 
WHEN @include_timestamp = 0 
THEN 
'''DEFAULT''' 
ELSE 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
END 
WHEN @Data_Type IN ('float','real','money','smallmoney') 
THEN 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ',2)' + ')),''NULL'')' 
ELSE 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ')' + ')),''NULL'')' 
END + '+' + ''',''' + ' + ' 
--Generating the column list for the INSERT statement 
SET @Column_List = @Column_List + @Column_Name + ',' 
SKIP_LOOP: --The label used in GOTO 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
ORDINAL_POSITION > @Column_ID AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop ends here! 
END 
--To get rid of the extra characters that got concatenated during the last run through the loop 
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1) 
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6) 
IF LTRIM(@Column_List) = '' 
BEGIN 
RAISERROR('No columns to select. There should at least be one column to generate the output',16,1) 
RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter 
END 
--Forming the final string that will be executed, to output the INSERT statements 
IF (@include_column_list <> 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' ''+' + '''(' + RTRIM(@Column_List) + '''+' + ''')''' + 
' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
ELSE IF (@include_column_list = 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' '' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
--Determining whether to ouput any debug information 
IF @debug_mode =1 
BEGIN 
PRINT '/*****START OF DEBUG INFORMATION*****' 
PRINT 'Beginning of the INSERT statement:' 
PRINT @Start_Insert 
PRINT '' 
PRINT 'The column list:' 
PRINT @Column_List 
PRINT '' 
PRINT 'The SELECT statement executed to generate the INSERTs' 
PRINT @Actual_Values 
PRINT '' 
PRINT '*****END OF DEBUG INFORMATION*****/' 
PRINT '' 
END 
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas' 
PRINT '--Build number: 22' 
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com' 
PRINT '--http://vyaskn.tripod.com' 
PRINT '' 
PRINT 'SET NOCOUNT ON' 
PRINT '' 
--Determining whether to print IDENTITY_INSERT or not 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON' 
PRINT 'GO' 
PRINT '' 
END 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
PRINT 'GO' 
END 
PRINT '' 
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + '''' 
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes! 
EXEC (@Actual_Values) 
PRINT 'PRINT ''Done''' 
PRINT '' 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
PRINT 'GO' 
END 
PRINT '' 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF' 
PRINT 'GO' 
END 
PRINT 'SET NOCOUNT OFF' 
SET NOCOUNT OFF 
RETURN 0 --Success. We are done! 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_GetPositionSpan
-- --------------------------------------------------

CREATE Procedure Sp_GetPositionSpan  
  (  
 @Sdate varchar(11),    
 @PartyFrom Varchar(10),  
 @PartyTo Varchar(10),  
 @Mode Varchar(10)  
  
  )  
AS    
  
Declare @intMonth int,  
 @intYear int  
  
Select @intMonth=Month(convert(datetime,@Sdate)),@intYear=Year(convert(datetime,@Sdate))  
  
If @PartyTo ='' Begin Set @PartyTo = 'zzzzzz' End  
  
Set Transaction Isolation Level Read Uncommitted  
  
if @Mode ='NORMAL'  
Begin  
 Select   
  Party_code,  
  Inst_type=PRODUCT_CODE,  
  Symbol=PRODUCT_CODE,  
  Expirydate=left(convert(varchar,expirydate,106),11),  
  Option_type=product_type,  
  Strike_price,   
  Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),  
  Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )  
 From  
  BFOSETTLEMENT   
 Where   
  Reserved1 <> 1  
  And Expirydate > @sdate + ' 23:59'    
  And Sauda_date <= @sdate + ' 23:59'    
  And Party_Code BetWeen @PartyFrom and @PartyTo  
 group by   
  Party_code,  
  PRODUCT_CODE,  
  left(convert(varchar,expirydate,106),11),  
  product_type,  
  Strike_price  
 Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0    
End  
Else if @Mode ='3DAYS1'  
Begin  
 Select   
  Party_code,  
  Inst_type=PRODUCT_CODE,  
  Symbol=PRODUCT_CODE,  
  Expirydate=left(convert(varchar,expirydate,106),11),  
  option_type=product_type,  
  Strike_price,   
  Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),  
  Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )  
 From  
  BFOSETTLEMENT   
 Where   
  Reserved1 <> 1  
  And Expirydate > @sdate + ' 23:59'    
  And Sauda_date <= @sdate + ' 23:59'    
  And Party_Code BetWeen @PartyFrom and @PartyTo  
  And Month(expirydate) = @intMonth  
  And Year(expirydate) = @intYear  
 Group by   
  Party_code,  
  PRODUCT_CODE,  
  left(convert(varchar,expirydate,106),11),  
  product_type,  
  Strike_price  
 Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0    
End  
Else if @Mode ='3DAYS2'  
Begin  
 Select   
  Party_code,  
  Inst_type=PRODUCT_CODE,  
  Symbol=PRODUCT_CODE,  
  Expirydate=left(convert(varchar,expirydate,106),11),  
  Option_type=product_type,  
  Strike_price,   
  Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),  
  Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )  
 From  
  BFOSETTLEMENT   
 Where   
  Reserved1 <> 1  
  And Expirydate > @sdate + ' 23:59'    
  And Sauda_date <= @sdate + ' 23:59'    
  And Party_Code BetWeen @PartyFrom and @PartyTo  
  And   
  (  
   Month(expirydate) > @intMonth  
   OR  
   Year(expirydate) > @intYear  
  )  
 Group by   
  Party_code,  
  PRODUCT_CODE,  
  left(convert(varchar,expirydate,106),11),  
  product_type,  
  Strike_price  
 Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_StampDutyDetails
-- --------------------------------------------------

CREATE procedure  sp_StampDutyDetails (@fromdate varchar(11),  @todate varchar(11),@lstClType varchar(10))    
    
as    
    
    
SELECT     
    Sauda_Date = left(convert(varchar,sauda_date,103),11),     
    Totamount = Isnull(Round(Sum( MarketRate * TradeQty ),2),0) ,     
    
    Broker_Chrg = CEILING(sum(tradeqty* case when Auctionpart <> 'EA'  then marketrate else strike_price end * Cast(BFoTaxes.Broker_Note as money) /100)),    
    
    Optionpamt= Isnull(Round(Sum(    
    CASE     
        WHEN BFoSettlement.Product_Code like '%OPT'     
        AND Auctionpart =''     
        THEN Tradeqty*MarketRate     
        ELSE 0     
    END    
    ),2),0),     
    Futamt= Isnull(Round(Sum(    
    CASE     
        WHEN BFoSettlement.Product_Code like '%FUT'     
        AND Auctionpart ='0'     
        THEN Tradeqty*MarketRate     
        ELSE 0     
    END    
    ),2),0),     
    Eaamt= CEILING(Isnull(Sum(    
    CASE     
        WHEN BFoSettlement.Product_Code like '%OPT'     
        AND Auctionpart ='EA'     
        THEN Tradeqty*Strike_Price     
        ELSE 0     
    END    
    ),0))    
FROM BFoSettlement ,     
 Client1,     
 Client2,     
 BFoOwner,    
 BFoTaxes     
WHERE BFoSettlement.Party_Code = Client2.Party_Code     
    AND Client1.Cl_Code = Client2.Cl_Code     
    AND Auctionpart <> 'ca'     
    AND sauda_date BETWEEN @fromdate AND @todate  + ' 23:59'    
    AND Client1.Cl_Type like     
    CASE     
        WHEN @lstClType <>'All'     
        THEN @lstClType     
        ELSE '%'     
    END     
AND BFoTaxes.Trans_Cat ='TRD'    
    
GROUP BY left(convert(varchar,sauda_date,103),11)    
ORDER BY left(convert(varchar,sauda_date,103),11)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_Charges_Final
-- --------------------------------------------------




CREATE Proc STT_Charges_Final (@Sauda_Date Varchar(11)) As        
      
Declare       
@TrdBuyTrans Numeric(18,4),        
@TrdSellTrans Numeric(18,4)      
        
Select @TrdBuyTrans = 0         
Select @TrdSellTrans = 0        
        
Select @TrdBuyTrans = TrdBuyTrans, @TrdSellTrans = TrdSellTrans      
From BFoGlobals         
Where year_start_dt <= @Sauda_Date And year_end_dt >= @Sauda_Date        
        
If (@TrdBuyTrans > 0 Or @TrdSellTrans > 0)      
Begin        
       
	Update BFoSettlement set Ins_chrg = 0 where sauda_date like @Sauda_Date + '%'      
	  
	/*charges for purchase*/       
	Update BFoSettlement set ins_chrg = Round((TradeQty * MarketRate  * @TrdBuyTrans / 100),4)      
	where sauda_date like @Sauda_Date + '%' and Sell_buy = 1  and AuctionPart = '0' and TradeQty > 0      
	  
	/*charges for sell*/      
	Update BFoSettlement set ins_chrg = ins_chrg + Round((TradeQty * MarketRate  * @TrdSellTrans / 100),4)      
	where sauda_date like @Sauda_Date + '%' and Sell_buy = 2  and AuctionPart = '0' and TradeQty > 0      
	    
	/*inserting STT charges (Detail) for reporting*/        
	Exec STT_InsertData_Detail @Sauda_Date        
	
	/* Rounding for 1 Rs. Start */        
	Select ContractNo, Party_Code, ActChrg = Sum(Ins_Chrg), TobeChrg = Round(Sum(Ins_Chrg),0)         
	Into #SettRound From BFoSettlement         
	Where Sauda_Date Like @Sauda_Date + '%' And TradeQty > 0         
	And AuctionPart = '0'      
	Group By ContractNo, Party_Code      
	     
	Select S.ContractNo, S.Party_Code, Trade_No = Min(Trade_No)         
	Into #SettSTTParty From BFoSettlement S, #SettRound A         
	Where Sauda_Date Like @Sauda_Date + '%' And TradeQty > 0         
	And AuctionPart ='0'      
	And A.Party_Code = S.Party_Code
	And Ins_Chrg >= (Case When ToBeChrg-ActChrg < 0 Then abs(ToBeChrg-ActChrg) Else 0 End)    
	And Ins_Chrg > 0
	And S.ContractNo = A.ContractNo        
	Group By s.ContractNo, S.Party_Code        
	     
	Update BFoSettlement Set Ins_Chrg = Ins_Chrg + (ToBeChrg-ActChrg)        
	From #SettSTTParty A, #SettRound S        
	Where Sauda_Date Like @Sauda_Date + '%' And TradeQty > 0         
	And BFoSettlement.Party_Code = A.Party_Code        
	And BFoSettlement.Party_Code = S.Party_Code        
	And AuctionPart = '0'      
	And BFoSettlement.Trade_No = A.Trade_No        
	And BFoSettlement.ContractNo = A.ContractNo        
	And S.ContractNo = A.ContractNo     
	And BFoSettlement.Ins_Chrg > 0     
	  
	/*inserting STT charges (Summary) for reporting*/        
	Exec STT_InsertData_Summary @Sauda_Date        
	
	Update BFoSettlement Set Ins_Chrg = 0    
	From Client2 C     
	Where BFoSettlement.Party_Code = C.Party_Code    
	And Insurance_Chrg = 0 And Sauda_Date Like @Sauda_Date + '%'             
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_InsertData_Detail
-- --------------------------------------------------



CREATE Proc STT_InsertData_Detail (@Sauda_Date Varchar(11)) As   

Declare 
@TrdBuyTrans Numeric(18,4),  
@TrdSellTrans Numeric(18,4)
  
Select @TrdBuyTrans = 0   
Select @TrdSellTrans = 0  
  
Select @TrdBuyTrans = TrdBuyTrans, @TrdSellTrans = TrdSellTrans
From BFoGlobals   
Where year_start_dt <= @Sauda_Date And year_end_dt >= @Sauda_Date  

Delete From STT_ClientDetail Where sauda_Date Like @Sauda_Date + '%' and RecType = 30

Insert Into STT_ClientDetail   
	(RecType,Sauda_Date,ContractNo,Party_Code,
	Product_Type,Product_Code,Series_Code,Series_Id,Expirydate,
	TrdPrice,PQtyTrd,PAmtTrd,PSTTTrd,SQtyTrd,SAmtTrd,SSTTTrd,TotalSTT)

Select 30,Left(Convert(Varchar,Sauda_Date,109),11),ContractNo,Party_Code,
	Product_Type,Product_Code,Series_Code,Series_Id,ExpiryDate,MarketRate,
	Sum(Case when sell_buy=1 and @TrdBuyTrans > 0 then TradeQty else 0 end),
	Sum(Case when sell_buy=1 and @TrdBuyTrans > 0 then (TradeQty * MarketRate) else 0 end),
	Sum(Case when sell_buy=1 and @TrdBuyTrans > 0 then Ins_Chrg else 0 end),
	Sum(Case when sell_buy=2 and @TrdSellTrans > 0 then TradeQty else 0 end),
	Sum(Case when sell_buy=2 and @TrdSellTrans > 0 then (TradeQty * MarketRate) else 0 end),
	Sum(Case when sell_buy=2 and @TrdSellTrans > 0 then Ins_Chrg else 0 end),
	Sum(Ins_Chrg) From BFoSettlement where 
	sauda_date like @Sauda_Date + '%' and AuctionPart = '0' and TradeQty > 0
 And Sell_Buy = 2 
Group by Left(Convert(Varchar,Sauda_Date,109),11),ContractNo,Party_Code,
	Product_Type,Product_Code,Series_Code,Series_Id,Expirydate,MarketRate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_InsertData_Summary
-- --------------------------------------------------




CREATE Proc STT_InsertData_Summary (@Sauda_Date Varchar(11)) As   

Delete From STT_ClientDetail Where sauda_Date Like @Sauda_Date + '%'  and RecType = 20

Insert Into STT_ClientDetail   
	(RecType,Sauda_Date,ContractNo,Party_Code,
	Product_Type,Product_Code,Series_Code,Series_Id,Expirydate,
	TrdPrice,PQtyTrd,PAmtTrd,PSTTTrd,SQtyTrd,SAmtTrd,SSTTTrd,TotalSTT)

Select 20,Left(Convert(Varchar,Sauda_Date,109),11),'',Party_Code,
	'','','','','',	0,0,0,0,0,Sum(TradeQty*MarketRate),0,Sum(Ins_Chrg) 
From BFoSettlement where 
	sauda_date like @Sauda_Date + '%' and AuctionPart = '0' and TradeQty > 0
 And Sell_Buy = 2 
Group by Left(Convert(Varchar,Sauda_Date,109),11),Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_Matching
-- --------------------------------------------------



CREATE  Proc STT_Matching 
	(
		@Sauda_Date_From Varchar(11),
		@Sauda_Date_To Varchar(11),
		@Party_From Varchar(10),
		@Party_To Varchar(10),
		@Show Varchar(4)
	) AS

if @Party_To = '' begin set @Party_To = 'zzzzzzz' end
Select 
	Bo_Sauda_Date = isnull(Bo_Sauda_Date,''),
	Bo_Party_Code = isnull(Bo_Party_Code,''),
	Bo_TotTurnOver = isnull(Bo_TotTurnOver,0),
	Bo_TotStt = isnull(Bo_TotStt,0),
	Ex_Stt_Date = isnull(Ex_Stt_Date,''),
	Ex_Party_Code = isnull(Ex_Party_Code,''),
	Ex_TotTurnOver = isnull(Ex_TotTurnOver,0),
	Ex_TotStt = isnull(Ex_TotStt,0),
	Stt_Diff = isnull(Bo_TotStt,0)- isnull(Ex_TotStt,0)
From

(
	Select	
		Bo_Sauda_Date = Convert(Varchar,Sauda_Date,103),		
		Bo_Party_Code = Party_Code,
		Bo_TotTurnOver = SAmtTrd,  
		Bo_TotStt = TotalStt
	From 
		STT_ClientDetail 
	Where 
		Sauda_Date between @Sauda_Date_From  and @Sauda_Date_To + ' 23:59'
		And Party_code between @Party_From  and @Party_To
		And RecType ='20'
) BoStt

Full Outer Join

(
	Select 
		Ex_Stt_Date = Convert(Varchar,Stt_Date,103),
		Ex_Party_Code = Party_Code,
		Ex_TotTurnOver = Tot_TurnOver,
		Ex_TotStt = abs(Tot_Stt)
	From 
		STT_Exchg
	Where 
		Stt_Date between @Sauda_Date_From  and @Sauda_Date_To + ' 23:59'
		And Party_code between @Party_From  and @Party_To
	
) ExStt
On
	(
		Ex_Stt_Date = Bo_Sauda_Date
		And Bo_Party_Code = Ex_Party_Code
	)


Where 1 = Case When @Show ='' then 1 else  case when Bo_TotStt-Ex_TotStt > 0 then 2 else 1 end end 
Order By 
	isnull(Bo_Sauda_Date,''), isnull(Ex_Stt_Date,''),isnull(Bo_Party_Code,''),isnull(Ex_Party_Code,'')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.update_bfoexerciseallocation
-- --------------------------------------------------

CREATE procedure [dbo].[update_bfoexerciseallocation]        
@Billdate as varchar(11)        
as    
select  Filedate=left(convert(varchar,filedate,109),11),    
 party_code,    
 Cl_Type,    
        Product_type,    
 Product_Code,    
 Series_Code,    
        Series_ID,    
        strike_price,    
 CallPut,    
 Settlement_Price,    
 exercise_quantity,    
 openposition,'EA' as auctionpart ,    
 expirydate = (select bfoscrip2.expirydate from bfoscrip2 where bfoscrip2.series_code = bfooptionexercise.series_code and  bfoscrip2.series_id = bfooptionexercise.series_id),
 expdt = (select bfoscrip2.expirydate from bfoscrip2 where bfoscrip2.series_code = bfooptionexercise.series_code and  bfoscrip2.series_id = bfooptionexercise.series_id)
from bfooptionexercise    
where  Filedate like  @Billdate +'%'    
 and InOutAtTheMoney = 'I'    
and exercise_quantity <> 0    
union all    
select  Filedate=left(convert(varchar,filedate,109),11),    
 party_code,    
 Cl_Type,    
        Product_type,    
 Product_Code,    
 Series_Code,    
        Series_ID,    
        strike_price,    
 CallPut,    
 Settlement_Price,    
 Exercise_quantity,    
 openposition,'OA' as auctionpart,    
 expirydate = (select bfoscrip2.expirydate from bfoscrip2 where bfoscrip2.series_code = bfooptionassigned.series_code and  bfoscrip2.series_id = bfooptionassigned.series_id),
 expdt = (select bfoscrip2.expirydate from bfoscrip2 where bfoscrip2.series_code = bfooptionassigned.series_code and  bfoscrip2.series_id = bfooptionassigned.series_id)
from bfooptionassigned    
where  Filedate like @Billdate +'%'    
and exercise_quantity <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------


CREATE PROC UPDATEACMAST
	@EXCHANGE VARCHAR(20),
	@SEGMENT VARCHAR(20),
	@COMPANY VARCHAR(100)
AS
DECLARE
	@@SHAREDB AS VARCHAR(50),
	@@GRPCODE AS VARCHAR(50),
	@@SQL AS VARCHAR(2000)
/*
	EXEC UPDATEACMAST 'NSE', 'CAPITAL', 'MOTILAL OSWAL SECURITIES LTD'
*/
SELECT @@SHAREDB = ''
SELECT TOP 1
	@@SHAREDB = SHAREDB
FROM
	PRADNYA.DBO.MULTICOMPANY
WHERE
	EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	AND COMPANYNAME = @COMPANY
	AND PRIMARYSERVER = 1

SELECT @@GRPCODE = ''
SELECT
	@@GRPCODE = ISNULL(GRPCODE, '')
FROM
	OWNER O,
	GRPMAST G
WHERE
	O.CLIENTGROUP = G.GRPNAME
IF @@SHAREDB = ''
	BEGIN
		SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'
		RETURN
	END
BEGIN TRANSACTION
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , (CASE WHEN CL_TYPE = 'REM' THEN 'LIABILITY' ELSE 'ASSET' END), (CASE WHEN CL_TYPE = 'REM' THEN '3' ELSE '4' END), '', PARTY_CODE , '', "
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "
SELECT @@SQL = @@SQL + "AND PARTY_CODE NOT IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT IN(3, 4)) "
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "
SELECT @@SQL = @@SQL + "AND ISNULL(LEDGER.ACNAME, '') <> A.LONGNAME "

--PRINT @@SQL
EXEC (@@SQL)
COMMIT TRANSACTION
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'

SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UpdateRegion
-- --------------------------------------------------
  
CREATE proc UpdateRegion  
as  
truncate table region  
insert into region select * from anand1.msajag.dbo.region

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_APPLICATION_LOG
-- --------------------------------------------------

CREATE proc V2_APPLICATION_LOG  
(  
          @FromDate VARCHAR(11),              
          @ToDate VARCHAR(11),              
          @LoginName  VARCHAR(10),  
          @ReportType varchar(10)  
)              
  
AS              
              
/*              
  SET @FromDate = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@FromDate,'/',''),'-',''),112),11)              
  SET @ToDate = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@ToDate,'/',''),'-',''),112),11)              
*/  
  SET @FromDate = LEFT(CONVERT(DATETIME,@FromDate,105),11)              
  SET @ToDate = LEFT(CONVERT(DATETIME,@ToDate,105),11)              
  
  
if @ReportType = 'LOGIN LOG'  
begin  
 if @LoginName = ''  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   [Action],   
   AddDt as [Activity Time]  
  FROM  
   V2_LOGIN_LOG (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
  Order by AddDt  
 end  
 else  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   [Action],   
   AddDt as [Activity Time]  
  FROM  
   V2_LOGIN_LOG (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
   AND USERNAME LIKE @LoginName + '%'  
  Order by AddDt  
 end  
end  
  
if @ReportType = 'ACCESS LOG'  
begin  
 if @LoginName = ''  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   RepPath [Report Path],   
   AddDt as [Activity Time]  
  FROM  
   V2_Report_Access_Log (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
  Order by AddDt  
 end  
 else  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   RepPath [Report Path],   
   AddDt as [Activity Time]  
  FROM  
   V2_Report_Access_Log (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
   AND USERNAME LIKE @LoginName + '%'  
  Order by AddDt  
 end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKBLOCKEDREPORTS
-- --------------------------------------------------
  
CREATE PROCEDURE V2_CHECKBLOCKEDREPORTS  
                @RPTPATH VARCHAR(100)  
                  
AS  
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED  
    
  SET NOCOUNT ON  
          
  IF (SELECT COUNT(1)  
      FROM   TBLREPORTS_BLOCKED WITH (NOLOCK)  
      WHERE  BLOCK_FLAG = 1  
             AND LTRIM(RTRIM(FLDPATH)) = left(LTRIM(RTRIM(@RPTPATH)),len(FLDPATH))) > 0   
  BEGIN   
    SELECT '<font color = red><b>UPDATION IN PROGRESS!! </b></font>'  
  END   
  ELSE   
  BEGIN   
    SELECT ''   
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CLASS_PROC_ENTITYMASTER
-- --------------------------------------------------

CREATE PROC V2_CLASS_PROC_ENTITYMASTER  
  
as  
  
  SELECT ENT_TYPE = A.ENT_TYPE,   
         NO_OF_UNITS = ISNULL(NO_OF_UNITS,0),   
         NO_OF_LOGIN = ISNULL(NO_OF_LOGIN,0),   
         NO_OF_USERS = ISNULL(NO_OF_USERS,0)   
  FROM   (SELECT ENT_TYPE,   
                 NO_OF_UNITS = COUNT(1),   
                 ORDER_BY  
          FROM   V2_CLASS_VW_ENTITYMASTER   
          GROUP BY ENT_TYPE,ORDER_BY) A   
            LEFT OUTER JOIN   
            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
             FROM   (SELECT FLDADMINAUTO,   
                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
                     FROM   TBLPRADNYAUSERS   
                     GROUP BY FLDADMINAUTO) U,   
                     TBLADMIN A   
             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
             GROUP BY FLDSTATUS) B  
             ON A.ENT_TYPE = B.ENT_TYPE    
              LEFT OUTER JOIN   
                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
                        NO_OF_USERS = SUM(NO_OF_USERS)   
                 FROM   (SELECT FLDADMINAUTO,   
                                FLDSTNAME,   
                                NO_OF_USERS = COUNT(1)   
                         FROM TBLPRADNYAUSERS   
                         GROUP BY FLDADMINAUTO,   
                          FLDSTNAME) U, TBLADMIN A   
                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
                 GROUP BY FLDSTATUS) C   
                 ON A.ENT_TYPE = C.ENT_TYPE   
  ORDER BY ORDER_BY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION
-- --------------------------------------------------

Create Procedure  dbo.V2_CONTSECTION   
 (   
	 @STATUSID VARCHAR(15),   
	 @STATUSNAME VARCHAR(25),   
	 @SAUDA_DATE VARCHAR(11),   
	 @FROMPARTY_CODE VARCHAR(10),   
	 @TOPARTY_CODE VARCHAR(10),   
	 @BRANCH VARCHAR(10),   
	 @SUB_BROKER VARCHAR(10),   
	 @FROMCONTRACTNO VARCHAR(12),   
	 @TOCONTRACTNO VARCHAR(12),   
	 @CONTFLAG VARCHAR(10)   
 )   
   
 AS   

 Declare @_TOSAUDA_DATE VARCHAR(11),
		 @_Status Char(1)    


 SET @_TOSAUDA_DATE=@SAUDA_DATE

 If @SUB_BROKER = 'ALL' OR @SUB_BROKER = ''   
 Begin   
		Set @SUB_BROKER = '%'   
 End   
 If @BRANCH = 'ALL' OR @BRANCH = ''   
 Begin   
         Set @BRANCH = '%'   
 End   
 If @FROMCONTRACTNO = ''  
 Begin  
  set @FROMCONTRACTNO = 000000  
 End  
   
 If @TOCONTRACTNO = ''  
 Begin  
  Set @TOCONTRACTNO = 99999999  
 End  

/*------------------  CANNED CONTRACT PLUG IN ------------------------*/  

IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (nolock) WHERE SAUDA_DATE >= @SAUDA_DATE)  
BEGIN  
 EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@BRANCH,@SUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@_TOSAUDA_DATE,@_Status Output  
 IF  @_Status =1  
	RETURN  
END   

/*---------------------------------------------------------------------*/  


SELECT  C2.PARTY_CODE,   
        C1.LONG_NAME,   
        C1.L_ADDRESS1,   
        C1.L_ADDRESS2,   
        C1.L_ADDRESS3,   
        C1.L_CITY,   
        C1.L_STATE,   
        C1.L_ZIP,   
        C1.BRANCH_CD ,   
        C1.SUB_BROKER,   
        C1.TRADER,   
        C1.PAN_GIR_NO,   
        C1.OFF_PHONE1,   
        C1.OFF_PHONE2,   
        PRINTF,   
        MAPIDID,   
        C2.SERVICE_CHRG,   
        BROKERNOTE,   
        TURNOVER_TAX,   
        SEBI_TURN_TAX,   
        C2.OTHER_CHRG,   
        INSURANCE_CHRG,  
 SEBI_NO = FD_Code  
INTO    #CLIENTMASTER   
FROM    CLIENT1 C1   
WITH   
        (   
                NOLOCK   
        )   
        ,   
        CLIENT2 C2   
WITH   
        (   
                NOLOCK   
        )   
LEFT OUTER JOIN UCC_CLIENT UC   
WITH   
        (   
                NOLOCK   
        )   
        ON C2.PARTY_CODE = UC.PARTY_CODE   
WHERE   C2.CL_CODE       = C1.CL_CODE   
        AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE   
        AND @STATUSNAME = (   
        CASE   
                WHEN @STATUSID = 'BRANCH'   
                THEN C1.BRANCH_CD   
                WHEN @STATUSID = 'SUBBROKER'   
                THEN C1.SUB_BROKER   
                WHEN @STATUSID = 'TRADER'   
                THEN C1.TRADER   
                WHEN @STATUSID = 'FAMILY'   
                THEN C1.FAMILY   
                WHEN @STATUSID = 'AREA'   
                THEN C1.AREA   
                WHEN @STATUSID = 'REGION'   
                THEN C1.REGION   
                WHEN @STATUSID = 'CLIENT'   
                THEN C2.PARTY_CODE   
                ELSE 'BROKER' END)   
        AND BRANCH_CD LIKE @BRANCH   
        AND SUB_BROKER LIKE @SUB_BROKER   
SELECT  Contractno,   
        Billno,   
        Trade_No,   
        Party_Code,  
		Product_Type,  
		Product_Code,  
		Series_Code,  
		Series_ID,  
		MarketRate,   
        Expirydate,   
        Strike_Price,   
        User_Id,   
        Pro_Cli,   
        Tradeqty,   
        Auctionpart,   
        Markettype,   
        Series,   
        Order_No,   
        Sauda_Date,   
        Table_No,   
        Line_No,   
        Val_Perc,   
        Normal,   
        Day_Puc,   
        Day_Sales,   
        Sett_Purch,   
        Sett_Sales,   
        Sell_Buy,   
        Settflag,   
        Brokapplied,   
        Netrate,   
        Amount,   
        Ins_Chrg,   
        Turn_Tax,   
        Other_Chrg,   
        Sebi_Tax,   
        Broker_Chrg,   
        Service_Tax,   
        Trade_Amount,   
        Billflag,   
        Sett_No,   
        Nbrokapp,   
        Nsertax,   
        N_Netrate,   
        Sett_Type,   
        Cl_Rate,   
        Participantcode,   
        Status,   
        Order_Date,   
        Instrument,   
        Booktype,   
        Branch_Id,   
        Tmark,   
        Scheme,   
        Dummy1,   
        Dummy2,   
        Reserved1,   
        Reserved2   
INTO    #FOSETT   
FROM    BFOSETTLEMENT   
WHERE   1 = 2   
INSERT   
INTO    #FOSETT   
SELECT  Contractno,   
        Billno,   
        Trade_No,   
        Party_Code,   
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
 MarketRate,   
        Expirydate,   
        Strike_Price,   
        User_Id,   
        Pro_Cli,   
        Tradeqty,   
        Auctionpart,   
        Markettype,   
        Series,   
        Order_No,   
      Sauda_Date,   
        Table_No,   
        Line_No,   
        Val_Perc,   
        Normal,   
        Day_Puc,   
        Day_Sales,   
        Sett_Purch,   
        Sett_Sales,   
        Sell_Buy,   
        Settflag,   
        Brokapplied,   
        Netrate,   
        Amount,   
        Ins_Chrg,   
        Turn_Tax,   
        Other_Chrg,   
        Sebi_Tax,   
        Broker_Chrg,   
        Service_Tax,   
        Trade_Amount,   
        Billflag,   
        Sett_No,   
        Nbrokapp,   
        Nsertax,   
        N_Netrate,   
        Sett_Type,   
        Cl_Rate,   
        Participantcode,   
        Status,   
        Order_Date,   
        Instrument,   
        Booktype,   
        Branch_Id,   
        Tmark,   
        Scheme,   
        Dummy1,   
        Dummy2,   
        Reserved1,   
        Reserved2   
FROM    BFOSETTLEMENT   
WHERE   sauda_date LIKE @SAUDA_DATE + '%'   
        AND party_code >= @FROMPARTY_CODE   
        AND party_code <= @TOPARTY_CODE   
        AND auctionpart NOT IN ('CA')   
        AND tradeqty <> 0   
        AND MARKETRATE > 0   
        AND RESERVED1 = 0   
  
Create  INDEX [DELPOS]   
        ON [dbo].[#FOSETT]   
        (   
                [PARTY_CODE]   
        )   
  
SELECT  order_no,   
        ORDER_TIME = Convert(Varchar,order_date,108),   
        Trade_no,   
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) as tradetime,   
        pqty = (   
        CASE   
                WHEN sell_buy = 1   
                THEN tradeqty   
                ELSE 0 END),   
        sqty = (   
        CASE   
                WHEN sell_buy = 2   
                THEN tradeqty   
                ELSE 0 END),   
        prate = (   
        CASE   
                WHEN sell_buy = 1   
                THEN isnull(MarketRate,0)   
                ELSE 0 END),   
        srate = (   
        CASE   
                WHEN sell_buy = 2   
                THEN isnull(MarketRate,0)   
                ELSE 0 END),   
        pbrok =(   
        CASE   
                WHEN sell_buy = 1   
                THEN isnull((brokapplied + (   
                CASE   
                        WHEN C.service_chrg=1   
                        THEN isnull(f.SERVICE_TAX/tradeqty,0)   
                        ELSE 0 END )),0)   
                ELSE 0 END),   
        sbrok =(   
        CASE   
                WHEN sell_buy = 2   
                THEN isnull((brokapplied + (   
                CASE   
                        WHEN C.service_chrg=1   
                        THEN isnull(f.SERVICE_TAX/tradeqty,0)   
                        ELSE 0 END )),0)   
                ELSE 0 END),   
        PNetRate = (   
        CASE   
                WHEN sell_buy =1   
                THEN isnull(netrate + (   
                CASE   
                        WHEN C.service_chrg = 1   
                        THEN isnull((f.service_tax/TradeQty),0)   
                        ELSE 0 END),0)   
                ELSE 0 END),   
        SNetRate = (   
        CASE   
                WHEN sell_buy =2   
                THEN isnull(netrate - (   
                CASE   
                        WHEN C.service_chrg = 1   
                        THEN isnull((f.service_tax/TradeQty),0)   
                        ELSE 0 END),0)   
                ELSE 0 END),   
        isnull(amount,0) amount ,   
        Product_Type= (   
        CASE   
                WHEN f.auctionpart = 'EA'   
                THEN stuff(Product_Type,1,3,'EA-')   
                ELSE Product_Type END),   
 Product_Code = (   
        CASE   
                WHEN f.auctionpart = 'EA'   
                THEN stuff(Product_Code,1,3,'EA-')   
                ELSE Product_Code END),  
 Series_Code,  
 Series_ID,  
        pAmt=(   
        CASE   
                WHEN sell_buy = 1   
                THEN (tradeqty * netrate) + (   
                CASE   
                        WHEN C.service_chrg = 1   
                        THEN isnull((f.service_tax),0)   
                        ELSE (   
                        CASE   
                                WHEN C.service_chrg = 0   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.service_chrg = 2   
                                        THEN 0   
                                        ELSE 0 END) END ) END )   
                ELSE 0 END),   
        sAmt=(   
        CASE   
                WHEN sell_buy = 2   
                THEN(tradeqty * netrate) - (   
                CASE   
                        WHEN C.service_chrg = 1   
                        THEN isnull((f.service_tax),0)   
                        ELSE (   
                        CASE   
                                WHEN C.service_chrg = 0   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.service_chrg = 2   
                                        THEN 0   
                                        ELSE 0 END ) END ) END)   
                ELSE 0 END),   
        LEFT(CONVERT(VARCHAR,expirydate,106),11) as expirydate,   
        f.party_code,   
        sell_buy,   
        contractno,   
        convert(varchar,sauda_date,103) as sauda_date,   
        isnull(strike_price,0) strike_price,   
        pservice_Tax= (   
        CASE   
                WHEN sell_buy = 1   
                THEN (   
                CASE   
                        WHEN C.service_chrg=0   
                        THEN (f.service_tax)   
                        ELSE (   
                        CASE   
                                WHEN C.service_chrg=1   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.service_chrg=2   
                                        THEN 0 END) END) END)   
                ELSE 0 END),   
        sservice_Tax= (   
        CASE   
                WHEN sell_buy = 2   
                THEN (   
                CASE   
                        WHEN C.service_chrg=0   
                        THEN (f.service_tax)   
                        ELSE (   
                        CASE   
                                WHEN C.service_chrg=1   
                                THEN 0   
                                ELSE (   
                                CASE   
                                        WHEN C.service_chrg=2   
                                        THEN 0 END) END) END)   
                ELSE 0 END),   
        yy          =year(sauda_date),   
        mm          =month(sauda_date),   
        dd          =day(sauda_date),   
        DFlag       = 1 ,   
        Broker_Chrg = (   
        CASE   
                WHEN BrokerNote = 1   
                THEN Broker_Chrg   
                ELSE 0 END ),   
        turn_tax = (   
        CASE   
                WHEN Turnover_tax = 1   
                THEN turn_tax   
                ELSE 0 END),   
        sebi_tax = (   
        CASE   
                WHEN Sebi_Turn_tax = 1   
                THEN sebi_tax   
                ELSE 0 END),   
        other_chrg = (   
        CASE   
                WHEN C.Other_chrg = 1   
                THEN f.other_chrg   
                ELSE 0 END) ,   
        Ins_Chrg = (   
        CASE   
                WHEN Insurance_Chrg = 1   
                THEN Ins_chrg   
                ELSE 0 END ),   
        Service_Tax = (   
        CASE   
                WHEN Service_chrg = 0   
                THEN Service_Tax   
                ELSE 0 END ),   
        NSerTax = (   
        CASE   
                WHEN Service_chrg = 0   
                THEN Service_Tax  
                ELSE 0 END ),   
        Brokerage = isnull(tradeqty*brokapplied,0),   
        C.Branch_cd ,   
        C.Sub_broker,   
        C.Trader,   
        PRINTF,     
        C.service_chrg,     
        PARTYNAME=long_name,   
        L_ADDRESS1,   
        L_ADDRESS2,   
        L_ADDRESS3,   
        L_CITY,   
        L_STATE,   
        L_ZIP,   
        PAN_GIR_NO,   
        OFF_PHONE1,           OFF_PHONE2,     
        MAPIDID,  
 SEBI_NO  
INTO    #CONTSETT   
FROM    #FOSETT F,   
        #CLIENTMASTER C   
WHERE   f.party_code     >= @FROMPARTY_CODE   
        AND f.party_code <= @TOPARTY_CODE   
 AND contractno BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO  
        AND f.party_code=C.party_code   
  
  
UPDATE     
 #CONTSETT    
SET    
 Brokerage = Case When Sell_Buy =1 then CD_Tot_BuyBrok Else CD_Tot_SellBrok End    
      + (Case When Service_Chrg = 1 Then     
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end    
        Else 0 End),    
 Service_Tax = Service_Tax+(Case When Service_Chrg = 0 Then     
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end    
   Else 0 End),    
 NSerTax = (Case When Service_Chrg = 0 Then     
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end    
   Else 0 End),    
 PService_Tax = (Case When Service_Chrg = 0 Then     
   Case When Sell_Buy =1 then Service_Tax+CD_Tot_BuySerTax Else 0 end    
   Else 0 End),    
 SService_Tax = (Case When Service_Chrg = 0 Then     
   Case When Sell_Buy =1 then 0 Else Service_Tax+CD_Tot_SellSerTax end    
   Else 0 End),    
        pAmt=(CASE WHEN sell_buy = 1 THEN (PQty * PRate)+ CD_Tot_BuyBrok     
  + (Case When Service_Chrg = 1 Then Service_Tax+isnull((CD_Tot_BuySerTax),0) Else 0 End)    
              ELSE 0 END),     
        SAmt=(CASE WHEN sell_buy = 2 THEN (SQty * SRate) - CD_Tot_SellBrok     
  - (Case When Service_Chrg = 1 Then Service_Tax+isnull((CD_Tot_SellSerTax),0) Else 0 End)    
              ELSE 0 END)    
     
FROM    
 CHARGES_DETAIL    
WHERE    
 Convert(Varchar,CD_Sauda_Date,103) = Convert(Varchar,Sauda_Date,103)    
 And CD_Party_Code = #CONTSETT.Party_Code     
 And CD_Product_Type = Product_Type  
 And CD_Product_Code = Product_Code  
 And CD_Series_Id = Series_Id  
 And CD_Series_Code = Series_Code  
 And Convert(Varchar,CD_Expiry_Date,106) = ExpiryDate    
 And CD_Trade_No = Trade_No    
 And CD_Order_No = Order_No    
    
  
Insert into #ContSett    
SELECT  CD_order_no,     
 ORDER_TIME = '',     
 CD_Trade_no,     
 tradetime='',     
 pqty = 0,     
 sqty = 0,     
 prate = 0,     
 srate = 0,     
 pbrok =0,     
 sbrok =0,     
 PNetRate = 0,     
 SNetRate = 0,     
 amount =0,     
 CD_Product_Type,     
 CD_Product_Code,  
 CD_Series_Code =(Case When CD_Series_Code = '' Then 'CONT BROK' Else CD_Series_Code End),     
 CD_Series_Id,  
 pAmt=0,     
 sAmt=0,     
 (Case When CD_Series_Code = '' Then '' Else   
 LEFT(CONVERT(VARCHAR,cd_expiry_date,106),11) End) as expirydate,     
 CD_party_code,    
 Sell_Buy = 1,     
 CD_contract_no,     
 convert(varchar,CD_sauda_date,103) as sauda_date,     
 strike_price = 0 ,  
 PService_Tax = (Case When Service_Chrg = 0 Then     
  CD_Tot_BuySerTax    
  Else 0 End),    
 SService_Tax = 0,    
 yy          =year(CD_sauda_date),     
 mm          =month(CD_sauda_date),     
 dd          =day(CD_sauda_date),     
 DFlag       = 1 ,     
 Broker_Chrg = 0,     
 turn_tax = 0,     
 sebi_tax = 0,     
 other_chrg = 0 ,     
 Ins_Chrg = 0,     
 Service_Tax = (Case When Service_Chrg = 0 Then     
  CD_Tot_BuySerTax     
  Else 0 End),    
 nsertax= (Case When Service_Chrg = 0 Then     
  CD_Tot_BuySerTax     
  Else 0 End),    
 Brokerage = CD_Tot_BuyBrok     
  + (Case When Service_Chrg = 1 Then     
  CD_Tot_BuySerTax     
  Else 0 End),    
 C.Branch_cd ,     
 C.Sub_broker,     
 C.Trader,     
 PRINTF,       
 C.service_chrg,       
 PARTYNAME=long_name,     
 L_ADDRESS1,     
 L_ADDRESS2,     
 L_ADDRESS3,     
 L_CITY,     
 L_STATE,     
 L_ZIP,     
 PAN_GIR_NO,     
 OFF_PHONE1,     
 OFF_PHONE2,       
 MAPIDID,    
 SEBI_NO  
FROM    CHARGES_DETAIL f,     
        #CLIENTMASTER C     
WHERE   CD_Sauda_Date Like @SAUDA_DATE + '%'    
 And CD_party_code     >= '0'     
 AND CD_party_code <= 'zz'     
 AND CD_contract_no BETWEEN (     
 CASE     
         WHEN CD_Product_Code like 'opt%'     
         AND CD_AuctionPart ='EA'     
         THEN 0     
         ELSE '0' END)     
 AND '9999'     
 AND CD_party_code=C.party_code    
 And CD_Trade_No = ''    
 And CD_Tot_BuyBrok > 0    
    
Insert into #ContSett    
SELECT  CD_order_no,     
 ORDER_TIME = '',     
 CD_Trade_no,     
 tradetime='',     
 pqty = 0,     
 sqty = 0,     
 prate = 0,     
 srate = 0,     
 pbrok =0,     
 sbrok =0,     
 PNetRate = 0,     
 SNetRate = 0,     
 amount =0,     
 CD_Product_Type,     
 CD_Product_Code,  
 CD_Series_Code =(Case When CD_Series_Code = '' Then 'CONT BROK' Else CD_Series_Code End),     
 CD_Series_Id,  
 pAmt=0,     
 sAmt=0,     
 (Case When CD_Series_Code = '' Then '' Else   
  LEFT(CONVERT(VARCHAR,cd_expiry_date,106),11) End) as expirydate,     
 CD_party_code,    
 Sell_Buy = 1,     
 CD_contract_no,     
 convert(varchar,CD_sauda_date,103) as sauda_date,     
 strike_price = 0 ,  
 PService_Tax = 0 ,    
 SService_Tax = (Case When Service_Chrg = 0 Then     
  CD_Tot_SellSerTax    
  Else 0 End),    
 yy          =year(CD_sauda_date),     
 mm          =month(CD_sauda_date),     
 dd          =day(CD_sauda_date),     
 DFlag       = 1 ,     
 Broker_Chrg = 0,     
 turn_tax =0,     
 sebi_tax =0,     
 other_chrg = 0,     
 Ins_Chrg = 0,     
 Service_Tax = (Case When Service_Chrg = 0 Then     
  CD_Tot_SellSerTax     
  Else 0 End),    
 nsertax= (Case When Service_Chrg = 0 Then     
  CD_Tot_SellSerTax     
  Else 0 End),    
 Brokerage = CD_Tot_SellBrok     
  + (Case When Service_Chrg = 1 Then     
  CD_Tot_SellSerTax     
  Else 0 End),    
 C.Branch_cd ,     
 C.Sub_broker,     
 C.Trader,     
 PRINTF,       
 C.service_chrg,       
 PARTYNAME=long_name,     
 L_ADDRESS1,     
 L_ADDRESS2,     
 L_ADDRESS3,     
 L_CITY,     
 L_STATE,     
 L_ZIP,     
 PAN_GIR_NO,     
 OFF_PHONE1,     
 OFF_PHONE2,       
 MAPIDID,    
 SEBI_NO  
FROM    CHARGES_DETAIL f,     
        #CLIENTMASTER C     
WHERE   CD_Sauda_Date Like @SAUDA_DATE + '%'    
 And CD_party_code     >= '0'     
 AND CD_party_code <= 'zz'     
 AND CD_contract_no BETWEEN (     
 CASE     
         WHEN CD_Product_Code like 'opt%'     
         AND CD_AuctionPart ='EA'     
         THEN 0     
         ELSE '0' END)     
 AND '9999'     
 AND CD_party_code=C.party_code    
 And CD_Trade_No = ''    
 And CD_Tot_SellBrok > 0      
  
  
  
  
  
SELECT  ORDER_NO='0000000000000000',   
        ORDER_TIME      = '          ',   
        TRADE_NO        ='00000000000000',   
        tradetime       ='0000000000000',   
        PQTY            =SUM(PQTY),   
        SQTY            =SUM(SQTY),   
        PRATE           =(   
        CASE   
                WHEN SUM(PQTY) > 0   
                THEN SUM(PRATE*PQTY)/SUM(PQTY)   
                ELSE 0 END),   
        SRATE=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SRATE*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        PBROK=(   
        CASE   
                WHEN SUM(PQTY) > 0   
                THEN SUM(PBROK*PQTY)/SUM(PQTY)   
                ELSE 0 END ),   
        SBROK=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SBROK*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        PNETRATE=(   
        CASE   
                WHEN SUM(PQTY) > 0   
                THEN SUM(PNETRATE*PQTY)/SUM(PQTY)   
                ELSE 0 END ),   
        SNETRATE=(   
        CASE   
                WHEN SUM(SQTY) > 0   
                THEN SUM(SNETRATE*SQTY)/SUM(SQTY)   
                ELSE 0 END ),   
        amount=SUM(AMOUNT),   
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        PAMT=SUM(PAMT),   
        SAMT=SUM(sAmt),   
        expirydate,   
        party_code,   
        sell_buy,   
        contractno,   
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),   
        strike_price,   
        Pservice_Tax=SUM(Pservice_Tax),   
        Sservice_Tax=SUM(Sservice_Tax),   
        yy,   
        mm,   
        dd,   
        DFlag,   
        BROKER_CHRG = SUM(BROKER_CHRG),   
        TURN_TAX    = SUM(TURN_TAX),   
        SEBI_TAX    = SUM(SEBI_TAX),   
        OTHER_CHRG  = SUM(OTHER_CHRG) ,   
        INS_CHRG    = SUM(INS_CHRG),   
        SERVICE_TAX = SUM(SERVICE_TAX),   
        NSERTAX     = SUM(NSERTAX),   
        BROKERAGE   = SUM(BROKERAGE),   
        Branch_cd,   
        Sub_broker,   
        Trader,   
        PRINTF,     
        service_chrg,     
        PARTYNAME,   
        L_ADDRESS1,   
        L_ADDRESS2,   
        L_ADDRESS3,   
        L_CITY,   
        L_STATE,   
        L_ZIP,   
        PAN_GIR_NO,   
        OFF_PHONE1,   
        OFF_PHONE2,     
        MAPIDID,  
 SEBI_NO  
INTO    #CONTSETTNEW   
FROM    #CONTSETT   
WHERE   PRINTF = '3'   
GROUP BY Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        expirydate,   
        party_code,   
        sell_buy,   
        contractno,   
        strike_price,   
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),   
        yy,   
        mm,   
        dd,   
        DFlag,   
        Branch_cd,   
        Sub_broker,   
        Trader,   
        PRINTF,     
        service_chrg,     
        PARTYNAME,   
        L_ADDRESS1,   
        L_ADDRESS2,   
        L_ADDRESS3,   
        L_CITY,   
        L_STATE,   
        L_ZIP,   
        PAN_GIR_NO,   
        OFF_PHONE1,   
        OFF_PHONE2,     
        MAPIDID,  
 SEBI_NO  
INSERT   
INTO    #CONTSETTNEW SELECT  *   
FROM    #CONTSETT   
WITH   
        (   
                NOLOCK   
        )   
WHERE   PRINTF <> '3'   
UPDATE #CONTSETTNEW   
        SET ORDER_NO = S.ORDER_NO,   
        ORDER_TIME   = S.ORDER_TIME,   
        tradetime    = S.tradetime,   
        TRADE_NO     = S.TRADE_NO   
FROM    #CONTSETT S   
WITH   
        (   
                NOLOCK   
        )   
WHERE   S.PRINTF           = #CONTSETTNEW.PRINTF   
        AND S.PRINTF       = '3'   
        AND S.PARTY_CODE   = #CONTSETTNEW.PARTY_CODE   
 AND S.PRODUCT_TYPE = #CONTSETTNEW.PRODUCT_TYPE  
 AND S.PRODUCT_CODE = #CONTSETTNEW.PRODUCT_CODE  
 AND S.SERIES_CODE  = #CONTSETTNEW.SERIES_CODE  
 AND S.SERIES_ID    = #CONTSETTNEW.SERIES_ID  
        AND S.EXPIRYDATE   = #CONTSETTNEW.EXPIRYDATE   
        AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE   
        AND S.SELL_BUY     = #CONTSETTNEW.SELL_BUY   
        AND S.SAUDA_DATE   =   
        (SELECT MIN(SAUDA_DATE)   
        FROM    #CONTSETT ISETT   
        WITH   
                (   
                        NOLOCK   
                )   
        WHERE   PRINTF             = '3'   
                AND S.PARTY_CODE   = ISETT.PARTY_CODE   
  AND S.PRODUCT_TYPE = ISETT.PRODUCT_TYPE  
  AND S.PRODUCT_CODE = ISETT.PRODUCT_CODE  
  AND S.SERIES_CODE  = ISETT.SERIES_CODE  
  AND S.SERIES_ID    = ISETT.SERIES_ID  
              AND S.EXPIRYDATE   = ISETT.EXPIRYDATE   
                AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE   
                AND S.SELL_BUY     = ISETT.SELL_BUY   
        )   
  
IF (@CONTFLAG = 'CONTRACT')  
BEGIN   
SELECT  ORDER_NO,  
        ORDER_TIME,  
        TRADE_NO,  
        TM=tradetime,    
 QTY = PQTY + SQTY,  
 BUYSELL = Case When PQTY >0 then 'BUY' else 'SELL' End ,  
        PQTY,  
        SQTY,    
        Rate = PRate + SRate,    
        PRATE,  
        SRATE,    
        BROK=PBrok+SBrok,    
        PBROK,  
        SBROK,    
        NETRATE = PNETRATE + SNETRATE,    
        PNETRATE,  
        SNETRATE,    
        amount,  
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        AMT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN -PAMT   
                ELSE SAMT END),   
        PAMT,   
        SAMT,   
        AMTSTT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN -(PAMT+INS_CHRG)   
                ELSE (SAMT-INS_CHRG) END),   
        PAMTSTT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN PAMT+INS_CHRG   
                ELSE 0 END),   
        SAMTSTT = (   
        CASE   
                WHEN SELL_BUY = 2   
                THEN SAMT-INS_CHRG   
                ELSE 0 END),   
        expirydate,  
        party_code,  
        sell_buy,  
        contractno,  
        SAUDA_DATE,  
        SDT=SAUDA_DATE,  
        strike_price,    
        Pservice_Tax,  
        Sservice_Tax,  
        yy,  
        mm,  
        dd,  
        DFlag,  
   BROKER_CHRG,  
        TURN_TAX,  
        SEBI_TAX,  
        OTHER_CHRG,    
        PINS_CHRG=(  
        CASE   
                WHEN Sell_Buy = 1   
                THEN Ins_Chrg   
                ELSE 0 END),    
        SINS_CHRG=(  
        CASE   
                WHEN Sell_Buy = 2   
                THEN Ins_Chrg   
                ELSE 0 END),    
        INS_CHRG,  
        SERVICE_TAX,  
        NSERTAX,  
        BROKERAGE,  
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
        Branch_cd,  
        Sub_broker,  
        Trader,  
        PRINTF,  
        service_chrg,     
        PARTYNAME,   
        L_ADDRESS1,   
        L_ADDRESS2,   
        L_ADDRESS3,   
        L_CITY,   
        L_STATE,   
        L_ZIP,   
 SEBI_NO,  
        PAN_GIR_NO,   
        OFF_PHONE1,   
        OFF_PHONE2,     
        MAPIDID,    
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
        PMARKETAMT = PRATE * PQTY ,   
        SMARKETAMT = SRATE * SQTY ,   
        Series     = '',  
        TMARK      ='',    
        ScripName  =  RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108) ,  
        PScripName = (Case When Sell_Buy=1 Then   
   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
  ELSE '' END),     
        SScripName = (Case When Sell_Buy=2 Then  
   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
  ELSE '' END)     
FROM    #CONTSETTNEW   
WITH   
        (   
                NOLOCK   
        )   
WHERE   PRINTF <> 1   
ORDER BY BRANCH_CD,   
        SUB_BROKER,   
        TRADER,   
        PARTY_CODE,   
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        EXPIRYDATE,   
        STRIKE_PRICE,   
        ORDER_NO,   
        TRADE_NO   
END   
ELSE BEGIN   
SELECT  ORDER_NO,  
        ORDER_TIME,  
        TRADE_NO,  
        TM=tradetime,   
 QTY = PQTY + SQTY,  
 BUYSELL = Case When PQTY >0 then 'BUY' else 'SELL' End ,  
        PQTY,  
        SQTY,    
        Rate = PRate + SRate,    
        PRATE,  
        SRATE,    
        BROK=PBrok+SBrok,    
        PBROK,  
        SBROK,    
        NETRATE = PNETRATE + SNETRATE,    
        PNETRATE,  
        SNETRATE,    
        amount,  
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        AMT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN -PAMT   
                ELSE SAMT END),   
        PAMT,   
        SAMT,   
        AMTSTT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN -(PAMT+INS_CHRG)   
                ELSE (SAMT-INS_CHRG) END),   
        PAMTSTT = (   
        CASE   
                WHEN SELL_BUY = 1   
                THEN PAMT+INS_CHRG   
                ELSE 0 END),   
        SAMTSTT = (   
        CASE   
                WHEN SELL_BUY = 2   
                THEN SAMT-INS_CHRG   
                ELSE 0 END),   
        expirydate,  
        party_code,  
        sell_buy,  
        contractno,  
        SAUDA_DATE,  
        SDT=SAUDA_DATE,  
        strike_price,    
        Pservice_Tax,  
        Sservice_Tax,  
        yy,  
        mm,  
        dd,  
        DFlag,  
        BROKER_CHRG,  
        TURN_TAX,  
        SEBI_TAX,  
        OTHER_CHRG,    
        PINS_CHRG=(  
        CASE   
                WHEN Sell_Buy = 1   
                THEN Ins_Chrg   
                ELSE 0 END),    
        SINS_CHRG=(  
        CASE   
                WHEN Sell_Buy = 2   
                THEN Ins_Chrg   
                ELSE 0 END),    
        INS_CHRG,  
        SERVICE_TAX,  
        NSERTAX,  
        BROKERAGE,  
        PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
        SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
        Branch_cd,  
        Sub_broker,  
        Trader,  
        PRINTF,  
        service_chrg,     
        PARTYNAME,   
        L_ADDRESS1,   
        L_ADDRESS2,   
        L_ADDRESS3,   
        L_CITY,   
        L_STATE,   
        L_ZIP,   
 SEBI_NO,  
        PAN_GIR_NO,   
        OFF_PHONE1,   
        OFF_PHONE2,     
        MAPIDID,    
        MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
        PMARKETAMT = PRATE * PQTY ,   
        SMARKETAMT = SRATE * SQTY ,   
        Series     = '',  
        TMARK      ='',    
        ScripName  =  RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108) ,  
        PScripName = (Case When Sell_Buy=1 Then   
   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
  ELSE '' END),     
        SScripName = (Case When Sell_Buy=2 Then  
   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
  ELSE '' END)     
FROM    #CONTSETTNEW   
WITH   
        (   
                NOLOCK   
        )   
ORDER BY BRANCH_CD,   
SUB_BROKER,   
        TRADER,   
        PARTY_CODE,   
 Product_Type,  
 Product_Code,  
 Series_Code,  
 Series_ID,  
        EXPIRYDATE,   
        STRIKE_PRICE,   
        ORDER_NO,   
        TRADE_NO   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL
-- --------------------------------------------------


Create  PROC dbo.V2_CONTSECTION_DETAIL     
(    
  @STATUSID VARCHAR(15),    
  @STATUSNAME VARCHAR(25),     
  @SAUDA_DATE VARCHAR(11),     
  @FROMPARTY_CODE VARCHAR(10),     
  @TOPARTY_CODE VARCHAR(10),     
  @BRANCH VARCHAR(10),     
  @SUB_BROKER VARCHAR(10),     
  @FROMCONTRACTNO VARCHAR(12),     
  @TOCONTRACTNO VARCHAR(12),     
  @CONTFLAG VARCHAR(10),  
  @TOSAUDA_DATE VARCHAR(11) = '',
  @Status As Char(1) Output      
)     
AS  
BEGIN
    

--Check whether records present or not
	IF Not Exists (Select 1 FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM 
	 WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.Party_Code = C.Party_Code    
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.Party_Code >= @FROMPARTY_CODE   
	 AND CM.Party_Code <= @TOPARTY_CODE   
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO And @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER    
     AND @STATUSNAME = (  
    CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  )
      BEGIN
		SET @Status =0
        RETURN 
      END  

	IF (@CONTFLAG = 'CONTRACT')  
	BEGIN   
	SELECT  ORDER_NO,  
			ORDER_TIME,  
			TRADE_NO,  
			TM=tradetime,    
	 QTY = PQTY + SQTY,  
	 BUYSELL = Case When PQTY >0 then 'BUY' else 'SELL' End ,  
			PQTY,  
			SQTY,    
			Rate = PRate + SRate,    
			PRATE,  
			SRATE,    
			BROK=PBrok+SBrok,    
			PBROK,  
			SBROK,    
			NETRATE = PNETRATE + SNETRATE,    
			PNETRATE,  
			SNETRATE,    
			amount,  
	 Product_Type,  
	 Product_Code,  
	 Series_Code,  
	 Series_ID,  
			AMT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -PAMT   
					ELSE SAMT END),   
			PAMT,   
			SAMT,   
			AMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -(PAMT+INS_CHRG)   
					ELSE (SAMT-INS_CHRG) END),   
			PAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN PAMT+INS_CHRG   
					ELSE 0 END),   
			SAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SAMT-INS_CHRG   
					ELSE 0 END),   
			expirydate,  
			CM.party_code,  
			sell_buy,  
			contractno,  
			SAUDA_DATE,  
			SDT=SAUDA_DATE,  
			strike_price,    
			Pservice_Tax,  
			Sservice_Tax,  
			yy          =year(Sauda_Date),     
			mm          =month(Sauda_Date),     
			dd          =day(Sauda_Date),
			DFlag,  
	   BROKER_CHRG,  
			TURN_TAX,  
			SEBI_TAX,  
			C.OTHER_CHRG,    
			PINS_CHRG=(  
			CASE   
					WHEN Sell_Buy = 1   
					THEN Ins_Chrg   
					ELSE 0 END),    
			SINS_CHRG=(  
			CASE   
					WHEN Sell_Buy = 2   
					THEN Ins_Chrg   
					ELSE 0 END),    
			INS_CHRG,  
			SERVICE_TAX,  
			NSERTAX,  
			BROKERAGE,  
			PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
			SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
			CM.Branch_cd,  
			CM.SUBBROKER AS SUB_BROKER,  
			CM.Trader,  
			C.PRINTF,  
			C.service_chrg,     
			CM.PARTYNAME,   
			CM.L_ADDRESS1,   
			CM.L_ADDRESS2,   
			CM.L_ADDRESS3,   
			CM.L_CITY,   
			CM.L_STATE,   
			CM.L_ZIP,   
	 CM.SEBI_NO,  
			CM.PAN_GIR_NO,   
			Cm.OFF_PHONE1,   
			CM.OFF_PHONE2,     
			CM.MAPIDID,    
			MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
			PMARKETAMT = PRATE * PQTY ,   
			SMARKETAMT = SRATE * SQTY ,   
			Series     = '',  
			TMARK      ='',    
			ScripName  =  RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108) ,  
			PScripName = (Case When Sell_Buy=1 Then   
	   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
	  ELSE '' END),     
			SScripName = (Case When Sell_Buy=2 Then  
	   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
	  ELSE '' END)     
	FROM     CONTRACT_DATA C (NOLOCK) ,  CONTRACT_MASTER CM
	WHERE   C.PRINTF <> 1  AND  CM.Party_Code = C.Party_Code    
	 AND SAUDA_DATE >= @SAUDA_DATE   
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.Party_Code >= @FROMPARTY_CODE   
	 AND Cm.Party_Code <= @TOPARTY_CODE   
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO And @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER       
     AND @STATUSNAME = (  
    CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  
	ORDER BY CM.BRANCH_CD,   
			SUB_BROKER,   
			CM.TRADER,   
			CM.PARTY_CODE,   
	 Product_Type,  
	 Product_Code,  
	 Series_Code,  
	 Series_ID,  
			EXPIRYDATE,   
			STRIKE_PRICE,   
			ORDER_NO,   
			TRADE_NO   
	END  
 
	ELSE BEGIN   
	SELECT  ORDER_NO,  
			ORDER_TIME,  
			TRADE_NO,  
			TM=tradetime,   
	 QTY = PQTY + SQTY,  
	 BUYSELL = Case When PQTY >0 then 'BUY' else 'SELL' End ,  
			PQTY,  
			SQTY,    
			Rate = PRate + SRate,    
			PRATE,  
			SRATE,    
			BROK=PBrok+SBrok,    
			PBROK,  
			SBROK,    
			NETRATE = PNETRATE + SNETRATE,    
			PNETRATE,  
			SNETRATE,    
			amount,  
	 Product_Type,  
	 Product_Code,  
	 Series_Code,  
	 Series_ID,  
			AMT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -PAMT   
					ELSE SAMT END),   
			PAMT,   
			SAMT,   
			AMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN -(PAMT+INS_CHRG)   
					ELSE (SAMT-INS_CHRG) END),   
			PAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN PAMT+INS_CHRG   
					ELSE 0 END),   
			SAMTSTT = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SAMT-INS_CHRG   
					ELSE 0 END),   
			expirydate,  
			CM.party_code,  
			sell_buy,  
			contractno,  
			SAUDA_DATE,  
			SDT=SAUDA_DATE,  
			strike_price,    
			Pservice_Tax,  
			Sservice_Tax,  
			yy          =year(Sauda_Date),     
			mm          =month(Sauda_Date),     
			dd          =day(Sauda_Date),
			DFlag,  
			BROKER_CHRG,  
			TURN_TAX,  
			SEBI_TAX,  
			C.OTHER_CHRG,    
			PINS_CHRG=(  
			CASE   
					WHEN Sell_Buy = 1   
					THEN Ins_Chrg   
					ELSE 0 END),    
			SINS_CHRG=(  
			CASE   
					WHEN Sell_Buy = 2   
					THEN Ins_Chrg   
					ELSE 0 END),    
			INS_CHRG,  
			SERVICE_TAX,  
			NSERTAX,  
			BROKERAGE,  
			PBROKERAGE=(CASE WHEN SELL_BUY = 1 THEN BROKERAGE ELSE 0 END),  
			SBROKERAGE=(CASE WHEN SELL_BUY = 2 THEN BROKERAGE ELSE 0 END),  
			CM.Branch_cd,  
			SUBBROKER AS Sub_broker,  
			CM.Trader,  
			C.PRINTF,  
			C.service_chrg,     
			CM.PARTYNAME,   
			CM.L_ADDRESS1,   
			CM.L_ADDRESS2,   
			CM.L_ADDRESS3,   
			CM.L_CITY,   
			CM.L_STATE,   
			CM.L_ZIP,   
	        CM.SEBI_NO,  
			CM.PAN_GIR_NO,   
			CM.OFF_PHONE1,   
			CM.OFF_PHONE2,     
			CM.MAPIDID,    
			MARKETAMT  = (PRATE + SRATE) * (PQTY+SQTY),   
			PMARKETAMT = PRATE * PQTY ,   
			SMARKETAMT = SRATE * SQTY ,   
			Series     = '',  
			TMARK      ='',    
			ScripName  =  RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108) ,  
			PScripName = (Case When Sell_Buy=1 Then   
	   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
	  ELSE '' END),     
			SScripName = (Case When Sell_Buy=2 Then  
	   RTRIM(product_code) + ' ' + RTRIM(Series_code) + ' ' + CONVERT(VARCHAR,Series_id,108)   
	  ELSE '' END)     
	FROM    CONTRACT_DATA C (NOLOCK) ,CONTRACT_MASTER  CM 
	 WHERE SAUDA_DATE >= @SAUDA_DATE  AND  CM.Party_Code = C.Party_Code    
	 AND SAUDA_DATE <= @TOSAUDA_DATE  
	 AND CM.Party_Code >= @FROMPARTY_CODE   
	 AND CM.Party_Code <= @TOPARTY_CODE   
	 AND CONTRACTNO BETWEEN @FROMCONTRACTNO And @TOCONTRACTNO     
     AND BRANCH_CD LIKE @BRANCH   
     AND SUBBROKER LIKE @SUB_BROKER    
     AND @STATUSNAME = (  
    CASE  
        WHEN @STATUSID = 'BRANCH'     
        THEN CM.BRANCH_CD     
        WHEN @STATUSID = 'SUBBROKER'     
        THEN CM.SUBBROKER     
        WHEN @STATUSID = 'TRADER'     
        THEN CM.TRADER     
        WHEN @STATUSID = 'FAMILY'     
        THEN CM.FAMILY     
        WHEN @STATUSID = 'AREA'     
        THEN CM.AREA     
        WHEN @STATUSID = 'REGION'     
        THEN CM.REGION     
        WHEN @STATUSID = 'CLIENT'     
        THEN CM.PARTY_CODE     
        ELSE 'BROKER'   
		END)  
	ORDER BY CM.BRANCH_CD,   
	SUB_BROKER,   
			CM.TRADER,   
			CM.PARTY_CODE,   
	 Product_Type,  
	 Product_Code,  
	 Series_Code,  
	 Series_ID,  
			EXPIRYDATE,   
			STRIKE_PRICE,   
			ORDER_NO,   
			TRADE_NO   
	END

   IF @@RowCount>0 
      SET @Status=1 
   ELSE 
	SET @Status=0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOBillDetail
-- --------------------------------------------------




---EXEC V2_FOBillDetail 'broker','broker','Jun 13 2006','0','ZZ','','zzzzzzz','','zzzzzzz'


CREATE   PROC V2_FOBillDetail
	(
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@FromDate VarChar(11),
	@FromPartyCode VarChar(20),
	@ToPartyCode VarChar(20),
	@FROMBRANCH VARCHAR(10),
	@TOBRANCH VARCHAR(10),
	@FROMSUB_BROKER VARCHAR(10),
	@TOSUB_BROKER VARCHAR(10)
	)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT
	partyname = f.party_name,
	f.party_code, 
	f.client_type, 
	c1.l_address1, 
	c1.l_address2,
	c1.l_address3,
	c1.L_city,
	c1.L_State,
	c1.L_Nation,
	c1.L_Zip,
        C1.OFF_PHONE1, 
        C1.OFF_PHONE2, 
	f.branch_code Branch_Cd,
	f.branch_code,
	f.SUB_BROKER,
        C1.TRADER,
	C1.PAN_GIR_NO,
	C2.service_chrg,
	BillNo = '0000000000',
	Case When Len(c1.email) = 0 Then '_' Else c1.email End AS email,
	Inst_Type = Product_Code,
	Symbol = Series_code,
	Convert(VarChar, f.expirydate, 103) AS expirydate,
	f.strike_price, 
	Option_Type = (Case When f.Product_Type = '' Then '' Else f.Product_Type End),
	Convert(VarChar, f.sauda_date, 103) AS saudadate,
        ScripName  = (RTrim(Product_Code) + ' '
			+ RTrim(Series_code) + ' '
			+ Left(ExpiryDate,11) + ' '
			+ (CASE WHEN strike_Price > 0 THEN RTrim(Convert(Varchar,strike_Price)) + '' ELSE + ' ' END)
			+ (CASE WHEN Product_Type <> '' THEN RTrim(Product_Type) ELSE + '' END) ),
	Cl_Rate AS CLRATE,	
	Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End End AS prate,    
	Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End End AS srate,    
	
	Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,    
	Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,    
	
	Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End AS pbillamt,    
	Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End AS sbillamt,    

	Sum((f.pbillamt)) - Sum((f.sbillamt) ) AS diff,    
	Sum(((f.cl_chrg - f.excl_chrg) + (f.service_tax - f.exser_tax) + (f.sebi_tax) + (f.turn_tax) + (f.broker_note) + (f.ins_chrg) + (f.other_chrg)) ) AS chrg_total,    
	Sum((f.pbillamt) + ((f.service_tax) + (f.turn_tax) + (f.sebi_tax) + (f.broker_note) +  (f.ins_chrg) + (f.other_chrg) + (f.cl_chrg-f.excl_chrg)) ) - Sum((f.sbillamt)  ) AS finalfigure,    

	CLCHARGES = Sum(f.cl_chrg - f.excl_chrg), /* CLEARING CHARGES */
	SERVICE_TAX = Sum(f.service_tax - f.exser_tax), /* SERVICE TAX */
	SEBI_TAX = Sum(f.sebi_tax), /* SEBI TAX */
	TURN_TAX = Sum(f.turn_tax), /* TURNOVER TAX */
	BROKER_NOTE = Sum(f.broker_note), /* STAMP DUTY */
	INS_CHRG = Sum(f.ins_chrg), /* INS CHARGES */
	OTHER_CHRG = Sum(f.other_chrg), /* OTHERCHARGES */

	Case When f.tradetype = 'BF' 
		Then '<FONT Style="COLOR: #ff0000;">' + f.tradetype + '</FONT>'     
	        Else Case When AuctionPart = 'EA' And product_code Like 'FUT%'     
			Then '<FONT Style="COLOR:BLUE;">' + 'FF'  + '</FONT>'     
	        	Else Case When AuctionPart = 'EA' And product_code Like 'OPT%'     
				Then '<FONT Style="COLOR:GREEN;">' + 'EA'  + '</FONT>'     
				Else f.tradetype     
	                 	End     
			End     
		End AS tradetype,    

	 Case When f.tradetype = 'BF' 
		Then f.tradetype    
		Else Case When AuctionPart = 'EA' And product_code Like 'FUT%'     
			Then  'FF'     
			Else Case When AuctionPart = 'EA' And product_code Like 'OPT%'     
				Then  'EA'     
				Else f.tradetype     
				End     
			End     
		End AS tradetypeprint     

INTO #FOBILL

FROM
	Bfobillvalan F (nolock), 
	client1 c1 (nolock), 
	client2 c2 (nolock)

WHERE
	c1.cl_code = c2.cl_code
	AND c2.party_code = f.party_code
	AND f.party_code >= @FromPartyCode
	AND f.party_code <= @ToPartyCode
	AND f.sauda_date LIKE @FromDate +'%'
 	AND f.tradetype like 
		(Case When product_code Like 'OPT%' 
			Then 'BT' 
			Else '%' 
			End )
	AND @statusName = (case when @Statusid = 'branch' then isnull(f.branch_code,'')
				when @Statusid = 'subbroker' then isnull(f.sub_broker,'')
				when @Statusid = 'trader' then isnull(f.trader,'')
				when @Statusid = 'family' then isnull(f.Family,'')
				when @Statusid = 'area' then isnull(f.area,'')
				when @Statusid = 'region' then isnull(f.region,'')
				when @Statusid = 'client' then isnull(f.party_code,'')
				when @Statusid = 'broker' then @statusname
				End)
        AND F.BRANCH_CODE 	>= @FROMBRANCH 
        AND F.BRANCH_CODE 	<= @TOBRANCH 
        AND F.SUB_BROKER 	>= @FROMSUB_BROKER
        AND F.SUB_BROKER 	<= @TOSUB_BROKER 

GROUP BY 
	f.branch_code,
	f.SUB_BROKER,
        C1.TRADER, 
	f.party_code, 
	f.party_name, 
	f.client_type, 
	f.Series_Code, 
	f.Product_Code, 
	f.expirydate, 
	f.strike_price, 
	f.Product_Type,
	c1.l_address1, 
	c1.l_address2, 
	c1.l_address3,
	c1.L_city,
	c1.L_State,
	c1.L_Nation,
	c1.L_Zip,
	f.tradetype, 
        C1.OFF_PHONE1, 
        C1.OFF_PHONE2, 
	f.sauda_date,
	c1.email,
	cl_rate,
	AuctionPart,
	C1.PAN_GIR_NO,
	C2.service_chrg,
	BillNo

ORDER BY 
	f.party_code, 
	f.party_name, 
	f.branch_code,
	f.SUB_BROKER,
	f.client_type, 
	f.Series_Code, 
	f.Product_Code, 
	f.expirydate, 
	f.strike_price, 
	f.Product_Type, 
	f.tradetype, 
	f.sauda_date

--COMPUTE
--	Sum(Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End), /* PAMT */ 
--	Sum(Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End), /* SAMT */
--	Sum(Sum((f.pbillamt) ) - Sum((f.sbillamt) )),  /*DIFF = PAMT-SAMT*/
--	Sum(Sum(((f.cl_chrg - f.excl_chrg) + (f.service_tax - f.exser_tax) + (f.sebi_tax) + (f.turn_tax) + (f.broker_note) + (f.ins_chrg) + (f.other_chrg)) )), /* TOTAL OF CHARGES */
--	Sum(Sum((f.pbillamt) + ((f.service_tax- f.exser_tax) + (f.turn_tax) + (f.sebi_tax) + (f.broker_note) +  (f.ins_chrg) + (f.other_chrg) + (f.cl_chrg-f.excl_chrg)) ) - Sum((f.sbillamt)  )), /* DIFF - TOTAL OF CHARGES */
--	Sum(Sum(((f.cl_chrg - f.excl_chrg)) )), /* TOTAL OF CLEARING CHARGES */
--	Sum(Sum(((f.service_tax - f.exser_tax)) )), /* TOTAL OF SERVICE TAX */
--	Sum(Sum(((f.sebi_tax)) )), /* TOTAL OF SEBI TAX */
--	Sum(Sum(((f.turn_tax)) )), /* TOTAL OF TURNOVER TAX */
--	Sum(Sum(((f.broker_note)) )), /* TOTAL OF STAMP DUTY */
--	Sum(Sum(((f.ins_chrg)) )), /* TOTAL OF INS CHARGES */
--	Sum(Sum(((f.other_chrg)) )) /* TOTAL OF OTHERCHARGES */
--	BY f.party_code 

	UPDATE #FOBILL
	SET BILLNO = FA.BILL_NO
	FROM BFOACCBILL FA
	WHERE FA.PARTY_CODE = #FOBILL.PARTY_CODE
	AND LEFT(SAUDADATE,11) = LEFT(CONVERT(VARCHAR,BILLDATE,103),11)


	SELECT * FROM #FOBILL

GO

-- --------------------------------------------------
-- TABLE dbo.Area
-- --------------------------------------------------
CREATE TABLE [dbo].[Area]
(
    [Areacode] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bank
-- --------------------------------------------------
CREATE TABLE [dbo].[Bank]
(
    [BankId] VARCHAR(12) NOT NULL,
    [BankName] VARCHAR(50) NULL,
    [address1] VARCHAR(35) NULL,
    [address2] VARCHAR(60) NULL,
    [city] VARCHAR(30) NULL,
    [pincode] VARCHAR(20) NULL,
    [phone1] VARCHAR(20) NULL,
    [phone2] VARCHAR(20) NULL,
    [phone3] VARCHAR(20) NULL,
    [phone4] VARCHAR(20) NULL,
    [fax1] VARCHAR(20) NULL,
    [fax2] VARCHAR(20) NULL,
    [email] VARCHAR(50) NULL,
    [Banktype] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bankguarantee
-- --------------------------------------------------
CREATE TABLE [dbo].[bankguarantee]
(
    [exch_indicator] VARCHAR(3) NOT NULL,
    [seg_indicator] VARCHAR(20) NOT NULL,
    [cl_type] VARCHAR(1) NOT NULL,
    [party_code] VARCHAR(6) NOT NULL,
    [sysid] DECIMAL(18, 0) NOT NULL,
    [bankId] DECIMAL(18, 0) NOT NULL,
    [bk_guarantee_no] VARCHAR(30) NOT NULL,
    [bk_guarantee_amt] DECIMAL(18, 0) NOT NULL,
    [guarantee_bal_amt] DECIMAL(18, 2) NOT NULL,
    [issue_dt] SMALLDATETIME NOT NULL,
    [maturity_dt] SMALLDATETIME NOT NULL,
    [lastclaim_dt] SMALLDATETIME NOT NULL,
    [status] VARCHAR(1) NOT NULL,
    [create_dt] SMALLDATETIME NOT NULL,
    [created_by] VARCHAR(30) NOT NULL,
    [guarantee_rec_dt] SMALLDATETIME NULL,
    [remarks] VARCHAR(250) NULL,
    [update_dt] SMALLDATETIME NULL,
    [old_id] DECIMAL(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BBGBfoSettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[BBGBfoSettlement]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoAccBill
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoAccBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [MTM] MONEY NULL,
    [PREMIUMPAYABLE] MONEY NULL,
    [PREMIUMRECEIVABLE] MONEY NULL,
    [NETPREMIUM] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [SERVICETAX] MONEY NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] MONEY NULL,
    [RESERVED4] MONEY NULL,
    [RESERVED5] INT NULL,
    [branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoBillno
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoBillno]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [BILLDATE] SMALLDATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoBillValan
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoBillValan]
(
    [Party_Code] VARCHAR(15) NOT NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Client_Type] VARCHAR(20) NOT NULL,
    [BillNo] VARCHAR(20) NOT NULL,
    [ContractNo] VARCHAR(20) NOT NULL,
    [Product_Code] VARCHAR(20) NOT NULL,
    [Series_Code] VARCHAR(20) NOT NULL,
    [expirydate] DATETIME NOT NULL,
    [Product_type] VARCHAR(20) NOT NULL,
    [Series_Id] INT NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [Market_Lot] INT NOT NULL,
    [AuctionPart] VARCHAR(20) NOT NULL,
    [MaturityDate] DATETIME NOT NULL,
    [Sauda_date] DATETIME NOT NULL,
    [IsIn] VARCHAR(20) NOT NULL,
    [PQty] INT NOT NULL,
    [SQty] INT NOT NULL,
    [PRate] MONEY NOT NULL,
    [SRate] MONEY NOT NULL,
    [PAmt] MONEY NOT NULL,
    [SAmt] MONEY NOT NULL,
    [PBrokAmt] MONEY NOT NULL,
    [SBrokAmt] MONEY NOT NULL,
    [PBillAmt] MONEY NOT NULL,
    [SBillAmt] MONEY NOT NULL,
    [Cl_Rate] MONEY NOT NULL,
    [Cl_Chrg] MONEY NOT NULL,
    [ExCl_Chrg] MONEY NOT NULL,
    [Service_Tax] MONEY NOT NULL,
    [ExSer_Tax] MONEY NOT NULL,
    [InExSerFlag] SMALLINT NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [Broker_note] MONEY NOT NULL,
    [Ins_Chrg] MONEY NOT NULL,
    [Other_Chrg] MONEY NOT NULL,
    [TradeType] VARCHAR(20) NOT NULL,
    [ParticiPantCode] VARCHAR(25) NOT NULL,
    [Terminal_Id] VARCHAR(25) NOT NULL,
    [Family] VARCHAR(20) NOT NULL,
    [FamilyName] VARCHAR(100) NOT NULL,
    [Trader] VARCHAR(40) NOT NULL,
    [Branch_Code] VARCHAR(20) NOT NULL,
    [Sub_Broker] VARCHAR(20) NOT NULL,
    [StatusName] VARCHAR(25) NOT NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(25) NOT NULL,
    [MemberType] VARCHAR(10) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Region] VARCHAR(20) NOT NULL,
    [UpdateDate] VARCHAR(11) NOT NULL,
    [email] VARCHAR(100) NOT NULL,
    [sbu] VARCHAR(20) NOT NULL,
    [relmgr] VARCHAR(20) NOT NULL,
    [grp] VARCHAR(20) NOT NULL,
    [sector] VARCHAR(20) NOT NULL,
    [CMClosing] MONEY NOT NULL,
    [track] VARCHAR(20) NOT NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoclearingchrg
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoclearingchrg]
(
    [Party_code] VARCHAR(10) NULL,
    [orderno] VARCHAR(15) NULL,
    [series_code] VARCHAR(14) NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [Clearingcharges] MONEY NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOCLOSING
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOCLOSING]
(
    [Product_Type] VARCHAR(5) NULL,
    [Product_Code] VARCHAR(10) NULL,
    [Series_Id] INT NULL,
    [Series_code] VARCHAR(13) NULL,
    [Sec_name] VARCHAR(200) NULL,
    [expirydate] SMALLDATETIME NULL,
    [Trade_date] SMALLDATETIME NULL,
    [Cl_rate] MONEY NULL,
    [PCP] MONEY NULL,
    [SeriesHigh] MONEY NULL,
    [SeriesLow] MONEY NULL,
    [SettlementPrice] MONEY NULL,
    [TradedVolume] VARCHAR(20) NULL,
    [TradeValue] MONEY NULL,
    [NoTrades] INT NULL,
    [BasePrice] MONEY NULL,
    [PrOpenInterest] MONEY NULL,
    [OpenInterest] MONEY NULL,
    [OpenIntChange] MONEY NULL,
    [Reserved1] TINYINT NULL,
    [Reserved2] TINYINT NULL,
    [Reserved3] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bfoerrorlog
-- --------------------------------------------------
CREATE TABLE [dbo].[Bfoerrorlog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoexallocSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoexallocSETTLEMENT]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [callput] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOexallocTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOexallocTRADE]
(
    [bfoeatrd_Trade_No] VARCHAR(20) NULL,
    [bfoeatrd_Status] VARCHAR(2) NULL,
    [bfoeatrd_Product_Type] VARCHAR(6) NULL,
    [bfoeatrd_Product_Code] VARCHAR(12) NULL,
    [bfoeatrd_Expirydate] SMALLDATETIME NULL,
    [bfoeatrd_Strike_price] MONEY NULL,
    [bfoeatrd_CallPut] VARCHAR(2) NULL,
    [bfoeatrd_Series_Code] VARCHAR(16) NULL,
    [bfoeatrd_Series_ID] VARCHAR(12) NULL,
    [bfoeatrd_Sec_Name] VARCHAR(25) NULL,
    [bfoeatrd_MarKetType] VARCHAR(2) NULL,
    [bfoeatrd_User_Id] VARCHAR(8) NULL,
    [bfoeatrd_Sell_Buy] INT NULL,
    [bfoeatrd_TradeQty] INT NULL,
    [bfoeatrd_Price] MONEY NULL,
    [bfoeatrd_Pro_cli] INT NULL,
    [bfoeatrd_Party_Code] VARCHAR(10) NULL,
    [bfoeatrd_O_C_Flag] VARCHAR(5) NULL,
    [bfoeatrd_C_U_Flag] VARCHAR(7) NULL,
    [bfoeatrd_ActivityTime] SMALLDATETIME NULL,
    [bfoeatrd_Order_No] VARCHAR(20) NULL,
    [bfoeatrd_settflag] INT NULL,
    [bfoeatrd_cl_rate] MONEY NULL,
    [auctionpart] VARCHAR(5) NULL,
    [oldpartycode] VARCHAR(20) NULL,
    [participantcode] VARCHAR(20) NULL,
    [tmcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoexerciseallocation
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoexerciseallocation]
(
    [bfoea_table_no] INT IDENTITY(1,1) NOT NULL,
    [bfoea_position_date] DATETIME NULL,
    [bfoea_desc] VARCHAR(50) NULL,
    [bfoea_segment_ind] VARCHAR(5) NULL,
    [bfoea_sett_type] VARCHAR(2) NULL,
    [bfoea_cm_code] VARCHAR(13) NULL,
    [bfoea_mem_type] VARCHAR(1) NULL,
    [bfoea_tm_code] VARCHAR(13) NULL,
    [bfoea_acc_type] VARCHAR(2) NULL,
    [bfoea_party_code] VARCHAR(15) NULL,
    [bfoea_product_type] VARCHAR(6) NULL,
    [bfoea_product_code] VARCHAR(12) NULL,
    [bfoea_series_code] VARCHAR(12) NULL,
    [bfoea_series_ID] VARCHAR(12) NULL,
    [bfoea_expirydate] DATETIME NULL,
    [bfoea_strike_price] MONEY NULL,
    [bfoea_CallPut] VARCHAR(2) NULL,
    [bfoea_cor_act_level] INT NULL,
    [bfoea_preexall_longqty] INT NULL,
    [bfoea_preexall_shortqty] INT NULL,
    [bfoea_exercise_qty] INT NULL,
    [bfoea_alloc_qty] INT NULL,
    [bfoea_postexall_longqty] INT NULL,
    [bfoea_postexall_shortqty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoexpiryBackup
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoexpiryBackup]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL,
    [RunDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoExpirySettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoExpirySettlement]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoFinalClosing
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoFinalClosing]
(
    [ClosingDate] SMALLDATETIME NOT NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Cl_Rate] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfofttrade
-- --------------------------------------------------
CREATE TABLE [dbo].[bfofttrade]
(
    [Product_Type] VARCHAR(5) NULL,
    [Product_Code] VARCHAR(10) NULL,
    [Group_ID] VARCHAR(7) NULL,
    [Trader_Code] VARCHAR(7) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Series_Id] INT NULL,
    [Series_Code] VARCHAR(13) NULL,
    [Sell_Buy] INT NULL,
    [Tradeqty] INT NULL,
    [MarketRate] MONEY NULL,
    [Party_code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Trans_Type] CHAR(1) NULL,
    [Sauda_Date] DATETIME NULL,
    [Order_Date] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [User_Id] VARCHAR(4) NULL,
    [Reserved1] TINYINT NULL,
    [Reserved2] TINYINT NULL,
    [Reserved3] TINYINT NULL,
    [Reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmcode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfofuttrade
-- --------------------------------------------------
CREATE TABLE [dbo].[bfofuttrade]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoglobals
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoglobals]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoIMpercent
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoIMpercent]
(
    [Eff_Date] SMALLDATETIME NULL,
    [IM_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoMarginColl
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoMarginColl]
(
    [File_Date] SMALLDATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [GroupId] VARCHAR(10) NULL,
    [MTM_Margin] MONEY NULL,
    [MTM_Coll] MONEY NULL,
    [MTM_Short] MONEY NULL,
    [Init_Margin] MONEY NULL,
    [IM_Coll] MONEY NULL,
    [IM_Short] MONEY NULL,
    [Premium] MONEY NULL,
    [Premium_Coll] MONEY NULL,
    [Premium_Short] MONEY NULL,
    [Reserved1] MONEY NULL,
    [Reserved2] DECIMAL(5, 0) NULL,
    [Reserved3] TINYINT NULL,
    [Reserved4] TINYINT NULL,
    [Reserved5] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfooptionassigned
-- --------------------------------------------------
CREATE TABLE [dbo].[bfooptionassigned]
(
    [Filedate] SMALLDATETIME NULL,
    [Group_Id] VARCHAR(3) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(2) NULL,
    [Product_Code] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(5) NULL,
    [Series_Id] INT NULL,
    [Series_Code] VARCHAR(13) NULL,
    [CallPut] VARCHAR(3) NULL,
    [Strike_Price] MONEY NULL,
    [Settlement_Price] MONEY NULL,
    [OpenPosition] INT NULL,
    [Exercise_Quantity] INT NULL,
    [Reserved1] TINYINT NULL,
    [Reserved2] TINYINT NULL,
    [Reserved3] TINYINT NULL,
    [Reserved4] TINYINT NULL,
    [Reserved5] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfooptionexercise
-- --------------------------------------------------
CREATE TABLE [dbo].[bfooptionexercise]
(
    [Filedate] SMALLDATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(2) NULL,
    [Group_Id] VARCHAR(3) NULL,
    [Product_Code] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(5) NULL,
    [Series_Id] INT NULL,
    [Series_Code] VARCHAR(13) NULL,
    [CallPut] VARCHAR(3) NULL,
    [InOutAtTheMoney] VARCHAR(3) NULL,
    [Strike_Price] MONEY NULL,
    [Settlement_Price] MONEY NULL,
    [OpenPosition] INT NULL,
    [Exercise_quantity] INT NULL,
    [Reserved1] TINYINT NULL,
    [Reserved2] TINYINT NULL,
    [Reserved3] TINYINT NULL,
    [Reserved4] TINYINT NULL,
    [Reserved5] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoowner
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoowner]
(
    [Company] VARCHAR(200) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(25) NULL,
    [Zip] VARCHAR(10) NULL,
    [city] VARCHAR(20) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] INT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [expdeposit] MONEY NULL,
    [Sebi_Regn_No] VARCHAR(30) NULL,
    [style] INT NULL,
    [contno] VARCHAR(7) NULL,
    [State] VARCHAR(50) NULL,
    [SebiNo] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP1
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP1]
(
    [ProductName] CHAR(3) NULL,
    [UnderlyingAsset] VARCHAR(5) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(20) NULL,
    [series_id] VARCHAR(13) NULL,
    [scripmap_cd] VARCHAR(13) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP1_IMP]
(
    [ProductName] CHAR(3) NULL,
    [UnderlyingAsset] VARCHAR(5) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(20) NULL,
    [series_id] VARCHAR(13) NULL,
    [scripmap_cd] VARCHAR(13) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2]
(
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(20) NULL,
    [Series_id] INT NULL,
    [series_type] VARCHAR(3) NULL,
    [sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [OpeningDay] SMALLDATETIME NULL,
    [Lifetime] INT NULL,
    [Isin_Code] INT NULL,
    [Base_Price] MONEY NULL,
    [Multiplier] INT NULL,
    [marketsegment] VARCHAR(15) NULL,
    [marketlot] INT NULL,
    [ceilingdepth] INT NULL,
    [callput] VARCHAR(3) NULL,
    [optionstyle] VARCHAR(3) NULL,
    [strikeprice] MONEY NULL,
    [nearseriesid] INT NULL,
    [farseriesid] INT NULL,
    [cor_act_level] INT NULL,
    [reserved1] INT NULL,
    [reserved2] INT NULL,
    [reserved3] INT NULL,
    [reserved4] INT NULL,
    [reserved5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSCRIP2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSCRIP2_IMP]
(
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(20) NULL,
    [Series_id] INT NULL,
    [series_type] VARCHAR(3) NULL,
    [sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [OpeningDay] SMALLDATETIME NULL,
    [Lifetime] INT NULL,
    [Isin_Code] INT NULL,
    [Base_Price] MONEY NULL,
    [Multiplier] INT NULL,
    [marketsegment] VARCHAR(15) NULL,
    [marketlot] INT NULL,
    [ceilingdepth] INT NULL,
    [callput] VARCHAR(3) NULL,
    [optionstyle] VARCHAR(3) NULL,
    [strikeprice] MONEY NULL,
    [nearseriesid] INT NULL,
    [farseriesid] INT NULL,
    [cor_act_level] INT NULL,
    [reserved1] INT NULL,
    [reserved2] INT NULL,
    [reserved3] INT NULL,
    [reserved4] INT NULL,
    [reserved5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfosett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[bfosett_mst]
(
    [Exchange] CHAR(5) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] VARCHAR(10) NULL,
    [Series_code] VARCHAR(20) NULL,
    [Start_date] SMALLDATETIME NULL,
    [expirydate] SMALLDATETIME NULL,
    [Funds_Payin] SMALLDATETIME NULL,
    [Funds_Payout] SMALLDATETIME NULL,
    [Sec_Payin] SMALLDATETIME NULL,
    [Sec_Payout] SMALLDATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL,
    [maturitydate] SMALLDATETIME NULL,
    [Product_type] VARCHAR(5) NULL,
    [Product_code] VARCHAR(10) NULL,
    [Series_Id] VARCHAR(13) NULL,
    [Series_type] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSETTLEMENT]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(20) NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOSETTLEMENT1
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOSETTLEMENT1]
(
    [ContractNo] NVARCHAR(14) NOT NULL,
    [BillNo] NVARCHAR(10) NULL,
    [Trade_no] NVARCHAR(20) NULL,
    [Party_Code] NVARCHAR(10) NOT NULL,
    [product_type] NVARCHAR(5) NULL,
    [product_code] NVARCHAR(10) NULL,
    [Series_code] NVARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] NVARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(2) NULL,
    [MarketType] NVARCHAR(2) NULL,
    [Series] NVARCHAR(3) NOT NULL,
    [Order_no] NVARCHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [Table_No] NVARCHAR(4) NOT NULL,
    [Line_No] FLOAT NOT NULL,
    [Val_perc] NVARCHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] FLOAT NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] FLOAT NULL,
    [sett_type] NVARCHAR(3) NULL,
    [Cl_type] NVARCHAR(3) NULL,
    [Order_Date] SMALLDATETIME NULL,
    [OppMemCode] NVARCHAR(5) NULL,
    [OppTraderCode] NVARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] NVARCHAR(7) NULL,
    [TraderCode] NVARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] NVARCHAR(2) NULL,
    [branch_cd] NVARCHAR(6) NULL,
    [pro_cli] NVARCHAR(6) NULL,
    [participantcode] NVARCHAR(15) NULL,
    [cpid] NVARCHAR(5) NULL,
    [instrument] NVARCHAR(5) NULL,
    [booktype] NVARCHAR(5) NULL,
    [branch_id] NVARCHAR(5) NULL,
    [scheme] NVARCHAR(5) NULL,
    [tmark] NVARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoSettlementExpiry
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoSettlementExpiry]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NOT NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BfoSettTest
-- --------------------------------------------------
CREATE TABLE [dbo].[BfoSettTest]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(20) NULL,
    [Series_id] INT NULL,
    [expirydate] SMALLDATETIME NULL,
    [multiplier] INT NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] CHAR(20) NOT NULL,
    [MarketRate] MONEY NULL,
    [strike_price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Order_Date] DATETIME NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Cl_rate] MONEY NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [status] CHAR(2) NULL,
    [branch_cd] VARCHAR(6) NULL,
    [pro_cli] VARCHAR(6) NULL,
    [participantcode] VARCHAR(15) NULL,
    [cpid] VARCHAR(5) NULL,
    [instrument] VARCHAR(5) NULL,
    [booktype] VARCHAR(5) NULL,
    [branch_id] VARCHAR(5) NULL,
    [scheme] VARCHAR(5) NULL,
    [tmark] VARCHAR(5) NULL,
    [dummy1] INT NULL,
    [dummy2] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfoSpanMargin_intraday
-- --------------------------------------------------
CREATE TABLE [dbo].[bfoSpanMargin_intraday]
(
    [node] VARCHAR(7) NOT NULL,
    [Intradate] SMALLDATETIME NOT NULL,
    [isSetl] INT NOT NULL,
    [qual] VARCHAR(7) NOT NULL,
    [Intratime] VARCHAR(7) NULL,
    [run] VARCHAR(7) NULL,
    [firm] VARCHAR(7) NOT NULL,
    [acct] VARCHAR(7) NOT NULL,
    [seg] VARCHAR(4) NULL,
    [Intratype] VARCHAR(7) NULL,
    [isCust] VARCHAR(7) NULL,
    [ec] VARCHAR(10) NULL,
    [cc] VARCHAR(10) NULL,
    [Intracurrency] VARCHAR(7) NULL,
    [lfv] FLOAT NULL,
    [sfv] FLOAT NULL,
    [lov] FLOAT NULL,
    [sov] FLOAT NULL,
    [isM] FLOAT NULL,
    [pbc] VARCHAR(7) NULL,
    [spanReq] FLOAT NULL,
    [anov] FLOAT NULL,
    [sr] FLOAT NULL,
    [ia] FLOAT NULL,
    [dr] FLOAT NULL,
    [ie] FLOAT NULL,
    [iex] FLOAT NULL,
    [som] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoSpMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoSpMargin]
(
    [Date] SMALLDATETIME NULL,
    [NSeries_Code] VARCHAR(13) NULL,
    [Near_ExpiryDate] SMALLDATETIME NULL,
    [FSeries_Code] VARCHAR(13) NULL,
    [Far_ExpiryDate] SMALLDATETIME NULL,
    [Valid_Date] SMALLDATETIME NULL,
    [SpreadMargin] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfostat_trd
-- --------------------------------------------------
CREATE TABLE [dbo].[bfostat_trd]
(
    [actioncode] VARCHAR(3) NULL,
    [sysdate] SMALLDATETIME NULL,
    [filedate] SMALLDATETIME NULL,
    [com_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bfotaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[bfotaxes]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] VARCHAR(3) NULL,
    [Insurance_Chrg] NUMERIC(18, 4) NULL,
    [Turnover_tax] NUMERIC(18, 4) NULL,
    [Other_chrg] DECIMAL(3, 2) NULL,
    [Sebiturn_tax] NUMERIC(18, 4) NULL,
    [Broker_note] DECIMAL(3, 3) NULL,
    [From_date] DATETIME NULL,
    [Demat_Insure] DECIMAL(3, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOtempbillflag
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOtempbillflag]
(
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Series_Code] VARCHAR(20) NULL,
    [Series_id] INT NULL,
    [EXPIRYDATE] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOtermparty
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOtermparty]
(
    [UserId] CHAR(10) NOT NULL,
    [Party_code] CHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOTRADE]
(
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Series_Id] INT NULL,
    [Series_Code] VARCHAR(13) NULL,
    [Sell_Buy] INT NULL,
    [Tradeqty] INT NULL,
    [MarketRate] MONEY NULL,
    [Party_code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Trans_Type] CHAR(1) NULL,
    [Sauda_Date] DATETIME NULL,
    [Order_Date] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [User_Id] VARCHAR(4) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmcode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFoTradeMissing
-- --------------------------------------------------
CREATE TABLE [dbo].[BFoTradeMissing]
(
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [GroupId] VARCHAR(7) NULL,
    [TraderCode] VARCHAR(7) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Series_Id] INT NULL,
    [Series_Code] VARCHAR(13) NULL,
    [Sell_Buy] INT NULL,
    [Tradeqty] INT NULL,
    [MarketRate] MONEY NULL,
    [Party_code] VARCHAR(10) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [OppMemCode] VARCHAR(5) NULL,
    [OppTraderCode] VARCHAR(5) NULL,
    [Trans_Type] CHAR(1) NULL,
    [Sauda_Date] DATETIME NULL,
    [Order_Date] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [User_Id] VARCHAR(4) NULL,
    [reserved1] TINYINT NULL,
    [reserved2] TINYINT NULL,
    [reserved3] TINYINT NULL,
    [reserved4] TINYINT NULL,
    [reserved5] TINYINT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmcode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [BRANCH_CODE] CHAR(6) NULL,
    [BRANCH] CHAR(40) NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(100) NULL,
    [Prefix] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchBrokTable
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchBrokTable]
(
    [Table_No] INT NULL,
    [Table_Name] VARCHAR(30) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Table_Type] CHAR(1) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Remarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branches
-- --------------------------------------------------
CREATE TABLE [dbo].[Branches]
(
    [Branch_Cd] VARCHAR(50) NOT NULL,
    [Short_Name] VARCHAR(20) NOT NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(25) NULL,
    [Address2] VARCHAR(25) NULL,
    [City] VARCHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(25) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Deftrader] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchPayMode
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchPayMode]
(
    [AcName] VARCHAR(100) NULL,
    [Branch] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.brokers
-- --------------------------------------------------
CREATE TABLE [dbo].[brokers]
(
    [Broker_Code] CHAR(6) NOT NULL,
    [Exchange] CHAR(3) NULL,
    [Exc_Code] CHAR(5) NULL,
    [Name] CHAR(25) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [branch_code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.c
-- --------------------------------------------------
CREATE TABLE [dbo].[c]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Charges_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[Charges_Detail]
(
    [CD_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CD_Party_Code] VARCHAR(10) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(20) NULL,
    [CD_Order_No] VARCHAR(15) NULL,
    [CD_Product_Type] VARCHAR(5) NULL,
    [CD_Product_Code] VARCHAR(10) NULL,
    [CD_Series_Code] VARCHAR(20) NULL,
    [CD_Series_Id] INT NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_AuctionPart] VARCHAR(2) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] CHAR(1) NULL,
    [CD_ComputationOn] CHAR(1) NULL,
    [CD_ComputationType] CHAR(1) NULL,
    [CD_BuyRate] MONEY NULL,
    [CD_SellRate] MONEY NULL,
    [CD_Tot_BuyQty] INT NULL,
    [CD_Tot_SellQty] INT NULL,
    [CD_Tot_BuyTurnOver] MONEY NULL,
    [CD_Tot_SellTurnOver] MONEY NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NULL,
    [CD_Tot_TurnOver] MONEY NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] MONEY NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] MONEY NULL,
    [CD_Tot_SellBrok] MONEY NULL,
    [CD_Tot_Brok] MONEY NULL,
    [CD_Tot_BuySerTax] MONEY NULL,
    [CD_Tot_SellSerTax] MONEY NULL,
    [CD_Tot_SerTax] MONEY NULL,
    [CD_Tot_Stt] MONEY NULL,
    [CD_Tot_Turn_Tax] MONEY NULL,
    [CD_Tot_Other_Chrg] MONEY NULL,
    [CD_Tot_Sebi_Tax] MONEY NULL,
    [CD_Tot_StampDuty] MONEY NULL,
    [CD_Exch_BuyRate] MONEY NULL,
    [CD_Exch_SellRate] MONEY NULL,
    [CD_TimeStamp] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_brok_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_brok_details_tmp]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(7) NOT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Trd_Brok] INT NULL,
    [Del_Brok] INT NULL,
    [Ser_Tax] TINYINT NULL,
    [Ser_Tax_Method] TINYINT NULL,
    [Credit_Limit] INT NOT NULL,
    [InActive_From] DATETIME NULL,
    [Print_Options] TINYINT NULL,
    [No_Of_Copies] INT NULL,
    [Participant_Code] VARCHAR(15) NULL,
    [Custodian_Code] VARCHAR(50) NULL,
    [Inst_Contract] CHAR(1) NULL,
    [Round_Style] INT NULL,
    [STP_Provider] VARCHAR(5) NULL,
    [STP_Rp_Style] TINYINT NULL,
    [Market_Type] INT NULL,
    [Multiplier] INT NULL,
    [Charged] INT NULL,
    [Maintenance] INT NULL,
    [Reqd_By_Exch] INT NULL,
    [Reqd_By_Broker] INT NULL,
    [Client_Rating] VARCHAR(10) NULL,
    [Debit_Balance] CHAR(1) NULL,
    [Inter_Sett] CHAR(1) NULL,
    [TRD_STT] MONEY NULL,
    [Trd_Tran_Chrgs] MONEY NULL,
    [Trd_Sebi_Fees] MONEY NULL,
    [Trd_Stamp_Duty] MONEY NULL,
    [Trd_Other_Chrgs] MONEY NULL,
    [Trd_Eff_Dt] DATETIME NULL,
    [Del_Stt] MONEY NULL,
    [Del_Tran_Chrgs] MONEY NULL,
    [Del_SEBI_Fees] MONEY NULL,
    [Del_Stamp_Duty] MONEY NULL,
    [Del_Other_Chrgs] MONEY NULL,
    [Del_Eff_Dt] DATETIME NULL,
    [Rounding_Method] VARCHAR(10) NULL,
    [Round_To_Digit] TINYINT NULL,
    [Round_To_Paise] INT NULL,
    [Fut_Brok] INT NULL,
    [Fut_Opt_Brok] INT NULL,
    [Fut_Fut_Fin_Brok] INT NULL,
    [Fut_Opt_Exc] INT NULL,
    [Fut_Brok_Applicable] INT NULL,
    [Fut_Stt] SMALLINT NULL,
    [Fut_Tran_Chrgs] SMALLINT NULL,
    [Fut_Sebi_Fees] SMALLINT NULL,
    [Fut_Stamp_Duty] SMALLINT NULL,
    [Fut_Other_Chrgs] SMALLINT NULL,
    [Status] CHAR(1) NULL,
    [Modifiedon] DATETIME NULL,
    [Modifiedby] VARCHAR(25) NULL,
    [Imp_Status] TINYINT NULL,
    [Pay_B3B_Payment] CHAR(1) NULL,
    [Pay_Bank_name] VARCHAR(50) NULL,
    [Pay_Branch_name] VARCHAR(50) NULL,
    [Pay_AC_No] VARCHAR(10) NULL,
    [Pay_payment_Mode] CHAR(1) NULL,
    [Brok_Eff_Date] DATETIME NULL,
    [Inst_Trd_Brok] INT NULL,
    [Inst_Del_Brok] INT NULL,
    [SYSTEMDATE] DATETIME NULL,
    [Active_Date] DATETIME NULL,
    [CheckActiveClient] VARCHAR(1) NULL,
    [Deactive_Remarks] VARCHAR(100) NULL,
    [Deactive_value] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details_tmp]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(50) NULL,
    [p_city] VARCHAR(20) NULL,
    [p_address2] VARCHAR(50) NULL,
    [p_state] VARCHAR(15) NULL,
    [p_address3] VARCHAR(50) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] NUMERIC(18, 0) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [INCOME_SLAB] INT NULL,
    [NETWORTH_SLAB] INT NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Print_Settings
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Print_Settings]
(
    [Print_Flag] TINYINT NOT NULL,
    [Print_Flag_Desc] VARCHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1
-- --------------------------------------------------
CREATE TABLE [dbo].[client1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [trader] VARCHAR(20) NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(20) NULL,
    [Clrating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1_devang
-- --------------------------------------------------
CREATE TABLE [dbo].[client1_devang]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [trader] VARCHAR(20) NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(20) NULL,
    [Clrating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [contcharge] TINYINT NULL,
    [mincontamt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [dummy6] VARCHAR(5) NULL,
    [dummy7] VARCHAR(4) NULL,
    [dummy8] VARCHAR(20) NULL,
    [dummy9] VARCHAR(20) NULL,
    [dummy10] VARCHAR(20) NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client2_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Client2_Log]
(
    [Cl_Code] CHAR(10) NULL,
    [Exchange] CHAR(3) NULL,
    [Tran_Cat] CHAR(3) NULL,
    [Scrip_Cat] DECIMAL(9, 0) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Margin] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [Sebi_Turn_Tax] TINYINT NULL,
    [Insurance_Chrg] TINYINT NULL,
    [Service_Chrg] TINYINT NULL,
    [Std_Rate] INT NULL,
    [P_To_P] INT NULL,
    [Exposure_Lim] DECIMAL(18, 0) NULL,
    [Demat_Tableno] INT NULL,
    [Bankid] VARCHAR(16) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Printf] TINYINT NULL,
    [Albmdelchrg] TINYINT NULL,
    [Albmdelivery] INT NULL,
    [Albmcf_Tableno] INT NULL,
    [Mf_Tableno] INT NULL,
    [Sb_Tableno] INT NULL,
    [Brok1_Tableno] INT NULL,
    [Brok2_Tableno] INT NULL,
    [Brok3_Tableno] INT NULL,
    [Brokernote] TINYINT NULL,
    [Other_Chrg] TINYINT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontamt] TINYINT NULL,
    [Addledgerbal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [Inscont] CHAR(1) NULL,
    [Sertaxmethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [Activefrom] DATETIME NULL,
    [Inactivefrom] DATETIME NULL,
    [Debitbalflag] INT NULL,
    [Intersettflag] INT NULL,
    [Logfld_Script_Name] VARCHAR(500) NULL,
    [Logfld_Session_Id] VARCHAR(30) NULL,
    [Logfld_Local_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Host] VARCHAR(50) NULL,
    [Logfld_Statusname] VARCHAR(50) NULL,
    [Logfld_Username] VARCHAR(100) NULL,
    [Logfld_When_109] VARCHAR(30) NULL,
    [Logfld_Action] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client3
-- --------------------------------------------------
CREATE TABLE [dbo].[Client3]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Party_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Markettype] VARCHAR(15) NOT NULL,
    [Margin] MONEY NOT NULL,
    [Nooftimes] DECIMAL(2, 0) NOT NULL,
    [Margin_Recd] DECIMAL(18, 0) NULL,
    [Mtom] DECIMAL(18, 0) NULL,
    [Pmarginrate] DECIMAL(5, 2) NULL,
    [Mtomdate] DATETIME NULL,
    [Initialmargin] DECIMAL(18, 4) NULL,
    [Mainenancetmargin] DECIMAL(18, 4) NULL,
    [Marginexchange] DECIMAL(18, 4) NULL,
    [Marginbroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4
-- --------------------------------------------------
CREATE TABLE [dbo].[client4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(20) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client5
-- --------------------------------------------------
CREATE TABLE [dbo].[client5]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [BirthDate] DATETIME NULL,
    [Sex] CHAR(1) NULL,
    [ActiveFrom] DATETIME NULL,
    [InteractMode] TINYINT NULL,
    [RepatriatAC] TINYINT NULL,
    [RepatriatBank] TINYINT NULL,
    [RepatriatACNO] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [KYCForm] TINYINT NULL,
    [BankCert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [VotersID] TINYINT NULL,
    [VotersIDdtl] VARCHAR(30) NULL,
    [ITReturn] TINYINT NULL,
    [ITReturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [InactiveFrom] DATETIME NULL,
    [P_Address1] VARCHAR(50) NULL,
    [P_Address2] VARCHAR(50) NULL,
    [P_Address3] VARCHAR(50) NULL,
    [P_City] VARCHAR(20) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [addemailid] VARCHAR(230) NULL,
    [PassportDateOfIssue] DATETIME NULL,
    [PassportPlaceOfIssue] VARCHAR(30) NULL,
    [VoterIdDateOfIssue] DATETIME NULL,
    [VoterIdPlaceOfIssue] VARCHAR(30) NULL,
    [ITReturnDateOfFiling] DATETIME NULL,
    [LicenceNoDateOfIssue] DATETIME NULL,
    [LicenceNoPlaceOfIssue] VARCHAR(30) NULL,
    [RationCardDateOfIssue] DATETIME NULL,
    [RationCardPlaceOfIssue] VARCHAR(30) NULL,
    [Client_Agre_Dt] DATETIME NULL,
    [Regr_No] VARCHAR(50) NULL,
    [Regr_Place] VARCHAR(50) NULL,
    [Regr_Date] DATETIME NULL,
    [Regr_Auth] VARCHAR(50) NULL,
    [Introd_Client_Id] VARCHAR(50) NULL,
    [Introd_Relation] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Sett_Mode] VARCHAR(50) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Systumdate] DATETIME NULL,
    [Passportexpdate] DATETIME NULL,
    [Driveexpdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientbrok_scheme
-- --------------------------------------------------
CREATE TABLE [dbo].[clientbrok_scheme]
(
    [SCHEME_ID] DECIMAL(18, 0) IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [Table_No] VARCHAR(5) NOT NULL,
    [Scheme_Type] VARCHAR(5) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Trade_Type] VARCHAR(3) NOT NULL,
    [BrokScheme] VARCHAR(1) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientCharges
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientCharges]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [MinUnitBrok] SMALLMONEY NULL,
    [Charge1] SMALLMONEY NULL,
    [Charge1Desc] VARCHAR(20) NULL,
    [Charge2] SMALLMONEY NULL,
    [Charge2Desc] VARCHAR(20) NULL,
    [Charge3] SMALLMONEY NULL,
    [Charge3Desc] VARCHAR(20) NULL,
    [Charge4] SMALLMONEY NULL,
    [Charge4Desc] VARCHAR(20) NULL,
    [MinContAmt] SMALLMONEY NULL,
    [Leg] CHAR(2) NULL,
    [Sett_type] CHAR(3) NULL,
    [NOC] TINYINT NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientSettings
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientSettings]
(
    [Exchange] CHAR(3) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Cl_Code] VARCHAR(50) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(4) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(4) NULL,
    [Dummy9] VARCHAR(4) NULL,
    [Dummy10] VARCHAR(4) NULL,
    [RoundStyle] SMALLINT NULL,
    [RoundStyle1] SMALLINT NULL,
    [DebitBalance] TINYINT NULL,
    [InterSett] TINYINT NULL,
    [Latest] CHAR(4) NULL,
    [Area] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Cl_Type] CHAR(3) NULL,
    [Cl_status] CHAR(3) NULL,
    [Clrating] VARCHAR(10) NULL,
    [Family] VARCHAR(50) NULL,
    [Sub_Broker] VARCHAR(50) NULL,
    [Trader] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientstatus
-- --------------------------------------------------
CREATE TABLE [dbo].[clientstatus]
(
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Description] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientTaxes]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [Cl_type] CHAR(5) NULL,
    [Trans_cat] CHAR(5) NULL,
    [Insurance_Chrg] SMALLMONEY NULL,
    [Turnover_tax] SMALLMONEY NULL,
    [Other_chrg] SMALLMONEY NULL,
    [Sebiturn_tax] SMALLMONEY NULL,
    [Broker_note] SMALLMONEY NULL,
    [Demat_Insure] SMALLMONEY NULL,
    [Service_tax] SMALLMONEY NULL,
    [Tax1] SMALLMONEY NULL,
    [Tax2] SMALLMONEY NULL,
    [Tax3] SMALLMONEY NULL,
    [Tax4] SMALLMONEY NULL,
    [Tax5] SMALLMONEY NULL,
    [Tax6] SMALLMONEY NULL,
    [Tax7] SMALLMONEY NULL,
    [Tax8] SMALLMONEY NULL,
    [Tax9] SMALLMONEY NULL,
    [Tax10] SMALLMONEY NULL,
    [Latest] CHAR(10) NULL,
    [State] CHAR(15) NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttaxes_new
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttaxes_new]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [Cl_type] CHAR(5) NULL,
    [Trans_cat] CHAR(5) NULL,
    [Insurance_Chrg] MONEY NULL,
    [Turnover_tax] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [Sebiturn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Demat_Insure] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Tax1] MONEY NULL,
    [Tax2] MONEY NULL,
    [Tax3] MONEY NULL,
    [Tax4] MONEY NULL,
    [Tax5] MONEY NULL,
    [Tax6] MONEY NULL,
    [Tax7] MONEY NULL,
    [Tax8] MONEY NULL,
    [Tax9] MONEY NULL,
    [Tax10] MONEY NULL,
    [Latest] CHAR(10) NULL,
    [State] CHAR(15) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [Round_To] INT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttype
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttype]
(
    [Cl_Type] VARCHAR(3) NOT NULL,
    [Description] VARCHAR(25) NULL,
    [prefix] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContGen
-- --------------------------------------------------
CREATE TABLE [dbo].[ContGen]
(
    [contractno] INT NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContLogin
-- --------------------------------------------------
CREATE TABLE [dbo].[ContLogin]
(
    [LoginId] VARCHAR(30) NULL,
    [FromParty] VARCHAR(10) NULL,
    [ToParty] VARCHAR(10) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(13) NULL,
    [Expirydate] DATETIME NULL,
    [series_id] INT NULL,
    [Qty] INT NULL,
    [Sell_Buy] INT NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [ContractNo] VARCHAR(10) NULL,
    [SplitDate] SMALLDATETIME NULL,
    [Printed] INT NULL,
    [TradeNo] VARCHAR(14) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA]
(
    [CONTRACTNO] VARCHAR(7) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(16) NOT NULL,
    [ORDER_TIME] VARCHAR(10) NOT NULL,
    [TM] VARCHAR(13) NOT NULL,
    [TRADE_NO] VARCHAR(14) NOT NULL,
    [SCRIP_CD] VARCHAR(10) NOT NULL,
    [SCRIPNAME] VARCHAR(50) NULL,
    [SDT] CHAR(30) NULL,
    [SELL_BUY] INT NOT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] NUMERIC(38, 6) NULL,
    [SNETRATE] NUMERIC(38, 6) NULL,
    [PAMT] NUMERIC(38, 4) NULL,
    [SAMT] NUMERIC(38, 4) NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [STT] INT NOT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [FLAG] VARCHAR(3) NOT NULL,
    [BILLFLAG] INT NULL,
    [TMARK] VARCHAR(1) NOT NULL,
    [TDATE1] CHAR(30) NULL,
    [SAUDA_DATE] VARCHAR(11) NULL,
    [T_TTYPE] VARCHAR(2) NOT NULL,
    [FACE_VAL] VARCHAR(10) NULL,
    [BOOK_CL_DT] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [SCRIPNAME1] VARCHAR(52) NULL,
    [BSECODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [PRINTF] TINYINT NOT NULL,
    [ROUNDTO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Rounding
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Rounding]
(
    [CR_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CR_Party_Code] VARCHAR(10) NULL,
    [CR_Min_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Max_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Date_From] DATETIME NOT NULL,
    [CR_Date_To] DATETIME NOT NULL,
    [CR_CreatedBy] VARCHAR(20) NULL,
    [CR_CreatedOn] DATETIME NOT NULL,
    [CR_ModifiedBy] VARCHAR(20) NULL,
    [CR_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContractPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[ContractPrint_Setting]
(
    [Rpt_Code] VARCHAR(20) NULL,
    [Rpt_Desc] VARCHAR(50) NULL,
    [Rpt_Pos] DECIMAL(10, 0) NULL,
    [Rpt_Width] DECIMAL(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Custodian
-- --------------------------------------------------
CREATE TABLE [dbo].[Custodian]
(
    [custodiancode] VARCHAR(10) NOT NULL,
    [Short_name] VARCHAR(21) NOT NULL,
    [Long_name] VARCHAR(50) NULL,
    [Address1] CHAR(10) NULL,
    [Address2] CHAR(10) NULL,
    [city] CHAR(10) NULL,
    [State] CHAR(10) NULL,
    [Nation] CHAR(10) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(10) NULL,
    [Off_Phone1] CHAR(10) NULL,
    [Off_Phone2] CHAR(10) NULL,
    [Email] CHAR(10) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [DpId] VARCHAR(16) NULL,
    [SebiRegNo] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delpartyflag
-- --------------------------------------------------
CREATE TABLE [dbo].[Delpartyflag]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Debitflag] INT NULL,
    [Interflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Blank_Check
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Blank_Check]
(
    [Email_Blank_Flag] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Login_User
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Login_User]
(
    [Email_Login_Id] VARCHAR(10) NOT NULL,
    [Email_Login_Name] VARCHAR(50) NOT NULL,
    [Email_Login_Password] VARCHAR(10) NOT NULL,
    [Email_Login_Status] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Partyreport
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Partyreport]
(
    [Email_Party_Code] CHAR(10) NOT NULL,
    [Email_Report_Names] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Report_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Report_Log]
(
    [Email_Login_Id] VARCHAR(10) NOT NULL,
    [Email_Activity_Type] CHAR(1) NOT NULL,
    [Email_Activity_Date] INT NOT NULL,
    [Email_Activity_Time] INT NOT NULL,
    [Email_From_Party] VARCHAR(10) NOT NULL,
    [Email_Mail_Add] VARCHAR(50) NOT NULL,
    [Email_Report_Name] VARCHAR(5000) NULL,
    [Email_Report_Date] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Report_Settings
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Report_Settings]
(
    [Email_Report_Name] VARCHAR(50) NOT NULL,
    [Email_Report_Path] VARCHAR(256) NOT NULL,
    [Email_Report_Subject] VARCHAR(256) NOT NULL,
    [Email_Report_Cc] VARCHAR(256) NOT NULL,
    [Email_Report_Body] VARCHAR(256) NOT NULL,
    [Email_Report_Priority] INT NOT NULL,
    [Email_Report_Parameter] VARCHAR(256) NOT NULL,
    [Email_Search_Parameter] VARCHAR(256) NOT NULL,
    [Email_Out_File_Prefix] VARCHAR(10) NOT NULL,
    [Email_Output_FoLder] VARCHAR(256) NOT NULL,
    [Email_Output_Sub_FoLder] VARCHAR(100) NOT NULL,
    [Email_DateFoRmat] INT NOT NULL,
    [Email_Table_Name] VARCHAR(200) NULL,
    [Email_Network_Path] VARCHAR(256) NOT NULL,
    [Email_Report_From] VARCHAR(256) NOT NULL,
    [Email_Out_File_Suffix] VARCHAR(20) NULL,
    [Email_Out_File_SubFolderFlag] INT NULL,
    [Email_Out_File_SrNo_Part1] INT NULL,
    [Email_Out_File_SrNo_Part2] INT NULL,
    [Email_Out_File_SrNo_Type] VARCHAR(8) NULL,
    [Email_Out_File_Name] VARCHAR(50) NULL,
    [Email_Report_Desc] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[ErrorLog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] NTEXT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Exchanges
-- --------------------------------------------------
CREATE TABLE [dbo].[Exchanges]
(
    [Exchange] VARCHAR(3) NOT NULL,
    [Short_name] VARCHAR(20) NULL,
    [Long_name] VARCHAR(20) NULL,
    [Address1] VARCHAR(25) NULL,
    [Address2] VARCHAR(25) NULL,
    [City] VARCHAR(20) NULL,
    [State] VARCHAR(15) NULL,
    [Nation] VARCHAR(15) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Saj_code] VARCHAR(10) NULL,
    [Alloc_method] VARCHAR(3) NULL,
    [marketsegment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLIENTBROKSCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLIENTBROKSCHEME]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_BROKTABLE] INT NULL,
    [OPT_BROKTABLE] INT NULL,
    [FUT_EXP_BROKTABLE] INT NULL,
    [OPT_EXC_BROKTABLE] INT NULL,
    [COMM_DEL_BROKTABLE] INT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [OPT_BROK_COMPUTEON] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLIENTTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLIENTTAXES]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_INSURANCE_CHRG] NUMERIC(18, 10) NULL,
    [FUT_TURNOVER_TAX] NUMERIC(18, 10) NULL,
    [FUT_OTHER_CHRG] NUMERIC(18, 10) NULL,
    [FUT_SEBITURN_TAX] NUMERIC(18, 10) NULL,
    [FUT_BROKER_NOTE] NUMERIC(18, 10) NULL,
    [OPT_INSURANCE_CHRG] NUMERIC(18, 10) NULL,
    [OPT_TURNOVER_TAX] NUMERIC(18, 10) NULL,
    [OPT_OTHER_CHRG] NUMERIC(18, 10) NULL,
    [OPT_SEBITURN_TAX] NUMERIC(18, 10) NULL,
    [OPT_BROKER_NOTE] NUMERIC(18, 10) NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [ROFIG] INT NULL,
    [ERRNUM] MONEY NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOGLOBALS
-- --------------------------------------------------
CREATE TABLE [dbo].[FOGLOBALS]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Span
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Span]
(
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Spanmargin] MONEY NULL,
    [Premium] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Pmarginrate] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Newspanmargin] MONEY NULL,
    [Finaltotalmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoOwner
-- --------------------------------------------------
CREATE TABLE [dbo].[FoOwner]
(
    [Company] VARCHAR(200) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(15) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [expdeposit] MONEY NULL,
    [Style] INT NULL,
    [FAX] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement_09092020
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement_09092020]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 0) NULL,
    [Trade_no] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NOT NULL,
    [User_id] INT NOT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTAXES]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] VARCHAR(3) NULL,
    [Insurance_Chrg] DECIMAL(5, 4) NULL,
    [Turnover_tax] NUMERIC(18, 6) NULL,
    [Other_chrg] DECIMAL(5, 4) NULL,
    [Sebiturn_tax] DECIMAL(5, 4) NULL,
    [Broker_note] DECIMAL(5, 4) NULL,
    [From_date] DATETIME NULL,
    [Demat_Insure] DECIMAL(3, 2) NULL,
    [To_Date] DATETIME NULL,
    [Inst_Type] VARCHAR(3) NULL,
    [Turnover_Tax_On] VARCHAR(6) NULL,
    [Other_Chrg_On] VARCHAR(7) NULL,
    [Sebi_Tax_On] VARCHAR(7) NULL,
    [Broker_Note_On] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENTBROKSCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENTBROKSCHEME]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_BROKTABLE] INT NULL,
    [OPT_BROKTABLE] INT NULL,
    [FUT_EXP_BROKTABLE] INT NULL,
    [OPT_EXC_BROKTABLE] INT NULL,
    [COMM_DEL_BROKTABLE] INT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [OPT_BROK_COMPUTEON] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENTTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENTTAXES]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_INSURANCE_CHRG] NUMERIC(18, 10) NULL,
    [FUT_TURNOVER_TAX] NUMERIC(18, 10) NULL,
    [FUT_OTHER_CHRG] NUMERIC(18, 10) NULL,
    [FUT_SEBITURN_TAX] NUMERIC(18, 10) NULL,
    [FUT_BROKER_NOTE] NUMERIC(18, 10) NULL,
    [OPT_INSURANCE_CHRG] NUMERIC(18, 10) NULL,
    [OPT_TURNOVER_TAX] NUMERIC(18, 10) NULL,
    [OPT_OTHER_CHRG] NUMERIC(18, 10) NULL,
    [OPT_SEBITURN_TAX] NUMERIC(18, 10) NULL,
    [OPT_BROKER_NOTE] NUMERIC(18, 10) NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 9) NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_after_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_after_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_before_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_before_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.history
-- --------------------------------------------------
CREATE TABLE [dbo].[history]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(15) NOT NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] VARCHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] VARCHAR(15) NULL,
    [status] VARCHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(3) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(2) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] VARCHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ihistory
-- --------------------------------------------------
CREATE TABLE [dbo].[ihistory]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(15) NOT NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] VARCHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] VARCHAR(15) NULL,
    [status] VARCHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(3) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(2) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] VARCHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Instclient_Tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[Instclient_Tbl]
(
    [Partycode] CHAR(10) NULL,
    [Marketrate] CHAR(1) NULL,
    [Brokerage] CHAR(1) NULL,
    [Netrate] CHAR(1) NULL,
    [Noc] INT NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicltid
-- --------------------------------------------------
CREATE TABLE [dbo].[multicltid]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [DpId] VARCHAR(16) NULL,
    [Introducer] VARCHAR(100) NULL,
    [DpType] VARCHAR(4) NULL,
    [def] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicltlog
-- --------------------------------------------------
CREATE TABLE [dbo].[multicltlog]
(
    [Party_Code] VARCHAR(10) NULL,
    [OCltDpId] VARCHAR(16) NULL,
    [ODpId] VARCHAR(8) NULL,
    [OPOA] INT NULL,
    [NCltDpID] VARCHAR(16) NULL,
    [NDpId] VARCHAR(8) NULL,
    [NPOA] INT NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedDate] DATETIME NULL,
    [RecordFrom] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multicompany
-- --------------------------------------------------
CREATE TABLE [dbo].[Multicompany]
(
    [CompanyName] VARCHAR(35) NULL,
    [Exchange] CHAR(3) NULL,
    [ShareDB] VARCHAR(12) NULL,
    [AccountDB] VARCHAR(12) NULL,
    [DefaultClient] INT NULL,
    [segment] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multiisin
-- --------------------------------------------------
CREATE TABLE [dbo].[multiisin]
(
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] CHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Valid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner]
(
    [Company] VARCHAR(200) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(25) NULL,
    [Zip] VARCHAR(6) NULL,
    [City] VARCHAR(20) NULL,
    [Membercode] VARCHAR(15) NULL,
    [Bankname] VARCHAR(50) NULL,
    [Bankadd] VARCHAR(50) NULL,
    [Csdlid] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [Dpid] VARCHAR(10) NULL,
    [Cltaccno] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Std_Rate] SMALLINT NULL,
    [P_To_P] SMALLINT NULL,
    [Demat_Tableno] SMALLINT NULL,
    [Albmcf_Tableno] SMALLINT NULL,
    [Mf_Tableno] SMALLINT NULL,
    [Sb_Tableno] SMALLINT NULL,
    [Brok1_Tableno] SMALLINT NULL,
    [Brok2_Tableno] SMALLINT NULL,
    [Brok3_Tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [Tscheme] TINYINT NULL,
    [Dispcharge] TINYINT NULL,
    [Brok_Inc_Stax] TINYINT NULL,
    [Def_Scheme] CHAR(1) NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontcharge] TINYINT NULL,
    [Marginmultiplier] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [Style] INT NULL,
    [Exchangecode] VARCHAR(5) NULL,
    [Brokersebiregno] VARCHAR(15) NULL,
    [Counterparty] VARCHAR(15) NULL,
    [Cp_Sebiregno] VARCHAR(15) NULL,
    [Panno] VARCHAR(50) NULL,
    [Fax] VARCHAR(25) NULL,
    [State] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyMapping]
(
    [OldParty_Code] VARCHAR(12) NULL,
    [NewParty_code] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.paymentmode
-- --------------------------------------------------
CREATE TABLE [dbo].[paymentmode]
(
    [paycode] VARCHAR(2) NULL,
    [paycodename] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Pobank
-- --------------------------------------------------
CREATE TABLE [dbo].[Pobank]
(
    [Bankid] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(40) NOT NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL,
    [MICRNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prad_multicompany
-- --------------------------------------------------
CREATE TABLE [dbo].[prad_multicompany]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prad_ukmulticompany
-- --------------------------------------------------
CREATE TABLE [dbo].[prad_ukmulticompany]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rating
-- --------------------------------------------------
CREATE TABLE [dbo].[Rating]
(
    [Rating] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Region
-- --------------------------------------------------
CREATE TABLE [dbo].[Region]
(
    [Regioncode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.roundparam
-- --------------------------------------------------
CREATE TABLE [dbo].[roundparam]
(
    [RoundStyle] SMALLINT NULL,
    [Description] CHAR(25) NULL,
    [Round_to] SMALLINT NULL,
    [RoFig] SMALLINT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] SMALLINT NULL,
    [RoundMarketrate] TINYINT NULL,
    [RoundBrokerage] TINYINT NULL,
    [RoundNetrate] TINYINT NULL,
    [OtherRound] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sbu_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Sbu_Master]
(
    [Sbu_Code] VARCHAR(10) NOT NULL,
    [Sbu_Name] VARCHAR(50) NOT NULL,
    [Sbu_Addr1] VARCHAR(40) NOT NULL,
    [Sbu_Addr2] VARCHAR(40) NULL,
    [Sbu_Addr3] VARCHAR(40) NULL,
    [Sbu_City] VARCHAR(20) NULL,
    [Sbu_State] VARCHAR(20) NULL,
    [Sbu_Zip] VARCHAR(10) NULL,
    [Sbu_Phone1] VARCHAR(15) NULL,
    [Sbu_Phone2] VARCHAR(15) NULL,
    [Sbu_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Mapping]
(
    [SP_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SP_Party_Code] VARCHAR(10) NULL,
    [SP_Computation_Level] CHAR(1) NULL,
    [SP_Product_Code] VARCHAR(3) NULL,
    [SP_Series_Id] INT NULL,
    [SP_Scheme_Id] INT NOT NULL,
    [SP_Trd_Type] VARCHAR(3) NULL,
    [SP_Scheme_Type] CHAR(1) NULL,
    [SP_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Buy_Brok_Type] CHAR(1) NULL,
    [SP_Sell_Brok_Type] CHAR(1) NULL,
    [SP_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Sell_Brok] NUMERIC(18, 4) NULL,
    [SP_Value_From] NUMERIC(18, 4) NOT NULL,
    [SP_Value_To] NUMERIC(18, 4) NOT NULL,
    [SP_Brok_ComputeOn] CHAR(1) NULL,
    [SP_Brok_ComputeType] CHAR(1) NULL,
    [SP_Min_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Min_SeriesIdAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_SeriesIdAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Date_From] DATETIME NOT NULL,
    [SP_Date_To] DATETIME NOT NULL,
    [SP_CreatedBy] VARCHAR(20) NULL,
    [SP_CreatedOn] DATETIME NOT NULL,
    [SP_ModifiedBy] VARCHAR(20) NULL,
    [SP_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Master]
(
    [SM_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SM_Scheme_Id] INT NOT NULL,
    [SM_Scheme_Desc] VARCHAR(20) NULL,
    [SM_Trd_Type] VARCHAR(3) NULL,
    [SM_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Buy_Brok_Type] CHAR(1) NULL,
    [SM_Sell_Brok_Type] CHAR(10) NULL,
    [SM_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Value_From] NUMERIC(18, 4) NOT NULL,
    [SM_Value_To] NUMERIC(18, 4) NOT NULL,
    [SM_ComputationOn] CHAR(1) NULL,
    [SM_ComputationType] CHAR(1) NULL,
    [SM_CreatedBy] VARCHAR(20) NULL,
    [SM_CreatedOn] DATETIME NOT NULL,
    [SM_ModifiedBy] VARCHAR(20) NULL,
    [SM_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Schemes
-- --------------------------------------------------
CREATE TABLE [dbo].[Schemes]
(
    [schemeID] TINYINT NULL,
    [Desc] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip1]
(
    [Co_Code] INT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Short_Name] VARCHAR(50) NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Market_Lot] INT NULL,
    [Face_Val] FLOAT NULL,
    [Book_Cl_Dt] DATETIME NULL,
    [Ex_Div_Dt] DATETIME NULL,
    [Ex_Bon_Dt] DATETIME NULL,
    [Ex_Rit_Dt] DATETIME NULL,
    [Eqt_Type] VARCHAR(3) NULL,
    [Sub_Type] VARCHAR(3) NULL,
    [Agent_Cd] VARCHAR(6) NULL,
    [Demat_Flag] SMALLINT NULL,
    [Demat_Date] DATETIME NULL,
    [Rec1] VARCHAR(10) NULL,
    [Rec2] VARCHAR(10) NULL,
    [Rec3] VARCHAR(10) NULL,
    [Rec4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip2
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip2]
(
    [Co_Code] INT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Scrip_Cat] VARCHAR(3) NULL,
    [No_Del_Fr] DATETIME NULL,
    [No_Del_To] DATETIME NULL,
    [Cl_Rate] FLOAT NULL,
    [Clos_Rate_Dt] DATETIME NULL,
    [Min_Trd_Qty] INT NULL,
    [Bsecode] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [Delsc_Cat] VARCHAR(3) NULL,
    [Sector] VARCHAR(10) NULL,
    [Track] VARCHAR(10) NULL,
    [Cdol_No] VARCHAR(10) NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL,
    [Globalcustodian] VARCHAR(10) NULL,
    [common_code] VARCHAR(25) NULL,
    [IndexName] VARCHAR(10) NULL,
    [Industry] VARCHAR(10) NULL,
    [Bloomberg] VARCHAR(10) NULL,
    [RicCode] VARCHAR(10) NULL,
    [Reuters] VARCHAR(10) NULL,
    [IES] VARCHAR(10) NULL,
    [NoofIssuedshares] NUMERIC(18, 4) NULL,
    [Status] VARCHAR(10) NULL,
    [ADRGDRRatio] NUMERIC(18, 4) NULL,
    [GEMultiple] NUMERIC(18, 4) NULL,
    [GroupforGE] INT NULL,
    [RBICeilingIndicatorFlag] VARCHAR(2) NULL,
    [RBICeilingIndicatorValue] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SPLIT_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[SPLIT_LEDGER]
(
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.State_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[State_Master]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [State] VARCHAR(50) NOT NULL,
    [TrdStampDuty] DECIMAL(18, 4) NOT NULL,
    [DelStampDuty] DECIMAL(18, 4) NOT NULL,
    [ProStampDuty] DECIMAL(18, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Stt_Clientdetail
-- --------------------------------------------------
CREATE TABLE [dbo].[Stt_Clientdetail]
(
    [Rectype] INT NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Contractno] VARCHAR(7) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [product_type] VARCHAR(5) NULL,
    [product_code] VARCHAR(10) NULL,
    [Series_code] VARCHAR(13) NULL,
    [Series_id] INT NULL,
    [Expirydate] DATETIME NOT NULL,
    [Trdprice] MONEY NULL,
    [Pqtytrd] INT NULL,
    [Pamttrd] MONEY NULL,
    [Pstttrd] MONEY NULL,
    [Sqtytrd] INT NULL,
    [Samttrd] MONEY NULL,
    [Sstttrd] MONEY NULL,
    [Totalstt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Stt_Exchg
-- --------------------------------------------------
CREATE TABLE [dbo].[Stt_Exchg]
(
    [Stt_Date] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Tot_TurnOver] NUMERIC(18, 4) NULL,
    [Tot_Stt] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokers]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] CHAR(30) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.taxes
-- --------------------------------------------------
CREATE TABLE [dbo].[taxes]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] VARCHAR(3) NULL,
    [Insurance_Chrg] DECIMAL(5, 4) NULL,
    [Turnover_tax] DECIMAL(4, 3) NULL,
    [Other_chrg] DECIMAL(3, 2) NULL,
    [Sebiturn_tax] DECIMAL(3, 2) NULL,
    [Broker_note] DECIMAL(3, 2) NULL,
    [From_date] DATETIME NULL,
    [Demat_Insure] DECIMAL(3, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_clientmargin]
(
    [Party_Code] VARCHAR(15) NOT NULL,
    [Margindate] DATETIME NOT NULL,
    [Billamount] MONEY NOT NULL,
    [Ledgeramount] MONEY NOT NULL,
    [Cash_Coll] MONEY NOT NULL,
    [Noncash_Coll] MONEY NOT NULL,
    [Initialmargin] MONEY NOT NULL,
    [Lst_Update_Dt] DATETIME NOT NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Family] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [Trader] VARCHAR(20) NULL,
    [Mtmmargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Mtompremiumbill
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Mtompremiumbill]
(
    [Billdate] SMALLDATETIME NULL,
    [Pqty] INT NULL,
    [Sqty] INT NULL,
    [Netrate] MONEY NULL,
    [Cl_Rate] MONEY NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Product_type] VARCHAR(20) NULL,
    [Product_Code] VARCHAR(20) NULL,
    [Series_Code] VARCHAR(20) NULL,
    [Series_Id] INT NOT NULL,
    [expirydate] DATETIME NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [Sdate] SMALLDATETIME NULL,
    [Sell_Buy] INT NULL,
    [Service_Tax] MONEY NULL,
    [Brok] MONEY NULL,
    [Nonexpiryservice_Tax] MONEY NULL,
    [Nonexpirybrok] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Stampduty] MONEY NULL,
    [Inex_Service_Tax] MONEY NULL,
    [Inex_Sebi_Tax] MONEY NULL,
    [Inex_Turn_Tax] MONEY NULL,
    [Inex_Stampduty] MONEY NULL,
    [Expirybrok] MONEY NULL,
    [Expiryservice_Tax] MONEY NULL,
    [Insurance_Chrg] MONEY NULL,
    [Inex_Insurance_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Inex_Other_Chrg] MONEY NULL,
    [Auctionpart] VARCHAR(2) NULL,
    [Netwithbrok] MONEY NULL,
    [Bfdayflag] VARCHAR(3) NULL,
    [Reserved1] INT NULL,
    [Actbuyqty] INT NULL,
    [Actsellqty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbladmin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbladmin]
(
    [fldauto_admin] INT IDENTITY(1,1) NOT NULL,
    [fldname] VARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(30) NOT NULL,
    [fldcompany] VARCHAR(50) NULL,
    [fldstname] VARCHAR(50) NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [flddesc] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblAdminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[TblAdminconfig]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcatmenu]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldreportcode] INT NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblGlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblGlobalParams]
(
    [FLDPWDMINLENGTH] SMALLINT NOT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NOT NULL,
    [FLDSPCLCHAR] CHAR(1) NOT NULL,
    [FLDENCRYPTION] CHAR(1) NOT NULL,
    [FLDBLOCKPWD] VARCHAR(255) NOT NULL,
    [FLDDELBLOCK] CHAR(1) NOT NULL,
    [fldlastins] BIGINT NOT NULL,
    [fldlastdel] BIGINT NOT NULL,
    [fldlastupdt] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblmenuhead
-- --------------------------------------------------
CREATE TABLE [dbo].[tblmenuhead]
(
    [fldmenucode] VARCHAR(20) NULL,
    [fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreportgrp]
(
    [fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [fldgrpname] VARCHAR(35) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreports
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreports]
(
    [fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [fldreportname] VARCHAR(25) NULL,
    [fldpath] VARCHAR(100) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports_Blocked]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblsysusers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblsysusers]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_calc_fo
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_calc_fo]
(
    [SUB_BROKER] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [brokapplied] MONEY NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [sauda_date] DATETIME NULL,
    [product_code] VARCHAR(10) NULL,
    [series_code] VARCHAR(20) NULL,
    [User_id] VARCHAR(7) NOT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Tradeqty] INT NULL,
    [SELL_BUY] INT NOT NULL,
    [Strike_price] MONEY NULL,
    [marketrate] MONEY NULL,
    [BROKCHRG] MONEY NULL,
    [BROK_AMT] MONEY NULL,
    [expirydate] SMALLDATETIME NULL,
    [Percentage] MONEY NULL,
    [product_type] VARCHAR(5) NULL,
    [bmarkup] INT NULL,
    [smarkup] INT NULL,
    [brok_per_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.termlimit
-- --------------------------------------------------
CREATE TABLE [dbo].[termlimit]
(
    [UserId] NVARCHAR(50) NOT NULL,
    [Tradelimit] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.termparty
-- --------------------------------------------------
CREATE TABLE [dbo].[termparty]
(
    [UserId] NVARCHAR(10) NOT NULL,
    [Party_code] NVARCHAR(10) NOT NULL,
    [TMark] NVARCHAR(1) NULL,
    [Scheme] NVARCHAR(2) NULL,
    [ProCli] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestACCBill
-- --------------------------------------------------
CREATE TABLE [dbo].[TestACCBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [MTM] MONEY NULL,
    [PREMIUMPAYABLE] MONEY NULL,
    [PREMIUMRECEIVABLE] MONEY NULL,
    [NETPREMIUM] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [SERVICETAX] MONEY NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] MONEY NULL,
    [RESERVED4] MONEY NULL,
    [RESERVED5] INT NULL,
    [branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestValan
-- --------------------------------------------------
CREATE TABLE [dbo].[TestValan]
(
    [Party_Code] VARCHAR(15) NOT NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Client_Type] VARCHAR(20) NOT NULL,
    [BillNo] VARCHAR(20) NOT NULL,
    [ContractNo] VARCHAR(20) NOT NULL,
    [Product_Code] VARCHAR(20) NOT NULL,
    [Series_Code] VARCHAR(20) NOT NULL,
    [expirydate] DATETIME NOT NULL,
    [Product_type] VARCHAR(20) NOT NULL,
    [Series_Id] INT NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [Market_Lot] INT NOT NULL,
    [AuctionPart] VARCHAR(20) NOT NULL,
    [MaturityDate] DATETIME NOT NULL,
    [Sauda_date] DATETIME NOT NULL,
    [IsIn] VARCHAR(20) NOT NULL,
    [PQty] INT NOT NULL,
    [SQty] INT NOT NULL,
    [PRate] MONEY NOT NULL,
    [SRate] MONEY NOT NULL,
    [PAmt] MONEY NOT NULL,
    [SAmt] MONEY NOT NULL,
    [PBrokAmt] MONEY NOT NULL,
    [SBrokAmt] MONEY NOT NULL,
    [PBillAmt] MONEY NOT NULL,
    [SBillAmt] MONEY NOT NULL,
    [Cl_Rate] MONEY NOT NULL,
    [Cl_Chrg] MONEY NOT NULL,
    [ExCl_Chrg] MONEY NOT NULL,
    [Service_Tax] MONEY NOT NULL,
    [ExSer_Tax] MONEY NOT NULL,
    [InExSerFlag] SMALLINT NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [Broker_note] MONEY NOT NULL,
    [Ins_Chrg] MONEY NOT NULL,
    [Other_Chrg] MONEY NOT NULL,
    [TradeType] VARCHAR(20) NOT NULL,
    [ParticiPantCode] VARCHAR(25) NOT NULL,
    [Terminal_Id] VARCHAR(25) NOT NULL,
    [Family] VARCHAR(20) NOT NULL,
    [FamilyName] VARCHAR(100) NOT NULL,
    [Trader] VARCHAR(40) NOT NULL,
    [Branch_Code] VARCHAR(20) NOT NULL,
    [Sub_Broker] VARCHAR(20) NOT NULL,
    [StatusName] VARCHAR(25) NOT NULL,
    [Exchange] VARCHAR(10) NOT NULL,
    [Segment] VARCHAR(25) NOT NULL,
    [MemberType] VARCHAR(10) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Region] VARCHAR(20) NOT NULL,
    [UpdateDate] VARCHAR(11) NOT NULL,
    [email] VARCHAR(100) NOT NULL,
    [sbu] VARCHAR(20) NOT NULL,
    [relmgr] VARCHAR(20) NOT NULL,
    [grp] VARCHAR(20) NOT NULL,
    [sector] VARCHAR(20) NOT NULL,
    [CMClosing] MONEY NOT NULL,
    [track] VARCHAR(20) NOT NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trade_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[trade_omnesys]
(
    [EXCHG_ORDER_NO] VARCHAR(25) NULL,
    [REMARKS] VARCHAR(20) NULL,
    [USERID] VARCHAR(15) NULL,
    [EXCHG] VARCHAR(8) NULL,
    [FILE_DATE] DATE NULL,
    [sell_buy] VARCHAR(10) NULL,
    [TRD_SYMBOL] VARCHAR(100) NULL,
    [PRODUCT_TYPE] VARCHAR(100) NULL,
    [TRADE_QTY] INT NULL,
    [ORDER_SOURCE] VARCHAR(100) NULL,
    [SYMBOL] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ucc_client
-- --------------------------------------------------
CREATE TABLE [dbo].[ucc_client]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NOT NULL,
    [Contract_Person] VARCHAR(60) NULL,
    [ClearingNo1] VARCHAR(4) NULL,
    [ClearingNo2] VARCHAR(4) NULL,
    [ClearingNo3] VARCHAR(4) NULL,
    [ClearingNo4] VARCHAR(4) NULL,
    [MapidId] VARCHAR(10) NULL,
    [FMCode] VARCHAR(10) NULL,
    [DEALING_WITH_OTHRER_TM] VARCHAR(50) NULL,
    [ANY_OTHER_ACC] VARCHAR(50) NULL,
    [Family_code1] VARCHAR(10) NULL,
    [Family_code2] VARCHAR(10) NULL,
    [Family_code3] VARCHAR(10) NULL,
    [Family_code4] VARCHAR(10) NULL,
    [Remark] VARCHAR(100) NULL,
    [Ucc_Code] VARCHAR(16) NULL,
    [StpProvider] VARCHAR(100) NULL,
    [dummy1] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_Data]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_Text
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_Text]
(
    [C_SR_NO] DECIMAL(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BillPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BillPrint_Setting]
(
    [Rpt_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(300) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_data
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_data]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_TEXT]
(
    [C_SR_NO] DECIMAL(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_contractprint_setting
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_contractprint_setting]
(
    [Rpt_SrNo] INT NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(50) NULL,
    [Rpt_XPos] DECIMAL(10, 0) NULL,
    [Rpt_YPos] DECIMAL(18, 0) NULL,
    [Rpt_Width] DECIMAL(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Digital_File_Name]
(
    [SrNo] INT NOT NULL,
    [D_Type] VARCHAR(8) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(10) NULL,
    [D_Order] INT NULL,
    [D_Seprater] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Login_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Login_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [Category] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusId] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [Action] VARCHAR(6) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Report_Access_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [RepPath] VARCHAR(4000) NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(50) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusID] VARCHAR(32) NULL,
    [IPAdd] VARCHAR(20) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ValanAccount
-- --------------------------------------------------
CREATE TABLE [dbo].[ValanAccount]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.Angel_Client2
-- --------------------------------------------------
CREATE view Angel_Client2  
as  
select party_Code from client2 (nolock)   
where party_code not in (select branch_code from branch (nolock))  
and party_code not in (Select sub_Broker from subbrokers (nolock))

GO

-- --------------------------------------------------
-- VIEW dbo.BFOAsalepur1
-- --------------------------------------------------

CREATE view [dbo].[BFOAsalepur1] AS
select t1.party_code,t1.series_code,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.sell_buy = 2),0),
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.series_code,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOASALEPUR2
-- --------------------------------------------------

CREATE view [dbo].[BFOASALEPUR2] AS
select t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
               and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 2),0),
strikeprice=isnull((select distinct bs.StrikePrice from bfoscrip2 bs where bs.product_code=t1.product_code and bs.product_type=t1.product_type and bs.series_code=t1.series_code and bs.series_id=t1.series_id) ,0) ,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBILLPQTYSQTY
-- --------------------------------------------------

CREATE view [dbo].[BFOBILLPQTYSQTY] AS   
select   
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty) else 0 end ),  
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty) else 0 end )  ,  
Party_Code,s.Series_Code,s.Series_id,S.EXPIRYDATE  
from BFoSettlement s  
group by   
party_code,s.Series_Code,s.Series_id,S.EXPIRYDATE,sell_Buy

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBILLTOTQT
-- --------------------------------------------------

CREATE view [dbo].[BFOBILLTOTQT] AS  
SELECT PQTY=SUM(pqty),SQTY=SUM(Sqty),Party_Code,s.Series_Code,s.Series_id,S.EXPIRYDATE  
from BFOBILLPQTYSQTY s  
group by   
party_code,s.Series_Code,s.Series_id,s.expirydate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBROKVIEW_EXALLOCFINAL
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOBROKVIEW_EXALLOCFINAL] 
AS 
  SELECT BFOBROKVIEW_EXALLOC.TRADE_NO, 
         BFOBROKVIEW_EXALLOC.PRODUCT_CODE, 
         BFOBROKVIEW_EXALLOC.PRODUCT_TYPE, 
         BFOBROKVIEW_EXALLOC.PARTY_CODE, 
         BFOBROKVIEW_EXALLOC.SERIES_CODE, 
         BFOBROKVIEW_EXALLOC.SERIES_ID, 
         BFOBROKVIEW_EXALLOC.EXPIRYDATE, 
         BFOBROKVIEW_EXALLOC.MULTIPLIER, 
         BFOBROKVIEW_EXALLOC.USER_ID, 
         BFOBROKVIEW_EXALLOC.SELL_BUY, 
         BFOBROKVIEW_EXALLOC.TRADEQTY, 
         BFOBROKVIEW_EXALLOC.MARKETRATE, 
         BFOBROKVIEW_EXALLOC.CL_TYPE, 
         BFOBROKVIEW_EXALLOC.OPPMEMCODE, 
         BFOBROKVIEW_EXALLOC.OPPTRADERCODE, 
         BFOBROKVIEW_EXALLOC.TRANS_TYPE, 
         BFOBROKVIEW_EXALLOC.STRIKEPRICE, 
         BFOBROKVIEW_EXALLOC.SAUDA_DATE, 
         BFOBROKVIEW_EXALLOC.ORDER_DATE, 
         BFOBROKVIEW_EXALLOC.ORDER_NO, 
         BFOBROKVIEW_EXALLOC.SETTFLAG, 
         BFOBROKVIEW_EXALLOC.GROUPID, 
         BFOBROKVIEW_EXALLOC.TRADERCODE, 
         FUT_BROKTABLE, 
         BFOBROKVIEW_EXALLOC.TRAN_CAT, 
         BFOBROKVIEW_EXALLOC.OFF_PHONE1, 
         BROK_SCHEME, 
         MPRICE, 
         BFOGLOBALS.SERVICE_TAX, 
         BROKTABLE.TABLE_NO, 
         BROKTABLE.LINE_NO, 
         BROKTABLE.VAL_PERC, 
         BROKTABLE.NORMAL, 
         BROKTABLE.DAY_PUC, 
         BROKTABLE.DAY_SALES, 
         BROKTABLE.SETT_PURCH, 
         BROKTABLE.SETT_SALES, 
         FOCLIENTTAXES.ROUND_TO, 
         FOCLIENTTAXES.ROFIG, 
         FOCLIENTTAXES.ERRNUM, 
         FOCLIENTTAXES.NOZERO, 
         FUT_INSURANCE_CHRG, 
         FUT_TURNOVER_TAX, 
         FUT_SEBITURN_TAX, 
         FUT_BROKER_NOTE, 
         SERTAX = BFOGLOBALS.SERVICE_TAX, 
         BFOGLOBALS.YEAR, 
         BFOGLOBALS.EXCHANGE, 
         MARKETLOT, 
         BROKAPPLIED = BFOBROKVIEW_EXALLOC.MULTIPLIER * (CASE 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'V' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL *
					 POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					 POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'V' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * 
					 POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					 (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					 POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'P' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL / 100) * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 1 
                     AND BROKTABLE.VAL_PERC = 'P' 
                     AND BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL / 100) *
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 2 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC)) *
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 2 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_PUC / 100) * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 3 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 3 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_SALES / 100) * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +
					FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 4 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 4 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_PURCH / 100) * 
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 5 
                     AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * 
					POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               WHEN (BFOBROKVIEW_EXALLOC.SETTFLAG = 5 
                     AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_SALES / 100) *
					(BFOBROKVIEW_EXALLOC.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) /
					(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
					POWER(10,FOCLIENTTAXES.ROUND_TO)) 
               ELSE 0 
             END), 
          
         INS_CHRG = 0, 
         TURN_TAX = ((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX 
				ELSE OPT_TURNOVER_TAX 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
				POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         OTHER_CHRG = ((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG 
				ELSE OPT_OTHER_CHRG 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
				POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         SEBI_TAX = ((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX 
				ELSE OPT_SEBITURN_TAX 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) *
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /
				POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         BROKER_CHRG = ((FLOOR((((CASE 
				WHEN RIGHT(BFOBROKVIEW_EXALLOC.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE 
				ELSE OPT_BROKER_NOTE 
				END * (BFOBROKVIEW_EXALLOC.CL_RATE) * BFOBROKVIEW_EXALLOC.TRADEQTY) / 100) * 
				POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / 
				(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / 
				POWER(10,FOCLIENTTAXES.ROUND_TO)), 
         BFOBROKVIEW_EXALLOC.SEC_NAME, 
         BFOBROKVIEW_EXALLOC.CL_RATE, 
         BFOBROKVIEW_EXALLOC.CALLPUT, 
         PRO_CLI, 
         O_C_FLAG, 
         C_U_FLAG, 
         MARKETTYPE, 
         AUCTIONPART, 
         PARTICIPANTCODE, 
         OLDPARTYCODE 
  FROM   BROKTABLE BROKTABLE, 
         (SELECT TRADE_NO = F.BFOEATRD_TRADE_NO, 
                 STATUS = F.BFOEATRD_STATUS, 
                 PRODUCT_CODE = F.BFOEATRD_PRODUCT_CODE, 
                 PRODUCT_TYPE = F.BFOEATRD_PRODUCT_TYPE, 
                 SERIES_CODE = F.BFOEATRD_SERIES_CODE, 
                 SERIES_ID = F.BFOEATRD_SERIES_ID, 
                 EXPIRYDATE = F.BFOEATRD_EXPIRYDATE, 
                 STRIKEPRICE = F.BFOEATRD_STRIKE_PRICE, 
                 CALLPUT = F.BFOEATRD_CALLPUT, 
                 CL_TYPE = '', 
                 OPPMEMCODE = '', 
                 OPPTRADERCODE = '', 
                 TRANS_TYPE = '', 
                 SEC_NAME = F.BFOEATRD_SEC_NAME, 
                 BOOKTYPE = '1', 
                 TRADERCODE = '', 
                 MARKETTYPE = F.BFOEATRD_MARKETTYPE, 
                 USER_ID = F.BFOEATRD_USER_ID, 
                 BRANCH_ID = '1', 
                 SELL_BUY = F.BFOEATRD_SELL_BUY, 
                 TRADEQTY = F.BFOEATRD_TRADEQTY, 
                 MARKETRATE = F.BFOEATRD_PRICE, 
                 PRO_CLI = F.BFOEATRD_PRO_CLI, 
                 PARTY_CODE = F.BFOEATRD_PARTY_CODE, 
                 PARTICIPANTCODE = '', 
                 O_C_FLAG = F.BFOEATRD_O_C_FLAG, 
                 C_U_FLAG = F.BFOEATRD_C_U_FLAG, 
                 SAUDA_DATE = F.BFOEATRD_ACTIVITYTIME, 
                 ORDER_DATE = F.BFOEATRD_ACTIVITYTIME, 
                 ORDER_NO = F.BFOEATRD_ORDER_NO, 
                 OPP_BROKER_ID = '', 
                 SETTFLAG = F.BFOEATRD_SETTFLAG, 
                 GROUPID = '', 
                 TRAN_CAT, 
                 OFF_PHONE1 = '', 
                 AUCTIONPART = F.AUCTIONPART, 
                 MPRICE = F.BFOEATRD_CL_RATE, 
                 MULTIPLIER = 1, 
                 CL_RATE = F.BFOEATRD_CL_RATE, 
                 OLDPARTYCODE, 
                 MARKETLOT 
          FROM   BFOEXALLOCTRADE F, 
                 CLIENT2 C2, 
                 BFOSCRIP2 S2 
          WHERE  C2.PARTY_CODE = F.BFOEATRD_PARTY_CODE 
                 AND F.BFOEATRD_PRODUCT_TYPE = S2.PRODUCT_TYPE 
                 AND F.BFOEATRD_PRODUCT_CODE = S2.PRODUCT_CODE 
                 AND F.BFOEATRD_SERIES_CODE = S2.SERIES_CODE 
                 AND F.BFOEATRD_SERIES_ID = S2.SERIES_ID) BFOBROKVIEW_EXALLOC, 
         BFOGLOBALS, 
         (SELECT   PARTY_CODE = T1.BFOEATRD_PARTY_CODE, 
                   PRODUCT_TYPE = T1.BFOEATRD_PRODUCT_TYPE, 
                   PRODUCT_CODE = T1.BFOEATRD_PRODUCT_CODE, 
                   SERIES_CODE = T1.BFOEATRD_SERIES_CODE, 
                   SERIES_ID = T1.BFOEATRD_SERIES_ID, 
                   SELL_BUY = T1.BFOEATRD_SELL_BUY, 
                   PQTY = SUM(CASE 
                                WHEN BFOEATRD_SELL_BUY = 1 THEN BFOEATRD_TRADEQTY 
                                ELSE 0 
                              END), 
                   SQTY = SUM(CASE 
                                WHEN BFOEATRD_SELL_BUY = 2 THEN BFOEATRD_TRADEQTY 
                                ELSE 0 
                              END), 
                   STRIKEPRICE = ISNULL((SELECT DISTINCT BS.STRIKEPRICE 
                                         FROM   BFOSCRIP2 BS 
                                         WHERE  BS.PRODUCT_CODE = T1.BFOEATRD_PRODUCT_CODE 
                                                AND BS.PRODUCT_TYPE = T1.BFOEATRD_PRODUCT_TYPE 
                                                AND BS.SERIES_CODE = T1.BFOEATRD_SERIES_CODE 
                                                AND BS.SERIES_ID = T1.BFOEATRD_SERIES_ID), 
                                        0), 
                   PRATE = (CASE 
							WHEN T1.BFOEATRD_SELL_BUY = 1 THEN SUM(BFOEATRD_PRICE * BFOEATRD_TRADEQTY) / (CASE 
								  WHEN SUM(BFOEATRD_TRADEQTY) > 0 THEN SUM(BFOEATRD_TRADEQTY) 
								  ELSE 1 
								END) 
							ELSE 0 
							END), 
                   SRATE = (CASE 
							WHEN T1.BFOEATRD_SELL_BUY = 2 THEN SUM(BFOEATRD_PRICE * BFOEATRD_TRADEQTY) / (CASE 
								  WHEN SUM(BFOEATRD_TRADEQTY) > 0 THEN SUM(BFOEATRD_TRADEQTY) 
								  ELSE 1 
								END) 
							ELSE 0 
							END) 
          FROM     BFOEXALLOCTRADE T1 
          GROUP BY T1.BFOEATRD_PARTY_CODE,T1.BFOEATRD_PRODUCT_TYPE,T1.BFOEATRD_PRODUCT_CODE,T1.BFOEATRD_SERIES_CODE, 
                   T1.BFOEATRD_SERIES_ID,T1.BFOEATRD_SELL_BUY) S, 
         FOCLIENTTAXES, 
         FOCLIENTBROKSCHEME 
  WHERE  BFOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO 
         AND BFOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO 
         AND 
          
          BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
         AND BFOBROKVIEW_EXALLOC.SELL_BUY = S.SELL_BUY 
         AND BFOBROKVIEW_EXALLOC.PRODUCT_TYPE = S.PRODUCT_TYPE 
         AND BFOBROKVIEW_EXALLOC.PRODUCT_CODE = S.PRODUCT_CODE 
         AND BFOBROKVIEW_EXALLOC.SERIES_CODE = S.SERIES_CODE 
         AND BFOBROKVIEW_EXALLOC.SERIES_ID = S.SERIES_ID 
         AND BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
         AND BROKTABLE.LINE_NO = (CASE 
									WHEN (BROK_SCHEME = 1 
									OR BROK_SCHEME = 5) THEN (SELECT MIN(BROKTABLE.LINE_NO) 
									FROM   BROKTABLE 
									WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
									AND TRD_DEL = (CASE 
												 WHEN S.PQTY >= S.SQTY THEN (CASE 
																	WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
																	ELSE 'S' 
																	END) 
												 ELSE (CASE 
														 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
														 ELSE 'S' 
													   END) 
											   END) 
									AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
									AND BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM) 
                                    WHEN (BROK_SCHEME = 3 
										OR BROK_SCHEME = 6) THEN (SELECT MIN(BROKTABLE.LINE_NO) 
										FROM   BROKTABLE 
										WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
										AND TRD_DEL = (CASE 
											 WHEN S.PQTY > S.SQTY THEN (CASE 
													  WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
													  ELSE 'S' 
													END) 
											 ELSE (CASE 
													 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
													 ELSE 'S' 
												   END) 
										   END) 
										AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
										AND BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM) 
                                WHEN BROK_SCHEME = 2 THEN (SELECT MIN(BROKTABLE.LINE_NO) 
								FROM   BROKTABLE 
								WHERE  BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE 
								AND TRD_DEL = (CASE 
									WHEN S.PQTY = S.SQTY THEN (CASE 
										WHEN S.PRATE >= S.SRATE THEN (CASE 
											WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
											ELSE 'S' 
										  END) 
										ELSE (CASE 
										WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
										ELSE 'S' 
										END) 
										END) 
									ELSE (CASE 
									WHEN S.PQTY >= S.SQTY THEN (CASE 
														 WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 1) THEN 'F' 
														 ELSE 'S' 
													   END) 
									ELSE (CASE 
									WHEN (BFOBROKVIEW_EXALLOC.SELL_BUY = 2) THEN 'F' 
									ELSE 'S' 
									END) 
									END) 
									END) 
								AND BFOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE 
								AND BFOBROKVIEW_EXALLOC.CL_RATE <= BROKTABLE.UPPER_LIM) 
								ELSE (SELECT MIN(LINE_NO) 
								FROM   BROKTABLE 
								WHERE  BFOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM 
								AND BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE) 
                                  END) 
         AND BFOBROKVIEW_EXALLOC.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.BFOBROKVIEWFINAL
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOBROKVIEWFINAL] AS       
      
 SELECT BFOBROKVIEW.TRADE_NO,  
       BFOBROKVIEW.PRODUCT_CODE,  
       BFOBROKVIEW.PRODUCT_TYPE,  
       BFOBROKVIEW.PARTY_CODE,  
       BFOBROKVIEW.SERIES_CODE,  
       BFOBROKVIEW.SERIES_ID,  
       BFOBROKVIEW.EXPIRYDATE,  
       BFOBROKVIEW.MULTIPLIER,  
       BFOBROKVIEW.USER_ID,  
       BFOBROKVIEW.SELL_BUY,  
       BFOBROKVIEW.TRADEQTY,  
       BFOBROKVIEW.MARKETRATE,  
       BFOBROKVIEW.CL_TYPE,  
       BFOBROKVIEW.OPPMEMCODE,  
       BFOBROKVIEW.OPPTRADERCODE,  
       BFOBROKVIEW.TRANS_TYPE,  
       BFOBROKVIEW.STRIKEPRICE,  
       BFOBROKVIEW.SAUDA_DATE,  
       BFOBROKVIEW.ORDER_DATE,  
       BFOBROKVIEW.ORDER_NO,  
       BFOBROKVIEW.SETTFLAG,  
       BFOBROKVIEW.GROUPID,  
       BFOBROKVIEW.TRADERCODE,  
       FUT_BROKTABLE,  
       BFOBROKVIEW.TRAN_CAT,  
       BFOBROKVIEW.OFF_PHONE1,  
       BROK_SCHEME,  
       MPRICE,  
       BFOGLOBALS.SERVICE_TAX,  
       BROKTABLE.TABLE_NO,  
       BROKTABLE.LINE_NO,  
       BROKTABLE.VAL_PERC,  
       BROKTABLE.NORMAL,  
       BROKTABLE.DAY_PUC,  
       BROKTABLE.DAY_SALES,  
       BROKTABLE.SETT_PURCH,  
       BROKTABLE.SETT_SALES,         
       FOCLIENTTAXES.ROUND_TO,  
       FOCLIENTTAXES.ROFIG,  
       FOCLIENTTAXES.ERRNUM,  
       FOCLIENTTAXES.NOZERO,         
       FUT_INSURANCE_CHRG,  
       FUT_TURNOVER_TAX,  
       FUT_SEBITURN_TAX,  
       FUT_BROKER_NOTE,  
       SERTAX = BFOGLOBALS.SERVICE_TAX,  
       BFOGLOBALS.YEAR,  
       BFOGLOBALS.EXCHANGE,  
       MARKETLOT,  
       BROKAPPLIED = BFOBROKVIEW.MULTIPLIER * (CASE   
         WHEN (BFOBROKVIEW.SETTFLAG = 1  
  AND BROKTABLE.VAL_PERC = 'V'  
  AND BFOBROKVIEW.SELL_BUY = 1) THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) +   
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 1  
  AND BROKTABLE.VAL_PERC = 'V'  
  AND BFOBROKVIEW.SELL_BUY = 2) THEN ((FLOOR((BROKTABLE.NORMAL * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 1  
  AND BROKTABLE.VAL_PERC = 'P'  
  AND BFOBROKVIEW.SELL_BUY = 1) THEN ((FLOOR((((BROKTABLE.NORMAL / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 1  
  AND BROKTABLE.VAL_PERC = 'P'  
  AND BFOBROKVIEW.SELL_BUY = 2) THEN ((FLOOR((((BROKTABLE.NORMAL / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 2  
  AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((((BROKTABLE.DAY_PUC)) * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 2  
  AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_PUC / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +   
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 3  
  AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /  
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 3  
  AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.DAY_SALES / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 4  
  AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 4  
  AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_PURCH / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +   
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 5  
  AND BROKTABLE.VAL_PERC = 'V') THEN ((FLOOR((BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) /  
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
         WHEN (BFOBROKVIEW.SETTFLAG = 5  
  AND BROKTABLE.VAL_PERC = 'P') THEN ((FLOOR((((BROKTABLE.SETT_SALES / 100) * (BFOBROKVIEW.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +   
  FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))  
         ELSE 0  
       END),  
       INS_CHRG = 0,  
       TURN_TAX = ((FLOOR((((CASE   
   WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_TURNOVER_TAX  
   ELSE OPT_TURNOVER_TAX  
   END * (BFOBROKVIEW.MARKETRATE) * BFOBROKVIEW.TRADEQTY) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
   FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +   
   FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)),  
       OTHER_CHRG = ((FLOOR((((CASE   
   WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_OTHER_CHRG  
   ELSE OPT_OTHER_CHRG  
   END * (BFOBROKVIEW.MARKETRATE) * BFOBROKVIEW.TRADEQTY) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +   
   FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) *  
   (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)),  
       SEBI_TAX = ((FLOOR((((CASE   
   WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_SEBITURN_TAX  
   ELSE OPT_SEBITURN_TAX  
   END * (BFOBROKVIEW.MARKETRATE) * BFOBROKVIEW.TRADEQTY) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
   FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +  
   FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO)),  
       BROKER_CHRG = ((FLOOR((((CASE   
   WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKER_NOTE  
   ELSE OPT_BROKER_NOTE  
   END * (BFOBROKVIEW.MARKETRATE) * BFOBROKVIEW.TRADEQTY) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
   FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +  
   FOCLIENTTAXES.NOZERO)) / POWER(10,FOCLIENTTAXES.ROUND_TO))                       
FROM   BROKTABLE BROKTABLE,  
       (SELECT F.TRADE_NO,  
               F.PRODUCT_CODE,  
               F.PRODUCT_TYPE,  
               F.PARTY_CODE,  
               F.SERIES_CODE,  
               F.SERIES_ID,  
               S2.EXPIRYDATE,  
               F.USER_ID,  
               F.SELL_BUY,  
               F.TRADEQTY,  
               F.MARKETRATE,  
               F.CL_TYPE,  
               F.OPPMEMCODE,  
         F.OPPTRADERCODE,  
               F.TRANS_TYPE,  
               S2.STRIKEPRICE,  
               F.SAUDA_DATE,  
               F.ORDER_DATE,  
               F.ORDER_NO,  
               F.SETTFLAG,  
               F.GROUPID,  
               F.TRADERCODE,  
               TRAN_CAT,  
               OFF_PHONE1,  
               MPRICE = (CASE   
                           WHEN C2.DUMMY1 = 0 THEN MARKETRATE  
                           ELSE (CASE   
                                   WHEN C2.DUMMY1 = 1 THEN (CASE   
                                                              WHEN S2.STRIKEPRICE = 0 THEN F.MARKETRATE  
                                                              ELSE S2.STRIKEPRICE  
                                                            END)  
                                   ELSE S2.STRIKEPRICE + MARKETRATE  
                                 END)  
                         END),  
               MULTIPLIER,  
               MARKETLOT  
        FROM   BFOTRADE F,  
               CLIENT2 C2,  
               BFOSCRIP2 S2,  
               CLIENT1 C1  
        WHERE  C2.PARTY_CODE = F.PARTY_CODE  
               AND C1.CL_CODE = C2.CL_CODE  
               AND F.PRODUCT_TYPE = S2.PRODUCT_TYPE  
               AND F.PRODUCT_CODE = S2.PRODUCT_CODE  
               AND F.SERIES_CODE = S2.SERIES_CODE  
               AND F.SERIES_ID = S2.SERIES_ID) BFOBROKVIEW,  
       BFOGLOBALS,  
       FOCLIENTTAXES,  
       FOCLIENTBROKSCHEME,  
       (SELECT   T1.PARTY_CODE,  
                 T1.PRODUCT_TYPE,  
                 T1.PRODUCT_CODE,  
                 T1.SERIES_CODE,  
                 T1.SERIES_ID,  
                 PQTY = SUM(CASE   
                              WHEN SELL_BUY = 1 THEN TRADEQTY  
                              ELSE 0  
                            END),  
                 SQTY = SUM(CASE   
                              WHEN SELL_BUY = 2 THEN TRADEQTY  
                              ELSE 0  
                            END),  
                 STRIKEPRICE = ISNULL((SELECT DISTINCT BS.STRIKEPRICE  
                                       FROM   BFOSCRIP2 BS  
                                       WHERE  BS.PRODUCT_CODE = T1.PRODUCT_CODE  
                                              AND BS.PRODUCT_TYPE = T1.PRODUCT_TYPE  
                                              AND BS.SERIES_CODE = T1.SERIES_CODE  
                                              AND BS.SERIES_ID = T1.SERIES_ID),  
                                      0),  
                 PRATE = (CASE   
                            WHEN SUM(CASE   
                                       WHEN SELL_BUY = 1 THEN TRADEQTY  
                                       ELSE 0  
                                     END) > 0 THEN SUM(CASE   
                                                         WHEN SELL_BUY = 1 THEN TRADEQTY * MARKETRATE  
                                                         ELSE 0  
                                                       END) / SUM(CASE   
                                                                    WHEN SELL_BUY = 1 THEN TRADEQTY  
                                                                    ELSE 0  
                                                                  END)  
                            ELSE 0  
                          END),  
                 SRATE = (CASE   
                            WHEN SUM(CASE   
                                       WHEN SELL_BUY = 2 THEN TRADEQTY  
                                       ELSE 0  
                                     END) > 0 THEN SUM(CASE   
                                                         WHEN SELL_BUY = 2 THEN TRADEQTY * MARKETRATE  
                                                         ELSE 0  
                                                       END) / SUM(CASE   
                                                                    WHEN SELL_BUY = 2 THEN TRADEQTY  
                                                                    ELSE 0  
                               END)  
                            ELSE 0  
                          END)  
        FROM     BFOTRADE T1  
        GROUP BY T1.PARTY_CODE,T1.PRODUCT_TYPE,T1.PRODUCT_CODE,T1.SERIES_CODE,  
                 T1.SERIES_ID) S  
WHERE  BFOBROKVIEW.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE  
       AND BFOBROKVIEW.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO  
       AND BFOBROKVIEW.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE  
       AND BFOBROKVIEW.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO  
       AND  
         
        BFOBROKVIEW.PARTY_CODE = S.PARTY_CODE  
       AND BFOBROKVIEW.PRODUCT_TYPE = S.PRODUCT_TYPE  
       AND BFOBROKVIEW.PRODUCT_CODE = S.PRODUCT_CODE  
       AND BFOBROKVIEW.SERIES_CODE = S.SERIES_CODE  
       AND BFOBROKVIEW.SERIES_ID = S.SERIES_ID  
       AND BROKTABLE.TABLE_NO = (CASE   
                                   WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE  
                                   ELSE OPT_BROKTABLE  
                                 END)  
       AND BROKTABLE.LINE_NO = (CASE   
                                  WHEN (BROK_SCHEME = 1  
                                         OR BROK_SCHEME = 5) THEN (SELECT MIN(BROKTABLE.LINE_NO)  
                                                                   FROM   BROKTABLE  
                                                                   WHERE  BROKTABLE.TABLE_NO = (CASE   
                                                                                  WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE  
                                                                                  ELSE OPT_BROKTABLE  
                                                                                END)  
                                                           AND TRD_DEL = (CASE   
                                                                            WHEN S.PQTY >= S.SQTY THEN   
            (CASE   
            WHEN (BFOBROKVIEW.SELL_BUY = 1) THEN 'F'  
            ELSE 'S'  
            END)  
                                                                            ELSE (CASE   
                                                                                    WHEN (BFOBROKVIEW.SELL_BUY = 2) THEN 'F'  
                                                                                    ELSE 'S'  
                                                                                  END)  
                                                                          END)  
                                                           AND BFOBROKVIEW.PARTY_CODE = S.PARTY_CODE  
                                                           AND BFOBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM)  
                                  WHEN (BROK_SCHEME = 3  
                                         OR BROK_SCHEME = 6) THEN (SELECT MIN(BROKTABLE.LINE_NO)  
                                                                   FROM   BROKTABLE  
                                                                   WHERE  BROKTABLE.TABLE_NO = (CASE   
                                                                                                  WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT'  
              THEN FUT_BROKTABLE  
                                                                                                  ELSE OPT_BROKTABLE  
                                                                                                END)  
                                                                          AND TRD_DEL = (CASE   
                                                                                           WHEN S.PQTY > S.SQTY THEN   
            (CASE   
                                                                                                 WHEN (BFOBROKVIEW.SELL_BUY = 1) THEN 'F'  
   ELSE 'S'  
                                                                                                 END)  
                                                                                           ELSE (CASE   
                                                                                                   WHEN (BFOBROKVIEW.SELL_BUY = 2) THEN 'F'  
                                                                                                   ELSE 'S'  
                                                                                                 END)  
                                                                                         END)  
                                                                          AND BFOBROKVIEW.PARTY_CODE = S.PARTY_CODE  
                                                                          AND BFOBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM)  
                                  WHEN BROK_SCHEME = 2 THEN (SELECT MIN(BROKTABLE.LINE_NO)  
                                                             FROM   BROKTABLE  
                                                             WHERE  BROKTABLE.TABLE_NO = (CASE   
                                                                                  WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE  
                                                                                  ELSE OPT_BROKTABLE  
                                                                                END)  
                                                                    AND TRD_DEL = (CASE   
                                                                     WHEN S.PQTY = S.SQTY THEN (CASE   
                                                                          WHEN S.PRATE >= S.SRATE THEN   
            (CASE   
                                                                                                  WHEN (BFOBROKVIEW.SELL_BUY = 1) THEN 'F'  
                                                                                                  ELSE 'S'  
                                                                                                END)  
                                                                          ELSE (CASE   
                                                                                  WHEN (BFOBROKVIEW.SELL_BUY = 2) THEN 'F'  
                                                                                  ELSE 'S'  
                                                                                END)  
                                                                        END)  
                                                                     ELSE (CASE   
                                                                             WHEN S.PQTY >= S.SQTY THEN (CASE   
                                                                                                           WHEN (BFOBROKVIEW.SELL_BUY = 1) THEN 'F'  
                                                                                                           ELSE 'S'  
                                                                                                         END)  
                                                                             ELSE (CASE   
                                                                                     WHEN (BFOBROKVIEW.SELL_BUY = 2) THEN 'F'  
                                                                                     ELSE 'S'  
                                                                                   END)  
                                                                           END)  
                                                                                   END)  
                                                                    AND BFOBROKVIEW.PARTY_CODE = S.PARTY_CODE  
                                                                    AND BFOBROKVIEW.MARKETRATE <= BROKTABLE.UPPER_LIM)  
                                  ELSE (SELECT MIN(LINE_NO)  
                                        FROM   BROKTABLE  
                                        WHERE  BFOBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM  
                                               AND BROKTABLE.TABLE_NO = (CASE   
                                                    WHEN RIGHT(BFOBROKVIEW.PRODUCT_CODE,3) = 'FUT' THEN FUT_BROKTABLE  
                                                                           ELSE OPT_BROKTABLE  
                                                                         END))  
                                END)  
                                 
       AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.bFoBrokviewFinal_Expiry
-- --------------------------------------------------

CREATE  view bFoBrokviewFinal_Expiry as     
    
    
SELECT               
	BfoBrokView.Trade_no,BfoBrokView.product_code,BfoBrokView.product_type,BfoBrokView.party_code,BfoBrokView.series_code,BfoBrokView.series_id,bfobrokview.expirydate,bfobrokview.multiplier,BfoBrokView.user_id,    
	BfoBrokView.sell_buy,BfoBrokView.tradeqty,BfoBrokView.marketrate,BfoBrokView.Cl_type,BfoBrokView.OppMemCode,BfoBrokView.OppTraderCode,BfoBrokView.Trans_Type,bfobrokview.strikeprice,BfoBrokView.Sauda_Date,BfoBrokView.Order_Date,    
	BfoBrokView.Order_No,BfoBrokView.settflag,BfoBrokView.groupid,BfoBrokView.tradercode,bfobrokview.Std_Rate,bfobrokview.Tran_Cat,bfobrokview.Off_phone1,      
	bfobrokview.Brok_Scheme,MPrice,bFoGlobals.Service_tax,    
	BrokTable.Table_No,BrokTable.Line_No,BrokTable.Val_perc,broktable.Normal,broktable.day_puc,Broktable.day_sales,    
	Broktable.Sett_purch,Broktable.Sett_sales,Broktable.round_to,broktable.roFig,broktable.errnum,broktable.NoZero,    
	bFOTAXES.Insurance_chrg,bFOTAXES.turnover_tax,bFOTAXES.sebiturn_tax,bFOTAXES.broker_note,    
	SerTax=bFOGLOBALS.service_tax,bFOGLOBALS.year,bFOGLOBALS.exchange,  MarketLot,   
	BrokApplied = BfoBrokView.MultiPlier*(  case      
	when ( BfoBrokView.SettFlag = 1 and broktable.val_perc ='V' and BfoBrokView.sell_buy = 1)    
	Then     
		((floor(( broktable.Normal* power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    	
	when ( BfoBrokView.SettFlag = 1 and broktable.val_perc ='V' and BfoBrokView.sell_buy = 2)    
	Then     
		((floor(( broktable.Normal  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    	
	when ( BfoBrokView.SettFlag = 1 and broktable.val_perc ='P' and BfoBrokView.sell_buy = 1)    
	Then      
		((floor ( (((broktable.Normal /100 ) * (BfoBrokView.MPrice))  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /     	
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))    	
	when ( BfoBrokView.SettFlag = 1 and broktable.val_perc ='P' and BfoBrokView.sell_buy = 2)    
	Then     
		((floor(( ((broktable.Normal /100 )* (BfoBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when (BfoBrokView.SettFlag = 2  and broktable.val_perc ='V' )     
	Then     
		((floor(( ((broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when (BfoBrokView.SettFlag = 2  and broktable.val_perc ='P' )     
	Then     
		((floor(( ((broktable.day_puc/100) * (BfoBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when (BfoBrokView.SettFlag = 3  and broktable.val_perc ='V' )    
	Then     
		((floor(( Broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when (BfoBrokView.SettFlag = 3  and broktable.val_perc ='P' )    
	Then    
		((floor(( ((Broktable.day_sales/ 100) * (BfoBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( BfoBrokView.SettFlag = 4  and broktable.val_perc ='V' )    
	Then     
		((floor(( Broktable.Sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( BfoBrokView.SettFlag = 4  and broktable.val_perc ='P' )    
	Then     
		((floor(( ((Broktable.Sett_purch/100) * (BfoBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( BfoBrokView.SettFlag = 5  and broktable.val_perc ='V' )    
	Then     
		((floor(( Broktable.Sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	when ( BfoBrokView.SettFlag = 5  and broktable.val_perc ='P' )    
	Then     
		((floor(( ((Broktable.Sett_sales/100) * (BfoBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /      
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /     
		power(10,broktable.round_to))    
	Else  0     
	End     
	) ,    
	Ins_chrg  = ((floor(( ((Bfotaxes.insurance_chrg * (BfoBrokView.marketrate) * BfoBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    
		power(10,broktable.round_to)),    
	turn_tax  =  ((floor(( ((bfotaxes.turnover_tax * (BfoBrokView.marketrate) * BfoBrokView.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    
		power(10,broktable.round_to)),    
	other_chrg = ((floor(( ((Bfotaxes.other_chrg * (BfoBrokView.marketrate) * BfoBrokView.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /      
		power(10,broktable.round_to)),    
	sebi_tax =     ((floor(( ((Bfotaxes.sebiturn_tax *(BfoBrokView.marketrate) * BfoBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    
		power(10,broktable.round_to)),    
	Broker_chrg =  ((floor(( ((Bfotaxes.broker_note * (BfoBrokView.marketrate) * BfoBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
		 (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    
		power(10,broktable.round_to))    
	
	FROM BrokTable broktable,
	(
	SELECT      
		F.Trade_no,F.product_code,F.product_type,F.party_code,F.series_code,F.series_id,s2.expirydate,F.user_id,    
		F.sell_buy,F.tradeqty,F.marketrate,F.Cl_type,F.OppMemCode,F.OppTraderCode,F.Trans_Type,s2.strikeprice,
		F.Sauda_Date,F.Order_Date,F.Order_No,F.settflag,F.groupid,F.tradercode,Std_Rate,brok1_tableno,
		Brok_Scheme,Tran_Cat,Off_phone1,      
		MPrice = (CASE WHEN C2.Dummy1 = 0     
			THEN MarketRate     
				Else    
				(Case When C2.Dummy1 = 1     
				Then (Case When s2.StrikePrice = 0 Then F.Marketrate Else s2.StrikePrice End )        
				Else s2.Strikeprice + MarketRate    
				END)    
			END),    
		MultiPlier,MarketLot
	from
		bfotrade F, Client2 C2,BFoScrip2 S2,Client1 C1    
	where
		c2.Party_Code = F.Party_Code     
		and C1.Cl_Code = C2.Cl_Code    
		and F.Product_type = S2.Product_type    
		and F.Product_code=s2.product_code    
		AND F.series_code = S2.series_code    
		AND F.series_id = S2.series_id )
	BfoBrokView,bfotaxes,bfoglobals,
	(select t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,  
	pqty = sum(case when sell_buy=1 then TradeQty else 0 End),
	Sqty =sum(case when sell_buy=2 then TradeQty else 0 End),
	strikeprice=isnull((select distinct bs.StrikePrice from bfoscrip2 bs where bs.product_code=t1.product_code and 
	bs.product_type=t1.product_type and bs.series_code=t1.series_code and bs.series_id=t1.series_id) ,0) ,  
	PRate=(Case When SUM(Case When Sell_buy = 1 Then TradeQty Else 0 End) > 0
	       Then SUM(Case When Sell_buy = 1 Then TradeQty*MarketRate Else 0 End) /
		    SUM(Case When Sell_buy = 1 Then TradeQty Else 0 End)
	       Else 0 End),  
	SRate=(Case When SUM(Case When Sell_buy = 2 Then TradeQty Else 0 End) > 0
	       Then SUM(Case When Sell_buy = 2 Then TradeQty*MarketRate Else 0 End) /
		    SUM(Case When Sell_buy = 2 Then TradeQty Else 0 End)
	       Else 0 End)  
	from bfotrade t1  
	GROUP BY   
	t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id
	) S    
	WHERE     
		BfoBrokView.party_code = s.party_code and    
		BfoBrokView.product_type=S.Product_type and      
		BfoBrokView.product_code=S.product_code and    
		BfoBrokView.series_code=S.Series_code and     
		BfoBrokView.series_id=S.series_id and    	
		Broktable.Table_no = BfoBrokView.brok1_tableno    
		And Broktable.Line_no =  (Select min(Broktable.line_no) from broktable where 
				Broktable.table_no = BfoBrokView.brok1_tableno     
				and s.Party_Code =  BfoBrokView.Party_code    
     				--And Trd_Del = 'D'        
                            	and BfoBrokView.mprice <= Broktable.upper_lim)    
	And BFOTAXES.exchange = 'BSE'     
	and BfoBrokView.Tran_cat = BFOTAXES.Trans_cat    
	and sauda_date between year_start_dt and year_end_dt

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCONFIRMVIEW
-- --------------------------------------------------
CREATE VIEW [DBO].[BFOCONFIRMVIEW] AS   
  
  
SELECT  
	BFOBROKVIEWFINAL.TRADE_NO,BFOBROKVIEWFINAL.PRODUCT_CODE,BFOBROKVIEWFINAL.PRODUCT_TYPE,BFOBROKVIEWFINAL.PARTY_CODE,BFOBROKVIEWFINAL.SERIES_CODE,BFOBROKVIEWFINAL.SERIES_ID,
	BFOBROKVIEWFINAL.EXPIRYDATE,BFOBROKVIEWFINAL.MULTIPLIER,BFOBROKVIEWFINAL.USER_ID,BFOBROKVIEWFINAL.TRADEQTY,BFOBROKVIEWFINAL.MARKETRATE,BFOBROKVIEWFINAL.CL_TYPE,
	BFOBROKVIEWFINAL.OPPMEMCODE,BFOBROKVIEWFINAL.OPPTRADERCODE,BFOBROKVIEWFINAL.TRANS_TYPE,BFOBROKVIEWFINAL.STRIKEPRICE,BFOBROKVIEWFINAL.SAUDA_DATE,BFOBROKVIEWFINAL.ORDER_DATE,
	BFOBROKVIEWFINAL.ORDER_NO,BFOBROKVIEWFINAL.GROUPID,BFOBROKVIEWFINAL.TRADERCODE,BFOBROKVIEWFINAL.TABLE_NO,BFOBROKVIEWFINAL.LINE_NO,BFOBROKVIEWFINAL.VAL_PERC,
	BFOBROKVIEWFINAL.NORMAL,BFOBROKVIEWFINAL.DAY_PUC,BFOBROKVIEWFINAL.DAY_SALES,BFOBROKVIEWFINAL.SETT_PURCH,BFOBROKVIEWFINAL.SETT_SALES, BFOBROKVIEWFINAL.SELL_BUY,
	BFOBROKVIEWFINAL.SETTFLAG,BROKAPPLIED,
	NETRATE = (CASE WHEN BFOBROKVIEWFINAL.SELL_BUY = 1   
				THEN BFOBROKVIEWFINAL.MARKETRATE + BROKAPPLIED   
				ELSE BFOBROKVIEWFINAL.MARKETRATE - BROKAPPLIED   
				END),    
	AMOUNT = BFOBROKVIEWFINAL.TRADEQTY * (CASE WHEN BFOBROKVIEWFINAL.SELL_BUY = 1   
			THEN ( BFOBROKVIEWFINAL.MARKETRATE + BROKAPPLIED )  
			ELSE ( BFOBROKVIEWFINAL.MARKETRATE - BROKAPPLIED )  
			END),     
	INSURANCE_CHRG=INS_CHRG,TURNOVER_TAX=TURN_TAX,SEBITURN_TAX=SEBI_TAX,BROKER_NOTE=BROKER_CHRG,SERTAX,YEAR,EXCHANGE,OFF_PHONE1,    
	SERVICE_TAX = ((FLOOR ( (BROKAPPLIED*TRADEQTY*MULTIPLIER*BFOBROKVIEWFINAL.SERVICE_TAX/100 * POWER(10,BFOBROKVIEWFINAL.ROUND_TO) +
			 BFOBROKVIEWFINAL.ROFIG + BFOBROKVIEWFINAL.ERRNUM  ) /  (BFOBROKVIEWFINAL.ROFIG + BFOBROKVIEWFINAL.NOZERO)) * (BFOBROKVIEWFINAL.ROFIG + 
			BFOBROKVIEWFINAL.NOZERO) )  / POWER(10,BFOBROKVIEWFINAL.ROUND_TO)),  
	TRADE_AMOUNT = BFOBROKVIEWFINAL.TRADEQTY * BFOBROKVIEWFINAL.MARKETRATE,  
        BFOBROKVIEWFINAL.INS_CHRG,BFOBROKVIEWFINAL.TURN_TAX,BFOBROKVIEWFINAL.OTHER_CHRG,
	BFOBROKVIEWFINAL.SEBI_TAX,BFOBROKVIEWFINAL.BROKER_CHRG ,MARKETLOT
        FROM BFOBROKVIEWFINAL

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCONFIRMVIEW_EXPIRY
-- --------------------------------------------------
CREATE  VIEW [DBO].[BFOCONFIRMVIEW_EXPIRY] AS   
  
  
SELECT  
	BFOBROKVIEWFINAL_EXPIRY.TRADE_NO,BFOBROKVIEWFINAL_EXPIRY.PRODUCT_CODE,BFOBROKVIEWFINAL_EXPIRY.PRODUCT_TYPE,BFOBROKVIEWFINAL_EXPIRY.PARTY_CODE,BFOBROKVIEWFINAL_EXPIRY.SERIES_CODE,BFOBROKVIEWFINAL_EXPIRY.SERIES_ID,
	BFOBROKVIEWFINAL_EXPIRY.EXPIRYDATE,BFOBROKVIEWFINAL_EXPIRY.MULTIPLIER,BFOBROKVIEWFINAL_EXPIRY.USER_ID,BFOBROKVIEWFINAL_EXPIRY.TRADEQTY,BFOBROKVIEWFINAL_EXPIRY.MARKETRATE,BFOBROKVIEWFINAL_EXPIRY.CL_TYPE,
	BFOBROKVIEWFINAL_EXPIRY.OPPMEMCODE,BFOBROKVIEWFINAL_EXPIRY.OPPTRADERCODE,BFOBROKVIEWFINAL_EXPIRY.TRANS_TYPE,BFOBROKVIEWFINAL_EXPIRY.STRIKEPRICE,BFOBROKVIEWFINAL_EXPIRY.SAUDA_DATE,BFOBROKVIEWFINAL_EXPIRY.ORDER_DATE,
	BFOBROKVIEWFINAL_EXPIRY.ORDER_NO,BFOBROKVIEWFINAL_EXPIRY.GROUPID,BFOBROKVIEWFINAL_EXPIRY.TRADERCODE,BFOBROKVIEWFINAL_EXPIRY.TABLE_NO,BFOBROKVIEWFINAL_EXPIRY.LINE_NO,BFOBROKVIEWFINAL_EXPIRY.VAL_PERC,
	BFOBROKVIEWFINAL_EXPIRY.NORMAL,BFOBROKVIEWFINAL_EXPIRY.DAY_PUC,BFOBROKVIEWFINAL_EXPIRY.DAY_SALES,BFOBROKVIEWFINAL_EXPIRY.SETT_PURCH,BFOBROKVIEWFINAL_EXPIRY.SETT_SALES, BFOBROKVIEWFINAL_EXPIRY.SELL_BUY,
	BFOBROKVIEWFINAL_EXPIRY.SETTFLAG,BROKAPPLIED,
	NETRATE = (CASE WHEN BFOBROKVIEWFINAL_EXPIRY.SELL_BUY = 1   
				THEN BFOBROKVIEWFINAL_EXPIRY.MARKETRATE + BROKAPPLIED   
				ELSE BFOBROKVIEWFINAL_EXPIRY.MARKETRATE - BROKAPPLIED   
				END),    
	AMOUNT = BFOBROKVIEWFINAL_EXPIRY.TRADEQTY * (CASE WHEN BFOBROKVIEWFINAL_EXPIRY.SELL_BUY = 1   
			THEN ( BFOBROKVIEWFINAL_EXPIRY.MARKETRATE + BROKAPPLIED )  
			ELSE ( BFOBROKVIEWFINAL_EXPIRY.MARKETRATE - BROKAPPLIED )  
			END),     
	INSURANCE_CHRG=INS_CHRG,TURNOVER_TAX=TURN_TAX,SEBITURN_TAX=SEBI_TAX,BROKER_NOTE=BROKER_CHRG,SERTAX,YEAR,EXCHANGE,OFF_PHONE1,    
	SERVICE_TAX = ((FLOOR ( (BROKAPPLIED*TRADEQTY*MULTIPLIER*BFOBROKVIEWFINAL_EXPIRY.SERVICE_TAX/100 * POWER(10,BFOBROKVIEWFINAL_EXPIRY.ROUND_TO) +
			 BFOBROKVIEWFINAL_EXPIRY.ROFIG + BFOBROKVIEWFINAL_EXPIRY.ERRNUM  ) /  (BFOBROKVIEWFINAL_EXPIRY.ROFIG + BFOBROKVIEWFINAL_EXPIRY.NOZERO)) * (BFOBROKVIEWFINAL_EXPIRY.ROFIG + 
			BFOBROKVIEWFINAL_EXPIRY.NOZERO) )  / POWER(10,BFOBROKVIEWFINAL_EXPIRY.ROUND_TO)),  
	TRADE_AMOUNT = BFOBROKVIEWFINAL_EXPIRY.TRADEQTY * BFOBROKVIEWFINAL_EXPIRY.MARKETRATE,  
        BFOBROKVIEWFINAL_EXPIRY.INS_CHRG,BFOBROKVIEWFINAL_EXPIRY.TURN_TAX,BFOBROKVIEWFINAL_EXPIRY.OTHER_CHRG,
	BFOBROKVIEWFINAL_EXPIRY.SEBI_TAX,BFOBROKVIEWFINAL_EXPIRY.BROKER_CHRG ,MARKETLOT,
	AUCTIONPART = CASE WHEN RIGHT(PRODUCT_CODE,3) ='OPT' THEN 'CA' ELSE 'EA' END
        FROM BFOBROKVIEWFINAL_EXPIRY

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCursorContSale
-- --------------------------------------------------

/****** Object:  View dbo.BFOCursorContSale    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOCursorContSale    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOCursorContSale    Script Date: 09/25/2001 6:04:22 AM ******/
CREATE view [dbo].[BFOCursorContSale]
As
select t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.series_id,t1.product_code,t1.sell_buy,t1.tradeqty,sauda_date = Left(Convert(varchar,sauda_date,109),11), /*  t1.price,  */    
pqty = isnull((select sum(tradeqty) from bfosettlement where 
		bfosettlement.party_code = t1.party_code and
                bfosettlement.product_type=t1.product_type and 
                bfosettlement.series_code=t1.series_code and 
                bfosettlement.expirydate=t1.expirydate  and
                bfosettlement.series_id=t1.series_id and  
                bfosettlement.product_code=t1.product_code 
		and Left(Convert(varchar,sauda_date,109),11) = Left(Convert(varchar,t1.sauda_date,109),11)
                and bfosettlement.sell_buy = 1
		),0),
Sqty =isnull( (select sum(tradeqty) from bfosettlement where 
                bfosettlement.party_code = t1.party_code and
                bfosettlement.product_type=t1.product_type and
		bfosettlement.series_code=t1.series_code and
		bfosettlement.expirydate=t1.expirydate and
                bfosettlement.series_id=t1.series_id and 
                bfosettlement.product_code=t1.product_code 
		and Left(Convert(varchar,sauda_date,109),11) = Left(Convert(varchar,t1.sauda_date,109),11)
                and bfosettlement.sell_buy = 2
		),0)
from bfosettlement t1, Client2  where  tradeqty > 0  
and t1.PARTY_CODE = CLIENT2.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.BFOCursorContUnEqualSalePur
-- --------------------------------------------------

/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOCursorContUnEqualSalePur    Script Date: 09/25/2001 6:04:22 AM ******/
CREATE view [dbo].[BFOCursorContUnEqualSalePur] as 
select s1.party_code,s1.product_type,s1.series_code,s1.expirydate,s1.series_id,s1.product_code,sauda_date,
isnull(s1.pqty,0) pqty,isnull(s1.sqty,0) sqty 
from BFOCursorContSale s1 
group by Sauda_date,s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.expirydate,Sqty,Pqty

GO

-- --------------------------------------------------
-- VIEW dbo.bfoexallocconfirmview
-- --------------------------------------------------


CREATE view [dbo].[bfoexallocconfirmview] as
	SELECT  BFoBrokView_exallocFinal.Trade_no,BFoBrokView_exallocFinal.product_code,BFoBrokView_exallocFinal.product_type,BFoBrokView_exallocFinal.party_code,
	BFoBrokView_exallocFinal.series_code,BFoBrokView_exallocFinal.series_id,BFoBrokView_exallocFinal.expirydate,BFoBrokView_exallocFinal.multiplier,BFoBrokView_exallocFinal.user_id,
	BFoBrokView_exallocFinal.tradeqty,BFoBrokView_exallocFinal.marketrate,BFoBrokView_exallocFinal.Cl_type,BFoBrokView_exallocFinal.OppMemCode,
	BFoBrokView_exallocFinal.OppTraderCode,BFoBrokView_exallocFinal.Trans_Type,BFoBrokView_exallocFinal.strikeprice,BFoBrokView_exallocFinal.Sauda_Date,BFoBrokView_exallocFinal.Order_Date,
	BFoBrokView_exallocFinal.Order_No,BFoBrokView_exallocFinal.groupid,BFoBrokView_exallocFinal.tradercode,  
	BFoBrokView_exallocFinal.Table_No,BFoBrokView_exallocFinal.Line_No,BFoBrokView_exallocFinal.Val_perc,BFoBrokView_exallocFinal.Normal,BFoBrokView_exallocFinal.Day_puc,
	BFoBrokView_exallocFinal.day_sales,BFoBrokView_exallocFinal.Sett_purch,BFoBrokView_exallocFinal.Sett_sales, BFoBrokView_exallocFinal.sell_buy,BFoBrokView_exallocFinal.settflag,	
	BrokApplied ,NetRate = (Case when BFoBrokView_exallocFinal.sell_buy = 1 
		                    Then BFoBrokView_exallocFinal.marketrate + BrokApplied 
				    Else BFoBrokView_exallocFinal.marketrate - BrokApplied 
			       End), 	
	Amount = BFoBrokView_exallocFinal.Tradeqty * (Case when BFoBrokView_exallocFinal.sell_buy = 1 
		      				 Then ( BFoBrokView_exallocFinal.marketrate + BrokApplied )
	   	      				 Else ( BFoBrokView_exallocFinal.marketrate - BrokApplied )
		 			    End),  	
	Insurance_chrg,turnover_tax,sebiturn_tax,broker_note,SerTax,year,exchange,off_phone1,	 
	Service_tax = ((floor ( (Brokapplied*TradeQty*Multiplier*BFoBrokView_exallocFinal.Service_Tax/100 * power(10,BFoBrokView_exallocFinal.round_to) + BFoBrokView_exallocFinal.roFig + BFoBrokView_exallocFinal.errnum  ) /  (BFoBrokView_exallocFinal.RoFig + BFoBrokView_exallocFinal.Nozero)) * (BFoBrokView_exallocFinal.RoFig + BFoBrokView_exallocFinal.Nozero) )  / power(10,BFoBrokView_exallocFinal.round_to)),
	Trade_amount = BFoBrokView_exallocFinal.Tradeqty * BFoBrokView_exallocFinal.marketrate,
	BFoBrokView_exallocFinal.Ins_chrg,BFoBrokView_exallocFinal.turn_tax,BFoBrokView_exallocFinal.other_chrg,BFoBrokView_exallocFinal.sebi_tax,BFoBrokView_exallocFinal.Broker_chrg,
	sec_name = bfobrokview_exallocfinal.sec_name,cl_rate = bfobrokview_exallocfinal.cl_rate,callput,pro_cli,o_c_flag,c_u_flag,
	markettype,price = marketrate,auctionpart,participantcode,oldpartycode as branch_id,MarketLot
	FROM BFoBrokView_exallocFinal

GO

-- --------------------------------------------------
-- VIEW dbo.bfoexallocsalepur
-- --------------------------------------------------

CREATE view [dbo].[bfoexallocsalepur]
as
select  t1.bfoeatrd_party_code,t1.bfoeatrd_Product_type,t1.bfoeatrd_Product_Code,t1.bfoeatrd_Series_Code,t1.bfoeatrd_Series_ID,t1.bfoeatrd_expirydate,t1.bfoeatrd_strike_price ,t1.bfoeatrd_CallPut,
        t1.bfoeatrd_sell_buy, t1.bfoeatrd_tradeqty ,
      bfoeatrd_pqty = isnull((select sum(bfoeatrd_tradeqty) from bfoexalloctrade where 
                bfoexalloctrade.bfoeatrd_party_code = t1.bfoeatrd_party_code and
                bfoexalloctrade.bfoeatrd_Product_Type=t1.bfoeatrd_Product_Type and 
                bfoexalloctrade.bfoeatrd_Product_Code=t1.bfoeatrd_Product_Code and 
                bfoexalloctrade.bfoeatrd_Series_Code=t1.bfoeatrd_Series_Code and 
                bfoexalloctrade.bfoeatrd_Series_ID=t1.bfoeatrd_Series_ID and                 
                bfoexalloctrade.bfoeatrd_expirydate=t1.bfoeatrd_expirydate  and
                bfoexalloctrade.bfoeatrd_strike_price=t1.bfoeatrd_strike_price and  
                bfoexalloctrade.bfoeatrd_Series_Code = t1.bfoeatrd_series_Code  and 
                bfoexalloctrade.bfoeatrd_Series_ID = t1.bfoeatrd_series_ID  and
                bfoexalloctrade.bfoeatrd_Sec_name = t1.bfoeatrd_sec_name  and
                bfoexalloctrade.bfoeatrd_CallPut =t1.bfoeatrd_CallPut 
                and bfoexalloctrade.bfoeatrd_sell_buy = 1),0),
      bfoeatrd_Sqty =isnull( (select sum(bfoeatrd_tradeqty) from bfoexalloctrade where 
                bfoexalloctrade.bfoeatrd_party_code = t1.bfoeatrd_party_code and
                bfoexalloctrade.bfoeatrd_Product_Type=t1.bfoeatrd_Product_Type and
          bfoexalloctrade.bfoeatrd_Product_Code=t1.bfoeatrd_Product_Code and
         bfoexalloctrade.bfoeatrd_Series_Code = t1.bfoeatrd_series_Code  and
                bfoexalloctrade.bfoeatrd_Series_ID = t1.bfoeatrd_series_ID  and
                bfoexalloctrade.bfoeatrd_expirydate=t1.bfoeatrd_expirydate and
                bfoexalloctrade.bfoeatrd_strike_price=t1.bfoeatrd_strike_price and
                bfoexalloctrade.bfoeatrd_Sec_name = t1.bfoeatrd_sec_name  and
                bfoexalloctrade.bfoeatrd_CallPut=t1.bfoeatrd_CallPut
                and bfoexalloctrade.bfoeatrd_sell_buy = 2),0)
from bfoexalloctrade t1

GO

-- --------------------------------------------------
-- VIEW dbo.BFoNetPosView
-- --------------------------------------------------

/****** Object:  View dbo.BFoNetPosView    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoNetPosView    Script Date: 29-Sep-01 8:30:23 PM ******/
/* Created By Sandeep On 20 Aug 2001 used in BFoNetPosPartywiseSp*/
CREATE view [dbo].[BFoNetPosView] as
select s.party_code,s.product_type,s.product_code,s.series_code,s.series_id,s.sauda_date,s.expirydate,
pqty = ( case when sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(s.tradeqty) else 0 end ),netrate
from bfosettlement s, bfoscrip2 s1  
where s1.product_Type = s.product_type 
      and s.product_code = s1.product_code 
      and s.series_code = s1.series_code
      and s.series_id = s1.series_id 
      and s.expirydate = s1.expirydate
group by s.party_code,s.product_type,s.product_code,s.series_code,s.series_id,s.expirydate,s.sauda_date,s.sell_buy,s.netrate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOSALEPUR
-- --------------------------------------------------

/****** Object:  View dbo.BFOSALEPUR    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 8/7/01 8:35:38 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 5/24/01 4:09:46 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/28/01 7:40:15 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/21/01 1:26:01 PM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 21-Mar-01 12:07:04 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 3/15/01 10:04:32 AM ******/
/****** Object:  View dbo.BFOSALEPUR    Script Date: 22-Feb-01 10:10:18 PM ******/
CREATE view [dbo].[BFOSALEPUR] AS
select t1.trade_no,t1.party_code,t1.Series_code,t1.sell_buy,t1.tradeqty,t1.settflag 
from bfotrade t1,client2 c1,bfoscrip2 s2 where
     ( (t1.sell_buy = 1 ) and
         (t1.party_code in ( select t2.party_code from bfotrade t2
                           where
                              (t1.series_code = t2.series_code) 
                              and (t2.sell_buy = 2) 
                            )
          )
       )
       Or
       ((t1.sell_buy = 2 ) and
         (t1.party_code in ( select t2.party_code from bfotrade t2
                           where
                                   (t1.series_code = t2.series_code) 
                                and (t2.sell_buy = 1) 
                            )
         )
        )
 and t1.party_code = c1.party_code  
group by t1.party_code,t1.series_code,t1.sell_buy,t1.tradeqty,t1.Trade_no,t1.settflag

GO

-- --------------------------------------------------
-- VIEW dbo.BFOsalepur1
-- --------------------------------------------------

CREATE view [dbo].[BFOsalepur1] AS
select t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy,
      pqty = isnull((select sum(tradeqty) from bfotrade where 
                bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
                and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 1),0),
      Sqty =isnull( (select sum(tradeqty) from bfotrade where 
   
              bfotrade.party_code = t1.party_code
                and bfotrade.series_code = t1.series_code
               and bfotrade.product_code=t1.product_code
               and bfotrade.product_type=t1.product_type
                and bfotrade.series_id=t1.series_id
                and bfotrade.sell_buy = 2),0),
strikeprice=isnull((select distinct bs.StrikePrice from bfoscrip2 bs where bs.product_code=t1.product_code and bs.product_type=t1.product_type and bs.series_code=t1.series_code and bs.series_id=t1.series_id) ,0) ,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from bfotrade t1
GROUP BY 
t1.party_code,t1.product_type,t1.product_code,t1.series_code,t1.series_id,t1.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.bfosettbfview
-- --------------------------------------------------

CREATE view [dbo].[bfosettbfview] as
select Party_Code,s.product_code,s.product_type,s.series_id,s.series_code,s.expirydate,
Pqty=(Case When sell_buy = 1 then sum(tradeqty*s.multiplier) else 0 end),
Sqty=(Case When sell_buy = 2 then sum(tradeqty*s.multiplier) else 0 end),
sauda_date 
from bfosettlement s
where right(ltrim(rtrim(s.product_type)),1) not like 'O%'
group by Party_Code,s.product_code,s.product_type,s.series_id,s.series_code,s.expirydate,
sell_buy,expirydate,sauda_date

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSale
-- --------------------------------------------------


CREATE view [dbo].[BFoSettSale] As 
select t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.sell_buy,
PQty = (Case When Sell_buy = 1 Then sum(tradeqty) else 0 end ),
SQty = (Case When Sell_buy = 2 Then sum(tradeqty) else 0 end ),
SDate = Left(Convert(Varchar,sauda_date,109),11),product_code,series_id,
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
Strike_Price
from BfoSettlement t1 
GROUP BY t1.party_code,t1.product_type,t1.series_code,t1.expirydate,t1.sell_buy,Left(Convert(Varchar,sauda_date,109),11)
,product_code,series_id,Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSaleexpiry
-- --------------------------------------------------

/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/7/01 8:35:38 PM ******/
/****** Object:  View dbo.BFoSettSaleexpiry    Script Date: 8/7/01 5:47:28 PM ******/
CREATE view [dbo].[BFoSettSaleexpiry] As 
select t1.party_code,t1.series_code,t1.sell_buy,
PQty = (Case When Sell_buy = 1 Then sum(tradeqty) else 0 end ),
SQty = (Case When Sell_buy = 2 Then sum(tradeqty) else 0 end ),
SDate = Left(Convert(Varchar,sauda_date,109),11),
PRate =(Case When Sell_buy = 1 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end ),
SRate =(Case When Sell_buy = 2 Then sum(MarketRate*tradeqty)/(case when sum(tradeqty) > 0 then Sum(TradeQty) else 1 end )  else 0 end )
from Bfofuttrade t1 
GROUP BY  t1.party_code,t1.series_code,t1.sell_buy,Left(Convert(Varchar,sauda_date,109),11)

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSalePur
-- --------------------------------------------------

/****** Object:  View dbo.BFoSettSalePur    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 29-Sep-01 8:30:23 PM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BFoSettSalePur    Script Date: 8/7/01 8:35:38 PM ******/
CREATE view [dbo].[BFoSettSalePur] As 
select t1.party_code,t1.series_code,
PQty = Sum(Pqty),SQty = Sum(Sqty),SDate,PRATE=SUM(PRATE),SRATE=SUM(SRATE)
from BFoSettSale t1 GROUP BY t1.party_code,t1.series_code,SDate

GO

-- --------------------------------------------------
-- VIEW dbo.BFoSettSalePur1
-- --------------------------------------------------

CREATE view [dbo].[BFoSettSalePur1] As
SELECT party_code,product_type,product_code,expirydate,PQty=SUM(PQty),SQty=Sum(SQty),SDate,Series_code,series_id,strike_price
FROM BFoSettSale
group by party_code,product_type,product_code,expirydate,SDate,Series_code,series_id,strike_price

GO

-- --------------------------------------------------
-- VIEW dbo.BfosettsalepurSum
-- --------------------------------------------------

/****** Object:  View dbo.BfosettsalepurSum    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 29-Sep-01 8:30:24 PM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 8/28/01 10:03:15 AM ******/
/****** Object:  View dbo.BfosettsalepurSum    Script Date: 8/7/01 8:35:38 PM ******/
CREATE view [dbo].[BfosettsalepurSum] as
select  t1.party_code,t1.series_code,
      pqty=sum(pqty),
      sqty=sum(sqty),sdate,
       PRATE=SUM(PRATE),
      SRATE=SUM(SRATE)
    
from Bfosettsalepur t1
GROUP BY
t1.party_code,t1.series_code,t1.sdate

GO

-- --------------------------------------------------
-- VIEW dbo.BFOSETTVIEW
-- --------------------------------------------------

/****** Object:  View dbo.BFOSETTVIEW    Script Date: 01/04/1980 1:04:25 AM ******/
/****** Object:  View dbo.BFOSETTVIEW    Script Date: 29-Sep-01 8:30:24 PM ******/
/****** Object:  View dbo.BFOSETTVIEW    Script Date: 09/25/2001 6:04:21 AM ******/
CREATE view [dbo].[BFOSETTVIEW] AS
SELECT distinct  ContractNo,BillNo,F.Trade_no,F.Product_code,F.Product_type,F.Party_code,F.Series_code,F.Series_id,s2.Expirydate,F.user_id,
Tradeqty,AuctionPart,MarketType,Series,Order_no,MarketRate,strike_price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,
Sett_purch,Sett_sales,F.sell_buy,F.SettFlag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,
sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,F.Cl_type,F.Order_Date, F.OppMemCode,F.OppTraderCode,F.Cl_rate,F.groupid,F.tradercode,
MPrice = (CASE WHEN C2.Dummy1 = 0 
               THEN MarketRate 
               Else
		    (Case When C2.Dummy1 = 1 
    		          Then (Case When s2.StrikePrice = 0 Then F.Marketrate Else s2.StrikePrice End )    
                  	  Else s2.Strikeprice + MarketRate
      		    END)
   	  END),
MultiPlier = ( Case When ( c2.Brok_Scheme = 4 or c2.Brok_Scheme = 5 or c2.Brok_Scheme = 6 or c2.Brok_scheme=1 or c2.Brok_Scheme=2 or c2.Brok_Scheme=3) 
  		    Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),s2.marketLot)) 
  		    Else  1
       	      End) ,
TaxPrice = (CASE WHEN TaxesFlag = 0 
	       THEN marketrate 
	       Else
		   (Case When TaxesFlag = 1 
			 Then (Case When F.Strike_Price = 0 Then F.marketrate Else F.Strike_Price End ) 				
	                		 Else F.marketrate + marketrate
		    END)
	  END) 
from BFosettlement F, Client2 C2,BFoScrip2 S2,Client1 C1,BFOOwner
where c2.Party_Code = F.Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.Product_type = S2.Product_type
and F.Product_code=s2.product_code
AND F.series_code = S2.series_code
AND F.series_id = S2.series_id

GO

-- --------------------------------------------------
-- VIEW dbo.Bfounequalsalepur1
-- --------------------------------------------------

CREATE view Bfounequalsalepur1 as   
select  s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.sell_buy,  
              isnull(s1.pqty,0) pqty,isnull(s1.sqty,0) sqty   
 from BFOASALEPUR2 s1,client2 client2  
 where  isnull(s1.pqty,0) <> isnull(s1.sqty,0)  
          and client2.party_code = s1.party_code  
GROUP BY s1.party_code,s1.product_type,s1.product_code,s1.series_code,s1.series_id,s1.sell_buy,s1.pqty,s1.sqty

GO

-- --------------------------------------------------
-- VIEW dbo.bOptionExAllocView
-- --------------------------------------------------

CREATE view [dbo].[bOptionExAllocView]
as 
select s.party_code,s.Product_type,s.Product_Code,s.Series_Code,s.Series_ID,s.strike_price,s.MarketType,s.expirydate,
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty*s.multiplier) else 0 end ),
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty*s.multiplier) else 0 end ),
Nsertax = ( case when s.billflag>3 then sum(s.nsertax) else 0 end ),
nbrokapp = ( case when s.billflag > 3 then sum(s.nbrokapp*s.tradeqty) else 0 end ),s.billflag,
cl_rate = isnull(( select bfofinalclosing.cl_rate from bfofinalclosing
                         where bfofinalclosing.closingdate like s.expirydate
                           and bfoscrip2.maturitydate like bfofinalclosing.closingdate
                                        and bfofinalclosing.Series_Code=s.Series_Code   
           ),0)
from bfosettlement s, bfoscrip2
where right(s.Product_type,3) = 'IO'
and right(bfoscrip2.Product_type,3) = 'IO'
and bfoscrip2.Product_Code = s.Product_Code
and bfoscrip2.Product_type = s.Product_type
and bfoscrip2.Series_Code = s.Series_Code
and bfoscrip2.Series_ID = s.Series_ID
and bfoscrip2.strikeprice = s.strike_price
and bfoscrip2.expirydate = s.expirydate
group by s.party_code,s.Product_type,s.Product_Code,s.Series_Code,s.Series_ID,s.strike_price,s.MarketType,s.expirydate,s.sell_buy,s.billflag,bfoscrip2.maturitydate,s.multiplier

GO

-- --------------------------------------------------
-- VIEW dbo.broktablevalues
-- --------------------------------------------------

/****** Object:  View dbo.broktablevalues    Script Date: 10/15/2001 12:29:58 PM ******/


create view [dbo].[broktablevalues]
as 
select distinct day_puc as brok from broktable

union all
select distinct day_sales as brok from broktable

union all
select distinct sett_purch as brok from broktable

union all
select distinct sett_sales as brok from broktable

union all
select distinct normal as brok from broktable

GO

-- --------------------------------------------------
-- VIEW dbo.Fragmentaion_details
-- --------------------------------------------------
create view Fragmentaion_details
as 

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MParty
-- --------------------------------------------------

CREATE  View Rpt_View_NewM2MParty AS     
Select bfoea_position_date=Sauda_date,bfoea_party_code=BFoBillValan.Party_Code,    
bfoea_NetPremium=0,  
bfoea_Daily_MTM_Settlement_Value=Premium,    
bfoea_Futures_Final_Settlement_Value=mtm_margin,  
bfoea_Exercised_Assigned_Value=0   
From BFoBillValan,
(
	Select File_Date,Party_Code,mtm_margin=sum(mtm_margin),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll
where 
File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
and bfomargincoll.Party_Code = BFoBillValan.Party_Code

Group By Sauda_Date,BFoBillValan.Party_Code,mtm_margin,Premium

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MScrip
-- --------------------------------------------------

CREATE  View Rpt_View_NewM2MScrip AS     
Select bfoea_position_date=Sauda_Date,bfoea_series_code=Series_Code,
bfoea_Product_code = Product_Code,bfoea_expirydate=ExpiryDate,
bfoea_strike_price=Strike_price,bfoea_product_type=Product_Type,
bfoea_NetPremium=Premium,
bfoea_Daily_MTM_Settlement_Value=mtm_margin,    
bfoea_Futures_Final_Settlement_Value=0 ,
bfoea_Exercised_Assigned_Value=0    

From BFoBillValan,
(
	Select File_Date,Party_Code,mtm_margin=sum(mtm_margin),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll

where 
File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
and bfomargincoll.Party_Code = BFoBillValan.Party_Code
Group By Product_code,Sauda_Date,Series_Code,ExpiryDate,Strike_Price,Product_Type,
Premium,mtm_margin

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MScripParty
-- --------------------------------------------------

CREATE  View Rpt_View_NewM2MScripParty AS     
Select bfoea_position_date=Sauda_Date,bfoea_series_code=Series_Code,
bfoea_party_code=BFoBillValan.Party_Code, 
bfoea_Product_code = Product_Code,bfoea_expirydate=ExpiryDate,
bfoea_strike_price=Strike_price,bfoea_product_type=Product_Type,
bfoea_NetPremium=Premium,  
bfoea_Daily_MTM_Settlement_Value=mtm_margin,    
bfoea_Futures_Final_Settlement_Value=0 ,
bfoea_Exercised_Assigned_Value=0    

From BFoBillValan,
(
	Select File_Date,Party_Code,mtm_margin=sum(mtm_margin),Premium=sum(Premium)
	From bfomargincoll Group By  File_Date,Party_Code
) bfomargincoll
 where 
File_Date like Left(Convert(VarChar, sauda_date, 109),11) + '%'   
and bfomargincoll.Party_Code = BFoBillValan.Party_Code
Group By BFoBillValan.Party_Code,Product_code,Sauda_Date,Series_Code,ExpiryDate,Strike_Price,
Product_Type,mtm_margin,Premium

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLASS_VW_ENTITYMASTER
-- --------------------------------------------------

CREATE VIEW [DBO].[V2_CLASS_VW_ENTITYMASTER]     
    
AS    
    
  SELECT ENT_CODE = 'BROKER',    
         ENT_NAME = 'BROKER',     
         ENT_TYPE = 'BROKER',     
         ORDER_BY = 1      
  FROM   OWNER  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = BRANCH_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'BRANCH' ,     
         ORDER_BY = 2      
  FROM   BRANCH   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SHORT_NAME,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'TRADER',     
         ORDER_BY = 4        
  FROM   BRANCHES   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SUB_BROKER,    
         ENT_NAME = [NAME],     
         ENT_TYPE = 'SUBBROKER',     
         ORDER_BY = 3        
  FROM   SUBBROKERS  (NOLOCK)   
  UNION ALL     
  SELECT DISTINCT ENT_CODE = AREACODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'AREA',     
         ORDER_BY = 7        
  FROM   AREA   (NOLOCK)  
  UNION ALL     
  SELECT DISTINCT ENT_CODE = REGIONCODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'REGION',     
         ORDER_BY = 8        
  FROM   REGION   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = CL_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'CLIENT',     
         ORDER_BY = 5        
  FROM   CLIENT1  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = FAMILY,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'FAMILY',     
         ORDER_BY = 6        
  FROM   CLIENT1  (NOLOCK)  
  WHERE  CL_CODE = FAMILY    
  UNION ALL     
    
  SELECT ENT_CODE = CL_TYPE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLTYPE',     
         ORDER_BY = 9        
  FROM   CLIENTTYPE   (NOLOCK)   
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'GROUP',     
         ORDER_BY = 10        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'GROUP'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'RELMGR',     
         ORDER_BY = 11        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'RELMGR'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'SBU',     
         ORDER_BY = 12        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'SBU'    
  UNION ALL     
  SELECT ENT_CODE = CL_STATUS,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLSTATUS',     
         ORDER_BY = 13        
  FROM  CLIENTSTATUS   (NOLOCK)

GO

