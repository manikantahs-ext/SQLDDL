-- DDL Export
-- Server: 10.253.33.94
-- Database: PRADNYA
-- Exported: 2026-02-05T02:40:27.422027

USE PRADNYA;
GO

-- --------------------------------------------------
-- FUNCTION dbo.CHECKZIPFILE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[CHECKZIPFILE]
(
	@FILENAME	VARCHAR(200)
) RETURNS INT
AS
BEGIN
	DECLARE @STATUS	INT
	SET @STATUS = 0 
	
	SET @STATUS = (CASE WHEN @FILENAME LIKE '%.ZIP' THEN 1 ELSE 0 END)

	IF @STATUS = 0
	BEGIN
		SET @STATUS = (CASE WHEN @FILENAME LIKE '%.GZ' THEN 1 ELSE 0 END)
	END
	RETURN @STATUS
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLASS_PWDENCRY
-- --------------------------------------------------
create Function [dbo].[CLASS_PWDENCRY](@PWD Varchar(20)) Returns Varchar(20) as
Begin
	DECLARE @retVal int
	DECLARE @retstr varchar(1000)
	DECLARE @comHandle INT
	DECLARE @errorSource VARCHAR(8000)
	DECLARE @errorDescription VARCHAR(8000)
	
	EXEC @retVal = master..sp_OACreate 'PradnyaPWDDllPrj.PradnyaPwdDll', @comHandle OUTPUT
	if @retVal <> 0 
	begin 
		EXEC master..sp_OAGetErrorInfo @comHandle, @errorSource OUTPUT, @errorDescription OUTPUT
		Return RTrim(LTrim(@errorDescription))
	end
	
	EXEC @retVal = master..sp_OAMethod @comHandle, 'Encrypt',@retstr output, @PWD
		OUTPUT
	
	exec master..sp_OADestroy @comHandle
	
	Return @retstr 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_CLASS_Auto_Process_Replace
-- --------------------------------------------------

CREATE FUNCTION [dbo].[fn_CLASS_Auto_Process_Replace]    
(    
 @PARAMETER  VARCHAR(500),     
 @BUSINESS_DATE DATETIME,     
 @MEMBERCODE  VARCHAR(10),    
 @SETT_NO  VARCHAR(7),    
 @SETT_TYPE  VARCHAR(2)    
) RETURNS VARCHAR(500)    
AS    
BEGIN   

 DECLARE @NEW_SETTNO VARCHAR(7)
 
 SELECT @NEW_SETTNO = SETT_NO FROM BSEDB_AB.DBO.SETT_MST
 WHERE START_DATE = @BUSINESS_DATE 
 
 SET @PARAMETER = REPLACE(@PARAMETER,'<MSETTNO3>', RIGHT(@NEW_SETTNO,3))    
 
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEFOLDER>', CONVERT(VARCHAR,@BUSINESS_DATE,112))    
  
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEYYYYMMDD>', CONVERT(VARCHAR,@BUSINESS_DATE,112))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE106NS>', REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,106),' ', ''))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEDDMM>', LEFT(REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,103),'/',''),4))    
    
     
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEMMYY>', RIGHT(REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,3),'/',''),4))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE103->', REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,103),'/','-'))    
  
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE103>', CONVERT(VARCHAR,@BUSINESS_DATE,103))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<MON-YEAR>', LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,109),3) + '-' + RIGHT(LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,109),11),4))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEDDMMYYYY>', REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,103),'/',''))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATEDDMMYY>', LEFT(REPLACE(CONVERT(VARCHAR,@BUSINESS_DATE,3),'/',''),6))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<MEMBERCODE>', @MEMBERCODE)    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE109>', '''' + LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,109),11) + '''')    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE109,>', '''' + LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,109),11) + ''',')     
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<DATE106MMM_YYYY>', '' + REPLACE(RIGHT(LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,106),11),8),' ', '_') + '')    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<SetNo>',@SETT_NO)    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<SetNo3>',RIGHT(@SETT_NO,3))    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<SettType>',@SETT_TYPE)    
    
 IF @SETT_TYPE = 'D'     
 BEGIN    
  SET @PARAMETER = REPLACE(@PARAMETER,'<SettTypeDR>','DR')    
 END    
    
 IF @SETT_TYPE = 'C'     
 BEGIN    
  SET @PARAMETER = REPLACE(@PARAMETER,'<SettTypeDR>','C')    
 END    
    
 IF @SETT_TYPE = 'C'     
 BEGIN    
  SET @PARAMETER = REPLACE(@PARAMETER,'<SettTypePC>','PC')    
 END    
    
 IF @SETT_TYPE = 'D'     
 BEGIN    
  SET @PARAMETER = REPLACE(@PARAMETER,'<SettTypePC>','P')    
 END    
    
 SET @PARAMETER = REPLACE(@PARAMETER,'<BUSINESS_DATE>',LEFT(CONVERT(VARCHAR,@BUSINESS_DATE,109),11))    
    
 RETURN @PARAMETER    
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_EXCHANGE_SEGMENTS
-- --------------------------------------------------


CREATE FUNCTION FN_EXCHANGE_SEGMENTS ()
RETURNS @EXCHANGE_SEGMENTS TABLE
(
	EXCHANGE_SEGMENTS VARCHAR(12),
	EXCHANGE VARCHAR(3),
	SEGMENT VARCHAR(7)
) AS
BEGIN
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSECM','NSE','CAPITAL')
	INSERT @EXCHANGE_SEGMENTS VALUES ('BSECM','BSE','CAPITAL')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSEFO','NSE','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('BSEFO','BSE','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NCDX','NCX','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('MCDX','MCX','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('DBCOMMON','ALL','COMMON')
	INSERT @EXCHANGE_SEGMENTS VALUES ('BSEFOPCM','BCM','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('BSESLBS','BSE','SLBS')
	INSERT @EXCHANGE_SEGMENTS VALUES ('BSECURFO','BSX','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('MCDXCDS','MCD','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('MCDXPCM','MCM','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSEFOPCM','NCM','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NMCE','NMC','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSESLBS','NSE','SLBS')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSECURFO','NSX','FUTURES')
	INSERT @EXCHANGE_SEGMENTS VALUES ('NSECURFOPCM','NXM','FUTURES')

	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnMax
-- --------------------------------------------------

Create  Function [dbo].[fnMax](@Value1 money, @Value2 Money ) 
Returns Money As
Begin
	Declare @Return Money
	if @Value1  > @Value2
		Begin
			Set @Return =  @Value1 
		End
	else
		Begin
			Set @Return =  @Value2
		End
	Return @Return

End

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnMin
-- --------------------------------------------------

Create  Function [dbo].[fnMin](@Value1 money, @Value2 Money ) 
Returns Money As
Begin
	Declare @Return Money
	if @Value1  < @Value2
		Begin
			Set @Return =  @Value1 
		End
	else
		Begin
			Set @Return =  @Value2
		End
	Return @Return

End

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnMinMax
-- --------------------------------------------------

CREATE Function [dbo].[fnMinMax](@Amt money, @MinAmt Money, @MaxAmt Money) 
Returns Money As
Begin
if @Amt > 0 
	begin	
		if @MinAmt > 0 
		Begin
			if @Amt < @MinAmt 
			Begin
				Set @Amt = @MinAmt
			End
			Begin
				Set @Amt = @Amt
			End
		End

		if @MaxAmt > -1 
		Begin
			if @Amt > @MaxAmt 
			Begin
				Set @Amt = @MaxAmt
			End
			Begin
				Set @Amt = @Amt
			End
		End
	End
	Return @Amt
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------


CREATE FUNCTION FUN_SPLITSTRING(
                @SPLITSTRING VARCHAR(1000),
                @DELIMITER   VARCHAR(3))
RETURNS @SPLITTED TABLE (
    [SNO] [INT] IDENTITY(1,1) NOT NULL, 
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)

AS

/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */
BEGIN   
  DECLARE  @STRING         VARCHAR(1000),
           @POSITION       INT,
           @START_LOCATION INT,
           @STRING_LENGTH  INT
                           
  SET @STRING = @SPLITSTRING
                
  SET @POSITION = 0
                  
  SET @START_LOCATION = 0
                        
  SET @STRING_LENGTH = LEN(@STRING)
                       
  WHILE @STRING_LENGTH > 0
    BEGIN
    
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)
                      
      IF @POSITION = 0
        BEGIN
          INSERT INTO @SPLITTED
          SELECT @STRING
                 
          SET @STRING_LENGTH = 0
                               
        END
      ELSE
        BEGIN
          INSERT INTO @SPLITTED
          SELECT LEFT(@STRING,@POSITION - 1)
                 
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)
                        
          SET @STRING_LENGTH = LEN(@STRING)
        END
        
    END

  RETURN 

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING_2NUM
-- --------------------------------------------------

   CREATE FUNCTION [dbo].[FUN_SPLITSTRING_2NUM](  
                @SPLITSTRING VARCHAR(8000),  
                @DELIMITER   VARCHAR(3))  
RETURNS  INT  
AS  
  
BEGIN     
  
  DECLARE @INTRETURN INT  
  DECLARE  @STRING         VARCHAR(8000),  
           @POSITION       INT,  
           @START_LOCATION INT,  
           @STRING_LENGTH  INT  
                             
  SET @STRING = @SPLITSTRING  
                  
  SET @POSITION = 0  
                    
  SET @START_LOCATION = 0  
  SET @INTRETURN = 0                      
  SET @STRING_LENGTH = LEN(@STRING)  
                         
  WHILE @STRING_LENGTH > 0  
    BEGIN  
      
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)  
                        
      IF @POSITION = 0  
        BEGIN  
          SET @INTRETURN = @INTRETURN +  CONVERT(INT,@STRING )                  
          SET @STRING_LENGTH = 0  
                                 
        END  
      ELSE  
        BEGIN  
          SET @INTRETURN = @INTRETURN + CONVERT(INT,LEFT(@STRING,@POSITION - 1))                 
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)  
                          
          SET @STRING_LENGTH = LEN(@STRING)  
        END  
          
    END  
  
  
   RETURN  @INTRETURN  
          
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.ReplaceTradeNo
-- --------------------------------------------------

CREATE FUNCTION [dbo].[ReplaceTradeNo]
(
  @Temp varchar(255)
)
RETURNS varchar(255)
AS
Begin

    Declare @KeepValues as varchar(50)
    Set @KeepValues = '%[^0-9]%'
    While PatIndex(@KeepValues, @Temp) > 0
        Set @Temp = Stuff(@Temp, PatIndex(@KeepValues, @Temp), 1, '')

    Return @Temp
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ReplaceTradeNo_BKP_05022020
-- --------------------------------------------------

CREATE Function [dbo].[ReplaceTradeNo_BKP_05022020](@TradeNo  Varchar(16)) 
Returns Varchar(16) As
Begin
declare @Flag Varchar(1)

	Select @Flag = '0'
	while @Flag <> '1'
	Begin
		Select @Flag = Left(Upper(@TradeNo),1)
		if @Flag >= 'A' And @Flag <= 'Z'
			Select @TradeNo = Replace(@TradeNo, @Flag, '')
		Else
			Select @Flag = '1'
	End
Return @TradeNo 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundedToThousand
-- --------------------------------------------------
CREATE Function [dbo].[RoundedToThousand](@Amt Numeric(18,4))
Returns Numeric(18,4)
As
Begin
if @Amt > 0
	select @Amt = ((convert(numeric(18,2),@Amt/10000) - Right(convert(numeric(18,2),@Amt/10000),3))+1)*10000
Else 
	select @Amt = @Amt
Return @Amt 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundedTurnover
-- --------------------------------------------------
CREATE  Function [dbo].[RoundedTurnover](@Amt Numeric(18,4), @roundingAmt Numeric(18,4))  
Returns Numeric(18,4)  
As  
Begin  

	 if @Amt > 0 AND @roundingAmt > 1   
	  Select @Amt = (Case When @Amt - Convert(BigInt,@Amt/@roundingAmt)*@roundingAmt = 0   
						  Then @Amt   
			Else (Convert(BigInt,@Amt/@roundingAmt)+1)*@roundingAmt   
			  End)  
	 Else   
	  select @Amt = @Amt  
	 
	Return @Amt  
  
  end

GO

-- --------------------------------------------------
-- INDEX dbo.MCX_C_WFIN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CLTCODE] ON [dbo].[MCX_C_WFIN] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.NCX_C_WFIN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CLTCODE] ON [dbo].[NCX_C_WFIN] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.NSE_DATA_FINAL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cltcode ] ON [dbo].[NSE_DATA_FINAL] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.QL_ADDR
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cl] ON [dbo].[QL_ADDR] ([CL_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_HOLDING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [party_code] ON [dbo].[TBL_HOLDING] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Margindata
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_partycode_updatedon] ON [dbo].[tbl_Margindata] ([Party_code], [updatedon])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_A_TEMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_tbl_sccsannexure_a_temp_party_code] ON [dbo].[TBL_SCCSANNEXURE_A_TEMP] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_B_TEMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [iX_party] ON [dbo].[TBL_SCCSANNEXURE_B_TEMP] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_B_TEMP_ORG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_tbl_sccsannexure_b_temp_party_code] ON [dbo].[TBL_SCCSANNEXURE_B_TEMP_ORG] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_C_TEMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_tbl_sccsannexure_c_temp_party_code] ON [dbo].[TBL_SCCSANNEXURE_C_TEMP] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_D_TEMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_tbl_sccsannexure_d_temp_party_code] ON [dbo].[TBL_SCCSANNEXURE_D_TEMP] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSANNEXURE_E_TEMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ix_party] ON [dbo].[TBL_SCCSANNEXURE_E_TEMP] ([PARTY_CODE], [SEGMENT])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSCLIENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Dt] ON [dbo].[TBL_SCCSCLIENT] ([SCCS_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_SCCSCLIENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_PARTY] ON [dbo].[TBL_SCCSCLIENT] ([SCCS_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLDEL_TRANSSTAT_QRLY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [DELHOLD] ON [dbo].[TBLDEL_TRANSSTAT_QRLY] ([Transdate], [Party_Code], [Scrip_Cd], [Holdername], [Drcr], [Bdptype], [Bdpid], [Bcltdpid])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLDEL_TRANSSTAT1_QRLY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXQRLYLEDGER] ON [dbo].[TBLDEL_TRANSSTAT1_QRLY] ([TRANSDATE1])

GO

-- --------------------------------------------------
-- INDEX dbo.tmp_Data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_partycode] ON [dbo].[tmp_Data] ([party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.TMP_QL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ECN] ON [dbo].[TMP_QL] ([ECN_FLAG], [CLIENTCODE]) INCLUDE ([L_ZIP])

GO

-- --------------------------------------------------
-- INDEX dbo.TMP_QL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PARTY] ON [dbo].[TMP_QL] ([CLIENTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TMP_QL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ZIP] ON [dbo].[TMP_QL] ([L_ZIP])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_QUARTERLYLEDGER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ClusteredIndex-20170323-110833] ON [dbo].[V2_CLASS_QUARTERLYLEDGER] ([CQL_PARTYCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_QUARTERLYLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_CLASS] ON [dbo].[V2_CLASS_QUARTERLYLEDGER] ([CQL_VDT]) INCLUDE ([CQL_SEGMENT])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_QUARTERLYSECLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTYCODE] ON [dbo].[V2_CLASS_QUARTERLYSECLEDGER] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_YEARLYLEDGER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ClusteredIndex-20170414-130614] ON [dbo].[V2_CLASS_YEARLYLEDGER] ([CQL_PARTYCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_YEARLYLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20170414-131433] ON [dbo].[V2_CLASS_YEARLYLEDGER] ([CQL_VDT]) INCLUDE ([CQL_SEGMENT])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLASS_YEARLYSECLEDGER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ClusteredIndex-20170414-132359] ON [dbo].[V2_CLASS_YEARLYSECLEDGER] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sauda_trace
-- --------------------------------------------------
ALTER TABLE [dbo].[sauda_trace] ADD CONSTRAINT [PK__sauda_trace__35BCFE0A] PRIMARY KEY ([RowNumber])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__2B3F6F97] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_QLCASH_bounced
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_QLCASH_bounced] ADD CONSTRAINT [PK_Tbl_QLCASH_bounced] PRIMARY KEY ([EXCHANGE], [PARTY_CODE], [SAUDA_DATE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.trace070108
-- --------------------------------------------------
ALTER TABLE [dbo].[trace070108] ADD CONSTRAINT [PK__trace070108__1A14E395] PRIMARY KEY ([RowNumber])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BAK_V2_PROC_QUARTERLYLEDGER_6May2011
-- --------------------------------------------------
CREATE PROC BAK_V2_PROC_QUARTERLYLEDGER_6May2011              
(              
 @STARTDT VARCHAR(11),              
 @ENDDT VARCHAR(11),              
 @FROMPARTY VARCHAR(10),              
 @TOPARTY VARCHAR(10)              
)              
              
/*              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'              
*/              
              
AS              
              
SET NOCOUNT ON              
              
/*              
CREATE TABLE V2_CLASS_QUARTERLYLEDGER              
(              
 CQL_ID BIGINT IDENTITY(1,1),              
 CQL_SEGMENT VARCHAR(20),              
 CQL_PARTYCODE VARCHAR(10),              
 CQL_VDT VARCHAR(20),              
 CQL_VTYPE VARCHAR(10),              
 CQL_VNO VARCHAR(20),              
 CQL_ACCODE VARCHAR(10),              
 CQL_REMARKS VARCHAR(255),              
 CQL_DDNO VARCHAR(20),              
 CQL_DEBIT MONEY,              
 CQL_CREDIT MONEY,              
 CQL_BALANCE MONEY,              
 CQL_ORDERBY TINYINT,              
 CQL_DT INT,               
 CQL_ACNAME VARCHAR(100)              
)              
*/              
              
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER              
              
DECLARE @@SDTCUR DATETIME              
              
              
/* NOW DOING NSECM */              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND1.ACCOUNT.DBO.PARAMETER         
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSECM',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 1,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)               
   INNER JOIN              
   ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND1.ACCOUNT.DBO.PARAMETER               
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER             
SELECT               
 CQL_SEGMENT = 'NSECM',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 2,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME = A.ACNAME              
FROM              
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)               
 INNER JOIN              
 ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
              
              
/* NOW DOING BSECM */              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND.ACCOUNT_AB.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'BSECM',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 3,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)               
   INNER JOIN              
   ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'BSECM',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 4,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME = A.ACNAME              
FROM              
 ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)               
 INNER JOIN              
 ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
              
/* NOW DOING NSEFO */              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELFO.ACCOUNTFO.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSEFO',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)               
   INNER JOIN              
   ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NSEFO',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = A.ACNAME              
FROM              
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)               
 INNER JOIN              
 ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
              
/*===========================================================================================================*/              
--------------------------------------------------------------------------------------------------------------------    
-- NCDX    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NCDX',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NCDX',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
              
---------------------------------------------------------------------------------------------------------------    
-- MCDX    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,             
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'MCDX',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'MCDX',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
              
---------------------------------------------------------------------------------------------------------------    
-- MCDXCDS    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'MCDXCDS',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'MCDXCDS',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY      
    
    
--------------------------------------------------------------------------------------------------------------    
-- NSECURFO    
    
SELECT               
 @@SDTCUR = SDTCUR             
FROM               
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSECURFO',               
   CQL_PARTYCODE = L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = A.ACNAME              
  FROM              
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                
   INNER JOIN              
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND A.CLTCODE >= @FROMPARTY              
   AND A.CLTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NSECURFO',               
 CQL_PARTYCODE = L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = A.ACNAME              
FROM              
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                
 INNER JOIN              
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND A.CLTCODE >= @FROMPARTY              
 AND A.CLTCODE <= @TOPARTY              
    
-------------------------------------------------------------------------------------------------------------------                                    
/*============================================================================================================*/            
/*              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
SELECT               
 Q.*,              
 CQL_ADD1 = C.L_ADDRESS1,              
 CQL_ADD2 = C.L_ADDRESS2,              
 CQL_ADD3 = C.L_ADDRESS3,              
 CQL_CITY = C.L_CITY,              
 CQL_ZIP = C.L_ZIP,              
 CQL_PHONE = C.RES_PHONE1,              
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',              
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',              
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'              
FROM               
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)              
 INNER JOIN              
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)              
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)              
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)              
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)              
 ON (Q.CQL_PARTYCODE = C.CL_CODE)              
ORDER BY               
 Q.CQL_PARTYCODE,              
 Q.CQL_ORDERBY,              
 Q.CQL_DT              
  
*/                        
          
DELETE FROM V2_CLASS_QUARTERLYLEDGER          
WHERE CQL_DEBIT = 0          
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_V2_PROC_QUARTERLYLEDGER_POP_dkm161111
-- --------------------------------------------------
  
CREATE PROC bak_V2_PROC_QUARTERLYLEDGER_POP_dkm161111   
(            
               @FROMDATE   VARCHAR(11),            
               @TODATE     VARCHAR(11),            
               @FROMPARTY  VARCHAR(10),            
               @TOPARTY    VARCHAR(10),            
               @FROMSCRIP  VARCHAR(12),            
               @TOSCRIP    VARCHAR(12)            
)     
AS  
  
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY  
  
  
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_V2_PROC_QUARTERLYSHARELEDGER
-- --------------------------------------------------
          
CREATE PROCEDURE [dbo].[bak_V2_PROC_QUARTERLYSHARELEDGER]          
          
(          
               @FROMDATE   VARCHAR(11),          
               @TODATE     VARCHAR(11),          
               @FROMPARTY  VARCHAR(10),          
               @TOPARTY    VARCHAR(10),          
               @FROMSCRIP  VARCHAR(12),          
               @TOSCRIP    VARCHAR(12),          
               @STATUSID   VARCHAR(50),          
               @STATUSNAME VARCHAR(50))          
AS      
/*            
    
      
SELECT COUNT(1) FROM MSAJAG.DBO.DELTRANS      
EXEC V2_PROC_QUARTERLYSHARELEDGER  'JUL  1 1900', 'JUN 15 2009', '0a146', '0a146', '0000000000', 'ZZZZZZZZZZ', 'BROKER', 'BROKER'                
*/          
  DECLARE  @@LOOPDPID VARCHAR(10)          
            
  DECLARE  @@LOOPCLTDPID VARCHAR(16)          
            
  DECLARE  @NEWFROMDATE VARCHAR(11)          
                                  
  SET @@LOOPDPID = 'AAAA'          
            
  SET @@LOOPCLTDPID = 'AAAA'          
                                
  SELECT @NEWFROMDATE = 'APR  1 1950'          
          
TRUNCATE TABLE V2_CLASS_QUARTERLYSECLEDGER          
                                  
          
      CREATE TABLE #TABLEREPORT (          
  SEGMENT VARCHAR(5),          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)                    
      
      CREATE TABLE #TABLE1 (          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)          
          
          
      CREATE TABLE #TABLE2 (          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)          
          
          
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY          
          

Set Transaction isolation level read uncommitted                          
select * into #Del_TransStat_TMP From ANGELDEMAT.MSAJAG.DBO.Deltrans_Report With(NoLock)                           
Where Party_Code >= @FromParty And Party_Code <= @ToParty                          
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                          
--And TransDate >= @NewFromDate and TransDate <= @ToDate      
And Filler2 = 1       
      
INSERT INTO #DEL_TRANSSTAT_TMP      
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,       
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',       
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,       
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,      
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5      
FROM #DEL_TRANSSTAT_TMP D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP1      
WHERE D.SETT_NO = S.SETT_NO      
AND D.SETT_TYPE = S.SETT_TYPE      
AND DP.DESCRIPTION NOT LIKE '%POOL%'      
AND D.BDPID = DP.DPID      
AND D.BCLTDPID = DP.DPCLTNO      
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')      
AND DP1.DESCRIPTION LIKE '%POOL%'      
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)    
AND TCODE <> 0 AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED          
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY          
  SELECT D.*,''           
  FROM   #DEL_TRANSSTAT_TMP  D       
  WHERE  D.TRANSDATE >= @NEWFROMDATE          
         AND D.TRANSDATE <= @TODATE         

 UPDATE TBLDEL_TRANSSTAT_QRLY      SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
 FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
 WHERE M.ISIN = TBLDEL_TRANSSTAT_QRLY.CERTNO
 AND VALID = 1 
          
 UPDATE TBLDEL_TRANSSTAT_QRLY      
 SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANGELDEMAT.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),          
  ANGELDEMAT.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.SCRIP_CD = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD          
  AND S2.SERIES = TBLDEL_TRANSSTAT_QRLY.SERIES          
            
           
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'          
 WHERE ISNULL(SCRIP_NAME,'') = ''          
          
          
  DECLARE STATEMENT_CURSOR CURSOR  FOR          
            
            
  SELECT DISTINCT DPID,          
                DPCLTNO          
  FROM   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP D (NOLOCK)          
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'  
   AND DPCLTNO IN (
SELECT DISTINCT BCLTDPID
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS
WHERE FILLER2 = 1  
AND DRCR = 'D'
AND DELIVERED = '0'
AND TRTYPE IN (904, 905)
AND PARTY_CODE <> 'BROKER'
AND SHARETYPE <> 'AUCTION')
                
  OPEN STATEMENT_CURSOR          
            
  FETCH NEXT FROM STATEMENT_CURSOR          
  INTO @@LOOPDPID,          
       @@LOOPCLTDPID          
                 
  WHILE @@FETCH_STATUS = 0          
    BEGIN          
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY          
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = BDPID,          
                   CLTDPID = BCLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
          ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,        
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = DPID,          
                   CLTDPID = CLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-IN'          
                           ELSE REASON          
                                             END),          
             BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 2          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   /*AND DELIVERED = '0'*/          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND SETT_NO = '2000000' */          
                   AND FILLER1 NOT IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
                    
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO = 0,          
         DPID = '',          
                   CLTDPID = '',          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 3          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = '0'          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND FILLER1 IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO = (CASE           
                               WHEN FILLER1 = 'SPLIT' THEN 0          
                               ELSE SLIPNO          
      END),          
                   DPID = (CASE           
                             WHEN TRTYPE IN (1000,907,908) THEN ''          
                             WHEN FILLER1 = 'SPLIT' THEN ''          
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                             ELSE DPID          
                           END),          
                   CLTDPID = (CASE           
                                WHEN TRTYPE IN (1000,907,908) THEN ''          
                                WHEN FILLER1 = 'SPLIT' THEN ''          
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                                ELSE CLTDPID          
                              END),       
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE          
                               ELSE (CASE           
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'          
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1          
                                       ELSE (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'          
                                               ELSE REASON          
                                             END)          
                                     END)          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 4          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
				   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    FILLER2 = 1          
                   AND DRCR = 'D'          
                   AND DELIVERED <> '0'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                   ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   --AND HOLDERNAME NOT LIKE 'MARGIN%'          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,FILLER1,REASON          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO,          
                   DPID = DP.DPID,          
                   CLTDPID = DP.DPCLTNO,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1,          
                   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
       AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND DESCRIPTION NOT LIKE '%POOL%'*/      
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO          
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                             END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,          
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
          
          
          INSERT INTO #TABLE1          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'OPENING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),          
         FLAG = 0          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 < @FROMDATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          UNION ALL          
          SELECT *          
          FROM   TBLDEL_TRANSSTAT1_QRLY          
          WHERE  TRANSDATE1 >= @FROMDATE          
                 AND TRANSDATE1 <= @TODATE          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'CLOSING BALANCE',         
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),          
                   FLAG = 6          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 <= @TODATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          ORDER BY PARTY_CODE,          
                   SCRIP_CD,          
                   CERTNO,          
                   TRANSDATE1,          
                   FLAG,          
                   SETT_NO,          
                   SETT_TYPE          
                      
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY          
          
          
                
      FETCH NEXT FROM STATEMENT_CURSOR          
      INTO @@LOOPDPID,          
           @@LOOPCLTDPID          
    END          
              
  CLOSE STATEMENT_CURSOR          
            
  DEALLOCATE STATEMENT_CURSOR          
      
 INSERT INTO #TABLEREPORT          
  SELECT   'NSECM', *          
      FROM     #TABLE1          
  WHERE  CQTY <> 0 OR DQTY <> 0                
 ORDER BY PARTY_CODE,          
               SCRIP_CD,          
               FLAG,          
               TRANSDATEDT          
                         
      TRUNCATE TABLE #TABLE1          
      DROP TABLE #TABLE1          
          
          
/* NOW DOING BSECM */          
          
      
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY          
 
Set Transaction isolation level read uncommitted                          
select * into #Del_TransStat_TMP_1 From ANGELDEMAT.BSEDB.DBO.Deltrans_Report With(NoLock)                           
Where Party_Code >= @FromParty And Party_Code <= @ToParty                          
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                          
--And TransDate >= @NewFromDate and TransDate <= @ToDate      
And Filler2 = 1       
      
INSERT INTO #DEL_TRANSSTAT_TMP_1      
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,       
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',       
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,       
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,      
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5      
FROM #DEL_TRANSSTAT_TMP_1 D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP1      
WHERE D.SETT_NO = S.SETT_NO      
AND D.SETT_TYPE = S.SETT_TYPE      
AND DP.DESCRIPTION NOT LIKE '%POOL%'      
AND D.BDPID = DP.DPID      
AND D.BCLTDPID = DP.DPCLTNO      
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')      
AND DP1.DESCRIPTION LIKE '%POOL%'      
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)    
/*AND TCODE <> 0 */AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED          
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY          
  SELECT D.*,''           
  FROM   #DEL_TRANSSTAT_TMP_1  D       
  WHERE  D.TRANSDATE >= @NEWFROMDATE          
         AND D.TRANSDATE <= @TODATE 
         
          
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 (NOLOCK),          
  ANGELDEMAT.BSEDB.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.BSECODE = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD          
            
           
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'          
 WHERE ISNULL(SCRIP_NAME,'') = ''          
          
  DECLARE STATEMENT_CURSOR CURSOR  FOR          
            
            
  
  SELECT DISTINCT DPID,          
                DPCLTNO          
  FROM   ANGELDEMAT.BSEDB.DBO.DELIVERYDP D (NOLOCK)          
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'  
 AND DPCLTNO IN (
SELECT DISTINCT BCLTDPID
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS
WHERE FILLER2 = 1  
AND DRCR = 'D'
AND DELIVERED = '0'
AND TRTYPE IN (904, 905)
AND PARTY_CODE <> 'BROKER'
AND SHARETYPE <> 'AUCTION')
           
  OPEN STATEMENT_CURSOR          
            
  FETCH NEXT FROM STATEMENT_CURSOR          
  INTO @@LOOPDPID,          
       @@LOOPCLTDPID          
                 
  WHILE @@FETCH_STATUS = 0          
    BEGIN          
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY          
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = BDPID,          
                   CLTDPID = BCLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
     AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
     WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = DPID,          
                   CLTDPID = CLTDPID,          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,                         FLAG = 2          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   /*AND DELIVERED = '0'*/          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND SETT_NO = '2000000' */          
                   AND FILLER1 NOT IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                 END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
               BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
                    
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   SCRIP_NAME = D.SCRIP_CD + '( ' + CERTNO + ')',          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO = 0,          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 3          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = '0'          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
          AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND FILLER1 IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                 END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
          SELECT  TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO = (CASE           
                               WHEN FILLER1 = 'SPLIT' THEN 0          
                               ELSE SLIPNO          
                             END),          
                   DPID = (CASE           
                             WHEN TRTYPE IN (1000,907,908) THEN ''          
                             WHEN FILLER1 = 'SPLIT' THEN ''          
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                             ELSE DPID          
                           END),          
                   CLTDPID = (CASE           
                                WHEN TRTYPE IN (1000,907,908) THEN ''          
                                WHEN FILLER1 = 'SPLIT' THEN ''          
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                                ELSE CLTDPID          
                              END),          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE          
                               ELSE (CASE           
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'          
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1          
                                       ELSE (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'          
                           ELSE REASON          
                                             END)          
                                     END)          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 4          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    FILLER2 = 1          
                   AND DRCR = 'D'          
                   AND DELIVERED <> '0'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                              ELSE '%'          
                                           END)          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
         D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,FILLER1,REASON          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO,          
                   DPID = DP.DPID,          
                   CLTDPID = DP.DPCLTNO,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1,          
                   ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND DESCRIPTION NOT LIKE '%POOL%'    */      
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO          
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)   
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,          
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
          
          
          INSERT INTO #TABLE2          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'OPENING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),          
                   FLAG = 0          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 < @FROMDATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          UNION ALL          
          SELECT *          
          FROM   TBLDEL_TRANSSTAT1_QRLY          
          WHERE  TRANSDATE1 >= @FROMDATE          
                 AND TRANSDATE1 <= @TODATE          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),   
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
  REASON = 'CLOSING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),          
                   FLAG = 6          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 <= @TODATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          ORDER BY PARTY_CODE,          
                   SCRIP_CD,          
                   CERTNO,          
                   TRANSDATE1,          
                   FLAG,          
                   SETT_NO,          
                   SETT_TYPE          
                             
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY          
          
          
                
      FETCH NEXT FROM STATEMENT_CURSOR          
      INTO @@LOOPDPID,          
           @@LOOPCLTDPID          
    END          
              
  CLOSE STATEMENT_CURSOR          
            
  DEALLOCATE STATEMENT_CURSOR          
          
 INSERT INTO #TABLEREPORT          
  SELECT   'BSECM', *          
      FROM     #TABLE2          
  WHERE  CQTY <> 0 OR DQTY <> 0                
 ORDER BY PARTY_CODE,          
               SCRIP_CD,          
               FLAG,          
               TRANSDATEDT          
                         
      TRUNCATE TABLE #TABLE2          
      DROP TABLE #TABLE2          
          
          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER          
SELECT             
 Q.*          
FROM             
 #TABLEREPORT Q (NOLOCK)            
          
          
TRUNCATE TABLE #TABLEREPORT          
DROP TABLE #TABLEREPORT          
          
/*         
        
         
SELECT EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN,        
effdate, SUM(QTY)        
FROM C_SECURITIESMST        
where effdate >= '' and effdate <= ''        
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, effdate        
        
*/            
            
CREATE TABLE #COLL        
(        
 EXCHANGE VARCHAR(10),        
 SEGMENT VARCHAR(20),        
 EXCSEGMENT VARCHAR(10),        
 EFFDT VARCHAR(10),        
 PARTY_CODE VARCHAR(10),        
 SCRIP_CD VARCHAR(20),        
 SERIES VARCHAR(10),        
 SCRIP_NAME VARCHAR(100),        
 CERTNO VARCHAR(20),        
 CQTY INT,        
 DQTY INT,        
 REASON VARCHAR(255),        
 TRANSDATEDT DATETIME,        
 FLAG INT        
)        
         
INSERT INTO #COLL        
SELECT      
 EXCHANGE,      
 SEGMENT,      
 '',      
 CONVERT(varchar,CONVERT(DATETIME, @FROMDATE,109),103),      
 PARTY_CODE,      
 SCRIP_CD,      
 SERIES,      
 '',      
 ISIN,      
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),      
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),      
 'OPENING BALANCE',        
 CONVERT(DATETIME, @FROMDATE,109),        
 2        
 FROM      
 (      
  SELECT         
  EXCHANGE,        
  SEGMENT,         
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,        
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))      
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST       
  WHERE        
   EFFDATE < @FROMDATE        
   AND PARTY_CODE   >= @FROMPARTY      
   AND PARTY_CODE <= @TOPARTY      
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS        
 ) X      
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN      
      
      
      
INSERT INTO #COLL        
SELECT         
EXCHANGE,        
SEGMENT,        
'',        
convert(varchar,effdate,103),         
PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,        
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),        
UPPER(REMARKS),        
EFFDATE,        
1        
FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST        
WHERE        
 EFFDATE >= @FROMDATE        
 AND EFFDATE <= @TODATE + ' 23:59:59'        
 AND PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS        
        
        
/*      
INSERT INTO #COLL        
SELECT         
EXCHANGE,        
SEGMENT,        
'',        
convert(varchar,effdate,103),     PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,        
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),        
'CLOSING BALANCE',        
@TODATE + ' 23:59:59',        
6        
FROM MSAJAG.DBO.C_SECURITIESMST (NOLOCK)        
WHERE        
 EFFDATE <= @TODATE + ' 23:59:59'        
 AND PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS        
*/      
      
INSERT INTO #COLL        
SELECT      
 EXCHANGE,      
 SEGMENT,      
 '',      
 CONVERT(varchar,CONVERT(DATETIME, @TODATE,109),103),      
 PARTY_CODE,      
 SCRIP_CD,      
 SERIES,      
 '',      
 ISIN,      
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),      
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),      
 'CLOSING BALANCE',        
 @TODATE + ' 23:59:59',        
 6        
 FROM      
 (      
  SELECT         
  EXCHANGE,        
  SEGMENT,         
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,        
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))      
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST       
  WHERE        
   EFFDATE <= @TODATE  + ' 23:59:59'      
   AND PARTY_CODE   >= @FROMPARTY      
   AND PARTY_CODE <= @TOPARTY      
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS        
 ) X      
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN      
        
        
        
UPDATE #COLL          
SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')' ,        
EXCSEGMENT =         
 ( CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL' THEN 'NSECM'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'CAPITAL' THEN 'BSECM'        
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN 'NSEFO'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'FUTURES' THEN 'BSEFO'        
WHEN EXCHANGE = 'NCX' AND SEGMENT = 'FUTURES' THEN 'NCDX'        
WHEN EXCHANGE = 'MCX' AND SEGMENT = 'FUTURES' THEN 'MCDX'        
WHEN EXCHANGE = 'ALL' AND SEGMENT = 'COMMON' THEN 'DBCOMMON'        
WHEN EXCHANGE = 'BCM' AND SEGMENT = 'FUTURES' THEN 'BSEFOPCM'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'SLBS' THEN 'BSESLBS'        
WHEN EXCHANGE = 'BSX' AND SEGMENT = 'FUTURES' THEN 'BSECURFO'        
WHEN EXCHANGE = 'MCD' AND SEGMENT = 'FUTURES' THEN 'MCDXCDS'        
WHEN EXCHANGE = 'MCM' AND SEGMENT = 'FUTURES' THEN 'MCDXPCM'        
WHEN EXCHANGE = 'NCM' AND SEGMENT = 'FUTURES' THEN 'NSEFOPCM'        
WHEN EXCHANGE = 'NMC' AND SEGMENT = 'FUTURES' THEN 'NMCE'        
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'SLBS' THEN 'NSESLBS'        
WHEN EXCHANGE = 'NSX' AND SEGMENT = 'FUTURES' THEN 'NSECURFO'        
WHEN EXCHANGE = 'NXM' AND SEGMENT = 'FUTURES' THEN 'NSECURFOPCM'          
ELSE 'UNKNOWN' END)        
        
        
UPDATE #COLL        
SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANAND1.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),          
  ANAND1.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.SCRIP_CD = #COLL.SCRIP_CD          
  AND S2.SERIES = #COLL.SERIES          
        
            
        
UPDATE #COLL        
SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  AngelBSECM.BSEDB_AB.DBO.SCRIP1 S1 (NOLOCK),          
  AngelBSECM.BSEDB_AB.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.BSECODE = #COLL.SCRIP_CD          
        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER          
SELECT             
 EXCSEGMENT,        
 EFFDT,        
 '',        
 '',        
 PARTY_CODE,        
 SCRIP_CD,        
 SCRIP_NAME,        
 CERTNO,        
 CQTY,        
 DQTY,        
 '0',        
 '',        
 '',        
 '0',        
 UPPER(REASON),        
 '',        
 '',        
 TRANSDATEDT ,        
 FLAG         
FROM             
 #COLL  (NOLOCK)            
WHERE      
 PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
 AND ( CQTY <> 0  OR DQTY <> 0)      
        
TRUNCATE TABLE #COLL        
DROP TABLE #COLL        
      
select * from V2_CLASS_QUARTERLYSECLEDGER      
      
SET ANSI_NULLS OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!8K;6>!>2(990)/268?@U-}-#;*9<>//-&{99''!! ;;L'
SET @ERRCODE2 = '<<!9R12WJ659S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!'''
SET @ERRCODE5 = '@=${1`@'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY
-- --------------------------------------------------


CREATE PROC CLASSPROC_SAUDA_SUMMARY          
(          
 @STATUSID VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @FROMPARTYCODE VARCHAR(10),          
 @TOPARTYCODE VARCHAR(10),          
 @FROMDATE VARCHAR(11),          
 @TODATE VARCHAR(11),    
 @SETT_TYPE VARCHAR(3)      
)          
          
/*          
EXEC CLASSPROC_SAUDA_SUMMARY 'BROKER','BROKER', 'M888', 'M888', 'NOV  1 2008', 'NOV  7 2008' ,'%'         
*/          
          
AS          
          
CREATE TABLE #CLASSTBL_SAUDASUMMARY          
(          
 EXCHANGE VARCHAR(8),          
 TRDTYPE  VARCHAR(10),          
 PARTY_CODE VARCHAR(10),          
 TRADEDATE VARCHAR(10),          
 SCRIP_CD VARCHAR(12),           
 SCRIP_NAME VARCHAR(100),          
 SETT_NO VARCHAR(7),          
 SETT_TYPE VARCHAR(3),          
 BUYQTY INT,           
 BUYAVGRATE MONEY,          
 BUYAMOUNT MONEY,           
 SELLQTY INT,          
 SELLAVGRATE MONEY,          
 SELLAMOUNT MONEY,          
 NETQTY INT,          
 NETAVGRATE MONEY,          
 NETAMOUNT MONEY,          
 FLAG TINYINT          
)          
          
----------------------------          
-- NOW STARTING BSE CASH --          
----------------------------          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO #CLASSTBL_SAUDASUMMARY          
SELECT           
 EXCHANGE = 'BSE CASH',          
 TRDTYPE = '1. TRD',          
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME,          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = SUM(PQTYTRD),           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),          
 BUYAMOUNT = SUM(PAMTTRD),           
 SELLQTY = SUM(SQTYTRD),          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),          
 SELLAMOUNT = SUM(SAMTTRD) ,          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),          
 FLAG = 1          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)          
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME,          
 SETT_NO,          
 SETT_TYPE          
HAVING          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0           
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0          
          
UNION          
          
SELECT           
 EXCHANGE = 'BSE CASH',          
 TRDTYPE = '2. DEL',           
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = SUM(PQTYDEL),           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),          
 BUYAMOUNT = SUM(PAMTDEL),           
 SELLQTY = SUM(SQTYDEL),          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),          
 SELLAMOUNT = SUM(SAMTDEL),          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),          
 FLAG = 1          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)          
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME,          
 SETT_NO,          
 SETT_TYPE          
HAVING          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0          
          
UNION          
          
SELECT           
 EXCHANGE = 'BSE CASH',          
 TRDTYPE = '3. LEV',           
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD = 'ZZZZZZZZZZZZ',           
SCRIP_NAME = '** LEVIES **',          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = 0,           
 BUYAVGRATE = 0,          
 BUYAMOUNT = 0,           
 SELLQTY = 0,          
 SELLAVGRATE = 0,          
 SELLAMOUNT = 0,          
 NETQTY = 0,          
 NETAVGRATE = 0,          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,          
 FLAG = 2          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)          
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SETT_NO,          
 SETT_TYPE          
          
----------------------------          
-- NOW STARTING NSE CASH --          
----------------------------          
          
          
INSERT INTO #CLASSTBL_SAUDASUMMARY          
SELECT           
 EXCHANGE = 'NSE CASH',          
 TRDTYPE = '1. TRD',          
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = SUM(PQTYTRD),           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),          
 BUYAMOUNT = SUM(PAMTTRD),           
 SELLQTY = SUM(SQTYTRD),          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),          
 SELLAMOUNT = SUM(SAMTTRD) ,          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),          
 FLAG = 1          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN           
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SERIES,          
 SETT_NO,          
 SETT_TYPE          
HAVING          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0           
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0          
          
UNION          
          
SELECT           
 EXCHANGE = 'NSE CASH',          
 TRDTYPE = '2. DEL',           
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = SUM(PQTYDEL),           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),          
 BUYAMOUNT = SUM(PAMTDEL),           
 SELLQTY = SUM(SQTYDEL),          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),          
 SELLAMOUNT = SUM(SAMTDEL),          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),          
 FLAG = 1          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN           
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD,           
 SERIES,          
 SETT_NO,          
 SETT_TYPE          
HAVING          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0          
          UNION          
          
SELECT           
 EXCHANGE = 'NSE CASH',          
 TRDTYPE = '3. LEV',           
 PARTY_CODE,          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),          
 SCRIP_CD = 'ZZZZZZZZZZZZ',           
 SCRIP_NAME = '** LEVIES **',          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY = 0,           
 BUYAVGRATE = 0,          
 BUYAMOUNT = 0,           
 SELLQTY = 0,          
 SELLAVGRATE = 0,          
 SELLAMOUNT = 0,          
 NETQTY = 0,          
 NETAVGRATE = 0,          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,            
 FLAG = 2          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN          
WHERE PARTY_CODE >= @FROMPARTYCODE          
AND PARTY_CODE <= @TOPARTYCODE          
AND SAUDA_DATE >= @FROMDATE          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
GROUP BY           
 PARTY_CODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),          
 SETT_NO,          
 SETT_TYPE          
          
-------------------------------          
-- COMPLETED CALCULATION --          
-------------------------------          
      
SELECT           
 C.*           
FROM           
 #CLASSTBL_SAUDASUMMARY C          
 INNER JOIN          
 ANAND1.MSAJAG.DBO.CLIENT2 C2    
 INNER JOIN ANAND1.MSAJAG.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)    
 ON (C.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)  
WHERE           
 C.EXCHANGE = 'NSE CASH'      
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA  
            WHEN @STATUSID = 'REGION' THEN C1.REGION  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME  
            ELSE 'I DONT KNOW ' END)  
AND C.SETT_TYPE NOT IN ('A','X')
UNION          
SELECT           
 C.*           
FROM           
 #CLASSTBL_SAUDASUMMARY C          
 INNER JOIN          
 BSEDB_AB.DBO.CLIENT2 C2    
 INNER JOIN BSEDB_AB.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)    
 ON (C.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)  
WHERE           
 C.EXCHANGE = 'BSE CASH'     
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA  
            WHEN @STATUSID = 'REGION' THEN C1.REGION  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME  
            ELSE 'I DONT KNOW ' END)   
AND C.SETT_TYPE NOT IN ('AC','AD')
ORDER BY          
 C.PARTY_CODE,          
 C.EXCHANGE,          
 C.SETT_NO,          
 C.SETT_TYPE,          
 C.FLAG,          
 C.SCRIP_NAME,          
 C.TRDTYPE          
          
TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY          
          
DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT
-- --------------------------------------------------
    
    
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT]    
(                          
 @STATUSID VARCHAR(25),                  
 @STATUSNAME VARCHAR(25),                  
 @FROMPARTYCODE VARCHAR(10),                          
 @TOPARTYCODE VARCHAR(10),                          
 @FROMDATE VARCHAR(11),                          
 @TODATE VARCHAR(11),                    
 @SETT_TYPE VARCHAR(3)                      
)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'A0001', 'bz999', 'NOV  1 2010', 'NOV 30 2010' ,'%'                         
*/                          
                          
AS                          
                          
CREATE TABLE #CLASSTBL_SAUDASUMMARY                          
(                          
 EXCHANGE VARCHAR(8),                          
 TRDTYPE  VARCHAR(10),                          
 PARTY_CODE VARCHAR(10),                          
 TRADEDATE VARCHAR(10),                          
 SCRIP_CD VARCHAR(12),                           
 SCRIP_NAME VARCHAR(100),                          
 SETT_NO VARCHAR(7),                          
 SETT_TYPE VARCHAR(3),                          
 BUYQTY INT,                           
 BUYAVGRATE MONEY,                          
 BUYAMOUNT MONEY,                           
 SELLQTY INT,                          
 SELLAVGRATE MONEY,                          
 SELLAMOUNT MONEY,                          
 NETQTY INT,                          
 NETAVGRATE MONEY,                          
 NETAMOUNT MONEY,                          
 FLAG TINYINT                          
)                          
                          
----------------------------                          
-- NOW STARTING BSE CASH --                          
----------------------------                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
 -- HAVING SUM(PQTYTRD) - SUM(SQTYTRD) <> 0 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0 
 HAVING SUM(PQTYTRD) <> 0 
                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                     
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,             
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
-- HAVING SUM(PQTYDEL) - SUM(SQTYDEL) <> 0 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0   
HAVING SUM(PQTYDEL) <> 0 OR SUM(SQTYDEL) <> 0 
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                          
                          
----------------------------                          
-- NOW STARTING NSE CASH --                          
----------------------------                          
                          
                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,        
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE               
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
 -- HAVING SUM(PQTYTRD) - SUM(SQTYTRD) <> 0 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0  
 HAVING SUM(PQTYTRD) <> 0                                                  
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with(NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
-- HAVING SUM(PQTYDEL) - SUM(SQTYDEL) <> 0 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0    
HAVING SUM(PQTYDEL) <> 0 OR SUM(SQTYDEL) <> 0 
                      
 UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
 SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                   
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,              
 FLAG = 2                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                         
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                                                
-------------------------------                          
-- COMPLETED CALCULATION --                          
-------------------------------                          
                      
SELECT                           
 C.*,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM              
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                         
 INNER JOIN                          
AngelBSECM.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                            
 ON (C.PARTY_CODE = C1.PARTY_CODE)         
WHERE                           
 C.EXCHANGE = 'NSE CASH'                      
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                  
            ELSE 'I DONT KNOW ' END)                  
AND C.SETT_TYPE NOT IN ('A','X')                
UNION                          
SELECT                           
 C.*,                           
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                          
 INNER JOIN                          
AngelBSECM.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                            
 ON (C.PARTY_CODE = C1.PARTY_CODE)         
WHERE                           
 C.EXCHANGE = 'BSE CASH'                     
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                  
            ELSE 'I DONT KNOW ' END)                   
AND C.SETT_TYPE NOT IN ('AC','AD')                
ORDER BY                          
 C.PARTY_CODE,                          
 C.EXCHANGE,                          
 C.SETT_NO,                          
 C.SETT_TYPE,                          
 C.FLAG,                          
 C.SCRIP_NAME,                          
 C.TRDTYPE                          
                          
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY          
                          
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_01122010
-- --------------------------------------------------


CREATE PROC CLASSPROC_SAUDA_SUMMARY_CASHPRINT_01122010          
(                      
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @FROMPARTYCODE VARCHAR(10),                      
 @TOPARTYCODE VARCHAR(10),                      
 @FROMDATE VARCHAR(11),                      
 @TODATE VARCHAR(11),                
 @SETT_TYPE VARCHAR(3)                  
)                      
                      
/*                      
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'A0001', 'bz999', 'NOV  1 2010', 'NOV 30 2010' ,'%'                     
*/                      
                      
AS                      
                      
CREATE TABLE #CLASSTBL_SAUDASUMMARY                      
(                      
 EXCHANGE VARCHAR(8),                      
 TRDTYPE  VARCHAR(10),                      
 PARTY_CODE VARCHAR(10),                      
 TRADEDATE VARCHAR(10),                      
 SCRIP_CD VARCHAR(12),                       
 SCRIP_NAME VARCHAR(100),                      
 SETT_NO VARCHAR(7),                      
 SETT_TYPE VARCHAR(3),                      
 BUYQTY INT,                       
 BUYAVGRATE MONEY,                      
 BUYAMOUNT MONEY,                       
 SELLQTY INT,                      
 SELLAVGRATE MONEY,                      
 SELLAMOUNT MONEY,                      
 NETQTY INT,                      
 NETAVGRATE MONEY,                      
 NETAMOUNT MONEY,                      
 FLAG TINYINT                      
)                      
                      
----------------------------                      
-- NOW STARTING BSE CASH --                      
----------------------------                      
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '1. TRD',                      
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTTRD),                       
 SELLQTY = SUM(SQTYTRD),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTTRD) ,                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                      
 FLAG = 1                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '2. DEL',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                      
 SETT_NO,                      
 SETT_TYPE,         
 BUYQTY = SUM(PQTYDEL),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTDEL),                       
 SELLQTY = SUM(SQTYDEL),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTDEL),                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                      
 FLAG = 1                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '3. LEV',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                       
SCRIP_NAME = '** LEVIES **',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = 0,                       
 BUYAVGRATE = 0,                      
 BUYAMOUNT = 0,                       
 SELLQTY = 0,                      
 SELLAVGRATE = 0,                      
 SELLAMOUNT = 0,                      
 NETQTY = 0,                      
 NETAVGRATE = 0,                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                      
 FLAG = 2                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SETT_NO,                      
 SETT_TYPE                      
                      
----------------------------                      
-- NOW STARTING NSE CASH --                      
----------------------------                      
                      
                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '1. TRD',                      
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTTRD),                       
 SELLQTY = SUM(SQTYTRD),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTTRD) ,                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                      
 FLAG = 1                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                       
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE           
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SERIES,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '2. DEL',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYDEL),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTDEL),                       
 SELLQTY = SUM(SQTYDEL),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTDEL),                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                      
 FLAG = 1                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                       
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SERIES,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                      
          UNION                      
                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '3. LEV',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                       
 SCRIP_NAME = '** LEVIES **',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = 0,                       
 BUYAVGRATE = 0,                      
 BUYAMOUNT = 0,                       
 SELLQTY = 0,                      
 SELLAVGRATE = 0,                      
 SELLAMOUNT = 0,                      
 NETQTY = 0,                      
 NETAVGRATE = 0,                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                        
 FLAG = 2                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SETT_NO,                      
 SETT_TYPE                                            
-------------------------------                      
-- COMPLETED CALCULATION --                      
-------------------------------                      
                  
SELECT                       
 C.*,        
 C1.SHORT_NAME,        
 C1.BRANCH_CD,        
 C1.SUB_BROKER,        
 C1.L_ADDRESS1,        
 C1.L_ADDRESS2,        
 C1.L_ADDRESS3,        
 C1.L_CITY,        
 C1.L_STATE,        
 C1.L_ZIP,        
 C1.MOBILE_PAGER,        
 C1.RES_PHONE1,        
 C1.RES_PHONE2,        
 C1.OFF_PHONE1        
FROM          
 #CLASSTBL_SAUDASUMMARY C                      
 INNER JOIN                      
ANAND.Pradnya.dbo.TBL_ECNCASH C1                         
 ON (C.PARTY_CODE = C1.PARTY_CODE)     
WHERE                       
 C.EXCHANGE = 'NSE CASH'                  
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                  
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA              
            WHEN @STATUSID = 'REGION' THEN C1.REGION              
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD              
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER              
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER              
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY              
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE              
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME              
            ELSE 'I DONT KNOW ' END)              
AND C.SETT_TYPE NOT IN ('A','X')            
UNION                      
SELECT                       
 C.*,                       
 C1.SHORT_NAME,        
 C1.BRANCH_CD,        
 C1.SUB_BROKER,        
 C1.L_ADDRESS1,        
 C1.L_ADDRESS2,        
 C1.L_ADDRESS3,        
 C1.L_CITY,        
 C1.L_STATE,        
 C1.L_ZIP,        
 C1.MOBILE_PAGER,        
 C1.RES_PHONE1,        
 C1.RES_PHONE2,        
 C1.OFF_PHONE1        
FROM                       
 #CLASSTBL_SAUDASUMMARY C                      
 INNER JOIN                      
ANAND.Pradnya.dbo.TBL_ECNCASH C1                         
 ON (C.PARTY_CODE = C1.PARTY_CODE)     
WHERE                       
 C.EXCHANGE = 'BSE CASH'                 
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                    
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA              
            WHEN @STATUSID = 'REGION' THEN C1.REGION              
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD              
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER              
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER              
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY              
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE              
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME              
            ELSE 'I DONT KNOW ' END)               
AND C.SETT_TYPE NOT IN ('AC','AD')            
ORDER BY                      
 C.PARTY_CODE,                      
 C.EXCHANGE,                      
 C.SETT_NO,                      
 C.SETT_TYPE,                      
 C.FLAG,                      
 C.SCRIP_NAME,                      
 C.TRDTYPE                      
                      
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                      
                      
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW
-- --------------------------------------------------

    
              
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',            
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',             
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'               
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',               
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',               
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'               
              
              
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)             
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'              
              
              
              
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW]        
 (                                      
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @FROMPARTYCODE VARCHAR(10),              
 @TOPARTYCODE VARCHAR(10),              
 @FROMDATE VARCHAR(11),              
 @TODATE VARCHAR(11),              
 @SETT_TYPE VARCHAR(3),              
 @FROMCODE VARCHAR(15)='',              
 @TOCODE VARCHAR(15)='zzzzzzzzzz',              
 @RPT_BY VARCHAR(15)='BROKER'              
 )                                      
                                      
/*                                      
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                                     
*/                                      
                                      
AS                                      
              
IF @TOCODE = ''              
BEGIN              
 SET @TOCODE = 'zzzzzzzzzz'              
END              
              
              
SELECT              
 DISTINCT              
 PARTY_CODE,              
 PARENTCODE              
INTO               
 #PARTY              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)              
WHERE              
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE           
 AND (              
 CASE              
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY              
 WHEN @RPT_BY = 'REGION'  THEN REGION              
 WHEN @RPT_BY = 'AREA'  THEN AREA              
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD              
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER              
 WHEN @RPT_BY = 'TRADER'  THEN TRADER              
 ELSE PARENTCODE              
  END)              
 BETWEEN @FROMCODE AND @TOCODE              
 AND @STATUSNAME = (              
 CASE               
  WHEN @STATUSID = 'AREA' THEN AREA                              
  WHEN @STATUSID = 'REGION' THEN REGION                              
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                              
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                              
  WHEN @STATUSID = 'TRADER' THEN TRADER                              
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                              
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                              
  WHEN @STATUSID = 'BROKER' THEN 'broker'                              
  ELSE 'I DONT KNOW '               
 END)              
              
              
              
              
CREATE TABLE #CLASSTBL_SAUDASUMMARY                                      
(                                      
 EXCHANGE VARCHAR(8),                                      
 TRDTYPE  VARCHAR(10),                                      
 PARTY_CODE VARCHAR(10),                                      
 TRADEDATE VARCHAR(10),                                      
 SCRIP_CD VARCHAR(12),                                       
 SCRIP_NAME VARCHAR(100),                                      
 SETT_NO VARCHAR(7),                                      
 SETT_TYPE VARCHAR(3),                
 BUYQTY INT,                                       
 BUYAVGRATE MONEY,                                      
 BUYAMOUNT MONEY,                                       
 SELLQTY INT,                                      
 SELLAVGRATE MONEY,                                      
 SELLAMOUNT MONEY,                                      
 NETQTY INT,                    
 NETAVGRATE MONEY,                                      
 NetAmount MONEY,                                      
 FLAG TINYINT,              
 LONG_NAME VARCHAR(100),                        
 BRANCH_CD VARCHAR(20),                        
 SUB_BROKER VARCHAR(20),                        
 L_ADDRESS1 VARCHAR(100),                        
 L_ADDRESS2 VARCHAR(100),                        
 L_ADDRESS3 VARCHAR(100),                        
L_CITY VARCHAR(50),                        
 L_STATE VARCHAR(50),                        
 L_ZIP VARCHAR(20),                        
 MOBILE_PAGER VARCHAR(50),                        
 RES_PHONE1 VARCHAR(100),                        
 RES_PHONE2 VARCHAR(100),                     
 OFF_PHONE1 VARCHAR(100)                       
)                                      
                         
          
--------FOR NSE OPTIMIZATION     
    
SELECT DISTINCT SETT_NO INTO #SETT FROM ANAND1.MSAJAG.DBO.SETT_MST WHERE Start_date >=@FROMDATE  AND Start_date <= @TODATE + ' 23:59'          
AND SETT_TYPE IN ('N','W')    
                       
----------------------------                                      
-- NOW STARTING BSE CASH (LIVE) --                                      
----------------------------                                      
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                   
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                 
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                         
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                 
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                                       
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                      
 FLAG = 2,                                      
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                      
                                      
-------------------------------------                                      
-- NOW STARTING NSE CASH (LIVE) --                                      
-------------------------------------                                  
           
                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                                   
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE        
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,    
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                   
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
              
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
 SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,              
 LONG_NAME='',              
 BRANCH_CD='',
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                                            
              
--declare @FROMDATE varchar(11)
--set @FROMDATE='Sep 01 2012'

if (Convert(datetime,@FROMDATE,103)<'2013-04-01')                                 
begin 





--- samit changes   

----------------------------                                      
-- NOW STARTING BSE CASH (Archival) --                                      
----------------------------                                      
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                   
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                 
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                         
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                 
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                                       
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                      
 FLAG = 2,                                      
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                      
                                      
           
---------------------------------------                                     
-- NOW STARTING NSE CASH (ARCHIVE)--                                      
---------------------------------------                                      
                                      
                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                                   
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0              
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
              
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',         
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
 SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 [172.31.16.30].MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                
        
end
--- samit changes END HERE.       

-------------------------------                                      
-- COMPLETED CALCULATION --                                      
-------------------------------       
                           
UPDATE               
 #CLASSTBL_SAUDASUMMARY              
SET               
 LONG_NAME = C1.LONG_NAME,              
 BRANCH_CD = C1.BRANCH_CD,              
 SUB_BROKER = C1.SUB_BROKER,              
 L_ADDRESS1 = C1.L_ADDRESS1,              
 L_ADDRESS2 = C1.L_ADDRESS2,              
 L_ADDRESS3 = C1.L_ADDRESS3,              
 L_CITY  = C1.L_CITY,              
 L_STATE  = C1.L_STATE,              
 L_ZIP  = C1.L_ZIP,              
 MOBILE_PAGER= C1.MOBILE_PAGER,              
 RES_PHONE1 = C1.RES_PHONE1,              
 RES_PHONE2 = C1.RES_PHONE2,              
 OFF_PHONE1 = C1.OFF_PHONE1              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)              
WHERE              
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE              
              
              
SELECT                                       
 EXCHANGE,              
 TRDTYPE,              
 PARTY_CODE,              
 TRADEDATE,              
 SCRIP_CD,              
 SCRIP_NAME,              
 SETT_NO,              
 SETT_TYPE,              
 BUYQTY,              
 BUYAVGRATE,              
 BUYAMOUNT,              
 SELLQTY,              
 SELLAVGRATE,              
 SELLAMOUNT,              
 NETQTY,              
 NETAVGRATE,              
 NetAmount,              
 FLAG,              
 LONG_NAME,                        
 BRANCH_CD,                        
 SUB_BROKER,                        
 L_ADDRESS1,                        
 L_ADDRESS2,                        
 L_ADDRESS3,                        
 L_CITY,                        
 L_STATE,                        
 L_ZIP,                        
 MOBILE_PAGER,                        
 RES_PHONE1,                        
 RES_PHONE2,   
 OFF_PHONE1                        
FROM                          
 #CLASSTBL_SAUDASUMMARY (NOLOCK)              
ORDER BY                                      
 PARTY_CODE,                                      
 EXCHANGE,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 FLAG,                                      
 SCRIP_NAME,                                      
 TRDTYPE                           
                                      
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                     
                                      
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_250072011
-- --------------------------------------------------
      
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',    
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',     
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'       
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',       
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',       
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'       
      
      
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)     
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'      
      
      
      
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_250072011]
 (                              
 @STATUSID VARCHAR(25),      
 @STATUSNAME VARCHAR(25),      
 @FROMPARTYCODE VARCHAR(10),      
 @TOPARTYCODE VARCHAR(10),      
 @FROMDATE VARCHAR(11),      
 @TODATE VARCHAR(11),      
 @SETT_TYPE VARCHAR(3),      
 @FROMCODE VARCHAR(15)='',      
 @TOCODE VARCHAR(15)='zzzzzzzzzz',      
 @RPT_BY VARCHAR(15)='BROKER'      
 )                              
                              
/*                              
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                             
*/                              
                              
AS                              
      
IF @TOCODE = ''      
BEGIN      
 SET @TOCODE = 'zzzzzzzzzz'      
END      
      
      
SELECT      
 DISTINCT      
 PARTY_CODE,      
 PARENTCODE      
INTO       
 #PARTY      
FROM      
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)      
WHERE      
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE   
 AND (      
 CASE      
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY      
 WHEN @RPT_BY = 'REGION'  THEN REGION      
 WHEN @RPT_BY = 'AREA'  THEN AREA      
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD      
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER      
 WHEN @RPT_BY = 'TRADER'  THEN TRADER      
 ELSE PARTY_CODE      
  END)      
 BETWEEN @FROMCODE AND @TOCODE      
 AND @STATUSNAME = (      
 CASE       
  WHEN @STATUSID = 'AREA' THEN AREA                      
  WHEN @STATUSID = 'REGION' THEN REGION                      
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                      
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                      
  WHEN @STATUSID = 'TRADER' THEN TRADER                      
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                      
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                      
  WHEN @STATUSID = 'BROKER' THEN 'broker'                      
  ELSE 'I DONT KNOW '       
 END)      
      
      
      
      
CREATE TABLE #CLASSTBL_SAUDASUMMARY                              
(                              
 EXCHANGE VARCHAR(8),                              
 TRDTYPE  VARCHAR(10),                              
 PARTY_CODE VARCHAR(10),                              
 TRADEDATE VARCHAR(10),                              
 SCRIP_CD VARCHAR(12),                               
 SCRIP_NAME VARCHAR(100),                              
 SETT_NO VARCHAR(7),                              
 SETT_TYPE VARCHAR(3),                              
 BUYQTY INT,                               
 BUYAVGRATE MONEY,                              
 BUYAMOUNT MONEY,                               
 SELLQTY INT,                              
 SELLAVGRATE MONEY,                              
 SELLAMOUNT MONEY,                              
 NETQTY INT,                              
 NETAVGRATE MONEY,                              
 NetAmount MONEY,                              
 FLAG TINYINT,      
 LONG_NAME VARCHAR(100),                
 BRANCH_CD VARCHAR(20),                
 SUB_BROKER VARCHAR(20),                
 L_ADDRESS1 VARCHAR(100),                
 L_ADDRESS2 VARCHAR(100),                
 L_ADDRESS3 VARCHAR(100),                
L_CITY VARCHAR(50),                
 L_STATE VARCHAR(50),                
 L_ZIP VARCHAR(20),                
 MOBILE_PAGER VARCHAR(50),                
 RES_PHONE1 VARCHAR(100),                
 RES_PHONE2 VARCHAR(100),             
 OFF_PHONE1 VARCHAR(100)               
)                              
                              
----------------------------                              
-- NOW STARTING BSE CASH --                              
----------------------------                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO #CLASSTBL_SAUDASUMMARY                              
SELECT                               
 EXCHANGE = 'BSE CASH',                              
 TRDTYPE = '1. TRD',                              
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SCRIP_NAME,                              
 SETT_NO,                              
 SETT_TYPE,                              
 BUYQTY = SUM(PQTYTRD),                               
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                              
 BUYAMOUNT = SUM(PAMTTRD),                               
 SELLQTY = SUM(SQTYTRD),                              
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                              
 SELLAMOUNT = SUM(SAMTTRD) ,                              
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                              
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                              
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                              
 FLAG = 1,      
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),      
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('AC','AD')      
GROUP BY                               
 P.PARENTCODE,                              
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SCRIP_NAME,                              
 SETT_NO,                              
 SETT_TYPE                              
HAVING                              
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                               
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                              
                              
UNION                              
                              
SELECT                               
 EXCHANGE = 'BSE CASH',                              
 TRDTYPE = '2. DEL',                               
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                         
 SCRIP_CD,                               
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                              
 SETT_NO,                              
 SETT_TYPE,                 
 BUYQTY = SUM(PQTYDEL),                               
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                              
 BUYAMOUNT = SUM(PAMTDEL),                               
 SELLQTY = SUM(SQTYDEL),                              
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                              
 SELLAMOUNT = SUM(SAMTDEL),                              
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                         
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                              
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                              
 FLAG = 1,      
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),      
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('AC','AD')      
GROUP BY                               
 P.PARENTCODE,                              
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SCRIP_NAME,                              
 SETT_NO,                              
 SETT_TYPE                              
HAVING                              
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                               
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                              
                              
UNION                              
                              
SELECT                               
 EXCHANGE = 'BSE CASH',                              
 TRDTYPE = '3. LEV',                               
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD = 'ZZZZZZZZZZZZ',                               
SCRIP_NAME = '** LEVIES **',                              
 SETT_NO,                              
 SETT_TYPE,                              
 BUYQTY = 0,                               
 BUYAVGRATE = 0,                              
 BUYAMOUNT = 0,                               
 SELLQTY = 0,                              
 SELLAVGRATE = 0,                              
 SELLAMOUNT = 0,                              
 NETQTY = 0,                              
 NETAVGRATE = 0,                              
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                              
 FLAG = 2,                              
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),      
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('AC','AD')      
GROUP BY      
 P.PARENTCODE,      
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SETT_NO,                              
 SETT_TYPE                              
                              
----------------------------                              
-- NOW STARTING NSE CASH --                              
----------------------------                              
                              
                              
INSERT INTO #CLASSTBL_SAUDASUMMARY                              
SELECT                               
 EXCHANGE = 'NSE CASH',                              
 TRDTYPE = '1. TRD',                              
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                              
 SETT_NO,                              
 SETT_TYPE,                  
 BUYQTY = SUM(PQTYTRD),                               
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                              
 BUYAMOUNT = SUM(PAMTTRD),                               
 SELLQTY = SUM(SQTYTRD),                              
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                              
 SELLAMOUNT = SUM(SAMTTRD) ,                              
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                              
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                              
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                              
 FLAG = 1,      
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                           
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('A','X')      
GROUP BY      
 P.PARENTCODE,      
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SERIES,                              
 SETT_NO,                              
 SETT_TYPE                              
HAVING                              
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                              
                              
UNION                              
                              
SELECT                               
 EXCHANGE = 'NSE CASH',                              
 TRDTYPE = '2. DEL',                               
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                              
 SETT_NO,                              
 SETT_TYPE,                              
 BUYQTY = SUM(PQTYDEL),                               
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                              
 BUYAMOUNT = SUM(PAMTDEL),                               
 SELLQTY = SUM(SQTYDEL),                              
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                              
 SELLAMOUNT = SUM(SAMTDEL),                              
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                              
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                              
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                              
 FLAG = 1,      
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),      
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('A','X')      
GROUP BY      
 P.PARENTCODE,      
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD,                               
 SERIES,                              
 SETT_NO,                              
 SETT_TYPE                              
HAVING                              
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                               
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                              
      
UNION                              
                              
SELECT                               
 EXCHANGE = 'NSE CASH',                              
 TRDTYPE = '3. LEV',                               
 PARTY_CODE = P.PARENTCODE,                              
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SCRIP_CD = 'ZZZZZZZZZZZZ',                               
 SCRIP_NAME = '** LEVIES **',                              
 SETT_NO,                              
 SETT_TYPE,                              
 BUYQTY = 0,                               
 BUYAVGRATE = 0,                              
 BUYAMOUNT = 0,                               
 SELLQTY = 0,                              
 SELLAVGRATE = 0,                              
 SELLAMOUNT = 0,                              
 NETQTY = 0,                              
 NETAVGRATE = 0,                              
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                  
 FLAG = 2,      
 LONG_NAME='',      
 BRANCH_CD='',      
 SUB_BROKER='',      
 L_ADDRESS1='',      
 L_ADDRESS2='',      
 L_ADDRESS3='',      
 L_CITY='',      
 L_STATE='',      
 L_ZIP='',      
 MOBILE_PAGER='',      
 RES_PHONE1='',      
 RES_PHONE2='',      
 OFF_PHONE1=''      
FROM       
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),      
 #PARTY P (NOLOCK)      
WHERE       
 C.PARTY_CODE = P.PARTY_CODE      
 AND SAUDA_DATE >= @FROMDATE      
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'      
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)      
 AND C.SETT_TYPE NOT IN ('A','X')      
GROUP BY      
 P.PARENTCODE,      
 CONVERT(VARCHAR,SAUDA_DATE,103),                              
 SETT_NO,                              
 SETT_TYPE                                                    
      
-------------------------------                              
-- COMPLETED CALCULATION --                              
-------------------------------                              
                          
UPDATE       
 #CLASSTBL_SAUDASUMMARY      
SET       
 LONG_NAME = C1.LONG_NAME,      
 BRANCH_CD = C1.BRANCH_CD,      
 SUB_BROKER = C1.SUB_BROKER,      
 L_ADDRESS1 = C1.L_ADDRESS1,      
 L_ADDRESS2 = C1.L_ADDRESS2,      
 L_ADDRESS3 = C1.L_ADDRESS3,      
 L_CITY  = C1.L_CITY,      
 L_STATE  = C1.L_STATE,      
 L_ZIP  = C1.L_ZIP,      
 MOBILE_PAGER= C1.MOBILE_PAGER,      
 RES_PHONE1 = C1.RES_PHONE1,      
 RES_PHONE2 = C1.RES_PHONE2,      
 OFF_PHONE1 = C1.OFF_PHONE1      
FROM      
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)      
WHERE      
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE      
      
      
SELECT                               
 EXCHANGE,      
 TRDTYPE,      
 PARTY_CODE,      
 TRADEDATE,      
 SCRIP_CD,      
 SCRIP_NAME,      
 SETT_NO,      
 SETT_TYPE,      
 BUYQTY,      
 BUYAVGRATE,      
 BUYAMOUNT,      
 SELLQTY,      
 SELLAVGRATE,      
 SELLAMOUNT,      
 NETQTY,      
 NETAVGRATE,      
 NetAmount,      
 FLAG,      
 LONG_NAME,                
 BRANCH_CD,                
 SUB_BROKER,                
 L_ADDRESS1,                
 L_ADDRESS2,                
 L_ADDRESS3,                
 L_CITY,                
 L_STATE,                
 L_ZIP,                
 MOBILE_PAGER,                
 RES_PHONE1,                
 RES_PHONE2,                
 OFF_PHONE1                
FROM                  
 #CLASSTBL_SAUDASUMMARY (NOLOCK)      
ORDER BY                              
 PARTY_CODE,                              
 EXCHANGE,                              
 SETT_NO,                              
 SETT_TYPE,                              
 FLAG,                              
 SCRIP_NAME,                              
 TRDTYPE                              
                              
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY             
                              
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_BAK_04102017
-- --------------------------------------------------
    
              
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',            
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',             
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'               
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',               
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',               
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'               
              
              
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)             
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'              
              
              
              
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW]        
 (                                      
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @FROMPARTYCODE VARCHAR(10),              
 @TOPARTYCODE VARCHAR(10),              
 @FROMDATE VARCHAR(11),              
 @TODATE VARCHAR(11),              
 @SETT_TYPE VARCHAR(3),              
 @FROMCODE VARCHAR(15)='',              
 @TOCODE VARCHAR(15)='zzzzzzzzzz',              
 @RPT_BY VARCHAR(15)='BROKER'              
 )                                      
                                      
/*                                      
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                                     
*/                                      
                                      
AS                                      
              
IF @TOCODE = ''              
BEGIN              
 SET @TOCODE = 'zzzzzzzzzz'              
END              
              
              
SELECT              
 DISTINCT              
 PARTY_CODE,              
 PARENTCODE              
INTO               
 #PARTY              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)              
WHERE              
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE           
 AND (              
 CASE              
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY              
 WHEN @RPT_BY = 'REGION'  THEN REGION              
 WHEN @RPT_BY = 'AREA'  THEN AREA              
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD              
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER              
 WHEN @RPT_BY = 'TRADER'  THEN TRADER              
 ELSE PARTY_CODE              
  END)              
 BETWEEN @FROMCODE AND @TOCODE              
 AND @STATUSNAME = (              
 CASE               
  WHEN @STATUSID = 'AREA' THEN AREA                              
  WHEN @STATUSID = 'REGION' THEN REGION                              
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                              
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                              
  WHEN @STATUSID = 'TRADER' THEN TRADER                              
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                              
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                              
  WHEN @STATUSID = 'BROKER' THEN 'broker'                              
  ELSE 'I DONT KNOW '               
 END)              
              
              
              
              
CREATE TABLE #CLASSTBL_SAUDASUMMARY                                      
(                                      
 EXCHANGE VARCHAR(8),                                      
 TRDTYPE  VARCHAR(10),                                      
 PARTY_CODE VARCHAR(10),                                      
 TRADEDATE VARCHAR(10),                                      
 SCRIP_CD VARCHAR(12),                                       
 SCRIP_NAME VARCHAR(100),                                      
 SETT_NO VARCHAR(7),                                      
 SETT_TYPE VARCHAR(3),                
 BUYQTY INT,                                       
 BUYAVGRATE MONEY,                                      
 BUYAMOUNT MONEY,                                       
 SELLQTY INT,                                      
 SELLAVGRATE MONEY,                                      
 SELLAMOUNT MONEY,                                      
 NETQTY INT,                    
 NETAVGRATE MONEY,                                      
 NetAmount MONEY,                                      
 FLAG TINYINT,              
 LONG_NAME VARCHAR(100),                        
 BRANCH_CD VARCHAR(20),                        
 SUB_BROKER VARCHAR(20),                        
 L_ADDRESS1 VARCHAR(100),                        
 L_ADDRESS2 VARCHAR(100),                        
 L_ADDRESS3 VARCHAR(100),                        
L_CITY VARCHAR(50),                        
 L_STATE VARCHAR(50),                        
 L_ZIP VARCHAR(20),                        
 MOBILE_PAGER VARCHAR(50),                        
 RES_PHONE1 VARCHAR(100),                        
 RES_PHONE2 VARCHAR(100),                     
 OFF_PHONE1 VARCHAR(100)                       
)                                      
                         
          
--------FOR NSE OPTIMIZATION     
    
SELECT DISTINCT SETT_NO INTO #SETT FROM ANAND1.MSAJAG.DBO.SETT_MST WHERE Start_date >=@FROMDATE  AND Start_date <= @TODATE + ' 23:59'          
AND SETT_TYPE IN ('N','W')    
                       
----------------------------                                      
-- NOW STARTING BSE CASH (LIVE) --                                      
----------------------------                                      
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                   
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                 
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                         
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                 
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                                       
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                      
 FLAG = 2,                                      
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                      
                                      
-------------------------------------                                      
-- NOW STARTING NSE CASH (LIVE) --                                      
-------------------------------------                                  
           
                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                                   
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE        
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,    
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                   
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
              
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
 SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,              
 LONG_NAME='',              
 BRANCH_CD='',
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                                            
              
--declare @FROMDATE varchar(11)
--set @FROMDATE='Sep 01 2012'

if (Convert(datetime,@FROMDATE,103)<'2013-04-01')                                 
begin 





--- samit changes   

----------------------------                                      
-- NOW STARTING BSE CASH (Archival) --                                      
----------------------------                                      
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ABCSOBOARCHIVAL.BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                   
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                 
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                         
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                 
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ABCSOBOARCHIVAL.BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                                       
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                      
 FLAG = 2,                                      
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ABCSOBOARCHIVAL.BSEDB_AB.DBO.CMBILLVALAN C WITH (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                      
                                      
           
---------------------------------------                                     
-- NOW STARTING NSE CASH (ARCHIVE)--                                      
---------------------------------------                                      
                                      
                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                                   
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0              
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
              
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',         
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
 SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                
        
end
--- samit changes END HERE.       

-------------------------------                                      
-- COMPLETED CALCULATION --                                      
-------------------------------       
                           
UPDATE               
 #CLASSTBL_SAUDASUMMARY              
SET               
 LONG_NAME = C1.LONG_NAME,              
 BRANCH_CD = C1.BRANCH_CD,              
 SUB_BROKER = C1.SUB_BROKER,              
 L_ADDRESS1 = C1.L_ADDRESS1,              
 L_ADDRESS2 = C1.L_ADDRESS2,              
 L_ADDRESS3 = C1.L_ADDRESS3,              
 L_CITY  = C1.L_CITY,              
 L_STATE  = C1.L_STATE,              
 L_ZIP  = C1.L_ZIP,              
 MOBILE_PAGER= C1.MOBILE_PAGER,              
 RES_PHONE1 = C1.RES_PHONE1,              
 RES_PHONE2 = C1.RES_PHONE2,              
 OFF_PHONE1 = C1.OFF_PHONE1              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)              
WHERE              
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE              
              
              
SELECT                                       
 EXCHANGE,              
 TRDTYPE,              
 PARTY_CODE,              
 TRADEDATE,              
 SCRIP_CD,              
 SCRIP_NAME,              
 SETT_NO,              
 SETT_TYPE,              
 BUYQTY,              
 BUYAVGRATE,              
 BUYAMOUNT,              
 SELLQTY,              
 SELLAVGRATE,              
 SELLAMOUNT,              
 NETQTY,              
 NETAVGRATE,              
 NetAmount,              
 FLAG,              
 LONG_NAME,                        
 BRANCH_CD,                        
 SUB_BROKER,                        
 L_ADDRESS1,                        
 L_ADDRESS2,                        
 L_ADDRESS3,                        
 L_CITY,                        
 L_STATE,                        
 L_ZIP,                        
 MOBILE_PAGER,                        
 RES_PHONE1,                        
 RES_PHONE2,   
 OFF_PHONE1                        
FROM                          
 #CLASSTBL_SAUDASUMMARY (NOLOCK)              
ORDER BY                                      
 PARTY_CODE,                                      
 EXCHANGE,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 FLAG,                                      
 SCRIP_NAME,                                      
 TRDTYPE                           
                                      
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                     
                                      
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_BAK1606
-- --------------------------------------------------

          
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',        
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',         
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'           
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',           
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',           
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'           
          
          
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)         
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'          
          
          
          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_BAK1606]    
 (                                  
 @STATUSID VARCHAR(25),          
 @STATUSNAME VARCHAR(25),          
 @FROMPARTYCODE VARCHAR(10),          
 @TOPARTYCODE VARCHAR(10),          
 @FROMDATE VARCHAR(11),          
 @TODATE VARCHAR(11),          
 @SETT_TYPE VARCHAR(3),          
 @FROMCODE VARCHAR(15)='',          
 @TOCODE VARCHAR(15)='zzzzzzzzzz',          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                  
                                  
/*                                  
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                                 
*/                                  
                                  
AS                                  
          
IF @TOCODE = ''          
BEGIN          
 SET @TOCODE = 'zzzzzzzzzz'          
END          
          
          
SELECT          
 DISTINCT          
 PARTY_CODE,          
 PARENTCODE          
INTO           
 #PARTY          
FROM          
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)          
WHERE          
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE       
 AND (          
 CASE          
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY          
 WHEN @RPT_BY = 'REGION'  THEN REGION          
 WHEN @RPT_BY = 'AREA'  THEN AREA          
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD          
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER          
 WHEN @RPT_BY = 'TRADER'  THEN TRADER          
 ELSE PARTY_CODE          
  END)          
 BETWEEN @FROMCODE AND @TOCODE          
 AND @STATUSNAME = (          
 CASE           
  WHEN @STATUSID = 'AREA' THEN AREA                          
  WHEN @STATUSID = 'REGION' THEN REGION                          
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                          
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                          
  WHEN @STATUSID = 'TRADER' THEN TRADER                          
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                          
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                          
  WHEN @STATUSID = 'BROKER' THEN 'broker'                          
  ELSE 'I DONT KNOW '           
 END)          
          
          
          
          
CREATE TABLE #CLASSTBL_SAUDASUMMARY                                  
(                                  
 EXCHANGE VARCHAR(8),                                  
 TRDTYPE  VARCHAR(10),                                  
 PARTY_CODE VARCHAR(10),                                  
 TRADEDATE VARCHAR(10),                                  
 SCRIP_CD VARCHAR(12),                                   
 SCRIP_NAME VARCHAR(100),                                  
 SETT_NO VARCHAR(7),                                  
 SETT_TYPE VARCHAR(3),                                  
 BUYQTY INT,                                   
 BUYAVGRATE MONEY,                                  
 BUYAMOUNT MONEY,                                   
 SELLQTY INT,                                  
 SELLAVGRATE MONEY,                                  
 SELLAMOUNT MONEY,                                  
 NETQTY INT,                
 NETAVGRATE MONEY,                                  
 NetAmount MONEY,                                  
 FLAG TINYINT,          
 LONG_NAME VARCHAR(100),                    
 BRANCH_CD VARCHAR(20),                    
 SUB_BROKER VARCHAR(20),                    
 L_ADDRESS1 VARCHAR(100),                    
 L_ADDRESS2 VARCHAR(100),                    
 L_ADDRESS3 VARCHAR(100),                    
L_CITY VARCHAR(50),                    
 L_STATE VARCHAR(50),                    
 L_ZIP VARCHAR(20),                    
 MOBILE_PAGER VARCHAR(50),                    
 RES_PHONE1 VARCHAR(100),                    
 RES_PHONE2 VARCHAR(100),                 
 OFF_PHONE1 VARCHAR(100)                   
)                                  
                                  
----------------------------                                  
-- NOW STARTING BSE CASH (LIVE) --                                  
----------------------------                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO #CLASSTBL_SAUDASUMMARY                                  
SELECT                                   
 EXCHANGE = 'BSE CASH',                                  
 TRDTYPE = '1. TRD',                                  
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME,                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = SUM(PQTYTRD),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTTRD),                                   
 SELLQTY = SUM(SQTYTRD),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTTRD) ,                                  
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                  
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('AC','AD')          
GROUP BY                                   
 P.PARENTCODE,                                  
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME,                                  
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                   
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                  
                                  
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'BSE CASH',                                  
 TRDTYPE = '2. DEL',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                             
 SCRIP_CD,                                   
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                  
 SETT_NO,                                  
 SETT_TYPE,                     
 BUYQTY = SUM(PQTYDEL),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTDEL),                                   
 SELLQTY = SUM(SQTYDEL),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTDEL),                                  
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                             
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('AC','AD')          
GROUP BY                                   
 P.PARENTCODE,                                  
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME,                                  
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                   
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                  
                                  
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'BSE CASH',                                  
 TRDTYPE = '3. LEV',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                   
SCRIP_NAME = '** LEVIES **',                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = 0,                                   
 BUYAVGRATE = 0,                                  
 BUYAMOUNT = 0,                                   
 SELLQTY = 0,                                  
 SELLAVGRATE = 0,                                  
 SELLAMOUNT = 0,                                  
 NETQTY = 0,                                  
 NETAVGRATE = 0,                                  
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                  
 FLAG = 2,                                  
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('AC','AD')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SETT_NO,                                  
 SETT_TYPE                                  
                                  
-------------------------------------                                  
-- NOW STARTING NSE CASH (LIVE) --                                  
-------------------------------------                              
       
                                  
INSERT INTO #CLASSTBL_SAUDASUMMARY                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '1. TRD',                                  
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                  
 SETT_NO,                                  
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTTRD),                                   
 SELLQTY = SUM(SQTYTRD),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTTRD) ,                                  
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                  
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                               
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SERIES,                                  
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                    
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                  
                                  
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '2. DEL',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = SUM(PQTYDEL),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTDEL),                                   
 SELLQTY = SUM(SQTYDEL),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTDEL),                                  
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                  
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SERIES,                                  
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                   
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                  
          
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '3. LEV',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                   
 SCRIP_NAME = '** LEVIES **',                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = 0,                                   
 BUYAVGRATE = 0,                                  
 BUYAMOUNT = 0,                                   
 SELLQTY = 0,                                  
 SELLAVGRATE = 0,                                  
 SELLAMOUNT = 0,                                  
 NETQTY = 0,                                  
 NETAVGRATE = 0,                                  
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                      
 FLAG = 2,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SETT_NO,                                  
 SETT_TYPE                                                        
          
                               
--- samit changes           
---------------------------------------                                 
-- NOW STARTING NSE CASH (ARCHIVE)--                                  
---------------------------------------                                  
                                  
                                  
INSERT INTO #CLASSTBL_SAUDASUMMARY                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '1. TRD',                                  
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                  
 SETT_NO,                                  
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTTRD),                                   
 SELLQTY = SUM(SQTYTRD),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTTRD) ,                                  
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                  
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                               
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SERIES,                                  
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                    
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                  
                                  
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '2. DEL',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = SUM(PQTYDEL),                                   
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                  
 BUYAMOUNT = SUM(PAMTDEL),                                   
 SELLQTY = SUM(SQTYDEL),                                  
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                  
 SELLAMOUNT = SUM(SAMTDEL),                                  
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                  
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                  
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                  
 FLAG = 1,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD,                                   
 SERIES,            
 SETT_NO,                                  
 SETT_TYPE                                  
HAVING                                  
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                   
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                  
          
UNION                                  
                                  
SELECT                                   
 EXCHANGE = 'NSE CASH',                                  
 TRDTYPE = '3. LEV',                                   
 PARTY_CODE = P.PARENTCODE,                                  
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                   
 SCRIP_NAME = '** LEVIES **',                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 BUYQTY = 0,                                   
 BUYAVGRATE = 0,                                  
 BUYAMOUNT = 0,                                   
 SELLQTY = 0,                                  
 SELLAVGRATE = 0,                                  
 SELLAMOUNT = 0,                                  
 NETQTY = 0,                                  
 NETAVGRATE = 0,                                  
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                      
 FLAG = 2,          
 LONG_NAME='',          
 BRANCH_CD='',          
 SUB_BROKER='',          
 L_ADDRESS1='',          
 L_ADDRESS2='',          
 L_ADDRESS3='',          
 L_CITY='',          
 L_STATE='',          
 L_ZIP='',          
 MOBILE_PAGER='',          
 RES_PHONE1='',          
 RES_PHONE2='',          
 OFF_PHONE1=''          
FROM           
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),          
 #PARTY P (NOLOCK)          
WHERE           
 C.PARTY_CODE = P.PARTY_CODE          
 AND SAUDA_DATE >= @FROMDATE          
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'          
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)          
 AND C.SETT_TYPE NOT IN ('A','X')          
GROUP BY          
 P.PARENTCODE,          
 CONVERT(VARCHAR,SAUDA_DATE,103),                                  
 SETT_NO,                                  
 SETT_TYPE            
    
   
--- samit changes END HERE.    
-------------------------------                                  
-- COMPLETED CALCULATION --                                  
-------------------------------   
                       
UPDATE           
 #CLASSTBL_SAUDASUMMARY          
SET           
 LONG_NAME = C1.LONG_NAME,          
 BRANCH_CD = C1.BRANCH_CD,          
 SUB_BROKER = C1.SUB_BROKER,          
 L_ADDRESS1 = C1.L_ADDRESS1,          
 L_ADDRESS2 = C1.L_ADDRESS2,          
 L_ADDRESS3 = C1.L_ADDRESS3,          
 L_CITY  = C1.L_CITY,          
 L_STATE  = C1.L_STATE,          
 L_ZIP  = C1.L_ZIP,          
 MOBILE_PAGER= C1.MOBILE_PAGER,          
 RES_PHONE1 = C1.RES_PHONE1,          
 RES_PHONE2 = C1.RES_PHONE2,          
 OFF_PHONE1 = C1.OFF_PHONE1          
FROM          
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)          
WHERE          
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
          
SELECT                                   
 EXCHANGE,          
 TRDTYPE,          
 PARTY_CODE,          
 TRADEDATE,          
 SCRIP_CD,          
 SCRIP_NAME,          
 SETT_NO,          
 SETT_TYPE,          
 BUYQTY,          
 BUYAVGRATE,          
 BUYAMOUNT,          
 SELLQTY,          
 SELLAVGRATE,          
 SELLAMOUNT,          
 NETQTY,          
 NETAVGRATE,          
 NetAmount,          
 FLAG,          
 LONG_NAME,                    
 BRANCH_CD,                    
 SUB_BROKER,                    
 L_ADDRESS1,                    
 L_ADDRESS2,                    
 L_ADDRESS3,                    
 L_CITY,                    
 L_STATE,                    
 L_ZIP,                    
 MOBILE_PAGER,                    
 RES_PHONE1,                    
 RES_PHONE2,                    
 OFF_PHONE1                    
FROM                      
 #CLASSTBL_SAUDASUMMARY (NOLOCK)          
ORDER BY                                  
 PARTY_CODE,                                  
 EXCHANGE,                                  
 SETT_NO,                                  
 SETT_TYPE,                                  
 FLAG,                                  
 SCRIP_NAME,                                  
 TRDTYPE                       
                                  
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                 
                                  
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_SA
-- --------------------------------------------------
        
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',      
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',       
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'         
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',         
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',         
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'         
        
        
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)       
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'        
        
        
        
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW_SA]  
 (                                
 @STATUSID VARCHAR(25),        
 @STATUSNAME VARCHAR(25),        
 @FROMPARTYCODE VARCHAR(10),        
 @TOPARTYCODE VARCHAR(10),        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @SETT_TYPE VARCHAR(3),        
 @FROMCODE VARCHAR(15)='',        
 @TOCODE VARCHAR(15)='zzzzzzzzzz',        
 @RPT_BY VARCHAR(15)='BROKER'        
 )                                
                                
/*                                
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                               
*/                                
                                
AS                                
        
IF @TOCODE = ''        
BEGIN        
 SET @TOCODE = 'zzzzzzzzzz'        
END        
        
        
SELECT        
 DISTINCT        
 PARTY_CODE,        
 PARENTCODE        
INTO         
 #PARTY        
FROM        
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)        
WHERE        
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE     
 AND (        
 CASE        
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY        
 WHEN @RPT_BY = 'REGION'  THEN REGION        
 WHEN @RPT_BY = 'AREA'  THEN AREA        
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD        
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER        
 WHEN @RPT_BY = 'TRADER'  THEN TRADER        
 ELSE PARTY_CODE        
  END)        
 BETWEEN @FROMCODE AND @TOCODE        
 AND @STATUSNAME = (        
 CASE         
  WHEN @STATUSID = 'AREA' THEN AREA                        
  WHEN @STATUSID = 'REGION' THEN REGION                        
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                        
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                        
  WHEN @STATUSID = 'TRADER' THEN TRADER                        
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                        
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                        
  WHEN @STATUSID = 'BROKER' THEN 'broker'                        
  ELSE 'I DONT KNOW '         
 END)        
        
        
        
        
CREATE TABLE #CLASSTBL_SAUDASUMMARY                                
(                                
 EXCHANGE VARCHAR(8),                                
 TRDTYPE  VARCHAR(10),                                
 PARTY_CODE VARCHAR(10),                                
 TRADEDATE VARCHAR(10),                                
 SCRIP_CD VARCHAR(12),                                 
 SCRIP_NAME VARCHAR(100),                                
 SETT_NO VARCHAR(7),                                
 SETT_TYPE VARCHAR(3),                                
 BUYQTY INT,                                 
 BUYAVGRATE MONEY,                                
 BUYAMOUNT MONEY,                                 
 SELLQTY INT,                                
 SELLAVGRATE MONEY,                                
 SELLAMOUNT MONEY,                                
 NETQTY INT,                                
 NETAVGRATE MONEY,                                
 NetAmount MONEY,                                
 FLAG TINYINT,        
 LONG_NAME VARCHAR(100),                  
 BRANCH_CD VARCHAR(20),                  
 SUB_BROKER VARCHAR(20),                  
 L_ADDRESS1 VARCHAR(100),                  
 L_ADDRESS2 VARCHAR(100),                  
 L_ADDRESS3 VARCHAR(100),                  
L_CITY VARCHAR(50),                  
 L_STATE VARCHAR(50),                  
 L_ZIP VARCHAR(20),                  
 MOBILE_PAGER VARCHAR(50),                  
 RES_PHONE1 VARCHAR(100),                  
 RES_PHONE2 VARCHAR(100),               
 OFF_PHONE1 VARCHAR(100)                 
)                                
                                
----------------------------                                
-- NOW STARTING BSE CASH (LIVE) --                                
----------------------------                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO #CLASSTBL_SAUDASUMMARY                                
SELECT                                 
 EXCHANGE = 'BSE CASH',                                
 TRDTYPE = '1. TRD',                                
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME,                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = SUM(PQTYTRD),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTTRD),                                 
 SELLQTY = SUM(SQTYTRD),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTTRD) ,                                
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('AC','AD')        
GROUP BY                                 
 P.PARENTCODE,                                
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME,                                
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                 
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                
                                
UNION                                
                                
SELECT                                 
 EXCHANGE = 'BSE CASH',                                
 TRDTYPE = '2. DEL',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                           
 SCRIP_CD,                                 
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                
 SETT_NO,                                
 SETT_TYPE,                   
 BUYQTY = SUM(PQTYDEL),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTDEL),                                 
 SELLQTY = SUM(SQTYDEL),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTDEL),                                
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                           
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('AC','AD')        
GROUP BY                                 
 P.PARENTCODE,                                
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME,                                
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                 
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                
                                
UNION                                
                                
SELECT                                 
 EXCHANGE = 'BSE CASH',                                
 TRDTYPE = '3. LEV',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                 
SCRIP_NAME = '** LEVIES **',                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = 0,                                 
 BUYAVGRATE = 0,                                
 BUYAMOUNT = 0,                                 
 SELLQTY = 0,                                
 SELLAVGRATE = 0,                                
 SELLAMOUNT = 0,                                
 NETQTY = 0,                                
 NETAVGRATE = 0,                                
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                
 FLAG = 2,                                
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('AC','AD')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SETT_NO,                                
 SETT_TYPE                                
                                
-------------------------------------                                
-- NOW STARTING NSE CASH (LIVE) --                                
-------------------------------------                            
     
                                
INSERT INTO #CLASSTBL_SAUDASUMMARY                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '1. TRD',                                
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                
 SETT_NO,                                
 SETT_TYPE,                    
 BUYQTY = SUM(PQTYTRD),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTTRD),                                 
 SELLQTY = SUM(SQTYTRD),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTTRD) ,                                
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                             
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SERIES,                                
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                  
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                
                                
UNION                                
                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '2. DEL',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = SUM(PQTYDEL),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTDEL),                                 
 SELLQTY = SUM(SQTYDEL),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTDEL),                                
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SERIES,                                
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                 
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                
        
UNION                                
                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '3. LEV',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                 
 SCRIP_NAME = '** LEVIES **',                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = 0,                                 
 BUYAVGRATE = 0,                                
 BUYAMOUNT = 0,                                 
 SELLQTY = 0,                                
 SELLAVGRATE = 0,                                
 SELLAMOUNT = 0,                                
 NETQTY = 0,                                
 NETAVGRATE = 0,                                
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                    
 FLAG = 2,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SETT_NO,                                
 SETT_TYPE                                                      
        
                             
--- samit changes         
---------------------------------------                               
-- NOW STARTING NSE CASH (ARCHIVE)--                                
---------------------------------------                                
                                
                                
INSERT INTO #CLASSTBL_SAUDASUMMARY                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '1. TRD',                                
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                
 SETT_NO,                                
 SETT_TYPE,                    
 BUYQTY = SUM(PQTYTRD),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTTRD),                                 
 SELLQTY = SUM(SQTYTRD),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTTRD) ,                                
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                             
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SERIES,                                
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                  
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                
                                
UNION                                
                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '2. DEL',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = SUM(PQTYDEL),                                 
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                
 BUYAMOUNT = SUM(PAMTDEL),                                 
 SELLQTY = SUM(SQTYDEL),                                
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                
 SELLAMOUNT = SUM(SAMTDEL),                                
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                
 FLAG = 1,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD,                                 
 SERIES,          
 SETT_NO,                                
 SETT_TYPE                                
HAVING                                
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                 
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                
        
UNION                                
                                
SELECT                                 
 EXCHANGE = 'NSE CASH',                                
 TRDTYPE = '3. LEV',                                 
 PARTY_CODE = P.PARENTCODE,                                
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                 
 SCRIP_NAME = '** LEVIES **',                                
 SETT_NO,                                
 SETT_TYPE,                                
 BUYQTY = 0,                                 
 BUYAVGRATE = 0,                                
 BUYAMOUNT = 0,                                 
 SELLQTY = 0,                                
 SELLAVGRATE = 0,                                
 SELLAMOUNT = 0,                                
 NETQTY = 0,                                
 NETAVGRATE = 0,                                
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                    
 FLAG = 2,        
 LONG_NAME='',        
 BRANCH_CD='',        
 SUB_BROKER='',        
 L_ADDRESS1='',        
 L_ADDRESS2='',        
 L_ADDRESS3='',        
 L_CITY='',        
 L_STATE='',        
 L_ZIP='',        
 MOBILE_PAGER='',        
 RES_PHONE1='',        
 RES_PHONE2='',        
 OFF_PHONE1=''        
FROM         
 ACDLCM.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),        
 #PARTY P (NOLOCK)        
WHERE         
 C.PARTY_CODE = P.PARTY_CODE        
 AND SAUDA_DATE >= @FROMDATE        
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)        
 AND C.SETT_TYPE NOT IN ('A','X')        
GROUP BY        
 P.PARENTCODE,        
 CONVERT(VARCHAR,SAUDA_DATE,103),                                
 SETT_NO,                                
 SETT_TYPE          
  
 
--- samit changes END HERE.  
-------------------------------                                
-- COMPLETED CALCULATION --                                
------------------------------- 
                     
UPDATE         
 #CLASSTBL_SAUDASUMMARY        
SET         
 LONG_NAME = C1.LONG_NAME,        
 BRANCH_CD = C1.BRANCH_CD,        
 SUB_BROKER = C1.SUB_BROKER,        
 L_ADDRESS1 = C1.L_ADDRESS1,        
 L_ADDRESS2 = C1.L_ADDRESS2,        
 L_ADDRESS3 = C1.L_ADDRESS3,        
 L_CITY  = C1.L_CITY,        
 L_STATE  = C1.L_STATE,        
 L_ZIP  = C1.L_ZIP,        
 MOBILE_PAGER= C1.MOBILE_PAGER,        
 RES_PHONE1 = C1.RES_PHONE1,        
 RES_PHONE2 = C1.RES_PHONE2,        
 OFF_PHONE1 = C1.OFF_PHONE1        
FROM        
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)        
WHERE        
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE        
        
        
SELECT                                 
 EXCHANGE,        
 TRDTYPE,        
 PARTY_CODE,        
 TRADEDATE,        
 SCRIP_CD,        
 SCRIP_NAME,        
 SETT_NO,        
 SETT_TYPE,        
 BUYQTY,        
 BUYAVGRATE,        
 BUYAMOUNT,        
 SELLQTY,        
 SELLAVGRATE,        
 SELLAMOUNT,        
 NETQTY,        
 NETAVGRATE,        
 NetAmount,        
 FLAG,        
 LONG_NAME,                  
 BRANCH_CD,                  
 SUB_BROKER,                  
 L_ADDRESS1,                  
 L_ADDRESS2,                  
 L_ADDRESS3,                  
 L_CITY,                  
 L_STATE,                  
 L_ZIP,                  
 MOBILE_PAGER,                  
 RES_PHONE1,                  
 RES_PHONE2,                  
 OFF_PHONE1                  
FROM                    
 #CLASSTBL_SAUDASUMMARY (NOLOCK)        
ORDER BY                                
 PARTY_CODE,                                
 EXCHANGE,                                
 SETT_NO,                                
 SETT_TYPE,                                
 FLAG,                                
 SCRIP_NAME,                                
 TRDTYPE                     
                                
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY               
                                
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_devang
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_CASHPRINT_devang    
(                          
@BRANCHNAME  VARCHAR(25),        
@STATUSID VARCHAR(25),                  
 @STATUSNAME VARCHAR(25),                  
 @FROMPARTYCODE VARCHAR(10),                          
 @TOPARTYCODE VARCHAR(10),                          
 @FROMDATE VARCHAR(11),                          
 @TODATE VARCHAR(11),                    
 @SETT_TYPE VARCHAR(3)                      
)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'M888', 'M888', 'NOV  1 2008', 'NOV  7 2008' ,'%'                         
*/                          
                          
AS                          
                          
CREATE TABLE #CLASSTBL_SAUDASUMMARY                          
(                          
 EXCHANGE VARCHAR(8),                          
 TRDTYPE  VARCHAR(10),                          
 PARTY_CODE VARCHAR(10),                          
 TRADEDATE VARCHAR(10),                          
 SCRIP_CD VARCHAR(12),                           
 SCRIP_NAME VARCHAR(100),                          
 SETT_NO VARCHAR(7),                          
 SETT_TYPE VARCHAR(3),                          
 BUYQTY INT,                           
 BUYAVGRATE MONEY,                          
 BUYAMOUNT MONEY,                           
 SELLQTY INT,                          
 SELLAVGRATE MONEY,                          
 SELLAMOUNT MONEY,                          
 NETQTY INT,                          
 NETAVGRATE MONEY,                          
 NETAMOUNT MONEY,                          
 FLAG TINYINT                          
)                          
                          
----------------------------                          
-- NOW STARTING BSE CASH --                          
----------------------------                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'        
--AND Branch_cd = @BRANCHNAME                        
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                           
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                          
                          
UNION                          
                      
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                 
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),            
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
--AND Branch_cd = @BRANCHNAME      
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
--AND Branch_cd = @BRANCHNAME      
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                          
                          
----------------------------                          
-- NOW STARTING NSE CASH --                          
----------------------------                          
                          
                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                    
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM anand1.MSAJAG.DBO.CMBILLVALAN                           
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
--AND Branch_cd = @BRANCHNAME      
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                   
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM anand1.MSAJAG.DBO.CMBILLVALAN                           
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
--AND Branch_cd = @BRANCHNAME      
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                          
          UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
 SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                  
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                            
 FLAG = 2                          
FROM anand1.MSAJAG.DBO.CMBILLVALAN                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'               
--AND Branch_cd = @BRANCHNAME      
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                          
                          
-------------------------------                          
-- COMPLETED CALCULATION --                          
-------------------------------                          
                      
SELECT                           
 C.*,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 #CLASSTBL_SAUDASUMMARY C                          
 INNER JOIN                          
 ANAND.Pradnya.dbo.TBL_ECNCASH C1                       
 ON (C.PARTY_CODE = C1.PARTY_CODE)   
WHERE                           
 C.EXCHANGE = 'NSE CASH'                      
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                  
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)         
            ELSE 'I DONT KNOW ' END)                  
AND C.SETT_TYPE NOT IN ('A','X')                
UNION                          
SELECT                           
 C.*,                           
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 #CLASSTBL_SAUDASUMMARY C                          
 INNER JOIN                          
 ANAND.Pradnya.dbo.TBL_ECNCASH C1                       
 ON (C.PARTY_CODE = C1.PARTY_CODE)   
WHERE                           
 C.EXCHANGE = 'BSE CASH'                     
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                  
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)                   
            ELSE 'I DONT KNOW ' END)                   
AND C.SETT_TYPE NOT IN ('AC','AD')                
ORDER BY                          
 C.PARTY_CODE,                          
 C.EXCHANGE,                          
 C.SETT_NO,                          
 C.SETT_TYPE,                          
 C.FLAG,                          
 C.SCRIP_NAME,                          
 C.TRDTYPE                          
                          
TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                          
                          
DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_dh
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_CASHPRINT_dh          
(            
 @FROMPARTYCODE VARCHAR(10),                      
 @TOPARTYCODE VARCHAR(10),                      
 @FROMDATE VARCHAR(11),                      
 @TODATE VARCHAR(11)                
                   
)                      
                      
/*                      
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'M888', 'M888', 'NOV  1 2008', 'NOV  7 2008' ,'%'                     
*/                      
                      
AS                      
                      
                      
----------------------------                      
-- NOW STARTING BSE CASH --                      
----------------------------                      
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
INSERT INTO tbldkm_sauda_summary_cm_1                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '1. TRD',                      
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTTRD),                       
 SELLQTY = SUM(SQTYTRD),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTTRD) ,                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                      
 FLAG = 1                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '2. DEL',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                      
 SETT_NO,                      
 SETT_TYPE,         
 BUYQTY = SUM(PQTYDEL),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTDEL),                       
 SELLQTY = SUM(SQTYDEL),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTDEL),                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                      
 FLAG = 1                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'BSE CASH',                      
 TRDTYPE = '3. LEV',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                       
SCRIP_NAME = '** LEVIES **',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = 0,                       
 BUYAVGRATE = 0,                      
 BUYAMOUNT = 0,                       
 SELLQTY = 0,                      
 SELLAVGRATE = 0,                      
 SELLAMOUNT = 0,                      
 NETQTY = 0,                      
 NETAVGRATE = 0,                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                      
 FLAG = 2                      
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SETT_NO,                      
 SETT_TYPE                      
                      
----------------------------                      
-- NOW STARTING NSE CASH --                      
----------------------------                      
                      
                      
INSERT INTO tbldkm_sauda_summary_cm_1                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '1. TRD',                      
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYTRD),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTTRD),                       
 SELLQTY = SUM(SQTYTRD),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTTRD) ,                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                      
 FLAG = 1                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                       
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE           
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SERIES,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                      
                      
UNION                      
                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '2. DEL',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = SUM(PQTYDEL),                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                      
 BUYAMOUNT = SUM(PAMTDEL),                       
 SELLQTY = SUM(SQTYDEL),                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                      
 SELLAMOUNT = SUM(SAMTDEL),                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                      
 FLAG = 1                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                       
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD,                       
 SERIES,                      
 SETT_NO,                      
 SETT_TYPE                      
HAVING                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                      
          UNION                      
                      
SELECT                       
 EXCHANGE = 'NSE CASH',                      
 TRDTYPE = '3. LEV',                       
 PARTY_CODE,                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                       
 SCRIP_NAME = '** LEVIES **',                      
 SETT_NO,                      
 SETT_TYPE,                      
 BUYQTY = 0,                       
 BUYAVGRATE = 0,                      
 BUYAMOUNT = 0,                       
 SELLQTY = 0,                      
 SELLAVGRATE = 0,                      
 SELLAMOUNT = 0,                      
 NETQTY = 0,                      
 NETAVGRATE = 0,                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                        
 FLAG = 2                      
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN                      
WHERE PARTY_CODE >= @FROMPARTYCODE                      
AND PARTY_CODE <= @TOPARTYCODE                      
AND SAUDA_DATE >= @FROMDATE                      
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                      
GROUP BY                       
 PARTY_CODE,                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                      
 SETT_NO,                      
 SETT_TYPE     




                                       
-------------------------------                      
-- COMPLETED CALCULATION --                      
-------------------------------                      
                  
SELECT                       
 C.*,        
 C1.SHORT_NAME,        
 C1.BRANCH_CD,        
 C1.SUB_BROKER,        
 C1.L_ADDRESS1,        
 C1.L_ADDRESS2,        
 C1.L_ADDRESS3,        
 C1.L_CITY,        
 C1.L_STATE,        
 C1.L_ZIP,        
 C1.MOBILE_PAGER,        
 C1.RES_PHONE1,        
 C1.RES_PHONE2,        
 C1.OFF_PHONE1        
FROM          
 tbldkm_sauda_summary_cm_1 C                      
 INNER JOIN                      
ANAND.Pradnya.dbo.TBL_ECNCASH C1                         
 ON (C.PARTY_CODE = C1.PARTY_CODE)     
WHERE                       
 C.EXCHANGE = 'NSE CASH'                  
                          
AND C.SETT_TYPE NOT IN ('A','X')            
UNION                      
SELECT                       
 C.*,                       
 C1.SHORT_NAME,        
 C1.BRANCH_CD,        
 C1.SUB_BROKER,        
 C1.L_ADDRESS1,        
 C1.L_ADDRESS2,        
 C1.L_ADDRESS3,        
 C1.L_CITY,        
 C1.L_STATE,        
 C1.L_ZIP,        
 C1.MOBILE_PAGER,        
 C1.RES_PHONE1,        
 C1.RES_PHONE2,        
 C1.OFF_PHONE1        
FROM                       
 tbldkm_sauda_summary_cm_1 C                      
 INNER JOIN                      
ANAND.Pradnya.dbo.TBL_ECNCASH C1                         
 ON (C.PARTY_CODE = C1.PARTY_CODE)     
WHERE                       
 C.EXCHANGE = 'BSE CASH'                 
              
AND C.SETT_TYPE NOT IN ('AC','AD')            
ORDER BY                      
 C.PARTY_CODE,                      
 C.EXCHANGE,                      
 C.SETT_NO,                      
 C.SETT_TYPE,                      
 C.FLAG,                      
 C.SCRIP_NAME,                      
 C.TRDTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_DKM_NEW
-- --------------------------------------------------
    
              
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0',            
--@TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%',             
--@FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'               
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = 'p187',               
--@TOPARTYCODE = 'p187', @FROMDATE = 'Apr  1 2011', @TODATE = 'Jun 30 2011',               
--@SETT_TYPE = '%',@FROMCODE = '%', @TOCODE = '%',@RPT_BY = 'broker'               
              
              
--Select * from bsedb_ab.dbo.cmbillvalan with (nolock)             
--where Sauda_date between 'apr  1 2011' and 'jun 30 2011 23:59' and Party_code = 'p187'              
              
              
              
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_DKM_NEW]        
 (                                      
 @STATUSID VARCHAR(25),              
 @STATUSNAME VARCHAR(25),              
 @FROMPARTYCODE VARCHAR(10),              
 @TOPARTYCODE VARCHAR(10),              
 @FROMDATE VARCHAR(11),              
 @TODATE VARCHAR(11),              
 @SETT_TYPE VARCHAR(3),              
 @FROMCODE VARCHAR(15)='',              
 @TOCODE VARCHAR(15)='zzzzzzzzzz',              
 @RPT_BY VARCHAR(15)='BROKER'              
 )                                      
                                      
/*                                      
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_ALL_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                                     
*/                                      
                                      
AS                                      
              
IF @TOCODE = ''              
BEGIN              
 SET @TOCODE = 'zzzzzzzzzz'              
END              
              
              
SELECT              
 DISTINCT              
 PARTY_CODE,              
 PARENTCODE              
INTO               
 #PARTY              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS with (NOLOCK)              
WHERE              
 PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE           
 AND (              
 CASE              
 WHEN @RPT_BY = 'FAMILY'  THEN FAMILY              
 WHEN @RPT_BY = 'REGION'  THEN REGION              
 WHEN @RPT_BY = 'AREA'  THEN AREA              
 WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD              
 WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER              
 WHEN @RPT_BY = 'TRADER'  THEN TRADER              
 ELSE PARENTCODE              
  END)              
 BETWEEN @FROMCODE AND @TOCODE              
 AND @STATUSNAME = (              
 CASE               
  WHEN @STATUSID = 'AREA' THEN AREA                              
  WHEN @STATUSID = 'REGION' THEN REGION                              
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                              
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                              
  WHEN @STATUSID = 'TRADER' THEN TRADER                              
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                              
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                              
  WHEN @STATUSID = 'BROKER' THEN 'broker'                              
  ELSE 'I DONT KNOW '               
 END)              
              
        
              
              
CREATE TABLE #CLASSTBL_SAUDASUMMARY                                      
(                                      
 EXCHANGE VARCHAR(8),                                      
 TRDTYPE  VARCHAR(10),                                      
 PARTY_CODE VARCHAR(10),                                      
 TRADEDATE VARCHAR(10),                                      
 SCRIP_CD VARCHAR(12),                                       
 SCRIP_NAME VARCHAR(100),                                      
 SETT_NO VARCHAR(7),                                      
 SETT_TYPE VARCHAR(3),                
 BUYQTY INT,                                       
 BUYAVGRATE MONEY,                                      
 BUYAMOUNT MONEY,                                       
 SELLQTY INT,                                      
 SELLAVGRATE MONEY,                                      
 SELLAMOUNT MONEY,                                      
 NETQTY INT,                    
 NETAVGRATE MONEY,                                      
 NetAmount MONEY,                                      
 FLAG TINYINT,              
 LONG_NAME VARCHAR(100),                        
 BRANCH_CD VARCHAR(20),                        
 SUB_BROKER VARCHAR(20),                        
 L_ADDRESS1 VARCHAR(100),                        
 L_ADDRESS2 VARCHAR(100),                        
 L_ADDRESS3 VARCHAR(100),                        
L_CITY VARCHAR(50),                        
 L_STATE VARCHAR(50),                        
 L_ZIP VARCHAR(20),                        
 MOBILE_PAGER VARCHAR(50),                        
 RES_PHONE1 VARCHAR(100),                        
 RES_PHONE2 VARCHAR(100),                     
 OFF_PHONE1 VARCHAR(100)                       
)                                      
                         
          
--------FOR NSE OPTIMIZATION     
    
SELECT DISTINCT SETT_NO INTO #SETT FROM ANAND1.MSAJAG.DBO.SETT_MST WHERE Start_date >=@FROMDATE  AND Start_date <= @TODATE + ' 23:59'          
AND SETT_TYPE IN ('N','W')    
                       
----------------------------                                      
-- NOW STARTING BSE CASH (LIVE) --                                      
----------------------------                                      
                                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                   
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                  
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                                       
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                 
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                         
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                 
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY                                       
 P.PARENTCODE,                                      
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'BSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                                      
 FLAG = 2,                                      
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND SAUDA_DATE >= @FROMDATE              
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('AC','AD')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                      
                                      
-------------------------------------                                      
-- NOW STARTING NSE CASH (LIVE) --                                      
-------------------------------------                                  
           
                                      
INSERT INTO #CLASSTBL_SAUDASUMMARY                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '1. TRD',                                      
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTTRD),                                       
 SELLQTY = SUM(SQTYTRD),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTTRD) ,                                      
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                                   
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE        
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,    
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                        
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                   
                                      
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '2. DEL',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = SUM(PQTYDEL),                                       
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                                      
 BUYAMOUNT = SUM(PAMTDEL),                                       
 SELLQTY = SUM(SQTYDEL),                                      
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                                      
 SELLAMOUNT = SUM(SAMTDEL),                                      
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                                      
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                                      
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                                      
 FLAG = 1,              
 LONG_NAME='',              
 BRANCH_CD='',              
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD,                                       
 SERIES,                                      
 SETT_NO,                                      
 SETT_TYPE                                      
HAVING                                      
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                                       
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                                      
              
UNION                                      
                                      
SELECT                                       
 EXCHANGE = 'NSE CASH',                                      
 TRDTYPE = '3. LEV',                                       
 PARTY_CODE = P.PARENTCODE,                                      
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SCRIP_CD = 'ZZZZZZZZZZZZ',                                       
 SCRIP_NAME = '** LEVIES **',                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 BUYQTY = 0,                                       
 BUYAVGRATE = 0,                                      
 BUYAMOUNT = 0,                                       
 SELLQTY = 0,                                      
 SELLAVGRATE = 0,                                      
 SELLAMOUNT = 0,                                      
 NETQTY = 0,                                      
 NETAVGRATE = 0,                                      
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,              
 LONG_NAME='',              
 BRANCH_CD='',
 SUB_BROKER='',              
 L_ADDRESS1='',              
 L_ADDRESS2='',              
 L_ADDRESS3='',              
 L_CITY='',              
 L_STATE='',              
 L_ZIP='',              
 MOBILE_PAGER='',              
 RES_PHONE1='',              
 RES_PHONE2='',              
 OFF_PHONE1=''              
FROM               
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),              
 #PARTY P (NOLOCK)              
WHERE               
 C.PARTY_CODE = P.PARTY_CODE              
 AND    SETT_NO IN (SELECT * FROM #SETT )       
 --AND SAUDA_DATE >= @FROMDATE              
 --AND SAUDA_DATE <= @TODATE + ' 23:59:59'              
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)              
 AND C.SETT_TYPE NOT IN ('A','X')              
GROUP BY              
 P.PARENTCODE,              
 CONVERT(VARCHAR,SAUDA_DATE,103),                                      
 SETT_NO,                                      
 SETT_TYPE                                                            
              
                                 
-------------------------------                                      
-- COMPLETED CALCULATION --                                      
-------------------------------       
                           
UPDATE               
 #CLASSTBL_SAUDASUMMARY              
SET               
 LONG_NAME = C1.LONG_NAME,              
 BRANCH_CD = C1.BRANCH_CD,              
 SUB_BROKER = C1.SUB_BROKER,              
 L_ADDRESS1 = C1.L_ADDRESS1,              
 L_ADDRESS2 = C1.L_ADDRESS2,              
 L_ADDRESS3 = C1.L_ADDRESS3,              
 L_CITY  = C1.L_CITY,              
 L_STATE  = C1.L_STATE,              
 L_ZIP  = C1.L_ZIP,              
 MOBILE_PAGER= C1.MOBILE_PAGER,              
 RES_PHONE1 = C1.RES_PHONE1,              
 RES_PHONE2 = C1.RES_PHONE2,              
 OFF_PHONE1 = C1.OFF_PHONE1              
FROM              
 ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)              
WHERE              
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE              
              
              
SELECT                                       
 EXCHANGE,              
 TRDTYPE,              
 PARTY_CODE,              
 TRADEDATE,              
 SCRIP_CD,              
 SCRIP_NAME,              
 SETT_NO,              
 SETT_TYPE,              
 BUYQTY,              
 BUYAVGRATE,              
 BUYAMOUNT,              
 SELLQTY,              
 SELLAVGRATE,              
 SELLAMOUNT,              
 NETQTY,              
 NETAVGRATE,              
 NetAmount,              
 FLAG,              
 LONG_NAME,                        
 BRANCH_CD,                        
 SUB_BROKER,                        
 L_ADDRESS1,                        
 L_ADDRESS2,                        
 L_ADDRESS3,                        
 L_CITY,                        
 L_STATE,                        
 L_ZIP,                        
 MOBILE_PAGER,                        
 RES_PHONE1,                        
 RES_PHONE2,   
 OFF_PHONE1                        
FROM                          
 #CLASSTBL_SAUDASUMMARY (NOLOCK)              
ORDER BY                                      
 PARTY_CODE,                                      
 EXCHANGE,                                      
 SETT_NO,                                      
 SETT_TYPE,                                      
 FLAG,                                      
 SCRIP_NAME,                                      
 TRDTYPE                           
                                      
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY                     
                                      
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW
-- --------------------------------------------------
  
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0', @TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%', @FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER'   
  
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW]  
 (                          
 @STATUSID VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @FROMPARTYCODE VARCHAR(10),  
 @TOPARTYCODE VARCHAR(10),  
 @FROMDATE VARCHAR(11),  
 @TODATE  VARCHAR(11),  
 @SETT_TYPE VARCHAR(3),  
 @FROMCODE VARCHAR(15)='',  
 @TOCODE  VARCHAR(15)='zzzzzzzzzz',  
 @RPT_BY  VARCHAR(15)='BROKER',  
 @PRINTFLAG VARCHAR(2) ='',  
 @ORD_BY  VARCHAR(15)=''  
 )                          
                          
/*                          
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                         
*/                          
                          
AS                          
  
IF @TOCODE = ''  
BEGIN  
 SET @TOCODE = 'zzzzzzzzzz'  
END  
  
CREATE TABLE #PRINTF  
 (  
 PARTY_CODE VARCHAR(15)  
 )  
  
IF @PRINTFLAG <> ''  
BEGIN  
 INSERT INTO #PRINTF  
 SELECT   
  DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'')   
 FROM   
  ANAND1.PRADNYA.DBO.TBL_H_PRINTFLAG WITH (NOLOCK)  
 WHERE   
  PRINT_FLAG = @PRINTFLAG  
  AND PARTY_CODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE  
END  
ELSE  
BEGIN  
 INSERT INTO #PRINTF  
 SELECT   
  DISTINCT PARTY_CODE = ISNULL(PARENTCODE,'')   
 FROM   
  AngelBSECM.PRADNYA.DBO.TBL_ECNCASH WITH (NOLOCK)  
 WHERE   
  PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE  
END  
  
  
SELECT  
 DISTINCT  
 PARTY_CODE,  
 PARENTCODE  
INTO   
 #PARTY  
FROM  
 AngelBSECM.PRADNYA.DBO.TBL_ECNCASH WITH (NOLOCK)  
WHERE  
 ISNULL(PARENTCODE,'')  
 IN (SELECT DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'') FROM  #PRINTF)  
 AND PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE  
 AND (  
 CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARENTCODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
 AND @STATUSNAME = (  
 CASE   
  WHEN @STATUSID = 'AREA' THEN AREA                  
  WHEN @STATUSID = 'REGION' THEN REGION                  
  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                  
  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                  
  WHEN @STATUSID = 'TRADER' THEN TRADER                  
  WHEN @STATUSID = 'FAMILY' THEN FAMILY                  
  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                  
  WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                  
  ELSE 'I DONT KNOW '   
 END)  
  
  
CREATE TABLE #CLASSTBL_SAUDASUMMARY                          
(                          
 EXCHANGE VARCHAR(8),                          
 TRDTYPE  VARCHAR(10),                          
 PARTY_CODE VARCHAR(10),                          
 TRADEDATE VARCHAR(10),                          
 SCRIP_CD VARCHAR(12),                           
 SCRIP_NAME VARCHAR(100),                          
 SETT_NO VARCHAR(7),                          
 SETT_TYPE VARCHAR(3),                          
 BUYQTY INT,                           
 BUYAVGRATE MONEY,                          
 BUYAMOUNT MONEY,                           
 SELLQTY INT,                          
 SELLAVGRATE MONEY,                          
 SELLAMOUNT MONEY,                          
 NETQTY INT,                          
 NETAVGRATE MONEY,                          
 NetAmount MONEY,                          
 FLAG TINYINT,  
 LONG_NAME VARCHAR(100),            
 BRANCH_CD VARCHAR(20),            
 SUB_BROKER VARCHAR(20),            
 L_ADDRESS1 VARCHAR(100),            
 L_ADDRESS2 VARCHAR(100),            
 L_ADDRESS3 VARCHAR(100),            
 L_CITY VARCHAR(50),            
 L_STATE VARCHAR(50),            
 L_ZIP VARCHAR(20),            
 MOBILE_PAGER VARCHAR(50),            
 RES_PHONE1 VARCHAR(100),            
 RES_PHONE2 VARCHAR(100),            
 OFF_PHONE1 VARCHAR(100),  
 REGION VARCHAR(25)           
)                          
                          
----------------------------                          
-- NOW STARTING BSE CASH --                          
----------------------------                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1,  
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION = ''  
FROM   
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),  
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('AC','AD')  
GROUP BY                           
 P.PARENTCODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
 -- HAVING SUM(PQTYTRD) - SUM(SQTYTRD) <> 0 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0          
 HAVING SUM(PQTYTRD) <> 0                                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                     
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,             
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1,  
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION = ''  
FROM   
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),  
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('AC','AD')  
GROUP BY                           
 P.PARENTCODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
-- HAVING SUM(PQTYDEL) - SUM(SQTYDEL) <> 0 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                          
 HAVING SUM(PQTYDEL) <> 0 OR SUM(SQTYDEL) <> 0 
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION =''  
FROM   
 BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),  
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('AC','AD')  
GROUP BY  
 P.PARENTCODE,  
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                          
                          
----------------------------                          
-- NOW STARTING NSE CASH --                          
----------------------------                          
                          
                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1,  
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION=''  
FROM   
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                       
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('A','X')  
GROUP BY  
 P.PARENTCODE,  
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
 --HAVING SUM(PQTYTRD) - SUM(SQTYTRD) <> 0 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0 
 HAVING SUM(PQTYTRD) <> 0                     
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1,  
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION=''  
FROM   
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),  
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('A','X')  
GROUP BY  
 P.PARENTCODE,  
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
 -- HAVING SUM(PQTYDEL) - SUM(SQTYDEL) <> 0 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0 
 HAVING SUM(PQTYDEL) <> 0 OR SUM(SQTYDEL) <> 0                        
  
UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE = P.PARENTCODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
 SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,              
 FLAG = 2,  
 LONG_NAME='',  
 BRANCH_CD='',  
 SUB_BROKER='',  
 L_ADDRESS1='',  
 L_ADDRESS2='',  
 L_ADDRESS3='',  
 L_CITY='',  
 L_STATE='',  
 L_ZIP='',  
 MOBILE_PAGER='',  
 RES_PHONE1='',  
 RES_PHONE2='',  
 OFF_PHONE1='',  
 REGION=''  
FROM   
 ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),  
 #PARTY P (NOLOCK)  
WHERE   
 C.PARTY_CODE = P.PARTY_CODE  
 AND SAUDA_DATE >= @FROMDATE  
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'  
 AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)  
 AND C.SETT_TYPE NOT IN ('A','X')  
GROUP BY  
 P.PARENTCODE,  
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                                                
  
-------------------------------                          
-- COMPLETED CALCULATION --                          
-------------------------------                          
                      
UPDATE   
 #CLASSTBL_SAUDASUMMARY  
SET   
 LONG_NAME = C1.LONG_NAME,  
 BRANCH_CD = C1.BRANCH_CD,  
 SUB_BROKER = C1.SUB_BROKER,  
 L_ADDRESS1 = C1.L_ADDRESS1,  
 L_ADDRESS2 = C1.L_ADDRESS2,  
 L_ADDRESS3 = C1.L_ADDRESS3,  
 L_CITY  = C1.L_CITY,  
 L_STATE  = C1.L_STATE,  
 L_ZIP  = C1.L_ZIP,  
 MOBILE_PAGER= C1.MOBILE_PAGER,  
 RES_PHONE1 = C1.RES_PHONE1,  
 RES_PHONE2 = C1.RES_PHONE2,  
 OFF_PHONE1 = C1.OFF_PHONE1,  
 REGION  = C1.REGION  
FROM  
 AngelBSECM.PRADNYA.DBO.TBL_ECNCASH C1 (NOLOCK)  
WHERE  
 #CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE  
  
  
SELECT                           
 EXCHANGE,  
 TRDTYPE,  
 PARTY_CODE,  
 TRADEDATE,  
 SCRIP_CD,  
 SCRIP_NAME,  
 SETT_NO,  
 SETT_TYPE,  
 BUYQTY,  
 BUYAVGRATE,  
 BUYAMOUNT,  
 SELLQTY,  
 SELLAVGRATE,  
 SELLAMOUNT,  
 NETQTY,  
 NETAVGRATE,  
 NetAmount,  
 FLAG,  
 LONG_NAME,            
 BRANCH_CD,            
 SUB_BROKER,            
 L_ADDRESS1,            
 L_ADDRESS2,            
 L_ADDRESS3,            
 L_CITY,            
 L_STATE,            
 L_ZIP,            
 MOBILE_PAGER,            
 RES_PHONE1,            
 RES_PHONE2,            
 OFF_PHONE1,  
 REGION            
FROM              
 #CLASSTBL_SAUDASUMMARY (NOLOCK)  
ORDER BY                          
  (CASE   
  WHEN @ORD_BY = 'REGION' THEN REGION  
  WHEN @ORD_BY = 'PIN CODE' THEN L_ZIP  
  ELSE PARTY_CODE  
 END),  
 PARTY_CODE,                          
 EXCHANGE,                          
 SETT_NO,                          
 SETT_TYPE,                          
 FLAG,                          
 SCRIP_NAME,                          
 TRDTYPE                          
                          
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY          
                          
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_18102011
-- --------------------------------------------------

CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_18102011]
	(                        
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@FROMPARTYCODE VARCHAR(10),
	@TOPARTYCODE VARCHAR(10),
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@SETT_TYPE VARCHAR(3),
	@FROMCODE VARCHAR(15)='',
	@TOCODE	VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY VARCHAR(15)='BROKER'
	)                        
                        
/*                        
EXEC [CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW] 'BROKER','BROKER', 'GV54', 'GV54', 'FEB  1 2011', 'FEB 28 2011' ,'%'                       
*/                        
                        
AS                        

IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END


SELECT
	DISTINCT
	PARTY_CODE,
	PARENTCODE
INTO 
	#PARTY
FROM
	ANAND.PRADNYA.DBO.TBL_ECNCASH with (NOLOCK)
WHERE
	PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
	AND (
	CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
	AND @STATUSNAME = (
	CASE 
		WHEN @STATUSID = 'AREA' THEN AREA                
		WHEN @STATUSID = 'REGION' THEN REGION                
		WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                
		WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                
		WHEN @STATUSID = 'TRADER' THEN TRADER                
		WHEN @STATUSID = 'FAMILY' THEN FAMILY                
		WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                
		WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
		ELSE 'I DONT KNOW ' 
	END)




CREATE TABLE #CLASSTBL_SAUDASUMMARY                        
(                        
 EXCHANGE VARCHAR(8),                        
 TRDTYPE  VARCHAR(10),                        
 PARTY_CODE VARCHAR(10),                        
 TRADEDATE VARCHAR(10),                        
 SCRIP_CD VARCHAR(12),                         
 SCRIP_NAME VARCHAR(100),                        
 SETT_NO VARCHAR(7),                        
 SETT_TYPE VARCHAR(3),                        
 BUYQTY INT,                         
 BUYAVGRATE MONEY,                        
 BUYAMOUNT MONEY,                         
 SELLQTY INT,                        
 SELLAVGRATE MONEY,                        
 SELLAMOUNT MONEY,                        
 NETQTY INT,                        
 NETAVGRATE MONEY,                        
 NetAmount MONEY,                        
 FLAG TINYINT,
 LONG_NAME VARCHAR(100),          
 BRANCH_CD VARCHAR(20),          
 SUB_BROKER VARCHAR(20),          
 L_ADDRESS1 VARCHAR(100),          
 L_ADDRESS2 VARCHAR(100),          
 L_ADDRESS3 VARCHAR(100),          
 L_CITY VARCHAR(50),          
 L_STATE VARCHAR(50),          
 L_ZIP VARCHAR(20),          
 MOBILE_PAGER VARCHAR(50),          
 RES_PHONE1 VARCHAR(100),          
 RES_PHONE2 VARCHAR(100),          
 OFF_PHONE1 VARCHAR(100)         
)                        
                        
----------------------------                        
-- NOW STARTING BSE CASH --                        
----------------------------                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),            
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1,
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('AC','AD')
GROUP BY                         
	P.PARENTCODE,                        
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SCRIP_CD,                         
	SCRIP_NAME,                        
	SETT_NO,                        
	SETT_TYPE                        
HAVING                        
	SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                         
	OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                   
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,           
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1,
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('AC','AD')
GROUP BY                         
	P.PARENTCODE,                        
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SCRIP_CD,                         
	SCRIP_NAME,                        
	SETT_NO,                        
	SETT_TYPE                        
HAVING                        
	SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
	OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0          
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	BSEDB_AB.DBO.CMBILLVALAN C (NOLOCK),
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('AC','AD')
GROUP BY
	P.PARENTCODE,
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SETT_NO,                        
	SETT_TYPE                        
                        
----------------------------                        
-- NOW STARTING NSE CASH --                        
----------------------------                        
                        
                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1,
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),                     
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('A','X')
GROUP BY
	P.PARENTCODE,
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SCRIP_CD,                         
	SERIES,                        
	SETT_NO,                        
	SETT_TYPE                        
HAVING                        
	SUM(PQTYTRD) - SUM(SQTYTRD) <> 0  
	OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1,
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	ANAND1.MSAJAG.DBO.CMBILLVALAN C with(NOLOCK),
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('A','X')
GROUP BY
	P.PARENTCODE,
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SCRIP_CD,                         
	SERIES,                        
	SETT_NO,                        
	SETT_TYPE                        
HAVING                        
	SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
	OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                        

UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE = P.PARENTCODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
 SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,            
 FLAG = 2,
 LONG_NAME='',
 BRANCH_CD='',
 SUB_BROKER='',
 L_ADDRESS1='',
 L_ADDRESS2='',
 L_ADDRESS3='',
 L_CITY='',
 L_STATE='',
 L_ZIP='',
 MOBILE_PAGER='',
 RES_PHONE1='',
 RES_PHONE2='',
 OFF_PHONE1=''
FROM 
	ANAND1.MSAJAG.DBO.CMBILLVALAN C with (NOLOCK),
	#PARTY P (NOLOCK)
WHERE 
	C.PARTY_CODE = P.PARTY_CODE
	AND SAUDA_DATE >= @FROMDATE
	AND SAUDA_DATE <= @TODATE + ' 23:59:59'
	AND SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)
	AND C.SETT_TYPE NOT IN ('A','X')
GROUP BY
	P.PARENTCODE,
	CONVERT(VARCHAR,SAUDA_DATE,103),                        
	SETT_NO,                        
	SETT_TYPE                                              

-------------------------------                        
-- COMPLETED CALCULATION --                        
-------------------------------                        
                    
UPDATE 
	#CLASSTBL_SAUDASUMMARY
SET 
	LONG_NAME	= C1.LONG_NAME,
	BRANCH_CD	= C1.BRANCH_CD,
	SUB_BROKER	= C1.SUB_BROKER,
	L_ADDRESS1	= C1.L_ADDRESS1,
	L_ADDRESS2	= C1.L_ADDRESS2,
	L_ADDRESS3	= C1.L_ADDRESS3,
	L_CITY		= C1.L_CITY,
	L_STATE		= C1.L_STATE,
	L_ZIP		= C1.L_ZIP,
	MOBILE_PAGER= C1.MOBILE_PAGER,
	RES_PHONE1	= C1.RES_PHONE1,
	RES_PHONE2	= C1.RES_PHONE2,
	OFF_PHONE1	= C1.OFF_PHONE1
FROM
	ANAND.PRADNYA.DBO.TBL_ECNCASH C1 (NOLOCK)
WHERE
	#CLASSTBL_SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE


SELECT                         
	EXCHANGE,
	TRDTYPE,
	PARTY_CODE,
	TRADEDATE,
	SCRIP_CD,
	SCRIP_NAME,
	SETT_NO,
	SETT_TYPE,
	BUYQTY,
	BUYAVGRATE,
	BUYAMOUNT,
	SELLQTY,
	SELLAVGRATE,
	SELLAMOUNT,
	NETQTY,
	NETAVGRATE,
	NetAmount,
	FLAG,
	LONG_NAME,          
	BRANCH_CD,          
	SUB_BROKER,          
	L_ADDRESS1,          
	L_ADDRESS2,          
	L_ADDRESS3,          
	L_CITY,          
	L_STATE,          
	L_ZIP,          
	MOBILE_PAGER,          
	RES_PHONE1,          
	RES_PHONE2,          
	OFF_PHONE1          
FROM            
	#CLASSTBL_SAUDASUMMARY (NOLOCK)
ORDER BY                        
	PARTY_CODE,                        
	EXCHANGE,                        
	SETT_NO,                        
	SETT_TYPE,                        
	FLAG,                        
	SCRIP_NAME,                        
	TRDTYPE                        
                        
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY        
                        
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_28022011
-- --------------------------------------------------
  
--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0', @TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%', @FROMCODE = 'DFGDF', @TOCODE = 'DF
--GDF', @RPT_BY = 'SUB_BROKER'   
  
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_28022011]  
/*Changing long_name to long_name by Samit Mhatre on 25012011 */   
(                          
 @STATUSID VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @FROMPARTYCODE VARCHAR(10),  
 @TOPARTYCODE VARCHAR(10),  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @SETT_TYPE VARCHAR(3),  
 @FROMCODE VARCHAR(15)='',  
 @TOCODE VARCHAR(15)='zzzzzzzzzz',  
 @RPT_BY VARCHAR(15)='BROKER'  
 )                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'A0001', 'bz999', 'NOV  1 2010', 'NOV 30 2010' ,'%'                         
*/                          
                          
AS  
IF @TOCODE = ''  
BEGIN  
 SET @TOCODE = 'zzzzzzzzzz'  
END  
  
CREATE TABLE #CLASSTBL_SAUDASUMMARY                          
(                          
 EXCHANGE VARCHAR(8),                          
 TRDTYPE  VARCHAR(10),                          
 PARTY_CODE VARCHAR(10),                          
 TRADEDATE VARCHAR(11),                          
 SCRIP_CD VARCHAR(12),                           
 SCRIP_NAME VARCHAR(100),                          
 SETT_NO VARCHAR(7),                          
 SETT_TYPE VARCHAR(3),                          
 BUYQTY INT,                           
 BUYAVGRATE MONEY,                          
 BUYAMOUNT MONEY,                           
 SELLQTY INT,                          
 SELLAVGRATE MONEY,                          
 SELLAMOUNT MONEY,                          
 NETQTY INT,                          
 NETAVGRATE MONEY,                          
 NETAMOUNT MONEY,                          
 FLAG TINYINT                          
)                          
                          
----------------------------                          
-- NOW STARTING BSE CASH --                          
----------------------------                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)  
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                           
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                     
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,             
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'BSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                          
 FLAG = 2                          
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                 
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                          
                          
----------------------------                          
-- NOW STARTING NSE CASH --                          
----------------------------                          
                          
                          
INSERT INTO #CLASSTBL_SAUDASUMMARY                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '1. TRD',                          
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYTRD),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTTRD),                           
 SELLQTY = SUM(SQTYTRD),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTTRD) ,                          
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                          
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                          
 FLAG = 1                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE               
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0            
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                          
                          
UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '2. DEL',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = SUM(PQTYDEL),                           
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                          
 BUYAMOUNT = SUM(PAMTDEL),                           
 SELLQTY = SUM(SQTYDEL),                          
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                          
 SELLAMOUNT = SUM(SAMTDEL),                          
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                          
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                          
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                          
 FLAG = 1                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with(NOLOCK)                          
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD,                           
 SERIES,                          
 SETT_NO,                          
 SETT_TYPE                          
HAVING                          
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                           
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                          
          UNION                          
                          
SELECT                           
 EXCHANGE = 'NSE CASH',                          
 TRDTYPE = '3. LEV',                           
 PARTY_CODE,                          
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SCRIP_CD = 'ZZZZZZZZZZZZ',                           
 SCRIP_NAME = '** LEVIES **',                          
 SETT_NO,                          
 SETT_TYPE,                          
 BUYQTY = 0,                           
 BUYAVGRATE = 0,                          
 BUYAMOUNT = 0,                           
 SELLQTY = 0,                          
 SELLAVGRATE = 0,                          
 SELLAMOUNT = 0,                          
 NETQTY = 0,                          
 NETAVGRATE = 0,                          
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,              
 FLAG = 2                          
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                         
WHERE PARTY_CODE >= @FROMPARTYCODE                          
AND PARTY_CODE <= @TOPARTYCODE                          
AND SAUDA_DATE >= @FROMDATE                          
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN REGION  
  WHEN @RPT_BY = 'AREA'  THEN AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN TRADER  
  ELSE PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                           
 PARTY_CODE,                          
 CONVERT(VARCHAR,SAUDA_DATE,103),                          
 SETT_NO,                          
 SETT_TYPE                                                
-------------------------------                          
-- COMPLETED CALCULATION --                          
-------------------------------                          
                      
SELECT                           
 C.*,            
 C1.long_name,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM              
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                         
 INNER JOIN                          
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)       
 ON (C.PARTY_CODE = C1.PARTY_CODE)  
WHERE                           
 C.EXCHANGE = 'NSE CASH'                      
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                  
            ELSE 'I DONT KNOW ' END)                  
AND C.SETT_TYPE NOT IN ('A','X')                
UNION                          
SELECT                           
 C.*,                           
 C1.long_name,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                          
 INNER JOIN                          
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                            
 ON (C.PARTY_CODE = C1.PARTY_CODE)         
WHERE                           
 C.EXCHANGE = 'BSE CASH'                     
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
            WHEN @STATUSID = 'REGION' THEN C1.REGION                  
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE  
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME  
            ELSE 'I DONT KNOW ' END)                   
AND C.SETT_TYPE NOT IN ('AC','AD')                
ORDER BY                          
 C.PARTY_CODE,                          
 C.EXCHANGE,                          
 C.SETT_NO,                          
 C.SETT_TYPE,                          
 C.FLAG,                          
 C.SCRIP_NAME,                          
 C.TRDTYPE                          
                          
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY          
                          
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_31012011
-- --------------------------------------------------

--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0', @TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%', @FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER' 

CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_31012011]
/*Changing long_name to long_name by Samit Mhatre on 25012011 */	
(                        
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@FROMPARTYCODE VARCHAR(10),
	@TOPARTYCODE VARCHAR(10),
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@SETT_TYPE VARCHAR(3),
	@FROMCODE VARCHAR(15)='',
	@TOCODE	VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY VARCHAR(15)='BROKER'
	)                        
                        
/*                        
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'A0001', 'bz999', 'NOV  1 2010', 'NOV 30 2010' ,'%'                       
*/                        
                        
AS
IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END

CREATE TABLE #CLASSTBL_SAUDASUMMARY                        
(                        
 EXCHANGE VARCHAR(8),                        
 TRDTYPE  VARCHAR(10),                        
 PARTY_CODE VARCHAR(10),                        
 TRADEDATE VARCHAR(11),                        
 SCRIP_CD VARCHAR(12),                         
 SCRIP_NAME VARCHAR(100),                        
 SETT_NO VARCHAR(7),                        
 SETT_TYPE VARCHAR(3),                        
 BUYQTY INT,                         
 BUYAVGRATE MONEY,                        
 BUYAMOUNT MONEY,                         
 SELLQTY INT,                        
 SELLAVGRATE MONEY,                        
 SELLAMOUNT MONEY,                        
 NETQTY INT,                        
 NETAVGRATE MONEY,                        
 NETAMOUNT MONEY,                        
 FLAG TINYINT                        
)                        
                        
----------------------------                        
-- NOW STARTING BSE CASH --                        
----------------------------                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                         
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                   
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,           
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                        
 FLAG = 2                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SETT_NO,                        
 SETT_TYPE                        
                        
----------------------------                        
-- NOW STARTING NSE CASH --                        
----------------------------                        
                        
                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE             
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SERIES,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0          
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with(NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SERIES,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                        
          UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
 SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,            
 FLAG = 2                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                       
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SETT_NO,                        
 SETT_TYPE                                              
-------------------------------                        
-- COMPLETED CALCULATION --                        
-------------------------------                        
                    
SELECT                         
 C.*,          
 C1.long_name,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM            
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                       
 INNER JOIN                        
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                          
 ON (C.PARTY_CODE = C1.PARTY_CODE)
WHERE                         
 C.EXCHANGE = 'NSE CASH'                    
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                    
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                
AND C.SETT_TYPE NOT IN ('A','X')              
UNION                        
SELECT                         
 C.*,                         
 C1.long_name,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                        
 INNER JOIN                        
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                          
 ON (C.PARTY_CODE = C1.PARTY_CODE)       
WHERE                         
 C.EXCHANGE = 'BSE CASH'                   
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
            ELSE 'I DONT KNOW ' END)                 
AND C.SETT_TYPE NOT IN ('AC','AD')              
ORDER BY                        
 C.PARTY_CODE,                        
 C.EXCHANGE,                        
 C.SETT_NO,                        
 C.SETT_TYPE,                        
 C.FLAG,                        
 C.SCRIP_NAME,                        
 C.TRDTYPE                        
                        
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY        
                        
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_org_27012011
-- --------------------------------------------------

--EXEC PRADNYA.DBO.CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW @STATUSID = 'broker', @STATUSNAME = 'broker', @FROMPARTYCODE = '0', @TOPARTYCODE = 'ZZZZZZZ', @FROMDATE = 'Dec  1 2007', @TODATE = 'Nov 30 2010', @SETT_TYPE = '%', @FROMCODE = 'DFGDF', @TOCODE = 'DFGDF', @RPT_BY = 'SUB_BROKER' 

CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_CASHPRINT_NEW_org_27012011]
/*Changing short_name to long_name by Samit Mhatre on 25012011 */	
(                        
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@FROMPARTYCODE VARCHAR(10),
	@TOPARTYCODE VARCHAR(10),
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@SETT_TYPE VARCHAR(3),
	@FROMCODE VARCHAR(15)='',
	@TOCODE	VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY VARCHAR(15)='BROKER'
	)                        
                        
/*                        
EXEC CLASSPROC_SAUDA_SUMMARY_CASHPRINT 'BROKER','BROKER', 'A0001', 'bz999', 'NOV  1 2010', 'NOV 30 2010' ,'%'                       
*/                        
                        
AS                        

IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END

CREATE TABLE #CLASSTBL_SAUDASUMMARY                        
(                        
 EXCHANGE VARCHAR(8),                        
 TRDTYPE  VARCHAR(10),                        
 PARTY_CODE VARCHAR(10),                        
 TRADEDATE VARCHAR(10),                        
 SCRIP_CD VARCHAR(12),                         
 SCRIP_NAME VARCHAR(100),                        
 SETT_NO VARCHAR(7),                        
 SETT_TYPE VARCHAR(3),                        
 BUYQTY INT,                         
 BUYAVGRATE MONEY,                        
 BUYAMOUNT MONEY,                         
 SELLQTY INT,                        
 SELLAVGRATE MONEY,                        
 SELLAMOUNT MONEY,                        
 NETQTY INT,                        
 NETAVGRATE MONEY,                        
 NETAMOUNT MONEY,                        
 FLAG TINYINT                        
)                        
                        
----------------------------                        
-- NOW STARTING BSE CASH --                        
----------------------------                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0                         
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                   
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_NAME + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,           
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'BSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,                        
 FLAG = 2                        
FROM BSEDB_AB.DBO.CMBILLVALAN (NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SETT_NO,                        
 SETT_TYPE                        
                        
----------------------------                        
-- NOW STARTING NSE CASH --                        
----------------------------                        
                        
                        
INSERT INTO #CLASSTBL_SAUDASUMMARY                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '1. TRD',                        
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES,                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYTRD),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYTRD) <> 0 THEN SUM(PAMTTRD) / SUM(PQTYTRD) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTTRD),                         
 SELLQTY = SUM(SQTYTRD),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYTRD) <> 0 THEN SUM(SAMTTRD) / SUM(SQTYTRD) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTTRD) ,                        
 NETQTY = SUM(PQTYTRD) - SUM(SQTYTRD),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYTRD) - SUM(SQTYTRD)) <> 0 THEN ABS((SUM(SAMTTRD)-SUM(PAMTTRD))/(SUM(PQTYTRD) - SUM(SQTYTRD))) ELSE 0 END),                        
 NETAMT = SUM(SAMTTRD)-SUM(PAMTTRD),                        
 FLAG = 1                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                      
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE             
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SERIES,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYTRD) - SUM(SQTYTRD) <> 0          
 OR SUM(SAMTTRD)-SUM(PAMTTRD) <> 0                        
                        
UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '2. DEL',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SCRIP_NAME = SCRIP_CD + ' - ' + SERIES + ' (DELIVERY)',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = SUM(PQTYDEL),                         
 BUYAVGRATE = (CASE WHEN SUM(PQTYDEL) <> 0 THEN SUM(PAMTDEL) / SUM(PQTYDEL) ELSE 0 END),                        
 BUYAMOUNT = SUM(PAMTDEL),                         
 SELLQTY = SUM(SQTYDEL),                        
 SELLAVGRATE = (CASE WHEN SUM(SQTYDEL) <> 0 THEN SUM(SAMTDEL) / SUM(SQTYDEL) ELSE 0 END),                        
 SELLAMOUNT = SUM(SAMTDEL),                        
 NETQTY = SUM(PQTYDEL) - SUM(SQTYDEL),                        
 NETAVGRATE = (CASE WHEN (SUM(PQTYDEL) - SUM(SQTYDEL)) <> 0 THEN ABS((SUM(SAMTDEL)-SUM(PAMTDEL))/(SUM(PQTYDEL) - SUM(SQTYDEL))) ELSE 0 END),                        
 NETAMT = SUM(SAMTDEL)-SUM(PAMTDEL),                        
 FLAG = 1                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with(NOLOCK)                        
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD,                         
 SERIES,                        
 SETT_NO,                        
 SETT_TYPE                        
HAVING                        
 SUM(PQTYDEL) - SUM(SQTYDEL) <> 0                         
 OR SUM(SAMTDEL)-SUM(PAMTDEL) <> 0                        
          UNION                        
                        
SELECT                         
 EXCHANGE = 'NSE CASH',                        
 TRDTYPE = '3. LEV',                         
 PARTY_CODE,                        
 TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SCRIP_CD = 'ZZZZZZZZZZZZ',                         
 SCRIP_NAME = '** LEVIES **',                        
 SETT_NO,                        
 SETT_TYPE,                        
 BUYQTY = 0,                         
 BUYAVGRATE = 0,                        
 BUYAMOUNT = 0,                         
 SELLQTY = 0,                        
 SELLAVGRATE = 0,                        
 SELLAMOUNT = 0,                        
 NETQTY = 0,                        
 NETAVGRATE = 0,                        
 NETAMT = (SUM(SERVICE_TAX) + SUM(TURN_TAX)  + SUM(SEBI_TAX) + SUM(INS_CHRG) + SUM(BROKER_CHRG) + SUM(OTHER_CHRG)) * -1,            
 FLAG = 2                        
FROM ANAND1.MSAJAG.DBO.CMBILLVALAN with (NOLOCK)                       
WHERE PARTY_CODE >= @FROMPARTYCODE                        
AND PARTY_CODE <= @TOPARTYCODE                        
AND SAUDA_DATE >= @FROMDATE                        
AND SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                         
 PARTY_CODE,                        
 CONVERT(VARCHAR,SAUDA_DATE,103),                        
 SETT_NO,                        
 SETT_TYPE                                              
-------------------------------                        
-- COMPLETED CALCULATION --                        
-------------------------------                        
                    
SELECT                         
 C.*,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM            
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                       
 INNER JOIN                        
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                          
 ON (C.PARTY_CODE = C1.PARTY_CODE)
WHERE                         
 C.EXCHANGE = 'NSE CASH'                    
AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                    
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                
AND C.SETT_TYPE NOT IN ('A','X')              
UNION                        
SELECT                         
 C.*,                         
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 #CLASSTBL_SAUDASUMMARY C (NOLOCK)                        
 INNER JOIN                        
 ANAND.Pradnya.dbo.TBL_ECNCASH C1 (NOLOCK)                          
 ON (C.PARTY_CODE = C1.PARTY_CODE)       
WHERE                         
 C.EXCHANGE = 'BSE CASH'                   
 AND C.SETT_TYPE = (CASE WHEN @SETT_TYPE = '%' THEN C.SETT_TYPE ELSE @SETT_TYPE END)                      
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
            ELSE 'I DONT KNOW ' END)                 
AND C.SETT_TYPE NOT IN ('AC','AD')              
ORDER BY                        
 C.PARTY_CODE,                        
 C.EXCHANGE,                        
 C.SETT_NO,                        
 C.SETT_TYPE,                        
 C.FLAG,                        
 C.SCRIP_NAME,                        
 C.TRDTYPE                        
                        
--TRUNCATE TABLE #CLASSTBL_SAUDASUMMARY        
                        
--DROP TABLE #CLASSTBL_SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FO
-- --------------------------------------------------
    
CREATE PROC CLASSPROC_SAUDA_SUMMARY_FO          
(          
 @STATUSID VARCHAR(25),      
 @STATUSNAME VARCHAR(25),      
 @FROMPARTYCODE VARCHAR(10),              
 @TOPARTYCODE VARCHAR(10),              
 @FROMDATE VARCHAR(11),              
 @TODATE VARCHAR(11)              
)          
          
/*          
EXEC CLASSPROC_SAUDA_SUMMARY_FO 'BROKER','BROKER', 'B3947', 'B3947', 'NOV  6 2008', 'NOV  7 2008'              
*/          
          
AS          
    
-----------------------------------------------------------------------------    
--                            NOW DOING NSEFO                              --    
-----------------------------------------------------------------------------    
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT           
 EXCHANGE = 'F&O',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 BUYQTY = SUM(F.PQTY),          
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),          
 SELLQTY = SUM(F.SQTY),          
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),          
 FLAG = 1,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']'          
FROM           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F       
 INNER JOIN              
 ANGELFO.NSEFO.DBO.CLIENT2 C2        
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
         
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,        
 F.SAUDA_DATE        
          
UNION          
          
SELECT  
 EXCHANGE = 'F&O',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 TRADETYPE = '',          
 F.PARTY_CODE,          
 INST_TYPE = '',          
 SYMBOL = '** LEVIES **',          
 EXPIRYDATE = '',          
 OPTION_TYPE = '',          
 STRIKE_PRICE  = 0,          
 CL_RATE = 0,          
 BUYQTY = 0,          
 BUYRATE = 0,          
 SELLQTY = 0,          
 SELLRATE = 0,          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,          
 FLAG = 2,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,          
 SCRIP_NAME = '** LEVIES **'          
FROM           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F          
 INNER JOIN              
 ANGELFO.NSEFO.DBO.CLIENT2 C2        
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.PARTY_CODE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
    
    
-----------------------------------------------------------------------------    
--                            NOW DOING MCDX                              --    
-----------------------------------------------------------------------------    
UNION


SELECT           
 EXCHANGE = 'MCX',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 BUYQTY = SUM(F.PQTY),          
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),          
 SELLQTY = SUM(F.SQTY),          
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),          
 FLAG = 1,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']'          
FROM           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F       
 INNER JOIN              
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2        
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
         
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,        
 F.SAUDA_DATE        
          
UNION          
          
SELECT  
 EXCHANGE = 'MCX',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 TRADETYPE = '',          
 F.PARTY_CODE,          
 INST_TYPE = '',          
 SYMBOL = '** LEVIES **',          
 EXPIRYDATE = '',          
 OPTION_TYPE = '',          
 STRIKE_PRICE  = 0,          
 CL_RATE = 0,          
 BUYQTY = 0,          
 BUYRATE = 0,          
 SELLQTY = 0,          
 SELLRATE = 0,          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,          
 FLAG = 2,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,          
 SCRIP_NAME = '** LEVIES **'          
FROM           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F          
 INNER JOIN              
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2        
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.PARTY_CODE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          

UNION
    
-----------------------------------------------------------------------------    
--                            NOW DOING NCDX                              --    
-----------------------------------------------------------------------------    


SELECT           
 EXCHANGE = 'NCDX',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 BUYQTY = SUM(F.PQTY),          
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),          
 SELLQTY = SUM(F.SQTY),          
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),          
 FLAG = 1,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']'          
FROM           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F       
 INNER JOIN              
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2        
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
         
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.TRADETYPE,          
 F.PARTY_CODE,          
 F.INST_TYPE,          
 F.SYMBOL,          
 F.EXPIRYDATE,          
 F.OPTION_TYPE,          
 F.STRIKE_PRICE,          
 F.CL_RATE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,        
 F.SAUDA_DATE        
          
UNION          
          
SELECT  
 EXCHANGE = 'NCDX',
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 TRADETYPE = '',          
 F.PARTY_CODE,          
 INST_TYPE = '',          
 SYMBOL = '** LEVIES **',          
 EXPIRYDATE = '',          
 OPTION_TYPE = '',          
 STRIKE_PRICE  = 0,          
 CL_RATE = 0,          
 BUYQTY = 0,          
 BUYRATE = 0,          
 SELLQTY = 0,          
 SELLRATE = 0,          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,          
 FLAG = 2,          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,          
 SCRIP_NAME = '** LEVIES **'          
FROM           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F          
 INNER JOIN              
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2        
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)        
 ON (F.PARTY_CODE = C2.PARTY_CODE /*AND C2.PRINTF = 2*/)      
WHERE           
 F.PARTY_CODE >= @FROMPARTYCODE          
 AND F.PARTY_CODE <= @TOPARTYCODE          
 AND F.SAUDA_DATE >= @FROMDATE          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'          
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA      
            WHEN @STATUSID = 'REGION' THEN C1.REGION      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY      
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME      
            ELSE 'I DONT KNOW ' END)       
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),          
 F.PARTY_CODE,          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
    
    
    
    
ORDER BY          
 F.PARTY_CODE,        
 1,  
 SAUDA_DATE,          
 FLAG,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT]       
(                        
 @STATUSID VARCHAR(25),                    
 @STATUSNAME VARCHAR(25),                    
 @FROMPARTYCODE VARCHAR(10),                            
 @TOPARTYCODE VARCHAR(10),                            
 @FROMDATE VARCHAR(11),                            
 @TODATE VARCHAR(11)                            
)                        
                        
/*                        
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'a1160', 'a1160', 'jul  1 2009', 'jul 31 2009'                                      
*/                        
                        
AS                        
          
-----------------------------------------------------------------------------                  
--                            NOW DOING NSEFO                              --                  
-----------------------------------------------------------------------------                  
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
SELECT                         
 EXCHANGE = 'F&O',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                     
 INNER JOIN                            
AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)          
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,                      
 C1.SHORT_NAME,         
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                       
UNION                        
                        
SELECT                
 EXCHANGE = 'F&O',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)          
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                  
-----------------------------------------------------------------------------                  
--                            NOW DOING MCDX                              --                  
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'MCX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
 
(f.pqty) Else 0 End End AS BUYRATE,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SELLRATE,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                     
 INNER JOIN             
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY       
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'MCX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
              
UNION              
                  
-----------------------------------------------------------------------------                  
--                            NOW DOING NCDX                              --                  
-----------------------------------------------------------------------------                  
              
              
SELECT                         
 EXCHANGE = 'NCDX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
(  
f.pqty) Else 0 End End AS BUYRATE,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SELLRATE,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
          
FROM                         
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                     
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'NCDX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',          
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
      
-----------------------------------------------------------------------------       
--                            NOW DOING MCX-SX                             --                  
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'MCXSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
 
(f.pqty) Else 0 End End as BUYRATE,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SELLRATE,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                     
 INNER JOIN             
AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'MCXSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                  
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1       
      
-----------------------------------------------------------------------------                  
--                            NOW DOING NSX                               --                  
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'NSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,       
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                     
 INNER JOIN             
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'NSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 AngelBSECM.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA          
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1       
      
ORDER BY                        
 F.PARTY_CODE,                      
 1,                
 SAUDA_DATE,                        
 FLAG,                        
 INST_TYPE,                        
 SYMBOL,                        
 EXPIRYDATE,                        
 OPTION_TYPE,                        
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW
-- --------------------------------------------------







          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 @FROMCODE VARCHAR(15) ,          
 @TOCODE VARCHAR(15) ,          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_STEST 'BROKER','BROKER', 'RP61', 'RP61', 'APR  1 2014', 'MAY 18 2015' , 'RP61', 'RP61'                                              
*/                                    
                                    
AS                                    

--DECLARE @FROMCODE VARCHAR(15)
--DECLARE @TOCODE VARCHAR(15)
          
SET @FROMCODE =@FROMPARTYCODE 
SET @TOCODE =@TOPARTYCODE       

--PRINT @FROMCODE
--PRINT @TOCODE
--RETURN 
select * INTO #CLI from ANAND1.MSAJAG.dbo.CLIENT_DETAILS where PARENTCODE >=@FROMPARTYCODE 
AND PARENTCODE <=@TOPARTYCODE 
   
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          )A
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 --UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE      
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
--UNION      
INSERT INTO #SAUDASUMMARY     
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  [172.31.16.30].NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  [172.31.16.30].NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  [172.31.16.30].MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  [172.31.16.30].MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.Sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  [172.31.16.30].NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  [172.31.16.30].NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
-- ) SS          
--ORDER BY          
-- PARTY_CODE,          
-- 1,          
-- SAUDA_DATE,          
-- FLAG,          
-- INST_TYPE,          
-- SYMBOL,          
-- EXPIRYDATE,          
-- OPTION_TYPE,          
-- STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  #CLI C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_220615_BKP
-- --------------------------------------------------

          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_220615_BKP]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 @FROMCODE VARCHAR(15)='',          
 @TOCODE VARCHAR(15)='zzzzzzzzzz',          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                                  
*/                                    
                                    
AS                                    
          
IF @TOCODE = ''          
BEGIN          
 SET @TOCODE = 'zzzzzzzzzz'          
END          
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
 WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
UNION      
      
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
 ) SS          
ORDER BY          
 PARTY_CODE,          
 1,          
 SAUDA_DATE,          
 FLAG,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_25072011
-- --------------------------------------------------
  
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_25072011]
 (                            
 @STATUSID VARCHAR(25),                        
 @STATUSNAME VARCHAR(25),                        
 @FROMPARTYCODE VARCHAR(10),                                
 @TOPARTYCODE VARCHAR(10),                                
 @FROMDATE VARCHAR(11),                                
 @TODATE VARCHAR(11),  
 @FROMCODE VARCHAR(15)='',  
 @TOCODE VARCHAR(15)='zzzzzzzzzz',  
 @RPT_BY VARCHAR(15)='BROKER'  
 )                            
                            
/*                            
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                          
*/                            
                            
AS                            
  
IF @TOCODE = ''  
BEGIN  
 SET @TOCODE = 'zzzzzzzzzz'  
END  
              
-----------------------------------------------------------------------------                      
--                            NOW DOING NSEFO                              --                      
-----------------------------------------------------------------------------                      
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT  
 EXCHANGE,  
 TRADEDATE,  
 TRADETYPE,  
 PARTY_CODE,  
 INST_TYPE,  
 SYMBOL,  
 EXPIRYDATE,  
 OPTION_TYPE,  
 STRIKE_PRICE,  
 CL_RATE,  
 BUYQTY,  
 BUYRATE,  
 SELLQTY,  
 SELLRATE,  
 NETAMOUNT,  
 FLAG,  
 SAUDA_DATE,  
 SCRIP_NAME,  
 LONG_NAME = CONVERT(VARCHAR(100),''),  
 BRANCH_CD = CONVERT(VARCHAR(15),''),  
 SUB_BROKER = CONVERT(VARCHAR(15),''),  
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),  
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),  
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),  
 L_CITY  = CONVERT(VARCHAR(50),''),  
 L_STATE  = CONVERT(VARCHAR(50),''),  
 L_ZIP  = CONVERT(VARCHAR(25),''),  
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),  
 RES_PHONE1  = CONVERT(VARCHAR(50),''),  
 RES_PHONE2  = CONVERT(VARCHAR(50),''),  
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')  
INTO  
 #SAUDASUMMARY  
FROM  
 (  
 SELECT                             
  EXCHANGE = 'F&O',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  PARTY_CODE = C1.PARENTCODE,  
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,            
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
  FLAG = 1,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM  
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                         
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)              
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),  
  F.SAUDA_DATE  
                            
 UNION                            
                             
 SELECT                    
  EXCHANGE = 'F&O',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                   
  TRADETYPE = '',                            
  PARTY_CODE = C1.PARENTCODE,                            
  INST_TYPE = '',                            
  SYMBOL = '** LEVIES **',                            
  EXPIRYDATE = '',                            
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                            
  CL_RATE = 0,                            
  BUYQTY = 0,                            
  BUYRATE = 0,                            
  SELLQTY = 0,                            
  SELLRATE = 0,                            
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
  FLAG = 2,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
  SCRIP_NAME = '** LEVIES **',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM                             
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                            
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
     
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)              
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  C1.PARENTCODE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
                       
 -----------------------------------------------------------------------------                      
 --                            NOW DOING MCDX                              --                      
 -----------------------------------------------------------------------------                      
 UNION                  
                   
                   
 SELECT                             
  EXCHANGE = 'MCX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  PARTY_CODE = C1.PARENTCODE,  
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum   
     
      
 (f.pqty) Else 0 End End AS BUYRATE,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
(  
     
       
 f.sqty) Else 0 End End AS SELLRATE,            
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
  FLAG = 1,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM                             
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                         
  INNER JOIN                 
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
                            
 WHERE                   
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY           
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
                           
                             
 UNION                            
                             
 SELECT                    
  EXCHANGE = 'MCX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  TRADETYPE = '',                            
  PARTY_CODE= C1.PARENTCODE,  
  INST_TYPE = '',                            
  SYMBOL = '** LEVIES **',                            
  EXPIRYDATE = '',                            
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                            
  CL_RATE = 0,                            
  BUYQTY = 0,                            
  BUYRATE = 0,                            
  SELLQTY = 0,                            
  SELLRATE = 0,                            
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
  FLAG = 2,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
  SCRIP_NAME = '** LEVIES **',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
                             
 FROM                             
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                            
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
     
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  C1.PARENTCODE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
                             
                   
 UNION                  
                       
 -----------------------------------------------------------------------------                      
 --                            NOW DOING NCDX                              --                      
 -----------------------------------------------------------------------------                      
                   
                   
 SELECT                             
  EXCHANGE = 'NCDX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  PARTY_CODE = C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum   
    
 (      
 f.pqty) Else 0 End End AS BUYRATE,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
(  
     
       
 f.sqty) Else 0 End End AS SELLRATE,            
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
  FLAG = 1,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
               
 FROM                             
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                         
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
                            
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),  
  F.SAUDA_DATE  
                             
 UNION                            
                             
 SELECT                    
  EXCHANGE = 'NCDX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  TRADETYPE = '',                            
  PARTY_CODE = C1.PARENTCODE,                            
  INST_TYPE = '',                            
  SYMBOL = '** LEVIES **',                            
  EXPIRYDATE = '',              
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                            
  CL_RATE = 0,                            
  BUYQTY = 0,                            
  BUYRATE = 0,                            
  SELLQTY = 0,                            
  SELLRATE = 0,                            
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
  FLAG = 2,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
  SCRIP_NAME = '** LEVIES **',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
                             
 FROM                             
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                            
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)     
     
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  C1.PARENTCODE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
           
 -----------------------------------------------------------------------------           
 --                            NOW DOING MCX-SX                             --                      
 -----------------------------------------------------------------------------                      
 UNION                  
                   
                   
 SELECT                             
  EXCHANGE = 'MCXSX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  PARTY_CODE = C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,        
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum   
     
      
 (f.pqty) Else 0 End End as BUYRATE,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
(  
     
       
 f.sqty) Else 0 End End AS SELLRATE,            
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
  FLAG = 1,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM                             
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                         
  INNER JOIN                 
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
                            
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
  F.SAUDA_DATE             
                             
 UNION                            
                             
 SELECT                    
  EXCHANGE = 'MCXSX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  TRADETYPE = '',                            
  PARTY_CODE = C1.PARENTCODE,                            
  INST_TYPE = '',                            
  SYMBOL = '** LEVIES **',                            
  EXPIRYDATE = '',                            
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                            
  CL_RATE = 0,                            
  BUYQTY = 0,                            
  BUYRATE = 0,                            
  SELLQTY = 0,                      
  SELLRATE = 0,                            
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
  FLAG = 2,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
  SCRIP_NAME = '** LEVIES **',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
                             
 FROM                             
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                            
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)  
     
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                            
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  C1.PARENTCODE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
           
 -----------------------------------------------------------------------------                      
 --                            NOW DOING NSX                               --                      
 -----------------------------------------------------------------------------                      
 UNION                  
                   
                   
 SELECT                             
  EXCHANGE = 'NSX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  PARTY_CODE=C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,            
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
  FLAG = 1,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM                             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                         
  INNER JOIN                 
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)     
                            
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  F.TRADETYPE,                            
  C1.PARENTCODE,                            
  F.INST_TYPE,                            
  F.SYMBOL,                            
  F.EXPIRYDATE,                            
  F.OPTION_TYPE,                            
  F.STRIKE_PRICE,                            
  F.CL_RATE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
  F.SAUDA_DATE            
                             
 UNION                            
                             
 SELECT                    
  EXCHANGE = 'NSX',                  
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  TRADETYPE = '',                            
  PARTY_CODE = C1.PARENTCODE,                            
  INST_TYPE = '',                            
  SYMBOL = '** LEVIES **',                            
  EXPIRYDATE = '',                            
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                            
  CL_RATE = 0,                            
  BUYQTY = 0,                            
  BUYRATE = 0,                            
  SELLQTY = 0,                            
  SELLRATE = 0,                            
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
  FLAG = 2,                            
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
  SCRIP_NAME = '** LEVIES **',              
  LONG_NAME = '',  
  BRANCH_CD = '',  
  SUB_BROKER = '',  
  L_ADDRESS1 = '',  
  L_ADDRESS2 = '',  
  L_ADDRESS3 = '',  
  L_CITY = '',  
  L_STATE = '',  
  L_ZIP = '',  
  MOBILE_PAGER = '',  
  RES_PHONE1 = '',  
  RES_PHONE2 = '',  
  OFF_PHONE1 = ''  
 FROM                             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                            
  INNER JOIN                                
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                         
  ON (F.PARTY_CODE = C1.PARTY_CODE)     
     
 WHERE                             
  C1.PARENTCODE >= @FROMPARTYCODE                            
  AND C1.PARENTCODE <= @TOPARTYCODE                            
  AND F.SAUDA_DATE >= @FROMDATE                            
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA              
    WHEN @STATUSID = 'REGION' THEN C1.REGION                        
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
    ELSE 'I DONT KNOW ' END)                         
  AND (CASE  
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
   ELSE F.PARTY_CODE  
  END)  
  BETWEEN @FROMCODE AND @TOCODE  
  
 GROUP BY                             
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
  C1.PARENTCODE,                            
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)  
  
 ) SS  
ORDER BY  
 PARTY_CODE,  
 1,  
 SAUDA_DATE,  
 FLAG,  
 INST_TYPE,  
 SYMBOL,  
 EXPIRYDATE,  
 OPTION_TYPE,  
 STRIKE_PRICE  
  
 UPDATE   
  #SAUDASUMMARY   
 SET   
  LONG_NAME = C1.LONG_NAME,  
  BRANCH_CD = C1.BRANCH_CD,  
  SUB_BROKER = C1.SUB_BROKER,  
  L_ADDRESS1 = C1.L_ADDRESS1,  
  L_ADDRESS2 = C1.L_ADDRESS2,  
  L_ADDRESS3 = C1.L_ADDRESS3,  
  L_CITY  = C1.L_CITY,  
  L_STATE  = C1.L_STATE,  
  L_ZIP  = C1.L_ZIP,  
  MOBILE_PAGER= C1.MOBILE_PAGER,  
  RES_PHONE1 = C1.RES_PHONE1,  
  RES_PHONE2 = C1.RES_PHONE2,  
  OFF_PHONE1 = C1.OFF_PHONE1  
 FROM  
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1 (NOLOCK)  
 WHERE  
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE  
  
 SELECT * FROM #SAUDASUMMARY  
 ORDER BY  
  PARTY_CODE,  
  1,  
  SAUDA_DATE,  
  FLAG,  
  INST_TYPE,  
  SYMBOL,  
  EXPIRYDATE,  
  OPTION_TYPE,  
  STRIKE_PRICE  
  
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_bak_04102017
-- --------------------------------------------------






          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 @FROMCODE VARCHAR(15) ,          
 @TOCODE VARCHAR(15) ,          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_STEST 'BROKER','BROKER', 'RP61', 'RP61', 'APR  1 2014', 'MAY 18 2015' , 'RP61', 'RP61'                                              
*/                                    
                                    
AS                                    

--DECLARE @FROMCODE VARCHAR(15)
--DECLARE @TOCODE VARCHAR(15)
          
SET @FROMCODE =@FROMPARTYCODE 
SET @TOCODE =@TOPARTYCODE       

--PRINT @FROMCODE
--PRINT @TOCODE
--RETURN 
select * INTO #CLI from ANAND1.MSAJAG.dbo.CLIENT_DETAILS where PARENTCODE >=@FROMPARTYCODE 
AND PARENTCODE <=@TOPARTYCODE 
   
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          )A
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 --UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE      
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
--UNION      
INSERT INTO #SAUDASUMMARY     
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum((PRATE*PQTY)+PBROKAMT)/SUM(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum((SRATE*SQTY)+SBROKAMT)/SUM(f.Sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
-- ) SS          
--ORDER BY          
-- PARTY_CODE,          
-- 1,          
-- SAUDA_DATE,          
-- FLAG,          
-- INST_TYPE,          
-- SYMBOL,          
-- EXPIRYDATE,          
-- OPTION_TYPE,          
-- STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  #CLI C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_BAKDEC292016
-- --------------------------------------------------


          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_STEST]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 @FROMCODE VARCHAR(15) ,          
 @TOCODE VARCHAR(15) ,          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_STEST 'BROKER','BROKER', 'RP61', 'RP61', 'APR  1 2014', 'MAY 18 2015' , 'RP61', 'RP61'                                              
*/                                    
                                    
AS                                    

--DECLARE @FROMCODE VARCHAR(15)
--DECLARE @TOCODE VARCHAR(15)
          
SET @FROMCODE =@FROMPARTYCODE 
SET @TOCODE =@TOPARTYCODE       

--PRINT @FROMCODE
--PRINT @TOCODE
--RETURN 
select * INTO #CLI from ANAND1.MSAJAG.dbo.CLIENT_DETAILS where PARENTCODE >=@FROMPARTYCODE 
AND PARENTCODE <=@TOPARTYCODE 
   
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          )A
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 --UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE         
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
 INSERT INTO #SAUDASUMMARY                          
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE      
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
--UNION      
INSERT INTO #SAUDASUMMARY     
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
        
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                           
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            

 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE            
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 --UNION                          
                
  INSERT INTO #SAUDASUMMARY                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
   --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  --AND (CASE          
  -- WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
  -- WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
  -- WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
  -- WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
  -- WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
  -- WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
  -- ELSE F.PARTY_CODE          
  --END)  
 AND F.PARTY_CODE          
  BETWEEN @FROMCODE AND @TOCODE           
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
-- ) SS          
--ORDER BY          
-- PARTY_CODE,          
-- 1,          
-- SAUDA_DATE,          
-- FLAG,          
-- INST_TYPE,          
-- SYMBOL,          
-- EXPIRYDATE,          
-- OPTION_TYPE,          
-- STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  #CLI C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_BKP_2606
-- --------------------------------------------------

          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 @FROMCODE VARCHAR(15) ,          
 @TOCODE VARCHAR(15) ,          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEWT 'BROKER','BROKER', 'RP61', 'RP61', 'APR  1 2015', 'MAY 18 2015'                                                 
*/                                    
                                    
AS                                    

--DECLARE @FROMCODE VARCHAR(15)
--DECLARE @TOCODE VARCHAR(15)
          
SET @FROMCODE =@FROMPARTYCODE 
SET @TOCODE =@TOPARTYCODE       

--PRINT @FROMCODE
--PRINT @TOCODE

--RETURN 
select * INTO #CLI from ANAND1.MSAJAG.dbo.CLIENT_DETAILS where PARENTCODE >=@FROMPARTYCODE 
AND PARENTCODE <=@TOPARTYCODE 
   
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
 WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
UNION      
      
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  #CLI C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
 ) SS          
ORDER BY          
 PARTY_CODE,          
 1,          
 SAUDA_DATE,          
 FLAG,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  #CLI C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_SA
-- --------------------------------------------------
      
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_SA]      
 (                                
 @STATUSID VARCHAR(25),                            
 @STATUSNAME VARCHAR(25),                            
 @FROMPARTYCODE VARCHAR(10),                                    
 @TOPARTYCODE VARCHAR(10),                                    
 @FROMDATE VARCHAR(11),                                    
 @TODATE VARCHAR(11),      
 @FROMCODE VARCHAR(15)='',      
 @TOCODE VARCHAR(15)='zzzzzzzzzz',      
 @RPT_BY VARCHAR(15)='BROKER'      
 )                                
                                
/*                                
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                              
*/                                
                                
AS                                
      
IF @TOCODE = ''      
BEGIN      
 SET @TOCODE = 'zzzzzzzzzz'      
END      
                  
-----------------------------------------------------------------------------                          
--                           NOW DOING NSEFO (LIVE)                        --                          
-----------------------------------------------------------------------------                          
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
SELECT      
 EXCHANGE,      
 TRADEDATE,      
 TRADETYPE,      
 PARTY_CODE,      
 INST_TYPE,      
 SYMBOL,      
 EXPIRYDATE,      
 OPTION_TYPE,      
 STRIKE_PRICE,      
 CL_RATE,      
 BUYQTY,      
 BUYRATE,      
 SELLQTY,      
 SELLRATE,      
 NETAMOUNT,      
 FLAG,      
 SAUDA_DATE,      
 SCRIP_NAME,      
 LONG_NAME = CONVERT(VARCHAR(100),''),      
 BRANCH_CD = CONVERT(VARCHAR(15),''),      
 SUB_BROKER = CONVERT(VARCHAR(15),''),      
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),      
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),      
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),      
 L_CITY  = CONVERT(VARCHAR(50),''),      
 L_STATE  = CONVERT(VARCHAR(50),''),      
 L_ZIP  = CONVERT(VARCHAR(25),''),      
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),      
 RES_PHONE1  = CONVERT(VARCHAR(50),''),      
 RES_PHONE2  = CONVERT(VARCHAR(50),''),      
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')      
INTO      
 #SAUDASUMMARY      
FROM      
 (      
 SELECT                                 
  EXCHANGE = 'F&O',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,      
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',     
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM      
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                             
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                  
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
  F.SAUDA_DATE      
                                
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'F&O',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                       
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                  
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                           
 -----------------------------------------------------------------------------                          
 --                            NOW DOING MCDX (LIVE)                        --                          
 -----------------------------------------------------------------------------                          
 UNION                      
                       
                       
 SELECT                                 
  EXCHANGE = 'MCX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,      
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
                                
 WHERE                       
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY               
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                               
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'MCX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE= C1.PARENTCODE,      
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                        
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                         
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1          
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                                 
                       
 UNION                      
                           
 -----------------------------------------------------------------------------                          
 --                            NOW DOING NCDX (LIVE)                        --                          
 -----------------------------------------------------------------------------                          
                       
                       
 SELECT                                 
  EXCHANGE = 'NCDX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                   
 FROM                                 
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                             
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
  F.SAUDA_DATE      
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'NCDX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                  
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
               
 -----------------------------------------------------------------------------               
 --                            NOW DOING MCX-SX (LIVE)                            --                          
 -----------------------------------------------------------------------------                          
 UNION                      
                       
                       
 SELECT                                 
  EXCHANGE = 'MCXSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                               
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                              
  F.SAUDA_DATE                 
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'MCXSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                   
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                          
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
               
 -----------------------------------------------------------------------------                          
 --                            NOW DOING NSX (LIVE)                              --                          
 -----------------------------------------------------------------------------                          
 UNION                      
                       
                       
 SELECT                                 
  EXCHANGE = 'NSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE=C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM         
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                              
  F.SAUDA_DATE                
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'NSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                      
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
      
     
    
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.    
    
-----------------------------------------------------------------------------                          
--                            NOW DOING NSEFO (ARCHIVE)                    --                          
-----------------------------------------------------------------------------                          
                               
UNION  
  
 SELECT                                 
  EXCHANGE = 'F&O',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,      
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM      
  ACDLFO.NSEFO.DBO.FOBILLVALAN F                             
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                  
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
  F.SAUDA_DATE      
                                
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'F&O',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                       
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ACDLFO.NSEFO.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY       
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                  
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                           
 -----------------------------------------------------------------------------                          
 --                         NOW DOING MCDX (ARCHIVE)                        --                          
 -----------------------------------------------------------------------------                          
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011 : Open By Dharmeh on 27/08/2011
UNION                      
                       
                       
 SELECT                                 
  EXCHANGE = 'MCX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,      
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  NSEARC.MCDX.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
        
 WHERE                       
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY               
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                               
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'MCX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE= C1.PARENTCODE,      
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  NSEARC.MCDX.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                               
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
                                 
                       
 UNION                      
                           
 -----------------------------------------------------------------------------                          
 --                          NOW DOING NCDX (ARCHIVE)                       --                          
 -----------------------------------------------------------------------------                          
                       
                       
 SELECT                                 
  EXCHANGE = 'NCDX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                          
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                   
 FROM                                 
  NSEARC.NCDX.DBO.FOBILLVALAN F                             
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
  F.SAUDA_DATE      
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'NCDX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                  
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  NSEARC.NCDX.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) 
     
               
 -----------------------------------------------------------------------------               
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                          
 -----------------------------------------------------------------------------                          
 UNION                      
                       
                       
 SELECT                                 
  EXCHANGE = 'MCXSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE = C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,            
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ACDLFO.MCDXCDS.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                              
  F.SAUDA_DATE                 
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'MCXSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                                
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                          
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
                                 
 FROM                                 
  ACDLFO.MCDXCDS.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)      
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
               
 -----------------------------------------------------------------------------                          
 --                      NOW DOING NSX (ARCHIVE)                            --                          
 -----------------------------------------------------------------------------                          
 UNION                      
            
                       
 SELECT                                 
  EXCHANGE = 'NSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  PARTY_CODE=C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                  
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                
  FLAG = 1,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),     
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
  RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ACDLFO.NSECURFO.DBO.FOBILLVALAN F                             
  INNER JOIN                     
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
                                
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                            
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  F.TRADETYPE,                                
  C1.PARENTCODE,                                
  F.INST_TYPE,                                
  F.SYMBOL,                                
  F.EXPIRYDATE,                                
  F.OPTION_TYPE,                                
  F.STRIKE_PRICE,                                
  F.CL_RATE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                              
  F.SAUDA_DATE                
                                 
 UNION                                
                                 
 SELECT                        
  EXCHANGE = 'NSX',                      
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  TRADETYPE = '',                                
  PARTY_CODE = C1.PARENTCODE,                                
  INST_TYPE = '',                                
  SYMBOL = '** LEVIES **',                                
  EXPIRYDATE = '',                                
  OPTION_TYPE = '',                        
  STRIKE_PRICE  = 0,                                
  CL_RATE = 0,                                
  BUYQTY = 0,                                
  BUYRATE = 0,                                
  SELLQTY = 0,                                
  SELLRATE = 0,                                
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                
  FLAG = 2,                                
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                
  SCRIP_NAME = '** LEVIES **',                  
  LONG_NAME = '',      
  BRANCH_CD = '',      
  SUB_BROKER = '',      
  L_ADDRESS1 = '',      
  L_ADDRESS2 = '',      
  L_ADDRESS3 = '',      
  L_CITY = '',      
  L_STATE = '',      
  L_ZIP = '',      
  MOBILE_PAGER = '',      
RES_PHONE1 = '',      
  RES_PHONE2 = '',      
  OFF_PHONE1 = ''      
 FROM                                 
  ACDLFO.NSECURFO.DBO.FOBILLVALAN F                                
  INNER JOIN                                    
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                             
  ON (F.PARTY_CODE = C1.PARTY_CODE)         
         
 WHERE                                 
  C1.PARENTCODE >= @FROMPARTYCODE                                
  AND C1.PARENTCODE <= @TOPARTYCODE                                
  AND F.SAUDA_DATE >= @FROMDATE                                
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                  
    WHEN @STATUSID = 'REGION' THEN C1.REGION                            
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                            
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                            
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                            
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                            
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                            
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                            
    ELSE 'I DONT KNOW ' END)                             
  AND (CASE      
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY      
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION      
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA      
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER      
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER      
   ELSE F.PARTY_CODE      
  END)      
  BETWEEN @FROMCODE AND @TOCODE      
      
 GROUP BY                                 
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                
  C1.PARENTCODE,                                
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)      
      
 ) SS      
ORDER BY      
 PARTY_CODE,      
 1,      
 SAUDA_DATE,      
 FLAG,      
 INST_TYPE,      
 SYMBOL,      
 EXPIRYDATE,      
 OPTION_TYPE,      
 STRIKE_PRICE      
    
--------------- SAMIT CHANGES END HERE.     
 UPDATE       
  #SAUDASUMMARY       
 SET       
  LONG_NAME = C1.LONG_NAME,      
  BRANCH_CD = C1.BRANCH_CD,      
  SUB_BROKER = C1.SUB_BROKER,      
  L_ADDRESS1 = C1.L_ADDRESS1,      
  L_ADDRESS2 = C1.L_ADDRESS2,      
  L_ADDRESS3 = C1.L_ADDRESS3,      
  L_CITY  = C1.L_CITY,      
  L_STATE  = C1.L_STATE,      
  L_ZIP  = C1.L_ZIP,      
  MOBILE_PAGER= C1.MOBILE_PAGER,      
  RES_PHONE1 = C1.RES_PHONE1,      
  RES_PHONE2 = C1.RES_PHONE2,      
  OFF_PHONE1 = C1.OFF_PHONE1      
 FROM      
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1 (NOLOCK)      
 WHERE      
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE      
      
 SELECT * FROM #SAUDASUMMARY      
 ORDER BY      
  PARTY_CODE,      
  1,      
  SAUDA_DATE,      
  FLAG,      
  INST_TYPE,      
  SYMBOL,      
  EXPIRYDATE,     
  OPTION_TYPE,      
  STRIKE_PRICE      
      
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_TEST
-- --------------------------------------------------

          
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_TEST]          
 (                                    
 @STATUSID VARCHAR(25),                                
 @STATUSNAME VARCHAR(25),                                
 @FROMPARTYCODE VARCHAR(10),                                        
 @TOPARTYCODE VARCHAR(10),                                        
 @FROMDATE VARCHAR(11),                                        
 @TODATE VARCHAR(11),          
 --@FROMCODE VARCHAR(15) ,          
 --@TOCODE VARCHAR(15) ,          
 @RPT_BY VARCHAR(15)='BROKER'          
 )                                    
                                    
/*                                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_ALL_NEW_TEST 'BROKER','BROKER', 'a0001', 'a0001', 'MAY 18 2015', 'MAY 18 2015'                                                 
*/                                    
                                    
AS                                    

DECLARE @FROMCODE VARCHAR(15)
DECLARE @TOCODE VARCHAR(15)
          
SET @FROMCODE =@FROMPARTYCODE 
SET @TOCODE =@TOPARTYCODE       

PRINT @FROMCODE
PRINT @TOCODE

RETURN 

   
                      
-----------------------------------------------------------------------------                              
--                           NOW DOING NSEFO (LIVE)                        --                              
-----------------------------------------------------------------------------                              
                                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
SELECT          
 EXCHANGE,          
 TRADEDATE,          
 TRADETYPE,          
 PARTY_CODE,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE,          
 CL_RATE,          
 BUYQTY,          
 BUYRATE,          
 SELLQTY,          
 SELLRATE,          
 NETAMOUNT,          
 FLAG,          
 SAUDA_DATE,          
 SCRIP_NAME,          
 LONG_NAME = CONVERT(VARCHAR(100),''),          
 BRANCH_CD = CONVERT(VARCHAR(15),''),          
 SUB_BROKER = CONVERT(VARCHAR(15),''),          
 L_ADDRESS1  = CONVERT(VARCHAR(100),''),          
 L_ADDRESS2 = CONVERT(VARCHAR(100),''),          
 L_ADDRESS3  = CONVERT(VARCHAR(100),''),          
 L_CITY  = CONVERT(VARCHAR(50),''),          
 L_STATE  = CONVERT(VARCHAR(50),''),          
 L_ZIP  = CONVERT(VARCHAR(25),''),          
 MOBILE_PAGER  = CONVERT(VARCHAR(25),''),          
 RES_PHONE1  = CONVERT(VARCHAR(50),''),          
 RES_PHONE2  = CONVERT(VARCHAR(50),''),          
 OFF_PHONE1 = CONVERT(VARCHAR(50),'')          
INTO          
 #SAUDASUMMARY          
FROM          
 (          
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',         
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                             
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING MCDX (LIVE)                        --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum  
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)       
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                             
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1              
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NCDX (LIVE)                        --                               -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
 WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (LIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
    
(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                   
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                       
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                            NOW DOING NSX (LIVE)                              --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
 
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',    
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM             
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                          
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ANGELFO.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD      
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
         
        
---- FETCHING DETAILS FROM ARCHIVAL SERVER -- CHANGES FROM SAMIT START HERE.        
        
-----------------------------------------------------------------------------                              
--                            NOW DOING NSEFO (ARCHIVE)                    --                              
-----------------------------------------------------------------------------                              
                                   
UNION      
      
 SELECT                                     
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                
  
    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
   
     
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM          
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                    
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'F&O',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                           
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSEFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY           
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)                      
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                               
 -----------------------------------------------------------------------------                              
 --                         NOW DOING MCDX (ARCHIVE)                        --                              
 -----------------------------------------------------------------------------                              
-- Commented because data deletion is pending from Commodity database server by Samit by 25 Jul 2011     
/*UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,          
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
m    
(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
            
 WHERE                           
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                   
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                   
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE= C1.PARENTCODE,          
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.MCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                   
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                                     
                           
 UNION                          
                               
 -----------------------------------------------------------------------------                              
 --                          NOW DOING NCDX (ARCHIVE)               --                              
 -----------------------------------------------------------------------------                              
                           
                           
 SELECT                                     
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                              
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Su
  
    
m(f.pqty) Else 0 End End AS BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                       
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                 
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
  F.SAUDA_DATE          
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NCDX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                      
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  NSEARC.NCDX.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)     
*/         
                   
 -----------------------------------------------------------------------------                   
 --                            NOW DOING MCX-SX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                           
                           
 SELECT                                     
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,                
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BUYRATE,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum
  
    
(f.sqty) Else 0 End End AS SELLRATE,                    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                                    
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                     
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'MCXSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                                    
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                              
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
                                     
 FROM                                     
  ABCSOBOARCHIVAL.MCDXCDS.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)          
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                    
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
                   
 -----------------------------------------------------------------------------                              
 --                      NOW DOING NSX (ARCHIVE)                            --                              
 -----------------------------------------------------------------------------                              
 UNION                          
                
                           
 SELECT                                     
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  PARTY_CODE=C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,                    
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,                 
  
   
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                                      
  Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,                
  
    
  NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                                    
  FLAG = 1,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),         
  SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
  RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                 
  INNER JOIN                         
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
                                    
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                                
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  F.TRADETYPE,                                    
  C1.PARENTCODE,                                    
  F.INST_TYPE,                                    
  F.SYMBOL,                                    
  F.EXPIRYDATE,                                    
  F.OPTION_TYPE,                                    
  F.STRIKE_PRICE,                                    
  F.CL_RATE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                  
  F.SAUDA_DATE                    
                                     
 UNION                                    
                                     
 SELECT                            
  EXCHANGE = 'NSX',                          
  TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  TRADETYPE = '',                                    
  PARTY_CODE = C1.PARENTCODE,                                    
  INST_TYPE = '',                                    
  SYMBOL = '** LEVIES **',                                    
  EXPIRYDATE = '',                                    
  OPTION_TYPE = '',                            
  STRIKE_PRICE  = 0,                                    
  CL_RATE = 0,                                    
  BUYQTY = 0,                                    
  BUYRATE = 0,                                    
  SELLQTY = 0,                                    
  SELLRATE = 0,                                    
  NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                                    
  FLAG = 2,                                    
  SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                                    
  SCRIP_NAME = '** LEVIES **',                      
  LONG_NAME = '',          
  BRANCH_CD = '',          
  SUB_BROKER = '',          
  L_ADDRESS1 = '',          
  L_ADDRESS2 = '',          
  L_ADDRESS3 = '',          
  L_CITY = '',          
  L_STATE = '',          
  L_ZIP = '',          
  MOBILE_PAGER = '',          
RES_PHONE1 = '',          
  RES_PHONE2 = '',          
  OFF_PHONE1 = ''          
 FROM                                     
  ABCSOBOARCHIVAL.NSECURFO.DBO.FOBILLVALAN F                                    
  INNER JOIN                                        
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1                                 
  ON (F.PARTY_CODE = C1.PARTY_CODE)             
             
 WHERE                                     
  C1.PARENTCODE >= @FROMPARTYCODE                                    
  AND C1.PARENTCODE <= @TOPARTYCODE                                    
  AND F.SAUDA_DATE >= @FROMDATE                                    
  AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                                    
  AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
    WHEN @STATUSID = 'REGION' THEN C1.REGION                                
    WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                                
    WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                                
    WHEN @STATUSID = 'TRADER' THEN C1.TRADER                                
    WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                                
    WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                                
    WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                                
    ELSE 'I DONT KNOW ' END)                                 
  AND (CASE          
   WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY          
   WHEN @RPT_BY = 'REGION'  THEN C1.REGION          
   WHEN @RPT_BY = 'AREA'  THEN C1.AREA          
   WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD          
   WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER          
   WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER          
   ELSE F.PARTY_CODE          
  END)          
  BETWEEN @FROMCODE AND @TOCODE          
          
 GROUP BY                                     
  CONVERT(VARCHAR,F.SAUDA_DATE,103),                                    
  C1.PARENTCODE,                                    
  CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)          
          
 ) SS          
ORDER BY          
 PARTY_CODE,          
 1,          
 SAUDA_DATE,          
 FLAG,          
 INST_TYPE,          
 SYMBOL,          
 EXPIRYDATE,          
 OPTION_TYPE,          
 STRIKE_PRICE          
        
--------------- SAMIT CHANGES END HERE.         
 UPDATE           
  #SAUDASUMMARY           
 SET           
  LONG_NAME = C1.LONG_NAME,          
  BRANCH_CD = C1.BRANCH_CD,          
  SUB_BROKER = C1.SUB_BROKER,          
  L_ADDRESS1 = C1.L_ADDRESS1,          
  L_ADDRESS2 = C1.L_ADDRESS2,          
  L_ADDRESS3 = C1.L_ADDRESS3,          
  L_CITY  = C1.L_CITY,          
  L_STATE  = C1.L_STATE,          
  L_ZIP  = C1.L_ZIP,          
  MOBILE_PAGER= C1.MOBILE_PAGER,          
  RES_PHONE1 = C1.RES_PHONE1,          
  RES_PHONE2 = C1.RES_PHONE2,          
  OFF_PHONE1 = C1.OFF_PHONE1          
 FROM          
  ANAND1.MSAJAG.dbo.CLIENT_DETAILS C1 (NOLOCK)          
 WHERE          
  #SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE          
          
 SELECT * FROM #SAUDASUMMARY          
 ORDER BY          
  PARTY_CODE,          
  1,          
  SAUDA_DATE,          
  FLAG,          
  INST_TYPE,          
  SYMBOL,          
  EXPIRYDATE,         
  OPTION_TYPE,          
  STRIKE_PRICE          
          
DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_devang
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_FOPRINT_devang     
(     
@BRANCHNAME  VARCHAR(25),          
 @STATUSID VARCHAR(25),                    
 @STATUSNAME VARCHAR(25),                    
 @FROMPARTYCODE VARCHAR(10),                            
 @TOPARTYCODE VARCHAR(10),                            
 @FROMDATE VARCHAR(11),                            
 @TODATE VARCHAR(11)                            
)                        
                        
/*                        
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'KNPR1363', 'KNPR1363', 'NOV  1 2008', 'NOV 10 2008'                                      
*/                        
                        
AS                        
          
-----------------------------------------------------------------------------                  
--                            NOW DOING NSEFO                              --                  
-----------------------------------------------------------------------------                  
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
SELECT                         
 EXCHANGE = 'F&O',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BuyRate,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SellRate,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                     
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE)                    
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)          
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,                      
 C1.SHORT_NAME,         
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                       
UNION                        
                        
SELECT                
 EXCHANGE = 'F&O',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE)                   
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)          
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                  
-----------------------------------------------------------------------------                  
--                            NOW DOING MCDX                              --                  
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'MCX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
 
(f.pqty) Else 0 End End AS BuyRate,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SellRate,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                     
 INNER JOIN             
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE)
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'MCX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE)                
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--THEN @STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
              
UNION              
                  
-----------------------------------------------------------------------------                  
--                            NOW DOING NCDX                              --                  
-----------------------------------------------------------------------------                  
              
              
SELECT                         
 EXCHANGE = 'NCDX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(
  
f.pqty) Else 0 End End AS BuyRate,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SellRate,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
          
FROM                         
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                     
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE)                   
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--THEN @STATUSNAME    
                            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'NCDX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',          
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--@STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,        
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
      
-----------------------------------------------------------------------------       
--                            NOW DOING MCX-SX                             --                  
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'MCXSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
  
(f.pqty) Else 0 End End as BuyRate,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
f.sqty) Else 0 End End AS SellRate,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                     
 INNER JOIN             
ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--@STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'MCXSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                  
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                        
 INNER JOIN                            
 ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--@STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1       
      
-----------------------------------------------------------------------------                  
--                            NOW DOING NSX                               --            
-----------------------------------------------------------------------------                  
UNION              
              
              
SELECT                         
 EXCHANGE = 'NSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BuyRate,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SellRate,        
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                        
 FLAG = 1,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                        
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,       
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
FROM                         
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                     
 INNER JOIN             
ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 
                       
WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                    
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--@STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.TRADETYPE,                        
 F.PARTY_CODE,                        
 F.INST_TYPE,                        
 F.SYMBOL,                        
 F.EXPIRYDATE,                        
 F.OPTION_TYPE,                        
 F.STRIKE_PRICE,                        
 F.CL_RATE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                      
 F.SAUDA_DATE,          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,     
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                      
                        
UNION                        
                        
SELECT                
 EXCHANGE = 'NSX',              
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 TRADETYPE = '',                        
 F.PARTY_CODE,                        
 INST_TYPE = '',                        
 SYMBOL = '** LEVIES **',                        
 EXPIRYDATE = '',                        
 OPTION_TYPE = '',                        
 STRIKE_PRICE  = 0,                        
 CL_RATE = 0,                        
 BUYQTY = 0,                        
 BUYRATE = 0,                        
 SELLQTY = 0,                        
 SELLRATE = 0,                        
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                        
 FLAG = 2,                        
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 SCRIP_NAME = '** LEVIES **',          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1          
                        
FROM                         
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                        
 INNER JOIN                            
ANAND.Pradnya.dbo.TBL_ECNFo C1                     
 ON (F.PARTY_CODE = C1.PARTY_CODE) 

WHERE                         
 F.PARTY_CODE >= @FROMPARTYCODE                        
 AND F.PARTY_CODE <= @TOPARTYCODE                        
 AND F.SAUDA_DATE >= @FROMDATE                        
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                        
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA          
            WHEN @STATUSID = 'REGION' THEN C1.REGION                    
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
            WHEN @STATUSID = 'CLIENT' THEN C1.PARTY_CODE                    
            WHEN @STATUSID = 'BROKER' THEN (CASE WHEN @BRANCHNAME <> 'ALL' THEN c1.branch_cd ELSE @STATUSNAME END)--@STATUSNAME                    
            ELSE 'I DONT KNOW ' END)                     
GROUP BY                         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                        
 F.PARTY_CODE,                        
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),          
 C1.SHORT_NAME,          
 C1.BRANCH_CD,          
 C1.SUB_BROKER,          
 C1.L_ADDRESS1,          
 C1.L_ADDRESS2,          
 C1.L_ADDRESS3,          
 C1.L_CITY,          
 C1.L_STATE,          
 C1.L_ZIP,          
 C1.MOBILE_PAGER,          
 C1.RES_PHONE1,          
 C1.RES_PHONE2,          
 C1.OFF_PHONE1       
      
ORDER BY                        
 F.PARTY_CODE,                      
 1,                
 SAUDA_DATE,                        
 FLAG,                        
 INST_TYPE,                        
 SYMBOL,                        
 EXPIRYDATE,                        
 OPTION_TYPE,                        
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_dh
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_FOPRINT_dh         
(                      
 @FROMPARTYCODE VARCHAR(10),                              
 @TOPARTYCODE VARCHAR(10),                              
 @FROMDATE VARCHAR(11),                              
 @TODATE VARCHAR(11)                              
)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'a1160', 'a1160', 'jul  1 2009', 'jul 31 2009'                                        
*/                          
                          
AS 
          
-----------------------------------------------------------------------------                    
--                            NOW DOING NSEFO                              --                    
-----------------------------------------------------------------------------                    
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
INSERT INTO CLASSPROC_SAUDA_SUMMARYFOPRINT_dh                          
SELECT                           
 EXCHANGE = 'F&O',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                       
 INNER JOIN                              
ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                     
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,                        
 C1.SHORT_NAME,           
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                         
UNION                          
     
                    
SELECT                  
 EXCHANGE = 'F&O',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                    
-----------------------------------------------------------------------------                    
--                            NOW DOING MCDX                              --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'MCX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
  
   
(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                       
 INNER JOIN               
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'MCX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
                
UNION                
                    
-----------------------------------------------------------------------------                    
--                            NOW DOING NCDX                              --                    
-----------------------------------------------------------------------------                    
                
                
SELECT                           
 EXCHANGE = 'NCDX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
 
(    
f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
            
FROM                           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                       
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'NCDX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',            
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
        
-----------------------------------------------------------------------------         
--                            NOW DOING MCX-SX                             --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'MCXSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
  
   
(f.pqty) Else 0 End End as BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                       
 INNER JOIN               
ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'MCXSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                    
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1         
        
-----------------------------------------------------------------------------                    
--                            NOW DOING NSX                               --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'NSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,         
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                       
 INNER JOIN               
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'NSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1         
        
ORDER BY                          
 F.PARTY_CODE,                        
 1,                  
 SAUDA_DATE,                          
 FLAG,                          
 INST_TYPE,                          
 SYMBOL,                          
 EXPIRYDATE,                          
 OPTION_TYPE,                          
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_dkm
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_FOPRINT_dkm     
(                    
 @STATUSID VARCHAR(25),                
 @STATUSNAME VARCHAR(25),                
 @FROMPARTYCODE VARCHAR(10),                        
 @TOPARTYCODE VARCHAR(10),                        
 @FROMDATE VARCHAR(11),                        
 @TODATE VARCHAR(11)                        
)                    
                    
/*                    
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_dkm 'BROKER','BROKER', 'KNPR1363', 'KNPR1363', 'NOV  1 2008', 'NOV 10 2008'                                  
*/                    
                    
AS                    
      
-----------------------------------------------------------------------------              
--                            NOW DOING NSEFO                              --              
-----------------------------------------------------------------------------              
                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                    
SELECT                     
 EXCHANGE = 'F&O',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BuyRate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SellRate,    
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                    
 FLAG = 1,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                    
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
FROM                     
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                 
 INNER JOIN                        
 ANGELFO.NSEFO.DBO.CLIENT2 C2                  
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)      
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                  
 F.SAUDA_DATE,                  
 C1.SHORT_NAME,     
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                   
UNION                    
                    
SELECT            
 EXCHANGE = 'F&O',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 TRADETYPE = '',                    
 F.PARTY_CODE,                    
 INST_TYPE = '',                    
 SYMBOL = '** LEVIES **',                    
 EXPIRYDATE = '',                    
 OPTION_TYPE = '',                    
 STRIKE_PRICE  = 0,                    
 CL_RATE = 0,                    
 BUYQTY = 0,                    
 BUYRATE = 0,                    
 SELLQTY = 0,                    
 SELLRATE = 0,                    
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                    
 FLAG = 2,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                    
 SCRIP_NAME = '** LEVIES **',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
FROM                     
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                    
 INNER JOIN                        
 ANGELFO.NSEFO.DBO.CLIENT2 C2                  
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)      
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.PARTY_CODE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
              
-----------------------------------------------------------------------------              
--                            NOW DOING MCDX                              --              
-----------------------------------------------------------------------------              
UNION          
          
          
SELECT                     
 EXCHANGE = 'MCX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BuyRate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SellRate,    
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                    
 FLAG = 1,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                    
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
FROM                     
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                 
 INNER JOIN         
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
                   
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                  
 F.SAUDA_DATE,      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                  
                    
UNION                    
                    
SELECT            
 EXCHANGE = 'MCX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 TRADETYPE = '',                    
 F.PARTY_CODE,                    
 INST_TYPE = '',                    
 SYMBOL = '** LEVIES **',                    
 EXPIRYDATE = '',                    
 OPTION_TYPE = '',                    
 STRIKE_PRICE  = 0,                    
 CL_RATE = 0,                    
 BUYQTY = 0,                    
 BUYRATE = 0,                    
 SELLQTY = 0,                    
 SELLRATE = 0,                    
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                    
 FLAG = 2,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                    
 SCRIP_NAME = '** LEVIES **',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
FROM                     
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                    
 INNER JOIN                        
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.PARTY_CODE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
          
UNION          
              
-----------------------------------------------------------------------------              
--                            NOW DOING NCDX                              --              
-----------------------------------------------------------------------------              
          
          
SELECT                     
 EXCHANGE = 'NCDX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End AS BuyRate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SellRate,    
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                    
 FLAG = 1,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                    
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
      
FROM                     
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                 
 INNER JOIN                        
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
                   
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                  
 F.SAUDA_DATE,      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                  
                    
UNION                    
                    
SELECT            
 EXCHANGE = 'NCDX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 TRADETYPE = '',                    
 F.PARTY_CODE,                    
 INST_TYPE = '',                    
 SYMBOL = '** LEVIES **',                    
 EXPIRYDATE = '',                    
 OPTION_TYPE = '',                    
 STRIKE_PRICE  = 0,                    
 CL_RATE = 0,                    
 BUYQTY = 0,                    
 BUYRATE = 0,                    
 SELLQTY = 0,                    
 SELLRATE = 0,                    
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                    
 FLAG = 2,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                    
 SCRIP_NAME = '** LEVIES **',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
FROM                     
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                    
 INNER JOIN                        
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.PARTY_CODE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
  
-----------------------------------------------------------------------------   
--                            NOW DOING MCX-SX                             --              
-----------------------------------------------------------------------------              
UNION          
          
          
SELECT                     
 EXCHANGE = 'MCXSX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End End as BuyRate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End End AS SellRate,    
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                    
 FLAG = 1,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                    
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
FROM                     
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                 
 INNER JOIN         
 ANGELCOMMODITY.MCDXCDS.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.MCDXCDS.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
                   
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                  
 F.SAUDA_DATE,      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                  
                    
UNION                    
                    
SELECT            
 EXCHANGE = 'MCXSX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 TRADETYPE = '',                    
 F.PARTY_CODE,                    
 INST_TYPE = '',                    
 SYMBOL = '** LEVIES **',                    
 EXPIRYDATE = '',                    
 OPTION_TYPE = '',                    
 STRIKE_PRICE  = 0,                    
 CL_RATE = 0,                    
 BUYQTY = 0,                    
 BUYRATE = 0,                    
 SELLQTY = 0,              
 SELLRATE = 0,                    
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                    
 FLAG = 2,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                    
 SCRIP_NAME = '** LEVIES **',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
FROM                     
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                    
 INNER JOIN                        
 ANGELCOMMODITY.MCDXCDS.DBO.CLIENT2 C2                  
 INNER JOIN ANGELCOMMODITY.MCDXCDS.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.PARTY_CODE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1   
  
-----------------------------------------------------------------------------              
--                            NOW DOING NSX                               --              
-----------------------------------------------------------------------------              
UNION          
          
          
SELECT                     
 EXCHANGE = 'NSX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BuyQty,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BuyRate,    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SellQty,                      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SellRate,    
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                    
 FLAG = 1,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                    
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
FROM                     
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                 
 INNER JOIN         
 ANGELFO.NSECURFO.DBO.CLIENT2 C2                  
 INNER JOIN ANGELFO.NSECURFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
                   
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.TRADETYPE,                    
 F.PARTY_CODE,                    
 F.INST_TYPE,                    
 F.SYMBOL,                    
 F.EXPIRYDATE,                    
 F.OPTION_TYPE,                    
 F.STRIKE_PRICE,                    
 F.CL_RATE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                  
 F.SAUDA_DATE,      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                  
                    
UNION                    
                    
SELECT            
 EXCHANGE = 'NSX',          
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 TRADETYPE = '',                    
 F.PARTY_CODE,                    
 INST_TYPE = '',                    
 SYMBOL = '** LEVIES **',                    
 EXPIRYDATE = '',                    
 OPTION_TYPE = '',                    
 STRIKE_PRICE  = 0,                    
 CL_RATE = 0,                    
 BUYQTY = 0,                    
 BUYRATE = 0,                    
 SELLQTY = 0,                    
 SELLRATE = 0,                    
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                    
 FLAG = 2,                    
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                    
 SCRIP_NAME = '** LEVIES **',      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1      
                    
FROM                     
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                    
 INNER JOIN                        
 ANGELFO.NSECURFO.DBO.CLIENT2 C2                  
 INNER JOIN ANGELFO.NSECURFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)                  
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)                
WHERE                     
 F.PARTY_CODE >= @FROMPARTYCODE                    
 AND F.PARTY_CODE <= @TOPARTYCODE                    
 AND F.SAUDA_DATE >= @FROMDATE                    
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                    
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                
            WHEN @STATUSID = 'REGION' THEN C1.REGION                
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE                
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
            ELSE 'I DONT KNOW ' END)                 
GROUP BY                     
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                    
 F.PARTY_CODE,                    
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),      
 C1.SHORT_NAME,      
 C1.BRANCH_CD,      
 C1.SUB_BROKER,      
 C1.L_ADDRESS1,      
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_ZIP,      
 C1.MOBILE_PAGER,      
 C1.RES_PHONE1,      
 C1.RES_PHONE2,      
 C1.OFF_PHONE1   
  
ORDER BY                    
 F.PARTY_CODE,                  
 1,            
 SAUDA_DATE,                    
 FLAG,                    
 INST_TYPE,                    
 SYMBOL,                    
 EXPIRYDATE,                    
 OPTION_TYPE,                    
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_JAN12009
-- --------------------------------------------------
CREATE PROC CLASSPROC_SAUDA_SUMMARY_FOPRINT_JAN12009
(                
 @STATUSID VARCHAR(25),            
 @STATUSNAME VARCHAR(25),            
 @FROMPARTYCODE VARCHAR(10),                    
 @TOPARTYCODE VARCHAR(10),                    
 @FROMDATE VARCHAR(11),                    
 @TODATE VARCHAR(11)                    
)                
                
/*                
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'FRBAD534', 'FRBAD534', 'NOV  1 2008', 'NOV 30 2008'                    
*/                
                
AS                
  
-----------------------------------------------------------------------------          
--                            NOW DOING NSEFO                              --          
-----------------------------------------------------------------------------          
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
SELECT                 
 EXCHANGE = 'F&O',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 BUYQTY = SUM(F.PQTY),                
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),                
 SELLQTY = SUM(F.SQTY),                
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),                
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                
 FLAG = 1,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
FROM                 
 ANGELFO.NSEFO.DBO.FOBILLVALAN F             
 INNER JOIN                    
 ANGELFO.NSEFO.DBO.CLIENT2 C2              
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)  
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,              
 F.SAUDA_DATE,              
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
               
UNION                
                
SELECT        
 EXCHANGE = 'F&O',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 TRADETYPE = '',                
 F.PARTY_CODE,                
 INST_TYPE = '',                
 SYMBOL = '** LEVIES **',                
 EXPIRYDATE = '',                
 OPTION_TYPE = '',                
 STRIKE_PRICE  = 0,                
 CL_RATE = 0,                
 BUYQTY = 0,                
 BUYRATE = 0,                
 SELLQTY = 0,                
 SELLRATE = 0,                
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                
 FLAG = 2,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                
 SCRIP_NAME = '** LEVIES **',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
FROM                 
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                
 INNER JOIN                    
 ANGELFO.NSEFO.DBO.CLIENT2 C2              
 INNER JOIN ANGELFO.NSEFO.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)  
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.PARTY_CODE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
          
-----------------------------------------------------------------------------          
--                            NOW DOING MCDX                              --          
-----------------------------------------------------------------------------          
UNION      
      
      
SELECT                 
 EXCHANGE = 'MCX',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 BUYQTY = SUM(F.PQTY),                
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),                
 SELLQTY = SUM(F.SQTY),                
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),                
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                
 FLAG = 1,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
FROM                 
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F             
 INNER JOIN     
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2              
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
               
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,              
 F.SAUDA_DATE,  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
              
                
UNION                
                
SELECT        
 EXCHANGE = 'MCX',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 TRADETYPE = '',                
 F.PARTY_CODE,                
 INST_TYPE = '',                
 SYMBOL = '** LEVIES **',                
 EXPIRYDATE = '',                
 OPTION_TYPE = '',                
 STRIKE_PRICE  = 0,                
 CL_RATE = 0,                
 BUYQTY = 0,                
 BUYRATE = 0,                
 SELLQTY = 0,                
 SELLRATE = 0,                
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                
 FLAG = 2,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                
 SCRIP_NAME = '** LEVIES **',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
                
FROM                 
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                
 INNER JOIN                    
 ANGELCOMMODITY.MCDX.DBO.CLIENT2 C2              
 INNER JOIN ANGELCOMMODITY.MCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.PARTY_CODE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
                
      
UNION      
          
-----------------------------------------------------------------------------          
--                            NOW DOING NCDX                              --          
-----------------------------------------------------------------------------          
      
      
SELECT                 
 EXCHANGE = 'NCDX',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 BUYQTY = SUM(F.PQTY),                
 BUYRATE = (CASE WHEN SUM(F.PQTY) <> 0 THEN SUM(F.PAMT) / SUM(F.PQTY) ELSE 0 END),                
 SELLQTY = SUM(F.SQTY),                
 SELLRATE = (CASE WHEN SUM(F.SQTY) <> 0 THEN SUM(F.SAMT)  / SUM(F.SQTY) ELSE 0 END),                
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                
 FLAG = 1,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.SAUDA_DATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
  
FROM                 
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F             
 INNER JOIN                    
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2              
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
               
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.TRADETYPE,                
 F.PARTY_CODE,                
 F.INST_TYPE,                
 F.SYMBOL,                
 F.EXPIRYDATE,                
 F.OPTION_TYPE,                
 F.STRIKE_PRICE,                
 F.CL_RATE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,              
 F.SAUDA_DATE,  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
              
                
UNION                
                
SELECT        
 EXCHANGE = 'NCDX',      
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 TRADETYPE = '',                
 F.PARTY_CODE,                
 INST_TYPE = '',                
 SYMBOL = '** LEVIES **',                
 EXPIRYDATE = '',                
 OPTION_TYPE = '',                
 STRIKE_PRICE  = 0,                
 CL_RATE = 0,                
 BUYQTY = 0,                
 BUYRATE = 0,                
 SELLQTY = 0,                
 SELLRATE = 0,                
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                
 FLAG = 2,                
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                
 SCRIP_NAME = '** LEVIES **',  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
                
FROM                 
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                
 INNER JOIN                    
 ANGELCOMMODITY.NCDX.DBO.CLIENT2 C2              
 INNER JOIN ANGELCOMMODITY.NCDX.DBO.CLIENT1 C1 ON (C1.CL_CODE = C2.CL_CODE)              
 ON (F.PARTY_CODE = C2.PARTY_CODE AND C2.PRINTF = 2)            
WHERE                 
 F.PARTY_CODE >= @FROMPARTYCODE                
 AND F.PARTY_CODE <= @TOPARTYCODE                
 AND F.SAUDA_DATE >= @FROMDATE                
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                
AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION            
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
            WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE            
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME            
            ELSE 'I DONT KNOW ' END)             
GROUP BY                 
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                
 F.PARTY_CODE,                
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),  
 C1.SHORT_NAME,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.MOBILE_PAGER,  
 C1.RES_PHONE1,  
 C1.RES_PHONE2,  
 C1.OFF_PHONE1  
                
ORDER BY                
 F.PARTY_CODE,              
 1,        
 SAUDA_DATE,                
 FLAG,                
 INST_TYPE,                
 SYMBOL,                
 EXPIRYDATE,                
 OPTION_TYPE,                
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW
-- --------------------------------------------------


CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW]
	(                          
	@STATUSID 	VARCHAR(25),                      
	@STATUSNAME 	VARCHAR(25),                      
	@FROMPARTYCODE 	VARCHAR(10),                              
	@TOPARTYCODE 	VARCHAR(10),                              
	@FROMDATE 	VARCHAR(11),                              
	@TODATE 	VARCHAR(11),
	@FROMCODE 	VARCHAR(15)='',
	@TOCODE		VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY 	VARCHAR(15)='BROKER',
	@PRINTFLAG	VARCHAR(2) ='',
	@ORD_BY		VARCHAR(15)=''
	)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                        
*/                          
                          
AS                          

IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END

CREATE TABLE #PRINTF
	(
	PARTY_CODE VARCHAR(15)
	)

IF @PRINTFLAG <> ''
BEGIN
	INSERT INTO #PRINTF
	SELECT 
		DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'') 
	FROM 
		ANAND1.PRADNYA.DBO.TBL_H_PRINTFLAG WITH (NOLOCK)
	WHERE 
		PRINT_FLAG = @PRINTFLAG
		AND PARTY_CODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
END
ELSE
BEGIN
	INSERT INTO #PRINTF
	SELECT 
		DISTINCT PARTY_CODE = ISNULL(PARENTCODE,'') 
	FROM 
		AngelBSECM.PRADNYA.DBO.TBL_ECNFO WITH (NOLOCK)
	WHERE 
		PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
END


SELECT
	DISTINCT
	PARTY_CODE,
	PARENTCODE
INTO 
	#PARTY
FROM
	AngelBSECM.PRADNYA.DBO.TBL_ECNFO WITH (NOLOCK)
WHERE
	ISNULL(PARENTCODE,'')
	IN (SELECT DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'') FROM  #PRINTF)
	AND PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
	AND (
	CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
	AND @STATUSNAME = (
	CASE 
		WHEN @STATUSID = 'AREA' THEN AREA                
		WHEN @STATUSID = 'REGION' THEN REGION                
		WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                
		WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                
		WHEN @STATUSID = 'TRADER' THEN TRADER                
		WHEN @STATUSID = 'FAMILY' THEN FAMILY                
		WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                
		WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
		ELSE 'I DONT KNOW ' 
	END)
            
-----------------------------------------------------------------------------                    
--                            NOW DOING NSEFO                              --                    
-----------------------------------------------------------------------------                    
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SELECT
	EXCHANGE,
	TRADEDATE,
	TRADETYPE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	CL_RATE,
	BUYQTY,
	BUYRATE,
	SELLQTY,
	SELLRATE,
	NETAMOUNT,
	FLAG,
	SAUDA_DATE,
	SCRIP_NAME,
	LONG_NAME = CONVERT(VARCHAR(100),''),
	BRANCH_CD = CONVERT(VARCHAR(15),''),
	SUB_BROKER = CONVERT(VARCHAR(15),''),
	L_ADDRESS1  = CONVERT(VARCHAR(100),''),
	L_ADDRESS2 = CONVERT(VARCHAR(100),''),
	L_ADDRESS3  = CONVERT(VARCHAR(100),''),
	L_CITY  = CONVERT(VARCHAR(50),''),
	L_STATE  = CONVERT(VARCHAR(50),''),
	L_ZIP  = CONVERT(VARCHAR(25),''),
	MOBILE_PAGER  = CONVERT(VARCHAR(25),''),
	RES_PHONE1  = CONVERT(VARCHAR(50),''),
	RES_PHONE2  = CONVERT(VARCHAR(50),''),
	OFF_PHONE1 = CONVERT(VARCHAR(50),''),
	REGION = CONVERT(VARCHAR(25),'')
INTO
	#SAUDASUMMARY
FROM
	(
	SELECT                           
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM
		ANGELFO.NSEFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                         
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSEFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING MCDX                              --                    
	-----------------------------------------------------------------------------                    

	UNION                

	                
	SELECT                           
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F  WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY         
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                        
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE= C1.PARENTCODE,
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                          
	                
	UNION                
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NCDX                              --                    
	-----------------------------------------------------------------------------                    
	                
	                
	SELECT                           
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	 
	(    
	f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE                    
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',            
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F   WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE                   
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------         
	--                            NOW DOING MCX-SX                             --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,      
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End as BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE           
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                    
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F  WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NSX                               --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE=C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSECURFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE          
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSECURFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)

	) SS
ORDER BY
	PARTY_CODE,
	1,
	SAUDA_DATE,
	FLAG,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE

	UPDATE 
		#SAUDASUMMARY 
	SET 
		LONG_NAME	= C1.LONG_NAME,
		BRANCH_CD	= C1.BRANCH_CD,
		SUB_BROKER	= C1.SUB_BROKER,
		L_ADDRESS1	= C1.L_ADDRESS1,
		L_ADDRESS2	= C1.L_ADDRESS2,
		L_ADDRESS3	= C1.L_ADDRESS3,
		L_CITY		= C1.L_CITY,
		L_STATE		= C1.L_STATE,
		L_ZIP		= C1.L_ZIP,
		MOBILE_PAGER= C1.MOBILE_PAGER,
		RES_PHONE1	= C1.RES_PHONE1,
		RES_PHONE2	= C1.RES_PHONE2,
		OFF_PHONE1	= C1.OFF_PHONE1,
		REGION		= C1.REGION
	FROM
		AngelBSECM.PRADNYA.DBO.TBL_ECNFO C1 (NOLOCK)
	WHERE
		#SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE

	SELECT * FROM #SAUDASUMMARY
	ORDER BY
 		(CASE 
			WHEN @ORD_BY = 'REGION' THEN REGION
			WHEN @ORD_BY = 'PIN CODE' THEN L_ZIP
			ELSE PARTY_CODE
		END),
		PARTY_CODE,
		1,
		SAUDA_DATE,
		FLAG,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		OPTION_TYPE,
		STRIKE_PRICE

DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_18102011
-- --------------------------------------------------


CREATE PROC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW
	(                          
	@STATUSID VARCHAR(25),                      
	@STATUSNAME VARCHAR(25),                      
	@FROMPARTYCODE VARCHAR(10),                              
	@TOPARTYCODE VARCHAR(10),                              
	@FROMDATE VARCHAR(11),                              
	@TODATE VARCHAR(11),
	@FROMCODE VARCHAR(15)='',
	@TOCODE	VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY VARCHAR(15)='BROKER'
	)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                        
*/                          
                          
AS                          

IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END
            
-----------------------------------------------------------------------------                    
--                            NOW DOING NSEFO                              --                    
-----------------------------------------------------------------------------                    
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SELECT
	EXCHANGE,
	TRADEDATE,
	TRADETYPE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	CL_RATE,
	BUYQTY,
	BUYRATE,
	SELLQTY,
	SELLRATE,
	NETAMOUNT,
	FLAG,
	SAUDA_DATE,
	SCRIP_NAME,
	LONG_NAME = CONVERT(VARCHAR(100),''),
	BRANCH_CD = CONVERT(VARCHAR(15),''),
	SUB_BROKER = CONVERT(VARCHAR(15),''),
	L_ADDRESS1  = CONVERT(VARCHAR(100),''),
	L_ADDRESS2 = CONVERT(VARCHAR(100),''),
	L_ADDRESS3  = CONVERT(VARCHAR(100),''),
	L_CITY  = CONVERT(VARCHAR(50),''),
	L_STATE  = CONVERT(VARCHAR(50),''),
	L_ZIP  = CONVERT(VARCHAR(25),''),
	MOBILE_PAGER  = CONVERT(VARCHAR(25),''),
	RES_PHONE1  = CONVERT(VARCHAR(50),''),
	RES_PHONE2  = CONVERT(VARCHAR(50),''),
	OFF_PHONE1 = CONVERT(VARCHAR(50),'')
INTO
	#SAUDASUMMARY
FROM
	(
	SELECT                           
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM
	 ANGELFO.NSEFO.DBO.FOBILLVALAN F                       
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                         
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM                           
	 ANGELFO.NSEFO.DBO.FOBILLVALAN F                          
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	  
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING MCDX                              --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM                           
	 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                       
	 INNER JOIN               
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	                         
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY         
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                        
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE= C1.PARENTCODE,
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	                          
	FROM                           
	 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                          
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	  
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                          
	                
	UNION                
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NCDX                              --                    
	-----------------------------------------------------------------------------                    
	                
	                
	SELECT                           
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	 
	(    
	f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	            
	FROM                           
	 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                       
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	                         
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',            
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	                          
	FROM                           
	 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                          
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)   
	  
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------         
	--                            NOW DOING MCX-SX                             --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,      
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End as BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM                           
	 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                       
	 INNER JOIN               
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	                         
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE           
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                    
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	                          
	FROM                           
	 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                          
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)
	  
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NSX                               --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE=C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM                           
	 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                       
	 INNER JOIN               
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)   
	                         
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE          
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = ''
	FROM                           
	 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                          
	 INNER JOIN                              
	 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
	 ON (F.PARTY_CODE = C1.PARTY_CODE)   
	  
	WHERE                           
	 C1.PARENTCODE >= @FROMPARTYCODE                          
	 AND C1.PARENTCODE <= @TOPARTYCODE                          
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
				WHEN @STATUSID = 'REGION' THEN C1.REGION                      
				WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
				WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
				WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
				WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
				WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
				ELSE 'I DONT KNOW ' END)                       
	 AND (CASE
			WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
			WHEN @RPT_BY = 'REGION'		THEN C1.REGION
			WHEN @RPT_BY = 'AREA'		THEN C1.AREA
			WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
			WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
			ELSE F.PARTY_CODE
		END)
		BETWEEN @FROMCODE AND @TOCODE

	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)

	) SS
ORDER BY
	PARTY_CODE,
	1,
	SAUDA_DATE,
	FLAG,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE

	UPDATE 
		#SAUDASUMMARY 
	SET 
		LONG_NAME	= C1.LONG_NAME,
		BRANCH_CD	= C1.BRANCH_CD,
		SUB_BROKER	= C1.SUB_BROKER,
		L_ADDRESS1	= C1.L_ADDRESS1,
		L_ADDRESS2	= C1.L_ADDRESS2,
		L_ADDRESS3	= C1.L_ADDRESS3,
		L_CITY		= C1.L_CITY,
		L_STATE		= C1.L_STATE,
		L_ZIP		= C1.L_ZIP,
		MOBILE_PAGER= C1.MOBILE_PAGER,
		RES_PHONE1	= C1.RES_PHONE1,
		RES_PHONE2	= C1.RES_PHONE2,
		OFF_PHONE1	= C1.OFF_PHONE1
	FROM
		ANAND.PRADNYA.DBO.TBL_ECNFO C1 (NOLOCK)
	WHERE
		#SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE

	SELECT * FROM #SAUDASUMMARY
	ORDER BY
		PARTY_CODE,
		1,
		SAUDA_DATE,
		FLAG,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		OPTION_TYPE,
		STRIKE_PRICE

DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_28022011
-- --------------------------------------------------
  
CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_28022011]  
/* Changing long_name to Long_name for last query by Samit Mhatre on 25012011*/  
(                            
 @STATUSID VARCHAR(25),                        
 @STATUSNAME VARCHAR(25),                        
 @FROMPARTYCODE VARCHAR(10),                                
 @TOPARTYCODE VARCHAR(10),                                
 @FROMDATE VARCHAR(11),                                
 @TODATE VARCHAR(11),  
 @FROMCODE VARCHAR(15)='',  
 @TOCODE VARCHAR(15)='zzzzzzzzzz',  
 @RPT_BY VARCHAR(15)='BROKER'  
 )                            
                            
/*                            
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'a1160', 'a1160', 'jul  1 2009', 'jul 31 2009'                                          
*/                            
                            
AS  
IF @TOCODE = ''  
BEGIN  
 SET @TOCODE = 'zzzzzzzzzz'  
END  
              
-----------------------------------------------------------------------------                      
--                            NOW DOING NSEFO                              --                      
-----------------------------------------------------------------------------                      
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 EXCHANGE = 'F&O',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,            
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
 FLAG = 1,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
FROM                             
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                         
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)              
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 F.SAUDA_DATE,                          
 C1.long_name,             
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                           
UNION                            
                            
SELECT                    
 EXCHANGE = 'F&O',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                   
 TRADETYPE = '',                            
 F.PARTY_CODE,                            
 INST_TYPE = '',                            
 SYMBOL = '** LEVIES **',                            
 EXPIRYDATE = '',                            
 OPTION_TYPE = '',                            
 STRIKE_PRICE  = 0,                            
 CL_RATE = 0,                            
 BUYQTY = 0,                            
 BUYRATE = 0,                            
 SELLQTY = 0,                            
 SELLRATE = 0,                            
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
 FLAG = 2,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
 SCRIP_NAME = '** LEVIES **',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
FROM                             
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                            
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
    
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)              
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.PARTY_CODE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                      
-----------------------------------------------------------------------------                      
--                            NOW DOING MCDX                              --                      
-----------------------------------------------------------------------------                      
UNION                  
                  
                  
SELECT                             
 EXCHANGE = 'MCX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
   
    
     
(f.pqty) Else 0 End End AS BUYRATE,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
      
f.sqty) Else 0 End End AS SELLRATE,            
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
 FLAG = 1,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,    
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
FROM                             
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                         
 INNER JOIN                 
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
                           
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
   ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 F.SAUDA_DATE,              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                          
                            
UNION                            
                            
SELECT                    
 EXCHANGE = 'MCX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 TRADETYPE = '',                            
 F.PARTY_CODE,                            
 INST_TYPE = '',                            
 SYMBOL = '** LEVIES **',                            
 EXPIRYDATE = '',                            
 OPTION_TYPE = '',                            
 STRIKE_PRICE  = 0,                            
 CL_RATE = 0,                            
 BUYQTY = 0,                            
 BUYRATE = 0,                            
 SELLQTY = 0,                            
 SELLRATE = 0,                            
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
 FLAG = 2,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
 SCRIP_NAME = '** LEVIES **',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
FROM                             
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                            
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
    
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.PARTY_CODE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
                  
UNION                  
                      
-----------------------------------------------------------------------------                      
--                            NOW DOING NCDX                              --                      
-----------------------------------------------------------------------------                      
                  
                  
SELECT                             
 EXCHANGE = 'NCDX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
   
   
(      
f.pqty) Else 0 End End AS BUYRATE,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
   
f.sqty) Else 0 End End AS SELLRATE,            
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
 FLAG = 1,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
              
FROM                             
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                         
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
                           
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 F.SAUDA_DATE,              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                          
                            
UNION                            
                            
SELECT                    
 EXCHANGE = 'NCDX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 TRADETYPE = '',                            
 F.PARTY_CODE,                            
 INST_TYPE = '',                            
 SYMBOL = '** LEVIES **',                            
 EXPIRYDATE = '',              
 OPTION_TYPE = '',                            
 STRIKE_PRICE  = 0,                            
 CL_RATE = 0,                            
 BUYQTY = 0,                            
 BUYRATE = 0,                            
 SELLQTY = 0,     
 SELLRATE = 0,                            
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
 FLAG = 2,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
 SCRIP_NAME = '** LEVIES **',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
FROM                             
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                            
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)     
    
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.PARTY_CODE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
          
-----------------------------------------------------------------------------           
--                            NOW DOING MCX-SX                             --                      
-----------------------------------------------------------------------------                      
UNION                  
                  
                  
SELECT                             
 EXCHANGE = 'MCXSX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,        
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum
   
    
     
(f.pqty) Else 0 End End as BUYRATE,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
      
f.sqty) Else 0 End End AS SELLRATE,            
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
 FLAG = 1,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
FROM                             
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                         
 INNER JOIN                 
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
                           
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 F.SAUDA_DATE,              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,     
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                          
                            
UNION                            
                       
SELECT                    
 EXCHANGE = 'MCXSX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 TRADETYPE = '',                            
 F.PARTY_CODE,                            
 INST_TYPE = '',                            
 SYMBOL = '** LEVIES **',                            
 EXPIRYDATE = '',                            
 OPTION_TYPE = '',                            
 STRIKE_PRICE  = 0,                            
 CL_RATE = 0,                            
 BUYQTY = 0,                            
 BUYRATE = 0,                            
 SELLQTY = 0,                      
 SELLRATE = 0,                            
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
 FLAG = 2,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
 SCRIP_NAME = '** LEVIES **',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
FROM                             
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                            
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)  
    
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.PARTY_CODE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1           
          
-----------------------------------------------------------------------------                      
--                            NOW DOING NSX                               --                      
-----------------------------------------------------------------------------                      
UNION                  
                  
                  
SELECT                             
 EXCHANGE = 'NSX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,            
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                            
 FLAG = 1,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                            
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,           
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
FROM                             
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                         
 INNER JOIN                 
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)     
                           
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                        
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.TRADETYPE,                            
 F.PARTY_CODE,                            
 F.INST_TYPE,                            
 F.SYMBOL,                            
 F.EXPIRYDATE,                            
 F.OPTION_TYPE,                            
 F.STRIKE_PRICE,                            
 F.CL_RATE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,          
 F.SAUDA_DATE,              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                          
                            
UNION                            
                            
SELECT                    
 EXCHANGE = 'NSX',                  
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 TRADETYPE = '',                            
 F.PARTY_CODE,                            
 INST_TYPE = '',                            
 SYMBOL = '** LEVIES **',                            
 EXPIRYDATE = '',                            
 OPTION_TYPE = '',                            
 STRIKE_PRICE  = 0,                            
 CL_RATE = 0,                            
 BUYQTY = 0,                            
 BUYRATE = 0,                            
 SELLQTY = 0,                            
 SELLRATE = 0,                            
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                            
 FLAG = 2,                            
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                            
 SCRIP_NAME = '** LEVIES **',              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1              
                            
FROM                             
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                            
 INNER JOIN                                
 ANAND.Pradnya.dbo.TBL_ECNFo C1                         
 ON (F.PARTY_CODE = C1.PARTY_CODE)     
    
WHERE                             
 F.PARTY_CODE >= @FROMPARTYCODE                            
 AND F.PARTY_CODE <= @TOPARTYCODE                            
 AND F.SAUDA_DATE >= @FROMDATE                            
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                            
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA              
            WHEN @STATUSID = 'REGION' THEN C1.REGION                        
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                        
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                        
            ELSE 'I DONT KNOW ' END)                         
 AND (CASE  
  WHEN @RPT_BY = 'FAMILY'  THEN C1.FAMILY  
  WHEN @RPT_BY = 'REGION'  THEN C1.REGION  
  WHEN @RPT_BY = 'AREA'  THEN C1.AREA  
  WHEN @RPT_BY = 'BRANCH'  THEN C1.BRANCH_CD  
  WHEN @RPT_BY = 'SUB_BROKER' THEN C1.SUB_BROKER  
  WHEN @RPT_BY = 'TRADER'  THEN C1.TRADER  
  ELSE F.PARTY_CODE  
 END)  
 BETWEEN @FROMCODE AND @TOCODE  
  
GROUP BY                             
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                            
 F.PARTY_CODE,                            
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),              
 C1.long_name,              
 C1.BRANCH_CD,              
 C1.SUB_BROKER,              
 C1.L_ADDRESS1,              
 C1.L_ADDRESS2,              
 C1.L_ADDRESS3,              
 C1.L_CITY,              
 C1.L_STATE,              
 C1.L_ZIP,              
 C1.MOBILE_PAGER,              
 C1.RES_PHONE1,              
 C1.RES_PHONE2,              
 C1.OFF_PHONE1           
          
ORDER BY                            
 F.PARTY_CODE,                          
 1,                    
 SAUDA_DATE,                            
 FLAG,                            
 INST_TYPE,                            
 SYMBOL,                            
 EXPIRYDATE,                            
 OPTION_TYPE,                            
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_backup01Oct2017
-- --------------------------------------------------



CREATE PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_backup01Oct2017]
	(                          
	@STATUSID 	VARCHAR(25),                      
	@STATUSNAME 	VARCHAR(25),                      
	@FROMPARTYCODE 	VARCHAR(10),                              
	@TOPARTYCODE 	VARCHAR(10),                              
	@FROMDATE 	VARCHAR(11),                              
	@TODATE 	VARCHAR(11),
	@FROMCODE 	VARCHAR(15)='',
	@TOCODE		VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY 	VARCHAR(15)='BROKER',
	@PRINTFLAG	VARCHAR(2) ='',
	@ORD_BY		VARCHAR(15)=''
	)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW 'BROKER','BROKER', 'a0001', 'a1060', 'Feb  1 2011', 'Feb 28 2011'                                        
*/                          
                          
AS                          

IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END

CREATE TABLE #PRINTF
	(
	PARTY_CODE VARCHAR(15)
	)

IF @PRINTFLAG <> ''
BEGIN
	INSERT INTO #PRINTF
	SELECT 
		DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'') 
	FROM 
		ANAND1.PRADNYA.DBO.TBL_H_PRINTFLAG WITH (NOLOCK)
	WHERE 
		PRINT_FLAG = @PRINTFLAG
		AND PARTY_CODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
END
ELSE
BEGIN
	INSERT INTO #PRINTF
	SELECT 
		DISTINCT PARTY_CODE = ISNULL(PARENTCODE,'') 
	FROM 
		ANAND.PRADNYA.DBO.TBL_ECNFO WITH (NOLOCK)
	WHERE 
		PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
END


SELECT
	DISTINCT
	PARTY_CODE,
	PARENTCODE
INTO 
	#PARTY
FROM
	ANAND.PRADNYA.DBO.TBL_ECNFO WITH (NOLOCK)
WHERE
	ISNULL(PARENTCODE,'')
	IN (SELECT DISTINCT PARTY_CODE = ISNULL(PARTY_CODE,'') FROM  #PRINTF)
	AND PARENTCODE BETWEEN @FROMPARTYCODE AND @TOPARTYCODE
	AND (
	CASE
		WHEN @RPT_BY = 'FAMILY'		THEN FAMILY
		WHEN @RPT_BY = 'REGION'		THEN REGION
		WHEN @RPT_BY = 'AREA'		THEN AREA
		WHEN @RPT_BY = 'BRANCH'		THEN BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN TRADER
		ELSE PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
	AND @STATUSNAME = (
	CASE 
		WHEN @STATUSID = 'AREA' THEN AREA                
		WHEN @STATUSID = 'REGION' THEN REGION                
		WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD                
		WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER                
		WHEN @STATUSID = 'TRADER' THEN TRADER                
		WHEN @STATUSID = 'FAMILY' THEN FAMILY                
		WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE                
		WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                
		ELSE 'I DONT KNOW ' 
	END)
            
-----------------------------------------------------------------------------                    
--                            NOW DOING NSEFO                              --                    
-----------------------------------------------------------------------------                    
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SELECT
	EXCHANGE,
	TRADEDATE,
	TRADETYPE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	CL_RATE,
	BUYQTY,
	BUYRATE,
	SELLQTY,
	SELLRATE,
	NETAMOUNT,
	FLAG,
	SAUDA_DATE,
	SCRIP_NAME,
	LONG_NAME = CONVERT(VARCHAR(100),''),
	BRANCH_CD = CONVERT(VARCHAR(15),''),
	SUB_BROKER = CONVERT(VARCHAR(15),''),
	L_ADDRESS1  = CONVERT(VARCHAR(100),''),
	L_ADDRESS2 = CONVERT(VARCHAR(100),''),
	L_ADDRESS3  = CONVERT(VARCHAR(100),''),
	L_CITY  = CONVERT(VARCHAR(50),''),
	L_STATE  = CONVERT(VARCHAR(50),''),
	L_ZIP  = CONVERT(VARCHAR(25),''),
	MOBILE_PAGER  = CONVERT(VARCHAR(25),''),
	RES_PHONE1  = CONVERT(VARCHAR(50),''),
	RES_PHONE2  = CONVERT(VARCHAR(50),''),
	OFF_PHONE1 = CONVERT(VARCHAR(50),''),
	REGION = CONVERT(VARCHAR(25),'')
INTO
	#SAUDASUMMARY
FROM
	(
	SELECT                           
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM
		ANGELFO.NSEFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                         
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'F&O',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSEFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING MCDX                              --                    
	-----------------------------------------------------------------------------                    

	UNION                

	                
	SELECT                           
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F  WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY         
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                        
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE= C1.PARENTCODE,
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	                          
	                
	UNION                
	                    
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NCDX                              --                    
	-----------------------------------------------------------------------------                    
	                
	                
	SELECT                           
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	 
	(    
	f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE                    
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),
	 F.SAUDA_DATE
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NCDX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',            
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F   WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE                   
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------         
	--                            NOW DOING MCX-SX                             --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,      
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
	  
	   
	(f.pqty) Else 0 End End as BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
	  
	    
	f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE           
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'MCXSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                    
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F  WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)
	        
	-----------------------------------------------------------------------------                    
	--                            NOW DOING NSX                               --                    
	-----------------------------------------------------------------------------                    
	UNION                
	                
	                
	SELECT                           
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 PARTY_CODE=C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
	 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
	 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
	 FLAG = 1,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
	 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSECURFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 F.TRADETYPE,                          
	 C1.PARENTCODE,                          
	 F.INST_TYPE,                          
	 F.SYMBOL,                          
	 F.EXPIRYDATE,                          
	 F.OPTION_TYPE,                          
	 F.STRIKE_PRICE,                          
	 F.CL_RATE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
	 F.SAUDA_DATE          
	                          
	UNION                          
	                          
	SELECT                  
	 EXCHANGE = 'NSX',                
	 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 TRADETYPE = '',                          
	 PARTY_CODE = C1.PARENTCODE,                          
	 INST_TYPE = '',                          
	 SYMBOL = '** LEVIES **',                          
	 EXPIRYDATE = '',                          
	 OPTION_TYPE = '',                          
	 STRIKE_PRICE  = 0,                          
	 CL_RATE = 0,                          
	 BUYQTY = 0,                          
	 BUYRATE = 0,                          
	 SELLQTY = 0,                          
	 SELLRATE = 0,                          
	 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
	 FLAG = 2,                          
	 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
	 SCRIP_NAME = '** LEVIES **',            
	 LONG_NAME = '',
	 BRANCH_CD = '',
	 SUB_BROKER = '',
	 L_ADDRESS1 = '',
	 L_ADDRESS2 = '',
	 L_ADDRESS3 = '',
	 L_CITY = '',
	 L_STATE = '',
	 L_ZIP = '',
	 MOBILE_PAGER = '',
	 RES_PHONE1 = '',
	 RES_PHONE2 = '',
	 OFF_PHONE1 = '',
	 REGION = ''
	FROM                           
		ANGELFO.NSECURFO.DBO.FOBILLVALAN F WITH (NOLOCK),	
		#PARTY C1 WITH (NOLOCK)
	WHERE 
	 F.PARTY_CODE = C1.PARTY_CODE
	 AND F.SAUDA_DATE >= @FROMDATE                          
	 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
	GROUP BY                           
	 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
	 C1.PARENTCODE,                          
	 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109)

	) SS
ORDER BY
	PARTY_CODE,
	1,
	SAUDA_DATE,
	FLAG,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE

	UPDATE 
		#SAUDASUMMARY 
	SET 
		LONG_NAME	= C1.LONG_NAME,
		BRANCH_CD	= C1.BRANCH_CD,
		SUB_BROKER	= C1.SUB_BROKER,
		L_ADDRESS1	= C1.L_ADDRESS1,
		L_ADDRESS2	= C1.L_ADDRESS2,
		L_ADDRESS3	= C1.L_ADDRESS3,
		L_CITY		= C1.L_CITY,
		L_STATE		= C1.L_STATE,
		L_ZIP		= C1.L_ZIP,
		MOBILE_PAGER= C1.MOBILE_PAGER,
		RES_PHONE1	= C1.RES_PHONE1,
		RES_PHONE2	= C1.RES_PHONE2,
		OFF_PHONE1	= C1.OFF_PHONE1,
		REGION		= C1.REGION
	FROM
		ANAND.PRADNYA.DBO.TBL_ECNFO C1 (NOLOCK)
	WHERE
		#SAUDASUMMARY.PARTY_CODE = C1.PARTY_CODE

	SELECT * FROM #SAUDASUMMARY
	ORDER BY
 		(CASE 
			WHEN @ORD_BY = 'REGION' THEN REGION
			WHEN @ORD_BY = 'PIN CODE' THEN L_ZIP
			ELSE PARTY_CODE
		END),
		PARTY_CODE,
		1,
		SAUDA_DATE,
		FLAG,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		OPTION_TYPE,
		STRIKE_PRICE

DROP TABLE #SAUDASUMMARY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_org_27012011
-- --------------------------------------------------

create PROC [dbo].[CLASSPROC_SAUDA_SUMMARY_FOPRINT_NEW_org_27012011]
/* Changing Short_name to Long_name	for last query by Samit Mhatre on 25012011*/
(                          
	@STATUSID VARCHAR(25),                      
	@STATUSNAME VARCHAR(25),                      
	@FROMPARTYCODE VARCHAR(10),                              
	@TOPARTYCODE VARCHAR(10),                              
	@FROMDATE VARCHAR(11),                              
	@TODATE VARCHAR(11),
	@FROMCODE VARCHAR(15)='',
	@TOCODE	VARCHAR(15)='zzzzzzzzzz',
	@RPT_BY VARCHAR(15)='BROKER'
	)                          
                          
/*                          
EXEC CLASSPROC_SAUDA_SUMMARY_FOPRINT 'BROKER','BROKER', 'a1160', 'a1160', 'jul  1 2009', 'jul 31 2009'                                        
*/                          
                          
AS
IF @TOCODE = ''
BEGIN
	SET @TOCODE = 'zzzzzzzzzz'
END
            
-----------------------------------------------------------------------------                    
--                            NOW DOING NSEFO                              --                    
-----------------------------------------------------------------------------                    
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SELECT                           
 EXCHANGE = 'F&O',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                       
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,                        
 C1.SHORT_NAME,           
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                         
UNION                          
                          
SELECT                  
 EXCHANGE = 'F&O',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                 
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSEFO.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND 1 = (CASE WHEN F.TRADETYPE='BF' AND LEFT(F.INST_TYPE,3) = 'OPT' THEN 0 ELSE 1 END)            
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                    
-----------------------------------------------------------------------------                    
--                            NOW DOING MCDX                              --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'MCX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
  
   
(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                       
 INNER JOIN               
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
			ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY         
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'MCX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.MCDX.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
                
UNION                
                    
-----------------------------------------------------------------------------                    
--                            NOW DOING NCDX                              --                    
-----------------------------------------------------------------------------                    
                
                
SELECT                           
 EXCHANGE = 'NCDX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
 
(    
f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
            
FROM                           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                       
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'NCDX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',            
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.NCDX.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
        
-----------------------------------------------------------------------------         
--                            NOW DOING MCX-SX                             --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'MCXSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 BUYQTY = Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End,      
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt*f.Denominator/f.Numerator)/Sum 
  
   
(f.pqty) Else 0 End End as BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt*f.Denominator/f.Numerator)/Sum(
  
    
f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                       
 INNER JOIN               
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'MCXSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                    
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELCOMMODITY.MCDXCDS.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1         
        
-----------------------------------------------------------------------------                    
--                            NOW DOING NSX                               --                    
-----------------------------------------------------------------------------                    
UNION                
                
                
SELECT                           
 EXCHANGE = 'NSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS BUYQTY,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End Else 0 End Else Case When Sum(f.pqty) > 0 Then Sum(f.pamt)/Sum(f.pqty) Else 0 End End AS BUYRATE,          
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS SELLQTY,                            
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End Else 0 End Else Case When Sum(f.sqty) > 0 Then Sum(f.samt)/Sum(f.sqty) Else 0 End End AS SELLRATE,          
 NETAMOUNT = SUM(F.SBILLAMT) - SUM(F.PBILLAMT),                          
 FLAG = 1,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),                          
 SCRIP_NAME = F.INST_TYPE + ' ' + F.SYMBOL + ' ' + CONVERT(VARCHAR,F.EXPIRYDATE,103) + ' ' + CAST(F.STRIKE_PRICE AS VARCHAR)  + ' ' +  F.OPTION_TYPE  + ' [' + F.TRADETYPE + ']',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,         
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
FROM                           
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                       
 INNER JOIN               
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
                         
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA                      
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE
GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.TRADETYPE,                          
 F.PARTY_CODE,                          
 F.INST_TYPE,                          
 F.SYMBOL,                          
 F.EXPIRYDATE,                          
 F.OPTION_TYPE,                          
 F.STRIKE_PRICE,                          
 F.CL_RATE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                        
 F.SAUDA_DATE,            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                        
                          
UNION                          
                          
SELECT                  
 EXCHANGE = 'NSX',                
 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 TRADETYPE = '',                          
 F.PARTY_CODE,                          
 INST_TYPE = '',                          
 SYMBOL = '** LEVIES **',                          
 EXPIRYDATE = '',                          
 OPTION_TYPE = '',                          
 STRIKE_PRICE  = 0,                          
 CL_RATE = 0,                          
 BUYQTY = 0,                          
 BUYRATE = 0,                          
 SELLQTY = 0,                          
 SELLRATE = 0,                          
 NETAMOUNT = (SUM(F.CL_CHRG) + SUM(F.SERVICE_TAX) + SUM(F.SEBI_TAX) + SUM(F.TURN_TAX) + SUM(F.BROKER_NOTE) + SUM(F.INS_CHRG) + SUM(F.OTHER_CHRG)) * -1,                          
 FLAG = 2,                          
 SAUDA_DATE = CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109) ,                          
 SCRIP_NAME = '** LEVIES **',            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1            
                          
FROM                           
 ANGELFO.NSECURFO.DBO.FOBILLVALAN F                          
 INNER JOIN                              
 ANAND.Pradnya.dbo.TBL_ECNFo C1                       
 ON (F.PARTY_CODE = C1.PARTY_CODE)   
  
WHERE                           
 F.PARTY_CODE >= @FROMPARTYCODE                          
 AND F.PARTY_CODE <= @TOPARTYCODE                          
 AND F.SAUDA_DATE >= @FROMDATE                          
 AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'                          
 AND @STATUSNAME = (CASE WHEN @STATUSID = 'AREA' THEN C1.AREA            
            WHEN @STATUSID = 'REGION' THEN C1.REGION                      
            WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
            WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
            WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
            WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
            WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE                      
            WHEN @STATUSID = 'BROKER' THEN @STATUSNAME                      
            ELSE 'I DONT KNOW ' END)                       
 AND (CASE
		WHEN @RPT_BY = 'FAMILY'		THEN C1.FAMILY
		WHEN @RPT_BY = 'REGION'		THEN C1.REGION
		WHEN @RPT_BY = 'AREA'		THEN C1.AREA
		WHEN @RPT_BY = 'BRANCH'		THEN C1.BRANCH_CD
		WHEN @RPT_BY = 'SUB_BROKER'	THEN C1.SUB_BROKER
		WHEN @RPT_BY = 'TRADER'		THEN C1.TRADER
		ELSE F.PARTY_CODE
	END)
	BETWEEN @FROMCODE AND @TOCODE

GROUP BY                           
 CONVERT(VARCHAR,F.SAUDA_DATE,103),                          
 F.PARTY_CODE,                          
 CONVERT(DATETIME,LEFT(F.SAUDA_DATE,11),109),            
 C1.SHORT_NAME,            
 C1.BRANCH_CD,            
 C1.SUB_BROKER,            
 C1.L_ADDRESS1,            
 C1.L_ADDRESS2,            
 C1.L_ADDRESS3,            
 C1.L_CITY,            
 C1.L_STATE,            
 C1.L_ZIP,            
 C1.MOBILE_PAGER,            
 C1.RES_PHONE1,            
 C1.RES_PHONE2,            
 C1.OFF_PHONE1         
        
ORDER BY                          
 F.PARTY_CODE,                        
 1,                  
 SAUDA_DATE,                          
 FLAG,                          
 INST_TYPE,                          
 SYMBOL,                          
 EXPIRYDATE,                          
 OPTION_TYPE,                          
 STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CMPADDR
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_CMPADDR]
(
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(20)
)
AS
/*

CLS_CMPADDR 'BSE','CAPITAL'

SELECT * FROM MSAJAG.DBO.OWNER
SELECT * FROM NSEMFSS.DBO.OWNER
SELECT * FROM BBO_FA.DBO.OWNER
EXEC USP_CMPADDR 'NSEMFSS'

*/
/*BEGIN
	DECLARE @SQL VARCHAR(MAX), @SEGMENT VARCHAR(10)
	SELECT @SEGMENT = SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = @SHAREDB AND PRIMARYSERVER = 1
	SET @SQL="SELECT COMPANY, ADDR1, ADDR2, ADDR3" + CASE WHEN @SEGMENT = 'FUTURES' THEN '=''''' ELSE '' END + ", CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX,EMAIL,MEMBERCODE,BROKERSEBIREGNO,PANNO,COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE FROM "
	SET @SQL=@SQL+@SHAREDB
	SET @SQL=@SQL+".." + CASE WHEN @SEGMENT = 'FUTURES' THEN 'FOOWNER' ELSE 'OWNER' END
	PRINT @SQL
	EXEC(@SQL)
END*/
SELECT * FROM CLS_OWNER_VW WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMM_REPORTING_DATA
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[COMM_REPORTING_DATA] 
(
@TRD_SDATE DATETIME,
@RPT_DATE DATETIME
)
AS
BEGIN


--DECLARE @TRD_SDATE DATETIME = '2020-07-01',
-- @RPT_DATE DATETIME = '2021-06-30'

-- SELECT * FROM NSE_DATA_FINAL WHERE CLTCODE ='B33515'
 
  SELECT DISTINCT CLTCODE INTO #NCDXTRAA FROM (
 SELECT * FROM ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WHERE VDT >= @TRD_SDATE AND VDT <= @RPT_DATE AND VTYP = 15 
 )A ,
 ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS B WITH (NOLOCK) WHERE CLTCODE = CL_CODE 
 AND EXCHANGE IN ('NCX')  AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('T')
 
  Create index #IX_CLTCODE on #NCDXTRAA (CLTCODE)
  
 SELECT DISTINCT CL_CODE INTO #NEWCLNCDX  FROM ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS WITH (NOLOCK) WHERE ACTIVE_DATE >= @TRD_SDATE
  AND ACTIVE_DATE <= @RPT_DATE + '23:59' 
  AND EXCHANGE IN ('NCX')  -- AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T')
  
    Create index #IX_CLTCODE on #NEWCLNCDX (CLTCODE)
 
 
  ---- *** ===== CLOSED  ====****

  INSERT INTO #NEWCLNCDX
   SELECT DISTINCT CL_CODE FROM ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS  WITH (NOLOCK) WHERE EXCHANGE IN ('NCX') AND ISNULL(DEACTIVE_VALUE,'') = 'C'
	AND INACTIVE_FROM > @RPT_DATE AND ACTIVE_DATE <= @RPT_DATE + '23:59'  AND CL_CODE NOT IN (SELECT * FROM #NEWCLNCDX )

DELETE FROM #NEWCLNCDX WHERE CL_CODE NOT IN (SELECT CL_CODE FROM #NCDXTRAA)

	
  -- DROP TABLE #NCX_B

  
 SELECT  LONG_NAME,UPPER(RTRIM(LTRIM(D.CL_CODE))) AS CLTCODE,PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'NNNNN1111N' ELSE PAN_GIR_NO END )
  INTO #NCXACT1 FROM AngelBSECM.MSAJAG.DBO.CLIENT_BROK_DETAILS S WITH (NOLOCK) ,ANAND1.MSAJAG.DBO.CLIENT_DETAILS D WITH (NOLOCK)
   WHERE EXCHANGE = 'NCX' -- AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T') 
		AND ACTIVE_DATE <= @RPT_DATE + ' 23:59'
			AND S.CL_CODE = D.CL_CODE

  CREATE INDEX #C ON #NCXACT1 (CLTCODE)


  SELECT LONG_NAME,UPPER(RTRIM(LTRIM(D.CLTCODE))) AS CLTCODE,PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'NNNNN1111N' ELSE PAN_GIR_NO END ),
 -- MOBILE_PAGER = (CASE WHEN LEN(ISNULL(MOBILE_PAGER,'')) <> 10  THEN  '6666666666' ELSE MOBILE_PAGER END ),
 -- EMAIL =(CASE WHEN ISNULL(EMAIL,'') ='' THEN 'NOTPROVIDED@NOTPROVIDED.COM'  ELSE EMAIL END  ),
  NCX AS NCX_BALANCE, NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,
  ---REPLACE(CONVERT(NVARCHAR,SEBI_PAYOUT, 106), ' ', '-')  SEBI_PAYOUT  ,BORROWING    
CONVERT(VARCHAR(11),SEBI_PAYOUT,105)SEBI_PAYOUT  INTO #NCXD 
 FROM #NCXACT1 D WITH (NOLOCK), NSE_DATA_FINAL F  (NOLOCK) 
			WHERE F.CLTCODE = D.CLTCODE  
-- FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS D WITH (NOLOCK),  NSE_DATA_FINAL F   
--WHERE F.CLTCODE = D.CL_CODE AND
--  F.CLTCODE IN (SELECT CL_CODE FROM AngelBSECM.MSAJAG.DBO.CLIENT_BROK_DETAILS WITH (NOLOCK) WHERE EXCHANGE = 'NCX' --AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T') 
--  AND ACTIVE_DATE <= @RPT_DATE + '23:59')

 --- DROP TABLE #NCXFIN
 
     Create index #IX_CLTCODE on #NCXD (CLTCODE)
 

  SELECT * INTO #NCXFIN FROM (
  SELECT * FROM #NCXD WHERE NCX_BALANCE <> 0 OR NET_AMT <> 0 OR TOTAL_ISIN <> 0 OR PLEDGE_QTY <> 0 
  UNION ALL
  SELECT * FROM #NCXD WHERE NCX_BALANCE = 0 AND NET_AMT = 0 AND TOTAL_ISIN = 0 AND PLEDGE_QTY = 0 
  AND CLTCODE IN ( SELECT * FROM #NCDXTRAA
 UNION
 SELECT * FROM #NEWCLNCDX ) )A
 ORDER BY CLTCODE
 
 --- DROP TABLE #NCF
 
  Create index #IX_CLTCODE on #NCXFIN (CLTCODE)

   SELECT UPPER(LONG_NAME) AS LONG_NAME,UPPER(RTRIM(LTRIM(CLTCODE))) AS CLTCODE,UPPER(PAN_GIR_NO) AS PAN_GIR_NO,--MOBILE_PAGER,LOWER(EMAIL) AS EMAIL,
   ROUND(NCX_BALANCE,2) AS NCX_BALANCE,ROUND(NET_AMT,2) AS NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,ROUND(BARROWING,2) AS BARROWING,
   REPLACE(SEBI_PAYOUT,'-','/') AS SEBI_PAYOUT,ASD INTO #NCF
    FROM  #NCXFIN T,
  (SELECT CL_CODE,MIN(ACTIVE_DATE) ASD FROM AngelBSECM.MSAJAG.DBO.CLIENT_BROK_DETAILS WITH (NOLOCK)
   WHERE EXCHANGE = 'NCX' -- AND ISNULL(DEACTIVE_VALUE,'') NOT IN ('C','T') 
   AND ACTIVE_DATE <= @RPT_DATE + '23:59' 
   GROUP BY CL_CODE ) R
 WHERE T.CLTCODE = R.CL_CODE 
 --AND PAN_GIR_NO NOT LIKE '%.%' AND PAN_GIR_NO NOT LIKE '%,%' AND PAN_GIR_NO NOT LIKE '%-%' 
 --AND PAN_GIR_NO NOT LIKE '%/%' AND LEN(PAN_GIR_NO) = 10 AND LONG_NAME NOT LIKE '%VANDHA %'

 --UPDATE #NCF SET MOBILE_PAGER = '6666666666' WHERE MOBILE_PAGER LIKE '0%'
  
 -- UPDATE #NCF SET MOBILE_PAGER = '6666666666' WHERE MOBILE_PAGER = ''
 
 
  Create index #IX_CLTCODE on #NCF (CLTCODE)

  UPDATE #NCF SET PAN_GIR_NO = 'NNNNN1111N' WHERE PAN_GIR_NO IN ('PAN_EXEMPT','PAN EXEMPT')

 DELETE FROM #NCF WHERE LONG_NAME LIKE '%VANDHA %'

 --DECLARE @NEWCL DATETIME = '2021-06-30'
 --UPDATE #NCF SET SEBI_PAYOUT = 'NA' WHERE ASD >= @NEWCL - 84
 
 TRUNCATE TABLE NCX_C_WFIN 

 INSERT INTO NCX_C_WFIN  --- 1206224
	 SELECT * FROM #NCF --- WHERE TOTA_QTY_SEC <> 0 
		ORDER BY CLTCODE
 

 SELECT H.PARTY_CODE,H.ISIN,H.SCRIP,H.QTY,ISNULL(P.QTY,0) AS PLEDGE_QTY,ISNULL(BORROWING,0) AS BORROWING,ISNULL(PLEDGE_VALUE,0) AS PLEDGE_VALUE 
 INTO #NCHOLDING 
 FROM TBL_HOLDING H LEFT OUTER JOIN 
 TBL_PLDRPT P ON RTRIM(LTRIM(H.PARTY_CODE)) = RTRIM(LTRIM(P.PARTY_CODE))  AND RTRIM(LTRIM(H.ISIN)) = RTRIM(LTRIM(P.ISIN)) 
	WHERE H.PARTY_CODE IN (	SELECT CLTCODE FROM #NCF)  
	
	  Create index IX_PARTY on #NCHOLDING (PARTY_CODE)

 --- DROP TABLE NCX_S_WFIN

 TRUNCATE TABLE NCX_S_WFIN 

 INSERT INTO NCX_S_WFIN -- 137854
	SELECT UPPER(LONG_NAME) AS LONG_NAME,F.PARTY_CODE,PAN_GIR_NO,F.ISIN,F.SCRIP,F.QTY,F.PLEDGE_QTY,F.BORROWING
	 FROM #NCHOLDING F, NCX_C_WFIN (NOLOCK) WHERE CLTCODE = F.PARTY_CODE 
			ORDER BY PARTY_CODE	

---- SELECT DISTINCT PARTY_CODE FROM NCX_S_WFIN WHERE PAN_GIR_NO = ''

UPDATE S SET PAN_GIR_NO = C.PAN_GIR_NO FROM NCX_S_WFIN S , NCX_C_WFIN C WHERE CLTCODE = PARTY_CODE AND S.PAN_GIR_NO = ''

 ----------------------- BELOW QUERY NO RECORDS ------------------

 --SELECT * FROM NCX_S_WFIN WHERE QTY < PLEDGE_QTY 
	--ORDER BY PARTY_CODE,ISIN

---
	
--SELECT * FROM 	
--(SELECT CLTCODE,SUM(TOTA_QTY_SEC) AS HLD,SUM(PLEDGE_QTY) AS PLD,SUM(BARROWING) AS BARR FROM NCX_C_WFIN GROUP BY CLTCODE)A
--,
--(SELECT PARTY_CODE,SUM(QTY) AS HLDG,SUM(PLEDGE_QTY) AS PLDS, SUM(BORROWING) AS BORR FROM NCX_S_WFIN GROUP BY PARTY_CODE)B
--WHERE CLTCODE = PARTY_CODE AND PLD <> PLDS

---------------- CHEKCING END --------------------
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ECN_master
-- --------------------------------------------------
CREATE Proc [dbo].[ECN_master] as               
              
--------    AngelBSECM.pradnya
--------------  Created by MKT for process of sauda_summary dump            
              
Drop table TBL_ECNCASH              
              
Drop table TBL_ECNFO              
            
            
-----  CASH segment client list table            
              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode              
into TBL_ECNCASH     
from bsedb_ab..Client1 x, bsedb_ab..Client2 y /*where exists              
(              
Select Cl_code from bsedb_ab..Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
Where x.Cl_code = y.Cl_code and PrintF = 2  
  
union              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode    
from anand1.msajag.dbo.Client1 x, anand1.msajag.dbo.Client2 y /*where exists              
(              
Select Cl_code from anand1.msajag.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/              
Where x.Cl_code = y.Cl_code and PrintF = 2  
              
              
------ F&O segment client list table               
             
              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode             
 into TBL_ECNFO from angelfo.nsefo.dbo.Client1 x,angelfo.nsefo.dbo.Client2 y /* where  exists              
(              
Select  Cl_code from angelfo.nsefo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
where x.Cl_code = y.Cl_code and PrintF = 2               
union              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode             
 from angelfo.nsecurfo.dbo.Client1 x, angelfo.nsecurfo.dbo.Client2 y /*where exists              
(              
Select  Cl_code from angelfo.nsecurfo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
where x.Cl_code = y.Cl_code and PrintF = 2                
union              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode  
from angelcommodity.mcdx.dbo.Client1 x, angelcommodity.mcdx.dbo.Client2 y /*where exists              
(              
Select  Cl_code from angelcommodity.mcdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
where x.Cl_code = y.Cl_code and PrintF = 2  
union              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode  
 from angelcommodity.mcdxcds.dbo.Client1 x, angelcommodity.mcdxcds.dbo.Client2 y /*where exists              
(              
Select  Cl_code from angelcommodity.mcdxcds.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
where x.Cl_code = y.Cl_code and PrintF = 2  
union              
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode  
from angelcommodity.ncdx.dbo.Client1 x, angelcommodity.ncdx.dbo.Client2 y /*where exists              
(              
Select  Cl_code from angelcommodity.ncdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)*/  
where x.Cl_code = y.Cl_code and PrintF = 2  
          
delete from TBL_ECNCASH Where Party_code ='M888' -- deleting this client to skip extra pages print.          
delete from TBL_ECNFO Where Party_code ='M888' -- deleting this client to skip extra pages print.       
  
--- by Dharmesh due to printflag mismatch between ParentCode and Child Code : 03/03/2011  
  
Select ParentCode,count(Party_code) as CL into #t  from tbl_ECNcash  
Group by Parentcode having count(Party_code) > 1  
  
---  
  
Select * into #x from TBL_ECNCASH where Party_code like '98%' and Parentcode not in  
(Select ParentCode from #t)  
  
---  
  
Update #x set Party_code = Parentcode   
  
---  
  
insert into TBL_ECNCASH  
Select * from #x  
  
drop table #x  
drop table #t  
  
----  
  
Update TBL_ECNCASH set Parentcode = Party_code   
where Parentcode <> Party_code and Party_code not like '98%'  
  
----  
  
Update TBL_ECNFO set Parentcode = Party_code   
where Parentcode <> Party_code and Party_code not like '98%'  
  
---  
  
  
Update TBL_ECNCASH set Parentcode = Party_code where Party_code not like '98%' and Parentcode is null  
  
Update TBL_ECNFO set Parentcode = Party_code where Party_code not like '98%' and Parentcode is null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ECN_master_28022011
-- --------------------------------------------------
            
              
CREATE Proc ECN_master_28022011 as               
              
--------    anand.pradnya            
              
Drop table TBL_ECNCASH              
              
Drop table TBL_ECNFO              
            
            
-----  CASH segment client list table            
              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family              
into TBL_ECNCASH     
from bsedb_ab..Client1 x where exists              
(              
Select Cl_code from bsedb_ab..Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)               
union              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
from anand1.msajag.dbo.Client1 x where exists              
(              
Select Cl_code from anand1.msajag.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)              
              
              
------ F&O segment client list table               
             
              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
 into TBL_ECNFO from angelfo.nsefo.dbo.Client1 x where  exists              
(              
Select  Cl_code from angelfo.nsefo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)               
union              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
 from angelfo.nsecurfo.dbo.Client1 x where exists              
(              
Select  Cl_code from angelfo.nsecurfo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)              
union              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
from angelcommodity.mcdx.dbo.Client1 x where exists              
(              
Select  Cl_code from angelcommodity.mcdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)              
union              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
 from angelcommodity.mcdxcds.dbo.Client1 x where exists              
(              
Select  Cl_code from angelcommodity.mcdxcds.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)              
union              
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,            
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family             
from angelcommodity.ncdx.dbo.Client1 x where exists              
(              
Select  Cl_code from angelcommodity.ncdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2              
)          
          
delete from TBL_ECNCASH Where Party_code ='M888' -- deleting this client to skip extra pages print.          
delete from TBL_ECNFO Where Party_code ='M888' -- deleting this client to skip extra pages print.

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ECN_Master_Both
-- --------------------------------------------------
CREATE Proc ECN_Master_Both as 

-- by Dharmesh for distinct CASH & FO master 

Select * into #ecn from
(Select * from TBL_ECNcash
union
Select * from TBL_ECNfo)x 

----


Select Party_code,count(Party_code) as cnt into #t from #ecn 
group by Party_code having Count(Party_code) > 1

------

Delete from #ecn where Party_code in
(Select Party_code from #t)


Insert into #ecn
Select Branch_cd,Sub_broker,Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,Mobile_Pager,
RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode
from anand1.msajag.dbo.Client_details where Cl_code collate SQL_Latin1_General_CP1_CI_AS in
(Select Party_code from #t)

---

Truncate table TBL_ECNcash

Insert into TBL_ECNcash
Select * from #ecn  

Truncate table TBL_ECNfo

Insert into TBL_ECNfo
Select * from #ecn 

-----

Drop table #t

Drop table #ecn

----

Delete from TBL_ECNcash where Party_code = 'B34116'

Delete from TBL_ECNfo where Party_code = 'B34116'

Delete from TBL_ECNcash where Party_code like '88%'

Delete from TBL_ECNfo where Party_code like '88%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ECN_master_ITVISION
-- --------------------------------------------------
CREATE Proc ECN_master as             
            
--------    anand.pradnya          
            
Drop table TBL_ECNCASH            
            
Drop table TBL_ECNFO            
          
          
-----  CASH segment client list table          
            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode            
into TBL_ECNCASH   
from bsedb_ab..Client1 x, bsedb_ab..Client2 y /*where exists            
(            
Select Cl_code from bsedb_ab..Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
Where x.Cl_code = y.Cl_code and PrintF = 2

union            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode  
from anand1.msajag.dbo.Client1 x, anand1.msajag.dbo.Client2 y /*where exists            
(            
Select Cl_code from anand1.msajag.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/            
Where x.Cl_code = y.Cl_code and PrintF = 2
            
            
------ F&O segment client list table             
           
            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode           
 into TBL_ECNFO from angelfo.nsefo.dbo.Client1 x,angelfo.nsefo.dbo.Client2 y /* where  exists            
(            
Select  Cl_code from angelfo.nsefo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
where x.Cl_code = y.Cl_code and PrintF = 2             
union            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode           
 from angelfo.nsecurfo.dbo.Client1 x, angelfo.nsecurfo.dbo.Client2 y /*where exists            
(            
Select  Cl_code from angelfo.nsecurfo.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
where x.Cl_code = y.Cl_code and PrintF = 2              
union            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode
from angelcommodity.mcdx.dbo.Client1 x, angelcommodity.mcdx.dbo.Client2 y /*where exists            
(            
Select  Cl_code from angelcommodity.mcdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
where x.Cl_code = y.Cl_code and PrintF = 2
union            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode
 from angelcommodity.mcdxcds.dbo.Client1 x, angelcommodity.mcdxcds.dbo.Client2 y /*where exists            
(            
Select  Cl_code from angelcommodity.mcdxcds.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
where x.Cl_code = y.Cl_code and PrintF = 2
union            
Select Branch_cd,Sub_broker,x.Cl_code as Party_code,long_name,SHORT_NAME,L_Address1,L_Address2,L_Address3,L_City,L_Zip,L_State,          
Mobile_Pager,RES_Phone1,RES_Phone2,OFF_Phone1,Area,Region,Trader,Family,ParentCode
from angelcommodity.ncdx.dbo.Client1 x, angelcommodity.ncdx.dbo.Client2 y /*where exists            
(            
Select  Cl_code from angelcommodity.ncdx.dbo.Client2 y where x.Cl_code = y.Cl_code and PrintF = 2            
)*/
where x.Cl_code = y.Cl_code and PrintF = 2
        
delete from TBL_ECNCASH Where Party_code ='M888' -- deleting this client to skip extra pages print.        
delete from TBL_ECNFO Where Party_code ='M888' -- deleting this client to skip extra pages print.     

--- by Dharmesh due to printflag mismatch between ParentCode and Child Code : 03/03/2011

Select ParentCode,count(Party_code) as CL into #t  from tbl_ECNcash
Group by Parentcode having count(Party_code) > 1

---

Select * into #x from TBL_ECNCASH where Party_code like '98%' and Parentcode not in
(Select ParentCode from #t)

---

Update #x set Party_code = Parentcode 

---

insert into TBL_ECNCASH
Select * from #x

drop table #x
drop table #t

----

Update TBL_ECNCASH set Parentcode = Party_code 
where Parentcode <> Party_code and Party_code not like '98%'

----

Update TBL_ECNFO set Parentcode = Party_code 
where Parentcode <> Party_code and Party_code not like '98%'

---


Update TBL_ECNCASH set Parentcode = Party_code where Party_code not like '98%' and Parentcode is null

Update TBL_ECNFO set Parentcode = Party_code where Party_code not like '98%' and Parentcode is null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EQ_REPORTING_DATA
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[EQ_REPORTING_DATA]   
(  
@RPT_DATE DATETIME  
)  
AS  
BEGIN  
  
--USE PRADNYA -- AngelBSECM  
--GO  
  
--/* LEDGER BALANCE */  
  
--DECLARE @YST_DATE DATETIME = '2021-04-01',  
--@RPT_DATE  DATETIME = '2021-06-30' --- ### LAST TRADING DATE OF THE MONTH  ####  
  
  
----NSECM  
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #NSECM            
 FROM ANAND1.ACCOUNT.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <> 'MTF PROCESS'  
  GROUP BY CLTCODE     
    
  CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#NSECM]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
   INSERT INTO #NSECM    
   SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
   FROM ANAND1.ACCOUNTSLBS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <> 'MTF PROCESS'  
  GROUP BY CLTCODE   
    
 ------BSECM  
    
         
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #BSECM            
 FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>'MTF PROCESS'  
 GROUP BY CLTCODE    
   
  CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#BSECM]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
      -----NSEFO     
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #NSEFO            
 FROM ANGELFO.ACCOUNTFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>'MTF PROCESS'  
 GROUP BY CLTCODE    
   
  CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#NSEFO]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
   
  -------NSX     
       
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #NSX            
 FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>'MTF PROCESS'  
 GROUP BY CLTCODE  
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#NSX]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
  
  
----MCD  
       
         
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #MCD            
 FROM ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>' MTF PROCESS'  
 GROUP BY CLTCODE    
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#MCD]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
  
------MTFTRADE  
            
   
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #MTF            
 FROM ANAND1.MTFTRADE.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>' MTF PROCESS'  
 GROUP BY CLTCODE    
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#MTF]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
   
   
 ------BSX  
  
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #BSX            
 FROM  ANGELCOMMODITY.ACCOUNTCURBFO.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>' MTF PROCESS'  
 GROUP BY CLTCODE    
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#BSX]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
----MCDX  
  
 SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #MCX          
 FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>' MTF PROCESS'  
 GROUP BY CLTCODE    
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#MCX]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
---NCDX  
  
  SELECT CLTCODE,NETAMT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)            
 INTO #NCX  
 FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER WITH (NOLOCK) WHERE VDT >= '2021-04-01' AND VDT<= @RPT_DATE + '23:59' --AND ISNULL(ENTEREDBY,'') <>' MTF PROCESS'  
 GROUP BY CLTCODE   
   
 CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#NCX]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
    
  
 ---- SELECT * FROM #NSECM WHERE CLTCODE LIKE '98%' AND NETAMT <> 0  
  
 UPDATE  #BSECM SET CLTCODE = PARENTCODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C        
 WHERE  CLTCODE LIKE '98%' AND CLTCODE=CL_CODE             
             
  SELECT * INTO #AB FROM (            
  SELECT * FROM #NSECM            
  UNION ALL            
  SELECT * FROM #BSECM            
  UNION ALL            
  SELECT * FROM #NSEFO            
  UNION ALL            
  SELECT * FROM #NSX            
  UNION ALL            
  SELECT * FROM #MCD  
  UNION ALL            
  SELECT * FROM #MTF  
  UNION ALL            
  SELECT * FROM #BSX  
  UNION ALL            
  SELECT * FROM #MCX  
  UNION ALL            
  SELECT * FROM #NCX  
     )X   ORDER BY CLTCODE  
       
       
      CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[#AB]            
(     [CLTCODE] ASC,[NETAMT]  ASC     )   
  
 DELETE FROM #AB WHERE CLTCODE LIKE '05%'  
  
 UPDATE #AB SET CLTCODE = PARENTCODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C        
 WHERE  CLTCODE LIKE '98%' AND CLTCODE=CL_CODE  
  
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #NSECOMBINED FROM #AB GROUP BY CLTCODE   
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #BSEFINAL FROM #BSECM WHERE CLTCODE >='A00' AND CLTCODE <='ZZZZZ' GROUP BY CLTCODE   
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #BSXFINAL FROM #BSX WHERE CLTCODE >='A00' AND CLTCODE <='ZZZZZ' GROUP BY CLTCODE    
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #MTFFINAL FROM #MTF WHERE CLTCODE >='A00' AND CLTCODE <='ZZZZZ' GROUP BY CLTCODE   
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #MCXFINAL FROM #MCX WHERE CLTCODE >='A00' AND CLTCODE <='ZZZZZ' GROUP BY CLTCODE    
 SELECT CLTCODE,SUM(NETAMT) NET_AMT INTO #NCXFINAL FROM #NCX WHERE CLTCODE >='A00' AND CLTCODE <='ZZZZZ' GROUP BY CLTCODE   
  
  
 SELECT * INTO #NSECOMBINED_FINAL FROM #NSECOMBINED WHERE CLTCODE >= 'A00' AND CLTCODE <= 'ZZZZZ'  
  
 ALTER  TABLE #NSECOMBINED_FINAL  
 ADD NSEBALANCE NUMERIC(18,2)  
   
 CREATE NONCLUSTERED INDEX [IX_PARTY_CODE] ON [dbo].[#NSECOMBINED]            
(      [CLTCODE]ASC  )   
  
  SELECT CLTCODE,SUM(NETAMT) VAMT INTO #NSECOMB FROM (            
 SELECT * FROM #NSECM            
  UNION ALL            
 SELECT * FROM #NSEFO            
  UNION ALL            
 SELECT * FROM #NSX )A  GROUP BY CLTCODE  
  
  UPDATE F SET NSEBALANCE = VAMT FROM #NSECOMBINED_FINAL F,#NSECOMB N   
 WHERE  F.CLTCODE >='A00' AND F.CLTCODE <='ZZZZZ' AND F.CLTCODE = N.CLTCODE   
   
  
  -------- /* END LEDGER */ ----------  
  
  -- SELECT * FROM #NSECOMBINED_FINAL WHERE CLTCODE ='D47514'  
  
  -------------##### HOLDING #### ----------  
  
  --DECLARE @RPT_DATE  DATETIME = '2021-06-30'  
  
  SELECT UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,ISIN,SUM(QTY) AS QTY INTO #HOLD FROM   
   -- ANGELDEMAT.INHOUSE.DBO.EXCH_HOLD_REPORTING WITH (NOLOCK) WHERE HOLDINGDATE >= @RPT_DATE AND HOLDINGDATE <= @RPT_DATE + '23:59'   
    ANGELDEMAT.BSEDB.DBO.CLIENT_HOLDING_NEW WITH (NOLOCK) WHERE DP_DATE = @RPT_DATE  
 AND CLIENTID NOT IN ('1203320006951435','1203320000006579','10184021','10003588','1203320000006564','1100001100017670','1203320030135814','1203320030135829')   
 --AND CERTNO NOT IN ('INX528G01035','INE528G01035','INE528G01027')  
 GROUP BY PARTY_CODE,ISIN   
   
      CREATE NONCLUSTERED INDEX [IX_HOLD1] ON [dbo].[#HOLD]            
(     [PARTY_CODE] ASC,[ISIN] ,[QTY] )   
  
--INSERT INTO #HOLD  
--  SELECT UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,ISIN ,SUM(QTY) AS QTY  FROM   
--    ANGELDEMAT.BSEDB.DBO.CLIENT_HOLDING_NEW WITH (NOLOCK) WHERE DP_DATE = @RPT_DATE  
-- AND ISIN IN ('INX528G01035','INE528G01035','INE528G01027')  
-- AND CLIENTID NOT IN ('1203320006951435','1203320000006579','10184021','10003588','1203320000006564','1100001100017670','1203320030135814','1203320030135829')  
-- GROUP BY PARTY_CODE,ISIN   
   
---------- PLEDGE INVOKED -----------  
  
INSERT INTO #HOLD  
 SELECT PARTY_CODE,ISIN,QTY  
  FROM ANGELDEMAT.BSEDB.DBO.CLIENT_HOLDING_NEW WITH (NOLOCK) WHERE DP_DATE = @RPT_DATE  
 AND CLIENTID IN ('1203320030135814','1203320030135829')   
    
/*  
  SELECT UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,ISIN,SUM(QTY) AS QTY INTO #HOLD FROM   
   ( SELECT PARTY_CODE,ISIN,SUM(QTY) AS QTY  --- SUM(CASE WHEN ISNULL(ADJQTY,0) < 0 THEN QTY+ADJQTY ELSE QTY END) AS QTY   
    FROM  [CSOKYC-6].HISTORY.DBO.RMS_HOLDING WITH (NOLOCK)  
   WHERE UPD_DATE >= @RPT_DATE AND UPD_DATE <= @RPT_DATE + '23:59' AND SOURCE ='H'    -- #### --AND PROCESSDATE = '2020-07-01 14:01:47.660' ###  
   GROUP BY PARTY_CODE,ISIN   
  UNION ALL  
 SELECT UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,ISIN,SUM(QTY) AS QTY FROM MSAJAG..COLLATERALDETAILS WITH (NOLOCK)  
   WHERE EFFDATE = @RPT_DATE GROUP BY PARTY_CODE,ISIN )A  
  GROUP BY PARTY_CODE,ISIN   
    
*/  
    
 ---  TBL_EXCHG_SCRIP_MAP  
  
  DELETE  FROM #HOLD WHERE QTY <= 0   
  
   UPDATE #HOLD SET PARTY_CODE = PARENTCODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C        
 WHERE #HOLD.PARTY_CODE LIKE '98%' AND #HOLD.PARTY_CODE = C.CL_CODE     
  
  
UPDATE T SET PARTY_CODE = B.NEW_CODE FROM #HOLD T, ANGELDEMAT.BSEDB.DBO.TBL_OCNC B WHERE PARTY_CODE = OLD_CODE  
  
----   
  
 SELECT PARTY_CODE,ISIN,SUM(QTY) AS QTY INTO #HOLDING FROM #HOLD GROUP BY PARTY_CODE,ISIN   
  
  ----- ### ADDING SCRIP NAME ####  
        CREATE NONCLUSTERED INDEX [IX_HOLD2] ON [dbo].[#HOLDING]            
(     [PARTY_CODE] ASC,[ISIN] ,[QTY] )   
    
    
   ALTER TABLE #HOLDING  
 ADD SCRIP VARCHAR(100)  
   
    
 SELECT I.ISIN ,LONG_NAME INTO #NSE FROM ANGELDEMAT.MSAJAG.DBO.SCRIP2 T, ANGELDEMAT.MSAJAG.DBO.SCRIP1 S, ANGELDEMAT.MSAJAG.DBO.MULTIISIN I  
  WHERE T.CO_CODE = S.CO_CODE  AND I.SCRIP_CD = T.SCRIP_CD AND I.SERIES = T.SERIES   
  CREATE NONCLUSTERED INDEX [IX_ISIN] ON [dbo].[#NSE]            
(      [ISIN] ,[LONG_NAME] )   
   
   
    
 SELECT I.ISIN ,LONG_NAME INTO #BSE FROM ANGELDEMAT.BSEDB.DBO.SCRIP2 T, ANGELDEMAT.BSEDB.DBO.SCRIP1 S, ANGELDEMAT.BSEDB.DBO.MULTIISIN I  
  WHERE T.CO_CODE = S.CO_CODE  AND I.SCRIP_CD = T.BSECODE     
    
  CREATE NONCLUSTERED INDEX [IX_ISIN] ON [dbo].[#BSE]            
(      [ISIN] ,[LONG_NAME] )   
  
/*  
  
 SELECT * FROM #NSE WHERE LONG_NAME LIKE '&#%'  
  
 SELECT * FROM #BSE WHERE ISIN IN ('INE807M01023','INE039A09OF3','IN8607L01028') ORDER BY ISIN  
 SELECT * FROM #NSE WHERE ISIN IN ('INE807M01023','INE039A09OF3','IN8607L01028') ORDER BY ISIN  
  
*/  
  
 UPDATE #NSE SET LONG_NAME = 'INDOVATION TECHNOLOGIES LTD.' WHERE ISIN = 'INE807M01023'  
 UPDATE #NSE SET LONG_NAME = 'IFCI-9.09%-IV-15-2-22-B-PVT' WHERE ISIN = 'INE039A09OF3'  
 UPDATE #NSE SET LONG_NAME = 'BILENERGYLP' WHERE ISIN = 'IN8607L01028'  
  
  
---  
   
 UPDATE H SET SCRIP = LONG_NAME FROM #HOLDING H,#NSE N WHERE H.ISIN = N.ISIN   
 UPDATE H SET SCRIP = LONG_NAME FROM #HOLDING H,#BSE B WHERE H.ISIN = B.ISIN  AND SCRIP IS NULL  
   
 UPDATE #HOLDING SET SCRIP = 'YESBANK' WHERE ISIN = 'INE528G01027'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'ADITYA BIRLA SUN LIFE TAX RELIEF 96' WHERE ISIN = 'INF209K01090'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'ANGEL WELLNESS-EQ' WHERE ISIN = 'INE05WV01018'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'ANGEL FINCAP PVT-EQ' WHERE ISIN = 'INE05XZ01017'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'MIMANSA SOFTWARE-EQ' WHERE ISIN = 'INE727L01017'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'ANGEL SECURITIES-EQ' WHERE ISIN = 'INE728L01015'  AND SCRIP IS NULL  
 UPDATE #HOLDING SET SCRIP = 'ANGEL FINANCIAL-EQ' WHERE ISIN = 'INE729L01013'  AND SCRIP IS NULL   
 UPDATE #HOLDING SET SCRIP = 'MAFATLAL FINANCE' WHERE ISIN = 'INE965B01014' AND SCRIP IS NULL  
 --UPDATE #HOLDING SET SCRIP = 'INVENTURE GROWTH' WHERE ISIN = 'INE878H01016' AND SCRIP IS NULL  
  
  
-- SELECT * FROM ANAND1.MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP WHERE ISIN IN (  
-- SELECT DISTINCT ISIN FROM #HOLDING WHERE SCRIP IS NULL ) AND TO_DATE > GETDATE ()  
  
  
-- UPDATE A SET ISIN = B.ISIN FROM #T A, ANAND1.MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP  B WITH (NOLOCK)   
--WHERE A.SCRIP_CD = B.NSE_SCRIP_CD AND A.SERIES = B.NSE_SERIES -- AND VALID = 1   
--AND TO_DATE > GETDATE ()  
  
----SELECT DISTINCT ISIN FROM #HOLDING WHERE SCRIP IS NULL   
  
 -- SELECT * FROM #HOLDING WHERE PARTY_CODE = 'A100044'   
  
  ----   
  
TRUNCATE TABLE TBL_HOLDING   
  
 INSERT INTO TBL_HOLDING  -- 278703  
 SELECT * FROM #HOLDING   
 ORDER BY PARTY_CODE,ISIN  
   
-- SELECT * FROM TBL_PLDRPT WHERE PARTY_CODE = 'JAIP2829'  
  
 SELECT PARTY_CODE,COUNT(ISIN) ISIN_COUNT,SUM(QTY) QTY_COUNT INTO #HOLDCOUNT FROM TBL_HOLDING GROUP BY PARTY_CODE   
   
   CREATE NONCLUSTERED INDEX [IX_ISIN] ON [dbo].[#HOLDCOUNT]            
(      [PARTY_CODE]ASC  )   
  
   -------- DROP TABLE #PLD_FINAL  
 -- SELECT * FROM #PLD_FINAL WHERE PLD_QTY = 0  
    
 SELECT PARTY_CODE,SUM(QTY) AS PLD_QTY,SUM(PLEDGE_VALUE) AS PLD_VALUE,SUM(BORROWING) AS BORROWING,COUNT(DISTINCT ISIN) AS ISIN_COUNT  
 INTO #PLD_FINAL FROM TBL_PLDRPT WHERE QTY <> 0   
  GROUP BY PARTY_CODE   
   ORDER BY PARTY_CODE  
     
     
CREATE NONCLUSTERED INDEX [IX_PARTY_CODE] ON [dbo].[#PLD_FINAL]            
(      [PARTY_CODE]ASC  )   
  
---  
  
  ALTER TABLE #NSECOMBINED_FINAL  
  ADD TOTAL_ISIN VARCHAR(25), TOTA_QTY_SEC NUMERIC(18,2),PLEDGE_QTY NUMERIC(18,2),PLDGE_AMOUNT NUMERIC(18,2),SEBI_PAYOUT DATETIME  
  ALTER TABLE #NSECOMBINED_FINAL ADD BSE_BALANCE NUMERIC(18,2),MCD NUMERIC(18,2),BSX NUMERIC(18,2),MTF NUMERIC(18,2),BARROWING  NUMERIC(18,2) ,  
  MCX_BALANCE NUMERIC(18,2),NCX NUMERIC(18,2)  
  
ALTER TABLE #NSECOMBINED_FINAL ADD PLD_ISIN VARCHAR(25)  
  
UPDATE #NSECOMBINED_FINAL SET PLEDGE_QTY = 0,PLDGE_AMOUNT = 0,PLD_ISIN = 0,BARROWING = 0  
  
     
  ---------------- ###### SEBI PAYOUT ###### ------------------  
  
  --DECLARE @RPT_DATE  DATETIME = '2021-06-30'  
    
  SELECT  UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,MAX(SCCS_SETTDATE_LAST) AS SEBI_DT INTO #SEBIPAYOUT   
  FROM MIS.SCCS.DBO.SCCS_CLIENTMASTER WITH (NOLOCK) -- WHERE PARTY_CODE = 'K117022'  
   WHERE SCCS_SETTDATE_LAST <= @RPT_DATE + '23:59' AND PARTY_CODE >= 'A' AND PARTY_CODE <='ZZZZZ999' AND EXCLUDE ='N'   
   GROUP BY PARTY_CODE  
  
  INSERT INTO #SEBIPAYOUT  
   SELECT  UPPER(RTRIM(LTRIM(PARTY_CODE))) AS PARTY_CODE,MAX(SCCS_SETTDATE_LAST)   
   FROM MIS.SCCS.DBO.SCCS_CLIENTMASTER_HIST WITH (NOLOCK) --  WHERE PARTY_CODE = 'K117022'  
   WHERE SCCS_SETTDATE_LAST <= @RPT_DATE + '23:59' AND PARTY_CODE >= 'A00' AND PARTY_CODE <= 'ZZZZZ' AND EXCLUDE ='N'  
    GROUP BY PARTY_CODE  
  
  SELECT PARTY_CODE,MAX(SEBI_DT) AS SEBI_DT INTO #SEBI_FINAL FROM #SEBIPAYOUT GROUP BY PARTY_CODE  
   
   
  -------------- ##### FINAL REPORT ###### -----------  
  
  /* ONLY HOLDING CLIENTS ADDED  03012020 */     
  
  Create index #c on #NSECOMBINED_FINAL (CLTCODE)  
  
 -- Create index party_code on TBL_HOLDING (PARTY_CODE)  
  
SELECT DISTINCT PARTY_CODE INTO #HLD   
FROM TBL_HOLDING (NOLOCK) WHERE NOT EXISTS (SELECT CLTCODE FROM #NSECOMBINED_FINAL (NOLOCK) WHERE PARTY_CODE = CLTCODE )  
  
 -- DROP TABLE #HLD   
  
 INSERT INTO #NSECOMBINED_FINAL (CLTCODE)  
 SELECT * FROM #HLD  
 WHERE PARTY_CODE NOT LIKE '05%'   
  
  
 /**********************COMPLETED***************/  
    
  UPDATE #NSECOMBINED_FINAL SET TOTAL_ISIN = ISIN_COUNT,TOTA_QTY_SEC = QTY_COUNT FROM #HOLDCOUNT   
  WHERE #NSECOMBINED_FINAL.CLTCODE = #HOLDCOUNT.PARTY_CODE   
  
 UPDATE #NSECOMBINED_FINAL SET PLEDGE_QTY = PLD_QTY,PLDGE_AMOUNT = PLD_VALUE FROM #PLD_FINAL   
  WHERE #NSECOMBINED_FINAL.CLTCODE = #PLD_FINAL.PARTY_CODE   
  
UPDATE #NSECOMBINED_FINAL SET BARROWING = #PLD_FINAL.BORROWING,PLD_ISIN = ISIN_COUNT FROM #PLD_FINAL    
WHERE #NSECOMBINED_FINAL.CLTCODE = #PLD_FINAL.PARTY_CODE   
  
 UPDATE #NSECOMBINED_FINAL SET SEBI_PAYOUT = SEBI_DT FROM #SEBI_FINAL WHERE #NSECOMBINED_FINAL.CLTCODE = #SEBI_FINAL.PARTY_CODE   
    
 UPDATE #NSECOMBINED_FINAL SET TOTAL_ISIN = 0,TOTA_QTY_SEC = 0 WHERE TOTAL_ISIN IS NULL  
 UPDATE #NSECOMBINED_FINAL SET PLEDGE_QTY = 0,PLDGE_AMOUNT = 0 WHERE PLEDGE_QTY IS NULL  
 UPDATE #NSECOMBINED_FINAL SET BARROWING = 0 WHERE BARROWING IS NULL  
  
 UPDATE #NSECOMBINED_FINAL SET BSE_BALANCE = 0  WHERE BSE_BALANCE IS NULL  
 UPDATE #NSECOMBINED_FINAL SET NSEBALANCE = 0  WHERE NSEBALANCE IS NULL  
 UPDATE #NSECOMBINED_FINAL SET MCD = 0 WHERE MCD IS NULL  
 UPDATE #NSECOMBINED_FINAL SET BSX = 0 WHERE BSX IS NULL  
 UPDATE #NSECOMBINED_FINAL SET MTF = 0 WHERE MTF IS NULL  
 UPDATE #NSECOMBINED_FINAL SET MCX_BALANCE = 0 WHERE MCX_BALANCE IS NULL  
 UPDATE #NSECOMBINED_FINAL SET NCX = 0 WHERE NCX IS NULL  
 UPDATE #NSECOMBINED_FINAL SET NET_AMT = 0 WHERE NET_AMT IS NULL  
 UPDATE #NSECOMBINED_FINAL SET PLD_ISIN = 0 WHERE PLD_ISIN IS NULL  
   
   
  
 UPDATE #NSECOMBINED_FINAL SET SEBI_PAYOUT = ''  WHERE SEBI_PAYOUT IS NULL  
  
-------TO CHECK MTF AND BSX------RAHUL SHAH--------  
  
  
 UPDATE  #NSECOMBINED_FINAL SET BSE_BALANCE = #BSEFINAL.NET_AMT FROM #BSEFINAL WHERE #NSECOMBINED_FINAL.CLTCODE = #BSEFINAL.CLTCODE   
  
 UPDATE  #NSECOMBINED_FINAL SET MCD = #MCD.NETAMT FROM #MCD WHERE #NSECOMBINED_FINAL.CLTCODE = #MCD.CLTCODE   
  
 ---------RAHUL-------  
 UPDATE  #NSECOMBINED_FINAL SET BSX = #BSXFINAL.NET_AMT FROM #BSXFINAL WHERE #NSECOMBINED_FINAL.CLTCODE = #BSXFINAL.CLTCODE   
  
 UPDATE  #NSECOMBINED_FINAL SET MTF = #MTF.NETAMT FROM #MTF WHERE #NSECOMBINED_FINAL.CLTCODE = #MTF.CLTCODE   
  
  UPDATE  #NSECOMBINED_FINAL SET MCX_BALANCE = #MCXFINAL.NET_AMT FROM #MCXFINAL WHERE #NSECOMBINED_FINAL.CLTCODE = #MCXFINAL.CLTCODE   
  
 UPDATE  #NSECOMBINED_FINAL SET NCX = #NCXFINAL.NET_AMT FROM #NCXFINAL WHERE #NSECOMBINED_FINAL.CLTCODE = #NCXFINAL.CLTCODE   
  
 DELETE FROM #NSECOMBINED_FINAL WHERE CLTCODE IN ('BBBB','SSSS','EEEE','EEEEE','AAAA','ERROR')  
  
 -- UPDATE #NSECOMBINED_FINAL SET NET_AMT=NET_AMT*-1,NSEBALANCE=NSEBALANCE*-1,BSE_BALANCE=BSE_BALANCE*-1,MCD=MCD*-1,BSX=BSX*-1,MTF=MTF*-1  
  
  
TRUNCATE TABLE NSE_DATA_FINAL  
  
INSERT INTO NSE_DATA_FINAL -- 4011992  
 SELECT * FROM #NSECOMBINED_FINAL WHERE CLTCODE >= 'A' AND CLTCODE <= 'ZZZZZZZZZZ'  
 ORDER BY CLTCODE  
  
    
-- SELECT * FROM NSE_DATA_FINAL WHERE CLTCODE = 'A153805'  
  
DELETE FROM NSE_DATA_FINAL WHERE CLTCODE LIKE '%?%'  
DELETE FROM NSE_DATA_FINAL WHERE CLTCODE LIKE '%G %'  
  
-- UPDATE NSE_DATA_FINAL SET CLTCODE = 'G25830' WHERE CLTCODE LIKE '%?%'  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FN
-- --------------------------------------------------
  
CREATE PROC FN @FUN VARCHAR(25)AS             
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @FUN + '%' AND XTYPE='FN' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTEST
-- --------------------------------------------------




create PROC [dbo].[FOTEST]--Test 'D:\backoffice\foHOLD.csv'   
@Test_File AS VARCHAR(MAX)  
AS   
BEGIN  
  
TRUNCATE TABLE Fohold;  
  
DECLARE @SQL VARCHAR(2000)  
  
SET NOCOUNT ON  
SET @SQL = 'BULK INSERT Fohold FROM ''' + @Test_File + ''' WITH (FIRSTROW = 1,FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'') '  
EXEC(@SQL)  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MCDX_REP_FILE_GEN
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[MCDX_REP_FILE_GEN]    
--(@DATE DATETIME,@DATA VARCHAR(20))    
AS     
BEGIN     
   
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE < 'A47'  
    
DECLARE @FILE VARCHAR(MAX),@PATH VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE = @PATH + 'NCX_FUNDSECBALDTL_01' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S VARCHAR(MAX)                                
SET @S = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S = @S + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar)  F
ROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'A47' AND PARTY_CODE < 'BB'  
    
DECLARE @FILE1 VARCHAR(MAX),@PATH1 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE1 = @PATH1 + 'NCX_FUNDSECBALDTL_02' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S1 VARCHAR(MAX)                                
SET @S1 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S1 = @S1 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file1+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S1)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'BB' AND PARTY_CODE < 'DE'  
    
DECLARE @FILE2 VARCHAR(MAX),@PATH2 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE2 = @PATH2 + 'NCX_FUNDSECBALDTL_03' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S2 VARCHAR(MAX)                                
SET @S2 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S2 = @S2 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file2+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S2)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'DE' AND PARTY_CODE < 'H8'  
    
DECLARE @FILE3 VARCHAR(MAX),@PATH3 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE3 = @PATH3 + 'NCX_FUNDSECBALDTL_04' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S3 VARCHAR(MAX)                                
SET @S3 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S3 = @S3 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE3+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S3)  
  
end  
  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'H8' AND PARTY_CODE < 'K22'  
    
DECLARE @FILE4 VARCHAR(MAX),@PATH4 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE4 = @PATH4 + 'NCX_FUNDSECBALDTL_05' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S4 VARCHAR(MAX)                                
SET @S4 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S4 = @S4 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE4+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S4)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'K22' AND PARTY_CODE < 'M27'  
    
DECLARE @FILE5 VARCHAR(MAX),@PATH5 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE5 = @PATH5 + 'NCX_FUNDSECBALDTL_06' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S5 VARCHAR(MAX)                                
SET @S5 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S5 = @S5 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE5+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S5)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'M27' AND PARTY_CODE < 'N6'  
    
DECLARE @FILE6 VARCHAR(MAX),@PATH6 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE6 = @PATH6 + 'NCX_FUNDSECBALDTL_07' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S6 VARCHAR(MAX)                                
SET @S6 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S6 = @S6 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE6+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S6)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'N6'   AND PARTY_CODE < 'P35'  
    
DECLARE @FILE7 VARCHAR(MAX),@PATH7 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE7 = @PATH7 + 'NCX_FUNDSECBALDTL_08' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S7 VARCHAR(MAX)                                
SET @S7 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S7 = @S7 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE7+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S7)  
  
end  
  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'P35'  AND PARTY_CODE < 'R32'  
    
DECLARE @FILE8 VARCHAR(MAX),@PATH8 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE8 = @PATH8 + 'NCX_FUNDSECBALDTL_09' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S8 VARCHAR(MAX)                                
SET @S8 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S8 = @S8 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE8+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S8)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'R32' AND PARTY_CODE < 'S36'   
    
DECLARE @FILE9 VARCHAR(MAX),@PATH9 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE9 = @PATH9 + 'NCX_FUNDSECBALDTL_10' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S9 VARCHAR(MAX)                                
SET @S9 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S9 = @S9 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE9+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S9)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'S36' AND PARTY_CODE < 'S69'  
    
DECLARE @FILE10 VARCHAR(MAX),@PATH10 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE10 = @PATH10 + 'NCX_FUNDSECBALDTL_11' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S10 VARCHAR(MAX)                                
SET @S10 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S10 = @S10 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE10+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S10)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'S69' AND PARTY_CODE < 'UN'  
    
DECLARE @FILE11 VARCHAR(MAX),@PATH11 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE11 = @PATH11 + 'NCX_FUNDSECBALDTL_12' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S11 VARCHAR(MAX)                                
SET @S11 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S11 = @S11 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE11+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S11)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'UN'  
    
DECLARE @FILE12 VARCHAR(MAX),@PATH12 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE12 = @PATH12 + 'NCX_FUNDSECBALDTL_13' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S12 VARCHAR(MAX)                                
SET @S12 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S12 = @S12 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE12+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S12)  
  
end  
  
--------------------------NCDX  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE < 'A47'  
    
DECLARE @FILE13 VARCHAR(MAX),@PATH13 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE13 = @PATH13 + 'NCX_FUNDSECBAL_01' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S13 VARCHAR(MAX)                                
SET @S13 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S13 = @S13 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE13+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S13)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'A47' AND CLTCODE < 'BB'  
    
DECLARE @FILE14 VARCHAR(MAX),@PATH14 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE14 = @PATH14 + 'NCX_FUNDSECBAL_02' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S14 VARCHAR(MAX)                                
SET @S14 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S14 = @S14 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE14+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S14)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'BB' AND CLTCODE < 'DE'  
    
DECLARE @FILE15 VARCHAR(MAX),@PATH15 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE15 = @PATH15 + 'NCX_FUNDSECBAL_03' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S15 VARCHAR(MAX)                                
SET @S15 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S15 = @S15 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE15+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S15)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'DE' AND CLTCODE < 'H8'  
    
DECLARE @FILE16 VARCHAR(MAX),@PATH16 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE16 = @PATH16 + 'NCX_FUNDSECBAL_04' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S16 VARCHAR(MAX)                                
SET @S16 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S16 = @S16 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE16+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S16)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'H8' AND CLTCODE < 'K22'  
    
DECLARE @FILE17 VARCHAR(MAX),@PATH17 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE17 = @PATH17 + 'NCX_FUNDSECBAL_05' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S17 VARCHAR(MAX)                                
SET @S17 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S17 = @S17 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE17+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S17)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'K22' AND CLTCODE < 'M27'  
    
DECLARE @FILE18 VARCHAR(MAX),@PATH18 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE18 = @PATH18 + 'NCX_FUNDSECBAL_06' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S18 VARCHAR(MAX)                                
SET @S18 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S18 = @S18 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE18+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S18)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'M27' AND CLTCODE < 'N6'   
    
DECLARE @FILE19 VARCHAR(MAX),@PATH19 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE19 = @PATH19 + 'NCX_FUNDSECBAL_07' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S19 VARCHAR(MAX)                                
SET @S19 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S19 = @S19 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE19+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S19)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'N6' AND CLTCODE < 'P35'  
    
DECLARE @FILE20 VARCHAR(MAX),@PATH20 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE20 = @PATH20 + 'NCX_FUNDSECBAL_08' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S20 VARCHAR(MAX)                                
SET @S20 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S20 = @S20 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE20+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S20)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'P35'  AND CLTCODE < 'R32'  
    
DECLARE @FILE21 VARCHAR(MAX),@PATH21 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE21 = @PATH21 + 'NCX_FUNDSECBAL_09' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S21 VARCHAR(MAX)                                
SET @S21 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S21 = @S21 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE21+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S21)        
end   
  
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'R32' AND CLTCODE < 'S36'   
    
DECLARE @FILE22 VARCHAR(MAX),@PATH22 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE22 = @PATH22 + 'NCX_FUNDSECBAL_10' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S22 VARCHAR(MAX)                                
SET @S22 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S22 = @S22 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE22+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S22)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S36' AND CLTCODE < 'S69'  
    
DECLARE @FILE23 VARCHAR(MAX),@PATH23 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE23 = @PATH23 + 'NCX_FUNDSECBAL_11' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S23 VARCHAR(MAX)                                
SET @S23 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S23 = @S23 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE23+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S23)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S69' AND CLTCODE < 'UN'  
    
DECLARE @FILE24 VARCHAR(MAX),@PATH24 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE24 = @PATH24 + 'NCX_FUNDSECBAL_12' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S24 VARCHAR(MAX)                                
SET @S24 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S24 = @S24 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE24+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S24)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'UN'  
    
DECLARE @FILE25 VARCHAR(MAX),@PATH25 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE25 = @PATH25 + 'NCX_FUNDSECBAL_13' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S25 VARCHAR(MAX)                                
SET @S25 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S25 = @S25 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE25+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S25)        
end   
  --------------MCDX  
TRUNCATE TABLE MCDX_REPORTING_DATE    
BEGIN    
INSERT INTO MCDX_REPORTING_DATE    
select LONG_NAME,CLTCODE,PAN_GIR_NO,MCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from MCX_C_WFIN WHERE CLTCODE < 'R'   
    
DECLARE @FILE26 VARCHAR(MAX),@PATH26 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\MCDX\'                         
SET @FILE26 = @PATH26 + 'MCDX_1' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S26 VARCHAR(MAX)                                
SET @S26 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''MCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S26 = @S26 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([MCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[MCDX_REPORTING_DATE]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE26+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S26)        
end   
  
  
TRUNCATE TABLE MCDX_REPORTING_DATE    
BEGIN    
INSERT INTO MCDX_REPORTING_DATE    
select LONG_NAME,CLTCODE,PAN_GIR_NO,MCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from MCX_C_WFIN WHERE  CLTCODE > 'R'    
    
DECLARE @FILE27 VARCHAR(MAX),@PATH27 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\MCDX\'                         
SET @FILE27 = @PATH27 + 'MCDX_2' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S27 VARCHAR(MAX)                                
SET @S27 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''MCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S27 = @S27 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([MCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[MCDX_REPORTING_DATE]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE27+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S27)   
  
TRUNCATE TABLE MCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO MCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from MCX_S_WFIN    
    
DECLARE @FILE28 VARCHAR(MAX),@PATH28 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\MCDX\'                         
SET @FILE28 = @PATH28 + 'MCDX_2_S' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S28 VARCHAR(MAX)                                
SET @S28 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S28 = @S28 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[MCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE28+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S28)        
end        
end   
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_REP_FILE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[NCDX_REP_FILE]    
--(@DATE DATETIME,@DATA VARCHAR(20))    
AS     
BEGIN     
   
 --SELECT TOP 3 * FROM NCDX_REPORTING_DETAIL  
 --SELECT * INTO NCDX_REPORTING_DETAIL FROM NCX_C_WFIN  
   
 TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE < 'A47'  
    
DECLARE @FILE13 VARCHAR(MAX),@PATH13 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE13 = @PATH13 + 'NCX_FUNDSECBAL_01' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S13 VARCHAR(MAX)                                
SET @S13 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S13 = @S13 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_IS
IN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE13+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S13)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'A47' AND CLTCODE < 'BB'  
    
DECLARE @FILE14 VARCHAR(MAX),@PATH14 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE14 = @PATH14 + 'NCX_FUNDSECBAL_02' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S14 VARCHAR(MAX)                                
SET @S14 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S14 = @S14 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE14+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S14)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'BB' AND CLTCODE < 'DE'  
    
DECLARE @FILE15 VARCHAR(MAX),@PATH15 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE15 = @PATH15 + 'NCX_FUNDSECBAL_03' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S15 VARCHAR(MAX)                                
SET @S15 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S15 = @S15 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if reqired      
      
 +@FILE15+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S15)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'DE' AND CLTCODE < 'H8'  
    
DECLARE @FILE16 VARCHAR(MAX),@PATH16 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE16 = @PATH16 + 'NCX_FUNDSECBAL_04' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S16 VARCHAR(MAX)                                
SET @S16 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S16 = @S16 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE16+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S16)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'H8' AND CLTCODE < 'K22'  
    
DECLARE @FILE17 VARCHAR(MAX),@PATH17 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE17 = @PATH17 + 'NCX_FUNDSECBAL_05' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S17 VARCHAR(MAX)                                
SET @S17 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S17 = @S17 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE17+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S17)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'K22' AND CLTCODE < 'M27'  
    
DECLARE @FILE18 VARCHAR(MAX),@PATH18 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE18 = @PATH18 + 'NCX_FUNDSECBAL_06' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S18 VARCHAR(MAX)                                
SET @S18 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S18 = @S18 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE18+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S18)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'M27' AND CLTCODE < 'N6'   
    
DECLARE @FILE19 VARCHAR(MAX),@PATH19 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE19 = @PATH19 + 'NCX_FUNDSECBAL_07' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S19 VARCHAR(MAX)                                
SET @S19 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S19 = @S19 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE19+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S19)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'N6' AND CLTCODE < 'P35'  
    
DECLARE @FILE20 VARCHAR(MAX),@PATH20 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE20 = @PATH20 + 'NCX_FUNDSECBAL_08' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S20 VARCHAR(MAX)                                
SET @S20 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S20 = @S20 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE20+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S20)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'P35'  AND CLTCODE < 'R32'  
    
DECLARE @FILE21 VARCHAR(MAX),@PATH21 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE21 = @PATH21 + 'NCX_FUNDSECBAL_09' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S21 VARCHAR(MAX)                                
SET @S21 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S21 = @S21 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE21+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S21)        
end   
  
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'R32' AND CLTCODE < 'S36'   
    
DECLARE @FILE22 VARCHAR(MAX),@PATH22 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE22 = @PATH22 + 'NCX_FUNDSECBAL_10' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S22 VARCHAR(MAX)                                
SET @S22 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S22 = @S22 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE22+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S22)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S36' AND CLTCODE < 'S69'  
    
DECLARE @FILE23 VARCHAR(MAX),@PATH23 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE23 = @PATH23 + 'NCX_FUNDSECBAL_11' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S23 VARCHAR(MAX)                                
SET @S23 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S23 = @S23 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE23+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S23)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S69' AND CLTCODE < 'UN'  
    
DECLARE @FILE24 VARCHAR(MAX),@PATH24 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE24 = @PATH24 + 'NCX_FUNDSECBAL_12' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S24 VARCHAR(MAX)                                
SET @S24 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S24 = @S24 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE24+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S24)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'UN'  
    
DECLARE @FILE25 VARCHAR(MAX),@PATH25 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE25 = @PATH25 + 'NCX_FUNDSECBAL_13' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S25 VARCHAR(MAX)                                
SET @S25 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S25 = @S25 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE25+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S25)        
end   
   
   
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_REP_FILE_GEN
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[NCDX_REP_FILE_GEN]    
--(@DATE DATETIME,@DATA VARCHAR(20))    
AS     
BEGIN     
   
 --SELECT TOP 3 * FROM NCDX_REPORTING_SUMMARY  
 --SELECT * INTO NCDX_REPORTING_SUMMARY FROM NCX_S_WFIN  
   
   
 TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE < 'A47'  
    
DECLARE @FILE VARCHAR(MAX),@PATH VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE = @PATH + 'NCX_FUNDSECBALDTL_01' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S VARCHAR(MAX)                                
SET @S = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S = @S + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar)  F
ROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'A47' AND PARTY_CODE < 'BB'  
    
DECLARE @FILE1 VARCHAR(MAX),@PATH1 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE1 = @PATH1 + 'NCX_FUNDSECBALDTL_02' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S1 VARCHAR(MAX)                                
SET @S1 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S1 = @S1 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file1+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S1)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'BB' AND PARTY_CODE < 'DE'  
    
DECLARE @FILE2 VARCHAR(MAX),@PATH2 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE2 = @PATH2 + 'NCX_FUNDSECBALDTL_03' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S2 VARCHAR(MAX)                                
SET @S2 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S2 = @S2 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@file2+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S2)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'DE' AND PARTY_CODE < 'H8'  
    
DECLARE @FILE3 VARCHAR(MAX),@PATH3 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE3 = @PATH3 + 'NCX_FUNDSECBALDTL_04' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S3 VARCHAR(MAX)                                
SET @S3 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S3 = @S3 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE3+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S3)  
  
end  
  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'H8' AND PARTY_CODE < 'K22'  
    
DECLARE @FILE4 VARCHAR(MAX),@PATH4 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE4 = @PATH4 + 'NCX_FUNDSECBALDTL_05' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S4 VARCHAR(MAX)                                
SET @S4 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S4 = @S4 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE4+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S4)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'K22' AND PARTY_CODE < 'M27'  
    
DECLARE @FILE5 VARCHAR(MAX),@PATH5 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE5 = @PATH5 + 'NCX_FUNDSECBALDTL_06' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S5 VARCHAR(MAX)                                
SET @S5 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S5 = @S5 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE5+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S5)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'M27' AND PARTY_CODE < 'N6'  
    
DECLARE @FILE6 VARCHAR(MAX),@PATH6 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE6 = @PATH6 + 'NCX_FUNDSECBALDTL_07' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S6 VARCHAR(MAX)                                
SET @S6 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S6 = @S6 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE6+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S6)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'N6'   AND PARTY_CODE < 'P35'  
    
DECLARE @FILE7 VARCHAR(MAX),@PATH7 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE7 = @PATH7 + 'NCX_FUNDSECBALDTL_08' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S7 VARCHAR(MAX)                                
SET @S7 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S7 = @S7 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE7+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S7)  
  
end  
  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'P35'  AND PARTY_CODE < 'R32'  
    
DECLARE @FILE8 VARCHAR(MAX),@PATH8 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE8 = @PATH8 + 'NCX_FUNDSECBALDTL_09' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S8 VARCHAR(MAX)                                
SET @S8 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S8 = @S8 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE8+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S8)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'R32' AND PARTY_CODE < 'S36'   
    
DECLARE @FILE9 VARCHAR(MAX),@PATH9 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE9 = @PATH9 + 'NCX_FUNDSECBALDTL_10' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S9 VARCHAR(MAX)                                
SET @S9 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S9 = @S9 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar) 
 FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE9+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S9)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'S36' AND PARTY_CODE < 'S69'  
    
DECLARE @FILE10 VARCHAR(MAX),@PATH10 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE10 = @PATH10 + 'NCX_FUNDSECBALDTL_11' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S10 VARCHAR(MAX)                                
SET @S10 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S10 = @S10 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE10+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S10)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'S69' AND PARTY_CODE < 'UN'  
    
DECLARE @FILE11 VARCHAR(MAX),@PATH11 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE11 = @PATH11 + 'NCX_FUNDSECBALDTL_12' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S11 VARCHAR(MAX)                                
SET @S11 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S11 = @S11 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE11+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S11)  
  
end  
  
  
TRUNCATE TABLE NCDX_REPORTING_SUMMARY    
BEGIN    
INSERT INTO NCDX_REPORTING_SUMMARY    
select LONG_NAME,PARTY_CODE,PAN_GIR_NO,ISIN,SCRIP,QTY,PLEDGE_QTY,BORROWING from NCX_S_WFIN WHERE PARTY_CODE > 'UN'  
    
DECLARE @FILE12 VARCHAR(MAX),@PATH12 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\SUMMARY\'                         
SET @FILE12 = @PATH12 + 'NCX_FUNDSECBALDTL_13' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S12 VARCHAR(MAX)                                
SET @S12 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''PARTY_CODE'''',''''PAN_GIR_NO'''',''''ISIN'''',''''SCRIP'''',''''QTY'''',''''PLEDGE_QTY'''',''''BORROWING'''''  --Column Name      
  
SET @S12 = @S12 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([PARTY_CODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([ISIN] as varchar),cast([SCRIP] as varchar),cast([QTY] as varchar),cast([PLEDGE_QTY] as varchar),cast([BORROWING] as varchar
)  FROM [PRADNYA].[dbo].[NCDX_REPORTING_SUMMARY]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE12+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S12)  
  
end  
  
--------------------------NCDX  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE < 'A47'  
    
DECLARE @FILE13 VARCHAR(MAX),@PATH13 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE13 = @PATH13 + 'NCX_FUNDSECBAL_01' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S13 VARCHAR(MAX)                                
SET @S13 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S13 = @S13 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE13+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S13)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'A47' AND CLTCODE < 'BB'  
    
DECLARE @FILE14 VARCHAR(MAX),@PATH14 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE14 = @PATH14 + 'NCX_FUNDSECBAL_02' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S14 VARCHAR(MAX)                                
SET @S14 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S14 = @S14 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE14+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S14)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'BB' AND CLTCODE < 'DE'  
    
DECLARE @FILE15 VARCHAR(MAX),@PATH15 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE15 = @PATH15 + 'NCX_FUNDSECBAL_03' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S15 VARCHAR(MAX)                                
SET @S15 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S15 = @S15 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE15+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S15)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'DE' AND CLTCODE < 'H8'  
    
DECLARE @FILE16 VARCHAR(MAX),@PATH16 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE16 = @PATH16 + 'NCX_FUNDSECBAL_04' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S16 VARCHAR(MAX)                                
SET @S16 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S16 = @S16 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE16+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S16)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'H8' AND CLTCODE < 'K22'  
    
DECLARE @FILE17 VARCHAR(MAX),@PATH17 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE17 = @PATH17 + 'NCX_FUNDSECBAL_05' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S17 VARCHAR(MAX)                                
SET @S17 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S17 = @S17 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE17+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S17)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'K22' AND CLTCODE < 'M27'  
    
DECLARE @FILE18 VARCHAR(MAX),@PATH18 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE18 = @PATH18 + 'NCX_FUNDSECBAL_06' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S18 VARCHAR(MAX)                                
SET @S18 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S18 = @S18 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE18+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S18)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE  CLTCODE > 'M27' AND CLTCODE < 'N6'   
    
DECLARE @FILE19 VARCHAR(MAX),@PATH19 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE19 = @PATH19 + 'NCX_FUNDSECBAL_07' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S19 VARCHAR(MAX)                                
SET @S19 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S19 = @S19 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE19+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S19)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'N6' AND CLTCODE < 'P35'  
    
DECLARE @FILE20 VARCHAR(MAX),@PATH20 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE20 = @PATH20 + 'NCX_FUNDSECBAL_08' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S20 VARCHAR(MAX)                                
SET @S20 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S20 = @S20 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE20+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S20)        
end   
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE   CLTCODE > 'P35'  AND CLTCODE < 'R32'  
    
DECLARE @FILE21 VARCHAR(MAX),@PATH21 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE21 = @PATH21 + 'NCX_FUNDSECBAL_09' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S21 VARCHAR(MAX)                                
SET @S21 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S21 = @S21 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE21+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S21)        
end   
  
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'R32' AND CLTCODE < 'S36'   
    
DECLARE @FILE22 VARCHAR(MAX),@PATH22 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE22 = @PATH22 + 'NCX_FUNDSECBAL_10' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S22 VARCHAR(MAX)                                
SET @S22 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S22 = @S22 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE22+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S22)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S36' AND CLTCODE < 'S69'  
    
DECLARE @FILE23 VARCHAR(MAX),@PATH23 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE23 = @PATH23 + 'NCX_FUNDSECBAL_11' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S23 VARCHAR(MAX)                                
SET @S23 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S23 = @S23 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE23+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S23)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'S69' AND CLTCODE < 'UN'  
    
DECLARE @FILE24 VARCHAR(MAX),@PATH24 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE24 = @PATH24 + 'NCX_FUNDSECBAL_12' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S24 VARCHAR(MAX)                                
SET @S24 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S24 = @S24 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE24+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S24)        
end   
  
  
TRUNCATE TABLE NCDX_REPORTING_DETAIL    
BEGIN    
INSERT INTO NCDX_REPORTING_DETAIL    
select LONG_NAME,CLTCODE,PAN_GIR_NO,NCX_BALANCE,NET_AMT,TOTAL_ISIN,TOTA_QTY_SEC,PLD_ISIN,PLEDGE_QTY,BARROWING,CONVERT(DATETIME,SEBI_PAYOUT,104)AS SEBI_PAYOUT,ASD from NCX_C_WFIN WHERE CLTCODE > 'UN'  
    
DECLARE @FILE25 VARCHAR(MAX),@PATH25 VARCHAR(MAX) = 'H:\BackOffice\Automation\REPORTING_DATA\NCDX\DETAIL\'                         
SET @FILE25 = @PATH25 + 'NCX_FUNDSECBAL_13' +'_'+ CONVERT(VARCHAR(11),GETDATE()  , 112) + '.csv' --Folder Name       
DECLARE @S25 VARCHAR(MAX)                                
SET @S25 = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''LONG_NAME'''',''''CLTCODE'''',''''PAN_GIR_NO'''',''''NCX_BALANCE'''',''''NET_AMT'''',''''TOTAL_ISIN'''',''''TOTA_QTY_SEC'''',''''PLD_ISIN'''',''''PLEDGE_QTY'''',''''BARROWING'''',''''SEBI_PAYOUT'''',''''ASD'''''  --Column Name      
  
SET @S25 = @S25 + ' UNION ALL SELECT cast([LONG_NAME] as varchar),cast([CLTCODE] as varchar),cast([PAN_GIR_NO] as varchar),cast([NCX_BALANCE] as varchar),cast([NET_AMT] as varchar),cast([TOTAL_ISIN] as varchar),cast([TOTA_QTY_SEC] as varchar),cast([PLD_ISIN] as varchar),cast([PLEDGE_QTY] as varchar),cast([BARROWING] as varchar), CONVERT (VARCHAR (11),SEBI_PAYOUT,109) as SEBI_PAYOUT,CONVERT (VARCHAR (11),ASD,109) as ASD FROM [PRADNYA].[dbo].[NCDX_REPORTING_DETAIL]    " QUERYOUT ' --Convert data type if required      
      
 +@FILE25+ ' -c -SABVSBSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''       
--       PRINT  (@S)       
EXEC(@S25)        
end   
  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PRDKM_SS_CLMST
-- --------------------------------------------------

Create procedure PRDKM_SS_CLMST
as 
Select * into #t from
(Select Distinct Party_code from tbldkm_sauda_summary_fo
union
Select Distinct Party_code from tbldkm_sauda_summary_cm_1)x

Insert into TBLDKM_SS_CLMST
Select cl_code,Short_name,Branch_cd,SUB_BROKER L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_ZIP,
MOBILE_PAGER,RES_PHONE1,RES_PHONE2,OFF_PHONE1 
from anand1.msajag.dbo.Client_details where cl_code in
(Select * from #t)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.QL_CLIENT_CODES
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[QL_CLIENT_CODES]      
(@DATA VARCHAR(20))    
AS      
BEGIN       
  BEGIN    
  IF @DATA='COUNT'      
  SELECT  ECN_FLAG,COUNT(1) COunt_of_records FROM TMP_QL     
GROUP BY ECN_FLAG    
END    
        
      
  BEGIN    
  IF @DATA='CLIENT'      
TRUNCATE TABLE TM_QL_SSRS      
      
INSERT INTO TM_QL_SSRS      
SELECT  *   FROM TMP_QL WITH(NOLOCK)      
      
---SELECT * FROM TM_QL_SSRS      
      
      
DECLARE @FILE VARCHAR(MAX),@PATH VARCHAR(MAX) = '\\AngelBSECM\backoffice3\AUTOMATION\QL_CLIENT\'                           
SET @FILE = @PATH + 'QL_CLIENT_DATA' +'_'+ CONVERT(VARCHAR(11),GETDATE() , 112) + '.csv' --Folder Name         
DECLARE @S VARCHAR(MAX)                                  
SET @S = 'EXEC MASTER.DBO.XP_CMDSHELL ''BCP "SELECT ''''CLIENTCODE'''',''''L_ZIP'''',''''ECN_FLAG'''''    --Column Name        
SET @S = @S + ' UNION ALL SELECT    cast([CLIENTCODE] as varchar), cast([L_ZIP] as varchar), cast([ECN_FLAG] as varchar) FROM [PRADNYA].[dbo].[TM_QL_SSRS]    " QUERYOUT ' --Convert data type if required        
        
 +@file+ ' -c -SAngelBSECM -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'''         
--       PRINT  (@S)         
EXEC(@S)       
END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETENTIONANEXUREAB
-- --------------------------------------------------
    
    
CREATE PROC [DBO].[RETENTIONANEXUREAB]        
(        
          @FROMPARTY_CODE VARCHAR(10)                   
)     
    
--EXEC [RETENTIONANEXUREAB] 'V189817'               
        
AS                    
          
BEGIN    
 

 SELECT * ,
 -- B= SECVAL_TDAY , G =(CASE WHEN NSE_SECPAYIN_TM1DAY-SECVAL_TDAY >0 THEN  NSE_SECPAYIN_TM1DAY-SECVAL_TDAY ELSE 0 END )   ,E=NSE_SECPAYIN_TDAY,
  ---F=NSE_SECPAYIN_TM1DAY , X=NSE_SECPAYIN_TM1DAY-NSE_SECPAYIN_TDAY ,
 -- T=(CASE WHEN  NSE_SECPAYIN_TM1DAY-NSE_SECPAYIN_TDAY > SECVAL_TDAY THEN  NSE_SECPAYIN_TM1DAY-NSE_SECPAYIN_TDAY - SECVAL_TDAY ELSE 0 END)
  FINAL_TOTAL=NSE_SECPAYIN_TDAY+(CASE WHEN  NSE_SECPAYIN_TM1DAY-NSE_SECPAYIN_TDAY > SECVAL_TDAY THEN  NSE_SECPAYIN_TM1DAY-NSE_SECPAYIN_TDAY - SECVAL_TDAY ELSE 0 END)
  +ACCRUALAMT+OTHERSEGMENTDEBIT
   
FROM (
 SELECT      
 PARTYCODE = A.PARTY_CODE,   --PARTYNAME, --BRANCHCODE,        
 TOT_LEDBAL = UNENCUMBERED_BAL * -1,        
 TOT_MLEDBAL = '0.00',---UNENCUMBERED_MARGIN,        
 SECVAL_TDAY = VALUE_SECURITIESTDAY,        
 TOT_DLEDBAL = FUNDS_RETAINED,       
 VALUE_SECURITIESRETAINED, -- A.OTHERSEGMENTDEBIT,    
 B.UNENCUMBERED_DEBITBAL,       
 NSE_FUNDSPAYIN_TDAY = TDAY_FUNDSPAYIN_NSECM,        
 BSE_FUNDSPAYIN_TDAY = TDAY_FUNDSPAYIN_BSECM,        
 NFO_FUNDSPAYIN_TDAY = TDAY_FUNDSPAYIN_NSEFO,        
 BFO_FUNDSPAYIN_TDAY = 0,        
 NSX_FUNDSPAYIN_TDAY = TDAY_FUNDSPAYIN_NSX,        
 MCD_FUNDSPAYIN_TDAY = TDAY_FUNDSPAYIN_MCD,        
 NSE_FUNDSPAYIN_TM1DAY = T_1DAY_FUNDSPAYIN_NSECM ,        
 BSE_FUNDSPAYIN_TM1DAY = T_1DAY_FUNDSPAYIN_BSECM ,        
 NSE_SECPAYIN_TDAY = [MARGIN50%]*-1,--TDAY_SECURITIESPAYIN_NSECM,        
 BSE_SECPAYIN_TDAY = TDAY_SECURITIESPAYIN_BSECM,        
 NSE_SECPAYIN_TM1DAY = [MARGIN225%]*-1,--T_1DAY_SECURITESPAYIN_NSECM,        
 BSE_SECPAYIN_TM1DAY = T_1DAY_SECURITESPAYIN_BSECM,     
 NFO_MARGINREQ_175P = TDAY_MARGIN_NSEFO,        
 BFO_MARGINREQ_175P = 0,        
 NSX_MARGINREQ_175P = TDAY_MARGIN_NSX,        
 MCD_MARGINREQ_175P = TDAY_MARGIN_MCD,           
 NSE_TURNOVER_TDAY = TDAY_TURNOVER_NSECM,        
 BSE_TURNOVER_TDAY = TDAY_TURNOVER_BSECM,       
 TOT_FUNDSREC = A.FUNDS_RETAINED,      
 TOT_SECREL = A.SECURITIES_RELEASED,       
 FUNDSRELDT = CONVERT(VARCHAR(11), B.UPDATEDON),        
 TOT_FUNDSREL = A.FUNDS_RELEASED,    
 B.OTHERSEGMENTDEBIT,    
 ACCRUALAMT,MCDX_FUNDSPAYIN_TDAY=TDAY_FUNDSPAYIN_MCX,     
 NCDX_FUNDSPAYIN_TDAY=TDAY_FUNDSPAYIN_NCDX,MCX_MARGINREQ_175P=TDAY_MARGIN_MCX ,    
 NCDX_MARGINREQ_175P=TDAY_MARGIN_NCDX,    
 BSE_MARGINREQ_175P=[TDAY_MARGIN_BSECM],    
 NSE_MARGINREQ_175P=[TDAY_MARGIN_NSECM]-- ,,    
 --BSX_MARGINREQ_175P=[TDAY_MARGIN_BSX]    

 FROM  TBL_SCCSANNEXURE_A_TEMP A(NOLOCK) 
  LEFT OUTER JOIN 
 TBL_MARGINDATA T ON A.PARTY_CODE =T.PARTY_CODE
 , TBL_SCCSANNEXURE_B_TEMP B (NOLOCK)      
 WHERE A.PARTY_CODE = B.PARTY_CODE AND A.PARTY_CODE = @FROMPARTY_CODE    
 )A



       
 END       
       
--SELECT TOP 10 * FROM  SCCSANNEXURE_A WHERE PARTY_CODE ='A063'      
      
--SELECT TOP 10 * FROM  SCCSANNEXURE_B WHERE PARTY_CODE ='A063'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETENTIONANEXURECD
-- --------------------------------------------------

CREATE PROC [dbo].[RETENTIONANEXURECD]  
(  
          @FROMPARTY_CODE VARCHAR(10)             
)  
--EXEC  RETENTIONANEXURECD 'A063'           
  
AS              
    
BEGIN
 SELECT 
 PARTY_CODE,
 EXCHANGE = SEGMENT, 	
 SCRIP_CD = SCRIP_NAME, 	
 ISIN, 
 SEC_RET = convert(int,QUANTITY), 	
 SEC_REL = 0, 	
 CL_RATE = CLOSING_RATE, 	
 HAIRCUT, 	
 SEC_RETVALUE = VALUE, 
 SEC_RELVALUE = 0,
 NET_SEC_RETVALUE = VALUE, 	
 NET_SEC_RELVALUE = 0
 FROM TBL_SCCSANNEXURE_C_TEMP 
 WHERE PARTY_CODE = @FROMPARTY_CODE
 
 UNION ALL
 
 SELECT 
 PARTY_CODE,
 EXCHANGE = SEGMENT, 	
 SCRIP_CD = SCRIP_NAME, 	
 ISIN, 
 SEC_RET = 0, 	
 SEC_REL = convert(int,QUANTITY), 	
 CL_RATE = CLOSING_RATE, 	
 HAIRCUT, 	
 SEC_RETVALUE = 0, 
 SEC_RELVALUE = VALUE,
 NET_SEC_RETVALUE = 0, 	
 NET_SEC_RELVALUE = VALUE
 FROM TBL_SCCSANNEXURE_D_TEMP
 WHERE PARTY_CODE = @FROMPARTY_CODE
 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETENTIONANEXUREEF
-- --------------------------------------------------


CREATE PROC [dbo].[RETENTIONANEXUREEF]  
(  
          @FROMPARTY_CODE VARCHAR(10) ,
          @FROMCOLLTYPE VARCHAR(10)                         
)  
--EXEC  RETENTIONANEXUREEF 'D745','FD'           
AS              

BEGIN
SELECT PARTY_CODE = PARTY_CODE,
SEGMENT,
BANK_NAME = BANK_CODE,
BG_NO = FD_BGNO,
BG_AMOUNT = FINALAMOUNT,
MATURITY_DATE = CONVERT(VARCHAR,MATURITY_DATE,103)
FROM TBL_SCCSANNEXURE_E_TEMP WITH (NOLOCK)  
	WHERE PARTY_CODE = @FROMPARTY_CODE AND COll_TYPE = @FROMCOLLTYPE

END 

--

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_DATA
-- --------------------------------------------------
    
CREATE PROCEDURE SCCS_DATA (@SCCS_DATE VARCHAR(50))    
AS    
    
BEGIN    
    
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)    
    
TRUNCATE TABLE TBL_SCCS_DATA_TEMP    
    
INSERT INTO TBL_SCCS_DATA_TEMP    
SELECT * FROM #SCCS (NOLOCK) WHERE SCCS_DATE LIKE @SCCS_DATE + '%'  
    
---    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK) WHERE UPDATEDON LIKE @SCCS_DATE + '%'   
ORDER BY PARTY_CODE    
    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK) WHERE UPDATEDON LIKE @SCCS_DATE + '%'   
ORDER BY PARTY_CODE    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK) WHERE UPDATEDON LIKE @SCCS_DATE + '%'   
ORDER BY PARTY_CODE,SEGMENT    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK) WHERE UPDATEDON LIKE @SCCS_DATE + '%'       
ORDER BY PARTY_CODE,SEGMENT    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK) WHERE UPDATEDON LIKE @SCCS_DATE + '%'   
ORDER BY PARTY_CODE,SEGMENT      
    
DROP TABLE #SCCS    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
    
CREATE PROC SP @SPNAME VARCHAR(25)AS                 
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @SPNAME + '%' AND XTYPE='P' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
----------------------------------------------------------------------------------------------------------------------       
-- http://vyaskn.tripod.com/code.htm#inserts       
------------------------------------------------------------------------------------------------------------------------       
--SET NOCOUNT ON       
--GO       
--       
--PRINT 'Using Master database'       
--USE master       
--GO       
--       
--PRINT 'Checking for the existence of this procedure'       
--IF (SELECT OBJECT_ID('sp_generate_inserts','P')) IS NOT NULL --means, the procedure already exists       
-- BEGIN       
-- PRINT 'Procedure already exists. So, dropping it'       
-- DROP PROC sp_generate_inserts       
-- END       
--GO       
--       
----Turn system object marking on       
--EXEC master.dbo.sp_MS_upd_sysobj_category 1       
--GO       
create PROC [dbo].[sp_generate_inserts]       
(       
@table_name varchar(776), -- The table/view for which the INSERT statements will be generated using the existing data       
@target_table varchar(776) = NULL, -- Use this parameter to specify a different table name into which the data will be inserted       
@include_column_list bit = 1, -- Use this parameter to include/ommit column list in the generated INSERT statement       
@from varchar(800) = NULL, -- Use this parameter to filter the rows based on a filter condition (using WHERE)       
@include_timestamp bit = 0, -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement       
@debug_mode bit = 0, -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination       
@owner varchar(64) = NULL, -- Use this parameter if you are not the owner of the table       
@ommit_images bit = 0, -- Use this parameter to generate INSERT statements by omitting the 'image' columns       
@ommit_identity bit = 0, -- Use this parameter to ommit the identity columns       
@top int = NULL, -- Use this parameter to generate INSERT statements only for the TOP n rows       
@cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement       
@cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement       
@disable_constraints bit = 0, -- When 1, disables foreign key constraints and enables them after the INSERT statements       
@ommit_computed_cols bit = 0 -- When 1, computed columns will not be included in the INSERT statement       
)       
AS       
BEGIN       
/***********************************************************************************************************       
Procedure: sp_generate_inserts (Build 22)       
(Copyright  2002 Narayana Vyas Kondreddi. All rights reserved.)       
Purpose: To generate INSERT statements from existing data.       
These INSERTS can be executed to regenerate the data at some other location.       
This procedure is also useful to create a database setup, where in you can       
script your data along with your table definitions.       
Written by: Narayana Vyas Kondreddi       
http://vyaskn.tripod.com       
Acknowledgements:       
Divya Kalra -- For beta testing       
Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values       
Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables       
Joris Laperre -- For reporting a regression bug in handling text/ntext columns       
Tested on: SQL Server 7.0 and SQL Server 2000       
Date created: January 17th 2001 21:52 GMT       
Date modified: May 1st 2002 19:50 GMT       
Email: vyaskn@hotmail.com       
NOTE: This procedure may not work with tables with too many columns.       
Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types       
Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results       
IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed       
you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts       
like nchar and nvarchar       
Example 1: To generate INSERT statements for table 'titles':       
EXEC sp_generate_inserts 'titles'       
Example 2: To ommit the column list in the INSERT statement: (Column list is included by default)       
IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below,       
to avoid erroneous results       
EXEC sp_generate_inserts 'titles', @include_column_list = 0       
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table:       
EXEC sp_generate_inserts 'titles', 'titlesCopy'       
Example 4: To generate INSERT statements for 'titles' table for only those titles       
which contain the word 'Computer' in them:       
NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter       
EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'"       
Example 5: To specify that you want to include TIMESTAMP column's data as well in the INSERT statement:       
(By default TIMESTAMP column's data is not scripted)       
EXEC sp_generate_inserts 'titles', @include_timestamp = 1       
Example 6: To print the debug information:       
EXEC sp_generate_inserts 'titles', @debug_mode = 1       
Example 7: If you are not the owner of the table, use @owner parameter to specify the owner name       
To use this option, you must have SELECT permissions on that table       
EXEC sp_generate_inserts Nickstable, @owner = 'Nick'       
Example 8: To generate INSERT statements for the rest of the columns excluding images       
When using this otion, DO NOT set @include_column_list parameter to 0.       
EXEC sp_generate_inserts imgtable, @ommit_images = 1       
Example 9: To generate INSERT statements excluding (ommiting) IDENTITY columns:       
(By default IDENTITY columns are included in the INSERT statement)       
EXEC sp_generate_inserts mytable, @ommit_identity = 1       
Example 10: To generate INSERT statements for the TOP 10 rows in the table:       
EXEC sp_generate_inserts mytable, @top = 10       
Example 11: To generate INSERT statements with only those columns you want:       
EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'"       
Example 12: To generate INSERT statements by omitting certain columns:       
EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'"       
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements:       
EXEC sp_generate_inserts titles, @disable_constraints = 1       
Example 14: To exclude computed columns from the INSERT statement:       
EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1       
***********************************************************************************************************/       
SET NOCOUNT ON       
--Making sure user only uses either @cols_to_include or @cols_to_exclude       
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL))       
BEGIN       
RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1)       
RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified       
END       
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format       
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0))       
BEGIN       
RAISERROR('Invalid use of @cols_to_include property',16,1)       
PRINT 'Specify column names surrounded by single quotes and separated by commas'       
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"'       
RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property       
END       
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0))       
BEGIN       
RAISERROR('Invalid use of @cols_to_exclude property',16,1)       
PRINT 'Specify column names surrounded by single quotes and separated by commas'       
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"'       
RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property       
END       
--Checking to see if the database name is specified along wih the table name       
--Your database context should be local to the table for which you want to generate INSERT statements       
--specifying the database name is not allowed       
IF (PARSENAME(@table_name,3)) IS NOT NULL       
BEGIN       
RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1)       
RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed       
END       
--Checking for the existence of 'user table' or 'view'       
--This procedure is not written to work on system tables       
--To script the data in system tables, just create a view on the system tables and script the view instead       
IF @owner IS NULL       
BEGIN       
IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL))       
BEGIN       
RAISERROR('User table or view not found.',16,1)       
PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.'       
PRINT 'Make sure you have SELECT permission on that table or view.'       
RETURN -1 --Failure. Reason: There is no user table or view with this name       
END       
END       
ELSE       
BEGIN       
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner)       
BEGIN       
RAISERROR('User table or view not found.',16,1)       
PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.'       
PRINT 'Make sure you have SELECT permission on that table or view.'       
RETURN -1 --Failure. Reason: There is no user table or view with this name       
END       
END       
--Variable declarations       
DECLARE @Column_ID int,       
@Column_List varchar(8000),       
@Column_Name varchar(128),       
@Start_Insert varchar(786),       
@Data_Type varchar(128),       
@Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements       
@IDN varchar(128) --Will contain the IDENTITY column's name in the table       
--Variable Initialization       
SET @IDN = ''       
SET @Column_ID = 0       
SET @Column_Name = ''       
SET @Column_List = ''       
SET @Actual_Values = ''       
IF @owner IS NULL       
BEGIN       
SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'       
END       
ELSE       
BEGIN       
SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'       
END       
--To get the first column's ID       
SELECT @Column_ID = MIN(ORDINAL_POSITION)       
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)       
WHERE TABLE_NAME = @table_name AND       
(@owner IS NULL OR TABLE_SCHEMA = @owner)       
--Loop through all the columns of the table, to get the column names and their data types       
WHILE @Column_ID IS NOT NULL       
BEGIN       
SELECT @Column_Name = QUOTENAME(COLUMN_NAME),       
@Data_Type = DATA_TYPE       
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)       
WHERE ORDINAL_POSITION = @Column_ID AND       
TABLE_NAME = @table_name AND       
(@owner IS NULL OR TABLE_SCHEMA = @owner)       
IF @cols_to_include IS NOT NULL --Selecting only user specified columns       
BEGIN       
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0       
BEGIN     
GOTO SKIP_LOOP       
END       
END       
IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns       
BEGIN       
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0       
BEGIN       
GOTO SKIP_LOOP       
END       
END       
--Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column       
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1       
BEGIN       
IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column       
SET @IDN = @Column_Name       
ELSE       
GOTO SKIP_LOOP       
END       
--Making sure whether to output computed columns or not       
IF @ommit_computed_cols = 1       
BEGIN       
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1       
BEGIN       
GOTO SKIP_LOOP       
END       
END       
--Tables with columns of IMAGE data type are not supported for obvious reasons       
IF(@Data_Type in ('image'))       
BEGIN       
IF (@ommit_images = 0)       
BEGIN       
RAISERROR('Tables with image columns are not supported.',16,1)       
PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.'       
PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.'       
RETURN -1 --Failure. Reason: There is a column with image data type       
END       
ELSE       
BEGIN       
GOTO SKIP_LOOP       
END       
END       
--Determining the data type of the column and depending on the data type, the VALUES part of       
--the INSERT statement is generated. Care is taken to handle columns with NULL values. Also       
--making sure, not to lose any data from flot, real, money, smallmomey, datetime columns       
SET @Actual_Values = @Actual_Values +       
CASE       
WHEN @Data_Type IN ('char','varchar','nchar','nvarchar')       
THEN       
'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'       
WHEN @Data_Type IN ('datetime','smalldatetime')       
THEN       
'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')'       
WHEN @Data_Type IN ('uniqueidentifier')       
THEN       
'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')'       
WHEN @Data_Type IN ('text','ntext')       
THEN       
'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'       
WHEN @Data_Type IN ('binary','varbinary')       
THEN       
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'       
WHEN @Data_Type IN ('timestamp','rowversion')       
THEN       
CASE       
WHEN @include_timestamp = 0       
THEN       
'''DEFAULT'''       
ELSE       
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'       
END       
WHEN @Data_Type IN ('float','real','money','smallmoney')       
THEN       
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ',2)' + ')),''NULL'')'       
ELSE       
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ')' + ')),''NULL'')'       
END + '+' + ''',''' + ' + '       
--Generating the column list for the INSERT statement       
SET @Column_List = @Column_List + @Column_Name + ','       
SKIP_LOOP: --The label used in GOTO       
SELECT @Column_ID = MIN(ORDINAL_POSITION)       
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)       
WHERE TABLE_NAME = @table_name AND       
ORDINAL_POSITION > @Column_ID AND       
(@owner IS NULL OR TABLE_SCHEMA = @owner)       
--Loop ends here!       
END       
--To get rid of the extra characters that got concatenated during the last run through the loop       
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1)       
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6)       
IF LTRIM(@Column_List) = ''       
BEGIN       
RAISERROR('No columns to select. There should at least be one column to generate the output',16,1)       
RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter       
END       
--Forming the final string that will be executed, to output the INSERT statements       
IF (@include_column_list <> 0)       
BEGIN       
SET @Actual_Values =       
'SELECT ' +       
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +       
'''' + RTRIM(@Start_Insert) +       
' ''+' + '''(' + RTRIM(@Column_List) + '''+' + ''')''' +       
' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' +       
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')       
END       
ELSE IF (@include_column_list = 0)       
BEGIN       
SET @Actual_Values =       
'SELECT ' +       
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +       
'''' + RTRIM(@Start_Insert) +       
' '' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' +       
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')       
END       
--Determining whether to ouput any debug information       
IF @debug_mode =1       
BEGIN       
PRINT '/*****START OF DEBUG INFORMATION*****'       
PRINT 'Beginning of the INSERT statement:'       
PRINT @Start_Insert       
PRINT ''       
PRINT 'The column list:'       
PRINT @Column_List       
PRINT ''       
PRINT 'The SELECT statement executed to generate the INSERTs'       
PRINT @Actual_Values       
PRINT ''       
PRINT '*****END OF DEBUG INFORMATION*****/'       
PRINT ''       
END       
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas'       
PRINT '--Build number: 22'       
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com'       
PRINT '--http://vyaskn.tripod.com'       
PRINT ''       
PRINT 'SET NOCOUNT ON'       
PRINT ''       
--Determining whether to print IDENTITY_INSERT or not       
IF (@IDN <> '')       
BEGIN       
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON'       
PRINT 'GO'       
PRINT ''       
END       
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)       
BEGIN       
IF @owner IS NULL       
BEGIN       
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'       
END       
ELSE       
BEGIN       
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'       
END       
PRINT 'GO'       
END       
PRINT ''       
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + ''''       
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes!       
EXEC (@Actual_Values)       
PRINT 'PRINT ''Done'''       
PRINT ''       
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)       
BEGIN       
IF @owner IS NULL       
BEGIN       
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints'       
END       
ELSE       
BEGIN       
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints'       
END       
PRINT 'GO'       
END       
PRINT ''       
IF (@IDN <> '')       
BEGIN       
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF'       
PRINT 'GO'       
END       
PRINT 'SET NOCOUNT OFF'       
SET NOCOUNT OFF       
RETURN 0 --Success. We are done!       
END       
      
--------------------------------use to generate script      
--sp_generate_inserts 'v2_contract_digital_data'      
      
       
      
----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GET_BILL_DETAILS
-- --------------------------------------------------



CREATE PROC [dbo].[SP_GET_BILL_DETAILS]
(
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(25),
	@SHAREDB VARCHAR(25),
	@ACCDB VARCHAR(25),
	@BILLDT VARCHAR(11),
	@NARRATION VARCHAR(500)
)

AS
DECLARE @@SQL AS VARCHAR(MAX)
/*
	SELECT CNT = COUNT(*) INTO #CHK FROM account.sys.objects WHERE NAME = 'BILLPOSTED' 
	SELECT * FROM ACCOUNT..BILLPOSTED	 
	SELECT * FROM #CHK
*/
CREATE TABLE #CHK( NAME VARCHAR(50))

SET @@SQL = " INSERT INTO #CHK SELECT NAME FROM " + @ACCDB + ".sys.objects WHERE NAME = 'BILLPOSTED' "
PRINT @@SQL
EXEC(@@SQL)

IF (SELECT COUNT(1) FROM #CHK) > 0 
 BEGIN
	SET @@SQL = ""
	SET @@SQL = @@SQL + " SELECT BILLDATE,BP.SETT_NO,BP.SETT_TYPE,PATH = REPORTURL FROM " + @ACCDB +" .DBO.BILLPOSTED BP, ACCOUNT.DBO.PLDETAIL PL "
	SET @@SQL = @@SQL + " WHERE BILLDATE = '" + @BILLDT + "' "
	SET @@SQL = @@SQL + " AND PL.EXCHANGE = '" + @EXCHANGE + "' "
	SET @@SQL = @@SQL + " AND PL.SEGMENT = '" + @SEGMENT + "' "
	SET @@SQL = @@SQL + " AND BP.VTYP = PL.VTYPE "
	SET @@SQL = @@SQL + " AND BP.SETT_TYPE = PL.SETTTYPE AND FLAG = 'Y'"
	PRINT @@SQL
	EXEC(@@SQL)
 END
DROP TABLE #CHK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBL
-- --------------------------------------------------

    
CREATE PROC TBL @TBLNAME VARCHAR(25)AS               
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @TBLNAME + '%' AND XTYPE='U' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Test
-- --------------------------------------------------

CREATE PROC [dbo].[Test]
                                      
---- Test 'H:\backoffice\NSEHOLD.csv'
                                       
@Test_File AS VARCHAR(MAX)                                          
AS                                           
BEGIN                                          
                                          
TRUNCATE TABLE NSEHOLD;                                          
                                          
DECLARE @SQL VARCHAR(2000)                                          
                                          
SET NOCOUNT ON                                          
SET @SQL = 'BULK INSERT NSEHOLD FROM ''' + @Test_File + ''' WITH (FIRSTROW = 0,FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'') '  
EXEC(@SQL)                                          
                                          
                                          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_QL_MISMATCH_MISSING
-- --------------------------------------------------
CREATE Procedure USP_QL_MISMATCH_MISSING  
as  
--==========================================================================================  
---==============[BSECM]--------------------------------------------------------------------  
Set Nocount on  
  
/*---------MISMATCH CLIENT--------------------------------------------*/  
Select z.party_code,segment,x.scrip_cd,Cqty,Dqty,rmqty=y.qty,  
ctype=case   
when z.party_code=y.party_code and x.scrip_cd=y.scrip_cd and Cqty-Dqty=y.qty then 'Match'  
when z.party_code=y.party_code and y.scrip_cd is null then 'Mismatch'   
when z.party_code=y.party_code and x.scrip_cd=y.scrip_cd and Cqty-Dqty<>y.qty then 'MisMatch in Qty'  
else 'Misssing'  
 end into #file1   
--select x.party_code,x.segment,x.scrip_cd,x.Cqty,x.Dqty,z.party_code,y.party_code,y.exchange  
from   
(Select party_code,segment,scrip_cd,Cqty,Dqty from v2_class_QuarterlySecledger with(nolock)
 where reason = 'CLOSING BALANCE' and segment='BSECM')x  
left outer join  
(Select party_code,exchange,scrip_cd,qty=sum(qty) FROM bak_rm_holding31032010 with(nolock) 
where exchange='BSE' and isnull(accno,'')<>''  
group by party_code,exchange,scrip_cd)y  
on x.party_code=y.party_code and replace(x.segment,'CM','')=y.exchange   
and x.scrip_cd=y.scrip_cd  
inner join  
(Select distinct party_code from v2_class_QuarterlySecledger with(nolock)
 where reason = 'CLOSING BALANCE' and segment='BSECM')z  
on x.party_code=z.party_code  
order by party_code,scrip_cd  
  
  
/*-----MISSING*/  
  
Select z.party_code,segment,x.scrip_cd,Cqty,Dqty,rmqty=0,  
ctype=case when y.party_code is NULL then 'MISSING' else 'IGNORE'   
--else 'Missing'  
 end into #file2  
--select x.party_code,x.segment,x.scrip_cd,x.Cqty,x.Dqty,z.party_code,y.party_code,y.exchange  
from   
(Select   party_code,segment,scrip_cd,Cqty,Dqty from v2_class_QuarterlySecledger with(nolock)
 where reason = 'CLOSING BALANCE' and segment='BSECM')x  
left outer join  
(Select  party_code,exchange,scrip_cd,qty=sum(qty) FROM bak_rm_holding31032010 with(nolock)
 where exchange='BSE' and isnull(accno,'')<>''  
group by party_code,exchange,scrip_cd)y  
on x.party_code=y.party_code and replace(x.segment,'CM','')=y.exchange   
--and x.scrip_cd=y.scrip_cd  
inner join  
(Select distinct party_code from v2_class_QuarterlySecledger with(nolock) 
where reason = 'CLOSING BALANCE' and segment='BSECM')z  
on x.party_code=z.party_code  
  
  
--======================================================================================  
---==============[NSECM]--------------------------------------------------------------------  
/*---------MISMATCH CLIENT--------------------------------------------*/  
Select z.party_code,segment,x.scrip_cd,Cqty,Dqty,rmqty=y.qty,  
ctype=case   
when z.party_code=y.party_code and x.scrip_cd=y.scrip_cd and Cqty-Dqty=y.qty then 'Match'  
when z.party_code=y.party_code and y.scrip_cd is null then 'Mismatch'   
when z.party_code=y.party_code and x.scrip_cd=y.scrip_cd and Cqty-Dqty<>y.qty then 'MisMatch in Qty'  
else 'Misssing'  
 end into #file3   
--select x.party_code,x.segment,x.scrip_cd,x.Cqty,x.Dqty,z.party_code,y.party_code,y.exchange  
from   
(Select   party_code,segment,scrip_cd,Cqty,Dqty from v2_class_QuarterlySecledger with(nolock) 
where reason = 'CLOSING BALANCE' and segment='NSECM')x  
left outer join  
(Select  party_code,exchange,DUMMY1 as scrip_cd,qty=sum(qty) FROM bak_rm_holding31032010 with(nolock) 
where exchange='NSE' and isnull(accno,'')<>''  
group by party_code,exchange,DUMMY1)y  
on x.party_code=y.party_code and replace(x.segment,'CM','')=y.exchange   
and x.scrip_cd=y.scrip_cd  
inner join  
(Select distinct party_code from v2_class_QuarterlySecledger with(nolock)
 where reason = 'CLOSING BALANCE' and segment='NSECM')z  
on x.party_code=z.party_code  
order by party_code,scrip_cd  
  
  
/*-----MISSING*/  
  
Select z.party_code,segment,x.scrip_cd,Cqty,Dqty,rmqty=0,  
ctype=case when y.party_code is NULL then 'MISSING' else 'IGNORE'   
--else 'Missing'  
 end into #file4  
--select x.party_code,x.segment,x.scrip_cd,x.Cqty,x.Dqty,z.party_code,y.party_code,y.exchange  
from   
(Select party_code,segment,scrip_cd,Cqty,Dqty from v2_class_QuarterlySecledger with(nolock) 
where reason = 'CLOSING BALANCE' and segment='NSECM')x  
left outer join  
(Select  party_code,exchange,dummy1 as scrip_cd,qty=sum(qty) FROM bak_rm_holding31032010 with(nolock) 
where exchange='NSE' and isnull(accno,'')<>''  
group by party_code,exchange,DUMMY1)y  
on x.party_code=y.party_code and replace(x.segment,'CM','')=y.exchange   
--and x.scrip_cd=y.scrip_cd  
inner join  
(Select distinct party_code from v2_class_QuarterlySecledger with(nolock)
 where reason = 'CLOSING BALANCE' and segment='NSECM')z  
on x.party_code=z.party_code  
  
  
  
  
  
  
Drop table QL_Mismatch  
   
Select * into Ql_Mismatch from #file1 where ctype in ('Mismatch','MisMatch in Qty')  
union all  
Select * from #file2 where ctype='MISSING'  
union all  
Select * from #file3 where ctype in ('Mismatch','MisMatch in Qty')  
union all  
Select * from #file4 where ctype='MISSING'  
  
  
Select * from Ql_Mismatch  
  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER]
(                
 @STARTDT VARCHAR(11),                
 @ENDDT VARCHAR(11),                
 @FROMPARTY VARCHAR(10),                
 @TOPARTY VARCHAR(10)                
)                
                
/*                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                
*/                
                
AS                
                
SET NOCOUNT ON                
                
/*                
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                
(                
 CQL_ID BIGINT IDENTITY(1,1),                
 CQL_SEGMENT VARCHAR(20),                
 CQL_PARTYCODE VARCHAR(10),                
 CQL_VDT VARCHAR(20),                
 CQL_VTYPE VARCHAR(10),                
 CQL_VNO VARCHAR(20),                
 CQL_ACCODE VARCHAR(10),                
 CQL_REMARKS VARCHAR(255),                
 CQL_DDNO VARCHAR(20),                
 CQL_DEBIT MONEY,                
 CQL_CREDIT MONEY,                
 CQL_BALANCE MONEY,                
 CQL_ORDERBY TINYINT,                
 CQL_DT INT,                 
 CQL_ACNAME VARCHAR(100)                
)                
*/                
                
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
                
DECLARE @@SDTCUR DATETIME                
                
                
/* NOW DOING NSECM */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND1.ACCOUNT.DBO.PARAMETER           
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 1,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                 
   INNER JOIN                
   ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM 
	ANAND1.ACCOUNT.DBO.PARAMETER                 
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER               
SELECT                 
 CQL_SEGMENT = 'NSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 2,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = A.ACNAME                
FROM                
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                
 ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
                
                
/* NOW DOING BSECM */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 AngelBSECM.ACCOUNT_AB.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'BSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 3,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                 
   INNER JOIN                
   AngelBSECM.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'BSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 4,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = A.ACNAME                
FROM                
 AngelBSECM.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                
 AngelBSECM.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 AngelBSECM.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
                
/* NOW DOING NSEFO */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELFO.ACCOUNTFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSEFO',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                 
   INNER JOIN                
   ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSEFO',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = A.ACNAME                
FROM                
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                
 ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
                
/*===========================================================================================================*/                
--------------------------------------------------------------------------------------------------------------------      
-- NCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NCDX',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER   
SELECT                 
 CQL_SEGMENT = 'NCDX',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
                
---------------------------------------------------------------------------------------------------------------      
-- MCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,               
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDX',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDX',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
                
---------------------------------------------------------------------------------------------------------------      
-- MCDXCDS      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDXCDS',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDXCDS',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY        
      
      
--------------------------------------------------------------------------------------------------------------      
-- NSECURFO      
      
SELECT                 
 @@SDTCUR = SDTCUR               
FROM                 
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECURFO',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = A.ACNAME                
  FROM                
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
   INNER JOIN                
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND A.CLTCODE >= @FROMPARTY                
   AND A.CLTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSECURFO',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,           
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = A.ACNAME                
FROM                
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
 INNER JOIN                
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND A.CLTCODE >= @FROMPARTY                
 AND A.CLTCODE <= @TOPARTY                
      
-------------------------------------------------------------------------------------------------------------------                                      
/*============================================================================================================*/              
/*                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
SELECT                 
 Q.*,                
 CQL_ADD1 = C.L_ADDRESS1,                
 CQL_ADD2 = C.L_ADDRESS2,                
 CQL_ADD3 = C.L_ADDRESS3,                
 CQL_CITY = C.L_CITY,                
 CQL_ZIP = C.L_ZIP,                
 CQL_PHONE = C.RES_PHONE1,                
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                
FROM                 
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                
 INNER JOIN                
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                
ORDER BY                 
 Q.CQL_PARTYCODE,                
 Q.CQL_ORDERBY,                
 Q.CQL_DT                
    
*/                          
            
DELETE FROM V2_CLASS_QUARTERLYLEDGER            
WHERE CQL_DEBIT = 0            
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_14012013
-- --------------------------------------------------
CREATE PROC V2_PROC_QUARTERLYLEDGER_14012013  
(                  
 @STARTDT VARCHAR(11),                  
 @ENDDT VARCHAR(11),                  
 @FROMPARTY VARCHAR(10),                  
 @TOPARTY VARCHAR(10)                  
)                  
                  
/*                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                  
*/                  
                  
AS                  
                  
SET NOCOUNT ON                  
                  
/*                  
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                  
(                  
 CQL_ID BIGINT IDENTITY(1,1),                  
 CQL_SEGMENT VARCHAR(20),                  
 CQL_PARTYCODE VARCHAR(10),                  
 CQL_VDT VARCHAR(20),                  
 CQL_VTYPE VARCHAR(10),                  
 CQL_VNO VARCHAR(20),                  
 CQL_ACCODE VARCHAR(10),                  
 CQL_REMARKS VARCHAR(255),                  
 CQL_DDNO VARCHAR(20),                  
 CQL_DEBIT MONEY,                  
 CQL_CREDIT MONEY,                  
 CQL_BALANCE MONEY,                  
 CQL_ORDERBY TINYINT,                  
 CQL_DT INT,                   
 CQL_ACNAME VARCHAR(100)                  
)                  
*/                  
                  
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                  
                  
DECLARE @@SDTCUR DATETIME                  
                  
                  
/* NOW DOING NSECM */                  
                  
                  
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANAND1.ACCOUNT.DBO.PARAMETER             
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'NSECM',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 1,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                   
   INNER JOIN                  
   ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                   CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
                  
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM   
 ANAND1.ACCOUNT.DBO.PARAMETER                   
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                 
SELECT                   
 CQL_SEGMENT = 'NSECM',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 2,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME = A.ACNAME                  
FROM                  
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                   
 INNER JOIN                  
 ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
                  
                  
/* NOW DOING BSECM */                  
                  
                  
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANAND.ACCOUNT_AB.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'BSECM',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 3,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                   
   INNER JOIN                  
   ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X               
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT = 'BSECM',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 4,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME = A.ACNAME                  
FROM                  
 ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                   
 INNER JOIN                  
 ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
                  
/* NOW DOING NSEFO */                  
                  
                  
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'NSEFO',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 5,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                   
   INNER JOIN                  
   ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT = 'NSEFO',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 6,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME  = A.ACNAME                  
FROM                  
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                   
 INNER JOIN                  
 ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
                  
/*===========================================================================================================*/                  
--------------------------------------------------------------------------------------------------------------------        
-- NCDX        
        
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'NCDX',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 5,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                    
   INNER JOIN                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER     
SELECT                   
 CQL_SEGMENT = 'NCDX',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 6,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME  = A.ACNAME                  
FROM                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                    
 INNER JOIN                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
                  
---------------------------------------------------------------------------------------------------------------        
-- MCDX        
        
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                 
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'MCDX',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 5,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                    
   INNER JOIN                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT = 'MCDX',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 6,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME  = A.ACNAME                  
FROM                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                    
 INNER JOIN                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
                  
---------------------------------------------------------------------------------------------------------------        
-- MCDXCDS        
        
SELECT                   
 @@SDTCUR = SDTCUR                   
FROM                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'MCDXCDS',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 5,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                    
   INNER JOIN                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT = 'MCDXCDS',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                  
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 6,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME  = A.ACNAME                  
FROM                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                    
 INNER JOIN                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY          
        
        
--------------------------------------------------------------------------------------------------------------        
-- NSECURFO        
        
SELECT                   
 @@SDTCUR = SDTCUR                 
FROM                   
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                 
WHERE                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                  
 SUM(CQL_BALANCE),                  
 CQL_ORDERBY,                  
 19000101,                  
 CQL_ACNAME                  
FROM                   
 (                  
  SELECT                   
   CQL_SEGMENT = 'NSECURFO',                   
   CQL_PARTYCODE = L.CLTCODE,                  
   CQL_VDT = '',                  
   CQL_VTYPE = '',                  
   CQL_VNO = '',                  
   CQL_ACCODE = '',                  
   CQL_REMARKS = 'OPENING BALANCE',                  
   CQL_DDNO = '',                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
   CQL_ORDERBY = 5,                  
   CQL_ACNAME = A.ACNAME                  
  FROM                  
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                    
   INNER JOIN                  
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
  WHERE                   
   L.VDT >= @@SDTCUR                  
   AND L.VDT < @STARTDT                  
   AND A.CLTCODE >= @FROMPARTY                  
   AND A.CLTCODE <= @TOPARTY                  
 ) X                  
GROUP BY                  
 CQL_SEGMENT,                  
 CQL_PARTYCODE,                  
 CQL_VDT,                  
 CQL_VTYPE,                  
 CQL_VNO,                  
 CQL_ACCODE,                  
 CQL_REMARKS,                  
 CQL_DDNO,                  
 CQL_ORDERBY,                  
 CQL_ACNAME                  
                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                   
 CQL_SEGMENT = 'NSECURFO',                   
 CQL_PARTYCODE = L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,             
 CQL_ACCODE = '',                  
 CQL_REMARKS = L.NARRATION,                  
 CQL_DDNO = '',                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                  
 CQL_ORDERBY = 6,                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                  
 CQL_ACNAME  = A.ACNAME                  
FROM                  
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                    
 INNER JOIN                  
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                  
 LEFT OUTER JOIN                   
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                  
WHERE                   
 L.VDT >=  @STARTDT                  
 AND L.VDT <= @ENDDT + ' 23:59:59'                  
 AND A.CLTCODE >= @FROMPARTY                  
 AND A.CLTCODE <= @TOPARTY                  
        
-------------------------------------------------------------------------------------------------------------------                                        
/*============================================================================================================*/                
/*                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
SELECT                   
 Q.*,                  
 CQL_ADD1 = C.L_ADDRESS1,                  
 CQL_ADD2 = C.L_ADDRESS2,                  
 CQL_ADD3 = C.L_ADDRESS3,                  
 CQL_CITY = C.L_CITY,                  
 CQL_ZIP = C.L_ZIP,                  
 CQL_PHONE = C.RES_PHONE1,                  
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                  
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                  
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                  
FROM                   
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                  
 INNER JOIN                  
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                  
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                  
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                  
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                  
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                  
ORDER BY                   
 Q.CQL_PARTYCODE,                  
 Q.CQL_ORDERBY,                  
 Q.CQL_DT                  
      
*/                            
              
DELETE FROM V2_CLASS_QUARTERLYLEDGER              
WHERE CQL_DEBIT = 0              
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_21042011
-- --------------------------------------------------

CREATE PROC V2_PROC_QUARTERLYLEDGER_21042011            
(            
 @STARTDT VARCHAR(11),            
 @ENDDT VARCHAR(11),            
 @FROMPARTY VARCHAR(10),            
 @TOPARTY VARCHAR(10)            
)            
            
/*            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'            
*/            
            
AS            
            
SET NOCOUNT ON            
            
/*            
CREATE TABLE V2_CLASS_QUARTERLYLEDGER            
(            
 CQL_ID BIGINT IDENTITY(1,1),            
 CQL_SEGMENT VARCHAR(20),            
 CQL_PARTYCODE VARCHAR(10),            
 CQL_VDT VARCHAR(20),            
 CQL_VTYPE VARCHAR(10),            
 CQL_VNO VARCHAR(20),            
 CQL_ACCODE VARCHAR(10),            
 CQL_REMARKS VARCHAR(255),            
 CQL_DDNO VARCHAR(20),            
 CQL_DEBIT MONEY,            
 CQL_CREDIT MONEY,            
 CQL_BALANCE MONEY,            
 CQL_ORDERBY TINYINT,            
 CQL_DT INT,             
 CQL_ACNAME VARCHAR(100)            
)            
*/            
            
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER            
            
DECLARE @@SDTCUR DATETIME            
            
            
/* NOW DOING NSECM */            
            
            
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANAND1.ACCOUNT.DBO.PARAMETER       
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'NSECM',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 1,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)             
   INNER JOIN            
   ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
            
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANAND1.ACCOUNT.DBO.PARAMETER             
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER           
SELECT             
 CQL_SEGMENT = 'NSECM',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 2,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME = A.ACNAME            
FROM            
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)             
 INNER JOIN            
 ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
            
            
/* NOW DOING BSECM */            
            
            
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANAND.ACCOUNT_AB.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'BSECM',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 3,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)             
   INNER JOIN            
   ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'BSECM',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 4,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME = A.ACNAME            
FROM            
 ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)             
 INNER JOIN            
 ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
            
/* NOW DOING NSEFO */            
            
            
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'NSEFO',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 5,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)             
   INNER JOIN            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'NSEFO',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 6,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME  = A.ACNAME            
FROM            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)             
 INNER JOIN            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
            
/*===========================================================================================================*/            
--------------------------------------------------------------------------------------------------------------------  
-- NCDX  
  
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'NCDX',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 5,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L              
   INNER JOIN            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'NCDX',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 6,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME  = A.ACNAME            
FROM            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L              
 INNER JOIN            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
            
---------------------------------------------------------------------------------------------------------------  
-- MCDX  
  
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,           
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'MCDX',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 5,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L              
   INNER JOIN            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'MCDX',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 6,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME  = A.ACNAME            
FROM            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L              
 INNER JOIN            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
            
---------------------------------------------------------------------------------------------------------------  
-- MCDXCDS  
  
SELECT             
 @@SDTCUR = SDTCUR             
FROM             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'MCDXCDS',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 5,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L              
   INNER JOIN            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'MCDXCDS',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 6,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME  = A.ACNAME            
FROM            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L              
 INNER JOIN            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY    
  
  
--------------------------------------------------------------------------------------------------------------  
-- NSECURFO  
  
SELECT             
 @@SDTCUR = SDTCUR           
FROM             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER           
WHERE            
 @STARTDT BETWEEN SDTCUR AND LDTCUR            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),            
 SUM(CQL_BALANCE),            
 CQL_ORDERBY,            
 19000101,            
 CQL_ACNAME            
FROM             
 (            
  SELECT             
   CQL_SEGMENT = 'NSECURFO',             
   CQL_PARTYCODE = L.CLTCODE,            
   CQL_VDT = '',            
   CQL_VTYPE = '',            
   CQL_VNO = '',            
   CQL_ACCODE = '',            
   CQL_REMARKS = 'OPENING BALANCE',            
   CQL_DDNO = '',            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
   CQL_ORDERBY = 5,            
   CQL_ACNAME = A.ACNAME            
  FROM            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L              
   INNER JOIN            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
  WHERE             
   L.VDT >= @@SDTCUR            
   AND L.VDT < @STARTDT            
   AND A.CLTCODE >= @FROMPARTY            
   AND A.CLTCODE <= @TOPARTY            
 ) X            
GROUP BY            
 CQL_SEGMENT,            
 CQL_PARTYCODE,            
 CQL_VDT,            
 CQL_VTYPE,            
 CQL_VNO,            
 CQL_ACCODE,            
 CQL_REMARKS,            
 CQL_DDNO,            
 CQL_ORDERBY,            
 CQL_ACNAME            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYLEDGER            
SELECT             
 CQL_SEGMENT = 'NSECURFO',             
 CQL_PARTYCODE = L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,            
 CQL_ACCODE = '',            
 CQL_REMARKS = L.NARRATION,            
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),            
 CQL_ORDERBY = 6,            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),            
 CQL_ACNAME  = A.ACNAME            
FROM            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L              
 INNER JOIN            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A  ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))            
 LEFT OUTER JOIN             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)            
WHERE             
 L.VDT >=  @STARTDT            
 AND L.VDT <= @ENDDT + ' 23:59:59'            
 AND A.CLTCODE >= @FROMPARTY            
 AND A.CLTCODE <= @TOPARTY            
  
-------------------------------------------------------------------------------------------------------------------                                  
/*============================================================================================================*/          
/*            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT             
 Q.*,            
 CQL_ADD1 = C.L_ADDRESS1,            
 CQL_ADD2 = C.L_ADDRESS2,            
 CQL_ADD3 = C.L_ADDRESS3,            
 CQL_CITY = C.L_CITY,            
 CQL_ZIP = C.L_ZIP,            
 CQL_PHONE = C.RES_PHONE1,            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'            
FROM             
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)            
 INNER JOIN            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)            
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)            
ORDER BY             
 Q.CQL_PARTYCODE,            
 Q.CQL_ORDERBY,            
 Q.CQL_DT            

*/                      
        
DELETE FROM V2_CLASS_QUARTERLYLEDGER        
WHERE CQL_DEBIT = 0        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_A23954
-- --------------------------------------------------
CREATE PROC V2_PROC_QUARTERLYLEDGER_A23954
(                
 @STARTDT VARCHAR(11),                
 @ENDDT VARCHAR(11),                
 @FROMPARTY VARCHAR(10),                
 @TOPARTY VARCHAR(10)                
)                
                
/*                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                
*/                
                
AS                
                
SET NOCOUNT ON                
                
/*                
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                
(                
 CQL_ID BIGINT IDENTITY(1,1),                
 CQL_SEGMENT VARCHAR(20),                
 CQL_PARTYCODE VARCHAR(10),                
 CQL_VDT VARCHAR(20),                
 CQL_VTYPE VARCHAR(10),                
 CQL_VNO VARCHAR(20),                
 CQL_ACCODE VARCHAR(10),                
 CQL_REMARKS VARCHAR(255),                
 CQL_DDNO VARCHAR(20),                
 CQL_DEBIT MONEY,                
 CQL_CREDIT MONEY,                
 CQL_BALANCE MONEY,                
 CQL_ORDERBY TINYINT,                
 CQL_DT INT,                 
 CQL_ACNAME VARCHAR(100)                
)                
*/                
                
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
                
DECLARE @@SDTCUR DATETIME                
                
                
/* NOW DOING NSECM */                
  
CREATE TABLE #ACMAST  
(CLTCODE VARCHAR(10))  
  
CREATE CLUSTERED INDEX IDXCL ON #ACMAST(CLTCODE)  
  
INSERT INTO #ACMAST  
SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS  
WHERE PARTY_CODE >= @FROMPARTY AND PARTY_CODE <= @TOPARTY  
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 BSEDB_AB.DBO.NSE_PARAMETER           
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 1,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   BSEDB_AB.DBO.A23954_NSE_LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 BSEDB_AB.DBO.NSE_PARAMETER                 
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER               
SELECT                 
 CQL_SEGMENT = 'NSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 2,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = L.ACNAME                
FROM                
 BSEDB_AB.DBO.A23954_NSE_LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
                
/* NOW DOING BSECM */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
BSEDB_AB.DBO.BSE_PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'BSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 3,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   BSEDB_AB.DBO.A23954_BSE_LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'BSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 4,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = L.ACNAME                
FROM                
 BSEDB_AB.DBO.A23954_BSE_LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
/* NOW DOING NSEFO */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 BSEDB_AB.DBO.FO_PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSEFO',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   BSEDB_AB.DBO.A23954_FO_LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSEFO',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 BSEDB_AB.DBO.A23954_FO_LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
--/*===========================================================================================================*/                
----------------------------------------------------------------------------------------------------------------------      
---- NCDX      
      
--SELECT                 
-- @@SDTCUR = SDTCUR                 
--FROM                 
-- ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER               
--WHERE                
-- @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
-- SUM(CQL_BALANCE),                
-- CQL_ORDERBY,                
-- 19000101,                
-- CQL_ACNAME                
--FROM                 
-- (                
--  SELECT                 
--   CQL_SEGMENT = 'NCDX',                 
--   CQL_PARTYCODE = L.CLTCODE,                
--   CQL_VDT = '',                
--   CQL_VTYPE = '',                
--   CQL_VNO = '',                
--   CQL_ACCODE = '',                
--   CQL_REMARKS = 'OPENING BALANCE',                
--   CQL_DDNO = '',                
--   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
--   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
--   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
--   CQL_ORDERBY = 5,                
--   CQL_ACNAME = L.ACNAME                
--  FROM                
--   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
--  WHERE                 
--   L.VDT >= @@SDTCUR                
--   AND L.VDT < @STARTDT                
--   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
-- ) X                
--GROUP BY                
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_ORDERBY,                
-- CQL_ACNAME                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT = 'NCDX',                 
-- CQL_PARTYCODE = L.CLTCODE,                
-- CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
-- CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
-- CQL_VNO = L.VNO,                
-- CQL_ACCODE = '',                
-- CQL_REMARKS = L.NARRATION,                
-- CQL_DDNO = '',                
-- CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
-- CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
-- CQL_ORDERBY = 6,                
-- CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
-- CQL_ACNAME  = L.ACNAME                
--FROM                
-- ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
-- INNER JOIN                 
-- ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
--WHERE                 
-- L.VDT >=  @STARTDT                
-- AND L.VDT <= @ENDDT + ' 23:59:59'                
-- AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
-----------------------------------------------------------------------------------------------------------------      
---- MCDX      
      
--SELECT                 
-- @@SDTCUR = SDTCUR                 
--FROM                 
-- ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER               
--WHERE                
-- @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,               
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
-- SUM(CQL_BALANCE),                
-- CQL_ORDERBY,                
-- 19000101,                
-- CQL_ACNAME                
--FROM                 
-- (                
--  SELECT                 
--   CQL_SEGMENT = 'MCDX',                 
--   CQL_PARTYCODE = L.CLTCODE,                
--   CQL_VDT = '',                
--   CQL_VTYPE = '',                
--   CQL_VNO = '',                
--   CQL_ACCODE = '',                
--   CQL_REMARKS = 'OPENING BALANCE',                
--   CQL_DDNO = '',                
--   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
--   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
--   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
--   CQL_ORDERBY = 5,                
--   CQL_ACNAME = L.ACNAME                
--  FROM                
--   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
--  WHERE                 
--   L.VDT >= @@SDTCUR                
--   AND L.VDT < @STARTDT                
--   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)             
-- ) X                
--GROUP BY                
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_ORDERBY,                
-- CQL_ACNAME                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT = 'MCDX',                 
-- CQL_PARTYCODE = L.CLTCODE,                
-- CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
-- CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
-- CQL_VNO = L.VNO,                
-- CQL_ACCODE = '',                
-- CQL_REMARKS = L.NARRATION,                
-- CQL_DDNO = '',                
-- CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
-- CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
-- CQL_ORDERBY = 6,                
-- CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
-- CQL_ACNAME  = L.ACNAME                
--FROM                
-- ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
-- INNER JOIN                 
-- ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
--WHERE                 
-- L.VDT >=  @STARTDT                
-- AND L.VDT <= @ENDDT + ' 23:59:59'                
-- AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
-----------------------------------------------------------------------------------------------------------------      
---- MCDXCDS      
      
--SELECT                 
-- @@SDTCUR = SDTCUR                 
--FROM                 
-- ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER               
--WHERE                
-- @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
-- SUM(CQL_BALANCE),                
-- CQL_ORDERBY,                
-- 19000101,                
-- CQL_ACNAME                
--FROM                 
-- (                
--  SELECT                 
--   CQL_SEGMENT = 'MCDXCDS',                 
--   CQL_PARTYCODE = L.CLTCODE,                
--   CQL_VDT = '',                
--   CQL_VTYPE = '',                
--   CQL_VNO = '',                
--   CQL_ACCODE = '',                
--   CQL_REMARKS = 'OPENING BALANCE',                
--   CQL_DDNO = '',                
--   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
--   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
--   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
--   CQL_ORDERBY = 5,                
--   CQL_ACNAME = L.ACNAME                
--  FROM                
--   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
--  WHERE                 
--   L.VDT >= @@SDTCUR                
--   AND L.VDT < @STARTDT                
--   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
-- ) X                
--GROUP BY                
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_ORDERBY,                
-- CQL_ACNAME                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT = 'MCDXCDS',                 
-- CQL_PARTYCODE = L.CLTCODE,                
-- CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
-- CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
-- CQL_VNO = L.VNO,                
-- CQL_ACCODE = '',                
-- CQL_REMARKS = L.NARRATION,                
-- CQL_DDNO = '',                
-- CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
-- CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
-- CQL_ORDERBY = 6,                
-- CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
-- CQL_ACNAME  = L.ACNAME                
--FROM                
-- ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
-- INNER JOIN                 
-- ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
--WHERE                 
-- L.VDT >=  @STARTDT                
-- AND L.VDT <= @ENDDT + ' 23:59:59'                
-- AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
      
      
----------------------------------------------------------------------------------------------------------------      
---- NSECURFO      
      
--SELECT                 
-- @@SDTCUR = SDTCUR               
--FROM                 
-- ANGELFO.ACCOUNTCURFO.DBO.PARAMETER               
--WHERE                
-- @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
-- SUM(CQL_BALANCE),                
-- CQL_ORDERBY,                
-- 19000101,                
-- CQL_ACNAME                
--FROM                 
-- (                
--  SELECT                 
--   CQL_SEGMENT = 'NSECURFO',                 
--   CQL_PARTYCODE = L.CLTCODE,                
--   CQL_VDT = '',                
--   CQL_VTYPE = '',                
--   CQL_VNO = '',                
--   CQL_ACCODE = '',                
--   CQL_REMARKS = 'OPENING BALANCE',                
--   CQL_DDNO = '',                
--   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
--   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
--   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
--   CQL_ORDERBY = 5,                
--   CQL_ACNAME = L.ACNAME                
--  FROM                
--   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
--  WHERE                 
--   L.VDT >= @@SDTCUR                
--   AND L.VDT < @STARTDT                
--   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)            
-- ) X                
--GROUP BY                
-- CQL_SEGMENT,                
-- CQL_PARTYCODE,                
-- CQL_VDT,                
-- CQL_VTYPE,                
-- CQL_VNO,                
-- CQL_ACCODE,                
-- CQL_REMARKS,                
-- CQL_DDNO,                
-- CQL_ORDERBY,                
-- CQL_ACNAME                
                
                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                
--SELECT                 
-- CQL_SEGMENT = 'NSECURFO',                 
-- CQL_PARTYCODE = L.CLTCODE,                
-- CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
-- CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
-- CQL_VNO = L.VNO,                
-- CQL_ACCODE = '',                
-- CQL_REMARKS = L.NARRATION,                
-- CQL_DDNO = '',                
-- CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
-- CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
-- CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
-- CQL_ORDERBY = 6,                
-- CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
-- CQL_ACNAME  = L.ACNAME                
--FROM                
-- ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
-- INNER JOIN                 
-- ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
--WHERE                 
-- L.VDT >=  @STARTDT                
-- AND L.VDT <= @ENDDT + ' 23:59:59'                
-- AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
      
---------------------------------------------------------------------------------------------------------------------                                      
--/*============================================================================================================*/              
--/*                
--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
--SELECT                 
-- Q.*,                
-- CQL_ADD1 = C.L_ADDRESS1,                
-- CQL_ADD2 = C.L_ADDRESS2,                
-- CQL_ADD3 = C.L_ADDRESS3,                
-- CQL_CITY = C.L_CITY,                
-- CQL_ZIP = C.L_ZIP,                
-- CQL_PHONE = C.RES_PHONE1,                
-- CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                
-- CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                
-- CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                
--FROM                 
-- V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                
-- INNER JOIN                
--  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                
--  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                
--  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                
--  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                
-- ON (Q.CQL_PARTYCODE = C.CL_CODE)                
--ORDER BY                 
-- Q.CQL_PARTYCODE,                
-- Q.CQL_ORDERBY,                
-- Q.CQL_DT                
    
--*/                          
            
DELETE FROM V2_CLASS_QUARTERLYLEDGER            
WHERE CQL_DEBIT = 0            
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_BAK
-- --------------------------------------------------
CREATE PROC V2_PROC_QUARTERLYLEDGER_BAK         
(          
 @STARTDT VARCHAR(11),          
 @ENDDT VARCHAR(11),          
 @FROMPARTY VARCHAR(10),          
 @TOPARTY VARCHAR(10)          
)          
          
/*          
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'          
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'          
*/          
          
AS          
          
SET NOCOUNT ON          
          
/*          
CREATE TABLE V2_CLASS_QUARTERLYLEDGER          
(          
 CQL_ID BIGINT IDENTITY(1,1),          
 CQL_SEGMENT VARCHAR(20),          
 CQL_PARTYCODE VARCHAR(10),          
 CQL_VDT VARCHAR(20),          
 CQL_VTYPE VARCHAR(10),          
 CQL_VNO VARCHAR(20),          
 CQL_ACCODE VARCHAR(10),          
 CQL_REMARKS VARCHAR(255),          
 CQL_DDNO VARCHAR(20),          
 CQL_DEBIT MONEY,          
 CQL_CREDIT MONEY,          
 CQL_BALANCE MONEY,          
 CQL_ORDERBY TINYINT,          
 CQL_DT INT,           
 CQL_ACNAME VARCHAR(100)          
)          
*/          
          
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER          
          
DECLARE @@SDTCUR DATETIME          
          
          
/* NOW DOING NSECM */          
          
          
SELECT           
 @@SDTCUR = SDTCUR           
FROM           
 ANAND1.ACCOUNT.DBO.PARAMETER     
WHERE          
 @STARTDT BETWEEN SDTCUR AND LDTCUR          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),          
 SUM(CQL_BALANCE),          
 CQL_ORDERBY,          
 19000101,          
 CQL_ACNAME          
FROM           
 (          
  SELECT           
   CQL_SEGMENT = 'NSECM',           
   CQL_PARTYCODE = L.CLTCODE,          
   CQL_VDT = '',          
   CQL_VTYPE = '',          
   CQL_VNO = '',          
   CQL_ACCODE = '',          
   CQL_REMARKS = 'OPENING BALANCE',          
   CQL_DDNO = '',          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
   CQL_ORDERBY = 1,          
   CQL_ACNAME = A.ACNAME          
  FROM          
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)           
   INNER JOIN          
   ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
  WHERE           
   L.VDT >= @@SDTCUR          
   AND L.VDT < @STARTDT          
   AND A.CLTCODE >= @FROMPARTY          
   AND A.CLTCODE <= @TOPARTY          
 ) X          
GROUP BY          
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_ORDERBY,          
 CQL_ACNAME          
          
          
          
SELECT           
 @@SDTCUR = SDTCUR           
FROM           
 ANAND1.ACCOUNT.DBO.PARAMETER           
WHERE          
 @STARTDT BETWEEN SDTCUR AND LDTCUR          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT = 'NSECM',           
 CQL_PARTYCODE = L.CLTCODE,          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),          
 CQL_VNO = L.VNO,          
 CQL_ACCODE = '',          
 CQL_REMARKS = L.NARRATION,          
 CQL_DDNO = '',          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
 CQL_ORDERBY = 2,          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),          
 CQL_ACNAME = A.ACNAME          
FROM          
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)           
 INNER JOIN          
 ANAND1.ACCOUNT.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
 LEFT OUTER JOIN           
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)          
WHERE           
 L.VDT >=  @STARTDT          
 AND L.VDT <= @ENDDT + ' 23:59:59'          
 AND A.CLTCODE >= @FROMPARTY          
 AND A.CLTCODE <= @TOPARTY          
          
          
/* NOW DOING BSECM */          
          
          
SELECT           
 @@SDTCUR = SDTCUR           
FROM           
 ANAND.ACCOUNT_AB.DBO.PARAMETER         
WHERE          
 @STARTDT BETWEEN SDTCUR AND LDTCUR          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),          
 SUM(CQL_BALANCE),          
 CQL_ORDERBY,          
 19000101,          
 CQL_ACNAME          
FROM           
 (          
  SELECT           
   CQL_SEGMENT = 'BSECM',           
   CQL_PARTYCODE = L.CLTCODE,          
   CQL_VDT = '',          
   CQL_VTYPE = '',          
   CQL_VNO = '',          
   CQL_ACCODE = '',          
   CQL_REMARKS = 'OPENING BALANCE',          
   CQL_DDNO = '',          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
   CQL_ORDERBY = 3,          
   CQL_ACNAME = A.ACNAME          
  FROM          
   ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)           
   INNER JOIN          
   ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
  WHERE           
   L.VDT >= @@SDTCUR          
   AND L.VDT < @STARTDT          
   AND A.CLTCODE >= @FROMPARTY          
   AND A.CLTCODE <= @TOPARTY          
 ) X          
GROUP BY          
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_ORDERBY,          
 CQL_ACNAME          
          
          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT = 'BSECM',           
 CQL_PARTYCODE = L.CLTCODE,          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),          
 CQL_VNO = L.VNO,          
 CQL_ACCODE = '',          
 CQL_REMARKS = L.NARRATION,          
 CQL_DDNO = '',          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
 CQL_ORDERBY = 4,          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),          
 CQL_ACNAME = A.ACNAME          
FROM          
 ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)           
 INNER JOIN          
 ANAND.ACCOUNT_AB.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
 LEFT OUTER JOIN           
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)          
WHERE           
 L.VDT >=  @STARTDT          
 AND L.VDT <= @ENDDT + ' 23:59:59'          
 AND A.CLTCODE >= @FROMPARTY          
 AND A.CLTCODE <= @TOPARTY          
          
/* NOW DOING NSEFO */          
          
          
SELECT           
 @@SDTCUR = SDTCUR           
FROM           
 ANGELFO.ACCOUNTFO.DBO.PARAMETER         
WHERE          
 @STARTDT BETWEEN SDTCUR AND LDTCUR          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),          
 SUM(CQL_BALANCE),          
 CQL_ORDERBY,          
 19000101,          
 CQL_ACNAME          
FROM           
 (          
  SELECT           
   CQL_SEGMENT = 'NSEFO',           
   CQL_PARTYCODE = L.CLTCODE,          
   CQL_VDT = '',          
   CQL_VTYPE = '',          
   CQL_VNO = '',          
   CQL_ACCODE = '',          
   CQL_REMARKS = 'OPENING BALANCE',          
   CQL_DDNO = '',          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
   CQL_ORDERBY = 5,          
   CQL_ACNAME = A.ACNAME          
  FROM          
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)           
   INNER JOIN          
   ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
  WHERE           
   L.VDT >= @@SDTCUR          
   AND L.VDT < @STARTDT          
   AND A.CLTCODE >= @FROMPARTY          
   AND A.CLTCODE <= @TOPARTY          
 ) X          
GROUP BY          
 CQL_SEGMENT,          
 CQL_PARTYCODE,          
 CQL_VDT,          
 CQL_VTYPE,          
 CQL_VNO,          
 CQL_ACCODE,          
 CQL_REMARKS,          
 CQL_DDNO,          
 CQL_ORDERBY,          
 CQL_ACNAME          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
INSERT INTO V2_CLASS_QUARTERLYLEDGER          
SELECT           
 CQL_SEGMENT = 'NSEFO',           
 CQL_PARTYCODE = L.CLTCODE,          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),          
 CQL_VNO = L.VNO,          
 CQL_ACCODE = '',          
 CQL_REMARKS = L.NARRATION,          
 CQL_DDNO = '',          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),          
 CQL_ORDERBY = 6,          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),          
 CQL_ACNAME  = A.ACNAME          
FROM          
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)           
 INNER JOIN          
 ANGELFO.ACCOUNTFO.DBO.ACMAST A (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))          
 LEFT OUTER JOIN           
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)          
WHERE           
 L.VDT >=  @STARTDT          
 AND L.VDT <= @ENDDT + ' 23:59:59'          
 AND A.CLTCODE >= @FROMPARTY          
 AND A.CLTCODE <= @TOPARTY          
          
          
          
/*          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
SELECT           
 Q.*,          
 CQL_ADD1 = C.L_ADDRESS1,          
 CQL_ADD2 = C.L_ADDRESS2,          
 CQL_ADD3 = C.L_ADDRESS3,          
 CQL_CITY = C.L_CITY,          
 CQL_ZIP = C.L_ZIP,          
 CQL_PHONE = C.RES_PHONE1,          
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',          
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',          
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'          
FROM           
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)          
 INNER JOIN          
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)          
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)          
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)          
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)          
 ON (Q.CQL_PARTYCODE = C.CL_CODE)          
ORDER BY           
 Q.CQL_PARTYCODE,          
 Q.CQL_ORDERBY,          
 Q.CQL_DT          
*/        
          
      
DELETE FROM V2_CLASS_QUARTERLYLEDGER      
WHERE CQL_DEBIT = 0      
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW
-- --------------------------------------------------
  
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW]                                  
(                                  
 @STARTDT VARCHAR(11),                                  
 @ENDDT VARCHAR(20),                                  
 @FROMPARTY VARCHAR(10),                                  
 @TOPARTY VARCHAR(10),                      
 @FROMBRANCH VARCHAR(15) = '',                      
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                      
 @FROMSUBBROKER VARCHAR(15) = '',                      
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                      
 @RPT_FILTER INT = 0                      
)                                  
                                  
/*                                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                                  
*/                                  
                                  
AS                                  
                                  
SET NOCOUNT ON                                  
                                  
/*                                  
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                                  
(                                  
 CQL_ID BIGINT IDENTITY(1,1),                                  
 CQL_SEGMENT VARCHAR(20),                                  
 CQL_PARTYCODE VARCHAR(10),                                  
 CQL_VDT VARCHAR(20),                                  
 CQL_VTYPE VARCHAR(10),                                  
 CQL_VNO VARCHAR(20),                                  
 CQL_ACCODE VARCHAR(10),                                  
 CQL_REMARKS VARCHAR(255),                                  
 CQL_DDNO VARCHAR(20),                                  
 CQL_DEBIT MONEY,                                  
 CQL_CREDIT MONEY,                                  
 CQL_BALANCE MONEY,                                  
 CQL_ORDERBY TINYINT,                                  
 CQL_DT INT,                                   
 CQL_ACNAME VARCHAR(100)                                  
)                                  
*/                                  
                                  
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                      
DECLARE @@SDTCUR DATETIME                      
                                  
/* NOW DOING NSECM */                      
                      
IF (@TOBRANCH = '')                      
BEGIN                      
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                      
END                      
                      
IF (@TOSUBBROKER = '')                      
BEGIN                      
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                      
END                      
                      
CREATE TABLE #CLIENTMASTER                      
 (                      
 PARTY_CODE VARCHAR(15),                      
 PARTYNAME VARCHAR(100),                      
 PARENTCODE VARCHAR(15),                      
 BRANCH_CD VARCHAR(15),                      
 SUB_BROKER VARCHAR(15)                      
 )         
       
 /* optimization by Siva */      
      
SELECT DISTINCT PARTY_CODE           
 INTO #PARTY          
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)          
WHERE --INACTIVE_DATE > GETDATE () AND       
LEFT(SCCS_DATE,11) = (          
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )           
           
union       
        
SELECT DISTINCT PARTY_CODE           
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)           
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (          
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )          
      
/*************/      
      
--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'      
      
 CREATE INDEX PARTY ON  #PARTY      
 (PARTY_CODE )      
      
      
 CREATE INDEX PARTY ON  #CLIENTMASTER      
 (PARTY_CODE )      
      
      
                 
       
IF (@RPT_FILTER = 0)                      
BEGIN                      
 INSERT INTO #CLIENTMASTER                      
 SELECT                      
  DISTINCT                      
  PARTY_CODE = CL_CODE,                      
  PARTYNAME='',                      
  PARENTCODE,                      
  BRANCH_CD,                      
  SUB_BROKER                      
 FROM                      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                      
 WHERE                      
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                      
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER           
  AND CL_CODE IN (SELECT * FROM #PARTY)      
                   
END                      
ELSE                      
BEGIN                      
 INSERT INTO #CLIENTMASTER                      
 SELECT                      
  DISTINCT                      
  PARTY_CODE = C.CL_CODE,                      
  PARTYNAME='',                      
  PARENTCODE,                      
  BRANCH_CD,                      
  SUB_BROKER                      
 FROM                      
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                      
 WHERE                      
  T.PARTY_CODE = C.PARTY_CODE             
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)               
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                      
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                      
END                      
                      
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                      
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                      
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                    
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                           
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                          
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSECM',                                   
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                     CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 1,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                      
   --AND A.ACCAT IN ('4','104','204'))                      
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
       
      
       
       
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANAND1.ACCOUNT.DBO.PARAMETER                                   
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                            
SELECT                                   
 CQL_SEGMENT = 'NSECM',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 2,                       
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                                 
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                      
 INTO #TEMP                             
FROM                                  
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')                    
 --AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                      
                  
                  
                  
                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                                    
 CQL_SEGMENT ,                                
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO,                                  
 CQL_ACCODE ,                                  
 CQL_REMARKS,                  
 CQL_DDNO ,                                  
 CQL_DEBIT ,                                  
 CQL_CREDIT,                      
 CQL_BALANCE ,                       
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME = C.PARTYNAME                    
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                   
                  
DROP TABLE   #TEMP                  
                     
                                  
/* NOW DOING BSECM */                                  
                                  
       
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 AngelBSECM.ACCOUNT_AB.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                             
  SELECT                                   
   CQL_SEGMENT = 'BSECM',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),           
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 3,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                 
 --AND A.ACCAT IN ('4','104','204')                    
   INNER JOIN                      
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR     
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                             
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                      
                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'BSECM',                                   
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                    
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 4,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                  
 AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                  
 --AND A.ACCAT IN ('4','104','204')                    
 LEFT OUTER JOIN                                   
 AngelBSECM.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY        
       
       
 --------NOW FOR MTF-----      
       
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANAND1.MTFTRADE.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                     
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                             
  SELECT                                   
   CQL_SEGMENT = 'MTF',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),           
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 3,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                 
 --AND A.ACCAT IN ('4','104','204')                    
   INNER JOIN                      
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                  L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                             
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MTF',                                   
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                    
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 4,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                  
  ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                  
 --AND A.ACCAT IN ('4','104','204')                    
 LEFT OUTER JOIN                                   
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
      
----------------END MTF-----------------                                
                                 
                                  
/* NOW DOING NSEFO */          
      
      
 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER      
 (      
 PARTY_CODE      
 )                                
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR            
FROM                                   
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSEFO',                                   
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                 
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                      
   INNER JOIN                                  
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,     
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                            
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'NSEFO',                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                      
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                      
FROM                                  
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                      
 INNER JOIN                                  
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
                                  
---===========================================================================================================                                 
--------------------------------------------------------------------------------------------------------------------                        
-- NCDX                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                             
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                            
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),     
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NCDX',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)       
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE >= @FROMPARTY                                  
   AND C.PARENTCODE <= @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'NCDX',                                   
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                      
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT >=  @STARTDT                                  
 AND L.VDT <= @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE >= @FROMPARTY                                  
 AND C.PARENTCODE <= @TOPARTY                                  
                                  
---------------------------------------------------------------------------------------------------------------                        
-- MCDX                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                 
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'MCDX',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                      
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE >= @FROMPARTY                                  
   AND C.PARENTCODE <= @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,               
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                              
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MCDX',                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                 
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT >=  @STARTDT                                  
 AND L.VDT <= @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE >= @FROMPARTY                                  
 AND C.PARENTCODE <= @TOPARTY                                  
                          
          
          
---------------------------------------------------------------------------------------------------------------                        
-- BSEFO                        
                        
SELECT                                  
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                               
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'BSEFO',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                         
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'BSEFO',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                               
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP2                                 
FROM                                  
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                 
                 
                 
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                            
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
  DROP TABLE #TEMP2               
            
          
---------------------------------------------------------------------------------------------------------------                        
-- MCDXCDS                        
                        
SELECT                                  
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'MCDXCDS',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MCDXCDS',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                               
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP1                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                 
                 
                 
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
 DROP TABLE #TEMP1                
                 
                  
                        
                        
--------------------------------------------------------------------------------------------------------------                        
-- NSECURFO                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                   
 CQL_ACNAME                    
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSECURFO',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                      
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                 
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                            
 CQL_SEGMENT = 'NSECURFO',                                   
 --- CQL_PARTYCODE = C.PARENTCODE,         
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                                
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
 INTO #TEMP3        
FROM                                  
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY           
         
                  
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
 SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
 DROP TABLE #TEMP3            
                                
                        
-------------------------------------------------------------------------------------------------------------------    

---------------------------------------------------------------------------------------------------------------                        
---- NCE                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTNCE.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                 
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NCE',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER L WITH (NOLOCK)                      
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTNCE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE >= @FROMPARTY                                  
   AND C.PARENTCODE <= @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,               
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                              
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'NCE',                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                 
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTNCE.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTNCE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTNCE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT >=  @STARTDT                                  
 AND L.VDT <= @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE >= @FROMPARTY                                  
 AND C.PARENTCODE <= @TOPARTY                                  
                          
          
          



/*============================================================================================================*/                                
/*                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
SELECT                                   
 Q.*,                                  
 CQL_ADD1 = C.L_ADDRESS1,                                  
 CQL_ADD2 = C.L_ADDRESS2,                                  
 CQL_ADD3 = C.L_ADDRESS3,                                  
 CQL_CITY = C.L_CITY,                                  
 CQL_ZIP = C.L_ZIP,                                  
 CQL_PHONE = C.RES_PHONE1,                                  
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                                  
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                                  
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                                  
FROM                                   
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                                  
 INNER JOIN                                  
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                                  
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                                  
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                              
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                                  
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                                  
ORDER BY                                   
 Q.CQL_PARTYCODE,                                  
 Q.CQL_ORDERBY,                                  
 Q.CQL_DT                    
*/       

                              
DELETE FROM V2_CLASS_QUARTERLYLEDGER                              
WHERE CQL_DEBIT = 0                              
AND CQL_CREDIT = 0 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-34751*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_04mar2025
-- --------------------------------------------------
  
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_04mar2025]                                  
(                                  
 @STARTDT VARCHAR(11),                                  
 @ENDDT VARCHAR(20),                                  
 @FROMPARTY VARCHAR(10),                                  
 @TOPARTY VARCHAR(10),                      
 @FROMBRANCH VARCHAR(15) = '',                      
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                      
 @FROMSUBBROKER VARCHAR(15) = '',                      
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                      
 @RPT_FILTER INT = 0                      
)                                  
                                  
/*                                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                                  
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                                  
*/                                  
                                  
AS                                  
                                  
SET NOCOUNT ON                                  
                                  
/*                                  
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                                  
(                                  
 CQL_ID BIGINT IDENTITY(1,1),                                  
 CQL_SEGMENT VARCHAR(20),                                  
 CQL_PARTYCODE VARCHAR(10),                                  
 CQL_VDT VARCHAR(20),                                  
 CQL_VTYPE VARCHAR(10),                                  
 CQL_VNO VARCHAR(20),                                  
 CQL_ACCODE VARCHAR(10),                                  
 CQL_REMARKS VARCHAR(255),                                  
 CQL_DDNO VARCHAR(20),                                  
 CQL_DEBIT MONEY,                                  
 CQL_CREDIT MONEY,                                  
 CQL_BALANCE MONEY,                                  
 CQL_ORDERBY TINYINT,                                  
 CQL_DT INT,                                   
 CQL_ACNAME VARCHAR(100)                                  
)                                  
*/                                  
                                  
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                      
DECLARE @@SDTCUR DATETIME                      
                                  
/* NOW DOING NSECM */                      
                      
IF (@TOBRANCH = '')                      
BEGIN                      
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                      
END                      
                      
IF (@TOSUBBROKER = '')                      
BEGIN                      
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                      
END                      
                      
CREATE TABLE #CLIENTMASTER                      
 (                      
 PARTY_CODE VARCHAR(15),                      
 PARTYNAME VARCHAR(100),                      
 PARENTCODE VARCHAR(15),                      
 BRANCH_CD VARCHAR(15),                      
 SUB_BROKER VARCHAR(15)                      
 )         
       
 /* optimization by Siva */      
      
SELECT DISTINCT PARTY_CODE           
 INTO #PARTY          
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)          
WHERE --INACTIVE_DATE > GETDATE () AND       
LEFT(SCCS_DATE,11) = (          
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )           
           
union       
        
SELECT DISTINCT PARTY_CODE           
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)           
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (          
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )          
      
/*************/      
      
--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'      
      
 CREATE INDEX PARTY ON  #PARTY      
 (PARTY_CODE )      
      
      
 CREATE INDEX PARTY ON  #CLIENTMASTER      
 (PARTY_CODE )      
      
      
                 
       
IF (@RPT_FILTER = 0)                      
BEGIN                      
 INSERT INTO #CLIENTMASTER                      
 SELECT                      
  DISTINCT                      
  PARTY_CODE = CL_CODE,                      
  PARTYNAME='',                      
  PARENTCODE,                      
  BRANCH_CD,                      
  SUB_BROKER                      
 FROM                      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                      
 WHERE                      
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                      
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER           
  AND CL_CODE IN (SELECT * FROM #PARTY)      
                   
END                      
ELSE                      
BEGIN                      
 INSERT INTO #CLIENTMASTER                      
 SELECT                      
  DISTINCT                      
  PARTY_CODE = C.CL_CODE,                      
  PARTYNAME='',                      
  PARENTCODE,                      
  BRANCH_CD,                      
  SUB_BROKER                      
 FROM                      
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                      
 WHERE                      
  T.PARTY_CODE = C.PARTY_CODE             
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)               
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                      
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                      
END                      
                      
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                      
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                      
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                    
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                           
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                          
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSECM',                                   
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                     CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 1,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                      
   --AND A.ACCAT IN ('4','104','204'))                      
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
       
      
       
       
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANAND1.ACCOUNT.DBO.PARAMETER                                   
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
                            
SELECT                                   
 CQL_SEGMENT = 'NSECM',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 2,                       
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                                 
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                      
 INTO #TEMP                             
FROM                                  
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')                    
 --AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                      
                  
                  
                  
                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                                    
 CQL_SEGMENT ,                                
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO,                                  
 CQL_ACCODE ,                                  
 CQL_REMARKS,                  
 CQL_DDNO ,                                  
 CQL_DEBIT ,                                  
 CQL_CREDIT,                      
 CQL_BALANCE ,                       
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME = C.PARTYNAME                    
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                   
                  
DROP TABLE   #TEMP                  
                     
                                  
/* NOW DOING BSECM */                                  
                                  
       
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 AngelBSECM.ACCOUNT_AB.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                             
  SELECT                                   
   CQL_SEGMENT = 'BSECM',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),           
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 3,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                 
 --AND A.ACCAT IN ('4','104','204')                    
   INNER JOIN                      
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR     
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                             
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                      
                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'BSECM',                                   
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                    
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 4,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                  
 AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                  
 --AND A.ACCAT IN ('4','104','204')                    
 LEFT OUTER JOIN                                   
 AngelBSECM.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY        
       
       
 --------NOW FOR MTF-----      
       
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANAND1.MTFTRADE.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                     
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                             
  SELECT                                   
   CQL_SEGMENT = 'MTF',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),           
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 3,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                 
 --AND A.ACCAT IN ('4','104','204')                    
   INNER JOIN                      
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                  L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                             
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MTF',                                   
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                    
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 4,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                  
  ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                  
 --AND A.ACCAT IN ('4','104','204')                    
 LEFT OUTER JOIN                                   
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
      
----------------END MTF-----------------                                
                                 
                                  
/* NOW DOING NSEFO */          
      
      
 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER      
 (      
 PARTY_CODE      
 )                                
                                  
                                  
SELECT                                   
 @@SDTCUR = SDTCUR            
FROM                                   
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSEFO',                                   
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                 
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                      
   INNER JOIN                                  
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,     
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                            
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'NSEFO',                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                      
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                      
FROM                                  
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                      
 INNER JOIN                                  
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
                                  
---===========================================================================================================                                 
--------------------------------------------------------------------------------------------------------------------                        
-- NCDX                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                             
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                            
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),     
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NCDX',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)       
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE >= @FROMPARTY                                  
   AND C.PARENTCODE <= @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'NCDX',                                   
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                      
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT >=  @STARTDT                                  
 AND L.VDT <= @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE >= @FROMPARTY                                  
 AND C.PARENTCODE <= @TOPARTY                                  
                                  
---------------------------------------------------------------------------------------------------------------                        
-- MCDX                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                 
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'MCDX',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                      
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE >= @FROMPARTY                                  
   AND C.PARENTCODE <= @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,               
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                              
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MCDX',                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                 
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 INNER JOIN                      
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT >=  @STARTDT                                  
 AND L.VDT <= @ENDDT --+ ' 23:59:59'                                  
 AND C.PARENTCODE >= @FROMPARTY                                  
 AND C.PARENTCODE <= @TOPARTY                                  
                          
          
          
---------------------------------------------------------------------------------------------------------------                        
-- BSEFO                        
                        
SELECT                                  
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                               
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'BSEFO',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                         
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'BSEFO',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                               
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP2                                 
FROM                                  
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                 
                 
                 
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                            
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
  DROP TABLE #TEMP2               
            
          
---------------------------------------------------------------------------------------------------------------                        
-- MCDXCDS                        
                        
SELECT                                  
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                                  
 CQL_ACNAME                                  
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'MCDXCDS',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT = 'MCDXCDS',                                   
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                               
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP1                                  
FROM                                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                 
                 
                 
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
 DROP TABLE #TEMP1                
                 
                  
                        
                        
--------------------------------------------------------------------------------------------------------------                        
-- NSECURFO                        
                        
SELECT                                   
 @@SDTCUR = SDTCUR                                   
FROM                                   
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                                 
WHERE                                  
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                  
                                  
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                                   
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                                  
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                  
 SUM(CQL_BALANCE),                                  
 CQL_ORDERBY,                                  
 19000101,                   
 CQL_ACNAME                    
FROM                                   
 (                                  
  SELECT                                   
   CQL_SEGMENT = 'NSECURFO',                                   
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
   CQL_VDT = '',                                  
   CQL_VTYPE = '',                                  
   CQL_VNO = '',                                  
   CQL_ACCODE = '',                                  
   CQL_REMARKS = 'OPENING BALANCE',                                  
   CQL_DDNO = '',                                  
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
   CQL_ORDERBY = 5,                                  
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                  
  FROM                                  
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                   
   INNER JOIN                                  
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
   INNER JOIN                      
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
  WHERE                                   
   L.VDT >= @@SDTCUR                                  
   AND L.VDT < @STARTDT                                  
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
 ) X                                  
GROUP BY                                  
 CQL_SEGMENT,                                  
 CQL_PARTYCODE,                                  
 CQL_VDT,                                  
 CQL_VTYPE,                      
 CQL_VNO,                                  
 CQL_ACCODE,                                  
 CQL_REMARKS,                                  
 CQL_DDNO,                                  
 CQL_ORDERBY,                                  
 CQL_ACNAME                                  
                 
                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
SELECT                            
 CQL_SEGMENT = 'NSECURFO',                                   
 --- CQL_PARTYCODE = C.PARENTCODE,         
 L.CLTCODE,                                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                  
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                  
 CQL_VNO = L.VNO,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS = L.NARRATION,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                  
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                  
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                  
 CQL_ORDERBY = 6,                                  
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                                
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                  
 INTO #TEMP3        
FROM                                  
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                   
 INNER JOIN                                  
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                  
 LEFT OUTER JOIN                                   
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                  
 --INNER JOIN                      
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                      
WHERE                                   
 L.VDT BETWEEN @STARTDT AND @ENDDT --+ ' 23:59:59'                                  
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY           
         
                  
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                  
 SELECT                                   
 CQL_SEGMENT ,                                   
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                  
 CQL_VDT ,                                  
 CQL_VTYPE ,                                  
 CQL_VNO ,                                  
 CQL_ACCODE = '',                                  
 CQL_REMARKS ,                                  
 CQL_DDNO = '',                                  
 CQL_DEBIT ,                              
 CQL_CREDIT ,                                  
 CQL_BALANCE ,                                  
 CQL_ORDERBY ,                                  
 VDT,                                  
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                   
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                 
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
                  
                  
 DROP TABLE #TEMP3            
                                
                        
-------------------------------------------------------------------------------------------------------------------                                                        
/*============================================================================================================*/                                
/*                                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                  
SELECT                                   
 Q.*,                                  
 CQL_ADD1 = C.L_ADDRESS1,                                  
 CQL_ADD2 = C.L_ADDRESS2,                                  
 CQL_ADD3 = C.L_ADDRESS3,                                  
 CQL_CITY = C.L_CITY,                                  
 CQL_ZIP = C.L_ZIP,                                  
 CQL_PHONE = C.RES_PHONE1,                                  
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                                  
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                                  
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                                  
FROM                                   
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                                  
 INNER JOIN                                  
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                                  
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                                  
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                              
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                                  
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                                  
ORDER BY                                   
 Q.CQL_PARTYCODE,                                  
 Q.CQL_ORDERBY,                                  
 Q.CQL_DT                    
*/                                            
                              
DELETE FROM V2_CLASS_QUARTERLYLEDGER                              
WHERE CQL_DEBIT = 0                              
AND CQL_CREDIT = 0 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-34751*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_17122013
-- --------------------------------------------------
CREATE PROC [DBO].[V2_PROC_QUARTERLYLEDGER_NEW_17122013]                        
(                        
 @STARTDT VARCHAR(11),                        
 @ENDDT VARCHAR(11),                        
 @FROMPARTY VARCHAR(10),                        
 @TOPARTY VARCHAR(10),            
 @FROMBRANCH VARCHAR(15) = '',            
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',            
 @FROMSUBBROKER VARCHAR(15) = '',            
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',            
 @RPT_FILTER INT = 0            
)                        
                        
/*                        
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                        
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                        
*/                        
                        
AS                        
                        
SET NOCOUNT ON                        
                        
/*                        
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                        
(                        
 CQL_ID BIGINT IDENTITY(1,1),                        
 CQL_SEGMENT VARCHAR(20),                        
 CQL_PARTYCODE VARCHAR(10),                        
 CQL_VDT VARCHAR(20),                        
 CQL_VTYPE VARCHAR(10),                        
 CQL_VNO VARCHAR(20),                        
 CQL_ACCODE VARCHAR(10),                        
 CQL_REMARKS VARCHAR(255),                        
 CQL_DDNO VARCHAR(20),                        
 CQL_DEBIT MONEY,                        
 CQL_CREDIT MONEY,                        
 CQL_BALANCE MONEY,                        
 CQL_ORDERBY TINYINT,                        
 CQL_DT INT,                         
 CQL_ACNAME VARCHAR(100)                        
)                        
*/                        
                        
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER            
DECLARE @@SDTCUR DATETIME            
                        
/* NOW DOING NSECM */            
            
IF (@TOBRANCH = '')            
BEGIN            
 SET @TOBRANCH  = 'ZZZZZZZZZZ'            
END            
            
IF (@TOSUBBROKER = '')            
BEGIN            
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'            
END            
            
CREATE TABLE #CLIENTMASTER            
 (            
 PARTY_CODE VARCHAR(15),            
 PARTYNAME VARCHAR(100),            
 PARENTCODE VARCHAR(15),            
 BRANCH_CD VARCHAR(15),            
 SUB_BROKER VARCHAR(15)            
 )            
            
IF (@RPT_FILTER = 0)            
BEGIN            
 INSERT INTO #CLIENTMASTER            
 SELECT            
  DISTINCT            
  PARTY_CODE = CL_CODE,            
  PARTYNAME='',            
  PARENTCODE,            
  BRANCH_CD,            
  SUB_BROKER            
 FROM            
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)            
 WHERE            
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH            
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER            
END            
ELSE            
BEGIN            
 INSERT INTO #CLIENTMASTER            
 SELECT            
  DISTINCT            
  PARTY_CODE = C.CL_CODE,            
  PARTYNAME='',            
  PARENTCODE,            
  BRANCH_CD,            
  SUB_BROKER            
 FROM            
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),            
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)            
 WHERE            
  T.PARTY_CODE = C.PARTY_CODE            
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH            
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER            
END            
            
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)            
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE            
                        
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM          
 ANAND1.ACCOUNT.DBO.PARAMETER                   
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                 
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                      
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'NSECM',                         
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                        
   CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 1,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                         
   INNER JOIN                        
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')            
   --AND A.ACCAT IN ('4','104','204'))            
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                        
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                        
                        
                        
                        
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANAND1.ACCOUNT.DBO.PARAMETER                         
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                  
SELECT                         
 CQL_SEGMENT = 'NSECM',                         
 L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 2,             
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                       
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME            
 INTO #TEMP                   
FROM                        
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                         
 INNER JOIN                        
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')          
 --AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                        
 --INNER JOIN            
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                        
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
        
        
        
        
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT                          
 CQL_SEGMENT ,                      
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
 CQL_VDT ,                        
 CQL_VTYPE ,                        
 CQL_VNO,                        
 CQL_ACCODE ,                        
 CQL_REMARKS,        
 CQL_DDNO ,                        
 CQL_DEBIT ,                        
 CQL_CREDIT,                        
 CQL_BALANCE ,             
 CQL_ORDERBY ,                        
 VDT,                        
 CQL_ACNAME = C.PARTYNAME          
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE        
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY         
        
DROP TABLE   #TEMP        
           
                        
/* NOW DOING BSECM */                        
                        
                        
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANAND.ACCOUNT_AB.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'BSECM',                         
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
   CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 3,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                         
   INNER JOIN                        
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')       
 --AND A.ACCAT IN ('4','104','204')          
   INNER JOIN            
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                   
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                        
                        
                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'BSECM',                         
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),          
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 4,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                        
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
FROM                        
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                        
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                        
 --AND A.ACCAT IN ('4','104','204')          
 LEFT OUTER JOIN                         
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                        
 INNER JOIN            
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                        
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                        
/* NOW DOING NSEFO */                        
                        
                        
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'NSEFO',                         
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                           CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 5,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)            
   INNER JOIN                        
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                  
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'NSEFO',                         
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 6,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                        
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME            
FROM                        
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)            
 INNER JOIN                        
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                        
 INNER JOIN            
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                        
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
                        
/*===========================================================================================================                       
--------------------------------------------------------------------------------------------------------------------              
-- NCDX              
              
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                   
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                  
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'NCDX',                         
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
   CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 5,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)            
   INNER JOIN                        
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE >= @FROMPARTY                        
   AND C.PARENTCODE <= @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'NCDX',                         
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 6,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                        
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                        
FROM                        
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                         
 INNER JOIN                        
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)            
 INNER JOIN            
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT >=  @STARTDT                        
 AND L.VDT <= @ENDDT + ' 23:59:59'                        
 AND C.PARENTCODE >= @FROMPARTY                        
 AND C.PARENTCODE <= @TOPARTY                        
                        
---------------------------------------------------------------------------------------------------------------              
-- MCDX              
              
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                       
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'MCDX',                         
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
 CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 5,                        
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                        
  FROM                        
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)            
   INNER JOIN                        
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE >= @FROMPARTY                        
   AND C.PARENTCODE <= @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                    
 CQL_ACNAME                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'MCDX',                         
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 6,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                        
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                        
FROM                        
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                         
 INNER JOIN                        
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                        
 INNER JOIN            
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT >=  @STARTDT                        
 AND L.VDT <= @ENDDT + ' 23:59:59'                        
 AND C.PARENTCODE >= @FROMPARTY                        
 AND C.PARENTCODE <= @TOPARTY                        
     */                   
---------------------------------------------------------------------------------------------------------------              
-- MCDXCDS              
              
SELECT                        
 @@SDTCUR = SDTCUR                         
FROM                         
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                    
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'MCDXCDS',                         
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
   CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 5,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                         
   INNER JOIN                        
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'MCDXCDS',                         
 L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 6,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                     
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME      
 INTO #TEMP1                        
FROM                        
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                         
 INNER JOIN                        
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                        
 --INNER JOIN            
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                        
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
       
       
       
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT ,                         
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
 CQL_VDT ,                        
 CQL_VTYPE ,                        
 CQL_VNO ,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS ,                        
 CQL_DDNO = '',                        
 CQL_DEBIT ,                    
 CQL_CREDIT ,                        
 CQL_BALANCE ,                        
 CQL_ORDERBY ,                        
 VDT,                        
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME         
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE       
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY        
        
        
  DROP TABLE #TEMP1      
       
        
              
              
--------------------------------------------------------------------------------------------------------------              
-- NSECURFO              
              
SELECT                         
 @@SDTCUR = SDTCUR                         
FROM                         
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                       
WHERE                        
 @STARTDT BETWEEN SDTCUR AND LDTCUR                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                        
 CQL_ORDERBY,                        
 19000101,                        
 CQL_ACNAME                        
FROM                         
 (                        
  SELECT                         
   CQL_SEGMENT = 'NSECURFO',                         
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
   CQL_VDT = '',                        
   CQL_VTYPE = '',                        
   CQL_VNO = '',                        
   CQL_ACCODE = '',                        
   CQL_REMARKS = 'OPENING BALANCE',                        
   CQL_DDNO = '',                        
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
   CQL_ORDERBY = 5,                        
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                        
  FROM                        
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                         
   INNER JOIN                        
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
   INNER JOIN            
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
  WHERE                         
   L.VDT >= @@SDTCUR                        
   AND L.VDT < @STARTDT                        
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
 ) X                        
GROUP BY                        
 CQL_SEGMENT,                        
 CQL_PARTYCODE,                        
 CQL_VDT,                        
 CQL_VTYPE,                        
 CQL_VNO,                        
 CQL_ACCODE,                        
 CQL_REMARKS,                        
 CQL_DDNO,                        
 CQL_ORDERBY,                        
 CQL_ACNAME                        
                        
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
INSERT INTO V2_CLASS_QUARTERLYLEDGER                        
SELECT                         
 CQL_SEGMENT = 'NSECURFO',                         
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                        
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                        
 CQL_ACCODE = '',                        
 CQL_REMARKS = L.NARRATION,                        
 CQL_DDNO = '',                        
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                        
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                        
 CQL_ORDERBY = 6,                        
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                        
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                        
FROM                        
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                         
 INNER JOIN                        
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                        
 LEFT OUTER JOIN                         
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                        
 INNER JOIN            
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)            
WHERE                         
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                        
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                        
              
-------------------------------------------------------------------------------------------------------------------                                              
/*============================================================================================================*/                      
/*                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
SELECT                         
 Q.*,                        
 CQL_ADD1 = C.L_ADDRESS1,                        
 CQL_ADD2 = C.L_ADDRESS2,                        
 CQL_ADD3 = C.L_ADDRESS3,                        
 CQL_CITY = C.L_CITY,                        
 CQL_ZIP = C.L_ZIP,                        
 CQL_PHONE = C.RES_PHONE1,                        
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                        
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                        
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                        
FROM                         
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                        
 INNER JOIN                        
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                        
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                        
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                        
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                        
ORDER BY                         
 Q.CQL_PARTYCODE,                        
 Q.CQL_ORDERBY,                        
 Q.CQL_DT          
*/                                  
                    
DELETE FROM V2_CLASS_QUARTERLYLEDGER                    
WHERE CQL_DEBIT = 0                    
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_18032019
-- --------------------------------------------------

CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_18032019]                            
(                            
 @STARTDT VARCHAR(11),                            
 @ENDDT VARCHAR(11),                            
 @FROMPARTY VARCHAR(10),                            
 @TOPARTY VARCHAR(10),                
 @FROMBRANCH VARCHAR(15) = '',                
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                
 @FROMSUBBROKER VARCHAR(15) = '',                
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                
 @RPT_FILTER INT = 0                
)                            
                            
/*                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                            
*/                            
                            
AS                            
                            
SET NOCOUNT ON                            
                            
/*                            
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                            
(                            
 CQL_ID BIGINT IDENTITY(1,1),                            
 CQL_SEGMENT VARCHAR(20),                            
 CQL_PARTYCODE VARCHAR(10),                            
 CQL_VDT VARCHAR(20),                            
 CQL_VTYPE VARCHAR(10),                            
 CQL_VNO VARCHAR(20),                            
 CQL_ACCODE VARCHAR(10),                            
 CQL_REMARKS VARCHAR(255),                            
 CQL_DDNO VARCHAR(20),                            
 CQL_DEBIT MONEY,                            
 CQL_CREDIT MONEY,                            
 CQL_BALANCE MONEY,                            
 CQL_ORDERBY TINYINT,                            
 CQL_DT INT,                             
 CQL_ACNAME VARCHAR(100)                            
)                            
*/                            
                            
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
DECLARE @@SDTCUR DATETIME                
                            
/* NOW DOING NSECM */                
                
IF (@TOBRANCH = '')                
BEGIN                
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                
END                
                
IF (@TOSUBBROKER = '')                
BEGIN                
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                
END                
                
CREATE TABLE #CLIENTMASTER                
 (                
 PARTY_CODE VARCHAR(15),                
 PARTYNAME VARCHAR(100),                
 PARENTCODE VARCHAR(15),                
 BRANCH_CD VARCHAR(15),                
 SUB_BROKER VARCHAR(15)                
 )   
 
 /* optimization by Siva */

SELECT DISTINCT PARTY_CODE     
 INTO #PARTY    
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)    
WHERE --INACTIVE_DATE > GETDATE () AND 
LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )     
     
union 
  
SELECT DISTINCT PARTY_CODE     
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)     
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )    

/*************/

--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'

 CREATE INDEX PARTY ON  #PARTY
 (PARTY_CODE )


 CREATE INDEX PARTY ON  #CLIENTMASTER
 (PARTY_CODE )


           
                
IF (@RPT_FILTER = 0)                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
 WHERE                
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER     
  AND CL_CODE IN (SELECT * FROM #PARTY)
             
END                
ELSE                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = C.CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                
 WHERE                
  T.PARTY_CODE = C.PARTY_CODE       
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)         
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
                
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM              
 ANAND1.ACCOUNT.DBO.PARAMETER                       
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                     
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                    
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECM',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 1,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
   --AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
 

 
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
                      
SELECT                             
 CQL_SEGMENT = 'NSECM',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 2,                 
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                           
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP                       
FROM                            
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')              
 --AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
            
            
            
            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                              
 CQL_SEGMENT ,                          
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO,                            
 CQL_ACCODE ,                            
 CQL_REMARKS,            
 CQL_DDNO ,                            
 CQL_DEBIT ,                            
 CQL_CREDIT,                            
 CQL_BALANCE ,                 
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME = C.PARTYNAME              
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY             
            
DROP TABLE   #TEMP            
               
                            
/* NOW DOING BSECM */                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND.ACCOUNT_AB.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'BSECM',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSECM',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
 
 
 --------NOW FOR MTF-----
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.MTFTRADE.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,               
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'MTF',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MTF',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
  ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            

----------------END MTF-----------------                          
                           
                            
/* NOW DOING NSEFO */    


 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER
 (
	PARTY_CODE
 )                          
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR      
FROM                             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,           
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                      
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NSEFO',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
 INNER JOIN                            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
--=========================================================================================================== uncomment ,due to merger req on 18032019                         
--------------------------------------------------------------------------------------------------------------------                  
-- NCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                       
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                      
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                            
---------------------------------------------------------------------------------------------------------------                  
-- MCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                           
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                        
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                        
    
    
---------------------------------------------------------------------------------------------------------------                  
-- BSEFO                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                         
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'BSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSEFO',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP2                           
FROM                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                      
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
  DROP TABLE #TEMP2         
      
    
---------------------------------------------------------------------------------------------------------------                  
-- MCDXCDS                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDXCDS',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDXCDS',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP1                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP1          
           
            
                  
                  
--------------------------------------------------------------------------------------------------------------                  
-- NSECURFO                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,             
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECURFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                      
 CQL_SEGMENT = 'NSECURFO',                             
 --- CQL_PARTYCODE = C.PARENTCODE,   
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                          
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
 INTO #TEMP3  
FROM                            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY     
   
            
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
 SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP3      
                          
                  
-------------------------------------------------------------------------------------------------------------------                                                  
/*============================================================================================================*/                          
/*                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 Q.*,                            
 CQL_ADD1 = C.L_ADDRESS1,                            
 CQL_ADD2 = C.L_ADDRESS2,                            
 CQL_ADD3 = C.L_ADDRESS3,                            
 CQL_CITY = C.L_CITY,                            
 CQL_ZIP = C.L_ZIP,                            
 CQL_PHONE = C.RES_PHONE1,                            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                            
FROM                             
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                            
 INNER JOIN                            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                            
ORDER BY                             
 Q.CQL_PARTYCODE,                            
 Q.CQL_ORDERBY,                            
 Q.CQL_DT              
*/                                      
                        
DELETE FROM V2_CLASS_QUARTERLYLEDGER                        
WHERE CQL_DEBIT = 0                        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_18082013
-- --------------------------------------------------
CREATE PROC [DBO].[V2_PROC_QUARTERLYLEDGER_NEW_18082013]                
(                
 @STARTDT VARCHAR(11),                
 @ENDDT VARCHAR(11),                
 @FROMPARTY VARCHAR(10),                
 @TOPARTY VARCHAR(10),    
 @FROMBRANCH VARCHAR(15) = '',    
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',    
 @FROMSUBBROKER VARCHAR(15) = '',    
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',    
 @RPT_FILTER INT = 0    
)                
                
/*                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                
*/                
                
AS                
                
SET NOCOUNT ON                
                
/*                
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                
(                
 CQL_ID BIGINT IDENTITY(1,1),                
 CQL_SEGMENT VARCHAR(20),                
 CQL_PARTYCODE VARCHAR(10),                
 CQL_VDT VARCHAR(20),                
 CQL_VTYPE VARCHAR(10),                
 CQL_VNO VARCHAR(20),                
 CQL_ACCODE VARCHAR(10),                
 CQL_REMARKS VARCHAR(255),                
 CQL_DDNO VARCHAR(20),                
 CQL_DEBIT MONEY,                
 CQL_CREDIT MONEY,                
 CQL_BALANCE MONEY,                
 CQL_ORDERBY TINYINT,                
 CQL_DT INT,                 
 CQL_ACNAME VARCHAR(100)                
)                
*/                
                
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER    
DECLARE @@SDTCUR DATETIME    
                
/* NOW DOING NSECM */    
    
IF (@TOBRANCH = '')    
BEGIN    
 SET @TOBRANCH  = 'ZZZZZZZZZZ'    
END    
    
IF (@TOSUBBROKER = '')    
BEGIN    
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'    
END    
    
CREATE TABLE #CLIENTMASTER    
 (    
 PARTY_CODE VARCHAR(15),    
 PARTYNAME VARCHAR(100),    
 PARENTCODE VARCHAR(15),    
 BRANCH_CD VARCHAR(15),    
 SUB_BROKER VARCHAR(15)    
 )    
    
IF (@RPT_FILTER = 0)    
BEGIN    
 INSERT INTO #CLIENTMASTER    
 SELECT    
  DISTINCT    
  PARTY_CODE = CL_CODE,    
  PARTYNAME='',    
  PARENTCODE,    
  BRANCH_CD,    
  SUB_BROKER    
 FROM    
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)    
 WHERE    
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY    
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH    
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER    
END    
ELSE    
BEGIN    
 INSERT INTO #CLIENTMASTER    
 SELECT    
  DISTINCT    
  PARTY_CODE = C.CL_CODE,    
  PARTYNAME='',    
  PARENTCODE,    
  BRANCH_CD,    
  SUB_BROKER    
 FROM    
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),    
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)    
 WHERE    
  T.PARTY_CODE = C.PARTY_CODE    
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY    
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH    
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER    
END    
    
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)    
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE    
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND1.ACCOUNT.DBO.PARAMETER           
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME        
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECM',                 
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 1,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                 
   INNER JOIN                
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')    
   --AND A.ACCAT IN ('4','104','204'))    
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND1.ACCOUNT.DBO.PARAMETER                 
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSECM',                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 2,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')  
 --AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
   
                
/* NOW DOING BSECM */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND.ACCOUNT_AB.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'BSECM',                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,        
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 3,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                 
   INNER JOIN                
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
 --AND A.ACCAT IN ('4','104','204')  
   INNER JOIN    
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'BSECM',                 
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 4,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
 --AND A.ACCAT IN ('4','104','204')  
 LEFT OUTER JOIN                 
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
                
/* NOW DOING NSEFO */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELFO.ACCOUNTFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSEFO',                 
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)    
   INNER JOIN                
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSEFO',                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,    
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME    
FROM                
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)    
 INNER JOIN                
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
                
/*===========================================================================================================               
--------------------------------------------------------------------------------------------------------------------      
-- NCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,          
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NCDX',                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)    
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE >= @FROMPARTY                
   AND C.PARENTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NCDX',                 
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)    
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE >= @FROMPARTY                
 AND C.PARENTCODE <= @TOPARTY                
                
---------------------------------------------------------------------------------------------------------------      
-- MCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,               
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDX',                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)    
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE >= @FROMPARTY                
   AND C.PARENTCODE <= @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDX',                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE >= @FROMPARTY                
 AND C.PARENTCODE <= @TOPARTY                
     */           
---------------------------------------------------------------------------------------------------------------      
-- MCDXCDS      
      
SELECT                
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDXCDS',                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                 
   INNER JOIN                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDXCDS',                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY       
      
      
--------------------------------------------------------------------------------------------------------------      
-- NSECURFO      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECURFO',                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
  FROM                
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                 
   INNER JOIN                
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSECURFO',                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                 
 INNER JOIN                
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                
 LEFT OUTER JOIN                 
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)    
WHERE                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
      
-------------------------------------------------------------------------------------------------------------------                                      
/*============================================================================================================*/              
/*                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
SELECT                 
 Q.*,                
 CQL_ADD1 = C.L_ADDRESS1,                
 CQL_ADD2 = C.L_ADDRESS2,                
 CQL_ADD3 = C.L_ADDRESS3,                
 CQL_CITY = C.L_CITY,                
 CQL_ZIP = C.L_ZIP,                
 CQL_PHONE = C.RES_PHONE1,                
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                
FROM                 
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                
 INNER JOIN                
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                
ORDER BY                 
 Q.CQL_PARTYCODE,                
 Q.CQL_ORDERBY,                
 Q.CQL_DT    
*/                          
            
DELETE FROM V2_CLASS_QUARTERLYLEDGER            
WHERE CQL_DEBIT = 0            
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_20jan2022
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_20jan2022]                              
(                              
 @STARTDT VARCHAR(11),                              
 @ENDDT VARCHAR(11),                              
 @FROMPARTY VARCHAR(10),                              
 @TOPARTY VARCHAR(10),                  
 @FROMBRANCH VARCHAR(15) = '',                  
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                  
 @FROMSUBBROKER VARCHAR(15) = '',                  
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                  
 @RPT_FILTER INT = 0                  
)                              
                              
/*                              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                              
*/                              
                              
AS                              
                              
SET NOCOUNT ON                              
                              
/*                              
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                              
(                              
 CQL_ID BIGINT IDENTITY(1,1),                              
 CQL_SEGMENT VARCHAR(20),                              
 CQL_PARTYCODE VARCHAR(10),                              
 CQL_VDT VARCHAR(20),                              
 CQL_VTYPE VARCHAR(10),                              
 CQL_VNO VARCHAR(20),                              
 CQL_ACCODE VARCHAR(10),                              
 CQL_REMARKS VARCHAR(255),                              
 CQL_DDNO VARCHAR(20),                              
 CQL_DEBIT MONEY,                              
 CQL_CREDIT MONEY,                              
 CQL_BALANCE MONEY,                              
 CQL_ORDERBY TINYINT,                              
 CQL_DT INT,                               
 CQL_ACNAME VARCHAR(100)                              
)                              
*/                              
                              
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                  
DECLARE @@SDTCUR DATETIME                  
                              
/* NOW DOING NSECM */                  
                  
IF (@TOBRANCH = '')                  
BEGIN                  
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                  
END                  
                  
IF (@TOSUBBROKER = '')                  
BEGIN                  
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                  
END                  
                  
CREATE TABLE #CLIENTMASTER                  
 (                  
 PARTY_CODE VARCHAR(15),                  
 PARTYNAME VARCHAR(100),                  
 PARENTCODE VARCHAR(15),                  
 BRANCH_CD VARCHAR(15),                  
 SUB_BROKER VARCHAR(15)                  
 )     
   
 /* optimization by Siva */  
  
SELECT DISTINCT PARTY_CODE       
 INTO #PARTY      
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)      
WHERE --INACTIVE_DATE > GETDATE () AND   
LEFT(SCCS_DATE,11) = (      
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )       
       
union   
    
SELECT DISTINCT PARTY_CODE       
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)       
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (      
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )      
  
/*************/  
  
--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'  
  
 CREATE INDEX PARTY ON  #PARTY  
 (PARTY_CODE )  
  
  
 CREATE INDEX PARTY ON  #CLIENTMASTER  
 (PARTY_CODE )  
  
  
             
                  
IF (@RPT_FILTER = 0)                  
BEGIN                  
 INSERT INTO #CLIENTMASTER                  
 SELECT                  
  DISTINCT                  
  PARTY_CODE = CL_CODE,                  
  PARTYNAME='',                  
  PARENTCODE,                  
  BRANCH_CD,                  
  SUB_BROKER                  
 FROM                  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                  
 WHERE                  
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                  
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER       
  AND CL_CODE IN (SELECT * FROM #PARTY)  
               
END                  
ELSE                  
BEGIN                  
 INSERT INTO #CLIENTMASTER                  
 SELECT                  
  DISTINCT                  
  PARTY_CODE = C.CL_CODE,                  
  PARTYNAME='',                  
  PARENTCODE,                  
  BRANCH_CD,                  
  SUB_BROKER                  
 FROM                  
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                  
 WHERE                  
  T.PARTY_CODE = C.PARTY_CODE         
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)           
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                  
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                  
END                  
                  
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                  
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                  
                              
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                
 ANAND1.ACCOUNT.DBO.PARAMETER                         
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                       
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                      
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'NSECM',                               
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                              
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 1,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                  
   --AND A.ACCAT IN ('4','104','204'))                  
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
   
  
   
   
                              
                              
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANAND1.ACCOUNT.DBO.PARAMETER                               
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED         
                        
SELECT                               
 CQL_SEGMENT = 'NSECM',                               
 L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 2,                   
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                             
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                  
 INTO #TEMP                         
FROM                              
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')                
 --AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                              
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                  
              
              
              
              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                    
SELECT                                
 CQL_SEGMENT ,                            
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT ,                              
 CQL_VTYPE ,                              
 CQL_VNO,                              
 CQL_ACCODE ,                              
 CQL_REMARKS,              
 CQL_DDNO ,                              
 CQL_DEBIT ,                              
 CQL_CREDIT,                              
 CQL_BALANCE ,                   
 CQL_ORDERBY ,                              
 VDT,                              
 CQL_ACNAME = C.PARTYNAME                
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE              
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY               
              
DROP TABLE   #TEMP              
                 
                              
/* NOW DOING BSECM */                              
                              
   
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANAND.ACCOUNT_AB.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                         
  SELECT                               
   CQL_SEGMENT = 'BSECM',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                      
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),       
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 3,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')             
 --AND A.ACCAT IN ('4','104','204')                
   INNER JOIN                  
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                         
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'BSECM',                               
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 4,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                              
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
FROM                              
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                              
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                              
 --AND A.ACCAT IN ('4','104','204')                
 LEFT OUTER JOIN                               
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY    
   
   
 --------NOW FOR MTF-----  
   
                              
                              
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANAND1.MTFTRADE.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                 
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                         
  SELECT                               
   CQL_SEGMENT = 'MTF',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                      
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),       
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 3,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')             
 --AND A.ACCAT IN ('4','104','204')                
   INNER JOIN                  
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                                  L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                         
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'MTF',                               
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 4,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                              
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
FROM                              
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                              
  ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                              
 --AND A.ACCAT IN ('4','104','204')                
 LEFT OUTER JOIN                               
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
  
----------------END MTF-----------------                            
                             
                              
/* NOW DOING NSEFO */      
  
  
 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER  
 (  
 PARTY_CODE  
 )                            
                              
                              
SELECT                               
 @@SDTCUR = SDTCUR        
FROM                               
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'NSEFO',                               
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,             
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                  
   INNER JOIN                              
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                        
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'NSEFO',                               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                  
FROM                              
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                  
 INNER JOIN                              
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
                              
---===========================================================================================================                             
--------------------------------------------------------------------------------------------------------------------                    
-- NCDX                    
                    
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                         
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                        
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'NCDX',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                  
   INNER JOIN                              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE >= @FROMPARTY                              
   AND C.PARENTCODE <= @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'NCDX',                               
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                              
FROM                              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                  
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT >=  @STARTDT                              
 AND L.VDT <= @ENDDT + ' 23:59:59'                              
 AND C.PARENTCODE >= @FROMPARTY                              
 AND C.PARENTCODE <= @TOPARTY                              
                              
---------------------------------------------------------------------------------------------------------------                    
-- MCDX                    
                    
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                             
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'MCDX',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                              
  FROM                              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                  
   INNER JOIN                              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE >= @FROMPARTY                              
   AND C.PARENTCODE <= @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                          
 CQL_ACNAME                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'MCDX',                               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                              
FROM                              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 INNER JOIN                  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT >=  @STARTDT                              
 AND L.VDT <= @ENDDT + ' 23:59:59'                              
 AND C.PARENTCODE >= @FROMPARTY                              
 AND C.PARENTCODE <= @TOPARTY                              
                      
      
      
---------------------------------------------------------------------------------------------------------------                    
-- BSEFO                    
                    
SELECT                              
 @@SDTCUR = SDTCUR                               
FROM                               
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                           
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'BSEFO',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'BSEFO',                               
 L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                           
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME            
 INTO #TEMP2                             
FROM                              
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 --INNER JOIN                  
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                    
             
             
             
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT ,                               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT ,                              
 CQL_VTYPE ,                        
 CQL_VNO ,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS ,                              
 CQL_DDNO = '',                              
 CQL_DEBIT ,                          
 CQL_CREDIT ,                              
 CQL_BALANCE ,                              
 CQL_ORDERBY ,                              
 VDT,                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME               
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE             
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
              
              
  DROP TABLE #TEMP2           
        
      
---------------------------------------------------------------------------------------------------------------                    
-- MCDXCDS                    
                    
SELECT                              
 @@SDTCUR = SDTCUR                               
FROM                               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,                              
 CQL_ACNAME                              
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'MCDXCDS',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT = 'MCDXCDS',                               
 L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                           
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME            
 INTO #TEMP1                              
FROM                              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 --INNER JOIN                  
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                    
             
             
             
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT ,                               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT ,                              
 CQL_VTYPE ,                              
 CQL_VNO ,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS ,                              
 CQL_DDNO = '',                              
 CQL_DEBIT ,                          
 CQL_CREDIT ,                              
 CQL_BALANCE ,                              
 CQL_ORDERBY ,                              
 VDT,                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME               
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE             
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
              
              
 DROP TABLE #TEMP1            
             
              
                    
                    
--------------------------------------------------------------------------------------------------------------                    
-- NSECURFO                    
                    
SELECT                               
 @@SDTCUR = SDTCUR                               
FROM                               
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                             
WHERE                              
 @STARTDT BETWEEN SDTCUR AND LDTCUR                              
                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                               
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                              
 SUM(CQL_BALANCE),                              
 CQL_ORDERBY,                              
 19000101,               
 CQL_ACNAME                              
FROM                               
 (                              
  SELECT                               
   CQL_SEGMENT = 'NSECURFO',                               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
   CQL_VDT = '',                              
   CQL_VTYPE = '',                              
   CQL_VNO = '',                              
   CQL_ACCODE = '',                              
   CQL_REMARKS = 'OPENING BALANCE',                              
   CQL_DDNO = '',                              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
   CQL_ORDERBY = 5,                              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                              
  FROM                              
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                               
   INNER JOIN                              
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
   INNER JOIN                  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
  WHERE                               
   L.VDT >= @@SDTCUR                              
   AND L.VDT < @STARTDT                              
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
 ) X                              
GROUP BY                              
 CQL_SEGMENT,                              
 CQL_PARTYCODE,                              
 CQL_VDT,                              
 CQL_VTYPE,                              
 CQL_VNO,                              
 CQL_ACCODE,                              
 CQL_REMARKS,                              
 CQL_DDNO,                              
 CQL_ORDERBY,                              
 CQL_ACNAME                              
             
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
SELECT                        
 CQL_SEGMENT = 'NSECURFO',                               
 --- CQL_PARTYCODE = C.PARENTCODE,     
 L.CLTCODE,                              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                              
 CQL_VNO = L.VNO,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS = L.NARRATION,                              
 CQL_DDNO = '',                              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                              
 CQL_ORDERBY = 6,                              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                            
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                              
 INTO #TEMP3    
FROM                              
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                               
 INNER JOIN                              
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                              
 LEFT OUTER JOIN                               
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                              
 --INNER JOIN                  
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                  
WHERE                               
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                              
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY       
     
              
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                              
 SELECT                               
 CQL_SEGMENT ,                               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                              
 CQL_VDT ,                              
 CQL_VTYPE ,                              
 CQL_VNO ,                              
 CQL_ACCODE = '',                              
 CQL_REMARKS ,                              
 CQL_DDNO = '',                              
 CQL_DEBIT ,                          
 CQL_CREDIT ,                              
 CQL_BALANCE ,                              
 CQL_ORDERBY ,                              
 VDT,                              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME               
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE             
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
              
              
 DROP TABLE #TEMP3        
                            
                    
-------------------------------------------------------------------------------------------------------------------                                                    
/*============================================================================================================*/                            
/*                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
SELECT                               
 Q.*,                              
 CQL_ADD1 = C.L_ADDRESS1,                              
 CQL_ADD2 = C.L_ADDRESS2,                              
 CQL_ADD3 = C.L_ADDRESS3,                              
 CQL_CITY = C.L_CITY,                              
 CQL_ZIP = C.L_ZIP,                              
 CQL_PHONE = C.RES_PHONE1,                              
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                              
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                              
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                              
FROM                               
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                              
 INNER JOIN                              
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                              
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                              
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                          
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                              
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                              
ORDER BY                               
 Q.CQL_PARTYCODE,                              
 Q.CQL_ORDERBY,                              
 Q.CQL_DT                
*/                                        
                          
DELETE FROM V2_CLASS_QUARTERLYLEDGER                          
WHERE CQL_DEBIT = 0                          
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_25jan2022
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_25jan2022]                                
(                                
 @STARTDT VARCHAR(11),                                
 @ENDDT VARCHAR(20),                                
 @FROMPARTY VARCHAR(10),                                
 @TOPARTY VARCHAR(10),                    
 @FROMBRANCH VARCHAR(15) = '',                    
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                    
 @FROMSUBBROKER VARCHAR(15) = '',                    
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                    
 @RPT_FILTER INT = 0                    
)                                
                                
/*                                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                                
*/                                
                                
AS                                
                                
SET NOCOUNT ON                                
                                
/*                                
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                                
(                                
 CQL_ID BIGINT IDENTITY(1,1),                                
 CQL_SEGMENT VARCHAR(20),                                
 CQL_PARTYCODE VARCHAR(10),                                
 CQL_VDT VARCHAR(20),                                
 CQL_VTYPE VARCHAR(10),                                
 CQL_VNO VARCHAR(20),                                
 CQL_ACCODE VARCHAR(10),                                
 CQL_REMARKS VARCHAR(255),                                
 CQL_DDNO VARCHAR(20),                                
 CQL_DEBIT MONEY,                                
 CQL_CREDIT MONEY,                                
 CQL_BALANCE MONEY,                                
 CQL_ORDERBY TINYINT,                                
 CQL_DT INT,                                 
 CQL_ACNAME VARCHAR(100)                                
)                                
*/                                
                                
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                    
DECLARE @@SDTCUR DATETIME                    
                                
/* NOW DOING NSECM */                    
                    
IF (@TOBRANCH = '')                    
BEGIN                    
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                    
END                    
                    
IF (@TOSUBBROKER = '')                    
BEGIN                    
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                    
END                    
                    
CREATE TABLE #CLIENTMASTER                    
 (                    
 PARTY_CODE VARCHAR(15),                    
 PARTYNAME VARCHAR(100),                    
 PARENTCODE VARCHAR(15),                    
 BRANCH_CD VARCHAR(15),                    
 SUB_BROKER VARCHAR(15)                    
 )       
     
 /* optimization by Siva */    
    
SELECT DISTINCT PARTY_CODE         
 INTO #PARTY        
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)        
WHERE --INACTIVE_DATE > GETDATE () AND     
LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )         
         
union     
      
SELECT DISTINCT PARTY_CODE         
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)         
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )        
    
/*************/    
    
--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'    
    
 CREATE INDEX PARTY ON  #PARTY    
 (PARTY_CODE )    
    
    
 CREATE INDEX PARTY ON  #CLIENTMASTER    
 (PARTY_CODE )    
    
    
               
                    
IF (@RPT_FILTER = 0)                    
BEGIN                    
 INSERT INTO #CLIENTMASTER                    
 SELECT                    
  DISTINCT                    
  PARTY_CODE = CL_CODE,                    
  PARTYNAME='',                    
  PARENTCODE,                    
  BRANCH_CD,                    
  SUB_BROKER                    
 FROM                    
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                    
 WHERE                    
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                    
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                    
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER         
  AND CL_CODE IN (SELECT * FROM #PARTY)    
                 
END                    
ELSE                    
BEGIN                    
 INSERT INTO #CLIENTMASTER                    
 SELECT                    
  DISTINCT                    
  PARTY_CODE = C.CL_CODE,                    
  PARTYNAME='',                    
  PARENTCODE,                    
  BRANCH_CD,                    
  SUB_BROKER                    
 FROM                    
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                    
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                    
 WHERE                    
  T.PARTY_CODE = C.PARTY_CODE           
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)             
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                    
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                    
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                    
END                    
                    
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                    
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                    
                                
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                  
 ANAND1.ACCOUNT.DBO.PARAMETER                           
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                         
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                        
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'NSECM',                                 
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 1,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                    
   --AND A.ACCAT IN ('4','104','204'))                    
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                                
     
    
     
     
                                
                                
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANAND1.ACCOUNT.DBO.PARAMETER                                 
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED           
                          
SELECT                                 
 CQL_SEGMENT = 'NSECM',                                 
 L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 2,                     
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                               
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                    
 INTO #TEMP                           
FROM                                
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')                  
 --AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                                
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                    
                
                
                
                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                      
SELECT                                  
 CQL_SEGMENT ,                              
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT ,                                
 CQL_VTYPE ,                                
 CQL_VNO,                                
 CQL_ACCODE ,                                
 CQL_REMARKS,                
 CQL_DDNO ,                                
 CQL_DEBIT ,                                
 CQL_CREDIT,                    
 CQL_BALANCE ,                     
 CQL_ORDERBY ,                                
 VDT,                                
 CQL_ACNAME = C.PARTYNAME                  
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                 
                
DROP TABLE   #TEMP                
                   
                                
/* NOW DOING BSECM */                                
                                
     
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANAND.ACCOUNT_AB.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                           
  SELECT                                 
   CQL_SEGMENT = 'BSECM',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),         
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 3,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')               
 --AND A.ACCAT IN ('4','104','204')                  
   INNER JOIN                    
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                           
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                    
                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'BSECM',                                 
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 4,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
FROM                                
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                
 --AND A.ACCAT IN ('4','104','204')                  
 LEFT OUTER JOIN                                 
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY      
     
     
 --------NOW FOR MTF-----    
     
                                
                                
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANAND1.MTFTRADE.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                   
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                           
  SELECT                                 
   CQL_SEGMENT = 'MTF',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                        
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),         
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 3,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')               
 --AND A.ACCAT IN ('4','104','204')                  
   INNER JOIN                    
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                  L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                           
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                                
                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'MTF',                                 
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                  
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 4,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
FROM                                
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                                
  ANAND1.MTFTRADE.DBO.ACMAST_M A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                                
 --AND A.ACCAT IN ('4','104','204')                  
 LEFT OUTER JOIN                                 
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
    
----------------END MTF-----------------                              
                               
                                
/* NOW DOING NSEFO */        
    
    
 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER    
 (    
 PARTY_CODE    
 )                              
                                
                                
SELECT                                 
 @@SDTCUR = SDTCUR          
FROM                                 
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'NSEFO',                                 
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,               
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                    
   INNER JOIN                                
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                          
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'NSEFO',                                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                    
FROM                                
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                    
 INNER JOIN                                
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
                                
---===========================================================================================================                               
--------------------------------------------------------------------------------------------------------------------                      
-- NCDX                      
                      
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                           
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                          
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'NCDX',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)     
   INNER JOIN                                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE >= @FROMPARTY                                
   AND C.PARENTCODE <= @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'NCDX',                                 
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                
FROM                                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                    
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT >=  @STARTDT                                
 AND L.VDT <= @ENDDT + ' 23:59:59'                                
 AND C.PARENTCODE >= @FROMPARTY                                
 AND C.PARENTCODE <= @TOPARTY                                
                                
---------------------------------------------------------------------------------------------------------------                      
-- MCDX                      
                      
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                               
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'MCDX',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                                
  FROM                                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                    
   INNER JOIN                                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE >= @FROMPARTY                                
   AND C.PARENTCODE <= @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                            
 CQL_ACNAME                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'MCDX',                                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),               
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                
FROM                                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 INNER JOIN                    
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT >=  @STARTDT                                
 AND L.VDT <= @ENDDT + ' 23:59:59'                                
 AND C.PARENTCODE >= @FROMPARTY                                
 AND C.PARENTCODE <= @TOPARTY                                
                        
        
        
---------------------------------------------------------------------------------------------------------------                      
-- BSEFO                      
                      
SELECT                                
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                             
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'BSEFO',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                       
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'BSEFO',                                 
 L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                             
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
 INTO #TEMP2                               
FROM                                
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 --INNER JOIN                    
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
               
               
               
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT ,                                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT ,                                
 CQL_VTYPE ,                          
 CQL_VNO ,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS ,                                
 CQL_DDNO = '',                                
 CQL_DEBIT ,                            
 CQL_CREDIT ,                                
 CQL_BALANCE ,                                
 CQL_ORDERBY ,                                
 VDT,                                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                 
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE               
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
                
                
  DROP TABLE #TEMP2             
          
        
---------------------------------------------------------------------------------------------------------------                      
-- MCDXCDS                      
                      
SELECT                                
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                                
 CQL_ACNAME                                
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'MCDXCDS',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT = 'MCDXCDS',                                 
 L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                             
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
 INTO #TEMP1                                
FROM                                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 --INNER JOIN                    
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                      
               
               
               
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT ,                                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT ,                                
 CQL_VTYPE ,                                
 CQL_VNO ,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS ,                                
 CQL_DDNO = '',                                
 CQL_DEBIT ,                            
 CQL_CREDIT ,                                
 CQL_BALANCE ,                                
 CQL_ORDERBY ,                                
 VDT,                                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                 
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE               
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
                
                
 DROP TABLE #TEMP1              
               
                
                      
                      
--------------------------------------------------------------------------------------------------------------                      
-- NSECURFO                      
                      
SELECT                                 
 @@SDTCUR = SDTCUR                                 
FROM                                 
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                               
WHERE                                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                                
                                
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                                 
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                                
 SUM(CQL_BALANCE),                                
 CQL_ORDERBY,                                
 19000101,                 
 CQL_ACNAME                  
FROM                                 
 (                                
  SELECT                                 
   CQL_SEGMENT = 'NSECURFO',                                 
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
   CQL_VDT = '',                                
   CQL_VTYPE = '',                                
   CQL_VNO = '',                                
   CQL_ACCODE = '',                                
   CQL_REMARKS = 'OPENING BALANCE',                                
   CQL_DDNO = '',                                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
   CQL_ORDERBY = 5,                                
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                                
  FROM                                
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                 
   INNER JOIN                                
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
   INNER JOIN                    
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
  WHERE                                 
   L.VDT >= @@SDTCUR                                
   AND L.VDT < @STARTDT                                
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
 ) X                                
GROUP BY                                
 CQL_SEGMENT,                                
 CQL_PARTYCODE,                                
 CQL_VDT,                                
 CQL_VTYPE,                                
 CQL_VNO,                                
 CQL_ACCODE,                                
 CQL_REMARKS,                                
 CQL_DDNO,                                
 CQL_ORDERBY,                                
 CQL_ACNAME                                
               
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
SELECT                          
 CQL_SEGMENT = 'NSECURFO',                                 
 --- CQL_PARTYCODE = C.PARENTCODE,       
 L.CLTCODE,                                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                                
 CQL_VNO = L.VNO,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS = L.NARRATION,                                
 CQL_DDNO = '',                                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                                
 CQL_ORDERBY = 6,                                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                              
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                                
 INTO #TEMP3      
FROM                                
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                                 
 INNER JOIN                                
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                                
 LEFT OUTER JOIN                                 
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                                
 --INNER JOIN                    
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                    
WHERE                                 
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                                
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY         
       
                
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                                
 SELECT                                 
 CQL_SEGMENT ,                                 
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                                
 CQL_VDT ,                                
 CQL_VTYPE ,                                
 CQL_VNO ,                                
 CQL_ACCODE = '',                                
 CQL_REMARKS ,                                
 CQL_DDNO = '',                                
 CQL_DEBIT ,                            
 CQL_CREDIT ,                                
 CQL_BALANCE ,                                
 CQL_ORDERBY ,                                
 VDT,                                
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                 
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE               
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
                
                
 DROP TABLE #TEMP3          
                              
                      
-------------------------------------------------------------------------------------------------------------------                                                      
/*============================================================================================================*/                              
/*                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
SELECT                                 
 Q.*,                                
 CQL_ADD1 = C.L_ADDRESS1,                                
 CQL_ADD2 = C.L_ADDRESS2,                                
 CQL_ADD3 = C.L_ADDRESS3,                                
 CQL_CITY = C.L_CITY,                                
 CQL_ZIP = C.L_ZIP,                                
 CQL_PHONE = C.RES_PHONE1,                                
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                                
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                                
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                                
FROM                                 
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                                
 INNER JOIN                                
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                                
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                                
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                            
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                                
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                                
ORDER BY                                 
 Q.CQL_PARTYCODE,                                
 Q.CQL_ORDERBY,                                
 Q.CQL_DT                  
*/                                          
                            
DELETE FROM V2_CLASS_QUARTERLYLEDGER                            
WHERE CQL_DEBIT = 0                            
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_27122017
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_27122017]                            
(                            
 @STARTDT VARCHAR(11),                            
 @ENDDT VARCHAR(11),                            
 @FROMPARTY VARCHAR(10),                            
 @TOPARTY VARCHAR(10),                
 @FROMBRANCH VARCHAR(15) = '',                
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                
 @FROMSUBBROKER VARCHAR(15) = '',                
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                
 @RPT_FILTER INT = 0                
)                            
                            
/*                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                            
*/                            
                            
AS                            
                            
SET NOCOUNT ON                            
                            
/*                            
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                            
(                            
 CQL_ID BIGINT IDENTITY(1,1),                            
 CQL_SEGMENT VARCHAR(20),                            
 CQL_PARTYCODE VARCHAR(10),                            
 CQL_VDT VARCHAR(20),                            
 CQL_VTYPE VARCHAR(10),                            
 CQL_VNO VARCHAR(20),                            
 CQL_ACCODE VARCHAR(10),                            
 CQL_REMARKS VARCHAR(255),                            
 CQL_DDNO VARCHAR(20),                            
 CQL_DEBIT MONEY,                            
 CQL_CREDIT MONEY,                            
 CQL_BALANCE MONEY,                            
 CQL_ORDERBY TINYINT,                            
 CQL_DT INT,                             
 CQL_ACNAME VARCHAR(100)                            
)                            
*/                            
                            
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
DECLARE @@SDTCUR DATETIME                
                            
/* NOW DOING NSECM */                
                
IF (@TOBRANCH = '')                
BEGIN                
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                
END                
                
IF (@TOSUBBROKER = '')                
BEGIN                
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                
END                
                
CREATE TABLE #CLIENTMASTER                
 (                
 PARTY_CODE VARCHAR(15),                
 PARTYNAME VARCHAR(100),                
 PARENTCODE VARCHAR(15),                
 BRANCH_CD VARCHAR(15),                
 SUB_BROKER VARCHAR(15)                
 )   
 
           
                
IF (@RPT_FILTER = 0)                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
 WHERE                
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
ELSE                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = C.CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                
 WHERE                
  T.PARTY_CODE = C.PARTY_CODE                
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
                
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM              
 ANAND1.ACCOUNT.DBO.PARAMETER                       
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                     
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                    
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECM',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 1,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
   --AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
 
 CREATE INDEX PARTY ON  #CLIENTMASTER
 (PARTY_CODE )
 
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
                      
SELECT                             
 CQL_SEGMENT = 'NSECM',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 2,                 
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                           
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP                       
FROM                            
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')              
 --AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
            
            
            
            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                              
 CQL_SEGMENT ,                          
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO,                            
 CQL_ACCODE ,                            
 CQL_REMARKS,            
 CQL_DDNO ,                            
 CQL_DEBIT ,                            
 CQL_CREDIT,                            
 CQL_BALANCE ,                 
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME = C.PARTYNAME              
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY             
            
DROP TABLE   #TEMP            
               
                            
/* NOW DOING BSECM */                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND.ACCOUNT_AB.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'BSECM',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSECM',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
 
 
 --------NOW FOR MTF-----
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.MTFTRADE.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,               
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'MTF',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MTF',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
  ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            

----------------END MTF-----------------                          
                           
                            
/* NOW DOING NSEFO */    


 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER
 (
	PARTY_CODE
 )                          
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR      
FROM                             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,           
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                      
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NSEFO',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
 INNER JOIN                            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
/*===========================================================================================================                           
--------------------------------------------------------------------------------------------------------------------                  
-- NCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                       
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                      
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                            
---------------------------------------------------------------------------------------------------------------                  
-- MCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                           
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                        
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
     */                       
    
    
---------------------------------------------------------------------------------------------------------------                  
-- BSEFO                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                         
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'BSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSEFO',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP2                           
FROM                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                      
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
  DROP TABLE #TEMP2         
      
    
---------------------------------------------------------------------------------------------------------------                  
-- MCDXCDS                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDXCDS',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDXCDS',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP1                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP1          
           
            
                  
                  
--------------------------------------------------------------------------------------------------------------                  
-- NSECURFO                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,             
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECURFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                      
 CQL_SEGMENT = 'NSECURFO',                             
 --- CQL_PARTYCODE = C.PARENTCODE,   
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                          
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
 INTO #TEMP3  
FROM                            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY     
   
            
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
 SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP3      
                          
                  
-------------------------------------------------------------------------------------------------------------------                                                  
/*============================================================================================================*/                          
/*                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 Q.*,                            
 CQL_ADD1 = C.L_ADDRESS1,                            
 CQL_ADD2 = C.L_ADDRESS2,                            
 CQL_ADD3 = C.L_ADDRESS3,                            
 CQL_CITY = C.L_CITY,                            
 CQL_ZIP = C.L_ZIP,                            
 CQL_PHONE = C.RES_PHONE1,                            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                            
FROM                             
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                            
 INNER JOIN                            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                            
ORDER BY                             
 Q.CQL_PARTYCODE,                            
 Q.CQL_ORDERBY,                            
 Q.CQL_DT              
*/                                      
                        
DELETE FROM V2_CLASS_QUARTERLYLEDGER                        
WHERE CQL_DEBIT = 0                        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_BAK_AUG162013
-- --------------------------------------------------
CREATE PROC [DBO].[V2_PROC_QUARTERLYLEDGER_NEW_BAK_AUG162013]              
(              
 @STARTDT VARCHAR(11),              
 @ENDDT VARCHAR(11),              
 @FROMPARTY VARCHAR(10),              
 @TOPARTY VARCHAR(10),  
 @FROMBRANCH VARCHAR(15) = '',  
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',  
 @FROMSUBBROKER VARCHAR(15) = '',  
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',  
 @RPT_FILTER INT = 0  
)              
              
/*              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'              
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'              
*/              
              
AS              
              
SET NOCOUNT ON              
              
/*              
CREATE TABLE V2_CLASS_QUARTERLYLEDGER              
(              
 CQL_ID BIGINT IDENTITY(1,1),              
 CQL_SEGMENT VARCHAR(20),              
 CQL_PARTYCODE VARCHAR(10),              
 CQL_VDT VARCHAR(20),              
 CQL_VTYPE VARCHAR(10),              
 CQL_VNO VARCHAR(20),              
 CQL_ACCODE VARCHAR(10),              
 CQL_REMARKS VARCHAR(255),              
 CQL_DDNO VARCHAR(20),              
 CQL_DEBIT MONEY,              
 CQL_CREDIT MONEY,              
 CQL_BALANCE MONEY,              
 CQL_ORDERBY TINYINT,              
 CQL_DT INT,               
 CQL_ACNAME VARCHAR(100)              
)              
*/              
              
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER  
DECLARE @@SDTCUR DATETIME  
              
/* NOW DOING NSECM */  
  
IF (@TOBRANCH = '')  
BEGIN  
 SET @TOBRANCH  = 'ZZZZZZZZZZ'  
END  
  
IF (@TOSUBBROKER = '')  
BEGIN  
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'  
END  
  
CREATE TABLE #CLIENTMASTER  
 (  
 PARTY_CODE VARCHAR(15),  
 PARTYNAME VARCHAR(100),  
 PARENTCODE VARCHAR(15),  
 BRANCH_CD VARCHAR(15),  
 SUB_BROKER VARCHAR(15)  
 )  
  
IF (@RPT_FILTER = 0)  
BEGIN  
 INSERT INTO #CLIENTMASTER  
 SELECT  
  DISTINCT  
  PARTY_CODE = CL_CODE,  
  PARTYNAME='',  
  PARENTCODE,  
  BRANCH_CD,  
  SUB_BROKER  
 FROM  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)  
 WHERE  
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH  
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER  
END  
ELSE  
BEGIN  
 INSERT INTO #CLIENTMASTER  
 SELECT  
  DISTINCT  
  PARTY_CODE = C.CL_CODE,  
  PARTYNAME='',  
  PARENTCODE,  
  BRANCH_CD,  
  SUB_BROKER  
 FROM  
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)  
 WHERE  
  T.PARTY_CODE = C.PARTY_CODE  
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH  
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER  
END  
  
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)  
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE  
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND1.ACCOUNT.DBO.PARAMETER         
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSECM',               
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 1,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)               
   INNER JOIN              
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))  
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND1.ACCOUNT.DBO.PARAMETER               
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NSECM',               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 2,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
              
              
/* NOW DOING BSECM */              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANAND.ACCOUNT_AB.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'BSECM',               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,      
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 3,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)               
   INNER JOIN              
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'BSECM',               
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 4,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
              
/* NOW DOING NSEFO */              
              
              
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELFO.ACCOUNTFO.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSEFO',               
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)  
   INNER JOIN              
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NSEFO',               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,  
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME  
FROM              
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)  
 INNER JOIN              
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
              
/*===========================================================================================================             
--------------------------------------------------------------------------------------------------------------------    
-- NCDX    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NCDX',               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)  
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NCDX',               
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)  
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
              
---------------------------------------------------------------------------------------------------------------    
-- MCDX    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,             
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'MCDX',               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)  
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'MCDX',               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
     */         
---------------------------------------------------------------------------------------------------------------    
-- MCDXCDS    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'MCDXCDS',               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)               
   INNER JOIN              
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'MCDXCDS',               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY      
    
    
--------------------------------------------------------------------------------------------------------------    
-- NSECURFO    
    
SELECT               
 @@SDTCUR = SDTCUR               
FROM               
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER             
WHERE              
 @STARTDT BETWEEN SDTCUR AND LDTCUR              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),              
 SUM(CQL_BALANCE),              
 CQL_ORDERBY,              
 19000101,              
 CQL_ACNAME              
FROM               
 (              
  SELECT               
   CQL_SEGMENT = 'NSECURFO',               
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
   CQL_VDT = '',              
   CQL_VTYPE = '',              
   CQL_VNO = '',              
   CQL_ACCODE = '',              
   CQL_REMARKS = 'OPENING BALANCE',              
   CQL_DDNO = '',              
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
   CQL_ORDERBY = 5,              
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
  FROM              
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)               
   INNER JOIN              
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN  
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
  WHERE               
   L.VDT >= @@SDTCUR              
   AND L.VDT < @STARTDT              
   AND C.PARENTCODE >= @FROMPARTY              
   AND C.PARENTCODE <= @TOPARTY              
 ) X              
GROUP BY              
 CQL_SEGMENT,              
 CQL_PARTYCODE,              
 CQL_VDT,              
 CQL_VTYPE,              
 CQL_VNO,              
 CQL_ACCODE,              
 CQL_REMARKS,              
 CQL_DDNO,              
 CQL_ORDERBY,              
 CQL_ACNAME              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYLEDGER              
SELECT               
 CQL_SEGMENT = 'NSECURFO',               
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),              
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,              
 CQL_ACCODE = '',              
 CQL_REMARKS = L.NARRATION,              
 CQL_DDNO = '',              
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),              
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),              
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),              
 CQL_ORDERBY = 6,              
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),              
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
FROM              
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)               
 INNER JOIN              
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))              
 LEFT OUTER JOIN               
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN  
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)  
WHERE               
 L.VDT >=  @STARTDT              
 AND L.VDT <= @ENDDT + ' 23:59:59'              
 AND C.PARENTCODE >= @FROMPARTY              
 AND C.PARENTCODE <= @TOPARTY              
    
-------------------------------------------------------------------------------------------------------------------                                    
/*============================================================================================================*/            
/*              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
SELECT               
 Q.*,              
 CQL_ADD1 = C.L_ADDRESS1,              
 CQL_ADD2 = C.L_ADDRESS2,              
 CQL_ADD3 = C.L_ADDRESS3,              
 CQL_CITY = C.L_CITY,              
 CQL_ZIP = C.L_ZIP,              
 CQL_PHONE = C.RES_PHONE1,              
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',              
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',              
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'              
FROM               
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)              
 INNER JOIN              
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)              
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)              
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)              
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)              
 ON (Q.CQL_PARTYCODE = C.CL_CODE)              
ORDER BY               
 Q.CQL_PARTYCODE,              
 Q.CQL_ORDERBY,              
 Q.CQL_DT  
*/                        
          
DELETE FROM V2_CLASS_QUARTERLYLEDGER          
WHERE CQL_DEBIT = 0          
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_new_BAKJAN292016
-- --------------------------------------------------
CREATE PROC [DBO].[V2_PROC_QUARTERLYLEDGER_NEW]                          
(                          
 @STARTDT VARCHAR(11),                          
 @ENDDT VARCHAR(11),                          
 @FROMPARTY VARCHAR(10),                          
 @TOPARTY VARCHAR(10),              
 @FROMBRANCH VARCHAR(15) = '',              
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',              
 @FROMSUBBROKER VARCHAR(15) = '',              
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',              
 @RPT_FILTER INT = 0              
)                          
                          
/*                          
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                          
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                          
*/                          
                          
AS                          
                          
SET NOCOUNT ON                          
                          
/*                          
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                          
(                          
 CQL_ID BIGINT IDENTITY(1,1),                          
 CQL_SEGMENT VARCHAR(20),                          
 CQL_PARTYCODE VARCHAR(10),                          
 CQL_VDT VARCHAR(20),                          
 CQL_VTYPE VARCHAR(10),                          
 CQL_VNO VARCHAR(20),                          
 CQL_ACCODE VARCHAR(10),                          
 CQL_REMARKS VARCHAR(255),                          
 CQL_DDNO VARCHAR(20),                          
 CQL_DEBIT MONEY,                          
 CQL_CREDIT MONEY,                          
 CQL_BALANCE MONEY,                          
 CQL_ORDERBY TINYINT,                          
 CQL_DT INT,                           
 CQL_ACNAME VARCHAR(100)                          
)                          
*/                          
                          
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER              
DECLARE @@SDTCUR DATETIME              
                          
/* NOW DOING NSECM */              
              
IF (@TOBRANCH = '')              
BEGIN              
 SET @TOBRANCH  = 'ZZZZZZZZZZ'              
END              
              
IF (@TOSUBBROKER = '')              
BEGIN              
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'              
END              
              
CREATE TABLE #CLIENTMASTER              
 (              
 PARTY_CODE VARCHAR(15),              
 PARTYNAME VARCHAR(100),              
 PARENTCODE VARCHAR(15),              
 BRANCH_CD VARCHAR(15),              
 SUB_BROKER VARCHAR(15)              
 )              
              
IF (@RPT_FILTER = 0)              
BEGIN              
 INSERT INTO #CLIENTMASTER              
 SELECT              
  DISTINCT              
  PARTY_CODE = CL_CODE,              
  PARTYNAME='',              
  PARENTCODE,              
  BRANCH_CD,              
  SUB_BROKER              
 FROM              
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)              
 WHERE              
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH              
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER              
END              
ELSE              
BEGIN              
 INSERT INTO #CLIENTMASTER              
 SELECT              
  DISTINCT              
  PARTY_CODE = C.CL_CODE,              
  PARTYNAME='',              
  PARENTCODE,              
  BRANCH_CD,              
  SUB_BROKER              
 FROM              
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),              
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)              
 WHERE              
  T.PARTY_CODE = C.PARTY_CODE              
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY              
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH              
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER              
END              
              
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)              
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE              
                          
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM            
 ANAND1.ACCOUNT.DBO.PARAMETER                     
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                   
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                  
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'NSECM',                           
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                          
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 1,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                           
   INNER JOIN                          
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')              
   --AND A.ACCAT IN ('4','104','204'))              
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
                          
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANAND1.ACCOUNT.DBO.PARAMETER                           
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                    
SELECT                           
 CQL_SEGMENT = 'NSECM',                           
 L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 2,               
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                         
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME              
 INTO #TEMP                     
FROM                          
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')            
 --AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                          
 --INNER JOIN              
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                              
          
          
          
          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                            
 CQL_SEGMENT ,                        
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT ,                          
 CQL_VTYPE ,                          
 CQL_VNO,                          
 CQL_ACCODE ,                          
 CQL_REMARKS,          
 CQL_DDNO ,                          
 CQL_DEBIT ,                          
 CQL_CREDIT,                          
 CQL_BALANCE ,               
 CQL_ORDERBY ,                          
 VDT,                          
 CQL_ACNAME = C.PARTYNAME            
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE          
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY           
          
DROP TABLE   #TEMP          
             
                          
/* NOW DOING BSECM */                          
                          
                          
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANAND.ACCOUNT_AB.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'BSECM',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                  
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),   
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 3,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                           
   INNER JOIN                          
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')         
 --AND A.ACCAT IN ('4','104','204')            
   INNER JOIN              
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                     
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'BSECM',                           
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),            
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 4,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                          
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
FROM                          
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                          
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                          
 --AND A.ACCAT IN ('4','104','204')            
 LEFT OUTER JOIN                           
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 INNER JOIN              
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
                          
/* NOW DOING NSEFO */                          
                          
                          
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'NSEFO',                           
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,         
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)              
   INNER JOIN                          
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                    
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'NSEFO',                           
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,              
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME              
FROM                          
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)              
 INNER JOIN                          
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 INNER JOIN              
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
                          
/*===========================================================================================================                         
--------------------------------------------------------------------------------------------------------------------                
-- NCDX                
                
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                     
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                    
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'NCDX',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)              
   INNER JOIN                          
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE >= @FROMPARTY                          
   AND C.PARENTCODE <= @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'NCDX',                           
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                      
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                          
FROM                          
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)              
 INNER JOIN              
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT >=  @STARTDT                          
 AND L.VDT <= @ENDDT + ' 23:59:59'                          
 AND C.PARENTCODE >= @FROMPARTY                          
 AND C.PARENTCODE <= @TOPARTY                          
                          
---------------------------------------------------------------------------------------------------------------                
-- MCDX                
                
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                         
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'MCDX',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                          
  FROM                          
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)              
   INNER JOIN                          
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE >= @FROMPARTY                          
   AND C.PARENTCODE <= @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                      
 CQL_ACNAME                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'MCDX',                           
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                          
FROM                          
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 INNER JOIN              
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT >=  @STARTDT                          
 AND L.VDT <= @ENDDT + ' 23:59:59'                          
 AND C.PARENTCODE >= @FROMPARTY                          
 AND C.PARENTCODE <= @TOPARTY                          
     */                     
  
  
---------------------------------------------------------------------------------------------------------------                
-- BSEFO                
                
SELECT                          
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                      
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                       
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'BSEFO',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                           
   INNER JOIN                          
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'BSEFO',                           
 L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                       
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME        
 INTO #TEMP2                         
FROM                          
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 --INNER JOIN              
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
         
         
         
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT ,                           
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT ,                          
 CQL_VTYPE ,                    
 CQL_VNO ,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS ,                          
 CQL_DDNO = '',                          
 CQL_DEBIT ,                      
 CQL_CREDIT ,                          
 CQL_BALANCE ,                          
 CQL_ORDERBY ,                          
 VDT,                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME           
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE         
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY          
          
          
  DROP TABLE #TEMP2       
    
  
---------------------------------------------------------------------------------------------------------------                
-- MCDXCDS                
                
SELECT                          
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                      
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,                          
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'MCDXCDS',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                           
   INNER JOIN                          
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'MCDXCDS',                           
 L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                       
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME        
 INTO #TEMP1                          
FROM                          
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 --INNER JOIN              
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
         
         
         
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT ,                           
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT ,                          
 CQL_VTYPE ,                          
 CQL_VNO ,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS ,                          
 CQL_DDNO = '',                          
 CQL_DEBIT ,                      
 CQL_CREDIT ,                          
 CQL_BALANCE ,                          
 CQL_ORDERBY ,                          
 VDT,                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME           
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE         
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY          
          
          
 DROP TABLE #TEMP1        
         
          
                
                
--------------------------------------------------------------------------------------------------------------                
-- NSECURFO                
                
SELECT                           
 @@SDTCUR = SDTCUR                           
FROM                           
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                         
WHERE                          
 @STARTDT BETWEEN SDTCUR AND LDTCUR                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                          
 SUM(CQL_BALANCE),                          
 CQL_ORDERBY,                          
 19000101,           
 CQL_ACNAME                          
FROM                           
 (                          
  SELECT                           
   CQL_SEGMENT = 'NSECURFO',                           
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
   CQL_VDT = '',                          
   CQL_VTYPE = '',                          
   CQL_VNO = '',                          
   CQL_ACCODE = '',                          
   CQL_REMARKS = 'OPENING BALANCE',                          
   CQL_DDNO = '',                          
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
   CQL_ORDERBY = 5,                          
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                          
  FROM                          
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                           
   INNER JOIN                          
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
   INNER JOIN              
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
  WHERE                           
   L.VDT >= @@SDTCUR                          
   AND L.VDT < @STARTDT                          
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                          
 ) X                          
GROUP BY                          
 CQL_SEGMENT,                          
 CQL_PARTYCODE,                          
 CQL_VDT,                          
 CQL_VTYPE,                          
 CQL_VNO,                          
 CQL_ACCODE,                          
 CQL_REMARKS,                          
 CQL_DDNO,                          
 CQL_ORDERBY,                          
 CQL_ACNAME                          
                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
SELECT                           
 CQL_SEGMENT = 'NSECURFO',                           
 --- CQL_PARTYCODE = C.PARENTCODE, 
 L.CLTCODE,                          
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                          
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                          
 CQL_VNO = L.VNO,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS = L.NARRATION,                          
 CQL_DDNO = '',                          
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                          
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                          
 CQL_ORDERBY = 6,                          
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                        
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                          
 INTO #TEMP3
FROM                          
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                           
 INNER JOIN                          
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                          
 LEFT OUTER JOIN                           
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                          
 --INNER JOIN              
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)              
WHERE                           
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                          
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY   
 
          
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                          
	SELECT                           
 CQL_SEGMENT ,                           
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                          
 CQL_VDT ,                          
 CQL_VTYPE ,                          
 CQL_VNO ,                          
 CQL_ACCODE = '',                          
 CQL_REMARKS ,                          
 CQL_DDNO = '',                          
 CQL_DEBIT ,                      
 CQL_CREDIT ,                          
 CQL_BALANCE ,                          
 CQL_ORDERBY ,                          
 VDT,                          
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME           
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE         
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY          
          
          
 DROP TABLE #TEMP3    
                        
                
-------------------------------------------------------------------------------------------------------------------                                                
/*============================================================================================================*/                        
/*                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SELECT                           
 Q.*,                          
 CQL_ADD1 = C.L_ADDRESS1,                          
 CQL_ADD2 = C.L_ADDRESS2,                          
 CQL_ADD3 = C.L_ADDRESS3,                          
 CQL_CITY = C.L_CITY,                          
 CQL_ZIP = C.L_ZIP,                          
 CQL_PHONE = C.RES_PHONE1,                          
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                          
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                          
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                          
FROM                           
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                          
 INNER JOIN                          
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                          
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                          
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                          
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                          
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                          
ORDER BY                           
 Q.CQL_PARTYCODE,                          
 Q.CQL_ORDERBY,                          
 Q.CQL_DT            
*/                                    
                      
DELETE FROM V2_CLASS_QUARTERLYLEDGER                      
WHERE CQL_DEBIT = 0                      
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_BKP_08082017
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW]                            
(                            
 @STARTDT VARCHAR(11),                            
 @ENDDT VARCHAR(11),                            
 @FROMPARTY VARCHAR(10),                            
 @TOPARTY VARCHAR(10),                
 @FROMBRANCH VARCHAR(15) = '',                
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                
 @FROMSUBBROKER VARCHAR(15) = '',                
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                
 @RPT_FILTER INT = 0                
)                            
                            
/*                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                            
*/                            
                            
AS                            
                            
SET NOCOUNT ON                            
                            
/*                            
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                            
(                            
 CQL_ID BIGINT IDENTITY(1,1),                            
 CQL_SEGMENT VARCHAR(20),                            
 CQL_PARTYCODE VARCHAR(10),                            
 CQL_VDT VARCHAR(20),                            
 CQL_VTYPE VARCHAR(10),                            
 CQL_VNO VARCHAR(20),                            
 CQL_ACCODE VARCHAR(10),                            
 CQL_REMARKS VARCHAR(255),                            
 CQL_DDNO VARCHAR(20),                            
 CQL_DEBIT MONEY,                            
 CQL_CREDIT MONEY,                            
 CQL_BALANCE MONEY,                            
 CQL_ORDERBY TINYINT,                            
 CQL_DT INT,                             
 CQL_ACNAME VARCHAR(100)                            
)                            
*/                            
                            
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
DECLARE @@SDTCUR DATETIME                
                            
/* NOW DOING NSECM */                
                
IF (@TOBRANCH = '')                
BEGIN                
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                
END                
                
IF (@TOSUBBROKER = '')                
BEGIN                
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                
END                
                
CREATE TABLE #CLIENTMASTER                
 (                
 PARTY_CODE VARCHAR(15),                
 PARTYNAME VARCHAR(100),                
 PARENTCODE VARCHAR(15),                
 BRANCH_CD VARCHAR(15),                
 SUB_BROKER VARCHAR(15)                
 )   
 
           
                
IF (@RPT_FILTER = 0)                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
 WHERE                
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
ELSE                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = C.CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                
 WHERE                
  T.PARTY_CODE = C.PARTY_CODE                
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
                
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM              
 ANAND1.ACCOUNT.DBO.PARAMETER                       
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                     
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                    
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECM',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 1,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
   --AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
                      
SELECT                             
 CQL_SEGMENT = 'NSECM',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 2,                 
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                           
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP                       
FROM                            
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')              
 --AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
            
            
            
            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                              
 CQL_SEGMENT ,                          
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO,                            
 CQL_ACCODE ,                            
 CQL_REMARKS,            
 CQL_DDNO ,                            
 CQL_DEBIT ,                            
 CQL_CREDIT,                            
 CQL_BALANCE ,                 
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME = C.PARTYNAME              
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY             
            
DROP TABLE   #TEMP            
               
                            
/* NOW DOING BSECM */                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND.ACCOUNT_AB.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'BSECM',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSECM',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
 
 
                           
                            
/* NOW DOING NSEFO */    


 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER
 (
	PARTY_CODE
 )                          
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR      
FROM                             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,           
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                      
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NSEFO',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
 INNER JOIN                            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
/*===========================================================================================================                           
--------------------------------------------------------------------------------------------------------------------                  
-- NCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                       
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                      
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                            
---------------------------------------------------------------------------------------------------------------                  
-- MCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                           
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                        
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
     */                       
    
    
---------------------------------------------------------------------------------------------------------------                  
-- BSEFO                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                         
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'BSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSEFO',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP2                           
FROM                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                      
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
  DROP TABLE #TEMP2         
      
    
---------------------------------------------------------------------------------------------------------------                  
-- MCDXCDS                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDXCDS',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDXCDS',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP1                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP1          
           
            
                  
                  
--------------------------------------------------------------------------------------------------------------                  
-- NSECURFO                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,             
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECURFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                      
 CQL_SEGMENT = 'NSECURFO',                             
 --- CQL_PARTYCODE = C.PARENTCODE,   
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                          
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
 INTO #TEMP3  
FROM                            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY     
   
            
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
 SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP3      
                          
                  
-------------------------------------------------------------------------------------------------------------------                                                  
/*============================================================================================================*/                          
/*                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 Q.*,                            
 CQL_ADD1 = C.L_ADDRESS1,                            
 CQL_ADD2 = C.L_ADDRESS2,                            
 CQL_ADD3 = C.L_ADDRESS3,                            
 CQL_CITY = C.L_CITY,                            
 CQL_ZIP = C.L_ZIP,                            
 CQL_PHONE = C.RES_PHONE1,                            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                            
FROM                             
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                            
 INNER JOIN                            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                            
ORDER BY                             
 Q.CQL_PARTYCODE,                            
 Q.CQL_ORDERBY,                            
 Q.CQL_DT              
*/                                      
                        
DELETE FROM V2_CLASS_QUARTERLYLEDGER                        
WHERE CQL_DEBIT = 0                        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_NEW_ORG
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_NEW_ORG]                            
(                            
 @STARTDT VARCHAR(11),                            
 @ENDDT VARCHAR(11),                            
 @FROMPARTY VARCHAR(10),                            
 @TOPARTY VARCHAR(10),                
 @FROMBRANCH VARCHAR(15) = '',                
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                
 @FROMSUBBROKER VARCHAR(15) = '',                
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                
 @RPT_FILTER INT = 0                
)                            
                            
/*                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                            
*/                            
                            
AS                            
                            
SET NOCOUNT ON                            
                            
/*                            
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                            
(                            
 CQL_ID BIGINT IDENTITY(1,1),                            
 CQL_SEGMENT VARCHAR(20),                            
 CQL_PARTYCODE VARCHAR(10),                            
 CQL_VDT VARCHAR(20),                            
 CQL_VTYPE VARCHAR(10),                            
 CQL_VNO VARCHAR(20),                            
 CQL_ACCODE VARCHAR(10),                            
 CQL_REMARKS VARCHAR(255),                            
 CQL_DDNO VARCHAR(20),                            
 CQL_DEBIT MONEY,                            
 CQL_CREDIT MONEY,                            
 CQL_BALANCE MONEY,                            
 CQL_ORDERBY TINYINT,                            
 CQL_DT INT,                             
 CQL_ACNAME VARCHAR(100)                            
)                            
*/                            
                            
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
DECLARE @@SDTCUR DATETIME                
                            
/* NOW DOING NSECM */                
                
IF (@TOBRANCH = '')                
BEGIN                
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                
END                
                
IF (@TOSUBBROKER = '')                
BEGIN                
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                
END                
                
CREATE TABLE #CLIENTMASTER                
 (                
 PARTY_CODE VARCHAR(15),                
 PARTYNAME VARCHAR(100),                
 PARENTCODE VARCHAR(15),                
 BRANCH_CD VARCHAR(15),                
 SUB_BROKER VARCHAR(15)                
 )   
 
 /* optimization by Siva */

SELECT DISTINCT PARTY_CODE     
 INTO #PARTY    
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)    
WHERE --INACTIVE_DATE > GETDATE () AND 
LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )     
     
union 
  
SELECT DISTINCT PARTY_CODE     
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)     
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @ENDDT )    

/*************/

--SELECT * FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE PARTY_CODE='GRGN6062'

 CREATE INDEX PARTY ON  #PARTY
 (PARTY_CODE )


 CREATE INDEX PARTY ON  #CLIENTMASTER
 (PARTY_CODE )


           
                
IF (@RPT_FILTER = 0)                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
 WHERE                
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER     
  AND CL_CODE IN (SELECT * FROM #PARTY)
             
END                
ELSE                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = C.CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                
 WHERE                
  T.PARTY_CODE = C.PARTY_CODE       
 AND C.PARTY_CODE IN (SELECT * FROM #PARTY)         
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
                
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM              
 ANAND1.ACCOUNT.DBO.PARAMETER                       
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                     
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                    
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECM',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 1,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
   --AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
 

 
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
                      
SELECT                             
 CQL_SEGMENT = 'NSECM',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 2,                 
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                           
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP                       
FROM                            
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')              
 --AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
            
            
            
            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                  
SELECT                              
 CQL_SEGMENT ,                          
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO,                            
 CQL_ACCODE ,                            
 CQL_REMARKS,            
 CQL_DDNO ,                            
 CQL_DEBIT ,                            
 CQL_CREDIT,                            
 CQL_BALANCE ,                 
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME = C.PARTYNAME              
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY             
            
DROP TABLE   #TEMP            
               
                            
/* NOW DOING BSECM */                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND.ACCOUNT_AB.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'BSECM',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSECM',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANAND.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
 ANAND.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
 ANAND.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY  
 
 
 --------NOW FOR MTF-----
 
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.MTFTRADE.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,               
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'MTF',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
    ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MTF',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
  ANAND1.MTFTRADE.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
  ANAND1.MTFTRADE.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
  ANAND1.MTFTRADE.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            

----------------END MTF-----------------                          
                           
                            
/* NOW DOING NSEFO */    


 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER
 (
	PARTY_CODE
 )                          
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR      
FROM                             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,           
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                      
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NSEFO',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
 INNER JOIN                            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
/*===========================================================================================================                           
--------------------------------------------------------------------------------------------------------------------                  
-- NCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                       
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                      
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                            
---------------------------------------------------------------------------------------------------------------                  
-- MCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                           
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                        
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
     */                       
    
    
---------------------------------------------------------------------------------------------------------------                  
-- BSEFO                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                         
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'BSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSEFO',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP2                           
FROM                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                      
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
  DROP TABLE #TEMP2         
      
    
---------------------------------------------------------------------------------------------------------------                  
-- MCDXCDS                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDXCDS',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDXCDS',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP1                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP1          
           
            
                  
                  
--------------------------------------------------------------------------------------------------------------                  
-- NSECURFO                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,             
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECURFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--- INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
SELECT                      
 CQL_SEGMENT = 'NSECURFO',                             
 --- CQL_PARTYCODE = C.PARENTCODE,   
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                          
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
 INTO #TEMP3  
FROM                            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY     
   
            
 INSERT INTO V2_CLASS_QUARTERLYLEDGER                            
 SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP3      
                          
                  
-------------------------------------------------------------------------------------------------------------------                                                  
/*============================================================================================================*/                          
/*                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 Q.*,                            
 CQL_ADD1 = C.L_ADDRESS1,                            
 CQL_ADD2 = C.L_ADDRESS2,                            
 CQL_ADD3 = C.L_ADDRESS3,                            
 CQL_CITY = C.L_CITY,                            
 CQL_ZIP = C.L_ZIP,                            
 CQL_PHONE = C.RES_PHONE1,                            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                            
FROM                             
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                            
 INNER JOIN                            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                            
ORDER BY                             
 Q.CQL_PARTYCODE,                            
 Q.CQL_ORDERBY,                            
 Q.CQL_DT              
*/                                      
                        
DELETE FROM V2_CLASS_QUARTERLYLEDGER                        
WHERE CQL_DEBIT = 0                        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_ONETIME
-- --------------------------------------------------
CREATE PROC V2_PROC_QUARTERLYLEDGER_ONETIME
(                
 @STARTDT VARCHAR(11),                
 @ENDDT VARCHAR(11),                
 @FROMPARTY VARCHAR(10),                
 @TOPARTY VARCHAR(10)                
)                
                
/*                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                
*/                
                
AS                
                
SET NOCOUNT ON                
                
/*                
CREATE TABLE V2_CLASS_QUARTERLYLEDGER                
(                
 CQL_ID BIGINT IDENTITY(1,1),                
 CQL_SEGMENT VARCHAR(20),                
 CQL_PARTYCODE VARCHAR(10),                
 CQL_VDT VARCHAR(20),                
 CQL_VTYPE VARCHAR(10),                
 CQL_VNO VARCHAR(20),                
 CQL_ACCODE VARCHAR(10),                
 CQL_REMARKS VARCHAR(255),                
 CQL_DDNO VARCHAR(20),                
 CQL_DEBIT MONEY,                
 CQL_CREDIT MONEY,                
 CQL_BALANCE MONEY,                
 CQL_ORDERBY TINYINT,                
 CQL_DT INT,                 
 CQL_ACNAME VARCHAR(100)                
)                
*/                
                
TRUNCATE TABLE V2_CLASS_QUARTERLYLEDGER                
                
DECLARE @@SDTCUR DATETIME                
                
                
/* NOW DOING NSECM */                
  
CREATE TABLE #ACMAST  
(CLTCODE VARCHAR(10))  
  
CREATE CLUSTERED INDEX IDXCL ON #ACMAST(CLTCODE)  
  
INSERT INTO #ACMAST  
SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS  
WHERE PARTY_CODE >= @FROMPARTY AND PARTY_CODE <= @TOPARTY  
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND1.ACCOUNT.DBO.PARAMETER           
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 1,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND1.ACCOUNT.DBO.PARAMETER                 
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER               
SELECT                 
 CQL_SEGMENT = 'NSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 2,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = L.ACNAME                
FROM                
 ANAND1.ACCOUNT.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
                
/* NOW DOING BSECM */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANAND.ACCOUNT_AB.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'BSECM',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 3,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'BSECM',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 4,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME = L.ACNAME                
FROM                
 ANAND.ACCOUNT_AB.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANAND.ACCOUNT_AB.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
/* NOW DOING NSEFO */                
                
                
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELFO.ACCOUNTFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSEFO',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                 
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSEFO',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 ANGELFO.ACCOUNTFO.DBO.LEDGER L (NOLOCK)                 
 INNER JOIN                 
 ANGELFO.ACCOUNTFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
/*===========================================================================================================*/                
--------------------------------------------------------------------------------------------------------------------      
-- NCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NCDX',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NCDX',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L                  
 INNER JOIN                 
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
---------------------------------------------------------------------------------------------------------------      
-- MCDX      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,               
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDX',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)             
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDX',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L                  
 INNER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
                
---------------------------------------------------------------------------------------------------------------      
-- MCDXCDS      
      
SELECT                 
 @@SDTCUR = SDTCUR                 
FROM                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'MCDXCDS',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'MCDXCDS',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L                  
 INNER JOIN                 
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
      
      
--------------------------------------------------------------------------------------------------------------      
-- NSECURFO      
      
SELECT                 
 @@SDTCUR = SDTCUR               
FROM                 
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER               
WHERE                
 @STARTDT BETWEEN SDTCUR AND LDTCUR                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                
 SUM(CQL_BALANCE),                
 CQL_ORDERBY,                
 19000101,                
 CQL_ACNAME                
FROM                 
 (                
  SELECT                 
   CQL_SEGMENT = 'NSECURFO',                 
   CQL_PARTYCODE = L.CLTCODE,                
   CQL_VDT = '',                
   CQL_VTYPE = '',                
   CQL_VNO = '',                
   CQL_ACCODE = '',                
   CQL_REMARKS = 'OPENING BALANCE',                
   CQL_DDNO = '',                
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
   CQL_ORDERBY = 5,                
   CQL_ACNAME = L.ACNAME                
  FROM                
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
  WHERE                 
   L.VDT >= @@SDTCUR                
   AND L.VDT < @STARTDT                
   AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)            
 ) X                
GROUP BY                
 CQL_SEGMENT,                
 CQL_PARTYCODE,                
 CQL_VDT,                
 CQL_VTYPE,                
 CQL_VNO,                
 CQL_ACCODE,                
 CQL_REMARKS,                
 CQL_DDNO,                
 CQL_ORDERBY,                
 CQL_ACNAME                
                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYLEDGER                
SELECT                 
 CQL_SEGMENT = 'NSECURFO',                 
 CQL_PARTYCODE = L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                
 CQL_VNO = L.VNO,                
 CQL_ACCODE = '',                
 CQL_REMARKS = L.NARRATION,                
 CQL_DDNO = '',                
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                
 CQL_ORDERBY = 6,                
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                
 CQL_ACNAME  = L.ACNAME                
FROM                
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L                  
 INNER JOIN                 
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V ON (V.VTYPE = L.VTYP)                
WHERE                 
 L.VDT >=  @STARTDT                
 AND L.VDT <= @ENDDT + ' 23:59:59'                
 AND EXISTS(SELECT CLTCODE FROM #ACMAST A WHERE L.CLTCODE = A.CLTCODE)  
      
-------------------------------------------------------------------------------------------------------------------                                      
/*============================================================================================================*/              
/*                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
SELECT                 
 Q.*,                
 CQL_ADD1 = C.L_ADDRESS1,                
 CQL_ADD2 = C.L_ADDRESS2,                
 CQL_ADD3 = C.L_ADDRESS3,                
 CQL_CITY = C.L_CITY,                
 CQL_ZIP = C.L_ZIP,                
 CQL_PHONE = C.RES_PHONE1,                
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                
FROM                 
 V2_CLASS_QUARTERLYLEDGER Q (NOLOCK)                
 INNER JOIN                
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                
ORDER BY                 
 Q.CQL_PARTYCODE,                
 Q.CQL_ORDERBY,                
 Q.CQL_DT                
    
*/                          
            
DELETE FROM V2_CLASS_QUARTERLYLEDGER            
WHERE CQL_DEBIT = 0            
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP]             
(                      
               @FROMDATE   VARCHAR(11),                      
               @TODATE     VARCHAR(20),                      
               @FROMPARTY  VARCHAR(10),                      
               @TOPARTY    VARCHAR(10),                      
               @FROMSCRIP  VARCHAR(12),                      
               @TOSCRIP    VARCHAR(12)                      
)               
AS            
        
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'JAN  2 2018','MAR 26 2018','A0000','ZZZZZ','00000000','ZZZZZZZZZ'        
        
--- BY DHARMESH ON 14 01 2013        
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (AngelBSECM - 201)        
   
 set @TODATE=@TODATE+ ' 23:50'  
   
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY        
        
 /*       
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (AngelBSECM) SERVER         
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'       
    
*/    
 DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'        
     
    
---DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')        
        
--- SECURITIES DATA COPY FROM DEMAT SERVER         
        
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER        
        
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER        
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER         
         
        
SELECT DISTINCT PARTY_CODE         
 INTO #PARTY        
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)        
WHERE ---- INACTIVE_DATE > GETDATE () AND  removed for getting all balanced clients    
LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )         
         
--- FUNDS & SECURITIES PAYOUT CLIENTS        
        
SELECT DISTINCT PARTY_CODE         
 INTO #PO         
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)         
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )        
        
         
--- BILLS         
        
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE         
 INTO #BILL        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)         
WHERE CQL_VTYPE = 'BILL'         
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )        
        
--- HOLDING         
        
SELECT DISTINCT PARTY_CODE AS PARTY_CODE         
 INTO #HOLD        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)        
WHERE 1 = 1        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )        
        
--- RS 1000.00 DR/CR --        
      
/* ##### CHANGE ON 23/12/2016 ##### */      
        
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL         
 INTO #DRCR        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)         
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )        
GROUP BY CQL_PARTYCODE        
--- HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) > 1000        
ORDER BY CQL_PARTYCODE         
        
---         
        
SELECT *         
 INTO #CL         
FROM        
 (        
 SELECT * FROM #PO         
 UNION        
 SELECT * FROM #BILL        
 UNION        
 SELECT CQL_PARTYCODE FROM #DRCR        
 UNION        
 SELECT * FROM #HOLD        
 ) X        
       
     CREATE CLUSTERED INDEX  IX_CL ON  #CL    
  ( PARTY_CODE )    
    
-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015        
      
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1        
BEGIN         
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE         
END         
        
INSERT INTO TBLQLSEBIREPORT         
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL        
        
UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE      
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE        
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE        
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE        
        
     
-----------COMPLETED        
        
--- SCCS DATA DUMP INTO TEMP TABLE        
        
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP        
SELECT * FROM #SCCS (NOLOCK)         
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL)         
        
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP        
SELECT * FROM SCCSANNEXURE_A WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP        
SELECT * FROM SCCSANNEXURE_B WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE        
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP        
SELECT * FROM SCCSANNEXURE_C WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP        
SELECT * FROM SCCSANNEXURE_D WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT            
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP        
SELECT * FROM SCCSANNEXURE_E WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
          
        
---------        
        
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE         
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )        
        
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE         
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )        
        
----------        
--- Ql Clients for Printing       
      
      
TRUNCATE TABLE TMP_QL      
TRUNCATE TABLE QL_ADDR      
      
--SELECT * FROM TMP_QL where CLIENTCODE not in       
--(Select cl_code from QL_ADDR)      
      
INSERT INTO TMP_QL      
SELECT DISTINCT *  FROM (      
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP  END,      
CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END ECN_FLAG      
  FROM (      
SELECT DISTINCT CQL_PARTYCODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)) c  ,      
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)       
WHERE CLIENTCODE = C1.CL_CODE      
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'      
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY)      
--- AND C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%'      
        
UNION      
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP END      
, CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END      
FROM (SELECT DISTINCT PARTY_CODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER (NOLOCK)) c  ,      
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)       
WHERE CLIENTCODE = C1.CL_CODE      
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'      
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY) )A      
       
INSERT INTO QL_ADDR      
SELECT ACNAME = C.LONG_NAME,       
COMPANY ='Angel Broking Private Limited',       
COMPANY_ADD =  O.Addr1 + ', ' + O.Addr2  + ', ' + O.City + ', ' + O.Zip + ',Board line No:  ' + O.Phone,      
C.L_ADDRESS1,         
C.L_ADDRESS2,         
C.L_ADDRESS3,         
C.L_CITY,         
C.L_ZIP,         
C.RES_PHONE1,         
C.PAN_GIR_NO,         
C.L_STATE,         
C.L_NATION,         
BRANCH = C.BRANCH_CD,         
SUBBROKER = C.SUB_BROKER,         
TRADER = C.TRADER, MOBILE_PAGER ,CL_CODE         
FROM  ANAND1.MSAJAG.DBO.OWNER O (NOLOCK),      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)         
  INNER JOIN ANAND1.MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)         
  --INNER JOIN ANAND1.MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)         
  INNER JOIN ANAND1.MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)         
 AND  CL_CODE IN (SELECT CLIENTCODE FROM TMP_QL)      
     
 ---------------    
     
 DECLARE @UPD DATETIME    
 SELECT @UPD = MAX(convert(VARCHAR(11),UPDATEDON,120)) FROM TBL_SCCSANNEXURE_A_TEMP    
     
 ---    
     
DELETE FROM TBL_SCCSANNEXURE_A_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_B_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_C_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_D_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_E_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
      
      
 ----------Completed      
      
        
DROP TABLE #CL         
DROP TABLE #PO         
DROP TABLE #BILL        
DROP TABLE #DRCR        
DROP TABLE #HOLD        
DROP TABLE #PARTY        
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_07oct2022
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_07oct2022]             
(                      
               @FROMDATE   VARCHAR(11),                      
               @TODATE     VARCHAR(20),                      
               @FROMPARTY  VARCHAR(10),                      
               @TOPARTY    VARCHAR(10),                      
               @FROMSCRIP  VARCHAR(12),                      
               @TOSCRIP    VARCHAR(12)                      
)               
AS            
        
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'JAN  2 2018','MAR 26 2018','A0000','ZZZZZ','00000000','ZZZZZZZZZ'        
        
--- BY DHARMESH ON 14 01 2013        
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)        
   
 set @TODATE=@TODATE+ ' 23:50'  
   
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY        
        
 /*       
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER         
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'       
    
*/    
 DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'        
     
    
---DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')        
        
--- SECURITIES DATA COPY FROM DEMAT SERVER         
        
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER        
        
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER        
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER         
         
        
SELECT DISTINCT PARTY_CODE         
 INTO #PARTY        
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)        
WHERE ---- INACTIVE_DATE > GETDATE () AND  removed for getting all balanced clients    
LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )         
         
--- FUNDS & SECURITIES PAYOUT CLIENTS        
        
SELECT DISTINCT PARTY_CODE         
 INTO #PO         
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)         
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (        
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )        
        
         
--- BILLS         
        
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE         
 INTO #BILL        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)         
WHERE CQL_VTYPE = 'BILL'         
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )        
        
--- HOLDING         
        
SELECT DISTINCT PARTY_CODE AS PARTY_CODE         
 INTO #HOLD        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)        
WHERE 1 = 1        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )        
        
--- RS 1000.00 DR/CR --        
      
/* ##### CHANGE ON 23/12/2016 ##### */      
        
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL         
 INTO #DRCR        
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)         
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')        
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )        
GROUP BY CQL_PARTYCODE        
--- HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) > 1000        
ORDER BY CQL_PARTYCODE         
        
---         
        
SELECT *         
 INTO #CL         
FROM        
 (        
 SELECT * FROM #PO         
 UNION        
 SELECT * FROM #BILL        
 UNION        
 SELECT CQL_PARTYCODE FROM #DRCR        
 UNION        
 SELECT * FROM #HOLD        
 ) X        
       
     CREATE CLUSTERED INDEX  IX_CL ON  #CL    
  ( PARTY_CODE )    
    
-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015        
      
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1        
BEGIN         
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE         
END         
        
INSERT INTO TBLQLSEBIREPORT         
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL        
        
UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE      
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE        
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE        
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE        
        
     
-----------COMPLETED        
        
--- SCCS DATA DUMP INTO TEMP TABLE        
        
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP        
SELECT * FROM #SCCS (NOLOCK)         
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL)         
        
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP        
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE        
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP        
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE        
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP        
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP        
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT            
          
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP        
        
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP        
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)         
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE         
  AND PARTY_CODE IN        
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
          
        
---------        
        
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE         
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )        
        
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE         
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )        
        
----------        
--- Ql Clients for Printing       
      
      
TRUNCATE TABLE TMP_QL      
TRUNCATE TABLE QL_ADDR      
      
--SELECT * FROM TMP_QL where CLIENTCODE not in       
--(Select cl_code from QL_ADDR)      
      
INSERT INTO TMP_QL      
SELECT DISTINCT *  FROM (      
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP  END,      
CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END ECN_FLAG      
  FROM (      
SELECT DISTINCT CQL_PARTYCODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)) c  ,      
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)       
WHERE CLIENTCODE = C1.CL_CODE      
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'      
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY)      
--- AND C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%'      
        
UNION      
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP END      
, CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END      
FROM (SELECT DISTINCT PARTY_CODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER (NOLOCK)) c  ,      
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)       
WHERE CLIENTCODE = C1.CL_CODE      
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'      
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY) )A      
       
INSERT INTO QL_ADDR      
SELECT ACNAME = C.LONG_NAME,       
COMPANY ='Angel Broking Private Limited',       
COMPANY_ADD =  O.Addr1 + ', ' + O.Addr2  + ', ' + O.City + ', ' + O.Zip + ',Board line No:  ' + O.Phone,      
C.L_ADDRESS1,         
C.L_ADDRESS2,         
C.L_ADDRESS3,         
C.L_CITY,         
C.L_ZIP,         
C.RES_PHONE1,         
C.PAN_GIR_NO,         
C.L_STATE,         
C.L_NATION,         
BRANCH = C.BRANCH_CD,         
SUBBROKER = C.SUB_BROKER,         
TRADER = C.TRADER, MOBILE_PAGER ,CL_CODE         
FROM  ANAND1.MSAJAG.DBO.OWNER O (NOLOCK),      
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)         
  INNER JOIN ANAND1.MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)         
  --INNER JOIN ANAND1.MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)         
  INNER JOIN ANAND1.MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)         
 AND  CL_CODE IN (SELECT CLIENTCODE FROM TMP_QL)      
     
 ---------------    
     
 DECLARE @UPD DATETIME    
 SELECT @UPD = MAX(convert(VARCHAR(11),UPDATEDON,120)) FROM TBL_SCCSANNEXURE_A_TEMP    
     
 ---    
     
DELETE FROM TBL_SCCSANNEXURE_A_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_B_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_C_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_D_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
DELETE FROM TBL_SCCSANNEXURE_E_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD     
      
      
 ----------Completed      
      
        
DROP TABLE #CL         
DROP TABLE #PO         
DROP TABLE #BILL        
DROP TABLE #DRCR        
DROP TABLE #HOLD        
DROP TABLE #PARTY        
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_18032019
-- --------------------------------------------------

CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_18032019]         
(                  
               @FROMDATE   VARCHAR(11),                  
               @TODATE     VARCHAR(11),                  
               @FROMPARTY  VARCHAR(10),                  
               @TOPARTY    VARCHAR(10),                  
               @FROMSCRIP  VARCHAR(12),                  
               @TOSCRIP    VARCHAR(12)                  
)           
AS        
    
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'JAN  2 2018','MAR 26 2018','A0000','ZZZZZ','00000000','ZZZZZZZZZ'    
    
--- BY DHARMESH ON 14 01 2013    
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)    
 
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY    
    
    
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER     
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'   
    
    
 
 DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'    
 

    
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')    
    
--- SECURITIES DATA COPY FROM DEMAT SERVER     
    
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER    
    
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER    
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER     
     
--- FUNDS AND SECURITIES RELEASED CLIENT LIST    
    
SELECT DISTINCT PARTY_CODE     
 INTO #PARTY    
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)    
WHERE ---- INACTIVE_DATE > GETDATE () AND  removed for getting all balanced clients
LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )     
     
--- FUNDS & SECURITIES PAYOUT CLIENTS    
    
SELECT DISTINCT PARTY_CODE     
 INTO #PO     
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)     
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )    
    
     
--- BILLS     
    
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE     
 INTO #BILL    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)     
WHERE CQL_VTYPE = 'BILL'     
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )    
    
--- HOLDING     
    
SELECT DISTINCT PARTY_CODE AS PARTY_CODE     
 INTO #HOLD    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)    
WHERE 1 = 1    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )    
    
--- RS 1000.00 DR/CR --    
  
/* ##### CHANGE ON 23/12/2016 ##### */  
    
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL     
 INTO #DRCR    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)     
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )    
GROUP BY CQL_PARTYCODE    
--- HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) > 1000    
ORDER BY CQL_PARTYCODE     
    
---     
    
SELECT *     
 INTO #CL     
FROM    
 (    
 SELECT * FROM #PO     
 UNION    
 SELECT * FROM #BILL    
 UNION    
 SELECT CQL_PARTYCODE FROM #DRCR    
 UNION    
 SELECT * FROM #HOLD    
 ) X    
   
     CREATE CLUSTERED INDEX  IX_CL ON  #CL
	 ( PARTY_CODE )

-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015    
  
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1    
BEGIN     
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE     
END     
    
INSERT INTO TBLQLSEBIREPORT     
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL    
    
UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
    
-----------COMPLETED    
    
--- SCCS DATA DUMP INTO TEMP TABLE    
    
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP    
SELECT * FROM #SCCS (NOLOCK)     
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL)     
    
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT    
      
    
---------    
    
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE     
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )    
    
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE     
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )    
    
----------    
--- Ql Clients for Printing   
  
  
TRUNCATE TABLE TMP_QL  
TRUNCATE TABLE QL_ADDR  
  
--SELECT * FROM TMP_QL where CLIENTCODE not in   
--(Select cl_code from QL_ADDR)  
  
INSERT INTO TMP_QL  
SELECT DISTINCT *  FROM (  
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP  END,  
CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END ECN_FLAG  
  FROM (  
SELECT DISTINCT CQL_PARTYCODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)) c  ,  
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)   
WHERE CLIENTCODE = C1.CL_CODE  
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'  
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY)  
--- AND C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%'  
    
UNION  
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP END  
, CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END  
FROM (SELECT DISTINCT PARTY_CODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER (NOLOCK)) c  ,  
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)   
WHERE CLIENTCODE = C1.CL_CODE  
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'  
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY) )A  
   
INSERT INTO QL_ADDR  
SELECT ACNAME = C.LONG_NAME,   
COMPANY ='Angel Broking Private Limited',   
COMPANY_ADD =  O.Addr1 + ', ' + O.Addr2  + ', ' + O.City + ', ' + O.Zip + ',Board line No:  ' + O.Phone,  
C.L_ADDRESS1,     
C.L_ADDRESS2,     
C.L_ADDRESS3,     
C.L_CITY,     
C.L_ZIP,     
C.RES_PHONE1,     
C.PAN_GIR_NO,     
C.L_STATE,     
C.L_NATION,     
BRANCH = C.BRANCH_CD,     
SUBBROKER = C.SUB_BROKER,     
TRADER = C.TRADER, MOBILE_PAGER ,CL_CODE     
FROM  ANAND1.MSAJAG.DBO.OWNER O (NOLOCK),  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)     
  INNER JOIN ANAND1.MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)     
  --INNER JOIN ANAND1.MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)     
  INNER JOIN ANAND1.MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)     
 AND  CL_CODE IN (SELECT CLIENTCODE FROM TMP_QL)  
 
 ---------------
 
 DECLARE @UPD DATETIME
 SELECT @UPD = MAX(convert(VARCHAR(11),UPDATEDON,120)) FROM TBL_SCCSANNEXURE_A_TEMP
 
 ---
 
DELETE FROM TBL_SCCSANNEXURE_A_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_B_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_C_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_D_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_E_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
  
  
 ----------Completed  
  
    
DROP TABLE #CL     
DROP TABLE #PO     
DROP TABLE #BILL    
DROP TABLE #DRCR    
DROP TABLE #HOLD    
DROP TABLE #PARTY    
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_20jan2022
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_20jan2022]           
(                    
               @FROMDATE   VARCHAR(11),                    
               @TODATE     VARCHAR(11),                    
               @FROMPARTY  VARCHAR(10),                    
               @TOPARTY    VARCHAR(10),                    
               @FROMSCRIP  VARCHAR(12),                    
               @TOSCRIP    VARCHAR(12)                    
)             
AS          
      
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'JAN  2 2018','MAR 26 2018','A0000','ZZZZZ','00000000','ZZZZZZZZZ'      
      
--- BY DHARMESH ON 14 01 2013      
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)      
  
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY      
      
 /*     
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER       
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'     
  
*/  
 DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'      
   
  
---DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')      
      
--- SECURITIES DATA COPY FROM DEMAT SERVER       
      
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER      
      
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER      
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER       
       
      
SELECT DISTINCT PARTY_CODE       
 INTO #PARTY      
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)      
WHERE ---- INACTIVE_DATE > GETDATE () AND  removed for getting all balanced clients  
LEFT(SCCS_DATE,11) = (      
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )       
       
--- FUNDS & SECURITIES PAYOUT CLIENTS      
      
SELECT DISTINCT PARTY_CODE       
 INTO #PO       
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)       
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (      
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )      
      
       
--- BILLS       
      
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE       
 INTO #BILL      
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)       
WHERE CQL_VTYPE = 'BILL'       
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')      
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )      
      
--- HOLDING       
      
SELECT DISTINCT PARTY_CODE AS PARTY_CODE       
 INTO #HOLD      
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)      
WHERE 1 = 1      
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )      
      
--- RS 1000.00 DR/CR --      
    
/* ##### CHANGE ON 23/12/2016 ##### */    
      
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL       
 INTO #DRCR      
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)       
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO','MCDX','NCDX')      
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )      
GROUP BY CQL_PARTYCODE      
--- HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) > 1000      
ORDER BY CQL_PARTYCODE       
      
---       
      
SELECT *       
 INTO #CL       
FROM      
 (      
 SELECT * FROM #PO       
 UNION      
 SELECT * FROM #BILL      
 UNION      
 SELECT CQL_PARTYCODE FROM #DRCR      
 UNION      
 SELECT * FROM #HOLD      
 ) X      
     
     CREATE CLUSTERED INDEX  IX_CL ON  #CL  
  ( PARTY_CODE )  
  
-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015      
    
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1      
BEGIN       
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE       
END       
      
INSERT INTO TBLQLSEBIREPORT       
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL      
      
UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE      
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE      
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE      
      
   
-----------COMPLETED      
      
--- SCCS DATA DUMP INTO TEMP TABLE      
      
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)      
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP      
SELECT * FROM #SCCS (NOLOCK)       
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL)       
      
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY      
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP      
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)       
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL) ORDER BY PARTY_CODE      
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP      
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)       
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL) ORDER BY PARTY_CODE      
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP      
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)       
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT      
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP      
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)       
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT          
        
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP      
      
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP      
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)       
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE       
  AND PARTY_CODE IN      
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT      
        
      
---------      
      
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE       
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )      
      
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE       
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )      
      
----------      
--- Ql Clients for Printing     
    
    
TRUNCATE TABLE TMP_QL    
TRUNCATE TABLE QL_ADDR    
    
--SELECT * FROM TMP_QL where CLIENTCODE not in     
--(Select cl_code from QL_ADDR)    
    
INSERT INTO TMP_QL    
SELECT DISTINCT *  FROM (    
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP  END,    
CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END ECN_FLAG    
  FROM (    
SELECT DISTINCT CQL_PARTYCODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)) c  ,    
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)     
WHERE CLIENTCODE = C1.CL_CODE    
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'    
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY)    
--- AND C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%'    
      
UNION    
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP END    
, CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END    
FROM (SELECT DISTINCT PARTY_CODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER (NOLOCK)) c  ,    
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)     
WHERE CLIENTCODE = C1.CL_CODE    
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'    
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY) )A    
     
INSERT INTO QL_ADDR    
SELECT ACNAME = C.LONG_NAME,     
COMPANY ='Angel Broking Private Limited',     
COMPANY_ADD =  O.Addr1 + ', ' + O.Addr2  + ', ' + O.City + ', ' + O.Zip + ',Board line No:  ' + O.Phone,    
C.L_ADDRESS1,       
C.L_ADDRESS2,       
C.L_ADDRESS3,       
C.L_CITY,       
C.L_ZIP,       
C.RES_PHONE1,       
C.PAN_GIR_NO,       
C.L_STATE,       
C.L_NATION,       
BRANCH = C.BRANCH_CD,       
SUBBROKER = C.SUB_BROKER,       
TRADER = C.TRADER, MOBILE_PAGER ,CL_CODE       
FROM  ANAND1.MSAJAG.DBO.OWNER O (NOLOCK),    
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)       
  INNER JOIN ANAND1.MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)       
  --INNER JOIN ANAND1.MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)       
  INNER JOIN ANAND1.MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)       
 AND  CL_CODE IN (SELECT CLIENTCODE FROM TMP_QL)    
   
 ---------------  
   
 DECLARE @UPD DATETIME  
 SELECT @UPD = MAX(convert(VARCHAR(11),UPDATEDON,120)) FROM TBL_SCCSANNEXURE_A_TEMP  
   
 ---  
   
DELETE FROM TBL_SCCSANNEXURE_A_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD   
DELETE FROM TBL_SCCSANNEXURE_B_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD   
DELETE FROM TBL_SCCSANNEXURE_C_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD   
DELETE FROM TBL_SCCSANNEXURE_D_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD   
DELETE FROM TBL_SCCSANNEXURE_E_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD   
    
    
 ----------Completed    
    
      
DROP TABLE #CL       
DROP TABLE #PO       
DROP TABLE #BILL      
DROP TABLE #DRCR      
DROP TABLE #HOLD      
DROP TABLE #PARTY      
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_23102013
-- --------------------------------------------------
  
CREATE PROC V2_PROC_QUARTERLYLEDGER_POP_23102013 --- OLD SP BACKUP IN VIEW OF NEW RETENTION SP DEPOLYED       
(                
               @FROMDATE   VARCHAR(11),                
               @TODATE     VARCHAR(11),                
               @FROMPARTY  VARCHAR(10),                
               @TOPARTY    VARCHAR(10),                
               @FROMSCRIP  VARCHAR(12),                
               @TOSCRIP    VARCHAR(12)                
)         
AS      
  
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'OCT 23 2012','JAN 14 2013','A0000','ZZZZZ','00000000','ZZZZZZZZZ'  
  
--- BY DHARMESH ON 14 01 2013  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)  
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY  
  
  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER   
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'  
  
  
---   
  
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'  
  
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')  
  
--- SECURITIES DATA COPY FROM DEMAT SERVER   
  
TRUNCATE TABLE V2_CLASS_QUARTERLYSECLEDGER  
  
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER  
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER   
   
--- FUNDS AND SECURITIES RELEASED CLIENT LIST  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PARTY  
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)  
WHERE INACTIVE_DATE > GETDATE () AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )   
   
--- FUNDS & SECURITIES PAYOUT CLIENTS  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PO   
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)   
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )  
  
   
--- BILLS   
  
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE   
 INTO #BILL  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_VTYPE = 'BILL'   
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
  
--- HOLDING   
  
SELECT DISTINCT PARTY_CODE AS PARTY_CODE   
 INTO #HOLD  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)  
WHERE 1 = 1  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )  
  
--- RS 1000.00 DR/CR --  
  
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL   
 INTO #DRCR  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
GROUP BY CQL_PARTYCODE  
HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) >1000  
ORDER BY CQL_PARTYCODE   
  
---   
  
SELECT *   
 INTO #CL   
FROM  
 (  
 SELECT * FROM #PO   
 UNION  
 SELECT * FROM #BILL  
 UNION  
 SELECT CQL_PARTYCODE FROM #DRCR  
 UNION  
 SELECT * FROM #HOLD  
 ) X  
  
--- SCCS DATA DUMP INTO TEMP TABLE  
  
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)  
  
TRUNCATE TABLE TBL_SCCS_DATA_TEMP  
  
INSERT INTO TBL_SCCS_DATA_TEMP  
SELECT * FROM #SCCS (NOLOCK)   
WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE   
AND PARTY_CODE IN  
(SELECT * FROM #CL)   
  
----   
  
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )  
  
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )  
  
DROP TABLE #CL   
DROP TABLE #PO   
DROP TABLE #BILL  
DROP TABLE #DRCR  
DROP TABLE #HOLD  
DROP TABLE #PARTY  
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_BAK2306
-- --------------------------------------------------

  
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_BAK2306]       
(                
               @FROMDATE   VARCHAR(11),                
               @TODATE     VARCHAR(11),                
               @FROMPARTY  VARCHAR(10),                
               @TOPARTY    VARCHAR(10),                
               @FROMSCRIP  VARCHAR(12),                
               @TOSCRIP    VARCHAR(12)                
)         
AS      
  
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'OCT 23 2012','JAN 14 2013','A0000','ZZZZZ','00000000','ZZZZZZZZZ'  
  
--- BY DHARMESH ON 14 01 2013  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)  
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY  
  
  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER   
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'  
  
  
---   
  
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'  
  
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')  
  
--- SECURITIES DATA COPY FROM DEMAT SERVER   
  
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER  
  
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER  
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER   
   
--- FUNDS AND SECURITIES RELEASED CLIENT LIST  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PARTY  
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)  
WHERE INACTIVE_DATE > GETDATE () AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )   
   
--- FUNDS & SECURITIES PAYOUT CLIENTS  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PO   
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)   
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )  
  
   
--- BILLS   
  
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE   
 INTO #BILL  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_VTYPE = 'BILL'   
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
  
--- HOLDING   
  
SELECT DISTINCT PARTY_CODE AS PARTY_CODE   
 INTO #HOLD  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)  
WHERE 1 = 1  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )  
  
--- RS 1000.00 DR/CR --  
  
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL   
 INTO #DRCR  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
GROUP BY CQL_PARTYCODE  
HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) >1000  
ORDER BY CQL_PARTYCODE   
  
---   
  
SELECT *   
 INTO #CL   
FROM  
 (  
 SELECT * FROM #PO   
 UNION  
 SELECT * FROM #BILL  
 UNION  
 SELECT CQL_PARTYCODE FROM #DRCR  
 UNION  
 SELECT * FROM #HOLD  
 ) X  
  
--- SCCS DATA DUMP INTO TEMP TABLE  
  
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP  
SELECT * FROM #SCCS (NOLOCK)   
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL)   
  
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE  
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT  
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT      
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT  
    
  
---------  
  
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )  
  
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )  
  
----------  
  
DROP TABLE #CL   
DROP TABLE #PO   
DROP TABLE #BILL  
DROP TABLE #DRCR  
DROP TABLE #HOLD  
DROP TABLE #PARTY  
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_BAKNOV72016
-- --------------------------------------------------


  
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_BAKNOV72016]       
(                
               @FROMDATE   VARCHAR(11),                
               @TODATE     VARCHAR(11),                
               @FROMPARTY  VARCHAR(10),                
               @TOPARTY    VARCHAR(10),                
               @FROMSCRIP  VARCHAR(12),                
               @TOSCRIP    VARCHAR(12)                
)         
AS      
  
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'OCT 23 2012','JAN 14 2013','A0000','ZZZZZ','00000000','ZZZZZZZZZ'  
  
--- BY DHARMESH ON 14 01 2013  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)  
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY  
  
  
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER   
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'  
  
  
---   
  
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'  
  
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')  
  
--- SECURITIES DATA COPY FROM DEMAT SERVER   
  
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER  
  
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER  
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER   
   
--- FUNDS AND SECURITIES RELEASED CLIENT LIST  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PARTY  
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)  
WHERE INACTIVE_DATE > GETDATE () AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )   
   
--- FUNDS & SECURITIES PAYOUT CLIENTS  
  
SELECT DISTINCT PARTY_CODE   
 INTO #PO   
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)   
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (  
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )  
  
   
--- BILLS   
  
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE   
 INTO #BILL  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_VTYPE = 'BILL'   
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
  
--- HOLDING   
  
SELECT DISTINCT PARTY_CODE AS PARTY_CODE   
 INTO #HOLD  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)  
WHERE 1 = 1  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )  
  
--- RS 1000.00 DR/CR --  
  
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL   
 INTO #DRCR  
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)   
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')  
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )  
GROUP BY CQL_PARTYCODE  
HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) >1000  
ORDER BY CQL_PARTYCODE   
  
---   
  
SELECT *   
 INTO #CL   
FROM  
 (  
 SELECT * FROM #PO   
 UNION  
 SELECT * FROM #BILL  
 UNION  
 SELECT CQL_PARTYCODE FROM #DRCR  
 UNION  
 SELECT * FROM #HOLD  
 ) X  

-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1
BEGIN 
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE 
END 

INSERT INTO TBLQLSEBIREPORT 
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL

UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE

-----------COMPLETED
  
--- SCCS DATA DUMP INTO TEMP TABLE  
  
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP  
SELECT * FROM #SCCS (NOLOCK)   
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL)   
  
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE  
  
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE  
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT  
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT      
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP  
  
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP  
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)   
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE   
  AND PARTY_CODE IN  
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT  
    
  
---------  
  
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )  
  
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE   
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )  
  
----------  
  
DROP TABLE #CL   
DROP TABLE #PO   
DROP TABLE #BILL  
DROP TABLE #DRCR  
DROP TABLE #HOLD  
DROP TABLE #PARTY  
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYLEDGER_POP_ORG
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_QUARTERLYLEDGER_POP_ORG]         
(                  
               @FROMDATE   VARCHAR(11),                  
               @TODATE     VARCHAR(11),                  
               @FROMPARTY  VARCHAR(10),                  
               @TOPARTY    VARCHAR(10),                  
               @FROMSCRIP  VARCHAR(12),                  
               @TOSCRIP    VARCHAR(12)                  
)           
AS        
    
--- EXEC V2_PROC_QUARTERLYLEDGER_POP 'JAN  2 2018','MAR 26 2018','A0000','ZZZZZ','00000000','ZZZZZZZZZ'    
    
--- BY DHARMESH ON 14 01 2013    
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYLEDGER ON BSE SERVER (ANAND - 201)    
 
EXEC PRADNYA.DBO.V2_PROC_QUARTERLYLEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY    
    
    
--- LEDGER DATA FETCH IN V2_CLASS_QUARTERLYSECLEDGER ON DEMAT SERVER (ANGELDEAMT - 197) AND COPY TO BSE (ANAND) SERVER     
EXEC ANGELDEMAT.PRADNYA.DBO.V2_PROC_QUARTERLYSHARELEDGER_NEW @FROMDATE,@TODATE,@FROMPARTY,@TOPARTY,@FROMSCRIP,@TOSCRIP,'BROKER','BROKER'   
    
    
 
 DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_VTYPE LIKE 'OPEN%'    
 

    
DELETE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER WHERE CQL_SEGMENT IN ('MCDX','NCDX')    
    
--- SECURITIES DATA COPY FROM DEMAT SERVER     
    
TRUNCATE TABLE PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER    
    
INSERT INTO PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER    
SELECT * FROM ANGELDEMAT.PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER     
     
--- FUNDS AND SECURITIES RELEASED CLIENT LIST    
    
SELECT DISTINCT PARTY_CODE     
 INTO #PARTY    
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)    
WHERE ---- INACTIVE_DATE > GETDATE () AND  removed for getting all balanced clients
LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM PRADNYA.DBO.TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )     
     
--- FUNDS & SECURITIES PAYOUT CLIENTS    
    
SELECT DISTINCT PARTY_CODE     
 INTO #PO     
FROM PRADNYA.DBO.TBL_SCCSCLIENT (NOLOCK)     
WHERE FLAG = 'Y' AND LEFT(SCCS_DATE,11) = (    
SELECT DISTINCT LEFT(MAX(SCCS_DATE),11) FROM TBL_SCCSCLIENT WHERE SCCS_DATE < @TODATE )    
    
     
--- BILLS     
    
SELECT DISTINCT CQL_PARTYCODE AS PARTY_CODE     
 INTO #BILL    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)     
WHERE CQL_VTYPE = 'BILL'     
AND CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )    
    
--- HOLDING     
    
SELECT DISTINCT PARTY_CODE AS PARTY_CODE     
 INTO #HOLD    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER C (NOLOCK)    
WHERE 1 = 1    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = C.PARTY_CODE )    
    
--- RS 1000.00 DR/CR --    
  
/* ##### CHANGE ON 23/12/2016 ##### */  
    
SELECT CQL_PARTYCODE,SUM(CQL_BALANCE) AS BAL     
 INTO #DRCR    
FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)     
WHERE CQL_SEGMENT IN ('BSECM','NSECM','NSEFO','MCDXCDS','NSECURFO')    
AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE PARTY_CODE = CQL_PARTYCODE )    
GROUP BY CQL_PARTYCODE    
--- HAVING SUM(CQL_BALANCE) < -1000 OR SUM(CQL_BALANCE) > 1000    
ORDER BY CQL_PARTYCODE     
    
---     
    
SELECT *     
 INTO #CL     
FROM    
 (    
 SELECT * FROM #PO     
 UNION    
 SELECT * FROM #BILL    
 UNION    
 SELECT CQL_PARTYCODE FROM #DRCR    
 UNION    
 SELECT * FROM #HOLD    
 ) X    
   
     CREATE CLUSTERED INDEX  IX_CL ON  #CL
	 ( PARTY_CODE )

-----------ADDED BY SIVA AS PER REQUEST RECIEVD ON 18/06/2015    
  
IF (SELECT COUNT(*) FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE )>=1    
BEGIN     
DELETE FROM TBLQLSEBIREPORT WHERE STATEMENTDATE=@TODATE     
END     
    
INSERT INTO TBLQLSEBIREPORT     
SELECT *,'N','N','N','N',@TODATE,GETDATE() FROM #CL    
    
UPDATE TBLQLSEBIREPORT SET Funds_Sec='Y'  FROM #PO WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Bills='Y'  FROM #BILL WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Ledger='Y'  FROM #DRCR WHERE CL_CODE=CQL_PARTYCODE and STATEMENTDATE =@TODATE    
UPDATE TBLQLSEBIREPORT SET Holding='Y'  FROM #HOLD WHERE CL_CODE=PARTY_CODE and STATEMENTDATE =@TODATE    
    
-----------COMPLETED    
    
--- SCCS DATA DUMP INTO TEMP TABLE    
    
SELECT * INTO #SCCS FROM VW_SCCS_DATA (NOLOCK)    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCS_DATA_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCS_DATA_TEMP    
SELECT * FROM #SCCS (NOLOCK)     
 WHERE SCCS_DATE > @FROMDATE AND SCCS_DATE < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL)     
    
---- RETENTION ANNEXURE DATA DUMP INTO TEMP TABLE DEPOLYED ON 23/10/2013 BY DHARMESH K MISTRY    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_A_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_A WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE    
    
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_B_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_B WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_C_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_C WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT    
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_D_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_D WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT        
      
TRUNCATE TABLE PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
    
INSERT INTO PRADNYA.DBO.TBL_SCCSANNEXURE_E_TEMP    
SELECT * FROM MIS.SCCS.DBO.SCCSANNEXURE_E WITH (NOLOCK)     
 WHERE UPDATEDON > @FROMDATE AND UPDATEDON < @TODATE     
  AND PARTY_CODE IN    
  (SELECT * FROM #CL) ORDER BY PARTY_CODE,SEGMENT    
      
    
---------    
    
DELETE FROM V2_CLASS_QUARTERLYSECLEDGER WHERE     
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = V2_CLASS_QUARTERLYSECLEDGER.PARTY_CODE )    
    
DELETE FROM V2_CLASS_QUARTERLYLEDGER WHERE     
NOT EXISTS (SELECT PARTY_CODE FROM #CL WHERE #CL.PARTY_CODE = CQL_PARTYCODE )    
    
----------    
--- Ql Clients for Printing   
  
  
TRUNCATE TABLE TMP_QL  
TRUNCATE TABLE QL_ADDR  
  
--SELECT * FROM TMP_QL where CLIENTCODE not in   
--(Select cl_code from QL_ADDR)  
  
INSERT INTO TMP_QL  
SELECT DISTINCT *  FROM (  
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP  END,  
CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END ECN_FLAG  
  FROM (  
SELECT DISTINCT CQL_PARTYCODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYLEDGER (NOLOCK)) c  ,  
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)   
WHERE CLIENTCODE = C1.CL_CODE  
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'  
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY)  
--- AND C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%'  
    
UNION  
SELECT CLIENTCODE,L_ZIP = CASE WHEN ISNULL(L_ZIP,'')='' THEN '000000' ELSE L_ZIP END  
, CASE WHEN  C1.REPATRIAT_BANK_AC_NO NOT LIKE 'ECN%' THEN 'NECN' ELSE 'ECN' END  
FROM (SELECT DISTINCT PARTY_CODE AS CLIENTCODE FROM PRADNYA.DBO.V2_CLASS_QUARTERLYSECLEDGER (NOLOCK)) c  ,  
ANAND1.MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)   
WHERE CLIENTCODE = C1.CL_CODE  
AND CLIENTCODE BETWEEN 'A00' AND 'ZZZZ'  
AND CLIENTCODE NOT IN (SELECT PARTY_CODE FROM ANAND1.MSAJAG.DBO.TBL_QL_EXCLUDE_PARTY) )A  
   
INSERT INTO QL_ADDR  
SELECT ACNAME = C.LONG_NAME,   
COMPANY ='Angel Broking Private Limited',   
COMPANY_ADD =  O.Addr1 + ', ' + O.Addr2  + ', ' + O.City + ', ' + O.Zip + ',Board line No:  ' + O.Phone,  
C.L_ADDRESS1,     
C.L_ADDRESS2,     
C.L_ADDRESS3,     
C.L_CITY,     
C.L_ZIP,     
C.RES_PHONE1,     
C.PAN_GIR_NO,     
C.L_STATE,     
C.L_NATION,     
BRANCH = C.BRANCH_CD,     
SUBBROKER = C.SUB_BROKER,     
TRADER = C.TRADER, MOBILE_PAGER ,CL_CODE     
FROM  ANAND1.MSAJAG.DBO.OWNER O (NOLOCK),  
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)     
  INNER JOIN ANAND1.MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)     
  --INNER JOIN ANAND1.MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)     
  INNER JOIN ANAND1.MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)     
 AND  CL_CODE IN (SELECT CLIENTCODE FROM TMP_QL)  
 
 ---------------
 
 DECLARE @UPD DATETIME
 SELECT @UPD = MAX(convert(VARCHAR(11),UPDATEDON,120)) FROM TBL_SCCSANNEXURE_A_TEMP
 
 ---
 
DELETE FROM TBL_SCCSANNEXURE_A_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_B_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_C_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_D_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
DELETE FROM TBL_SCCSANNEXURE_E_TEMP WHERE convert(VARCHAR(11),UPDATEDON,120) <> @UPD 
  
  
 ----------Completed  
  
    
DROP TABLE #CL     
DROP TABLE #PO     
DROP TABLE #BILL    
DROP TABLE #DRCR    
DROP TABLE #HOLD    
DROP TABLE #PARTY    
DROP TABLE #SCCS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYSHARELEDGER
-- --------------------------------------------------
          
CREATE PROCEDURE [dbo].[V2_PROC_QUARTERLYSHARELEDGER]          
          
(          
               @FROMDATE   VARCHAR(11),          
               @TODATE     VARCHAR(11),          
               @FROMPARTY  VARCHAR(10),          
               @TOPARTY    VARCHAR(10),          
               @FROMSCRIP  VARCHAR(12),          
               @TOSCRIP    VARCHAR(12),          
               @STATUSID   VARCHAR(50),          
               @STATUSNAME VARCHAR(50))          
AS      
/*            
    
      
SELECT COUNT(1) FROM MSAJAG.DBO.DELTRANS      
EXEC V2_PROC_QUARTERLYSHARELEDGER  'JUL  1 1900', 'JUN 15 2009', '0a146', '0a146', '0000000000', 'ZZZZZZZZZZ', 'BROKER', 'BROKER'                
*/
          
DECLARE  @@LOOPDPID VARCHAR(10)          
        
DECLARE  @@LOOPCLTDPID VARCHAR(16)          
        
DECLARE  @NEWFROMDATE VARCHAR(11)          
                              
SET @@LOOPDPID = 'AAAA'          
        
SET @@LOOPCLTDPID = 'AAAA'          
                            
SELECT @NEWFROMDATE = 'APR  1 1950'                  

TRUNCATE TABLE V2_CLASS_QUARTERLYSECLEDGER

EXEC ANGELDEMAT.BSEDB.DBO.RPT_HOLDCHECK_FINAL @FROMDATE, @TODATE

EXEC ANGELDEMAT.MSAJAG.DBO.RPT_HOLDCHECK_FINAL @FROMDATE, @TODATE

INSERT INTO V2_CLASS_QUARTERLYSECLEDGER
SELECT * FROM ANGELDEMAT.BSEDB.DBO.V2_DELHOLDFINAL

INSERT INTO V2_CLASS_QUARTERLYSECLEDGER
SELECT * FROM ANGELDEMAT.MSAJAG.DBO.V2_DELHOLDFINAL

/*                                  
          
      CREATE TABLE #TABLEREPORT (          
  SEGMENT VARCHAR(5),          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)                    
      
      CREATE TABLE #TABLE1 (          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)          
          
          
      CREATE TABLE #TABLE2 (          
        TRANSDATE   VARCHAR(10),          
        SETT_NO     VARCHAR(10),          
        SETT_TYPE   VARCHAR(5),          
        PARTY_CODE  VARCHAR(10),          
        SCRIP_CD    VARCHAR(20),          
        SCRIP_NAME  VARCHAR(255),          
        CERTNO      VARCHAR(20),          
        CQTY        INT,          
        DQTY        INT,          
        SLIPNO      VARCHAR(20),          
        DPID        VARCHAR(8),          
        CLTDPID     VARCHAR(16),          
        TRTYPE      VARCHAR(6),          
        REASON      VARCHAR(255),          
        BDPID       VARCHAR(8),          
        BCLTDPID    VARCHAR(16),          
        TRANSDATEDT DATETIME,          
        FLAG        INT)          
          
          
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY          
          

Set Transaction isolation level read uncommitted                          
select * into #Del_TransStat_TMP From ANGELDEMAT.MSAJAG.DBO.Deltrans_Report With(NoLock)                           
Where Party_Code >= @FromParty And Party_Code <= @ToParty                          
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                          
--And TransDate >= @NewFromDate and TransDate <= @ToDate      
And Filler2 = 1       
      
INSERT INTO #DEL_TRANSSTAT_TMP      
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,       
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',       
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,       
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,      
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5      
FROM #DEL_TRANSSTAT_TMP D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP1      
WHERE D.SETT_NO = S.SETT_NO      
AND D.SETT_TYPE = S.SETT_TYPE      
AND DP.DESCRIPTION NOT LIKE '%POOL%'      
AND D.BDPID = DP.DPID      
AND D.BCLTDPID = DP.DPCLTNO      
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')      
AND DP1.DESCRIPTION LIKE '%POOL%'      
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)    
AND TCODE <> 0 AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED          
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY          
  SELECT D.*,''           
  FROM   #DEL_TRANSSTAT_TMP  D       
  WHERE  D.TRANSDATE >= @NEWFROMDATE          
         AND D.TRANSDATE <= @TODATE         

 UPDATE TBLDEL_TRANSSTAT_QRLY      SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
 FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
 WHERE M.ISIN = TBLDEL_TRANSSTAT_QRLY.CERTNO
 AND VALID = 1 
          
 UPDATE TBLDEL_TRANSSTAT_QRLY      
 SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANGELDEMAT.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),          
  ANGELDEMAT.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.SCRIP_CD = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD          
  AND S2.SERIES = TBLDEL_TRANSSTAT_QRLY.SERIES          
            
           
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'          
 WHERE ISNULL(SCRIP_NAME,'') = ''          
          
          
  DECLARE STATEMENT_CURSOR CURSOR  FOR          
            
            
  SELECT DISTINCT DPID,          
                DPCLTNO          
  FROM   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP D (NOLOCK)          
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'  
   AND DPCLTNO IN (
SELECT DISTINCT BCLTDPID
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS
WHERE FILLER2 = 1  
AND DRCR = 'D'
AND DELIVERED = '0'
AND TRTYPE IN (904, 905)
AND PARTY_CODE <> 'BROKER'
AND SHARETYPE <> 'AUCTION')
                
  OPEN STATEMENT_CURSOR          
            
  FETCH NEXT FROM STATEMENT_CURSOR          
  INTO @@LOOPDPID,          
       @@LOOPCLTDPID          
                 
  WHILE @@FETCH_STATUS = 0          
    BEGIN          
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY          
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = BDPID,          
                   CLTDPID = BCLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
          ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,        
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = DPID,          
                   CLTDPID = CLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-IN'          
                           ELSE REASON          
                                             END),          
             BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 2          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   /*AND DELIVERED = '0'*/          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND SETT_NO = '2000000' */          
                   AND FILLER1 NOT IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
                    
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO = 0,          
         DPID = '',          
                   CLTDPID = '',          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 3          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = '0'          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND FILLER1 IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO = (CASE           
                               WHEN FILLER1 = 'SPLIT' THEN 0          
                               ELSE SLIPNO          
      END),          
                   DPID = (CASE           
                             WHEN TRTYPE IN (1000,907,908) THEN ''          
                             WHEN FILLER1 = 'SPLIT' THEN ''          
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                             ELSE DPID          
                           END),          
                   CLTDPID = (CASE           
                                WHEN TRTYPE IN (1000,907,908) THEN ''          
                                WHEN FILLER1 = 'SPLIT' THEN ''          
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                                ELSE CLTDPID          
                              END),       
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE          
                               ELSE (CASE           
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'          
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1          
                                       ELSE (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'          
                                               ELSE REASON          
                                             END)          
                                     END)          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 4          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
				   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1          
          WHERE    FILLER2 = 1          
                   AND DRCR = 'D'          
                   AND DELIVERED <> '0'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                   ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   --AND HOLDERNAME NOT LIKE 'MARGIN%'          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,FILLER1,REASON          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO,          
                   DPID = DP.DPID,          
                   CLTDPID = DP.DPCLTNO,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,          
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1,          
                   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
       AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND DESCRIPTION NOT LIKE '%POOL%'*/      
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO          
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                             END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,          
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
          
          
          INSERT INTO #TABLE1          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'OPENING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),          
         FLAG = 0          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 < @FROMDATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          UNION ALL          
          SELECT *          
          FROM   TBLDEL_TRANSSTAT1_QRLY          
          WHERE  TRANSDATE1 >= @FROMDATE          
                 AND TRANSDATE1 <= @TODATE          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'CLOSING BALANCE',         
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),          
                   FLAG = 6          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 <= @TODATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          ORDER BY PARTY_CODE,          
                   SCRIP_CD,          
                   CERTNO,          
                   TRANSDATE1,          
                   FLAG,          
                   SETT_NO,          
                   SETT_TYPE          
                      
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY          
          
          
                
      FETCH NEXT FROM STATEMENT_CURSOR          
      INTO @@LOOPDPID,          
           @@LOOPCLTDPID          
    END          
              
  CLOSE STATEMENT_CURSOR          
            
  DEALLOCATE STATEMENT_CURSOR          
      
 INSERT INTO #TABLEREPORT          
  SELECT   'NSECM', *          
      FROM     #TABLE1          
  WHERE  CQTY <> 0 OR DQTY <> 0                
 ORDER BY PARTY_CODE,          
               SCRIP_CD,          
               FLAG,          
               TRANSDATEDT          
                         
      TRUNCATE TABLE #TABLE1          
      DROP TABLE #TABLE1          
*/          
          
/* NOW DOING BSECM */          
/*          
      
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY          
 
Set Transaction isolation level read uncommitted                          
select * into #Del_TransStat_TMP_1 From ANGELDEMAT.BSEDB.DBO.Deltrans_Report With(NoLock)                           
Where Party_Code >= @FromParty And Party_Code <= @ToParty                          
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                          
--And TransDate >= @NewFromDate and TransDate <= @ToDate      
And Filler2 = 1       
      
INSERT INTO #DEL_TRANSSTAT_TMP_1      
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,       
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',       
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,       
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,      
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5      
FROM #DEL_TRANSSTAT_TMP_1 D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP1      
WHERE D.SETT_NO = S.SETT_NO      
AND D.SETT_TYPE = S.SETT_TYPE      
AND DP.DESCRIPTION NOT LIKE '%POOL%'      
AND D.BDPID = DP.DPID      
AND D.BCLTDPID = DP.DPCLTNO      
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')      
AND DP1.DESCRIPTION LIKE '%POOL%'      
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)    
/*AND TCODE <> 0 */AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'
          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED          
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY          
  SELECT D.*,''           
  FROM   #DEL_TRANSSTAT_TMP_1  D       
  WHERE  D.TRANSDATE >= @NEWFROMDATE          
         AND D.TRANSDATE <= @TODATE 
         
          
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 (NOLOCK),          
  ANGELDEMAT.BSEDB.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.BSECODE = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD          
            
           
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'          
 WHERE ISNULL(SCRIP_NAME,'') = ''          
          
  DECLARE STATEMENT_CURSOR CURSOR  FOR          
            
            
  
  SELECT DISTINCT DPID,          
                DPCLTNO          
  FROM   ANGELDEMAT.BSEDB.DBO.DELIVERYDP D (NOLOCK)          
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'  
 AND DPCLTNO IN (
SELECT DISTINCT BCLTDPID
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS
WHERE FILLER2 = 1  
AND DRCR = 'D'
AND DELIVERED = '0'
AND TRTYPE IN (904, 905)
AND PARTY_CODE <> 'BROKER'
AND SHARETYPE <> 'AUCTION')
           
  OPEN STATEMENT_CURSOR          
            
  FETCH NEXT FROM STATEMENT_CURSOR          
  INTO @@LOOPDPID,          
       @@LOOPCLTDPID          
                 
  WHILE @@FETCH_STATUS = 0          
    BEGIN          
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY          
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = BDPID,          
                   CLTDPID = BCLTDPID,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
     AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
     WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO,          
                   DPID = DPID,          
                   CLTDPID = CLTDPID,          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,                         FLAG = 2          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   /*AND DELIVERED = '0'*/          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND SETT_NO = '2000000' */          
                   AND FILLER1 NOT IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                 END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
               BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
                    
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   SCRIP_NAME = D.SCRIP_CD + '( ' + CERTNO + ')',          
                   CERTNO,          
                   CQTY = SUM(QTY),          
                   DQTY = 0,          
                   SLIPNO = 0,          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE,          
                   UPPER(REASON),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 3          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    DRCR = 'C'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = '0'          
                   AND FILLER2 = 1          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
          AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND FILLER1 IN ('SPLIT','BONUS')          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                 END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,REASON          
                             
          UNION ALL          
          SELECT  TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO = (CASE           
                               WHEN FILLER1 = 'SPLIT' THEN 0          
                               ELSE SLIPNO          
                             END),          
                   DPID = (CASE           
                             WHEN TRTYPE IN (1000,907,908) THEN ''          
                             WHEN FILLER1 = 'SPLIT' THEN ''          
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                             ELSE DPID          
                           END),          
                   CLTDPID = (CASE           
                                WHEN TRTYPE IN (1000,907,908) THEN ''          
                                WHEN FILLER1 = 'SPLIT' THEN ''          
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''          
                                ELSE CLTDPID          
                              END),          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE          
                               ELSE (CASE           
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'          
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1          
                                       ELSE (CASE           
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'          
                           ELSE REASON          
                                             END)          
                                     END)          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 4          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1          
          WHERE    FILLER2 = 1          
                   AND DRCR = 'D'          
                   AND DELIVERED <> '0'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                              ELSE '%'          
                                           END)          
                   AND HOLDERNAME NOT LIKE 'MARGIN%'          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
         D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,FILLER1,REASON          
                             
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),          
                   SETT_NO,          
                   SETT_TYPE,          
                   D.PARTY_CODE,          
                   D.SCRIP_CD,          
                   D.SCRIP_NAME,          
                   CERTNO,          
                   CQTY = 0,          
                   DQTY = SUM(QTY),          
                   SLIPNO,          
                   DPID = DP.DPID,          
                   CLTDPID = DP.DPCLTNO,          
                   TRTYPE,          
                   REASON = (CASE           
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'          
                               ELSE 'TRANS TO BEN'          
                             END),          
                   BDPID,          
                   BCLTDPID,          
                   TRANSDATE1 = TRANSDATE,          
                   FLAG = 1          
          FROM     TBLDEL_TRANSSTAT_QRLY D,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,          
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1,          
                   ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP          
          WHERE    DRCR = 'D'          
                   AND SHARETYPE <> 'AUCTION'          
                   AND CERTNO LIKE 'IN%'          
                   AND DELIVERED = 'G'          
                   AND FILLER2 = 0          
                   AND C2.CL_CODE = C1.CL_CODE          
                   AND C2.PARTY_CODE = D.PARTY_CODE          
                   AND TRANSDATE >= @NEWFROMDATE          
                   AND TRANSDATE <= @TODATE          
                   AND D.PARTY_CODE >= @FROMPARTY          
                   AND D.PARTY_CODE <= @TOPARTY          
                   AND D.SCRIP_CD >= @FROMSCRIP          
                   AND D.SCRIP_CD <= @TOSCRIP          
                   AND BDPID = @@LOOPDPID          
                   AND BCLTDPID = @@LOOPCLTDPID          
                   /*AND DESCRIPTION NOT LIKE '%POOL%'    */      
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO          
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)   
                   AND C1.BRANCH_CD LIKE (CASE           
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME          
                                            ELSE '%'          
                                          END)          
                   AND C1.SUB_BROKER LIKE (CASE           
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
                   AND C1.TRADER LIKE (CASE           
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C1.FAMILY LIKE (CASE           
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME          
                                         ELSE '%'          
                                       END)          
                   AND C2.PARTY_CODE LIKE (CASE           
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME          
                                             ELSE '%'          
                                           END)          
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,          
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,          
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,          
                   BDPID,BCLTDPID,HOLDERNAME          
          
          
          INSERT INTO #TABLE2          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),          
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
                   REASON = 'OPENING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),          
                   FLAG = 0          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 < @FROMDATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          UNION ALL          
          SELECT *          
          FROM   TBLDEL_TRANSSTAT1_QRLY          
          WHERE  TRANSDATE1 >= @FROMDATE          
                 AND TRANSDATE1 <= @TODATE          
          UNION ALL          
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),          
                   SETT_NO = '',          
                   SETT_TYPE = '',          
                   PARTY_CODE,          
                   SCRIP_CD,          
                   SCRIP_NAME,          
                   CERTNO,          
                   CQTY = (CASE           
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)          
                             ELSE 0          
                           END),          
                   DQTY = (CASE           
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)          
                             ELSE 0          
                           END),   
                   SLIPNO = '0',          
                   DPID = '',          
                   CLTDPID = '',          
                   TRTYPE = '0',          
  REASON = 'CLOSING BALANCE',          
                   BDPID = '',          
                   BCLTDPID = '',          
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),          
                   FLAG = 6          
          FROM     TBLDEL_TRANSSTAT1_QRLY          
          WHERE    TRANSDATE1 <= @TODATE          
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO          
          ORDER BY PARTY_CODE,          
                   SCRIP_CD,          
                   CERTNO,          
                   TRANSDATE1,          
                   FLAG,          
                   SETT_NO,          
                   SETT_TYPE          
                             
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY          
          
          
                
      FETCH NEXT FROM STATEMENT_CURSOR          
      INTO @@LOOPDPID,          
           @@LOOPCLTDPID          
    END          
              
  CLOSE STATEMENT_CURSOR          
            
  DEALLOCATE STATEMENT_CURSOR          
          
 INSERT INTO #TABLEREPORT          
  SELECT   'BSECM', *          
      FROM     #TABLE2          
  WHERE  CQTY <> 0 OR DQTY <> 0                
 ORDER BY PARTY_CODE,          
               SCRIP_CD,          
               FLAG,          
               TRANSDATEDT          
                         
      TRUNCATE TABLE #TABLE2          
      DROP TABLE #TABLE2          
          
          
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER          
SELECT             
 Q.*          
FROM             
 #TABLEREPORT Q (NOLOCK)            
          
          
TRUNCATE TABLE #TABLEREPORT          
DROP TABLE #TABLEREPORT          
*/
          
/*         
        
         
SELECT EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN,        
effdate, SUM(QTY)        
FROM C_SECURITIESMST        
where effdate >= '' and effdate <= ''        
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, effdate        
        
*/            
            
CREATE TABLE #COLL        
(        
 EXCHANGE VARCHAR(10),        
 SEGMENT VARCHAR(20),        
 EXCSEGMENT VARCHAR(10),        
 EFFDT VARCHAR(10),        
 PARTY_CODE VARCHAR(10),        
 SCRIP_CD VARCHAR(20),        
 SERIES VARCHAR(10),        
 SCRIP_NAME VARCHAR(100),        
 CERTNO VARCHAR(20),        
 CQTY INT,        
 DQTY INT,        
 REASON VARCHAR(255),        
 TRANSDATEDT DATETIME,        
 FLAG INT        
)        
         
INSERT INTO #COLL        
SELECT      
 EXCHANGE,      
 SEGMENT,      
 '',      
 CONVERT(varchar,CONVERT(DATETIME, @FROMDATE,109),103),      
 PARTY_CODE,      
 SCRIP_CD,      
 SERIES,      
 '',      
 ISIN,      
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),      
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),      
 'OPENING BALANCE',        
 CONVERT(DATETIME, @FROMDATE,109),        
 2        
 FROM      
 (      
  SELECT         
  EXCHANGE,        
  SEGMENT,         
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,        
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))      
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST       
  WHERE        
   EFFDATE < @FROMDATE        
   AND PARTY_CODE   >= @FROMPARTY      
   AND PARTY_CODE <= @TOPARTY      
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS        
 ) X      
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN      
      
      
      
INSERT INTO #COLL        
SELECT         
EXCHANGE,        
SEGMENT,        
'',        
convert(varchar,effdate,103),         
PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,        
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),        
UPPER(REMARKS),        
EFFDATE,        
1        
FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST        
WHERE        
 EFFDATE >= @FROMDATE        
 AND EFFDATE <= @TODATE + ' 23:59:59'        
 AND PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS        
        
        
/*      
INSERT INTO #COLL        
SELECT         
EXCHANGE,        
SEGMENT,        
'',        
convert(varchar,effdate,103),     PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,        
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),        
'CLOSING BALANCE',        
@TODATE + ' 23:59:59',        
6        
FROM MSAJAG.DBO.C_SECURITIESMST (NOLOCK)        
WHERE        
 EFFDATE <= @TODATE + ' 23:59:59'        
 AND PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS        
*/      
      
INSERT INTO #COLL        
SELECT      
 EXCHANGE,      
 SEGMENT,      
 '',      
 CONVERT(varchar,CONVERT(DATETIME, @TODATE,109),103),      
 PARTY_CODE,      
 SCRIP_CD,      
 SERIES,      
 '',      
 ISIN,      
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),      
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),      
 'CLOSING BALANCE',        
 @TODATE + ' 23:59:59',        
 6        
 FROM      
 (      
  SELECT         
  EXCHANGE,        
  SEGMENT,         
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,        
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),        
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))      
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST       
  WHERE        
   EFFDATE <= @TODATE  + ' 23:59:59'      
   AND PARTY_CODE   >= @FROMPARTY      
   AND PARTY_CODE <= @TOPARTY      
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS        
 ) X      
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN      
        
        
        
UPDATE #COLL          
SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')' ,        
EXCSEGMENT =         
 ( CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL' THEN 'NSECM'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'CAPITAL' THEN 'BSECM'        
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN 'NSEFO'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'FUTURES' THEN 'BSEFO'        
WHEN EXCHANGE = 'NCX' AND SEGMENT = 'FUTURES' THEN 'NCDX'        
WHEN EXCHANGE = 'MCX' AND SEGMENT = 'FUTURES' THEN 'MCDX'        
WHEN EXCHANGE = 'ALL' AND SEGMENT = 'COMMON' THEN 'DBCOMMON'        
WHEN EXCHANGE = 'BCM' AND SEGMENT = 'FUTURES' THEN 'BSEFOPCM'        
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'SLBS' THEN 'BSESLBS'        
WHEN EXCHANGE = 'BSX' AND SEGMENT = 'FUTURES' THEN 'BSECURFO'        
WHEN EXCHANGE = 'MCD' AND SEGMENT = 'FUTURES' THEN 'MCDXCDS'        
WHEN EXCHANGE = 'MCM' AND SEGMENT = 'FUTURES' THEN 'MCDXPCM'        
WHEN EXCHANGE = 'NCM' AND SEGMENT = 'FUTURES' THEN 'NSEFOPCM'        
WHEN EXCHANGE = 'NMC' AND SEGMENT = 'FUTURES' THEN 'NMCE'        
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'SLBS' THEN 'NSESLBS'        
WHEN EXCHANGE = 'NSX' AND SEGMENT = 'FUTURES' THEN 'NSECURFO'        
WHEN EXCHANGE = 'NXM' AND SEGMENT = 'FUTURES' THEN 'NSECURFOPCM'          
ELSE 'UNKNOWN' END)        
        
        
UPDATE #COLL        
SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  ANAND1.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),          
  ANAND1.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.SCRIP_CD = #COLL.SCRIP_CD          
  AND S2.SERIES = #COLL.SERIES          
        
            
        
UPDATE #COLL        
SET SCRIP_NAME = S1.LONG_NAME          
 FROM          
  AngelBSECM.BSEDB_AB.DBO.SCRIP1 S1 (NOLOCK),          
  AngelBSECM.BSEDB_AB.DBO.SCRIP2 S2 (NOLOCK)          
 WHERE          
  S1.CO_CODE = S2.CO_CODE          
  AND S2.BSECODE = #COLL.SCRIP_CD          
        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER          
SELECT             
 EXCSEGMENT,        
 EFFDT,        
 '',        
 '',        
 PARTY_CODE,        
 SCRIP_CD,        
 SCRIP_NAME,        
 CERTNO,        
 CQTY,        
 DQTY,        
 '0',        
 '',        
 '',        
 '0',        
 UPPER(REASON),        
 '',        
 '',        
 TRANSDATEDT ,        
 FLAG         
FROM             
 #COLL  (NOLOCK)            
WHERE      
 PARTY_CODE   >= @FROMPARTY      
 AND PARTY_CODE <= @TOPARTY      
 AND ( CQTY <> 0  OR DQTY <> 0)      
        
TRUNCATE TABLE #COLL        
DROP TABLE #COLL        
      
select * from V2_CLASS_QUARTERLYSECLEDGER      
      
SET ANSI_NULLS OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYSHARELEDGER_05092009
-- --------------------------------------------------
              
CREATE PROCEDURE [dbo].[V2_PROC_QUARTERLYSHARELEDGER_05092009]              
              
(              
               @FROMDATE   VARCHAR(11),              
               @TODATE     VARCHAR(11),              
               @FROMPARTY  VARCHAR(10),              
               @TOPARTY    VARCHAR(10),              
               @FROMSCRIP  VARCHAR(12),              
               @TOSCRIP    VARCHAR(12),              
               @STATUSID   VARCHAR(50),              
               @STATUSNAME VARCHAR(50))              
AS          
/*                
        
          
SELECT COUNT(1) FROM MSAJAG.DBO.DELTRANS          
EXEC V2_PROC_QUARTERLYSHARELEDGER  'JUL  1 1900', 'JUN 15 2009', '0a146', '0a146', '0000000000', 'ZZZZZZZZZZ', 'BROKER', 'BROKER'                    
*/              
  DECLARE  @@LOOPDPID VARCHAR(10)              
                
  DECLARE  @@LOOPCLTDPID VARCHAR(16)              
                
  DECLARE  @NEWFROMDATE VARCHAR(11)              
                                      
  SET @@LOOPDPID = 'AAAA'              
                
  SET @@LOOPCLTDPID = 'AAAA'              
                                    
  SELECT @NEWFROMDATE = 'APR  1 1950'              
              
TRUNCATE TABLE V2_CLASS_QUARTERLYSECLEDGER              
                                      
              
      CREATE TABLE #TABLEREPORT (              
  SEGMENT VARCHAR(5),              
        TRANSDATE   VARCHAR(10),              
        SETT_NO     VARCHAR(10),              
        SETT_TYPE   VARCHAR(5),              
        PARTY_CODE  VARCHAR(10),              
        SCRIP_CD    VARCHAR(20),              
        SCRIP_NAME  VARCHAR(255),              
        CERTNO      VARCHAR(20),              
        CQTY        INT,              
        DQTY        INT,              
        SLIPNO      VARCHAR(20),              
        DPID        VARCHAR(8),              
        CLTDPID     VARCHAR(16),              
        TRTYPE      VARCHAR(6),              
        REASON      VARCHAR(255),              
        BDPID       VARCHAR(8),              
        BCLTDPID    VARCHAR(16),              
        TRANSDATEDT DATETIME,              
        FLAG        INT)                        
          
      CREATE TABLE #TABLE1 (              
        TRANSDATE   VARCHAR(10),              
        SETT_NO     VARCHAR(10),              
        SETT_TYPE   VARCHAR(5),              
        PARTY_CODE  VARCHAR(10),              
        SCRIP_CD    VARCHAR(20),              
        SCRIP_NAME  VARCHAR(255),              
        CERTNO      VARCHAR(20),              
        CQTY        INT,              
        DQTY        INT,              
        SLIPNO      VARCHAR(20),              
        DPID        VARCHAR(8),              
        CLTDPID     VARCHAR(16),              
        TRTYPE      VARCHAR(6),              
        REASON      VARCHAR(255),              
        BDPID       VARCHAR(8),              
        BCLTDPID    VARCHAR(16),              
        TRANSDATEDT DATETIME,              
        FLAG        INT)              
              
              
      CREATE TABLE #TABLE2 (              
        TRANSDATE   VARCHAR(10),              
        SETT_NO     VARCHAR(10),              
        SETT_TYPE   VARCHAR(5),              
        PARTY_CODE  VARCHAR(10),              
        SCRIP_CD    VARCHAR(20),              
        SCRIP_NAME  VARCHAR(255),              
        CERTNO      VARCHAR(20),              
        CQTY        INT,              
        DQTY        INT,              
        SLIPNO      VARCHAR(20),              
        DPID        VARCHAR(8),              
        CLTDPID     VARCHAR(16),              
        TRTYPE      VARCHAR(6),              
        REASON      VARCHAR(255),              
        BDPID       VARCHAR(8),              
        BCLTDPID    VARCHAR(16),              
        TRANSDATEDT DATETIME,              
        FLAG        INT)              
              
              
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY           
              
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY              
  SELECT D.*,''               
  FROM   ANGELDEMAT.MSAJAG.DBO.DELTRANS  D           
  WHERE  D.PARTY_CODE >= @FROMPARTY              
         AND D.PARTY_CODE <= @TOPARTY              
    AND D.SCRIP_CD >= @FROMSCRIP              
         AND D.SCRIP_CD <= @TOSCRIP              
         AND D.TRANSDATE >= @NEWFROMDATE              
         AND D.TRANSDATE <= @TODATE              
              
 UPDATE TBLDEL_TRANSSTAT_QRLY          
 SET SCRIP_NAME = S1.LONG_NAME              
 FROM              
  ANGELDEMAT.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),              
  ANGELDEMAT.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)              
 WHERE              
  S1.CO_CODE = S2.CO_CODE              
  AND S2.SCRIP_CD = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD              
  AND S2.SERIES = TBLDEL_TRANSSTAT_QRLY.SERIES              
                
               
 UPDATE TBLDEL_TRANSSTAT_QRLY              
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'              
 WHERE ISNULL(SCRIP_NAME,'') = ''              
              
              
  DECLARE STATEMENT_CURSOR CURSOR  FOR              
                
                
  SELECT DISTINCT DPID,              
                DPCLTNO              
  FROM   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP D (NOLOCK)              
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'      
                       
  OPEN STATEMENT_CURSOR              
                
  FETCH NEXT FROM STATEMENT_CURSOR              
  INTO @@LOOPDPID,              
       @@LOOPCLTDPID              
                     
  WHILE @@FETCH_STATUS = 0              
    BEGIN              
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY              
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO,              
                   DPID = BDPID,              
                   CLTDPID = BCLTDPID,              
                   TRTYPE,              
                   REASON = (CASE               
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'              
                               ELSE 'TRANS TO BEN'              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 1              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1              
          WHERE    DRCR = 'D'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = 'G'              
                   AND FILLER2 = 0              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'              
                   AND HOLDERNAME NOT LIKE 'MARGIN%'              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
          ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,HOLDERNAME              
                                 
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO,              
                   DPID = DPID,              
                   CLTDPID = CLTDPID,              
                   TRTYPE,              
                   REASON = (CASE               
                                               WHEN REASON = 'DEMAT' THEN 'PAY-IN'              
                           ELSE REASON              
                                             END),              
             BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 2              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1              
          WHERE    DRCR = 'C'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   /*AND DELIVERED = '0'*/              
                   AND FILLER2 = 1              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   /*AND SETT_NO = '2000000' */              
                   AND FILLER1 NOT IN ('SPLIT','BONUS')              
                   AND C1.BRANCH_CD LIKE (CASE               
                   WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,REASON              
                                 
          UNION ALL              
                        
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO = 0,              
         DPID = '',              
                   CLTDPID = '',              
                   TRTYPE,              
                   UPPER(REASON),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 3              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1              
          WHERE    DRCR = 'C'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = '0'              
                   AND FILLER2 = 1              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   AND FILLER1 IN ('SPLIT','BONUS')              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,REASON              
                              
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = 0,              
                   DQTY = SUM(QTY),              
                   SLIPNO = (CASE               
                               WHEN FILLER1 = 'SPLIT' THEN 0              
                               ELSE SLIPNO              
      END),              
                   DPID = (CASE               
                             WHEN TRTYPE IN (1000,907,908) THEN ''              
                             WHEN FILLER1 = 'SPLIT' THEN ''              
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''              
                             ELSE DPID              
                           END),              
                   CLTDPID = (CASE               
                                WHEN TRTYPE IN (1000,907,908) THEN ''              
                                WHEN FILLER1 = 'SPLIT' THEN ''              
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''              
                                ELSE CLTDPID              
                              END),           
                   TRTYPE,              
                   REASON = (CASE               
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE              
                               ELSE (CASE               
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'              
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1              
                                       ELSE (CASE               
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'              
                                               ELSE REASON              
                                             END)              
                                     END)              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 4              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
       ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1              
          WHERE    FILLER2 = 1              
        AND DRCR = 'D'              
                   AND DELIVERED <> '0'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
         AND BCLTDPID = @@LOOPCLTDPID              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                   ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND HOLDERNAME NOT LIKE 'MARGIN%'              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,FILLER1,REASON              
                                 
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = 0,              
                   DQTY = SUM(QTY),              
                   SLIPNO,              
                   DPID = DP.DPID,              
                   CLTDPID = DP.DPCLTNO,              
                   TRTYPE,              
                   REASON = (CASE               
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'              
                               ELSE 'TRANS TO BEN'              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 1              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,              
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1,              
                   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP              
          WHERE    DRCR = 'D'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = 'G'              
                   AND FILLER2 = 0              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
       AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   /*AND DESCRIPTION NOT LIKE '%POOL%'*/          
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO              
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                             END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,              
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,HOLDERNAME              
              
              
          INSERT INTO #TABLE1              
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),              
                   SETT_NO = '',              
                   SETT_TYPE = '',              
                   PARTY_CODE,              
                   SCRIP_CD,              
                   SCRIP_NAME,              
                   CERTNO,              
                   CQTY = (CASE               
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)              
                             ELSE 0              
                           END),              
                   DQTY = (CASE               
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)              
                             ELSE 0              
                           END),              
                   SLIPNO = '0',              
                   DPID = '',              
                   CLTDPID = '',              
                   TRTYPE = '0',              
                   REASON = 'OPENING BALANCE',              
                   BDPID = '',              
                   BCLTDPID = '',              
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),              
         FLAG = 0              
         FROM     TBLDEL_TRANSSTAT1_QRLY              
          WHERE    TRANSDATE1 < @FROMDATE              
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO              
          UNION ALL              
          SELECT *              
          FROM   TBLDEL_TRANSSTAT1_QRLY              
          WHERE  TRANSDATE1 >= @FROMDATE              
                 AND TRANSDATE1 <= @TODATE              
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),              
                   SETT_NO = '',              
                   SETT_TYPE = '',              
                   PARTY_CODE,              
                   SCRIP_CD,              
                   SCRIP_NAME,              
                   CERTNO,              
                   CQTY = (CASE               
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)              
                             ELSE 0              
                           END),              
                  DQTY = (CASE               
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)              
                             ELSE 0              
                           END),              
                   SLIPNO = '0',              
                   DPID = '',              
                   CLTDPID = '',              
                   TRTYPE = '0',              
                   REASON = 'CLOSING BALANCE',             
                   BDPID = '',              
                   BCLTDPID = '',              
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),              
                   FLAG = 6              
          FROM     TBLDEL_TRANSSTAT1_QRLY              
          WHERE    TRANSDATE1 <= @TODATE              
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO              
          ORDER BY PARTY_CODE,              
                   SCRIP_CD,              
                   CERTNO,              
                   TRANSDATE1,              
                   FLAG,              
                   SETT_NO,              
                   SETT_TYPE              
                          
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY              
              
              
                    
      FETCH NEXT FROM STATEMENT_CURSOR              
      INTO @@LOOPDPID,              
           @@LOOPCLTDPID              
    END              
                  
  CLOSE STATEMENT_CURSOR              
                
  DEALLOCATE STATEMENT_CURSOR              
          
 INSERT INTO #TABLEREPORT              
  SELECT   'NSECM', *              
      FROM     #TABLE1              
  WHERE  CQTY <> 0 OR DQTY <> 0                    
 ORDER BY PARTY_CODE,              
               SCRIP_CD,              
               FLAG,              
               TRANSDATEDT              
                             
      TRUNCATE TABLE #TABLE1              
      DROP TABLE #TABLE1              
              
              
/* NOW DOING BSECM */              
              
          
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY              
              
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY              
  SELECT D.*,''               
  FROM   ANGELDEMAT.BSEDB.DBO.DELTRANS  D           
  WHERE  D.PARTY_CODE >= @FROMPARTY              
         AND D.PARTY_CODE <= @TOPARTY           
         AND D.SCRIP_CD >= @FROMSCRIP              
         AND D.SCRIP_CD <= @TOSCRIP              
         AND D.TRANSDATE >= @NEWFROMDATE              
         AND D.TRANSDATE <= @TODATE              
              
 UPDATE TBLDEL_TRANSSTAT_QRLY              
 SET SCRIP_NAME = S1.LONG_NAME              
 FROM              
  ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 (NOLOCK),              
  ANGELDEMAT.BSEDB.DBO.SCRIP2 S2 (NOLOCK)              
 WHERE              
  S1.CO_CODE = S2.CO_CODE              
  AND S2.BSECODE = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD    
                
               
 UPDATE TBLDEL_TRANSSTAT_QRLY              
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'              
 WHERE ISNULL(SCRIP_NAME,'') = ''              
              
  DECLARE STATEMENT_CURSOR CURSOR  FOR              
                
                
      
  SELECT DISTINCT DPID,              
                DPCLTNO              
  FROM   ANGELDEMAT.BSEDB.DBO.DELIVERYDP D (NOLOCK)              
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'      
                
  OPEN STATEMENT_CURSOR              
                
  FETCH NEXT FROM STATEMENT_CURSOR              
  INTO @@LOOPDPID,              
       @@LOOPCLTDPID              
                     
  WHILE @@FETCH_STATUS = 0              
    BEGIN              
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY              
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
 CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO,              
                   DPID = BDPID,              
                   CLTDPID = BCLTDPID,              
                   TRTYPE,              
                   REASON = (CASE               
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'              
                               ELSE 'TRANS TO BEN'              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 1              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1              
          WHERE    DRCR = 'D'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = 'G'              
                   AND FILLER2 = 0              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
     AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'              
                   AND HOLDERNAME NOT LIKE 'MARGIN%'              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
     WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,HOLDERNAME              
                                 
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO,              
                   DPID = DPID,              
                   CLTDPID = CLTDPID,              
                   TRTYPE,              
                   UPPER(REASON),              
               BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,                         FLAG = 2              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1              
          WHERE    DRCR = 'C'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   /*AND DELIVERED = '0'*/              
                   AND FILLER2 = 1              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   /*AND SETT_NO = '2000000' */              
                   AND FILLER1 NOT IN ('SPLIT','BONUS')              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                 END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                      ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
               BDPID,BCLTDPID,REASON              
                                 
          UNION ALL              
                        
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   SCRIP_NAME = D.SCRIP_CD + '( ' + CERTNO + ')',              
                   CERTNO,              
                   CQTY = SUM(QTY),              
                   DQTY = 0,              
                   SLIPNO = 0,              
                   DPID = '',              
                   CLTDPID = '',              
                   TRTYPE,              
                   UPPER(REASON),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 3              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1       
          WHERE    DRCR = 'C'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = '0'              
                   AND FILLER2 = 1              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
          AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   AND FILLER1 IN ('SPLIT','BONUS')              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                 END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,REASON              
                                 
          UNION ALL              
          SELECT  TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                   CERTNO,              
                   CQTY = 0,              
                   DQTY = SUM(QTY),              
                   SLIPNO = (CASE               
                               WHEN FILLER1 = 'SPLIT' THEN 0              
                               ELSE SLIPNO              
                             END),              
                   DPID = (CASE               
                             WHEN TRTYPE IN (1000,907,908) THEN ''              
                             WHEN FILLER1 = 'SPLIT' THEN ''              
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''              
                             ELSE DPID              
                           END),              
                   CLTDPID = (CASE               
                                WHEN TRTYPE IN (1000,907,908) THEN ''              
                                WHEN FILLER1 = 'SPLIT' THEN ''              
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''              
                                ELSE CLTDPID              
                              END),              
                   TRTYPE,              
           REASON = (CASE               
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE              
                               ELSE (CASE               
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'              
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1              
                                       ELSE (CASE               
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'              
                           ELSE REASON              
                                             END)              
                                     END)              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 4              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1              
          WHERE    FILLER2 = 1              
                   AND DRCR = 'D'              
                   AND DELIVERED <> '0'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                            ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                          WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                              ELSE '%'              
                                           END)              
                   AND HOLDERNAME NOT LIKE 'MARGIN%'              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
         D.SCRIP_CD,CERTNO,SLIPNO,DPID,              
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,FILLER1,REASON              
                                 
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),              
                   SETT_NO,              
                   SETT_TYPE,              
                   D.PARTY_CODE,              
                   D.SCRIP_CD,              
                   D.SCRIP_NAME,              
                CERTNO,              
                   CQTY = 0,              
                   DQTY = SUM(QTY),              
                   SLIPNO,              
                   DPID = DP.DPID,              
                   CLTDPID = DP.DPCLTNO,              
                   TRTYPE,              
                   REASON = (CASE               
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'              
                               ELSE 'TRANS TO BEN'              
                             END),              
                   BDPID,              
                   BCLTDPID,              
                   TRANSDATE1 = TRANSDATE,              
                   FLAG = 1              
          FROM     TBLDEL_TRANSSTAT_QRLY D,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,              
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1,              
                   ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP              
          WHERE    DRCR = 'D'              
                   AND SHARETYPE <> 'AUCTION'              
                   AND CERTNO LIKE 'IN%'              
                   AND DELIVERED = 'G'              
                   AND FILLER2 = 0              
                   AND C2.CL_CODE = C1.CL_CODE              
                   AND C2.PARTY_CODE = D.PARTY_CODE              
                   AND TRANSDATE >= @NEWFROMDATE              
                   AND TRANSDATE <= @TODATE              
                   AND D.PARTY_CODE >= @FROMPARTY              
                   AND D.PARTY_CODE <= @TOPARTY              
                   AND D.SCRIP_CD >= @FROMSCRIP              
                   AND D.SCRIP_CD <= @TOSCRIP              
                   AND BDPID = @@LOOPDPID              
                   AND BCLTDPID = @@LOOPCLTDPID              
                   /*AND DESCRIPTION NOT LIKE '%POOL%'    */          
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO              
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)       
                   AND C1.BRANCH_CD LIKE (CASE               
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME              
                                    ELSE '%'              
                                          END)              
                   AND C1.SUB_BROKER LIKE (CASE               
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
                   AND C1.TRADER LIKE (CASE               
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C1.FAMILY LIKE (CASE               
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME              
                                         ELSE '%'              
                                       END)              
                   AND C2.PARTY_CODE LIKE (CASE               
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME              
                                             ELSE '%'              
                                           END)              
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,              
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,              
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,              
                   BDPID,BCLTDPID,HOLDERNAME              
              
              
          INSERT INTO #TABLE2              
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),              
                   SETT_NO = '',              
                   SETT_TYPE = '',              
                   PARTY_CODE,              
                   SCRIP_CD,              
     SCRIP_NAME,              
                   CERTNO,              
                   CQTY = (CASE               
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)              
                             ELSE 0              
                           END),              
                   DQTY = (CASE               
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)              
                             ELSE 0              
                           END),              
                   SLIPNO = '0',              
                   DPID = '',              
                   CLTDPID = '',              
                   TRTYPE = '0',              
                   REASON = 'OPENING BALANCE',              
                   BDPID = '',              
                   BCLTDPID = '',              
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),              
                   FLAG = 0              
          FROM     TBLDEL_TRANSSTAT1_QRLY              
          WHERE    TRANSDATE1 < @FROMDATE              
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO              
          UNION ALL              
          SELECT *              
          FROM   TBLDEL_TRANSSTAT1_QRLY              
          WHERE  TRANSDATE1 >= @FROMDATE              
                 AND TRANSDATE1 <= @TODATE              
          UNION ALL              
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),              
                   SETT_NO = '',              
                   SETT_TYPE = '',              
                   PARTY_CODE,              
                   SCRIP_CD,              
                   SCRIP_NAME,              
                   CERTNO,              
                   CQTY = (CASE               
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)              
                             ELSE 0              
                           END),              
                   DQTY = (CASE               
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)              
                             ELSE 0              
                           END),       
                   SLIPNO = '0',              
                   DPID = '',              
                   CLTDPID = '',              
                   TRTYPE = '0',              
  REASON = 'CLOSING BALANCE',              
                   BDPID = '',              
                   BCLTDPID = '',              
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),              
                   FLAG = 6              
          FROM     TBLDEL_TRANSSTAT1_QRLY              
          WHERE    TRANSDATE1 <= @TODATE              
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO              
          ORDER BY PARTY_CODE,              
                   SCRIP_CD,              
                   CERTNO,              
                   TRANSDATE1,              
                   FLAG,              
                   SETT_NO,              
                   SETT_TYPE              
                                 
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY              
              
              
                    
      FETCH NEXT FROM STATEMENT_CURSOR              
      INTO @@LOOPDPID,              
           @@LOOPCLTDPID              
    END              
                  
  CLOSE STATEMENT_CURSOR              
                
  DEALLOCATE STATEMENT_CURSOR              
              
 INSERT INTO #TABLEREPORT              
  SELECT   'BSECM', *              
      FROM     #TABLE2              
  WHERE  CQTY <> 0 OR DQTY <> 0                    
 ORDER BY PARTY_CODE,              
               SCRIP_CD,              
               FLAG,              
               TRANSDATEDT              
                             
      TRUNCATE TABLE #TABLE2              
      DROP TABLE #TABLE2              
              
              
              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER              
SELECT                 
 Q.*              
FROM            
 #TABLEREPORT Q (NOLOCK)                
              
              
TRUNCATE TABLE #TABLEREPORT              
DROP TABLE #TABLEREPORT              
              
/*             
            
             
SELECT EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN,            
effdate, SUM(QTY)            
FROM C_SECURITIESMST            
where effdate >= '' and effdate <= ''            
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, effdate            
            
*/                
                
CREATE TABLE #COLL            
(            
 EXCHANGE VARCHAR(10),            
 SEGMENT VARCHAR(20),            
 EXCSEGMENT VARCHAR(10),            
 EFFDT VARCHAR(10),            
 PARTY_CODE VARCHAR(10),            
 SCRIP_CD VARCHAR(20),            
 SERIES VARCHAR(10),            
 SCRIP_NAME VARCHAR(100),            
 CERTNO VARCHAR(20),            
 CQTY INT,            
 DQTY INT,            
 REASON VARCHAR(255),            
 TRANSDATEDT DATETIME,            
 FLAG INT            
)            
             
INSERT INTO #COLL            
SELECT          
 EXCHANGE,          
 SEGMENT,          
 '',          
 CONVERT(varchar,CONVERT(DATETIME, @FROMDATE,109),103),          
 PARTY_CODE,          
 SCRIP_CD,          
 SERIES,          
 '',          
 ISIN,          
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),          
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),          
 'OPENING BALANCE',            
 CONVERT(DATETIME, @FROMDATE,109),            
 2            
 FROM          
 (          
  SELECT             
  EXCHANGE,            
  SEGMENT,             
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,            
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),            
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))          
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST            
  WHERE            
   EFFDATE < @FROMDATE               AND PARTY_CODE   >= @FROMPARTY          
   AND PARTY_CODE <= @TOPARTY          
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS            
 ) X          
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN          
          
          
          
INSERT INTO #COLL            
SELECT             
EXCHANGE,            
SEGMENT,            
'',            
convert(varchar,effdate,103),             
PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,            
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),            
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),            
UPPER(REMARKS),            
EFFDATE,            
1            
FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST             
WHERE            
 EFFDATE >= @FROMDATE            
 AND EFFDATE <= @TODATE + ' 23:59:59'            
 AND PARTY_CODE   >= @FROMPARTY          
 AND PARTY_CODE <= @TOPARTY          
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS            
            
            
/*          
INSERT INTO #COLL            
SELECT             
EXCHANGE,            
SEGMENT,            
'',            
convert(varchar,effdate,103),     PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,            
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),            
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),            
'CLOSING BALANCE',            
@TODATE + ' 23:59:59',            
6            
FROM MSAJAG.DBO.C_SECURITIESMST (NOLOCK)            
WHERE            
 EFFDATE <= @TODATE + ' 23:59:59'            
 AND PARTY_CODE   >= @FROMPARTY          
 AND PARTY_CODE <= @TOPARTY          
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS            
*/          
          
INSERT INTO #COLL            
SELECT          
 EXCHANGE,          
 SEGMENT,          
 '',          
 CONVERT(varchar,CONVERT(DATETIME, @TODATE,109),103),          
 PARTY_CODE,          
 SCRIP_CD,          
 SERIES,          
 '',          
 ISIN,          
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),          
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),          
 'CLOSING BALANCE',            
 @TODATE + ' 23:59:59',            
 6            
 FROM          
 (          
  SELECT             
  EXCHANGE,            SEGMENT,             
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,            
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),            
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))          
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST        
  WHERE            
   EFFDATE <= @TODATE  + ' 23:59:59'          
   AND PARTY_CODE   >= @FROMPARTY          
   AND PARTY_CODE <= @TOPARTY          
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS            
 ) X          
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN          
            
            
            
UPDATE #COLL              
SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')' ,            
EXCSEGMENT =             
 ( CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL' THEN 'NSECM'            
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'CAPITAL' THEN 'BSECM'            
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN 'NSEFO'            
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'FUTURES' THEN 'BSEFO'            
WHEN EXCHANGE = 'NCX' AND SEGMENT = 'FUTURES' THEN 'NCDX'            
WHEN EXCHANGE = 'MCX' AND SEGMENT = 'FUTURES' THEN 'MCDX'            
WHEN EXCHANGE = 'ALL' AND SEGMENT = 'COMMON' THEN 'DBCOMMON'            
WHEN EXCHANGE = 'BCM' AND SEGMENT = 'FUTURES' THEN 'BSEFOPCM'            
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'SLBS' THEN 'BSESLBS'            
WHEN EXCHANGE = 'BSX' AND SEGMENT = 'FUTURES' THEN 'BSECURFO'            
WHEN EXCHANGE = 'MCD' AND SEGMENT = 'FUTURES' THEN 'MCDXCDS'            
WHEN EXCHANGE = 'MCM' AND SEGMENT = 'FUTURES' THEN 'MCDXPCM'            
WHEN EXCHANGE = 'NCM' AND SEGMENT = 'FUTURES' THEN 'NSEFOPCM'            
WHEN EXCHANGE = 'NMC' AND SEGMENT = 'FUTURES' THEN 'NMCE'            
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'SLBS' THEN 'NSESLBS'            
WHEN EXCHANGE = 'NSX' AND SEGMENT = 'FUTURES' THEN 'NSECURFO'            
WHEN EXCHANGE = 'NXM' AND SEGMENT = 'FUTURES' THEN 'NSECURFOPCM'              
ELSE 'UNKNOWN' END)            
            
            
UPDATE #COLL            
SET SCRIP_NAME = S1.LONG_NAME              
 FROM              
  ANAND1.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),              
  ANAND1.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)              
 WHERE              
  S1.CO_CODE = S2.CO_CODE              
  AND S2.SCRIP_CD = #COLL.SCRIP_CD              
  AND S2.SERIES = #COLL.SERIES              
            
                
            
UPDATE #COLL            
SET SCRIP_NAME = S1.LONG_NAME              
 FROM              
  ANAND.BSEDB_AB.DBO.SCRIP1 S1 (NOLOCK),              
  ANAND.BSEDB_AB.DBO.SCRIP2 S2 (NOLOCK)              
 WHERE              
  S1.CO_CODE = S2.CO_CODE              
  AND S2.BSECODE = #COLL.SCRIP_CD              
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER              
SELECT                 
 EXCSEGMENT,            
 EFFDT,            
 '',            
 '',            
 PARTY_CODE,            
 SCRIP_CD,            
 SCRIP_NAME,            
 CERTNO,            
 CQTY,            
 DQTY,            
 '0',            
 '',            
 '',            
 '0',            
 UPPER(REASON),            
 '',            
 '',            
 TRANSDATEDT ,            
 FLAG             
FROM                 
 #COLL  (NOLOCK)                
WHERE          
 PARTY_CODE   >= @FROMPARTY          
 AND PARTY_CODE <= @TOPARTY          
 AND ( CQTY <> 0  OR DQTY <> 0)          
            
TRUNCATE TABLE #COLL            
DROP TABLE #COLL            
          
select * from V2_CLASS_QUARTERLYSECLEDGER          
          
SET ANSI_NULLS OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_QUARTERLYSHARELEDGER_14012013
-- --------------------------------------------------
            
CREATE PROCEDURE [dbo].[V2_PROC_QUARTERLYSHARELEDGER_14012013]            
            
(            
               @FROMDATE   VARCHAR(11),            
               @TODATE     VARCHAR(11),            
               @FROMPARTY  VARCHAR(10),            
               @TOPARTY    VARCHAR(10),            
               @FROMSCRIP  VARCHAR(12),            
               @TOSCRIP    VARCHAR(12),            
               @STATUSID   VARCHAR(50),            
               @STATUSNAME VARCHAR(50))            
AS        
/*              
      
        
SELECT COUNT(1) FROM MSAJAG.DBO.DELTRANS        
EXEC V2_PROC_QUARTERLYSHARELEDGER  'JUL  1 1900', 'JUN 15 2009', '0a146', '0a146', '0000000000', 'ZZZZZZZZZZ', 'BROKER', 'BROKER'                  
*/  
            
DECLARE  @@LOOPDPID VARCHAR(10)            
          
DECLARE  @@LOOPCLTDPID VARCHAR(16)            
          
DECLARE  @NEWFROMDATE VARCHAR(11)            
                                
SET @@LOOPDPID = 'AAAA'            
          
SET @@LOOPCLTDPID = 'AAAA'            
                              
SELECT @NEWFROMDATE = 'APR  1 1950'                    
  
TRUNCATE TABLE V2_CLASS_QUARTERLYSECLEDGER  
  
EXEC ANGELDEMAT.BSEDB.DBO.RPT_HOLDCHECK_FINAL @FROMDATE, @TODATE  
  
EXEC ANGELDEMAT.MSAJAG.DBO.RPT_HOLDCHECK_FINAL @FROMDATE, @TODATE  
  
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER  
SELECT * FROM ANGELDEMAT.BSEDB.DBO.V2_DELHOLDFINAL  
  
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER  
SELECT * FROM ANGELDEMAT.MSAJAG.DBO.V2_DELHOLDFINAL  
  
/*                                    
            
      CREATE TABLE #TABLEREPORT (            
  SEGMENT VARCHAR(5),            
        TRANSDATE   VARCHAR(10),            
        SETT_NO     VARCHAR(10),            
        SETT_TYPE   VARCHAR(5),            
        PARTY_CODE  VARCHAR(10),            
        SCRIP_CD    VARCHAR(20),            
        SCRIP_NAME  VARCHAR(255),            
        CERTNO      VARCHAR(20),            
        CQTY        INT,            
        DQTY        INT,            
        SLIPNO      VARCHAR(20),            
        DPID        VARCHAR(8),            
        CLTDPID     VARCHAR(16),            
        TRTYPE      VARCHAR(6),            
        REASON      VARCHAR(255),            
        BDPID       VARCHAR(8),            
        BCLTDPID    VARCHAR(16),            
        TRANSDATEDT DATETIME,            
        FLAG        INT)                      
        
      CREATE TABLE #TABLE1 (            
        TRANSDATE   VARCHAR(10),            
        SETT_NO     VARCHAR(10),            
        SETT_TYPE   VARCHAR(5),            
        PARTY_CODE  VARCHAR(10),            
        SCRIP_CD    VARCHAR(20),            
        SCRIP_NAME  VARCHAR(255),            
        CERTNO      VARCHAR(20),            
        CQTY        INT,            
        DQTY        INT,            
        SLIPNO      VARCHAR(20),            
        DPID        VARCHAR(8),            
        CLTDPID     VARCHAR(16),            
        TRTYPE      VARCHAR(6),            
        REASON      VARCHAR(255),            
        BDPID       VARCHAR(8),            
        BCLTDPID    VARCHAR(16),            
        TRANSDATEDT DATETIME,            
        FLAG        INT)            
            
            
      CREATE TABLE #TABLE2 (            
        TRANSDATE   VARCHAR(10),            
        SETT_NO     VARCHAR(10),            
        SETT_TYPE   VARCHAR(5),            
        PARTY_CODE  VARCHAR(10),            
        SCRIP_CD    VARCHAR(20),            
        SCRIP_NAME  VARCHAR(255),            
        CERTNO      VARCHAR(20),            
        CQTY        INT,            
        DQTY        INT,            
        SLIPNO      VARCHAR(20),            
        DPID        VARCHAR(8),            
        CLTDPID     VARCHAR(16),            
        TRTYPE      VARCHAR(6),            
        REASON      VARCHAR(255),            
        BDPID       VARCHAR(8),            
        BCLTDPID    VARCHAR(16),            
        TRANSDATEDT DATETIME,            
  FLAG        INT)            
            
            
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY            
            
  
Set Transaction isolation level read uncommitted                            
select * into #Del_TransStat_TMP From ANGELDEMAT.MSAJAG.DBO.Deltrans_Report With(NoLock)                             
Where Party_Code >= @FromParty And Party_Code <= @ToParty                            
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                            
--And TransDate >= @NewFromDate and TransDate <= @ToDate        
And Filler2 = 1         
        
INSERT INTO #DEL_TRANSSTAT_TMP        
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,         
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',         
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,         
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,        
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5        
FROM #DEL_TRANSSTAT_TMP D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP1        
WHERE D.SETT_NO = S.SETT_NO        
AND D.SETT_TYPE = S.SETT_TYPE        
AND DP.DESCRIPTION NOT LIKE '%POOL%'        
AND D.BDPID = DP.DPID        
AND D.BCLTDPID = DP.DPCLTNO        
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')        
AND DP1.DESCRIPTION LIKE '%POOL%'        
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)      
AND TCODE <> 0 AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'  
            
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED            
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY            
  SELECT D.*,''             
  FROM   #DEL_TRANSSTAT_TMP  D         
  WHERE  D.TRANSDATE >= @NEWFROMDATE            
         AND D.TRANSDATE <= @TODATE           
  
 UPDATE TBLDEL_TRANSSTAT_QRLY      SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES  
 FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
 WHERE M.ISIN = TBLDEL_TRANSSTAT_QRLY.CERTNO  
 AND VALID = 1   
            
 UPDATE TBLDEL_TRANSSTAT_QRLY        
 SET SCRIP_NAME = S1.LONG_NAME            
 FROM            
  ANGELDEMAT.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),            
  ANGELDEMAT.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)            
 WHERE            
  S1.CO_CODE = S2.CO_CODE            
  AND S2.SCRIP_CD = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD            
  AND S2.SERIES = TBLDEL_TRANSSTAT_QRLY.SERIES            
              
             
 UPDATE TBLDEL_TRANSSTAT_QRLY            
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'            
 WHERE ISNULL(SCRIP_NAME,'') = ''            
            
            
  DECLARE STATEMENT_CURSOR CURSOR  FOR            
              
              
  SELECT DISTINCT DPID,            
                DPCLTNO            
  FROM   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP D (NOLOCK)            
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'    
   AND DPCLTNO IN (  
SELECT DISTINCT BCLTDPID  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS  
WHERE FILLER2 = 1    
AND DRCR = 'D'  
AND DELIVERED = '0'  
AND TRTYPE IN (904, 905)  
AND PARTY_CODE <> 'BROKER'  
AND SHARETYPE <> 'AUCTION')  
                  
  OPEN STATEMENT_CURSOR            
              
  FETCH NEXT FROM STATEMENT_CURSOR            
  INTO @@LOOPDPID,            
       @@LOOPCLTDPID            
                   
  WHILE @@FETCH_STATUS = 0            
    BEGIN            
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY            
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO,            
                   DPID = BDPID,            
                   CLTDPID = BCLTDPID,            
                   TRTYPE,            
                   REASON = (CASE             
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'            
                               ELSE 'TRANS TO BEN'            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 1            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1            
          WHERE    DRCR = 'D'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = 'G'            
                   AND FILLER2 = 0            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'            
                   AND HOLDERNAME NOT LIKE 'MARGIN%'            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
          ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,          
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,HOLDERNAME            
                               
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO,            
                   DPID = DPID,            
                   CLTDPID = CLTDPID,            
                   TRTYPE,            
                   REASON = (CASE    
                                               WHEN REASON = 'DEMAT' THEN 'PAY-IN'            
                           ELSE REASON            
                                             END),            
             BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 2            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1            
          WHERE    DRCR = 'C'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   /*AND DELIVERED = '0'*/            
                   AND FILLER2 = 1            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   /*AND SETT_NO = '2000000' */            
                   AND FILLER1 NOT IN ('SPLIT','BONUS')            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,REASON            
                               
          UNION ALL            
                      
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO = 0,            
         DPID = '',            
                   CLTDPID = '',            
                   TRTYPE,            
                   UPPER(REASON),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 3   
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1            
          WHERE    DRCR = 'C'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = '0'            
                   AND FILLER2 = 1            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   AND FILLER1 IN ('SPLIT','BONUS')            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,REASON            
                            
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = 0,            
                   DQTY = SUM(QTY),            
                   SLIPNO = (CASE             
                               WHEN FILLER1 = 'SPLIT' THEN 0            
                               ELSE SLIPNO            
      END),            
                   DPID = (CASE             
                             WHEN TRTYPE IN (1000,907,908) THEN ''            
                             WHEN FILLER1 = 'SPLIT' THEN ''            
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''            
                             ELSE DPID            
                           END),            
                   CLTDPID = (CASE             
                                WHEN TRTYPE IN (1000,907,908) THEN ''            
                                WHEN FILLER1 = 'SPLIT' THEN ''            
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''            
                                ELSE CLTDPID            
                              END),         
                   TRTYPE,            
                   REASON = (CASE             
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE            
                               ELSE (CASE             
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'            
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1            
                                       ELSE (CASE             
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'            
                                               ELSE REASON            
                                             END)            
                                     END)            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 4            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
       ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1            
          WHERE    FILLER2 = 1            
                   AND DRCR = 'D'            
                   AND DELIVERED <> '0'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                   ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   --AND HOLDERNAME NOT LIKE 'MARGIN%'            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,FILLER1,REASON            
                               
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
    SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = 0,            
                   DQTY = SUM(QTY),            
                   SLIPNO,            
                   DPID = DP.DPID,            
                   CLTDPID = DP.DPCLTNO,            
                   TRTYPE,            
                   REASON = (CASE             
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'            
                               ELSE 'TRANS TO BEN'            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 1            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT2 C2,            
                   ANGELDEMAT.MSAJAG.DBO.CLIENT1 C1,            
                   ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP            
          WHERE    DRCR = 'D'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = 'G'            
                   AND FILLER2 = 0            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
       AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   /*AND DESCRIPTION NOT LIKE '%POOL%'*/        
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO            
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                             END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,            
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,HOLDERNAME            
            
            
          INSERT INTO #TABLE1            
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
               SETT_NO = '',            
                   SETT_TYPE = '',            
                   PARTY_CODE,            
                   SCRIP_CD,            
                   SCRIP_NAME,            
                   CERTNO,            
                   CQTY = (CASE             
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)            
                             ELSE 0            
                           END),            
                   DQTY = (CASE             
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)            
                             ELSE 0            
                           END),            
                   SLIPNO = '0',            
                   DPID = '',            
                   CLTDPID = '',            
                   TRTYPE = '0',            
                   REASON = 'OPENING BALANCE',            
                   BDPID = '',            
                   BCLTDPID = '',            
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),            
         FLAG = 0            
          FROM     TBLDEL_TRANSSTAT1_QRLY            
          WHERE    TRANSDATE1 < @FROMDATE            
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO            
          UNION ALL            
          SELECT *            
          FROM   TBLDEL_TRANSSTAT1_QRLY            
          WHERE  TRANSDATE1 >= @FROMDATE            
                 AND TRANSDATE1 <= @TODATE            
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),            
                   SETT_NO = '',            
                   SETT_TYPE = '',            
                   PARTY_CODE,            
                   SCRIP_CD,            
                   SCRIP_NAME,            
                   CERTNO,            
                   CQTY = (CASE             
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)            
                             ELSE 0            
                           END),            
                   DQTY = (CASE             
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)            
                             ELSE 0            
                           END),            
                   SLIPNO = '0',            
                   DPID = '',            
                   CLTDPID = '',            
                   TRTYPE = '0',            
                   REASON = 'CLOSING BALANCE',           
                   BDPID = '',            
                   BCLTDPID = '',            
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),            
                   FLAG = 6            
          FROM     TBLDEL_TRANSSTAT1_QRLY            
          WHERE    TRANSDATE1 <= @TODATE            
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO            
          ORDER BY PARTY_CODE,            
                   SCRIP_CD,            
                   CERTNO,            
                   TRANSDATE1,            
                   FLAG,            
                   SETT_NO,            
                   SETT_TYPE            
                        
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY            
            
            
                  
      FETCH NEXT FROM STATEMENT_CURSOR            
      INTO @@LOOPDPID,            
           @@LOOPCLTDPID            
    END            
                
  CLOSE STATEMENT_CURSOR            
              
  DEALLOCATE STATEMENT_CURSOR            
        
 INSERT INTO #TABLEREPORT            
  SELECT   'NSECM', *            
      FROM     #TABLE1            
  WHERE  CQTY <> 0 OR DQTY <> 0                  
 ORDER BY PARTY_CODE,            
               SCRIP_CD,            
               FLAG,            
               TRANSDATEDT            
                           
      TRUNCATE TABLE #TABLE1            
      DROP TABLE #TABLE1            
*/            
  
/* NOW DOING BSECM */            
/*            
        
  TRUNCATE TABLE TBLDEL_TRANSSTAT_QRLY            
   
Set Transaction isolation level read uncommitted                            
select * into #Del_TransStat_TMP_1 From ANGELDEMAT.BSEDB.DBO.Deltrans_Report With(NoLock)                             
Where Party_Code >= @FromParty And Party_Code <= @ToParty                            
and Scrip_CD >= @FromScrip And Scrip_CD <= @ToScrip                            
--And TransDate >= @NewFromDate and TransDate <= @ToDate        
And Filler2 = 1         
        
INSERT INTO #DEL_TRANSSTAT_TMP_1        
SELECT D.SNO, D.Sett_No, D.Sett_type, D.RefNo, D.TCode, TrType=904, D.Party_Code, D.scrip_cd, D.series,         
D.Qty, D.FromNo, D.ToNo, D.CertNo, D.FolioNo, HolderName = 'Ben ' + BCLTDPID, Reason = 'Ben ' + BCLTDPID, DrCr = 'D',         
Delivered = 'G', D.OrgQty, D.DpType, D.DpId, D.CltDpId, D.BranchCd, D.PartipantCode,         
D.SlipNo, D.BatchNo, ISett_No='', ISett_Type='', D.ShareType, TransDate = SEC_PAYIN, D.Filler1,        
Filler2 = 0, D.Filler3, BDpType = DP1.DPTYPE, BDpId = DP1.DPID, BCltDpId = DP1.DPCLTNO, D.Filler4, D.Filler5        
FROM #DEL_TRANSSTAT_TMP_1 D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP1        
WHERE D.SETT_NO = S.SETT_NO        
AND D.SETT_TYPE = S.SETT_TYPE        
AND DP.DESCRIPTION NOT LIKE '%POOL%'        
AND D.BDPID = DP.DPID        
AND D.BCLTDPID = DP.DPCLTNO        
AND FILLER1 NOT IN ('SPILT', 'BONUS', 'RIGHTS')        
AND DP1.DESCRIPTION LIKE '%POOL%'        
AND DP1.DPTYPE = (CASE WHEN FILLER1 = '0' THEN 'NSDL' ELSE 'CDSL' END)      
/*AND TCODE <> 0 */AND FILLER1 NOT LIKE 'HOLDING TRANSFER%'  
            
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED            
  INSERT INTO   TBLDEL_TRANSSTAT_QRLY            
  SELECT D.*,''             
  FROM   #DEL_TRANSSTAT_TMP_1  D         
  WHERE  D.TRANSDATE >= @NEWFROMDATE            
         AND D.TRANSDATE <= @TODATE   
           
            
 UPDATE TBLDEL_TRANSSTAT_QRLY            
 SET SCRIP_NAME = S1.LONG_NAME            
 FROM            
  ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 (NOLOCK),            
  ANGELDEMAT.BSEDB.DBO.SCRIP2 S2 (NOLOCK)            
 WHERE            
  S1.CO_CODE = S2.CO_CODE            
  AND S2.BSECODE = TBLDEL_TRANSSTAT_QRLY.SCRIP_CD            
              
             
 UPDATE TBLDEL_TRANSSTAT_QRLY            
 SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')'            
 WHERE ISNULL(SCRIP_NAME,'') = ''            
            
  DECLARE STATEMENT_CURSOR CURSOR  FOR            
              
              
    
  SELECT DISTINCT DPID,            
                DPCLTNO            
  FROM   ANGELDEMAT.BSEDB.DBO.DELIVERYDP D (NOLOCK)            
 WHERE D.DESCRIPTION NOT LIKE '%POOL%' AND D.DESCRIPTION NOT LIKE '%PRINCI%'    
 AND DPCLTNO IN (  
SELECT DISTINCT BCLTDPID  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS  
WHERE FILLER2 = 1    
AND DRCR = 'D'  
AND DELIVERED = '0'  
AND TRTYPE IN (904, 905)  
AND PARTY_CODE <> 'BROKER'  
AND SHARETYPE <> 'AUCTION')  
             
  OPEN STATEMENT_CURSOR            
              
  FETCH NEXT FROM STATEMENT_CURSOR            
  INTO @@LOOPDPID,            
       @@LOOPCLTDPID            
                   
  WHILE @@FETCH_STATUS = 0            
    BEGIN            
  TRUNCATE TABLE  TBLDEL_TRANSSTAT1_QRLY            
  INSERT INTO     TBLDEL_TRANSSTAT1_QRLY            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO,            
                   DPID = BDPID,            
                   CLTDPID = BCLTDPID,            
                   TRTYPE,            
                   REASON = (CASE             
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'            
                               ELSE 'TRANS TO BEN'            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 1            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1            
          WHERE    DRCR = 'D'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = 'G'            
                   AND FILLER2 = 0            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
     AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@@LOOPCLTDPID)) + '%'            
                   AND HOLDERNAME NOT LIKE 'MARGIN%'            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
     WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,HOLDERNAME            
                               
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO,            
                   DPID = DPID,            
                   CLTDPID = CLTDPID,            
                   TRTYPE,            
                   UPPER(REASON),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,                         FLAG = 2            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,        
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1            
          WHERE    DRCR = 'C'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   /*AND DELIVERED = '0'*/            
                   AND FILLER2 = 1            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   /*AND SETT_NO = '2000000' */            
                   AND FILLER1 NOT IN ('SPLIT','BONUS')            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                 END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
               BDPID,BCLTDPID,REASON            
                               
          UNION ALL            
                      
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   SCRIP_NAME = D.SCRIP_CD + '( ' + CERTNO + ')',            
                   CERTNO,            
                   CQTY = SUM(QTY),            
                   DQTY = 0,            
                   SLIPNO = 0,            
                   DPID = '',            
                   CLTDPID = '',            
                   TRTYPE,            
                   UPPER(REASON),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 3            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1            
          WHERE    DRCR = 'C'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = '0'            
                   AND FILLER2 = 1            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
          AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   AND FILLER1 IN ('SPLIT','BONUS')            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                 END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,REASON            
                               
          UNION ALL            
          SELECT  TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = 0,            
                   DQTY = SUM(QTY),            
                   SLIPNO = (CASE             
                               WHEN FILLER1 = 'SPLIT' THEN 0            
                               ELSE SLIPNO            
                             END),            
                   DPID = (CASE             
                             WHEN TRTYPE IN (1000,907,908) THEN ''            
                             WHEN FILLER1 = 'SPLIT' THEN ''            
                             WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''            
                             ELSE DPID            
                           END),            
                   CLTDPID = (CASE             
                                WHEN TRTYPE IN (1000,907,908) THEN ''            
                                WHEN FILLER1 = 'SPLIT' THEN ''            
                                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''            
                                ELSE CLTDPID            
                              END),            
                   TRTYPE,            
                   REASON = (CASE             
                               WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE            
                               ELSE (CASE             
                                       WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'            
                                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1            
                                       ELSE (CASE             
                                               WHEN REASON = 'DEMAT' THEN 'PAY-OUT'            
                           ELSE REASON            
                                             END)            
                                     END)            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 4            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1            
          WHERE    FILLER2 = 1            
                   AND DRCR = 'D'            
                   AND DELIVERED <> '0'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                              ELSE '%'            
                                           END)            
                   AND HOLDERNAME NOT LIKE 'MARGIN%'            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
         D.SCRIP_CD,CERTNO,SLIPNO,DPID,            
                   CLTDPID,TRTYPE,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,FILLER1,REASON            
                               
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),            
                   SETT_NO,            
                   SETT_TYPE,            
                   D.PARTY_CODE,            
                   D.SCRIP_CD,            
                   D.SCRIP_NAME,            
                   CERTNO,            
                   CQTY = 0,            
                   DQTY = SUM(QTY),            
                   SLIPNO,            
                   DPID = DP.DPID,            
                   CLTDPID = DP.DPCLTNO,            
      TRTYPE,            
                   REASON = (CASE             
                               WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'            
                               ELSE 'TRANS TO BEN'            
                             END),            
                   BDPID,            
                   BCLTDPID,            
                   TRANSDATE1 = TRANSDATE,            
                   FLAG = 1            
          FROM     TBLDEL_TRANSSTAT_QRLY D,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT2 C2,            
                   ANGELDEMAT.BSEDB.DBO.CLIENT1 C1,            
                   ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP            
          WHERE    DRCR = 'D'            
                   AND SHARETYPE <> 'AUCTION'            
                   AND CERTNO LIKE 'IN%'            
                   AND DELIVERED = 'G'            
                   AND FILLER2 = 0            
                   AND C2.CL_CODE = C1.CL_CODE            
                   AND C2.PARTY_CODE = D.PARTY_CODE            
                   AND TRANSDATE >= @NEWFROMDATE            
                   AND TRANSDATE <= @TODATE            
                   AND D.PARTY_CODE >= @FROMPARTY            
                   AND D.PARTY_CODE <= @TOPARTY            
                   AND D.SCRIP_CD >= @FROMSCRIP            
                   AND D.SCRIP_CD <= @TOSCRIP            
                   AND BDPID = @@LOOPDPID            
                   AND BCLTDPID = @@LOOPCLTDPID            
                   /*AND DESCRIPTION NOT LIKE '%POOL%'    */        
                   AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO            
                         OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)     
                   AND C1.BRANCH_CD LIKE (CASE             
                                            WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME            
                                            ELSE '%'            
                                          END)            
                   AND C1.SUB_BROKER LIKE (CASE             
                                             WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
                   AND C1.TRADER LIKE (CASE             
                                         WHEN @STATUSID = 'TRADER' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C1.FAMILY LIKE (CASE             
                                         WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME            
                                         ELSE '%'            
                                       END)            
                   AND C2.PARTY_CODE LIKE (CASE             
                                             WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME            
                                             ELSE '%'            
                                           END)            
          GROUP BY TRANSDATE,SETT_NO,SETT_TYPE,D.PARTY_CODE, D.SCRIP_NAME,            
                   D.SCRIP_CD,CERTNO,SLIPNO,TRTYPE,            
                   DP.DPID,DPCLTNO,ISETT_NO,ISETT_TYPE,            
                   BDPID,BCLTDPID,HOLDERNAME            
            
            
          INSERT INTO #TABLE2            
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
                   SETT_NO = '',            
                   SETT_TYPE = '',            
                   PARTY_CODE,            
                   SCRIP_CD,            
                   SCRIP_NAME,            
                   CERTNO,            
                   CQTY = (CASE             
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)            
                             ELSE 0            
 END),            
                   DQTY = (CASE             
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)            
                             ELSE 0            
                           END),            
                   SLIPNO = '0',            
                   DPID = '',            
                   CLTDPID = '',            
                   TRTYPE = '0',            
                   REASON = 'OPENING BALANCE',            
                   BDPID = '',            
                   BCLTDPID = '',            
                   TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),            
                   FLAG = 0            
          FROM     TBLDEL_TRANSSTAT1_QRLY            
          WHERE    TRANSDATE1 < @FROMDATE            
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO            
          UNION ALL            
          SELECT *            
          FROM   TBLDEL_TRANSSTAT1_QRLY            
          WHERE  TRANSDATE1 >= @FROMDATE            
                 AND TRANSDATE1 <= @TODATE            
          UNION ALL            
          SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),            
                   SETT_NO = '',            
                   SETT_TYPE = '',            
                   PARTY_CODE,            
                   SCRIP_CD,            
                   SCRIP_NAME,            
                   CERTNO,            
                   CQTY = (CASE             
                             WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)            
                             ELSE 0            
                           END),            
                   DQTY = (CASE             
                             WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)            
                             ELSE 0            
                           END),     
                   SLIPNO = '0',            
                   DPID = '',            
                   CLTDPID = '',            
                   TRTYPE = '0',            
  REASON = 'CLOSING BALANCE',            
                   BDPID = '',            
                   BCLTDPID = '',            
                   TRANSDATE1 = CONVERT(DATETIME,@TODATE),            
                   FLAG = 6            
          FROM     TBLDEL_TRANSSTAT1_QRLY            
          WHERE    TRANSDATE1 <= @TODATE            
          GROUP BY PARTY_CODE, SCRIP_CD,SCRIP_NAME,CERTNO            
          ORDER BY PARTY_CODE,            
                   SCRIP_CD,            
                   CERTNO,            
                   TRANSDATE1,            
                   FLAG,            
                   SETT_NO,            
                   SETT_TYPE            
                               
          TRUNCATE TABLE TBLDEL_TRANSSTAT1_QRLY            
            
            
                  
      FETCH NEXT FROM STATEMENT_CURSOR            
      INTO @@LOOPDPID,            
           @@LOOPCLTDPID            
    END            
                
  CLOSE STATEMENT_CURSOR            
              
  DEALLOCATE STATEMENT_CURSOR            
            
 INSERT INTO #TABLEREPORT            
  SELECT   'BSECM', *            
      FROM     #TABLE2            
  WHERE  CQTY <> 0 OR DQTY <> 0                  
 ORDER BY PARTY_CODE,            
               SCRIP_CD,            
               FLAG,            
               TRANSDATEDT            
                           
      TRUNCATE TABLE #TABLE2            
      DROP TABLE #TABLE2            
            
            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER            
SELECT               
 Q.*            
FROM               
 #TABLEREPORT Q (NOLOCK)              
            
            
TRUNCATE TABLE #TABLEREPORT            
DROP TABLE #TABLEREPORT            
*/  
            
/*           
          
           
SELECT EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN,          effdate, SUM(QTY)          
FROM C_SECURITIESMST          
where effdate >= '' and effdate <= ''          
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, effdate          
          
*/              
              
CREATE TABLE #COLL          
(          
 EXCHANGE VARCHAR(10),          
 SEGMENT VARCHAR(20),          
 EXCSEGMENT VARCHAR(10),          
 EFFDT VARCHAR(10),          
 PARTY_CODE VARCHAR(10),          
 SCRIP_CD VARCHAR(20),          
 SERIES VARCHAR(10),          
 SCRIP_NAME VARCHAR(100),          
 CERTNO VARCHAR(20),          
 CQTY INT,          
 DQTY INT,          
 REASON VARCHAR(255),          
 TRANSDATEDT DATETIME,          
 FLAG INT          
)          
           
INSERT INTO #COLL          
SELECT        
 EXCHANGE,        
 SEGMENT,        
 '',        
 CONVERT(varchar,CONVERT(DATETIME, @FROMDATE,109),103),        
 PARTY_CODE,        
 SCRIP_CD,        
 SERIES,        
 '',        
 ISIN,        
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),        
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),        
 'OPENING BALANCE',          
 CONVERT(DATETIME, @FROMDATE,109),          
 2          
 FROM        
 (        
  SELECT           
  EXCHANGE,          
  SEGMENT,           
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,          
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),          
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))        
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST         
  WHERE          
   EFFDATE < @FROMDATE          
   AND PARTY_CODE   >= @FROMPARTY        
   AND PARTY_CODE <= @TOPARTY        
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS          
 ) X        
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN        
        
        
        
INSERT INTO #COLL          
SELECT           
EXCHANGE,          
SEGMENT,          
'',          
convert(varchar,effdate,103),           
PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,          
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),          
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),          
UPPER(REMARKS),          
EFFDATE,          
1          
FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST          
WHERE          
 EFFDATE >= @FROMDATE          
 AND EFFDATE <= @TODATE + ' 23:59:59'          
 AND PARTY_CODE   >= @FROMPARTY        
 AND PARTY_CODE <= @TOPARTY        
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS          
          
          
/*        
INSERT INTO #COLL          
SELECT           
EXCHANGE,          
SEGMENT,          
'',          
convert(varchar,effdate,103),     PARTY_CODE, SCRIP_CD, SERIES, '', ISIN,          
CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),          
DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END)),          
'CLOSING BALANCE',          
@TODATE + ' 23:59:59',          
6          
FROM MSAJAG.DBO.C_SECURITIESMST (NOLOCK)          
WHERE          
 EFFDATE <= @TODATE + ' 23:59:59'          
 AND PARTY_CODE   >= @FROMPARTY        
 AND PARTY_CODE <= @TOPARTY        
GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, EFFDATE, REMARKS          
*/        
        
INSERT INTO #COLL          
SELECT        
 EXCHANGE,        
 SEGMENT,        
 '',        
 CONVERT(varchar,CONVERT(DATETIME, @TODATE,109),103),        
 PARTY_CODE,        
 SCRIP_CD,        
 SERIES,        
 '',        
 ISIN,        
 CQTY = (CASE WHEN SUM(CQTY - DQTY) >= 0 THEN SUM(CQTY - DQTY) ELSE 0 END),        
 DQTY = (CASE WHEN SUM(DQTY - CQTY) >= 0 THEN SUM(DQTY - CQTY) ELSE 0 END),        
 'CLOSING BALANCE',          
 @TODATE + ' 23:59:59',          
 6          
 FROM        
 (        
  SELECT           
  EXCHANGE,          
  SEGMENT,           
  PARTY_CODE, SCRIP_CD, SERIES, ISIN,          
  CQTY = SUM((CASE WHEN DRCR = 'C' THEN QTY ELSE 0 END)),          
  DQTY = SUM((CASE WHEN DRCR = 'D' THEN QTY ELSE 0 END))        
  FROM ANAND1.MSAJAG.DBO.C_SECURITIESMST         
  WHERE          
EFFDATE <= @TODATE  + ' 23:59:59'        
   AND PARTY_CODE   >= @FROMPARTY        
   AND PARTY_CODE <= @TOPARTY        
  GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, DRCR, ISIN, REMARKS          
 ) X        
 GROUP BY EXCHANGE, SEGMENT, PARTY_CODE, SCRIP_CD, SERIES, ISIN        
          
          
          
UPDATE #COLL            
SET SCRIP_NAME = SCRIP_CD + ' (' + CERTNO + ')' ,          
EXCSEGMENT =           
 ( CASE WHEN EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL' THEN 'NSECM'          
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'CAPITAL' THEN 'BSECM'          
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' THEN 'NSEFO'          
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'FUTURES' THEN 'BSEFO'          
WHEN EXCHANGE = 'NCX' AND SEGMENT = 'FUTURES' THEN 'NCDX'          
WHEN EXCHANGE = 'MCX' AND SEGMENT = 'FUTURES' THEN 'MCDX'          
WHEN EXCHANGE = 'ALL' AND SEGMENT = 'COMMON' THEN 'DBCOMMON'          
WHEN EXCHANGE = 'BCM' AND SEGMENT = 'FUTURES' THEN 'BSEFOPCM'          
WHEN EXCHANGE = 'BSE' AND SEGMENT = 'SLBS' THEN 'BSESLBS'          
WHEN EXCHANGE = 'BSX' AND SEGMENT = 'FUTURES' THEN 'BSECURFO'          
WHEN EXCHANGE = 'MCD' AND SEGMENT = 'FUTURES' THEN 'MCDXCDS'          
WHEN EXCHANGE = 'MCM' AND SEGMENT = 'FUTURES' THEN 'MCDXPCM'          
WHEN EXCHANGE = 'NCM' AND SEGMENT = 'FUTURES' THEN 'NSEFOPCM'          
WHEN EXCHANGE = 'NMC' AND SEGMENT = 'FUTURES' THEN 'NMCE'          
WHEN EXCHANGE = 'NSE' AND SEGMENT = 'SLBS' THEN 'NSESLBS'          
WHEN EXCHANGE = 'NSX' AND SEGMENT = 'FUTURES' THEN 'NSECURFO'          
WHEN EXCHANGE = 'NXM' AND SEGMENT = 'FUTURES' THEN 'NSECURFOPCM'            
ELSE 'UNKNOWN' END)          
          
          
UPDATE #COLL          
SET SCRIP_NAME = S1.LONG_NAME            
 FROM            
  ANAND1.MSAJAG.DBO.SCRIP1 S1 (NOLOCK),            
  ANAND1.MSAJAG.DBO.SCRIP2 S2 (NOLOCK)            
 WHERE            
  S1.CO_CODE = S2.CO_CODE            
  AND S2.SCRIP_CD = #COLL.SCRIP_CD            
  AND S2.SERIES = #COLL.SERIES            
          
              
          
UPDATE #COLL          
SET SCRIP_NAME = S1.LONG_NAME            
 FROM            
  ANAND.BSEDB_AB.DBO.SCRIP1 S1 (NOLOCK),            
  ANAND.BSEDB_AB.DBO.SCRIP2 S2 (NOLOCK)            
 WHERE            
  S1.CO_CODE = S2.CO_CODE            
  AND S2.BSECODE = #COLL.SCRIP_CD            
          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
INSERT INTO V2_CLASS_QUARTERLYSECLEDGER           
SELECT               
 EXCSEGMENT,          
 EFFDT,          
 '',          
 '',          
 PARTY_CODE,          
 SCRIP_CD,          
 SCRIP_NAME,          
 CERTNO,          
 CQTY,          
 DQTY,          
 '0',          
 '',          
 '',          
 '0',          
 UPPER(REASON),          
 '',          
 '',          
 TRANSDATEDT ,          
 FLAG           
FROM               
 #COLL  (NOLOCK)              
WHERE        
 PARTY_CODE   >= @FROMPARTY        
 AND PARTY_CODE <= @TOPARTY        
 AND ( CQTY <> 0  OR DQTY <> 0)        
          
TRUNCATE TABLE #COLL          
DROP TABLE #COLL          
        
select * from V2_CLASS_QUARTERLYSECLEDGER        
        
SET ANSI_NULLS OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_YEARLYLEDGER_NEW
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROC_YEARLYLEDGER_NEW]                            
(                            
 @STARTDT VARCHAR(11),                            
 @ENDDT VARCHAR(11),                            
 @FROMPARTY VARCHAR(10),                            
 @TOPARTY VARCHAR(10),                
 @FROMBRANCH VARCHAR(15) = '',                
 @TOBRANCH VARCHAR(15) = 'ZZZZZZZZZZ',                
 @FROMSUBBROKER VARCHAR(15) = '',                
 @TOSUBBROKER VARCHAR(15) = 'ZZZZZZZZZZ',                
 @RPT_FILTER INT = 0                
)                            
                            
/*                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0000000000', 'ZZZZZZZZZZ'                            
EXEC V2_PROC_QUARTERLYLEDGER 'JUN  1 2008' , 'AUG 31 2008', '0080', '0080'                            
*/                            
                            
AS                            
                            
SET NOCOUNT ON                            
                            
/*                            
CREATE TABLE V2_CLASS_YEARLYLEDGER                            
(                            
 CQL_ID BIGINT IDENTITY(1,1),                            
 CQL_SEGMENT VARCHAR(20),                            
 CQL_PARTYCODE VARCHAR(10),                            
 CQL_VDT VARCHAR(20),                            
 CQL_VTYPE VARCHAR(10),                            
 CQL_VNO VARCHAR(20),                            
 CQL_ACCODE VARCHAR(10),                            
 CQL_REMARKS VARCHAR(255),                            
 CQL_DDNO VARCHAR(20),                            
 CQL_DEBIT MONEY,                            
 CQL_CREDIT MONEY,                            
 CQL_BALANCE MONEY,                            
 CQL_ORDERBY TINYINT,                            
 CQL_DT INT,                             
 CQL_ACNAME VARCHAR(100)                            
)                            
*/                        

 
                            
TRUNCATE TABLE V2_CLASS_YEARLYLEDGER                
DECLARE @@SDTCUR DATETIME                
                            
/* NOW DOING NSECM */                
                
IF (@TOBRANCH = '')                
BEGIN                
 SET @TOBRANCH  = 'ZZZZZZZZZZ'                
END                
                
IF (@TOSUBBROKER = '')                
BEGIN                
 SET @TOSUBBROKER = 'ZZZZZZZZZZ'                
END                
                
CREATE TABLE #CLIENTMASTER                
 (                
 PARTY_CODE VARCHAR(15),                
 PARTYNAME VARCHAR(100),                
 PARENTCODE VARCHAR(15),                
 BRANCH_CD VARCHAR(15),                
 SUB_BROKER VARCHAR(15)                
 )   
 
           
                
IF (@RPT_FILTER = 0)                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
 WHERE                
  PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
ELSE                
BEGIN                
 INSERT INTO #CLIENTMASTER                
 SELECT                
  DISTINCT                
  PARTY_CODE = C.CL_CODE,                
  PARTYNAME='',                
  PARENTCODE,                
  BRANCH_CD,                
  SUB_BROKER                
 FROM                
  ANAND1.PRADNYA.DBO.TBLCLIENT_GROUP T WITH (NOLOCK),                
  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH (NOLOCK)                
 WHERE                
  T.PARTY_CODE = C.PARTY_CODE                
  AND PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH                
 AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER                
END                
                
UPDATE #CLIENTMASTER SET PARTYNAME = ISNULL(SHORT_NAME,'') FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS WITH (NOLOCK)                
WHERE #CLIENTMASTER.PARENTCODE = CLIENT_DETAILS.PARENTCODE                
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM              
 ANAND1.ACCOUNT.DBO.PARAMETER                       
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                     
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                          
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                    
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECM',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 1,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                
   --AND A.ACCAT IN ('4','104','204'))                
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR  AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANAND1.ACCOUNT.DBO.PARAMETER                             
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
                      
SELECT                             
 CQL_SEGMENT = 'NSECM',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 2,                 
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                           
 --CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                
 INTO #TEMP                       
FROM                            
 ANAND1.ACCOUNT.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANAND1.ACCOUNT.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT = '4')              
 --AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANAND1.ACCOUNT.DBO.VMAST V ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                                
            
            
            
            
INSERT INTO V2_CLASS_YEARLYLEDGER                  
SELECT                              
 CQL_SEGMENT ,                          
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO,                            
 CQL_ACCODE ,                            
 CQL_REMARKS,            
 CQL_DDNO ,                            
 CQL_DEBIT ,                            
 CQL_CREDIT,                            
 CQL_BALANCE ,                 
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME = C.PARTYNAME              
 FROM #TEMP AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY             
            
DROP TABLE   #TEMP            
               
                            
/* NOW DOING BSECM */                            
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 AngelBSECM.ACCOUNT_AB.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                       
  SELECT                             
   CQL_SEGMENT = 'BSECM',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                    
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),     
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 3,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')           
 --AND A.ACCAT IN ('4','104','204')              
   INNER JOIN                
   #CLIENTMASTER C (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                       
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSECM',                             
 CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),              
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 4,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 AngelBSECM.ACCOUNT_AB.DBO.LEDGER L WITH (NOLOCK)                    INNER JOIN                            
 AngelBSECM.ACCOUNT_AB.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT ='4')                            
 --AND A.ACCAT IN ('4','104','204')              
 LEFT OUTER JOIN                             
 AngelBSECM.ACCOUNT_AB.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
/* NOW DOING NSEFO */    


 CREATE CLUSTERED INDEX IDX_CL ON #CLIENTMASTER
 (
	PARTY_CODE
 )                          
                            
                            
SELECT                             
 @@SDTCUR = SDTCUR      
FROM                             
 ANGELFO.ACCOUNTFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE, ---L.CLTCODE,           
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                      
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NSEFO',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                
FROM                            
 ANGELFO.ACCOUNTFO.DBO.LEDGER L WITH (NOLOCK)                
 INNER JOIN                            
 ANGELFO.ACCOUNTFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
                            
/*===========================================================================================================                           
--------------------------------------------------------------------------------------------------------------------                  
-- NCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                       
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                      
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A  WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'NCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  --- L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                        
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTNCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
                            
---------------------------------------------------------------------------------------------------------------                  
-- MCDX                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                           
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDX',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME   ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE >= @FROMPARTY                            
   AND C.PARENTCODE <= @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                        
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDX',                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT),                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDX.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 INNER JOIN                
 #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT >=  @STARTDT                            
 AND L.VDT <= @ENDDT + ' 23:59:59'                            
 AND C.PARENTCODE >= @FROMPARTY                            
 AND C.PARENTCODE <= @TOPARTY                            
     */                       
    
    
---------------------------------------------------------------------------------------------------------------                  
-- BSEFO                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                         
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'BSEFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'BSEFO',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                        
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP2                           
FROM                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTBFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTBFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                      
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP2 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
  DROP TABLE #TEMP2         
      
    
---------------------------------------------------------------------------------------------------------------                  
-- MCDXCDS                  
                  
SELECT                            
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                        
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,                            
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'MCDXCDS',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT = 'MCDXCDS',                             
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT)  VDT                         
 --CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME          
 INTO #TEMP1                            
FROM                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELCOMMODITY.ACCOUNTMCDXCDS.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                  
           
           
           
 INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP1 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP1          
           
            
                  
                  
--------------------------------------------------------------------------------------------------------------                  
-- NSECURFO                  
                  
SELECT                             
 @@SDTCUR = SDTCUR                             
FROM                             
 ANGELFO.ACCOUNTCURFO.DBO.PARAMETER                           
WHERE                            
 @STARTDT BETWEEN SDTCUR AND LDTCUR                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                             
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_DEBIT = (CASE WHEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT) >= 0 THEN SUM(CQL_DEBIT) - SUM(CQL_CREDIT)  ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT) >= 0 THEN SUM(CQL_CREDIT) - SUM(CQL_DEBIT)  ELSE 0 END),                            
 SUM(CQL_BALANCE),                            
 CQL_ORDERBY,                            
 19000101,             
 CQL_ACNAME                            
FROM                             
 (                            
  SELECT                             
   CQL_SEGMENT = 'NSECURFO',                             
   CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
   CQL_VDT = '',                            
   CQL_VTYPE = '',                            
   CQL_VNO = '',                            
   CQL_ACCODE = '',                            
   CQL_REMARKS = 'OPENING BALANCE',                            
   CQL_DDNO = '',                            
   CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
   CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
   CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
   CQL_ORDERBY = 5,                            
   CQL_ACNAME = C.PARTYNAME  ---A.ACNAME                            
  FROM                            
   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
   INNER JOIN                            
   ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
   INNER JOIN                
   #CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
  WHERE                             
   L.VDT >= @@SDTCUR                            
   AND L.VDT < @STARTDT                            
   AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY                            
 ) X                            
GROUP BY                            
 CQL_SEGMENT,                            
 CQL_PARTYCODE,                            
 CQL_VDT,                            
 CQL_VTYPE,                            
 CQL_VNO,                            
 CQL_ACCODE,                            
 CQL_REMARKS,                            
 CQL_DDNO,                            
 CQL_ORDERBY,                            
 CQL_ACNAME                            
                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
--- INSERT INTO V2_CLASS_YEARLYLEDGER                            
SELECT                      
 CQL_SEGMENT = 'NSECURFO',                             
 --- CQL_PARTYCODE = C.PARENTCODE,   
 L.CLTCODE,                            
 CQL_VDT = CONVERT(VARCHAR,L.VDT,103),                            
 CQL_VTYPE = ISNULL(V.SHORTDESC,'NA'),                            
 CQL_VNO = L.VNO,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS = L.NARRATION,                            
 CQL_DDNO = '',                            
 CQL_DEBIT = (CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),                            
 CQL_CREDIT = (CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),                            
 CQL_BALANCE = (CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END),                            
 CQL_ORDERBY = 6,                            
 CAST(CONVERT(VARCHAR,L.VDT,112) AS INT) VDT                          
 ---CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME                            
 INTO #TEMP3  
FROM                            
 ANGELFO.ACCOUNTCURFO.DBO.LEDGER L WITH (NOLOCK)                             
 INNER JOIN                            
 ANGELFO.ACCOUNTCURFO.DBO.ACMAST A WITH (NOLOCK) ON (A.CLTCODE = L.CLTCODE AND A.ACCAT IN ('4','104','204'))                            
 LEFT OUTER JOIN                             
 ANGELFO.ACCOUNTCURFO.DBO.VMAST V WITH (NOLOCK) ON (V.VTYPE = L.VTYP)                            
 --INNER JOIN                
 --#CLIENTMASTER C WITH (NOLOCK) ON (C.PARTY_CODE = A.CLTCODE)                
WHERE                             
 L.VDT BETWEEN @STARTDT AND @ENDDT + ' 23:59:59'                            
 --AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY     
   
            
 INSERT INTO V2_CLASS_YEARLYLEDGER                            
 SELECT                             
 CQL_SEGMENT ,                             
 CQL_PARTYCODE = C.PARENTCODE,  ---L.CLTCODE,                            
 CQL_VDT ,                            
 CQL_VTYPE ,                            
 CQL_VNO ,                            
 CQL_ACCODE = '',                            
 CQL_REMARKS ,                            
 CQL_DDNO = '',                            
 CQL_DEBIT ,                        
 CQL_CREDIT ,                            
 CQL_BALANCE ,                            
 CQL_ORDERBY ,                            
 VDT,                            
 CQL_ACNAME  = C.PARTYNAME  ---A.ACNAME             
 FROM #TEMP3 AS A,#CLIENTMASTER C WITH (NOLOCK) WHERE C.PARTY_CODE = A.CLTCODE           
 AND C.PARENTCODE BETWEEN @FROMPARTY AND @TOPARTY            
            
            
 DROP TABLE #TEMP3      
                          
                  
-------------------------------------------------------------------------------------------------------------------                                                  
/*============================================================================================================*/                          
/*                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
SELECT                             
 Q.*,                            
 CQL_ADD1 = C.L_ADDRESS1,                            
 CQL_ADD2 = C.L_ADDRESS2,                            
 CQL_ADD3 = C.L_ADDRESS3,                            
 CQL_CITY = C.L_CITY,                            
 CQL_ZIP = C.L_ZIP,                            
 CQL_PHONE = C.RES_PHONE1,                            
 CQL_BRANCH = B.BRANCH+' ~ ('+C.BRANCH_CD+')',                            
 CQL_SUBBROKER = S.NAME + ' ~ (' + C.SUB_BROKER + ')',                            
 CQL_TRADER = T.LONG_NAME + ' ~ (' + C.TRADER + ')'                            
FROM                             
 V2_CLASS_YEARLYLEDGER Q (NOLOCK)                            
 INNER JOIN                            
  MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)                            
  INNER JOIN MSAJAG.DBO.BRANCH B (NOLOCK) ON (C.BRANCH_CD = B.BRANCH_CODE)                            
  INNER JOIN MSAJAG.DBO.BRANCHES T (NOLOCK) ON (C.TRADER = T.SHORT_NAME)                        
  INNER JOIN MSAJAG.DBO.SUBBROKERS S (NOLOCK) ON (C.SUB_BROKER = S.SUB_BROKER)                            
 ON (Q.CQL_PARTYCODE = C.CL_CODE)                            
ORDER BY                             
 Q.CQL_PARTYCODE,                            
 Q.CQL_ORDERBY,                            
 Q.CQL_DT              
*/                                      
                        
DELETE FROM V2_CLASS_YEARLYLEDGER                        
WHERE CQL_DEBIT = 0                        
AND CQL_CREDIT = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VW
-- --------------------------------------------------
      
CREATE PROC VW @VWNAME VARCHAR(25)AS                     
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @VWNAME + '%' AND XTYPE='V' ORDER BY NAME

GO

-- --------------------------------------------------
-- TABLE dbo.31032010CL BSE END
-- --------------------------------------------------
CREATE TABLE [dbo].[31032010CL BSE END]
(
    [Party_Code] NVARCHAR(50) NULL,
    [Party_Name] NVARCHAR(50) NULL,
    [Scrip_Cd] NVARCHAR(50) NULL,
    [Series] NVARCHAR(50) NULL,
    [DPId] NVARCHAR(50) NULL,
    [ClientId] NVARCHAR(50) NULL,
    [Isin] NVARCHAR(50) NULL,
    [Sett_No] NVARCHAR(50) NULL,
    [Sett_Type] NVARCHAR(50) NULL,
    [HoldQty] NVARCHAR(50) NULL,
    [PledgeQty] NVARCHAR(50) NULL,
    [Qty] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.31032010CL NSE END
-- --------------------------------------------------
CREATE TABLE [dbo].[31032010CL NSE END]
(
    [Party_Code] NVARCHAR(50) NULL,
    [Party_Name] NVARCHAR(50) NULL,
    [Scrip_Cd] NVARCHAR(50) NULL,
    [Series] NVARCHAR(50) NULL,
    [DPId] NVARCHAR(50) NULL,
    [ClientId] NVARCHAR(50) NULL,
    [Isin] NVARCHAR(50) NULL,
    [Sett_No] NVARCHAR(50) NULL,
    [Sett_Type] NVARCHAR(50) NULL,
    [HoldQty] NVARCHAR(50) NULL,
    [PledgeQty] NVARCHAR(50) NULL,
    [Qty] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.A23954_NSE_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[A23954_NSE_LEDGER]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] VARCHAR(12) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] VARCHAR(12) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold]
(
    [segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold_CGT
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold_CGT]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold_JAS
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold_JAS]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold010113
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold010113]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold010413
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold010413]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold0105
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold0105]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD010615
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD010615]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold011012
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold011012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold020112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold020112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD020614
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD020614]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold020712
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold020712]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold020811
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold020811]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold0304
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold0304]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold030412
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold030412]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold030613
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold030613]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold030912
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold030912]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold031011
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold031011]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD031114
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD031114]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold031212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold031212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold040213
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold040213]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold040313
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold040313]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold040612
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold040612]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold0409
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold0409]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold0502
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold0502]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD050211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD050211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold050312
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold050312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD050514
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD050514]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold050711
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold050711]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold050911
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold050911]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold051113_all
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold051113_all]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold051211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold051211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold060212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold060212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold0603
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold0603]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD060415
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD060415]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold060513
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold060513]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold060812
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold060812]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold061112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold061112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold070113
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold070113]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD070414
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD070414]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold070611
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold070611]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD070714
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD070714]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold080413
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold080413]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold0805
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold0805]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold080713
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold080713]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold080811
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold080811]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold0809
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold0809]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold081012
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold081012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold081111
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold081111]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold090112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold090112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold090412
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold090412]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD090614
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD090614]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold090712
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold090712]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold1
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold1]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold1004
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold1004]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold100613
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold100613]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold100912
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold100912]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold101011
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold101011]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD101114
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD101114]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold101212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold101212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold110213
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold110213]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold110313
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold110313]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold110612
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold110612]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold111211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold111211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD120211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD120211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold120312
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold120312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD120514
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD120514]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold120711
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold120711]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold120911
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold120911]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold130212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold130212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold1303
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold1303]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold130513
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold130513]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold130812
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold130812]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD131014
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD131014]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold131112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold131112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold1312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold1312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold140113
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold140113]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold140512
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold140512]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold140611
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold140611]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD140714
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD140714]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold1408
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold1408]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold1409
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold1409]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold141111
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold141111]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold150413
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold150413]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD150414
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD150414]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD150914
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD150914]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold151012
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold151012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold160112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold160112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold160412
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold160412]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold160511
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold160511]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold160712
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold160712]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold160811
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold160811]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold1701
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold1701]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold1704
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold1704]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold170613
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold170613]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold170613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold170613_all]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold1709
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold1709]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold170912
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold170912]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold171011
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold171011]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold171013
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold171013]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold171212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold171212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold180213
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold180213]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold180313
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold180313]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold180612
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold180612]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD190211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD190211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold190312
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold190312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD190514
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD190514]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold190711
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold190711]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold190813
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold190813]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold190911
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold190911]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold191112_p1
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold191112_p1]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold191112_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold191112_P2]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold191211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold191211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold200513
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold200513]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold2009
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold2009]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold210113
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold210113]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold210212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold210212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold2103
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold2103]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD210414
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD210414]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold210512
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold210512]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold210611
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold210611]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2108
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2108]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold210812
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold210812]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold211111
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold211111]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold220413
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold220413]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD220615
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD220615]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold220713_all
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold220713_all]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold220811
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold220811]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD220816
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD220816]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold2209
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold2209]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD220914
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD220914]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold221012
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold221012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold230112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold230112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold230511
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold230511]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold230712
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold230712]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold240314
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold240314]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold2404
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold2404]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold240511
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold240511]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold240613
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold240613]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold240613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold240613_all]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold240912
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold240912]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold241011
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold241011]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold241212_all
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold241212_all]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD250116
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD250116]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold250213
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold250213]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold250313
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold250313]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD250515
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD250515]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold250612
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold250612]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold2509
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold2509]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold251211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold251211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD260211
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD260211]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold260312
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold260312]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD260514
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD260514]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold260911
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold260911]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold261112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold261112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold261212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold261212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2701
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2701]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold270212
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold270212]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold270513
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold270513]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold270812
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold270812]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD271014
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD271014]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold280113
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold280113]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold2803
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold2803]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD280414
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD280414]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold280512
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold280512]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold280611
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold280611]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2808
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2808]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold2809
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold2809]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold281111
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold281111]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold2812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold2812]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold290413
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold290413]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold290811
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold290811]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_hold2909
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_hold2909]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold291012
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold291012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_HOLD300111
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_HOLD300111]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold300112
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold300112]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold300412
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold300412]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold300712
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold300712]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_hold3012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_hold3012]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold310314
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold310314]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold310511
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold310511]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Hold311011
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Hold311011]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Holdpend
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Holdpend]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Holdpend1
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Holdpend1]
(
    [Segment] VARCHAR(5) NOT NULL,
    [PartyCode] VARCHAR(50) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [hold] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_AMJ_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_AMJ_Mismatch]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_AMJ_Mismatch1
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_AMJ_Mismatch1]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Jun_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Jun_Mismatch]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_241212_All
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_241212_All]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_AMRTS
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_AMRTS]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_CGT
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_CGT]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_JFM12
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_JFM12]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010413
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010413]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS0105
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS0105]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010615
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010615]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010713
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010713]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010811
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010811]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS010914
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS010914]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS011012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS011012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS011214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS011214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020215
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020215]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020315
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020315]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020614
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020614]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020712
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020712]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS020913
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS020913]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS021213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS021213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030314
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030314]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS0304
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS0304]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030412
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030412]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030613
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030613]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030815
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030815]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030911
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030911]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS030912
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS030912]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS031011
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS031011]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS031114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS031114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS031212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS031212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040213_P1
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040213_P1]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040213_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040213_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040313
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040313]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040515
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040515]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040612
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040612]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040711
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040711]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS040814
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS040814]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS0409
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS0409]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS050115
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS050115]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS050211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS050211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS050312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS050312]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS050514
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS050514]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS050813
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS050813]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS051113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS051113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS051113_all
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS051113_all]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS051211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS051211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS051211_v2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS051211_v2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS0603
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS0603]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060415
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060415]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060513
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060513]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060513_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060513_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060611
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060611]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060616
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060616]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060715
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060715]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060811
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060811]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS060812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS060812]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS061112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS061112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS070113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS070113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS070414
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS070414]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS070714
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS070714]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS071013
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS071013]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS071014
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS071014]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS080413
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS080413]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS0805
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS0805]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS080615
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS080615]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS080713
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS080713]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS0809
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS0809]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS080914
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS080914]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS081012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS081012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS081111
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS081111]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS081214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS081214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090215
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090215]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090315
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090315]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090412
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090412]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090614
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090614]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS090712
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS090712]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS091213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS091213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100314
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100314]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1004
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1004]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100613
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100613]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100815
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100815]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100912
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100912]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS100913
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS100913]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS101011
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS101011]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS101114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS101114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS101212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS101212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110116
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110116]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110313
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110313]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110515
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110515]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110612
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110612]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110711
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110711]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS110814
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS110814]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS111113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS111113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS111211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS111211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120115
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120115]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120312]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120514
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120514]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120813
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120813]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS120911
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS120911]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1303
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1303]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130415
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130415]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130513
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130513]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130513_P1
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130513_P1]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130513_P3
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130513_P3]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130611
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130611]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130715
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130715]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130811
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130811]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS130812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS130812]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS131014
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS131014]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS131112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS131112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1312]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS131216
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS131216]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS140113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS140113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS140512
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS140512]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS140714
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS140714]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1408
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1408]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS1409
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS1409]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS141111
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS141111]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS150413
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS150413]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS150414
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS150414]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS150615
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS150615]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS150713
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS150713]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS150914
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS150914]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS151012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS151012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS151214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS151214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160215
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160215]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160315
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160315]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160412
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160412]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160511
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160511]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160614
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160614]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160712
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160712]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS160913
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS160913]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS161017
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS161017]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS161213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS161213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1701
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1701]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS1704
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS1704]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170613
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170613]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170613_all]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170613_allN
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170613_allN]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170815
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170815]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS1709
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS1709]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS170912
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS170912]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS171011
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS171011]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS171013
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS171013]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS171114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS171114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS171212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS171212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180313
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180313]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180314
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180314]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180515
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180515]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180612
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180612]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180711
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180711]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180814
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180814]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS180917
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS180917]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS181113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS181113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190115
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190115]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190312]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190514
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190514]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190813
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190813]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS190911
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS190911]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS191112_P1
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS191112_P1]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS191112_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS191112_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS191211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS191211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200415
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200415]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200513
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200513]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200513_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200513_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200611
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200611]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200715
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200715]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS200811
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS200811]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2009
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2009]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS201014
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS201014]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2103
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2103]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210414
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210414]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210512
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210512]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210714
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210714]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2108
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2108]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS210812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS210812]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS211013
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS211013]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS211111
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS211111]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220413
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220413]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220413_n
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220413_n]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220413_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220413_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220615
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220615]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220713
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220713]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220713_all
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220713_all]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220816
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220816]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2209
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2209]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS220914
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS220914]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS221012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS221012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS221214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS221214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230215
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230215]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230315
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230315]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230412
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230412]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230511
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230511]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230516
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230516]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230614
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230614]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230712
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230712]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS230913
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS230913]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS231213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS231213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240314
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240314]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2404
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2404]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240511
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240511]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240613
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240613]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240613_all]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240815
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240815]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS240912
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS240912]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS241011
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS241011]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS241016
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS241016]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS241114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS241114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250116
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250116]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250313
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250313]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250313_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250313_P2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250515
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250515]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250612
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250612]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250711
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250711]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS250814
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS250814]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2509
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2509]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2509_test
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2509_test]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS251113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS251113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS251211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS251211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS260211
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS260211]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS260312
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS260312]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS260514
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS260514]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS260813
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS260813]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS260911
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS260911]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS261112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS261112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS261212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS261212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2701
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2701]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270114
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270114]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270115
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270115]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270212
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270212]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270415
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270415]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270513
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270513]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270611
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270611]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270715
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270715]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270811
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270811]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS270812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS270812]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS271014
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS271014]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS280113
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS280113]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2803
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2803]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS280414
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS280414]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS280512
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS280512]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS280714
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS280714]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2808
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2808]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2809
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2809]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS281013
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS281013]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS281111
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS281111]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS281111_V2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS281111_V2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS2812
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS2812]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS290413
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS290413]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS290413_p2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS290413_p2]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS290615
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS290615]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS290713
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS290713]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCS2909
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCS2909]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS290914
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS290914]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS291012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS291012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS291214
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS291214]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300111
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300111]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300112
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300112]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300315
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300315]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300412
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300412]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300511
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300511]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300614
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300614]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300712
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300712]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS300913
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS300913]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS3012
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS3012]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS301213
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS301213]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS310314
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS310314]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS310317_new
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS310317_new]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS310815
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS310815]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_QL_Mismatch1_SCCS311011
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_QL_Mismatch1_SCCS311011]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCSpend
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCSpend]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL_Mismatch1_SCCSpendCL1
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL_Mismatch1_SCCSpendCL1]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_QL2_Mismatch1_JAS10
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_QL2_Mismatch1_JAS10]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bse
-- --------------------------------------------------
CREATE TABLE [dbo].[bse]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [email] VARCHAR(50) NULL,
    [ECN AND NONECN] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsehold
-- --------------------------------------------------
CREATE TABLE [dbo].[bsehold]
(
    [PartyCode] VARCHAR(50) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [DpId] VARCHAR(50) NULL,
    [CltCode] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [HoldQty] INT NULL,
    [PledgeQty] INT NULL,
    [Qty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEHOLD1
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEHOLD1]
(
    [PartyCode] VARCHAR(50) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [DpId] VARCHAR(50) NULL,
    [CltCode] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [HoldQty] INT NULL,
    [PledgeQty] INT NULL,
    [Qty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CashSaudaMarketBil_MonthWise1_New
-- --------------------------------------------------
CREATE TABLE [dbo].[CashSaudaMarketBil_MonthWise1_New]
(
    [EXCHANGE] VARCHAR(50) NULL,
    [TRDTYPE] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(20) NULL,
    [TRADEDATE] VARCHAR(50) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIP_NAME] VARCHAR(150) NULL,
    [SETT_NO] VARCHAR(50) NULL,
    [SETT_TYPE] VARCHAR(50) NULL,
    [BUYQTY] BIGINT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] BIGINT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] BIGINT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] INT NULL,
    [LONG_NAME] VARCHAR(150) NULL,
    [BRANCH_CD] VARCHAR(20) NULL,
    [SUB_BROKER] VARCHAR(20) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(50) NULL,
    [MOBILE_PAGER] VARCHAR(50) NULL,
    [RES_PHONE1] VARCHAR(50) NULL,
    [RES_PHONE2] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSPROC_SAUDA_SUMMARY_dh1
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSPROC_SAUDA_SUMMARY_dh1]
(
    [EXCHANGE] VARCHAR(8) NULL,
    [TRDTYPE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [TRADEDATE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BUYQTY] INT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] INT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] INT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSPROC_SAUDA_SUMMARYCASHPRINT_dh
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSPROC_SAUDA_SUMMARYCASHPRINT_dh]
(
    [EXCHANGE] VARCHAR(8) NULL,
    [TRDTYPE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [TRADEDATE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BUYQTY] INT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] INT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] INT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dkm_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[dkm_temp]
(
    [b2c_sb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_CashCl_AMJ11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_CashCl_AMJ11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_CashCl_JA11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_CashCl_JA11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_CashCl_MJ11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_CashCl_MJ11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_Cl_Aug11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_Cl_Aug11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_FoCl_AMJ11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_FoCl_AMJ11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECN_FoCl_MJ11
-- --------------------------------------------------
CREATE TABLE [dbo].[ECN_FoCl_MJ11]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_after_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_after_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_before_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_before_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCDX_REPORTING_DATE
-- --------------------------------------------------
CREATE TABLE [dbo].[MCDX_REPORTING_DATE]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [MCX_BALANCE] NUMERIC(18, 2) NULL,
    [NET_AMT] MONEY NULL,
    [TOTAL_ISIN] VARCHAR(25) NULL,
    [TOTA_QTY_SEC] NUMERIC(18, 2) NULL,
    [PLD_ISIN] VARCHAR(25) NULL,
    [PLEDGE_QTY] NUMERIC(18, 2) NULL,
    [BARROWING] NUMERIC(18, 2) NULL,
    [SEBI_PAYOUT] VARCHAR(8000) NULL,
    [ASD] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCDX_REPORTING_SUMMARY
-- --------------------------------------------------
CREATE TABLE [dbo].[MCDX_REPORTING_SUMMARY]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [ISIN] VARCHAR(15) NULL,
    [SCRIP] VARCHAR(100) NULL,
    [QTY] FLOAT NULL,
    [PLEDGE_QTY] INT NOT NULL,
    [BORROWING] DECIMAL(38, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_C_WFIN
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_C_WFIN]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [MCX_BALANCE] NUMERIC(18, 2) NULL,
    [NET_AMT] MONEY NULL,
    [TOTAL_ISIN] VARCHAR(25) NULL,
    [TOTA_QTY_SEC] NUMERIC(18, 2) NULL,
    [PLD_ISIN] VARCHAR(25) NULL,
    [PLEDGE_QTY] NUMERIC(18, 2) NULL,
    [BARROWING] NUMERIC(18, 2) NULL,
    [SEBI_PAYOUT] VARCHAR(8000) NULL,
    [ASD] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_S_WFIN
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_S_WFIN]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [ISIN] VARCHAR(15) NULL,
    [SCRIP] VARCHAR(100) NULL,
    [QTY] FLOAT NULL,
    [PLEDGE_QTY] INT NOT NULL,
    [BORROWING] DECIMAL(38, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mismatchQL
-- --------------------------------------------------
CREATE TABLE [dbo].[mismatchQL]
(
    [Party_code] NVARCHAR(50) NULL,
    [Segment] NVARCHAR(50) NULL,
    [Scrip_cd] NVARCHAR(50) NULL,
    [ISIN] NVARCHAR(50) NULL,
    [Qty] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICOMPANY]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL,
    [APPSHARE_ROOTFLDR_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICOMPANY_23032013
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICOMPANY_23032013]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany_25022021
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany_25022021]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL,
    [APPSHARE_ROOTFLDR_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany_BKP_11_11_2022
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany_BKP_11_11_2022]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL,
    [APPSHARE_ROOTFLDR_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany_BKP_20220404
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany_BKP_20220404]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL,
    [APPSHARE_ROOTFLDR_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multicompany_bkup_18Dec2023
-- --------------------------------------------------
CREATE TABLE [dbo].[Multicompany_bkup_18Dec2023]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL,
    [APPSHARE_ROOTFLDR_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICOMPANY_MFSS
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICOMPANY_MFSS]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany_new
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany_new]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbpassword] VARCHAR(25) NULL,
    [Segment_Description] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCDX_REPORTING_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[NCDX_REPORTING_DETAIL]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [NCX_BALANCE] NUMERIC(18, 2) NULL,
    [NET_AMT] MONEY NULL,
    [TOTAL_ISIN] VARCHAR(25) NULL,
    [TOTA_QTY_SEC] NUMERIC(18, 2) NULL,
    [PLD_ISIN] VARCHAR(25) NULL,
    [PLEDGE_QTY] NUMERIC(18, 2) NULL,
    [BARROWING] NUMERIC(18, 2) NULL,
    [SEBI_PAYOUT] VARCHAR(8000) NULL,
    [ASD] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCDX_REPORTING_SUMMARY
-- --------------------------------------------------
CREATE TABLE [dbo].[NCDX_REPORTING_SUMMARY]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [ISIN] VARCHAR(15) NULL,
    [SCRIP] VARCHAR(100) NULL,
    [QTY] FLOAT NULL,
    [PLEDGE_QTY] INT NOT NULL,
    [BORROWING] DECIMAL(38, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCX_C_WFIN
-- --------------------------------------------------
CREATE TABLE [dbo].[NCX_C_WFIN]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [NCX_BALANCE] NUMERIC(18, 2) NULL,
    [NET_AMT] MONEY NULL,
    [TOTAL_ISIN] VARCHAR(25) NULL,
    [TOTA_QTY_SEC] NUMERIC(18, 2) NULL,
    [PLD_ISIN] VARCHAR(25) NULL,
    [PLEDGE_QTY] NUMERIC(18, 2) NULL,
    [BARROWING] NUMERIC(18, 2) NULL,
    [SEBI_PAYOUT] VARCHAR(8000) NULL,
    [ASD] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCX_S_WFIN
-- --------------------------------------------------
CREATE TABLE [dbo].[NCX_S_WFIN]
(
    [LONG_NAME] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [ISIN] VARCHAR(15) NULL,
    [SCRIP] VARCHAR(100) NULL,
    [QTY] FLOAT NULL,
    [PLEDGE_QTY] INT NOT NULL,
    [BORROWING] DECIMAL(38, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSE_DATA_FINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[NSE_DATA_FINAL]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [NET_AMT] MONEY NULL,
    [NSEBALANCE] NUMERIC(18, 2) NULL,
    [TOTAL_ISIN] VARCHAR(25) NULL,
    [TOTA_QTY_SEC] NUMERIC(18, 2) NULL,
    [PLEDGE_QTY] NUMERIC(18, 2) NULL,
    [PLDGE_AMOUNT] NUMERIC(18, 2) NULL,
    [SEBI_PAYOUT] DATETIME NULL,
    [BSE_BALANCE] NUMERIC(18, 2) NULL,
    [MCD] NUMERIC(18, 2) NULL,
    [BSX] NUMERIC(18, 2) NULL,
    [MTF] NUMERIC(18, 2) NULL,
    [BARROWING] NUMERIC(18, 2) NULL,
    [MCX_BALANCE] NUMERIC(18, 2) NULL,
    [NCX] NUMERIC(18, 2) NULL,
    [PLD_ISIN] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEEND
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEEND]
(
    [Party_Code] NVARCHAR(50) NULL,
    [Party_Name] NVARCHAR(50) NULL,
    [Scrip_Cd] NVARCHAR(50) NULL,
    [Series] NVARCHAR(50) NULL,
    [DPId] NVARCHAR(50) NULL,
    [ClientId] NVARCHAR(50) NULL,
    [Isin] NVARCHAR(50) NULL,
    [Sett_No] NVARCHAR(50) NULL,
    [Sett_Type] NVARCHAR(50) NULL,
    [HoldQty] NVARCHAR(50) NULL,
    [PledgeQty] NVARCHAR(50) NULL,
    [Qty] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsehold
-- --------------------------------------------------
CREATE TABLE [dbo].[nsehold]
(
    [PartyCode] VARCHAR(50) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [DpId] VARCHAR(50) NULL,
    [CltCode] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [HoldQty] INT NULL,
    [PledgeQty] INT NULL,
    [Qty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEHOLD1
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEHOLD1]
(
    [PartyCode] VARCHAR(50) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [DpId] VARCHAR(50) NULL,
    [CltCode] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [HoldQty] INT NULL,
    [PledgeQty] INT NULL,
    [Qty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PPFinal$
-- --------------------------------------------------
CREATE TABLE [dbo].[PPFinal$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [PartyName] NVARCHAR(255) NULL,
    [VocName] FLOAT NULL,
    [Mode Of Pay] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Request Dt#] DATETIME NULL,
    [ActiveFromDate] DATETIME NULL,
    [ExpiryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pravin
-- --------------------------------------------------
CREATE TABLE [dbo].[pravin]
(
    [brachcode] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(10) NULL,
    [[long_name]]] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prepaddata1$
-- --------------------------------------------------
CREATE TABLE [dbo].[prepaddata1$]
(
    [PartyCode] NVARCHAR(255) NULL,
    [PartyName] NVARCHAR(255) NULL,
    [VocName] FLOAT NULL,
    [ModeOfPay] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [RequestDt] DATETIME NULL,
    [ActiveFromDt] DATETIME NULL,
    [ExpiryDt] DATETIME NULL,
    [DepBal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prepaid$
-- --------------------------------------------------
CREATE TABLE [dbo].[prepaid$]
(
    [Party_Code] NVARCHAR(255) NULL,
    [Active_From] DATETIME NULL,
    [Expiry_dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL
-- --------------------------------------------------
CREATE TABLE [dbo].[QL]
(
    [cql_partycode] VARCHAR(10) NULL,
    [cql_segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_ADDR
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_ADDR]
(
    [ACNAME] VARCHAR(100) NULL,
    [COMPANY] VARCHAR(29) NOT NULL,
    [COMPANY_ADD] VARCHAR(159) NULL,
    [L_ADDRESS1] VARCHAR(40) NOT NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [RES_PHONE1] VARCHAR(15) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_NATION] VARCHAR(15) NULL,
    [BRANCH] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(20) NULL,
    [MOBILE_PAGER] VARCHAR(40) NULL,
    [CL_CODE] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_AMJ_Hold
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_AMJ_Hold]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ql_AMJ_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Ql_AMJ_Mismatch]
(
    [Party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [CertNo] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ql_AMJ_Mismatch1
-- --------------------------------------------------
CREATE TABLE [dbo].[Ql_AMJ_Mismatch1]
(
    [Party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [CertNo] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_CLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_CLIENT]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_dkm
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_dkm]
(
    [Column 0] NVARCHAR(50) NULL,
    [Column 1] NVARCHAR(50) NULL,
    [Column 2] NVARCHAR(50) NULL,
    [Column 3] NVARCHAR(50) NULL,
    [Column 4] NVARCHAR(50) NULL,
    [Column 5] NVARCHAR(50) NULL,
    [Column 6] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold]
(
    [Segment] VARCHAR(5) NULL,
    [PArty_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_241212_All
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_241212_All]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_CGT
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_CGT]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_JFM12
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_JFM12]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ql_hold_mis_2808
-- --------------------------------------------------
CREATE TABLE [dbo].[ql_hold_mis_2808]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010413
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010413]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0105
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0105]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010615
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010615]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010713
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010713]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010811
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010811]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS010914
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS010914]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS011012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS011012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS011214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS011214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020215
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020215]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020315
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020315]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020614
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020614]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020712
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020712]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS020913
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS020913]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS021213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS021213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030314
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030314]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0304
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0304]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030412
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030412]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030613
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030613]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030815
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030815]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030911
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030911]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS030912
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS030912]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS031011
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS031011]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS031114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS031114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS031212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS031212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040213_p1
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040213_p1]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040213_p2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040213_p2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040313
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040313]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040515
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040515]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040612
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040612]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040711
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040711]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS040814
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS040814]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0409
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0409]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS050115
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS050115]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0502
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0502]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS050211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS050211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS050312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS050312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS050514
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS050514]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS050813
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS050813]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS051113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS051113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS051113_all
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS051113_all]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS051211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS051211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS051211_v2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS051211_v2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0603
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0603]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060415
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060415]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060513
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060513]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060513_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060513_P2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060611
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060611]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060616
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060616]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060715
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060715]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060811
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060811]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS060812
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS060812]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS061112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS061112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS070113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS070113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS070414
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS070414]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS070714
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS070714]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS071013
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS071013]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS071014
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS071014]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS080413
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS080413]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0805
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0805]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS080615
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS080615]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS080713
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS080713]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS0809
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS0809]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS080914
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS080914]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS081012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS081012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS081111
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS081111]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS081214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS081214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090215
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090215]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090315
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090315]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090412
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090412]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090614
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090614]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS090712
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS090712]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS091213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS091213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100314
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100314]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1004
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1004]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100613
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100613]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100815
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100815]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100912
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100912]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS100913
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS100913]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS101011
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS101011]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS101114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS101114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS101212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS101212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110116
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110116]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110313
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110313]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110515
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110515]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110612
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110612]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110711
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110711]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS110814
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS110814]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS111113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS111113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS111211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS111211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120115
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120115]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120514
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120514]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120813
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120813]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS120911
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS120911]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS121216
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS121216]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1303
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1303]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130415
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130415]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130513
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130513]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130513_P1
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130513_P1]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130513_P3
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130513_P3]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130611
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130611]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130715
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130715]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130811
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130811]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS130812
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS130812]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS131014
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS131014]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS131112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS131112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS140113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS140113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS140512
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS140512]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS140714
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS140714]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1408
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1408]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1409
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1409]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS141111
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS141111]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS150413
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS150413]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS150414
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS150414]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS150615
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS150615]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS150713
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS150713]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS150914
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS150914]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS151012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS151012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS151214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS151214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160215
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160215]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160315
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160315]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160412
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160412]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160511
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160511]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160614
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160614]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160712
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160712]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS160913
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS160913]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS161017
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS161017]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS161213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS161213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1701
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1701]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1704
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1704]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170613
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170613]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170613_all]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170613_allN
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170613_allN]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170815
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170815]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS1709
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS1709]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS170912
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS170912]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS171011
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS171011]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS171013
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS171013]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS171114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS171114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS171212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS171212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180313
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180313]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180314
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180314]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180515
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180515]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180612
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180612]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180711
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180711]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180814
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180814]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS180917
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS180917]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS181113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS181113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190115
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190115]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190514
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190514]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190813
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190813]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS190911
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS190911]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS191112_p1
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS191112_p1]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS191112_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS191112_P2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS191211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS191211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200415
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200415]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200513
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200513]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200513_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200513_P2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200611
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200611]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200715
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200715]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS200811
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS200811]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2009
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2009]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS201014
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS201014]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2103
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2103]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210414
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210414]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210512
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210512]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210714
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210714]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2108
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2108]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS210812
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS210812]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS211013
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS211013]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS211111
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS211111]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220413
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220413]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220413_N
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220413_N]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220413_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220413_P2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220615
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220615]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220713
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220713]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220713_all
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220713_all]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220816
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220816]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2209
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2209]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS220914
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS220914]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS221012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS221012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS221214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS221214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230215
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230215]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230315
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230315]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230412
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230412]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230511
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230511]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230516
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230516]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230614
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230614]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230712
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230712]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS230913
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS230913]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS231213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS231213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240314
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240314]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2404
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2404]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240511
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240511]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240613
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240613]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240613_all
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240613_all]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240815
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240815]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS240912
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS240912]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS241011
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS241011]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS241016
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS241016]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS241114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS241114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250116
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250116]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250313
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250313]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250515
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250515]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250612
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250612]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250711
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250711]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS250814
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS250814]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2509
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2509]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS251113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS251113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS251211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS251211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS260211
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS260211]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS260312
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS260312]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS260514
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS260514]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS260813
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS260813]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS260911
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS260911]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS261112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS261112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS261212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS261212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2701
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2701]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270114
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270114]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270115
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270115]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270212
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270212]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270415
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270415]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270513
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270513]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270611
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270611]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270715
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270715]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270811
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270811]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS270812
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS270812]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS271014
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS271014]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS280113
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS280113]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2803
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2803]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS280414
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS280414]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS280512
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS280512]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS280714
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS280714]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2808
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2808]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2809
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2809]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS281013
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS281013]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS281111
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS281111]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS281111_V2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS281111_V2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2812
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2812]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS290413
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS290413]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS290413_p2
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS290413_p2]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS290615
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS290615]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS290713
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS290713]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS2909
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS2909]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS290914
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS290914]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS291012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS291012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS291214
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS291214]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300111
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300111]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300112
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300112]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300315
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300315]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300412
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300412]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300511
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300511]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300614
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300614]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300712
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300712]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS300913
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS300913]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS3012
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS3012]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS301213
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS301213]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS310314
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS310314]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS310317_new
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS310317_new]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS310815
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS310815]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCS311011
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCS311011]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCSpend
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCSpend]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Hold_SCCSpendCl1
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Hold_SCCSpendCl1]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_JUL
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_JUL]
(
    [cql_partycode] VARCHAR(10) NULL,
    [cql_segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_Jun_Hold
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_Jun_Hold]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ql_Mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Ql_Mismatch]
(
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_mismatch_11062010
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_mismatch_11062010]
(
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_mismatch1506
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_mismatch1506]
(
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ql_Mismatch3003
-- --------------------------------------------------
CREATE TABLE [dbo].[Ql_Mismatch3003]
(
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ql_miss
-- --------------------------------------------------
CREATE TABLE [dbo].[ql_miss]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL_missing
-- --------------------------------------------------
CREATE TABLE [dbo].[QL_missing]
(
    [party_code] VARCHAR(10) NULL,
    [Segment] VARCHAR(5) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QL_Hold] INT NULL,
    [BO_hold] INT NOT NULL,
    [Ctyp] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QL2_Hold_JAS10
-- --------------------------------------------------
CREATE TABLE [dbo].[QL2_Hold_JAS10]
(
    [Segment] VARCHAR(5) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Net] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Query
-- --------------------------------------------------
CREATE TABLE [dbo].[Query]
(
    [party_code] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Samit
-- --------------------------------------------------
CREATE TABLE [dbo].[Samit]
(
    [party_code] VARCHAR(10) NULL,
    [turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sauda_trace
-- --------------------------------------------------
CREATE TABLE [dbo].[sauda_trace]
(
    [RowNumber] INT IDENTITY(0,1) NOT NULL,
    [EventClass] INT NULL,
    [TextData] NTEXT NULL,
    [ApplicationName] NVARCHAR(128) NULL,
    [NTUserName] NVARCHAR(128) NULL,
    [LoginName] NVARCHAR(128) NULL,
    [CPU] INT NULL,
    [Reads] BIGINT NULL,
    [Writes] BIGINT NULL,
    [Duration] BIGINT NULL,
    [ClientProcessID] INT NULL,
    [SPID] INT NULL,
    [StartTime] DATETIME NULL,
    [EndTime] DATETIME NULL,
    [BinaryData] IMAGE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSANNEXURE_A_31aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSANNEXURE_A_31aug2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSANNEXURE_B_31aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSANNEXURE_B_31aug2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSANNEXURE_C_31aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSANNEXURE_C_31aug2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSANNEXURE_D_31aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSANNEXURE_D_31aug2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSANNEXURE_E_31aug2023
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSANNEXURE_E_31aug2023]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip1_27Jan2010
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip1_27Jan2010]
(
    [co_code] INT NULL,
    [series] VARCHAR(3) NOT NULL,
    [short_name] VARCHAR(50) NULL,
    [long_name] VARCHAR(50) NULL,
    [market_lot] INT NULL,
    [face_val] FLOAT NULL,
    [book_cl_dt] DATETIME NULL,
    [ex_div_dt] DATETIME NULL,
    [ex_bon_dt] DATETIME NULL,
    [ex_rit_dt] DATETIME NULL,
    [eqt_type] VARCHAR(3) NULL,
    [sub_type] VARCHAR(3) NULL,
    [agent_cd] VARCHAR(6) NULL,
    [demat_flag] SMALLINT NULL,
    [demat_date] DATETIME NULL,
    [rec1] VARCHAR(10) NULL,
    [rec2] VARCHAR(10) NULL,
    [rec3] VARCHAR(10) NULL,
    [rec4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip2_27Jan2010
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip2_27Jan2010]
(
    [co_code] INT NULL,
    [series] VARCHAR(3) NOT NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [scrip_cat] VARCHAR(3) NULL,
    [no_del_fr] DATETIME NULL,
    [no_del_to] DATETIME NULL,
    [cl_rate] FLOAT NULL,
    [clos_rate_dt] DATETIME NULL,
    [min_trd_qty] INT NULL,
    [BseCode] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [delsc_cat] VARCHAR(3) NULL,
    [Sector] VARCHAR(10) NULL,
    [Track] VARCHAR(1) NULL,
    [CDOL_No] VARCHAR(15) NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL,
    [Globalcustodian] VARCHAR(25) NULL,
    [common_code] VARCHAR(25) NULL,
    [IndexName] VARCHAR(10) NULL,
    [Industry] VARCHAR(10) NULL,
    [Bloomberg] VARCHAR(10) NULL,
    [RicCode] VARCHAR(10) NULL,
    [Reuters] VARCHAR(10) NULL,
    [IES] VARCHAR(10) NULL,
    [NoofIssuedshares] NUMERIC(18, 4) NULL,
    [Status] VARCHAR(10) NULL,
    [ADRGDRRatio] NUMERIC(18, 4) NULL,
    [GEMultiple] NUMERIC(18, 4) NULL,
    [GroupforGE] INT NULL,
    [RBICeilingIndicatorFlag] VARCHAR(2) NULL,
    [RBICeilingIndicatorValue] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebi_sEgveridata_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sebi_sEgveridata_hist]
(
    [POrequestID] VARCHAR(25) NULL,
    [id] INT NOT NULL,
    [ProcessDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Segment] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Flag] CHAR(1) NULL,
    [Balance] MONEY NULL,
    [UnsettledCrBill] MONEY NULL,
    [UnrecoAmt] MONEY NULL,
    [ShortSellValue] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [MarginAdjWithColl] MONEY NULL,
    [MarginShortage] MONEY NULL,
    [AccruedCharges] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [NonCashConsideration] MONEY NULL,
    [ExpoUtilised] MONEY NULL,
    [NetPayable] MONEY NULL,
    [UnPosted_PO] MONEY NULL,
    [Margin50%] MONEY NULL,
    [Margin225%] MONEY NULL,
    [Margin225%-50%] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1$]
(
    [A10018] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet2$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet2$]
(
    [fldusername] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SSDEC2010
-- --------------------------------------------------
CREATE TABLE [dbo].[SSDEC2010]
(
    [party_code] VARCHAR(10) NULL,
    [branch_cd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ACT_Client_details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ACT_Client_details]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_zip] VARCHAR(10) NULL,
    [Active_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Ann_b
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Ann_b]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] NUMERIC(2, 2) NOT NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_SECURITIESPAYIN_BSECM] NUMERIC(2, 2) NOT NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_TURNOVER_BSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_NSECM] NUMERIC(2, 2) NOT NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_SECURITIESPAYIN_NSECM] NUMERIC(2, 2) NOT NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_TURNOVER_NSECM] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_NSEFO] NUMERIC(2, 2) NOT NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] NUMERIC(2, 2) NOT NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] NUMERIC(2, 2) NOT NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] NUMERIC(2, 2) NOT NULL,
    [Tday_FundsPayin_NCDX] NUMERIC(2, 2) NOT NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_B2B_CL
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_B2B_CL]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_B2C_CL
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_B2C_CL]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Banned_CL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Banned_CL]
(
    [CLIENTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BO_city
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BO_city]
(
    [l_city] VARCHAR(40) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CGT_ClLst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CGT_ClLst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Cl_JUL
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Cl_JUL]
(
    [cl_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CL_SEBI
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CL_SEBI]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Client_details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Client_details]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_zip] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLmst_AMRTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLmst_AMRTS]
(
    [Party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ECN_BKGmis
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ECN_BKGmis]
(
    [Month_bkg] VARCHAR(2) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [BKG] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ECNCASH
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ECNCASH]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ecncash_11052011
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ecncash_11052011]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(10) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ECNFO
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ECNFO]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ecnfo_11052011
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ecnfo_11052011]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [long_name] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [L_City] VARCHAR(40) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [L_State] VARCHAR(50) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [RES_Phone1] VARCHAR(15) NULL,
    [RES_Phone2] VARCHAR(15) NULL,
    [OFF_Phone1] VARCHAR(15) NULL,
    [Area] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [ParentCode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FMC_CL130812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FMC_CL130812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_HOLDING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_HOLDING]
(
    [PARTY_CODE] VARCHAR(15) NULL,
    [ISIN] VARCHAR(15) NULL,
    [QTY] FLOAT NULL,
    [SCRIP] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_inactive_dkm1512
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_inactive_dkm1512]
(
    [cl_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ISINactive_DelistedScrip
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ISINactive_DelistedScrip]
(
    [ISIN] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_JAScl_NRI
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_JAScl_NRI]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Margindata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Margindata]
(
    [Party_code] VARCHAR(20) NULL,
    [updatedon] DATETIME NULL,
    [Margin50%] MONEY NULL,
    [Margin225%] MONEY NULL,
    [Margin225%-50%] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Margindata_test08oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Margindata_test08oct2022]
(
    [Party_code] VARCHAR(20) NULL,
    [updatedon] DATETIME NULL,
    [Margin50%] MONEY NULL,
    [Margin225%] MONEY NULL,
    [Margin225%-50%] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS030911_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS030911_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS051211_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS051211_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS060611_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS060611_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS060811_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS060811_clmst]
(
    [Party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS120911_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS120911_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS130212_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS130212_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS130311_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS130311_clmst]
(
    [Party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS130611_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS130611_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS130811_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS130811_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS1701_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS1701_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS190911_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS190911_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS200611_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS200611_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS200811_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS200811_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS2012_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS2012_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS210212_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS210212_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS210311_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS210311_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS211111_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS211111_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS230511_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS230511_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS2312_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS2312_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS260911_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS260911_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS2701_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS2701_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS270611_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS270611_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS270811_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS270811_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS280311_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS280311_clmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS281111_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS281111_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS2812_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS2812_clmst]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mismatch_SCCS3012_clmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mismatch_SCCS3012_clmst]
(
    [PArty_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Muth_QL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Muth_QL]
(
    [CLIENTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Old_ISIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Old_ISIN]
(
    [CertNo] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PLDRPT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PLDRPT]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QTY] INT NULL,
    [PLEDGE_VALUE] MONEY NULL,
    [BORROWING] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_PO_city
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_PO_city]
(
    [city] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PrePaid_Cl
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PrePaid_Cl]
(
    [FLD_Partycode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Prepaid_Sebi
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Prepaid_Sebi]
(
    [Exchange] VARCHAR(5) NOT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Sauda_date] DATETIME NULL,
    [TRD] MONEY NULL,
    [BKG] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_QL_Holding_Party
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_QL_Holding_Party]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_QLAMJ_UAT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_QLAMJ_UAT]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [STATUSNAME] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced_03092018
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced_03092018]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [STATUSNAME] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced_04112019
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced_04112019]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [STATUSNAME] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced_12082015
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced_12082015]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [STATUSNAME] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced_23092016
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced_23092016]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [STATUSNAME] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLCASH_bounced_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLCASH_bounced_IMP]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SAUDA_DATE] VARCHAR(11) NULL,
    [SESSION_ID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_QLmismatch_Active
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_QLmismatch_Active]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Quarterly_Cash_SaudaSummary_mimansa
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Quarterly_Cash_SaudaSummary_mimansa]
(
    [EXCHANGE] VARCHAR(50) NULL,
    [TRDTYPE] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(20) NULL,
    [TRADEDATE] VARCHAR(50) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIP_NAME] VARCHAR(150) NULL,
    [SETT_NO] VARCHAR(50) NULL,
    [SETT_TYPE] VARCHAR(50) NULL,
    [BUYQTY] BIGINT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] BIGINT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] BIGINT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] INT NULL,
    [LONG_NAME] VARCHAR(150) NULL,
    [BRANCH_CD] VARCHAR(20) NULL,
    [SUB_BROKER] VARCHAR(20) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(50) NULL,
    [MOBILE_PAGER] VARCHAR(50) NULL,
    [RES_PHONE1] VARCHAR(50) NULL,
    [RES_PHONE2] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Quarterly_Cash_SaudaSummary_mimansanew
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Quarterly_Cash_SaudaSummary_mimansanew]
(
    [EXCHANGE] VARCHAR(50) NULL,
    [TRDTYPE] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(20) NULL,
    [TRADEDATE] VARCHAR(50) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIP_NAME] VARCHAR(150) NULL,
    [SETT_NO] VARCHAR(50) NULL,
    [SETT_TYPE] VARCHAR(50) NULL,
    [BUYQTY] BIGINT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] BIGINT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] BIGINT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] INT NULL,
    [LONG_NAME] VARCHAR(150) NULL,
    [BRANCH_CD] VARCHAR(20) NULL,
    [SUB_BROKER] VARCHAR(20) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(50) NULL,
    [MOBILE_PAGER] VARCHAR(50) NULL,
    [RES_PHONE1] VARCHAR(50) NULL,
    [RES_PHONE2] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rcs
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rcs]
(
    [Party_code] VARCHAR(50) NOT NULL,
    [Segment] VARCHAR(50) NOT NULL,
    [Scrip_cd] VARCHAR(50) NOT NULL,
    [ISIN] VARCHAR(50) NOT NULL,
    [QTY] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL010113
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL010113]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL010511
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL010511]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL010811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL010811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL011012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL011012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL020112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL020112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL020712
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL020712]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL030411
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL030411]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL030412
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL030412]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL030912
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL030912]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL031011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL031011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL031212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL031212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL040612
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL040612]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL040711
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL040711]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL0409
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL0409]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL040911
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL040911]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL050312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL050312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL051211
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL051211]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL060212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL060212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL06022011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL06022011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL060311
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL060311]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL060611
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL060611]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL060811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL060811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL060812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL060812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL061112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL061112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL070113
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL070113]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL071111
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL071111]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL080511
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL080511]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL0809
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL0809]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL081012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL081012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL090112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL090112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL090412
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL090412]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL090712
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL090712]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL100411
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL100411]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL100912
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL100912]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL101011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL101011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL101212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL101212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL110612
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL110612]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL110711
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL110711]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL111211
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL111211]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL120312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL120312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL120911
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL120911]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130113
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130113]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130212_bak240212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130212_bak240212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL13022011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL13022011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130311
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130311]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130611
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130611]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL130812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL130812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL131112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL131112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL1312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL1312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL140512
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL140512]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL1408
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL1408]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL1409
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL1409]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL141111
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL141111]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL151012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL151012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL160112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL160112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL160412
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL160412]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL160511
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL160511]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL160712
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL160712]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL1701
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL1701]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL170411
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL170411]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL1709
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL1709]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL170912
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL170912]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL171011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL171011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL171212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL171212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL180612
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL180612]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL180711
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL180711]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL190312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL190312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL190911
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL190911]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL191112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL191112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL191112_P2
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL191112_P2]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL191211
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL191211]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL20022011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL20022011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL200611
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL200611]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL200811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL200811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2009
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2009]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL210212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL210212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL210212_bak2102
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL210212_bak2102]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL210311
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL210311]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL210512
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL210512]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2108
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2108]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL210812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL210812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL211111
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL211111]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL211111_bak2811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL211111_bak2811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2209
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2209]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL221012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL221012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL230112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL230112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL230412
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL230412]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL230511
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL230511]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL230712
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL230712]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL240411
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL240411]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL240912
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL240912]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL241011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL241011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL250612
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL250612]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL250711
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL250711]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2509
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2509]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL251211
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL251211]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL260312
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL260312]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL260911
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL260911]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL261112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL261112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL261212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL261212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2701
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2701]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL270212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL270212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL27022011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL27022011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL270611
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL270611]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL270811
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL270811]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL270812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL270812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL280311
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL280311]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL280512
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL280512]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2808
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2808]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2809
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2809]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL281111
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL281111]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL281111_bak1212
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL281111_bak1212]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2812
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2812]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL290412
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL290412]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL2909
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL2909]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL291012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL291012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL300112
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL300112]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL30012011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL30012011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL300511
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL300511]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL300712
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL300712]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL3012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL3012]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_CL311011
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_CL311011]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_ClPen
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_ClPen]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_DATA_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_DATA_TEMP]
(
    [SCCS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [BSECM_LEDGER] MONEY NULL,
    [NSECM_LEDGER] MONEY NULL,
    [NSEFO_LEDGER] MONEY NULL,
    [NSX_LEDGER] MONEY NULL,
    [MCD_LEDGER] MONEY NULL,
    [MCDX_LEDGER] MONEY NULL,
    [NCDX_LEDGER] MONEY NULL,
    [BSECM_DEPOSIT] MONEY NULL,
    [NSECM_DEPOSIT] MONEY NULL,
    [NSEFO_DEPOSIT] MONEY NULL,
    [NSX_DEPOSIT] MONEY NULL,
    [MCD_DEPOSIT] MONEY NULL,
    [MCDX_DEPOSIT] MONEY NULL,
    [NCDX_DEPOSIT] MONEY NULL,
    [OTHER_SEGMENT] MONEY NULL,
    [BSECM_COLLATERAL] INT NOT NULL,
    [NSECM_COLLATERAL] INT NOT NULL,
    [NSEFO_COLLATERAL] MONEY NULL,
    [NSX_COLLATERAL] MONEY NULL,
    [MCD_COLLATERAL] MONEY NULL,
    [MCDX_COLLATERAL] MONEY NULL,
    [NCDX_COLLATERAL] MONEY NULL,
    [ACCRUAL] NUMERIC(20, 4) NULL,
    [BSECM_UNRECO] MONEY NULL,
    [NSECM_UNRECO] MONEY NULL,
    [NSEFO_UNRECO] MONEY NULL,
    [NSX_UNRECO] MONEY NULL,
    [MCD_UNRECO] MONEY NULL,
    [MCDX_UNRECO] MONEY NULL,
    [NCDX_UNRECO] MONEY NULL,
    [NSEFO_MARGIN] NUMERIC(23, 6) NULL,
    [NSX_MARGIN] NUMERIC(23, 6) NULL,
    [MCD_MARGIN] NUMERIC(23, 6) NULL,
    [MCDX_MARGIN] MONEY NULL,
    [NCDX_MARGIN] MONEY NULL,
    [BSECM_UNSETTLE] MONEY NULL,
    [NSECM_UNSETTLE] MONEY NULL,
    [NSEFO_UNSETTLE] MONEY NULL,
    [NSX_UNSETTLE] MONEY NULL,
    [MCD_UNSETTLE] MONEY NULL,
    [MCDX_UNSETTLE] MONEY NULL,
    [NCDX_UNSETTLE] MONEY NULL,
    [CASH_ADDITIONAL_MARGIN] MONEY NULL,
    [NSEFO_ADDITIONAL_MARGIN] MONEY NULL,
    [MCDX_ADDITIONAL_MARGIN] MONEY NULL,
    [NCDX_ADDITIONAL_MARGIN] MONEY NULL,
    [SECURITY_HOLDING] FLOAT NOT NULL,
    [SHARES_PAYOUT_VALUE] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_DATA_TEMP_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_DATA_TEMP_ORG]
(
    [SCCS_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [BSECM_LEDGER] MONEY NULL,
    [NSECM_LEDGER] MONEY NULL,
    [NSEFO_LEDGER] MONEY NULL,
    [NSX_LEDGER] MONEY NULL,
    [MCD_LEDGER] MONEY NULL,
    [BSECM_DEPOSIT] MONEY NULL,
    [NSECM_DEPOSIT] MONEY NULL,
    [NSEFO_DEPOSIT] MONEY NULL,
    [NSX_DEPOSIT] MONEY NULL,
    [MCD_DEPOSIT] MONEY NULL,
    [OTHER_SEGMENT] MONEY NULL,
    [BSECM_COLLATERAL] INT NOT NULL,
    [NSECM_COLLATERAL] INT NOT NULL,
    [NSEFO_COLLATERAL] MONEY NULL,
    [NSX_COLLATERAL] MONEY NULL,
    [MCD_COLLATERAL] MONEY NULL,
    [ACCRUAL] NUMERIC(20, 4) NULL,
    [BSECM_UNRECO] MONEY NULL,
    [NSECM_UNRECO] MONEY NULL,
    [NSEFO_UNRECO] MONEY NULL,
    [NSX_UNRECO] MONEY NULL,
    [MCD_UNRECO] MONEY NULL,
    [NSEFO_MARGIN] NUMERIC(23, 6) NULL,
    [NSX_MARGIN] NUMERIC(23, 6) NULL,
    [MCD_MARGIN] NUMERIC(23, 6) NULL,
    [BSECM_UNSETTLE] MONEY NULL,
    [NSECM_UNSETTLE] MONEY NULL,
    [NSEFO_UNSETTLE] MONEY NULL,
    [NSX_UNSETTLE] MONEY NULL,
    [MCD_UNSETTLE] MONEY NULL,
    [CASH_ADDITIONAL_MARGIN] MONEY NULL,
    [NSEFO_ADDITIONAL_MARGIN] MONEY NULL,
    [SECURITY_HOLDING] FLOAT NOT NULL,
    [SHARES_PAYOUT_VALUE] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_PenCL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_PenCL]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_03aug2021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_03aug2021]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_04oct2022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_09sep2021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_09sep2021]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_10jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_10jan2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_11jul2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_11jul2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_NCE] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NCE] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NCE] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NCE] MONEY NULL,
    [TDAY_TURNOVER_NCE] MONEY NULL,
    [Tday_Margin_NCE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_03aug2021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_03aug2021]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_04mar2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_04mar2025]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_04oct2022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_05jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_05jan2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_09jan2024
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_09jan2024]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_09Jan2024_2
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_09Jan2024_2]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_10jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_10jan2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_11jul2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_11jul2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_BAK_14102022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_BAK_14102022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [Tday_FundsPayin_MCX] MONEY NULL,
    [Tday_FundsPayin_NCDX] MONEY NULL,
    [Tday_Margin_MCX] MONEY NULL,
    [Tday_Margin_NCDX] MONEY NULL,
    [Tday_Margin_BSECM] MONEY NULL,
    [Tday_Margin_NSECM] MONEY NULL,
    [Tday_Margin_BSX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_B_TEMP_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_B_TEMP_ORG]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_DEBITBAL] NUMERIC(2, 2) NOT NULL,
    [TDAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_BSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_BSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_BSECM] MONEY NULL,
    [TDAY_TURNOVER_BSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [T_1DAY_FUNDSPAYIN_NSECM] MONEY NULL,
    [TDAY_SECURITIESPAYIN_NSECM] MONEY NULL,
    [T_1DAY_SECURITESPAYIN_NSECM] MONEY NULL,
    [TDAY_TURNOVER_NSECM] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSEFO] MONEY NULL,
    [TDAY_MARGIN_NSEFO] MONEY NULL,
    [TDAY_FUNDSPAYIN_NSX] MONEY NULL,
    [TDAY_MARGIN_NSX] MONEY NULL,
    [TDAY_FUNDSPAYIN_MCD] MONEY NULL,
    [TDAY_MARGIN_MCD] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [ACCRUALAMT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_C_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_C_TEMP]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_C_TEMP_03aug2021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_C_TEMP_03aug2021]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_C_TEMP_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_C_TEMP_04oct2022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_C_TEMP_10jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_C_TEMP_10jan2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_C_TEMP_11jul2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_C_TEMP_11jul2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_D_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_D_TEMP]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_D_TEMP_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_D_TEMP_04oct2022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_D_TEMP_10jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_D_TEMP_10jan2023]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(200) NULL,
    [ISIN] VARCHAR(50) NULL,
    [QUANTITY] FLOAT NULL,
    [CLOSING_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VALUE] MONEY NULL,
    [SEGMENT] VARCHAR(50) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP_03aug2021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP_03aug2021]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP_04oct2022]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP_10jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP_10jan2023]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP_11jul2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP_11jul2023]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_E_TEMP_BAK_14102022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_E_TEMP_BAK_14102022]
(
    [PARTY_CODE] VARCHAR(30) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [COLL_TYPE] VARCHAR(15) NULL,
    [BANK_CODE] VARCHAR(50) NULL,
    [FD_BGNO] VARCHAR(75) NULL,
    [MATURITY_DATE] DATETIME NULL,
    [FINALAMOUNT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSCLIENT]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCCS_DATE] DATETIME NULL,
    [FLAG] VARCHAR(1) NULL,
    [INACTIVE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSCLIENT_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSCLIENT_04oct2022]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCCS_DATE] DATETIME NULL,
    [FLAG] VARCHAR(1) NULL,
    [INACTIVE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SSH_cllst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SSH_cllst]
(
    [Party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_WRQL_holdcl
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_WRQL_holdcl]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbladminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbladminconfig]
(
    [Fldauto] INT NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [fldcategorycode] INT NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcatmenu]
(
    [fldauto] INT NOT NULL,
    [fldreportcode] INT NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLDEL_TRANSSTAT_QRLY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLDEL_TRANSSTAT_QRLY]
(
    [Sno] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Refno] INT NOT NULL,
    [Tcode] NUMERIC(18, 0) NOT NULL,
    [Trtype] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [Fromno] VARCHAR(16) NULL,
    [Tono] VARCHAR(16) NULL,
    [Certno] VARCHAR(16) NULL,
    [Foliono] VARCHAR(16) NULL,
    [Holdername] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [Orgqty] NUMERIC(18, 0) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [Branchcd] VARCHAR(10) NOT NULL,
    [Partipantcode] VARCHAR(10) NOT NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Batchno] VARCHAR(10) NULL,
    [Isett_No] VARCHAR(7) NULL,
    [Isett_Type] VARCHAR(2) NULL,
    [Sharetype] VARCHAR(8) NULL,
    [Transdate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Bdptype] VARCHAR(10) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltdpid] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [SCRIP_NAME] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLDEL_TRANSSTAT1_QRLY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLDEL_TRANSSTAT1_QRLY]
(
    [TRANSDATE] VARCHAR(30) NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(16) NULL,
    [CQTY] NUMERIC(38, 0) NULL,
    [DQTY] NUMERIC(38, 0) NULL,
    [SLIPNO] NUMERIC(18, 0) NULL,
    [DPID] VARCHAR(16) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] NUMERIC(18, 0) NOT NULL,
    [REASON] VARCHAR(100) NULL,
    [BDPID] VARCHAR(16) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATE1] DATETIME NOT NULL,
    [FLAG] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbldkm_sauda_summary_cm_1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbldkm_sauda_summary_cm_1]
(
    [EXCHANGE] VARCHAR(8) NULL,
    [TRDTYPE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [TRADEDATE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BUYQTY] INT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] INT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] INT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbldkm_sauda_summary_fo
-- --------------------------------------------------
CREATE TABLE [dbo].[tbldkm_sauda_summary_fo]
(
    [EXCHANGE] VARCHAR(8) NULL,
    [TRADEDATE] VARCHAR(10) NULL,
    [TRADETYPE] VARCHAR(3) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [BUYQTY] INT NULL,
    [BUYRATE] INT NULL,
    [SELLQTY] INT NULL,
    [SELLRATE] INT NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] TINYINT NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [SCRIP_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbldkm_sauda_summary_fo_1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbldkm_sauda_summary_fo_1]
(
    [EXCHANGE] VARCHAR(8) NULL,
    [TRADEDATE] VARCHAR(10) NULL,
    [TRADETYPE] VARCHAR(3) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [BUYQTY] INT NULL,
    [BUYRATE] INT NULL,
    [SELLQTY] INT NULL,
    [SELLRATE] INT NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] TINYINT NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [SHORT_NAME] VARCHAR(21) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [MOBILE_PAGER] VARCHAR(40) NULL,
    [RES_PHONE1] VARCHAR(15) NULL,
    [RES_PHONE2] VARCHAR(15) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLDKM_SS_CLMST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLDKM_SS_CLMST]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [Short_name] VARCHAR(21) NOT NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [L_ADDRESS1] VARCHAR(10) NOT NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [MOBILE_PAGER] VARCHAR(40) NULL,
    [RES_PHONE1] VARCHAR(15) NULL,
    [RES_PHONE2] VARCHAR(15) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblGlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblGlobalParams]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblGrossExp
-- --------------------------------------------------
CREATE TABLE [dbo].[TblGrossExp]
(
    [sett_type] VARCHAR(3) NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [sauda_date] DATETIME NULL,
    [branch_id] VARCHAR(15) NULL,
    [buyval] MONEY NULL,
    [Sellval] MONEY NULL,
    [scrip_Cd] VARCHAR(12) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [series] CHAR(3) NOT NULL,
    [trade_no] VARCHAR(25) NOT NULL,
    [rate] DECIMAL(18, 2) NOT NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblGrossExpNew
-- --------------------------------------------------
CREATE TABLE [dbo].[TblGrossExpNew]
(
    [scrip_cd] VARCHAR(10) NOT NULL,
    [buyvalue] MONEY NOT NULL,
    [sellvalue] MONEY NOT NULL,
    [branch_id] VARCHAR(15) NULL,
    [series] CHAR(3) NOT NULL,
    [fromsettno] VARCHAR(7) NULL,
    [tosettno] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [saudadate] SMALLDATETIME NULL,
    [varmargin] MONEY NULL,
    [grossexp] MONEY NULL,
    [Rate] DECIMAL(18, 2) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblGrossExpNewDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[TblGrossExpNewDetail]
(
    [scrip_cd] VARCHAR(10) NOT NULL,
    [buyvalue] MONEY NOT NULL,
    [sellvalue] MONEY NOT NULL,
    [branch_id] VARCHAR(15) NULL,
    [series] CHAR(3) NOT NULL,
    [fromsettno] VARCHAR(7) NULL,
    [tosettno] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [saudadate] SMALLDATETIME NULL,
    [varmargin] MONEY NULL,
    [grossexp] MONEY NULL,
    [Rate] DECIMAL(18, 2) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [RunDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblmenuhead
-- --------------------------------------------------
CREATE TABLE [dbo].[tblmenuhead]
(
    [fldmenucode] VARCHAR(20) NULL,
    [fldmenuname] VARCHAR(40) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblmtomdetail
-- --------------------------------------------------
CREATE TABLE [dbo].[tblmtomdetail]
(
    [party_code] VARCHAR(10) NULL,
    [short_name] VARCHAR(30) NULL,
    [netamt] MONEY NULL,
    [clsamt] MONEY NULL,
    [clsdiff] MONEY NULL,
    [grossamt] MONEY NULL,
    [LedgerAmt] MONEY NULL,
    [Turnover] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblpradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblpradnyausers]
(
    [fldauto] INT NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(15) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(40) NULL,
    [fldaddress2] VARCHAR(40) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLQLSEBIREPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLQLSEBIREPORT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CL_CODE] VARCHAR(15) NULL,
    [Funds_Sec] VARCHAR(1) NULL,
    [Bills] VARCHAR(1) NULL,
    [Ledger] VARCHAR(1) NULL,
    [Holding] VARCHAR(1) NULL,
    [STATEMENTDATE] DATETIME NULL,
    [PROCESS_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreportgrp]
(
    [fldreportgrp] INT NOT NULL,
    [fldgrpname] VARCHAR(35) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreports
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreports]
(
    [fldreportcode] INT NOT NULL,
    [fldreportname] VARCHAR(50) NULL,
    [fldpath] VARCHAR(100) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblsysusers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblsysusers]
(
    [fldauto] INT NOT NULL,
    [fldusername] NVARCHAR(25) NULL,
    [fldpassword] NVARCHAR(15) NULL,
    [fldfirstname] NVARCHAR(25) NULL,
    [fldmiddlename] NVARCHAR(25) NULL,
    [fldlastname] NVARCHAR(25) NULL,
    [fldsex] NVARCHAR(8) NULL,
    [fldaddress1] NVARCHAR(40) NULL,
    [fldaddress2] NVARCHAR(40) NULL,
    [fldphone1] NVARCHAR(10) NULL,
    [fldphone2] NVARCHAR(10) NULL,
    [fldcategory] NVARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbltrader
-- --------------------------------------------------
CREATE TABLE [dbo].[tbltrader]
(
    [fldauto] INT NULL,
    [fldusername] NVARCHAR(25) NULL,
    [fldpassword] NVARCHAR(15) NULL,
    [fldvpassword] NVARCHAR(15) NULL,
    [fldfirstname] NVARCHAR(25) NULL,
    [fldmiddlename] NVARCHAR(25) NULL,
    [fldlastname] NVARCHAR(25) NULL,
    [fldsex] NVARCHAR(8) NULL,
    [fldcategory] NVARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Telangana
-- --------------------------------------------------
CREATE TABLE [dbo].[Telangana]
(
    [Pincode] VARCHAR(20) NULL,
    [State] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_B2C
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_B2C]
(
    [B2C_SB] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_dharmesh
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_dharmesh]
(
    [party_code] VARCHAR(10) NULL,
    [segment] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [Cqty] INT NULL,
    [Dqty] INT NULL,
    [rmqty] FLOAT NULL,
    [ctype] VARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Test_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[Test_Table]
(
    [PartyCode] VARCHAR(50) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ScrpCode] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [DpId] VARCHAR(50) NULL,
    [CltCode] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [HoldQty] VARCHAR(50) NULL,
    [PledgeQty] VARCHAR(50) NULL,
    [Qty] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TM_QL_SSRS
-- --------------------------------------------------
CREATE TABLE [dbo].[TM_QL_SSRS]
(
    [CLIENTCODE] VARCHAR(10) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [ECN_FLAG] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_Data]
(
    [party_Code] VARCHAR(50) NULL,
    [Sccs_Settdate_last] DATETIME NULL,
    [flag] VARCHAR(1) NOT NULL,
    [last_inactive_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_QL
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_QL]
(
    [CLIENTCODE] VARCHAR(10) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [ECN_FLAG] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_QL_2809
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_QL_2809]
(
    [CLIENTCODE] VARCHAR(10) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [ECN_FLAG] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trace070108
-- --------------------------------------------------
CREATE TABLE [dbo].[trace070108]
(
    [RowNumber] INT IDENTITY(0,1) NOT NULL,
    [EventClass] INT NULL,
    [ApplicationName] NVARCHAR(128) NULL,
    [NTUserName] NVARCHAR(128) NULL,
    [LoginName] NVARCHAR(128) NULL,
    [CPU] INT NULL,
    [Reads] BIGINT NULL,
    [Writes] BIGINT NULL,
    [Duration] BIGINT NULL,
    [ClientProcessID] INT NULL,
    [SPID] INT NULL,
    [StartTime] DATETIME NULL,
    [EndTime] DATETIME NULL,
    [TextData] NTEXT NULL,
    [BinaryData] IMAGE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UK1MULTICOMPANY
-- --------------------------------------------------
CREATE TABLE [dbo].[UK1MULTICOMPANY]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(10) NULL,
    [dbpassword] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UKMULTICOMPANY
-- --------------------------------------------------
CREATE TABLE [dbo].[UKMULTICOMPANY]
(
    [BrokerId] VARCHAR(6) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [MemberType] VARCHAR(3) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [ShareDb] VARCHAR(20) NULL,
    [ShareServer] VARCHAR(15) NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NULL,
    [AccountServer] VARCHAR(15) NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NULL,
    [DefaultDbServer] VARCHAR(20) NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [PrimaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_POOLTRANSACTIONS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_POOLTRANSACTIONS]
(
    [EXCHANGE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [SEC_PAYIN] VARCHAR(11) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIPNAME] VARCHAR(100) NULL,
    [SERIES] VARCHAR(3) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(20) NULL,
    [CLTDPID] VARCHAR(20) NULL,
    [PURQTY] INT NULL,
    [EXEDATE] VARCHAR(11) NULL,
    [SELLQTY] INT NULL,
    [RECDATE] VARCHAR(100) NULL,
    [RPTDATE] VARCHAR(20) NULL,
    [TRANSDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_01112017
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_01112017]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_04oct2022]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_09nov2022
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_09nov2022]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_28032018_BAK
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_28032018_BAK]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q1_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q1_0809]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q2_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q2_0809]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q3_0708
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q3_0708]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q3_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q3_0809]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q4_0708
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q4_0708]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYLEDGER_Q4_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYLEDGER_Q4_0809]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_01112017
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_01112017]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_04oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_04oct2022]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_10oct2022
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_10oct2022]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_BAK_09082017
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_BAK_09082017]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(15) NULL,
    [QL_QTY] VARCHAR(10) NULL,
    [BO_HOLD] VARCHAR(10) NULL,
    [MISMATCH] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYsecLEDGER_JFM10
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYsecLEDGER_JFM10]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_JFM10_Fin
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_JFM10_Fin]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q1_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q1_0809]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q2_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q2_0809]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q3_0708
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q3_0708]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q3_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q3_0809]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_q30708
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_q30708]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q4_0708
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q4_0708]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_QUARTERLYSECLEDGER_Q4_0809
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_QUARTERLYSECLEDGER_Q4_0809]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_YEARLYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_YEARLYLEDGER]
(
    [CQL_ID] BIGINT IDENTITY(1,1) NOT NULL,
    [CQL_SEGMENT] VARCHAR(20) NULL,
    [CQL_PARTYCODE] VARCHAR(10) NULL,
    [CQL_VDT] VARCHAR(20) NULL,
    [CQL_VTYPE] VARCHAR(10) NULL,
    [CQL_VNO] VARCHAR(20) NULL,
    [CQL_ACCODE] VARCHAR(10) NULL,
    [CQL_REMARKS] VARCHAR(255) NULL,
    [CQL_DDNO] VARCHAR(20) NULL,
    [CQL_DEBIT] MONEY NULL,
    [CQL_CREDIT] MONEY NULL,
    [CQL_BALANCE] MONEY NULL,
    [CQL_ORDERBY] TINYINT NULL,
    [CQL_DT] INT NULL,
    [CQL_ACNAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLASS_YEARLYSECLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLASS_YEARLYSECLEDGER]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Hold_QUARTERLYSECLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Hold_QUARTERLYSECLEDGER]
(
    [SEGMENT] VARCHAR(5) NULL,
    [TRANSDATE] VARCHAR(10) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(20) NULL,
    [SCRIP_NAME] VARCHAR(255) NULL,
    [CERTNO] VARCHAR(20) NULL,
    [CQTY] INT NULL,
    [DQTY] INT NULL,
    [SLIPNO] VARCHAR(20) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [TRTYPE] VARCHAR(6) NULL,
    [REASON] VARCHAR(255) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [TRANSDATEDT] DATETIME NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.acc_multicompany
-- --------------------------------------------------

create view acc_multicompany  
as  
select *from pradnya.dbo.multicompany

GO

-- --------------------------------------------------
-- VIEW dbo.acc_multicompany_MFSS
-- --------------------------------------------------


CREATE view [dbo].[acc_multicompany_MFSS]  
as  
select *from pradnya.dbo.MULTICOMPANY_MFSS

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_OWNER_VW
-- --------------------------------------------------


    
CREATE VIEW [dbo].[CLS_OWNER_VW] AS   
--SELECT 'NSE' AS EXCHANGE ,'CAPITAL' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,PANNO,COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM MSAJAG.DBO.OWNER   
--UNION ALL   
SELECT 'BSE' AS EXCHANGE ,'CAPITAL' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,PANNO,COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM BSEDB_ab.DBO.OWNER   
--UNION ALL   
--SELECT 'BSE' AS EXCHANGE ,'CAPITAL' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL='',WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,PANNO,COMPLIANCE_NAME='',COMPLIANCE_EMAIL='',COMPLIANCE_PHONE='',COMMONSEBINO='',COMMONMEMBERCODE='' FROM BSEDB.DBO.OWNER   
--UNION ALL   
--SELECT 'NSE' AS EXCHANGE ,'FUTURES' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,PANNO,COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM NSEFO.DBO.FOOWNER   
--UNION ALL   
--SELECT 'BSE' AS EXCHANGE ,'FUTURES' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,'',COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM BSEFO.DBO.bfoowner   --select *from  CLS_OWNER_VW       
--UNION ALL 
--SELECT 'NCX' AS EXCHANGE ,'FUTURES' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,'',COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM NCDX.DBO.NCXowner   --select *from  CLS_  
--UNION ALL   
--SELECT 'MCX' AS EXCHANGE ,'FUTURES' AS SEGMENT,COMPANY, ADDR1, ADDR2, ADDR3='', CITY, STATE,COUNTRY = '',ZIP,PHONE,FAX='',EMAIL,WEBSITE_ID='',MEMBERCODE,BROKERSEBIREGNO,'',COMPLIANCE_NAME,COMPLIANCE_EMAIL,COMPLIANCE_PHONE,COMMONSEBINO='',COMMONMEMBERCODE='' FROM NCDX.DBO.NCXowner   --select *from  CLS_  
  
--OWNER_VW

GO

-- --------------------------------------------------
-- VIEW dbo.Fragmentaion_details
-- --------------------------------------------------
create view Fragmentaion_details
as 

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0

GO

-- --------------------------------------------------
-- VIEW dbo.MinBrok
-- --------------------------------------------------
Create view MinBrok
as
/* Created by Dharmesh Mistry on 09/03/2011 */
Select Party_code,Sum(Diff_brokerage) as Brokerage from intranet.risk.dbo.tbl_minbrok
Group by Party_code

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_A
-- --------------------------------------------------

CREATE VIEW [dbo].[SCCSANNEXURE_A]                
AS                
select a.PARTY_CODE,(UNENCUMBERED_BAL)UNENCUMBERED_BAL, UNENCUMBERED_MARGIN, VALUE_SECURITIESTDAY,      
case when (FUNDS_RETAINED)>0 then (FUNDS_RETAINED) else 0 end as FUNDS_RETAINED,      
VALUE_SECURITIESRETAINED,FUNDS_RELEASED,SECURITIES_RELEASED,OTHERSEGMENTDEBIT,      
UPDATEDON from      
(      
SELECT a.PARTY_CODE,(sum(Balance+UnsettledCrBill+ UnrecoAmt+ ShortSellValue))*-1 UNENCUMBERED_BAL,sum(Balance+UnsettledCrBill) UNENCUMBERED_MARGIN,sum(NonCashColl) VALUE_SECURITIESTDAY,                      
      
 FUNDS_RETAINED = case when(sum(Balance+ UnrecoAmt+ ShortSellValue+UnsettledCrBill-NetPayable)>=0) then sum(Balance+ UnrecoAmt+ ShortSellValue+UnsettledCrBill-NetPayable) else 0 end,      
                     
sum(NonCashColl) VALUE_SECURITIESRETAINED,                
      
FUNDS_RELEASED = sum(NetPayable),                
      
SECURITIES_RELEASED='0.00',OTHERSEGMENTDEBIT=sum(OtherDebit)*-1,Convert(Datetime,Convert(varchar,ProcessDate,101),101) UPDATEDON                      
      
 FROM sebipayout.SEBI.dbo.vw_sebi_sEgveridata_hist a WITH (NOLOCK)       
 group by a.PARTY_CODE,Convert(varchar,ProcessDate,101)      
 ) a        
 group by a.PARTY_CODE,UNENCUMBERED_BAL,UNENCUMBERED_MARGIN,VALUE_SECURITIESTDAY,FUNDS_RETAINED,VALUE_SECURITIESRETAINED,FUNDS_RELEASED,SECURITIES_RELEASED,OTHERSEGMENTDEBIT,      
UPDATEDON

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_A_07oct2022
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_A_07oct2022]            
AS            
SELECT PARTY_CODE,UNENCUMBERED_BAL,UNENCUMBERED_MARGIN,VALUE_SECURITIESTDAY,            
 FUNDS_RETAINED = CASE WHEN UNENCUMBERED_BAL < 0 AND UNENCUMBERED_BAL > -1000 THEN UNENCUMBERED_BAL* -1       
  WHEN UNENCUMBERED_BAL <0 THEN       
   CASE WHEN FUNDS_RELEASED < 500 THEN (UNENCUMBERED_BAL)*-1 ELSE (UNENCUMBERED_BAL + FUNDS_RELEASED)*-1 END            
ELSE 0 END,            
VALUE_SECURITIESRETAINED,      
FUNDS_RELEASED = CASE WHEN FUNDS_RELEASED < 500 THEN 0 ELSE FUNDS_RELEASED END,      
SECURITIES_RELEASED,OTHERSEGMENTDEBIT,UPDATEDON            
 FROM MIS.SCCS.DBO.SCCS_SUMMARY_RETAIN_RELEASE_HIST WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_B
-- --------------------------------------------------
CREATE VIEW [dbo].[SCCSANNEXURE_B]                        
AS                        
SELECT a.PARTY_CODE,UNENCUMBERED_DEBITBAL = 0.00,                              
            
TDAY_FUNDSPAYIN_BSECM=sum(case when(Segment='BSECM') then (UnsettledDrBill) else '0.00' end),T_1DAY_FUNDSPAYIN_BSECM=0.00,TDAY_SECURITIESPAYIN_BSECM=0.00,T_1DAY_SECURITESPAYIN_BSECM=0.00,TDAY_TURNOVER_BSECM=0.00,                              
            
TDAY_FUNDSPAYIN_NSECM=sum(case when(Segment='NSECM') then (UnsettledDrBill) else '0.00' end),T_1DAY_FUNDSPAYIN_NSECM=0.00,TDAY_SECURITIESPAYIN_NSECM=0.00,T_1DAY_SECURITESPAYIN_NSECM=0.00,TDAY_TURNOVER_NSECM=0.00,                              
            
TDAY_FUNDSPAYIN_NSEFO=sum(case when(Segment='NSEFO') then (UnsettledDrBill) else '0.00' end),TDAY_MARGIN_NSEFO=sum(case when(Segment='NSEFO') then (MarginAmt*-1) else '0.00' end) ,
TDAY_FUNDSPAYIN_NSX=sum(case when(Segment='NSX') then (UnsettledDrBill) else '0.00' end),TDAY_MARGIN_NSX=sum(case when(Segment='NSX') then (MarginAmt*-1) else '0.00' end),                              
            
TDAY_FUNDSPAYIN_MCD=sum(case when(Segment='MCD') then (UnsettledDrBill) else '0.00' end),TDAY_MARGIN_MCD= sum(case when(Segment='MCD') then (MarginAmt*-1) else '0.00' end),OTHERSEGMENTDEBIT=sum(OtherDebit)*-1,ACCRUALAMT = sum(AccruedCharges)*-1,            
UPDATEDON=Convert(datetime,Convert(varchar,a.ProcessDate,101),101)  ,            
--new columns added for commodities annexure 19 mar 2019,vinod            
Tday_FundsPayin_MCX=sum(case when(Segment='MCX') then (UnsettledDrBill) else '0.00' end), Tday_FundsPayin_NCDX=sum(case when(Segment='NCDEX') then (UnsettledDrBill) else '0.00' end) ,Tday_Margin_MCX=sum(case when(Segment='MCX') then (MarginAmt*-1) else '0.00' end), 
Tday_Margin_NCDX=sum(case when(Segment='NCDEX') then (MarginAmt*-1) else '0.00' end) ,            
Tday_Margin_BSECM=sum(case when(Segment='BSECM') then (MarginAmt*-1) else '0.00' end),Tday_Margin_NSECM=sum(case when(Segment='NSECM') then (MarginAmt*-1) else '0.00' end),            
Tday_Margin_BSX =sum(case when(Segment='BSX') then (MarginAmt*-1) else '0.00' end)                        
            
 FROM sebipayout.SEBI.dbo.vw_sebi_sEgveridata_hist a WITH (NOLOCK)             
 left outer join             
 (SELECT PARTY_CODE,BLOCKAMT=Amount,Processdate FROM MIS.SCCS.DBO.Sccs_MFPendingOrders with (nolock) where Convert(varchar(11),Processdate,103)        
 =Convert(varchar(11),getdate(),103)) b on a.PARTY_CODE=b.PARTY_CODE and b.Processdate=Convert(varchar,a.ProcessDate,101)            
 group by a.PARTY_CODE,Convert(varchar,a.ProcessDate,101)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_B_07oct2022
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_B_07oct2022]                
AS                
SELECT PARTY_CODE,UNENCUMBERED_DEBITBAL = 0.00,                
TDAY_FUNDSPAYIN_BSECM,T_1DAY_FUNDSPAYIN_BSECM,TDAY_SECURITIESPAYIN_BSECM,T_1DAY_SECURITESPAYIN_BSECM,TDAY_TURNOVER_BSECM,                
TDAY_FUNDSPAYIN_NSECM,T_1DAY_FUNDSPAYIN_NSECM,TDAY_SECURITIESPAYIN_NSECM,T_1DAY_SECURITESPAYIN_NSECM,TDAY_TURNOVER_NSECM,                
TDAY_FUNDSPAYIN_NSEFO,TDAY_MARGIN_NSEFO,TDAY_FUNDSPAYIN_NSX,TDAY_MARGIN_NSX,                
TDAY_FUNDSPAYIN_MCD,TDAY_MARGIN_MCD,OTHERSEGMENTDEBIT,ACCRUALAMT = ACCRUALAMT+1000,UPDATEDON                
 FROM MIS.SCCS.DBO.SCCS_SUMMARY_RETAIN_RELEASE_HIST WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_B_08jan2024
-- --------------------------------------------------
CREATE VIEW [dbo].[SCCSANNEXURE_B_08jan2024]                      
AS                      
SELECT a.PARTY_CODE,UNENCUMBERED_DEBITBAL = 0.00,                            
          
TDAY_FUNDSPAYIN_BSECM=0.00,T_1DAY_FUNDSPAYIN_BSECM=0.00,TDAY_SECURITIESPAYIN_BSECM=0.00,T_1DAY_SECURITESPAYIN_BSECM=0.00,TDAY_TURNOVER_BSECM=0.00,                            
          
TDAY_FUNDSPAYIN_NSECM=0.00,T_1DAY_FUNDSPAYIN_NSECM=0.00,TDAY_SECURITIESPAYIN_NSECM=0.00,T_1DAY_SECURITESPAYIN_NSECM=0.00,TDAY_TURNOVER_NSECM=0.00,                            
          
TDAY_FUNDSPAYIN_NSEFO=0.00,TDAY_MARGIN_NSEFO=sum(case when(Segment='NSEFO') then (MarginAmt*-1) else '0.00' end) ,TDAY_FUNDSPAYIN_NSX=0.00,          
TDAY_MARGIN_NSX=sum(case when(Segment='NSX') then (MarginAmt*-1) else '0.00' end),                            
          
TDAY_FUNDSPAYIN_MCD=0.00,TDAY_MARGIN_MCD= sum(case when(Segment='MCD') then (MarginAmt*-1) else '0.00' end),OTHERSEGMENTDEBIT=sum(OtherDebit)*-1,ACCRUALAMT = sum(AccruedCharges)*-1,          
UPDATEDON=Convert(datetime,Convert(varchar,a.ProcessDate,101),101)  ,          
--new columns added for commodities annexure 19 mar 2019,vinod          
Tday_FundsPayin_MCX=0.00, Tday_FundsPayin_NCDX=0.00 ,Tday_Margin_MCX=sum(case when(Segment='MCX') then (MarginAmt*-1) else '0.00' end), Tday_Margin_NCDX=sum(case when(Segment='NCDEX') then (MarginAmt*-1) else '0.00' end) ,          
Tday_Margin_BSECM=sum(case when(Segment='BSECM') then (MarginAmt*-1) else '0.00' end),Tday_Margin_NSECM=sum(case when(Segment='NSECM') then (MarginAmt*-1) else '0.00' end),          
Tday_Margin_BSX =sum(case when(Segment='BSX') then (MarginAmt*-1) else '0.00' end)                      
          
 FROM sebipayout.SEBI.dbo.vw_sebi_sEgveridata_hist a WITH (NOLOCK)           
 left outer join           
 (SELECT PARTY_CODE,BLOCKAMT=Amount,Processdate FROM MIS.SCCS.DBO.Sccs_MFPendingOrders with (nolock) where Convert(varchar(11),Processdate,103)      
 =Convert(varchar(11),getdate(),103)) b on a.PARTY_CODE=b.PARTY_CODE and b.Processdate=Convert(varchar,a.ProcessDate,101)          
 group by a.PARTY_CODE,Convert(varchar,a.ProcessDate,101)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_C
-- --------------------------------------------------

CREATE VIEW [dbo].[SCCSANNEXURE_C]                    
AS                    
SELECT PARTY_CODE,SCRIP_NAME,ISIN,QUANTITY = SUM(QUANTITY),CL_Rate CLOSING_RATE,HAIRCUT,VALUE = SUM(FinalAmount),SEGMENT,ProcessDate UPDATEDON               
FROM sebipayout.Sebi.dbo.SEBI_ScripData WITH (NOLOCK)     
 GROUP BY PARTY_CODE,SCRIP_NAME,ISIN,CL_Rate,HAIRCUT,SEGMENT,ProcessDate

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_C_07oct2022
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_C_07oct2022]                  
AS                  
SELECT PARTY_CODE,SCRIP_NAME,ISIN,QUANTITY = SUM(QUANTITY),CLOSING_RATE,HAIRCUT,VALUE = SUM(VALUE),SEGMENT = ISNULL(COLLATERAL,SEGMENT),UPDATEDON           
FROM MIS.SCCS.DBO.SCCS_SHAREDETAILS_HIST WITH (NOLOCK)  
  WHERE FLAG IN ('B','I')                   
 GROUP BY PARTY_CODE,SCRIP_NAME,ISIN,CLOSING_RATE,HAIRCUT,SEGMENT,COLLATERAL,UPDATEDON

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_D
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_D]          
AS          
SELECT PARTY_CODE,SCRIP_NAME,ISIN,QUANTITY,CLOSING_RATE,HAIRCUT,VALUE,SEGMENT = ISNULL(COLLATERAL,SEGMENT),UPDATEDON     
FROM MIS.SCCS.DBO.SCCS_SHAREDETAILS_HIST WITH (NOLOCK)     
 WHERE FLAG ='R'

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_D_07oct2022
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_D_07oct2022]          
AS          
SELECT PARTY_CODE,SCRIP_NAME,ISIN,QUANTITY,CLOSING_RATE,HAIRCUT,VALUE,SEGMENT = ISNULL(COLLATERAL,SEGMENT),UPDATEDON   
FROM MIS.SCCS.DBO.SCCS_SHAREDETAILS_HIST WITH (NOLOCK)   
 WHERE FLAG ='R'

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_E
-- --------------------------------------------------

CREATE VIEW [dbo].[SCCSANNEXURE_E]        
AS        
SELECT PARTY_CODE,SEGMENT,COLL_TYPE='FD',BANK_CODE='',FD_BGNO='',MATURITY_DATE='', FINALAMOUNT=CashColl, UPDATEDON =Processdate          
FROM sebipayout.Sebi.dbo.vw_sebi_sEgveridata_hist WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCSANNEXURE_E_07oct2022
-- --------------------------------------------------
CREATE VIEW [DBO].[SCCSANNEXURE_E_07oct2022]    
AS    
SELECT PARTY_CODE,SEGMENT,COLL_TYPE,BANK_CODE,FD_BGNO,MATURITY_DATE,FINALAMOUNT,UPDATEDON     
FROM MIS.SCCS.DBO.SCCS_FDBG_HIST WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_Data
-- --------------------------------------------------
CREATE VIEW VW_SCCS_DATA  
AS        
SELECT  DISTINCT SD.*,[SECURITY_HOLDING] = ISNULL([SECURITY_HOLDING],0),[SHARES_PAYOUT_VALUE] = ISNULL([SHARES_PAYOUT_VALUE],0)   
FROM    
(    
SELECT DISTINCT      
[SCCS_DATE] = UPDATE_DATE,        
[PARTY_CODE] = PARTY_CODE,        
[BSECM_LEDGER] = BSECM_LEDGER,        
[NSECM_LEDGER] = NSECM_LEDGER,        
[NSEFO_LEDGER] = NSEFO_LEDGER,        
[NSX_LEDGER] = NSX_LEDGER,        
[MCD_LEDGER] = MCD_LEDGER, 
[MCDX_LEDGER]=MCDX_LEDGER,
[NCDX_LEDGER]=NCDX_LEDGER,       
[BSECM_DEPOSIT] = BSECM_DEPOSIT,        
[NSECM_DEPOSIT] = NSECM_DEPOSIT,        
[NSEFO_DEPOSIT] = NSEFO_DEPOSIT,        
[NSX_DEPOSIT] = NSX_DEPOSIT,        
[MCD_DEPOSIT] = MCD_DEPOSIT,   
[MCDX_DEPOSIT]=MCDX_DEPOSIT,
[NCDX_DEPOSIT]=NCDX_DEPOSIT,      
[OTHER_SEGMENT] = 0,---NCDX_LEDGER + MCDX_LEDGER ,--+ MCDX_DEPOSIT + NCDX_DEPOSIT,        
[BSECM_COLLATERAL] = 0,      
[NSECM_COLLATERAL] = 0,      
[NSEFO_COLLATERAL] = NSEFO_CASHCOLL,        
[NSX_COLLATERAL] = NSX_COLL,        
[MCD_COLLATERAL] = MCD_COLL, 
[MCDX_COLLATERAL] = ISNULL(MCDX_COLL,0), 
[NCDX_COLLATERAL] = ISNULL(NCDX_COLL,0),       
[ACCRUAL] = ACCRUALAMT + 1000.00,        
[BSECM_UNRECO] = BSECM_UNRECOVAL,        
[NSECM_UNRECO] = NSECM_UNRECOVAL,        
[NSEFO_UNRECO] = NSEFO_UNRECOVAL,        
[NSX_UNRECO] = NSX_UNRECOVAL,        
[MCD_UNRECO] = MCD_UNRECOVAL,   
[MCDX_UNRECO]= 0,--ISNULL(MCDX_UNRECO,0),  
[NCDX_UNRECO]=0,--ISNULL(NCDX_UNRECO,0),     
[NSEFO_MARGIN] = NSEFO_MARGIN*1.75,       
[NSX_MARGIN] = NSX_MARGIN*1.75,        
[MCD_MARGIN] = MCD_MARGIN*1.75,   
[MCDX_MARGIN]=ISNULL(MCDX_MARGIN,0)*1.75,  
[NCDX_MARGIN]=ISNULL(NCDX_MARGIN,0)*1.75,      
[BSECM_UNSETTLE] = BSECM_USD + BSECM_VAR + BSECM_SHRTVAL,        
[NSECM_UNSETTLE] = NSECM_USD + NSECM_VAR + NSECM_SHRTVAL,        
[NSEFO_UNSETTLE] = NSEFO_USD,        
[NSX_UNSETTLE] = NSX_USD,        
[MCD_UNSETTLE] = MCD_USD,  
[MCDX_UNSETTLE] = MCDX_USD,
[NCDX_UNSETTLE] = NCDX_USD,     
[CASH_ADDITIONAL_MARGIN] = INTRA_HGHMRG_CASH,         
[NSEFO_ADDITIONAL_MARGIN] = INTRA_HGHMRG_FO,
[MCDX_ADDITIONAL_MARGIN] = INTRA_HGHMRG_MCDX,
[NCDX_ADDITIONAL_MARGIN] = INTRA_HGHMRG_NCDX      
FROM MIS.SCCS.DBO.SCCS_DATA_HIST SD WITH (NOLOCK)        
WHERE EXISTS         
(SELECT UPDATE_DATE,PARTY_CODE FROM MIS.SCCS.DBO.V_SCCSMAXPAYOUTDATE VD WITH (NOLOCK)         
WHERE         
SD.PARTY_CODE = VD.PARTY_CODE AND          
SD.UPDATE_DATE = VD.UPDATE_DATE        
))SD    
LEFT OUTER JOIN     
(SELECT  PARTY_CODE,UPDATE_DATE = UPDATE_DATE,[SECURITY_HOLDING] =  SUM(HLDVAL),--QTY = SUM(QTY),QTY_ALLOWED = SUM(QTY_ALLOWED),  
[SHARES_PAYOUT_VALUE] = SUM((HLDVAL/QTY)*QTY_ALLOWED)    
FROM MIS.SCCS.DBO.SCCS_SHAREPO_HIST WITH (NOLOCK)     
--WHERE HLDVAL <> 0 AND QTY = 0    
WHERE QTY <> 0 --AND CONVERT(VARCHAR(11),SD.UPDATE_DATE,103)=CONVERT(VARCHAR(11),UPDATE_DATE,103)      
GROUP BY PARTY_CODE,UPDATE_DATE    
)SP    
ON SP.PARTY_CODE=SD.[PARTY_CODE] AND CONVERT(VARCHAR(11),SD.[SCCS_DATE],103)= CONVERT(VARCHAR(11),SP.UPDATE_DATE,103)

GO

-- --------------------------------------------------
-- VIEW dbo.VW_SCCS_DATA_31Aug2021
-- --------------------------------------------------
CREATE VIEW VW_SCCS_DATA_31Aug2021  
AS        
SELECT  DISTINCT SD.*,[SECURITY_HOLDING] = ISNULL([SECURITY_HOLDING],0),[SHARES_PAYOUT_VALUE] = ISNULL([SHARES_PAYOUT_VALUE],0)   
FROM    
(    
SELECT DISTINCT      
[SCCS_DATE] = UPDATE_DATE,        
[PARTY_CODE] = PARTY_CODE,        
[BSECM_LEDGER] = BSECM_LEDGER,        
[NSECM_LEDGER] = NSECM_LEDGER,        
[NSEFO_LEDGER] = NSEFO_LEDGER,        
[NSX_LEDGER] = NSX_LEDGER,        
[MCD_LEDGER] = MCD_LEDGER, 
[MCDX_LEDGER]=MCDX_LEDGER,
[NCDX_LEDGER]=NCDX_LEDGER,       
[BSECM_DEPOSIT] = BSECM_DEPOSIT,        
[NSECM_DEPOSIT] = NSECM_DEPOSIT,        
[NSEFO_DEPOSIT] = NSEFO_DEPOSIT,        
[NSX_DEPOSIT] = NSX_DEPOSIT,        
[MCD_DEPOSIT] = MCD_DEPOSIT,   
[MCDX_DEPOSIT]=MCDX_DEPOSIT,
[NCDX_DEPOSIT]=NCDX_DEPOSIT,      
[OTHER_SEGMENT] = 0,---NCDX_LEDGER + MCDX_LEDGER ,--+ MCDX_DEPOSIT + NCDX_DEPOSIT,        
[BSECM_COLLATERAL] = 0,      
[NSECM_COLLATERAL] = 0,      
[NSEFO_COLLATERAL] = NSEFO_CASHCOLL,        
[NSX_COLLATERAL] = NSX_COLL,        
[MCD_COLLATERAL] = MCD_COLL, 
[MCDX_COLLATERAL] = ISNULL(MCDX_COLL,0), 
[NCDX_COLLATERAL] = ISNULL(NCDX_COLL,0),       
[ACCRUAL] = ACCRUALAMT + 1000.00,        
[BSECM_UNRECO] = BSECM_UNRECOVAL,        
[NSECM_UNRECO] = NSECM_UNRECOVAL,        
[NSEFO_UNRECO] = NSEFO_UNRECOVAL,        
[NSX_UNRECO] = NSX_UNRECOVAL,        
[MCD_UNRECO] = MCD_UNRECOVAL,   
[MCDX_UNRECO]= 0,--ISNULL(MCDX_UNRECO,0),  
[NCDX_UNRECO]=0,--ISNULL(NCDX_UNRECO,0),     
[NSEFO_MARGIN] = NSEFO_MARGIN*1.75,       
[NSX_MARGIN] = NSX_MARGIN*1.75,        
[MCD_MARGIN] = MCD_MARGIN*1.75,   
[MCDX_MARGIN]=ISNULL(MCDX_MARGIN,0)*1.75,  
[NCDX_MARGIN]=ISNULL(NCDX_MARGIN,0)*1.75,      
[BSECM_UNSETTLE] = BSECM_USD + BSECM_VAR + BSECM_SHRTVAL,        
[NSECM_UNSETTLE] = NSECM_USD + NSECM_VAR + NSECM_SHRTVAL,        
[NSEFO_UNSETTLE] = NSEFO_USD,        
[NSX_UNSETTLE] = NSX_USD,        
[MCD_UNSETTLE] = MCD_USD,  
[MCDX_UNSETTLE] = MCDX_USD,
[NCDX_UNSETTLE] = NCDX_USD,     
[CASH_ADDITIONAL_MARGIN] = INTRA_HGHMRG_CASH,         
[NSEFO_ADDITIONAL_MARGIN] = INTRA_HGHMRG_FO,
[MCDX_ADDITIONAL_MARGIN] = INTRA_HGHMRG_MCDX,
[NCDX_ADDITIONAL_MARGIN] = INTRA_HGHMRG_NCDX      
FROM MIS.SCCS.DBO.SCCS_DATA_HIST SD WITH (NOLOCK)        
WHERE EXISTS         
(SELECT UPDATE_DATE,PARTY_CODE FROM MIS.SCCS.DBO.V_SCCSMAXPAYOUTDATE VD WITH (NOLOCK)         
WHERE         
SD.PARTY_CODE = VD.PARTY_CODE AND          
SD.UPDATE_DATE = VD.UPDATE_DATE        
))SD    
LEFT OUTER JOIN     
(SELECT  PARTY_CODE,UPDATE_DATE = UPDATE_DATE,[SECURITY_HOLDING] =  SUM(HLDVAL),--QTY = SUM(QTY),QTY_ALLOWED = SUM(QTY_ALLOWED),  
[SHARES_PAYOUT_VALUE] = SUM((HLDVAL/QTY)*QTY_ALLOWED)    
FROM MIS.SCCS.DBO.SCCS_SHAREPO_HIST WITH (NOLOCK)     
--WHERE HLDVAL <> 0 AND QTY = 0    
WHERE QTY <> 0 --AND CONVERT(VARCHAR(11),SD.UPDATE_DATE,103)=CONVERT(VARCHAR(11),UPDATE_DATE,103)      
GROUP BY PARTY_CODE,UPDATE_DATE    
)SP    
ON SP.PARTY_CODE=SD.[PARTY_CODE] AND CONVERT(VARCHAR(11),SD.[SCCS_DATE],103)= CONVERT(VARCHAR(11),SP.UPDATE_DATE,103)

GO

-- --------------------------------------------------
-- VIEW dbo.VW_SCCS_DATA_ALL
-- --------------------------------------------------
CREATE VIEW VW_SCCS_DATA_ALL    
AS          
SELECT  DISTINCT SD.*,[SECURITY_HOLDING] = ISNULL([SECURITY_HOLDING],0),[SHARES_PAYOUT_VALUE] = ISNULL([SHARES_PAYOUT_VALUE],0)     
FROM      
(      
SELECT DISTINCT        
[SCCS_DATE] = UPDATE_DATE,          
[PARTY_CODE] = PARTY_CODE,          
[BSECM_LEDGER] = BSECM_LEDGER,          
[NSECM_LEDGER] = NSECM_LEDGER,          
[NSEFO_LEDGER] = NSEFO_LEDGER,          
[NSX_LEDGER] = NSX_LEDGER,          
[MCD_LEDGER] = MCD_LEDGER,          
[BSECM_DEPOSIT] = BSECM_DEPOSIT,          
[NSECM_DEPOSIT] = NSECM_DEPOSIT,          
[NSEFO_DEPOSIT] = NSEFO_DEPOSIT,          
[NSX_DEPOSIT] = NSX_DEPOSIT,          
[MCD_DEPOSIT] = MCD_DEPOSIT,           
[OTHER_SEGMENT] = NCDX_LEDGER + MCDX_LEDGER ,--+ MCDX_DEPOSIT + NCDX_DEPOSIT,          
[BSECM_COLLATERAL] = 0,        
[NSECM_COLLATERAL] = 0,        
[NSEFO_COLLATERAL] = NSEFO_CASHCOLL,          
[NSX_COLLATERAL] = NSX_COLL,          
[MCD_COLLATERAL] = MCD_COLL,          
[ACCRUAL] = ACCRUALAMT + 1000.00,          
[BSECM_UNRECO] = BSECM_UNRECOVAL,          
[NSECM_UNRECO] = NSECM_UNRECOVAL,          
[NSEFO_UNRECO] = NSEFO_UNRECOVAL,          
[NSX_UNRECO] = NSX_UNRECOVAL,          
[MCD_UNRECO] = MCD_UNRECOVAL,          
[NSEFO_MARGIN] = NSEFO_MARGIN*1.75,         
[NSX_MARGIN] = NSX_MARGIN*1.75,          
[MCD_MARGIN] = MCD_MARGIN*1.75,          
[BSECM_UNSETTLE] = BSECM_USD + BSECM_VAR + BSECM_SHRTVAL,          
[NSECM_UNSETTLE] = NSECM_USD + NSECM_VAR + NSECM_SHRTVAL,          
[NSEFO_UNSETTLE] = NSEFO_USD,          
[NSX_UNSETTLE] = NSX_USD,          
[MCD_UNSETTLE] = MCD_USD,          
[CASH_ADDITIONAL_MARGIN] = INTRA_HGHMRG_CASH,           
[NSEFO_ADDITIONAL_MARGIN] = INTRA_HGHMRG_FO          
FROM MIS.SCCS.DBO.SCCS_DATA_HIST SD WITH (NOLOCK)          
--WHERE 
--EXISTS           
--(SELECT UPDATE_DATE,PARTY_CODE FROM MIS.SCCS.DBO.V_SCCSMAXPAYOUTDATE VD WITH (NOLOCK)           
--WHERE           
--SD.PARTY_CODE = VD.PARTY_CODE AND            
--SD.UPDATE_DATE = VD.UPDATE_DATE          
--)
)SD      
LEFT OUTER JOIN       
(SELECT  PARTY_CODE,UPDATE_DATE = UPDATE_DATE,[SECURITY_HOLDING] =  SUM(HLDVAL),--QTY = SUM(QTY),QTY_ALLOWED = SUM(QTY_ALLOWED),    
[SHARES_PAYOUT_VALUE] = SUM((HLDVAL/QTY)*QTY_ALLOWED)      
FROM MIS.SCCS.DBO.SCCS_SHAREPO_HIST WITH (NOLOCK)       
--WHERE HLDVAL <> 0 AND QTY = 0      
WHERE QTY <> 0 --AND CONVERT(VARCHAR(11),SD.UPDATE_DATE,103)=CONVERT(VARCHAR(11),UPDATE_DATE,103)        
GROUP BY PARTY_CODE,UPDATE_DATE      
)SP      
ON SP.PARTY_CODE=SD.[PARTY_CODE] AND CONVERT(VARCHAR(11),SD.[SCCS_DATE],103)= CONVERT(VARCHAR(11),SP.UPDATE_DATE,103)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_Data_ORG
-- --------------------------------------------------


CREATE VIEW [dbo].[Vw_SCCS_Data_ORG]  
AS        
SELECT  DISTINCT SD.*,[SECURITY_HOLDING] = ISNULL([SECURITY_HOLDING],0),[SHARES_PAYOUT_VALUE] = ISNULL([SHARES_PAYOUT_VALUE],0)   
FROM    
(    
SELECT DISTINCT      
[SCCS_DATE] = UPDATE_DATE,        
[PARTY_CODE] = PARTY_CODE,        
[BSECM_LEDGER] = BSECM_LEDGER,        
[NSECM_LEDGER] = NSECM_LEDGER,        
[NSEFO_LEDGER] = NSEFO_LEDGER,        
[NSX_LEDGER] = NSX_LEDGER,        
[MCD_LEDGER] = MCD_LEDGER,        
[BSECM_DEPOSIT] = BSECM_DEPOSIT,        
[NSECM_DEPOSIT] = NSECM_DEPOSIT,        
[NSEFO_DEPOSIT] = NSEFO_DEPOSIT,        
[NSX_DEPOSIT] = NSX_DEPOSIT,        
[MCD_DEPOSIT] = MCD_DEPOSIT,         
[OTHER_SEGMENT] = NCDX_LEDGER + MCDX_LEDGER ,--+ MCDX_DEPOSIT + NCDX_DEPOSIT,        
[BSECM_COLLATERAL] = 0,      
[NSECM_COLLATERAL] = 0,      
[NSEFO_COLLATERAL] = NSEFO_CASHCOLL,        
[NSX_COLLATERAL] = NSX_COLL,        
[MCD_COLLATERAL] = MCD_COLL,        
[ACCRUAL] = ACCRUALAMT + 1000.00,        
[BSECM_UNRECO] = BSECM_UNRECOVAL,        
[NSECM_UNRECO] = NSECM_UNRECOVAL,        
[NSEFO_UNRECO] = NSEFO_UNRECOVAL,        
[NSX_UNRECO] = NSX_UNRECOVAL,        
[MCD_UNRECO] = MCD_UNRECOVAL,        
[NSEFO_MARGIN] = NSEFO_MARGIN*1.75,       
[NSX_MARGIN] = NSX_MARGIN*1.75,        
[MCD_MARGIN] = MCD_MARGIN*1.75,        
[BSECM_UNSETTLE] = BSECM_USD + BSECM_VAR + BSECM_SHRTVAL,        
[NSECM_UNSETTLE] = NSECM_USD + NSECM_VAR + NSECM_SHRTVAL,        
[NSEFO_UNSETTLE] = NSEFO_USD,        
[NSX_UNSETTLE] = NSX_USD,        
[MCD_UNSETTLE] = MCD_USD,        
[CASH_ADDITIONAL_MARGIN] = INTRA_HGHMRG_CASH,         
[NSEFO_ADDITIONAL_MARGIN] = INTRA_HGHMRG_FO        
FROM MIS.SCCS.DBO.SCCS_DATA_HIST SD WITH (NOLOCK)        
WHERE EXISTS         
(SELECT UPDATE_DATE,PARTY_CODE FROM MIS.SCCS.DBO.V_SCCSMAXPAYOUTDATE VD WITH (NOLOCK)         
WHERE         
SD.PARTY_CODE = VD.PARTY_CODE AND          
SD.UPDATE_DATE = VD.UPDATE_DATE        
))SD    
LEFT OUTER JOIN     
(SELECT  PARTY_CODE,UPDATE_DATE = UPDATE_DATE,[SECURITY_HOLDING] =  SUM(HLDVAL),--QTY = SUM(QTY),QTY_ALLOWED = SUM(QTY_ALLOWED),  
[SHARES_PAYOUT_VALUE] = SUM((HLDVAL/QTY)*QTY_ALLOWED)    
FROM MIS.SCCS.DBO.SCCS_SHAREPO_HIST WITH (NOLOCK)     
--WHERE HLDVAL <> 0 AND QTY = 0    
WHERE QTY <> 0 --AND CONVERT(VARCHAR(11),SD.UPDATE_DATE,103)=CONVERT(VARCHAR(11),UPDATE_DATE,103)      
GROUP BY PARTY_CODE,UPDATE_DATE    
)SP    
ON SP.PARTY_CODE=SD.[PARTY_CODE] AND CONVERT(VARCHAR(11),SD.[SCCS_DATE],103)= CONVERT(VARCHAR(11),SP.UPDATE_DATE,103)

GO

