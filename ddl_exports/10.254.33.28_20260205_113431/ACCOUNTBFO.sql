-- DDL Export
-- Server: 10.254.33.28
-- Database: ACCOUNTBFO
-- Exported: 2026-02-05T11:34:32.440633

USE ACCOUNTBFO;
GO

-- --------------------------------------------------
-- CHECK dbo.Acmast
-- --------------------------------------------------
ALTER TABLE [dbo].[Acmast] ADD CONSTRAINT [CHKCONSCLTCODE] CHECK (isnull([CLTCODE],'')<>'')

GO

-- --------------------------------------------------
-- FUNCTION dbo.F_TABLE_NUMBER_RANGE
-- --------------------------------------------------
create function dbo.F_TABLE_NUMBER_RANGE
(
	@START_NUMBER		int,
	@END_NUMBER		int
)
/*
This function returns an integer table containing all integers
in the range of@START_NUMBER through @END_NUMBER, inclusive.
The maximum number of rows that this function can return
is 16777216.
*/

returns table 
as

return
(
select	top 100 percent
	NUMBER = (a.NUMBER+b.NUMBER)+
	-- Add the starting number for the final result set
	-- The case is needed, because the start and end 
	-- numbers can be passed in any order
	case
	when @START_NUMBER <= @END_NUMBER
	then @START_NUMBER
	else @END_NUMBER
	end
from
	(
	Select	top 100 percent
		NUMBER = convert(int,N01+N02+N03)
	From
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) a
	cross join
	(
	Select	top 100 percent
		NUMBER = 
		convert(int,
		(N01+N02+N03) *
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
		)
	From 
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) b
where
	a.NUMBER+b.NUMBER < 
	-- Total number of rows
	abs(@START_NUMBER-@END_NUMBER)+1	and
	-- Check that the number of rows to be returned
	-- is less than or equal to the maximum of 16777216
	case
	when abs(@START_NUMBER-@END_NUMBER)+1 <= 16777216
	then 1
	else 0
	end = 1
order by
	1
)

GO

-- --------------------------------------------------
-- FUNCTION dbo.GET_DPC_CLIENTS
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GET_DPC_CLIENTS]
(
	@FR_PARTY_CODE VARCHAR(10),
	@TO_PARTY_CODE VARCHAR(10),
	@REPORTDATE VARCHAR(11)
)
RETURNS @DPC_CLIENTS TABLE
(
	PARTY_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(100),
	BRANCH_CD VARCHAR(20), 
	SUB_BROKER VARCHAR(25), 
	TRADER VARCHAR(25),
	AREA VARCHAR(25),
	REGION VARCHAR(25),
	CL_TYPE VARCHAR(10),
	CREDIT_INT MONEY, 
	DEBIT_INT MONEY, 
	FROMDATE DATETIME, 
	TODATE DATETIME, 
	EXEMPT_NOOFDAYS TINYINT, 
	EXEMPT_NOOFDAYS_CR TINYINT, 
	MIN_INTEREST MONEY, 
	MIN_BALANCE MONEY
)
AS
BEGIN	

DECLARE @V2_CLIENTPROFILES_NEW table 
( 
	PARTY_CODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	ACCOUNT_LEVEL VARCHAR(15),
	ACCOUNT_CODE VARCHAR(10),
	CREDIT_INT MONEY,
	DEBIT_INT MONEY,
	FROMDATE SMALLDATETIME,
	TODATE SMALLDATETIME,
	EXEMPT_NOOFDAYS INT,
	EXEMPT_NOOFDAYS_CR INT,
	MIN_INTEREST MONEY,
	MIN_BALANCE MONEY
)


	INSERT INTO @V2_CLIENTPROFILES_NEW
	SELECT V2.PARTY_CODE, LONG_NAME, ACCOUNT_LEVEL, ACCOUNT_CODE, CREDIT_INT, DEBIT_INT, FROMDATE, TODATE, EXEMPT_NOOFDAYS, EXEMPT_NOOFDAYS_CR, MIN_INTEREST, MIN_BALANCE 
	FROM V2_CLIENTPROFILES_NEW C,
	(
		SELECT PARTY_CODE, LONG_NAME = LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE, LEVEL_FLAG = MAX(LEVEL_FLAG) FROM MSAJAG.DBO.CLIENT_DETAILS C
		, V2_CLIENTPROFILES_NEW V2
		WHERE ((AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END
		OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END
		OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
		OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
		OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END
		OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END
		OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)
		GROUP BY PARTY_CODE, LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE
	) V2
	WHERE 
		(AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END
		OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END
		OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
		OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
		OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END
		OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END
		OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) 
		AND @REPORTDATE BETWEEN FROMDATE AND TODATE AND V2.LEVEL_FLAG = C.LEVEL_FLAG
		

	INSERT INTO @DPC_CLIENTS
	SELECT 
		C.PARTY_CODE, C.LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, AREA, REGION, CL_TYPE,
		CREDIT_INT = ISNULL(V2.CREDIT_INT, V.CREDIT_INT), 
		DEBIT_INT = ISNULL(V2.DEBIT_INT, V.DEBIT_INT), 
		FROMDATE = ISNULL(V2.FROMDATE, V.FROMDATE), 
		TODATE = ISNULL(V2.TODATE, V.TODATE), 
		EXEMPT_NOOFDAYS = ISNULL(V2.EXEMPT_NOOFDAYS, V.EXEMPT_NOOFDAYS), 
		EXEMPT_NOOFDAYS_CR = ISNULL(V2.EXEMPT_NOOFDAYS_CR, V.EXEMPT_NOOFDAYS_CR), 
		MIN_INTEREST = ISNULL(V2.MIN_INTEREST, V.MIN_INTEREST), 
		MIN_BALANCE = ISNULL(V2.MIN_BALANCE, V.MIN_BALANCE)
	FROM MSAJAG.DBO.CLIENT_DETAILS C
	LEFT OUTER JOIN @V2_CLIENTPROFILES_NEW V2
	ON C.PARTY_CODE = V2.PARTY_CODE
	,(SELECT * FROM V2_CLIENTPROFILES_NEW WHERE ACCOUNT_LEVEL = 'ALL') V
	/*ON ((BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
	OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
	OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)*/
	WHERE C.PARTY_CODE >= @FR_PARTY_CODE AND C.PARTY_CODE <= @TO_PARTY_CODE


	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetGrouplevels
-- --------------------------------------------------


CREATE  Function GetGrouplevels(@Group_code varchar(20)) returns integer
as
begin
	declare @@Group_code VARCHAR(20),
	@@lastGroup_code VARCHAR(20),
	@@Level int

	Set @@Group_code = @Group_code 
	Set @@lastGroup_code = @Group_code 

	Set @@Level = 1
	While ltrim(rtrim(@@Group_code))  <> ''
	begin

		select @@Group_code = Main_group from PLgroup_mstr 
		where Group_Code = @@lastGroup_code and group_code <> Main_group
		if ltrim(rtrim(@@Group_code)) <> ''
		begin
			Set @@Level = @@Level + 1
		end
		set @@lastGroup_code = @@Group_code
	end


	return @@Level
	

end

GO

-- --------------------------------------------------
-- INDEX dbo.Acmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_cltcode] ON [dbo].[Acmast] ([Cltcode], [Grpcode], [Branchcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_vdt] ON [dbo].[Ledger] ([Vdt], [Vtyp], [Vno], [Cltcode], [Booktype], [Drcr], [Vamt])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE UNIQUE CLUSTERED INDEX [PK_V2_LastVno] ON [dbo].[V2_LastVno] ([FldAuto])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [VNoIdx] ON [dbo].[V2_LastVno] ([Vtyp], [Booktype], [Vdt], [VnoFlag], [FinYear])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_acwisereport
-- --------------------------------------------------


Create Proc Acc_acwisereport  
@Reptype Varchar(7),   
@Grplen Tinyint,   
@Grpcode Varchar(10),   
@Fdate Varchar(11),   
@Tdate Varchar(11),   
@Faccode Varchar(10),   
@Taccode Varchar(10),   
@Costcode Smallint  
As  
Declare   
@@Grpchars As Int  
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )  
If Len(Rtrim(@Faccode)) = 0  
Begin  
   Select @Faccode = ( Select Min(Cltcode) From Acmast )  
End  
If Len(Rtrim(@Taccode)) = 0  
Begin  
   Select @Taccode = ( Select Max(Cltcode) From Acmast )  
End  
If Rtrim(@Reptype) = 'AccountBFo'  
Begin  
   If @Grplen = 0   
      Begin  
 Select L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59' And Accat = 3  
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode  
 Group By L2.Cltcode, A.Acname  
 Order By L2.Cltcode, A.Acname  
      End  
   Else  
   If @Grplen = 2  
   Begin  
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C, Category Cc  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And L2.Cltcode = Rtrim(@Faccode)  
 Group By Category, Left(Grpcode, @Grplen)  
 Order By Category, Left(Grpcode, @Grplen)  
   End  
   Else  
   If @Grplen = 10  
      Begin  
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Grpcode Like Rtrim(@Grpcode)+'%'  
        And L2.Cltcode > = @Faccode And L2.Cltcode < = @Taccode  
 Group By L2.Costcode, Costname  
 Order By L2.Costcode, Costname  
      End  
   Else     
      Begin  
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C, Category Cc  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)  
 And L2.Cltcode = Rtrim(@Faccode)  
 Group By Category, Left(Grpcode, @Grplen)  
 Order By Category, Left(Grpcode, @Grplen)  
     End  
End  
Else  
Begin  
 Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno,   
 L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration,   
 Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')  
 From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V  
 Where L2.Cltcode = Rtrim(@Faccode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = @Costcode And L2.Vtype = V.Vtype  
 Order By L2.Cltcode, A.Acname  
End  
/*  
Else  
   Begin  
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C, Category Cc  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)  
 Group By Category, Left(Grpcode, @Grplen)  
 Order By Category, Left(Grpcode, @Grplen)  
   End  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_addacmast1
-- --------------------------------------------------
create procedure acc_addacmast1 as 
select grpname,grpcode ,grpmain ,
maingrpname =(case 
		when  left(grpmain,2)='A0' then (select grpname from grpmast where grpcode ='A0000000000') 
	        else
	        	(case when  left(grpmain,2)='L0' then (select grpname from grpmast where grpcode ='L0000000000')  
			else 
				(case when  left(grpmain,2)='N0' then (select grpname from grpmast where grpcode ='N0000000000')
				else 
					(case when  left(grpmain,2)='X0' then (select grpname from grpmast where grpcode ='X0000000000')
						end)
					 end) 		
				end ) 
	 		  end)
from grpmast order by grpcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisedtl
-- --------------------------------------------------


Create Proc Acc_costaccodewisedtl  
@Costcode Smallint,   
@Accode   Varchar(10),   
@Fdate Varchar(11),   
@Tdate Varchar(11)  
As  
Select Vdate = Convert(Varchar, L.Vdt, 103) , Shortdesc, L2.Vtype, L2.Booktype, L2.Vno, L2.Lno,   
L2.Cltcode, A.Acname, L2.Drcr, L2.Camt, L.Narration,   
Chqno = Isnull((Select Ddno From Ledger1 L1 Where L1.Vtyp = L2.Vtype And L1.Booktype = L2.Booktype And L1.Vno = L2.Vno And L1.Lno = L2.Lno), '')  
From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Ledger L, Vmast V  
Where L2.Cltcode = Rtrim(@Accode) And  L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
And L.Vdt > = @Fdate + ' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
And L2.Costcode = @Costcode And L2.Vtype = V.Vtype  
Order By L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costaccodewisesum
-- --------------------------------------------------


Create Proc Acc_costaccodewisesum  
@Costcode Smallint,   
@Fdate Varchar(11),   
@Tdate Varchar(11)  
As  
Select L2.Costcode, Costname, L2.Cltcode, A.Acname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
From Ledger2 L2, Ledger L, Costmast C, Acmast A  
Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
And L2.Costcode = C.Costcode And L2.Costcode = @Costcode And L2.Cltcode = A.Cltcode  
Group By L2.Costcode, Costname, L2.Cltcode, A.Acname  
Order By L2.Costcode, Costname, L2.Cltcode, A.Acname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_costwisereport
-- --------------------------------------------------


Create Proc Acc_costwisereport  
@Grplen Tinyint,   
@Grpcode Varchar(10),   
@Fdate Varchar(11),   
@Tdate Varchar(11)  
As  
Declare   
@@Grpchars As Int  
Select @@Grpchars = (Select Len(Rtrim(@Grpcode)) )  
If @Grplen = 2  
   Begin  
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C, Category Cc  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode  
 Group By Category, Left(Grpcode, @Grplen)  
 Order By Category, Left(Grpcode, @Grplen)  
   End  
Else  
If @Grplen = 10  
   Begin  
 Select L2.Costcode, Costname, Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And Left(Grpcode, @@Grpchars) = Rtrim(@Grpcode)  
 Group By L2.Costcode, Costname  
 Order By L2.Costcode, Costname  
   End  
Else  
   Begin  
 Select Category, Grpcode = Left(Grpcode, @Grplen), Bal = Sum(Case When Upper(L2.Drcr) = 'D' Then Camt Else -camt End)  
 From Ledger2 L2, Ledger L, Costmast C, Category Cc  
 Where L2.Vtype = L.Vtyp And L2.Booktype = L.Booktype And L2.Vno = L.Vno And L2.Lno = L.Lno  
 And L.Vdt > = @Fdate +' 00:00:00' And L.Vdt < = @Tdate + ' 23:59:59'  
 And L2.Costcode = C.Costcode And C.Catcode = Cc.Catcode And Left(Grpcode, 2) = Rtrim(@Grpcode)  
 Group By Category, Left(Grpcode, @Grplen)  
 Order By Category, Left(Grpcode, @Grplen)  
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DELVOUCHER
-- --------------------------------------------------

CREATE PROCEDURE ACC_DELVOUCHER      
@VNO VARCHAR(12),       
@VTYP  SMALLINT,       
@BOOKTYPE VARCHAR(2),       
@EMODE CHAR(1),       
@STATUS CHAR(6),       
@EDITNAME VARCHAR(15),       
@VDT VARCHAR(11)      
AS      
DECLARE      
@@VDT1 AS DATETIME      

SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))      
INSERT INTO LEDGER_LOG       
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER1_LOG      
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER2_LOG       
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO LEDGER3_LOG      
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
INSERT INTO MATCHDETAILS_LOG      
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO       
INSERT INTO MARGINLEDGER_LOG      
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE    

DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO       
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_EDITVOUCHER
-- --------------------------------------------------

CREATE PROCEDURE ACC_EDITVOUCHER  
@VNO VARCHAR(12),   
@VTYP  SMALLINT,   
@BOOKTYPE VARCHAR(2),   
@EMODE CHAR(1),   
@STATUS CHAR(6),   
@EDITNAME VARCHAR(15),   
@VDT VARCHAR(11)  
AS  
DECLARE  
@@VDT1 AS DATETIME  
    
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))  

INSERT INTO LEDGER_LOG   
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER1_LOG  
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER2_LOG   
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER3_LOG  
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO MATCHDETAILS_LOG  
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
INSERT INTO MARGINLEDGER_LOG  
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  

DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/      
      
/*    
-------------------------------------    
New Procedure to Generate VNO    
-------------------------------------    
    
Author            : Uppili Krishnan    
Date               : Sep 30 2005    
Reviewed By   :    
Review Date   :    
Tested By       :       
Tested Date    :    
    
-------------------------------------    
    
            
      Flags:    
            VnoFlag = 0 Yearly    
            VnoFlag = 1 Daily    
            VnoFlag = 2 Monthly    
    
Logic:    
      Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination    
      if for the above combination record is not present in V2_LastVno table then a new record is inserted    
            else existing record is updated    
    
    
                             
*/      
      
CREATE PROC Acc_GenVno  
@vdt      varchar(11),  /* dd/mm/yyyy */      
@vtyp     smallint,      
@booktype varchar(2),      
@sdtcur   varchar(11),      
@ldtcur   varchar(11)      
/* @vnoflag  int */      
as      
      
      
      
Declare @@voudt  as datetime      
Declare @@maxvno as numeric(12,0)      
Declare @@vnoflag as tinyint      
Declare @@vno as varchar(12)      
Declare @@rcnt as int      
Declare @@FldAuto bigint      
Declare @@YearlyVdt varchar(11)    
Declare @@DailyVDt Varchar(11)      
Declare @@MonthlyVdt varchar(11)      
Declare @@UpdtVdt varchar(11)      
Declare @@FinYear smallint    
      
--SET NOCOUNT ON      
set Xact_abort on      
      
begin transaction      
      
Select     
      @@vnoflag = vnoflag,     
      @@FinYear = FldAuto      
from     
      Parameter     
where      
      sdtcur like @sdtcur + '%'     
      and ldtcur like @ldtcur + '%'    
    
    
/*     
Reinitialising the Dates to be posted in the table.      
      For Daily, the Voucher Date is taken    
      For Monthly, the 1st Day of the Month is Taken    
      For Yearly, the first Day of the year is taken    
*/    
    
select     
      @@voudt = (select convert(datetime,@vdt)),     
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),     
      @@DailyVdt = @Vdt,     
      @@YearlyVdt = 'APR  1 '+right(@sdtcur,4)    
    
    
-- Doing Yearly Voucher Gen      
if @@vnoflag = 0      
   begin      
      select     
            @@FldAuto = isnull(FldAuto,0) ,     
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))     
      from     
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)     
      where     
            vtyp = @vtyp     
            and booktype = @booktype     
            and vdt = @@YearlyVdt + ' 00:00:00'     
            and VnoFlag = @@VnoFlag     
            and FinYear = @@FinYear    
    
    
      if @@ROWCOUNT=0    
         begin      
            -- If No Record Present, then Insert    
           select     
                  @@FldAuto=0,     
                  @@UpdtVdt = @@YearlyVdt,     
                  @@vno = Right(@@YearlyVdt,4) + '00000001'      
         end      
         else      
         begin      
           select     
            -- If record is Present, then Update    
                  @@UpdtVdt = @@YearlyVdt,     
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))      
         end      
   end      
    
-- Doing Daily Voucher Gen      
else if @@vnoflag = 1      
        begin      
    
          select     
                  @@FldAuto = isnull(FldAuto,0) ,      
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))     
            from     
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)     
            where     
                  vtyp = @vtyp     
                  and booktype = @booktype     
                  and vdt = @@DailyVDt + ' 00:00:00'      
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear    
    
    
          if  @@ROWCOUNT=0    
             begin      
            -- If No Record Present, then Insert    
                select     
                  @@FldAuto=0,     
              @@UpdtVdt = @@DailyVdt,     
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'      
             end      
          else      
   begin     
            -- If record is Present, then Update    
               select     
                  @@UpdtVdt = @@DailyVdt,     
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))      
             end      
        end      
    
-- Doing Monthly Voucher Gen      
else if @@vnoflag = 2      
        begin      
          select     
                  @@FldAuto = isnull(FldAuto,0) ,     
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))     
            from     
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)     
            where     
                  vtyp = @vtyp     
                  and booktype = @booktype     
                  and vdt = @@MonthlyVDt + ' 00:00:00'      
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear    
    
    
          if  @@ROWCOUNT=0    
             begin      
            -- If No Record Present, then Insert    
                select     
                  @@FldAuto=0,     
                  @@UpdtVdt = @@MonthlyVdt,     
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001'      
             end      
         else      
             begin      
            -- If record is Present, then Update    
               select     
                  @@UpdtVdt = @@MonthlyVdt,     
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))      
             end      
        end      
    
      
if @@error <> 0       
begin      
 rollback transaction      
 select vno = ''      
 return      
end       
else      
begin      
       if isnull(@@vno,'') <> ''       
       begin      
                  if isnull(@@FldAuto,0) = 0      
                  begin      
                        -- If No Record Present, then Insert    
                        insert into V2_LastVno     
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)    
                        values     
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)      
                  end      
                  else      
                  begin      
                        -- If record is Present, then Update    
                        Update     
                              V2_LastVno     
                        set     
                              Lastvno = @@Vno     
                        where     
                              FldAuto = @@FldAuto      
                  end      
                        commit transaction      
                        select vno = @@vno      
                        return      
       end       
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_GenVno_New
-- --------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--   
  
/****** Object:  Stored Procedure dbo.V2_Acc_GenVNo    Script Date: 09/30/2005 12:23:51 ******/    
    
/*  
-------------------------------------  
New Procedure to Generate VNO  
-------------------------------------  
  
Author            : Uppili Krishnan  
Date               : Sep 30 2005  
Reviewed By   :  
Review Date   :  
Tested By       :     
Tested Date    :  
  
-------------------------------------  
  
          
      Flags:  
            VnoFlag = 0 Yearly  
            VnoFlag = 1 Daily  
            VnoFlag = 2 Monthly  
  
Logic:  
      Generates 1 record per day for the combination of VnoFlag, VoucherDate, Financial Year Combination  
      if for the above combination record is not present in V2_LastVno table then a new record is inserted  
            else existing record is updated  
  
  
                           
*/    
    
CREATE PROC Acc_GenVno_New  
@vdt      varchar(11),  /* dd/mm/yyyy */    
@vtyp     smallint,    
@booktype varchar(2),    
@sdtcur   varchar(11),    
@ldtcur   varchar(11),
@NOREC INT = 0  
/* @vnoflag  int */    
as    
    
    
    
Declare @@voudt  as datetime    
Declare @@maxvno as numeric(12,0)    
Declare @@vnoflag as tinyint    
Declare @@vno as varchar(12)    
Declare @@rcnt as int    
Declare @@FldAuto bigint    
Declare @@YearlyVdt varchar(11)  
Declare @@DailyVDt Varchar(11)    
Declare @@MonthlyVdt varchar(11)    
Declare @@UpdtVdt varchar(11)    
Declare @@FinYear smallint  
    
--SET NOCOUNT ON    
set Xact_abort on    
    
begin transaction    
    
Select   
      @@vnoflag = vnoflag,   
      @@FinYear = FldAuto    
from   
      Parameter   
where    
      sdtcur like @sdtcur + '%'   
      and ldtcur like @ldtcur + '%'  
  
  
/*   
Reinitialising the Dates to be posted in the table.    
      For Daily, the Voucher Date is taken  
      For Monthly, the 1st Day of the Month is Taken  
      For Yearly, the first Day of the year is taken  
*/  
  
select   
      @@voudt = (select convert(datetime,@vdt)),   
      @@MonthlyVdt = left(@Vdt,4)+' 1 '+right(@Vdt,4),   
      @@DailyVdt = @Vdt,   
      @@YearlyVdt = 'Jan  1 '+right(@Vdt,4)  
  
  
-- Doing Yearly Voucher Gen    
if @@vnoflag = 0    
   begin    
      select   
            @@FldAuto = isnull(FldAuto,0) ,   
            @@maxvno = convert(NUMERIC,isnull(lastvno,0))   
      from   
            V2_LastVno WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)   
      where   
            vtyp = @vtyp   
            and booktype = @booktype   
            and vdt = @@YearlyVdt + ' 00:00:00'   
            and VnoFlag = @@VnoFlag   
            and FinYear = @@FinYear  
  
  
      if @@ROWCOUNT=0  
         begin    
            -- If No Record Present, then Insert  
           select   
                  @@FldAuto=0,   
                  @@UpdtVdt = @@YearlyVdt,   
                  @@vno = Right(@@YearlyVdt,4) + '00000001'    
         end    
         else    
         begin    
           select   
            -- If record is Present, then Update  
                  @@UpdtVdt = @@YearlyVdt,   
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))    
         end    
   end    
  
-- Doing Daily Voucher Gen    
else if @@vnoflag = 1    
        begin    
  
          select   
                  @@FldAuto = isnull(FldAuto,0) ,    
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))   
            from   
                  V2_LastVno WITH (Index(VnoIdx), TABLOCKX,HOLDLOCK)   
            where   
                  vtyp = @vtyp   
                  and booktype = @booktype   
                  and vdt = @@DailyVDt + ' 00:00:00'    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear  
  
  
          if  @@ROWCOUNT=0  
             begin    
            -- If No Record Present, then Insert  
                select   
                  @@FldAuto=0,   
     @@UpdtVdt = @@DailyVdt,   
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2) + right('00'+ltrim(convert(varchar,day(@@voudt))),2))+'0001'    
             end    
          else    
   begin    
            -- If record is Present, then Update  
               select   
                  @@UpdtVdt = @@DailyVdt,   
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))    
             end    
        end    
  
-- Doing Monthly Voucher Gen    
else if @@vnoflag = 2    
        begin    
          select   
                  @@FldAuto = isnull(FldAuto,0) ,   
                  @@maxvno =convert(NUMERIC,isnull(lastvno,0))   
            from   
                  V2_LastVno WITH (index(VNoIdx), TABLOCKX,HOLDLOCK)   
            where   
                  vtyp = @vtyp   
                  and booktype = @booktype   
                  and vdt = @@MonthlyVDt + ' 00:00:00'    
                  and VnoFlag = @@VnoFlag and FinYear = @@FinYear  
  
  
          if  @@ROWCOUNT=0  
             begin    
            -- If No Record Present, then Insert  
                select   
                  @@FldAuto=0,   
                  @@UpdtVdt = @@MonthlyVdt,   
                  @@vno = (select convert(varchar,year(@@voudt)) + right('0'+ltrim(convert(varchar,month(@@voudt))),2))+'000001'    
             end    
         else    
             begin    
            -- If record is Present, then Update  
               select   
                  @@UpdtVdt = @@MonthlyVdt,   
                  @@vno = rtrim(convert(varchar,@@maxvno + 1))    
             end    
        end    
  
    
if @@error <> 0     
begin    
 rollback transaction    
 select vno = ''    
 return    
end     
else    
begin    
       if isnull(@@vno,'') <> ''     
       begin    
                  if isnull(@@FldAuto,0) = 0    
                  begin    
                        -- If No Record Present, then Insert  
                        insert into V2_LastVno   
                        (Vtyp, BookType, Vdt, LastVno, VnoFlag, FinYear)  
                        values   
                        (@vtyp,@booktype,@@UpdtVdt,@@vno, @@VnoFlag, @@FinYear)    
                  end    
                  else    
                  begin    
                        -- If record is Present, then Update  
                        Update   
                              V2_LastVno   
                        set   
                              Lastvno = @@Vno   
                        where   
                              FldAuto = @@FldAuto    
                  end    
                        commit transaction    
                        select vno = @@vno    
                        return    
       end     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_opbal
-- --------------------------------------------------


CREATE Procedure Acc_opbal  
@Sdate Varchar(11),            /* As Mmm Dd Yyyy */  
@Edate Varchar(11),            /* As Mmm Dd Yyyy */  
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */  
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */  
@Fcode Varchar(10),   
@Tcode Varchar(10),   
@Statusid Varchar(30),   
@Statusname Varchar(30),   
@Branch Varchar(10),   
@Selectionby Varchar(3),   
@Groupby Varchar(10),   
@Sortby Varchar(50),   
@Reportname Varchar(30),   
@Reportopt Varchar(10),   
@Fld1 Varchar(10),   
@Fld2 Varchar(10),   
@Fld3 Varchar(10)  
As  
Declare  
@@Opendate   As Varchar(11)  
/* -------------------------------------------------------------------------- */  
If Len(Rtrim(@Fdate)) = 10   
Begin  
   Select @Fdate = Left(@Fdate, 3) + ' ' + Substring(@Fdate, 4, 7)  
End  
If Len(Rtrim(@Sdate)) = 10   
Begin  
   Select @Sdate = Left(@Sdate, 3) + ' ' + Substring(@Sdate, 4, 7)  
End  
If Len(Rtrim(@Tdate)) = 10   
Begin  
   Select @Tdate = Left(@Tdate, 3) + ' ' + Substring(@Tdate, 4, 7)  
End  
If Len(Rtrim(@Edate)) = 10   
Begin  
   Select @Edate = Left(@Edate, 3) + ' ' + Substring(@Edate, 4, 7)  
End  
If @Fdate = ''  
Begin  
   Select @Fdate = @Sdate  
End  
If @Tdate = ''  
Begin  
   Select @Tdate = @Edate  
End  
If @Reportname <> 'Marginledger'  
Begin  
/* Get Opendate From Sdate, Fdate Received As Parameter */  
   If Upper(@Selectionby) = 'Vdt'  
      Begin  
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger Where Vtyp = 18 And Vdt < = @Fdate )  
      End  
   Else  
      Begin  
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) From Ledger Where Vtyp = 18 And Edt < = @Fdate )  
   End  
/* -------------------------------------------------------------------------- */       
   If Upper(@Selectionby) = 'Vdt'  
      Begin  
         If @Sdate = @Fdate  
            Begin  
  If @@Opendate = @Fdate   
  Begin  
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)  
                From Ledger   
                Where Cltcode = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18  
                Group By Cltcode  
  End  
  Else  
  Begin  
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)  
                From Ledger   
                Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate   
                Group By Cltcode  
  End  
            End  
         Else  
            Begin  
               Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)  
               From Ledger   
               Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate   
               Group By Cltcode  
            End  
      End  
   Else  
      Begin  
         If @Sdate = @Fdate And @@Opendate = @Fdate  
            Begin  
               Select Cltcode, Opbal = Sum(Balamt)  
               From Ledger   
               Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18  
               Group By Cltcode  
            End  
         Else  
            Begin  
               Select Cltcode, Opbal = Sum(Opbal)  
               From  
               ( Select Cltcode, Opbal = Sum(Balamt)  
                 From Ledger   
                 Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18  
                 Group By Cltcode  
                 Union All  
                 Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)  
                 From Ledger   
                 Where Cltcode = @Fcode And Edt > = @@Opendate + ' 00:00:00' And Edt < @Fdate And Vtyp <> 18  
                 Group By Cltcode ) T  
               Group By Cltcode  
            End  
      End  
End  
If @Reportname = 'Marginledger'  
Begin  
/* Get Opendate From Sdate, Fdate Received As Parameter */  
   If Upper(@Selectionby) = 'Vdt'  
      Begin  
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )  
      End  
   Else  
      Begin  
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )  
   End  
/* -------------------------------------------------------------------------- */       
   If Upper(@Selectionby) = 'Vdt'  
      Begin  
         If @Sdate = @Fdate  
            Begin  
  If @@Opendate = @Fdate   
  Begin  
                Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)  
                From Marginledger   
                Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18  
                Group By Party_code  
  End  
  Else  
  Begin  
      Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)  
                From Marginledger   
                Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate   
                Group By Party_code  
  End  
            End  
         Else  
            Begin  
     Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)  
               From Marginledger   
               Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate   
               Group By Party_code  
            End  
      End  
   Else  
      Begin  
         If @Sdate = @Fdate And @@Opendate = @Fdate  
            Begin  
               Select Cltcode = Party_code, Opbal = Sum(Sett_no)  
               From Marginledger   
               Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18  
               Group By Party_code  
            End  
         Else  
            Begin  
               Select Cltcode, Opbal = Sum(Opbal)  
               From  
               ( Select Cltcode = Party_code, Opbal = Sum(Sett_no)  
                 From Marginledger   
                 Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18  
                 Group By Party_code  
                 Union All  
                 Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)  
                 From Marginledger   
                 Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate And Vtyp <> 18  
                 Group By Party_code) T  
               Group By Cltcode  
            End  
      End  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_PrintReconcile
-- --------------------------------------------------
  /****** Object:  Stored Procedure dbo.acc_PrintReconcile    Script Date: 01/18/2006 16:45:54 ******/    
--sp_helptext acc_printreconcile      
      
/****** Object:  Stored Procedure dbo.acc_PrintReconcile    Script Date: 03/15/2003 11:24:48 AM ******/            
CREATE PROCEDURE  acc_PrintReconcile              
@code varchar(10),            
@reporttype varchar(10),            
@tdate  datetime,            
@fdate  datetime            
AS            
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
          
if upper(@reporttype) = 'STATEMENT'            
begin            
set transaction isolation level read uncommitted          
        
select distinct vtyp, booktype, vno, lno into #tblbankreco from ledger where cltcode = @code        
        
 select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,             
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then relamt  else 0 end ),            
 Cramt= (case when upper(l.drcr) = 'C' then relamt else 0 end ),             
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno            
 From ledger l  left outer join LEDGER1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno,            
 #tblbankreco t             
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype and l.vdt not like 'Jan  1 1900%'               
 and cltcode <> @code and vdt <=@tdate --and l.vtyp not in ( 16, 17) and l1.clear_mode not in ('C', 'R')            
and rtrim(l1.ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109)     
not in(select rtrim(ddno) + convert(varchar,relamt) + convert(varchar(11),dddt,109) from ledger1 l12, ledger l2 where l12.vno=l2.vno and l12.vtyp=l2.vtyp                                       
and l12.booktype=l2.booktype and l12.vtyp='16' and l2.vdt < @tdate and cltcode= @code)                                    
 and (reldt ='1900-01-01 00:00:00.000' or reldt > @tdate )             
 order by l.drcr, vdt, l.vtyp, l.vno             
end            
else            
begin            
 select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,             
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end ),            
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),             
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno            
 From ledger l  left outer join LEDGER1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno,            
 (select distinct vtyp, booktype, vno, lno from ledger where cltcode = @code) t             
 WHERE l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype             
 and cltcode <> @code and vdt >= @fdate and vdt <= @tdate            
 order by l.drcr, vdt, l.vtyp, l.vno             
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_reports
-- --------------------------------------------------



--Exec acc_reports 'Apr  1 2005', 'Mar 31 2006', 'Apr  1 2005', 'Sep 20 2005', 'DPGHDFCN', 'DPGHDFCN', 'branch', 'lsedpg', 'lsedpg','vdt', 'Account', 'vdt', 'Bank Book', '', '', '', ''  
CREATE  Procedure Acc_reports    
@Sdate Varchar(11),            /* As Mmm Dd Yyyy */    
@Edate Varchar(11),            /* As Mmm Dd Yyyy */    
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */    
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */    
@Fcode Varchar(10),     
@Tcode Varchar(10),     
@Statusid Varchar(30),     
@Statusname Varchar(30),     
@Branch Varchar(10),     
@Selectionby Varchar(3),     
@Groupby Varchar(10),     
@Sortby Varchar(50),     
@Reportname Varchar(30),     
@Reportopt Varchar(10),     
@Fld1 Varchar(50),   /*  To Be Used For Sharedb In Case Of Party Ledger */    
@Fld2 Varchar(10),     
@Fld3 Varchar(10)    
    
As    
Set Nocount On     
    
Declare    
@@Opendate   As Varchar(11),             
@@Selectqury As Varchar(8000),     
@@Fromtables As Varchar(2000),     
@@Wherepart  As Varchar(8000),     
@@Groupby    As Varchar(200),     
@@Sortby     As Varchar(200),     
@@Uall       As Varchar(20),     
@@Uselectqury As Varchar(8000),     
@@Ufromtables As Varchar(2000),     
@@Uwherepart  As Varchar(8000),     
@@Ugroupby    As Varchar(200),     
@@Usortby     Varchar(200),     
@@Datefilter As Varchar(500),     
@@Reportfrom As Varchar(1)    
    
Set Transaction Isolation Level Read Uncommitted    
    
/* -------------------------------------------------------------------------- */    
If @Fdate = " "     
Begin    
   Select @Fdate = @Sdate    
End    
    
If @Tdate = " "    
Begin    
   Select @Tdate = @Edate    
End    
    
/* Get Filter Condition On Dates Based On The Value Of @Selectionby */    
    
If @Selectionby = 'Vdt'    
Begin    
   Select @@Datefilter = " Where L.Vdt >= '" + @Fdate + " 00:00:00' And L.Vdt <= '" + @Tdate +" 23:59:59'"    
End    
Else If @Selectionby = 'Edt'    
Begin    
   Select @@Datefilter = " Where L.Edt >= '" + @Fdate + " 00:00:00' And L.Edt <= '" + @Tdate +" 23:59:59'"    
End    
/* -------------------------------------------------------------------------- */         
    
If @Reportname = 'Cash Book'     
Begin    
    
   If Upper(@Sortby) = 'Vdt'    
         Select @@Sortby = " Order By Voudt, L.Vtyp, L.Vno"    
   Else If Upper(@Sortby) = 'Edt'    
         Select @@Sortby = " Order By Effdt, L.Vtyp, L.Vno"    
    Else If Upper(@Sortby) = 'Vtype'    
          Select @@Sortby = " Order By L.Vtyp, L.Vdt, L.Vno"    
  Else If Upper(@Sortby) = 'Accode'    
       Select @@Sortby = " Order By L.Cltcode, L.Vdt, L.Vtyp, L.Vno"    
   Else If Upper(@Sortby) = 'Acname'    
        Select @@Sortby = " Order By L.Acname, L.Vdt, L.Vtyp, L.Vno"    
      Else If Upper(@Sortby) = 'Booktype'    
            Select @@Sortby = " Order By L.Booktype, L.Vdt, L.Vtyp, L.Vno"    
       Else If Upper(@Sortby) = 'Vno'    
             Select @@Sortby = " Order By L.Vno, L.Vdt, L.Vtyp"    
        Else If Upper(@Sortby) = 'Drcr'    
              Select @@Sortby = " Order By L.Drcr, L.Vdt, L.Vtyp, L.Vno"    
         Else If Upper(@Sortby) = 'Amount'    
               Select @@Sortby = " Order By L.Vamt, L.Vdt, L.Vtyp, L.Vno"    
    
    
    
   If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
      Begin    
         Select @@Selectqury = "Select L.Booktype, L.Vtyp, L.Vno, Vdt=convert(Varchar, Vdt, 103), Edt = Convert(Varchar, L.Edt, 103), Cltcode, Acname=isnull(Acname, ''), Voudt=l.Vdt, Effdt=l.Edt, Debit = (Case When Upper(L.Drcr) = 'C' Then  Vamt  Else  0 
End), Credit = (Case When Upper(L.Drcr) = 'D' Then  Vamt   Else  0 End), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Drcr"    
         Select @@Fromtables = " From (Select Distinct Vtyp, Vno, Booktype From Ledger Where Cltcode = '" + @Fcode + "') T, Ledger L "    
         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype "    
         Select @@Groupby = " "    
      End        Else    
      Begin    
    
         Select @@Selectqury = "Select L.Booktype, L.Vtyp, L.Vno, Vdt=convert(Varchar, Vdt, 103), Edt = Convert(Varchar, L.Edt, 103), Cltcode=l2.Cltcode, Acname=isnull(L.Acname, ''), Voudt=l.Vdt, Effdt=l.Edt, Debit = (Case When Upper(L2.Drcr) = 'C' Then  
Camt Else  0 End), Credit = (Case When Upper(L2.Drcr) = 'D' Then  Camt   Else  0 End), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L2.Drcr"    
         Select @@Fromtables = " From (Select Distinct Vtyp, Vno, Booktype From Ledger Where Cltcode = '" + @Fcode + "') T, Ledger2 L2, Costmast C, Ledger L "    
         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype And L2.Vtype = L.Vtyp And L2.Vno = L.Vno And L2.Lno = L.Lno And L2.Booktype = L.Booktype An
d Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode =l.Cltcode "    
         Select @@Groupby = " "     
    
    
      End    
End    
    
If @Reportname = 'Bank Book'     
Begin    
   If Upper(@Sortby) = 'Vdt'    
         Select @@Sortby = " Order By Voudt, L.Vtyp, L.Vno"    
   Else If Upper(@Sortby) = 'Edt'    
         Select @@Sortby = " Order By Effdt, L.Vtyp, L.Vno"    
    Else If Upper(@Sortby) = 'Vtype'    
          Select @@Sortby = " Order By L.Vtyp, L.Vdt, L.Vno"    
  Else If Upper(@Sortby) = 'Accode'    
       Select @@Sortby = " Order By L.Cltcode, L.Vdt, L.Vtyp, L.Vno"    
   Else If Upper(@Sortby) = 'Acname'    
        Select @@Sortby = " Order By L.Acname, L.Vdt, L.Vtyp, L.Vno"    
      Else If Upper(@Sortby) = 'Booktype'    
            Select @@Sortby = " Order By L.Booktype, L.Vdt, L.Vtyp, L.Vno"    
       Else If Upper(@Sortby) = 'Vno'    
             Select @@Sortby = " Order By L.Vno, L.Vdt, L.Vtyp"    
        Else If Upper(@Sortby) = 'Drcr'    
              Select @@Sortby = " Order By L.Drcr, L.Vdt, L.Vtyp, L.Vno"    
         Else If Upper(@Sortby) = 'Amount'    
               Select @@Sortby = " Order By L.Vamt, L.Vdt, L.Vtyp, L.Vno"    
    
   If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
      Begin    
         Select @@Selectqury = "Select L.Booktype, Vdt = Convert(Varchar, L.Vdt, 103), Effdt = L.Edt, Edt = Convert(Varchar, L.Edt, 103), Cltcode, Acname, L.Vno, L.Vtyp, Voudt=l.Vdt, Ddno= Isnull((Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno 
And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Debit = (Case When Upper(L.Drcr) = 'C' Then  Vamt  Else  0 End), Credit = (Case When Upper(L.Drcr) ='D' Then  Vamt   Else  0 End), Narration = Replace(Replace(L.Narration, '''', ''), 
'""', '')  "    
         Select @@Fromtables = " From (Select Distinct Vtyp, Vno, Booktype From Ledger Where Cltcode = '" + @Fcode + "') T, Ledger L "    
         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype "    
         Select @@Groupby = " "    
      End    
   Else    
      Begin    
/*         Select @@Selectqury = "Select L.Booktype, Vdt = Convert(Varchar, L.Vdt, 103), Effdt = L.Edt, Edt = Convert(Varchar, L.Edt, 103), L2.Cltcode, Acname, L.Vno, L.Vtyp, Voudt=l.Vdt, Ddno= Isnull((Select Ddno From Ledger1 L1 Where L1.Vno=l.Vno And L1
  
.Vty    
P=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Debit = (Case When Upper(L2.Drcr) = 'C' Then  Camt  Else  0 End), Credit = (Case When Upper(L2.Drcr) ='D' Then  Camt   Else  0 End), L.Narration "    
         Select @@Fromtables = " From (Select Distinct Vtyp, Vno, Booktype From Ledger Where Cltcode = '" + @Fcode + "') T, Ledger2 L2, Costmast C, Ledger L " */    
/*         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype And L2.Vtype = L.Vtyp And L2.Vno = L.Vno And L2.Lno = L.Lno And L2.Booktype = L.Booktype 
  
    
And Rtrim(Costname) = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode Not In ( Select Brcontrolac From Branchaccounts ) " */    
/*         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype And L2.Vtype = L.Vtyp And L2.Vno = L.Vno And L2.Lno = L.Lno And L2.Booktype = L.Booktype 
  
    
And Rtrim(Costname) = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode =l.Cltcode "     
         Select @@Groupby = " " */    
         Select @@Selectqury = "Select L.Booktype, Vdt = Convert(Varchar, L.Vdt, 103), Effdt = L.Edt, Edt = Convert(Varchar, L.Edt, 103), L2.Cltcode, Acname, L.Vno, L.Vtyp, Voudt=l.Vdt, Ddno= Isnull((Select max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno An
d L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Debit = (Case When Upper(L2.Drcr) = 'C' Then  Camt  Else  0 End), Credit = (Case When Upper(L2.Drcr) ='D' Then  Camt   Else  0 End), Narration = Replace(Replace(L.Narration, '''', ''), 
'""', '')  "    
         Select @@Fromtables = " From (Select Distinct Vtype, Vno, Booktype From Ledger2 Where Cltcode = '" + @Fcode + "') T, Ledger2 L2, Costmast C, Ledger L "     
/*         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtyp And L.Vno = T.Vno And L.Booktype = T.Booktype And L2.Vtype = L.Vtyp And L2.Vno = L.Vno And L2.Lno = L.Lno And L2.Booktype = L.Booktype 
  
    
And Rtrim(Costname) = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode Not In ( Select Brcontrolac From Branchaccounts ) " */    
         Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L2.Cltcode <> '" + @Fcode + "' And L.Vtyp = T.Vtype And L.Vno = T.Vno And L.Booktype = T.Booktype And L2.Vtype = L.Vtyp And L2.Vno = L.Vno And L2.Lno = L.Lno And L2.Booktype = L.Booktype 
/*And L2.CltCode = L.CltCode */And Rtrim(Costname) = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode "     
         Select @@Groupby = " "     
      End    
End    
    
If @Reportname = 'Gl'     
Begin    
    
/* Assign From And To Account Codes. */    
   If @Fcode = ""     
      Begin    
         Select @Fcode = (Select Min(Cltcode) From Acmast Where Accat <> 4)    
      End    
    
   If @Tcode = ""     
      Begin    
         Select @Tcode = (Select Max(Cltcode) From Acmast Where Accat <> 4)    
   End    
    
   If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
      Begin    
        Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Narration = Replac
e(Replace(L.Narration, '''', ''), '""', '') , Ddno=isnull((Select MAX(Ddno) From Ledger1 Where Vtyp = L.Vtyp And Vno = L.Vno And Booktype = L.Booktype), ''), L.Cltcode , A.Longname, Vdt, L.Vtyp, L.Booktype, Vdt = Convert(Varchar, L.Vdt, 103), Edt = Co
nvert(Varchar, L.Edt, 103), Accat "    
        Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast V "    
        Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And Vtyp = Vtype And A.Cltcode = L.Cltcode And A.Accat <> '4' "    
        Select @@Groupby = " "    
        Select @@Sortby = " Order By L.Cltcode, Voudt, L.Vtyp Desc, L.Vno"      
      End    
   Else    
      Begin    
    
        Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L2.Drcr) = 'D' Then Camt Else 0 End),  Cramt=(Case When Upper(L2.Drcr) = 'C' Then Camt Else 0 End), L.Vno, Narration = Repl
ace(Replace(L.Narration, '''', ''), '""', '') , Ddno=isnull((Select max(Ddno) From Ledger1 Where Vtyp = L.Vtyp And Vno = L.Vno And Booktype = L.Booktype), ''), L2.Cltcode , A.Longname, Vdt, L.Vtyp, L.Booktype, Vdt = Convert(Varchar, L.Vdt, 103), Edt =
 Convert(Varchar, L.Edt, 103), Accat "    
        Select @@Fromtables = " From Ledger L , Vmast V, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C  "    
        Select @@Wherepart = @@Datefilter + " And L2.Vtype <> 18 And L2.Cltcode >= '" + @Fcode + "' And L2.Cltcode <= '" + @Tcode + "' And L.Vtyp = V.Vtype And A.Cltcode = L2.Cltcode And A.Accat <> '4' And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype An
d L.Vno = L2.Vno And L.Lno = L2.Lno And Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode "    
        Select @@Groupby = " "    
    
        Select @@Sortby = " Order By L2.Cltcode, Voudt, L.Vtyp Desc, L.Vno"      
    
      End    
End    
    
If @Reportname = 'Partyledger'    
Begin    
    
 Select @@Sortby = " Voudt, L.Vtyp Desc, L.Vno"     
 If Upper(@Sortby) = 'Vdt'    
    Select @@Sortby = " Voudt, L.Vtyp Desc, L.Vno"     
   Else If Upper(@Sortby) = 'Edt'    
           Select @@Sortby = " Effdt, L.Vtyp Desc, L.Vno"     
    
 If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
 Select @@Sortby = " L.Cltcode, " + @@Sortby    
 Else    
 Select @@Sortby = " L2.Cltcode, " + @@Sortby    
    
 If Upper(Rtrim(@Groupby)) = 'Family'    
    Select @@Sortby = " Order By Cm.Family, " + @@Sortby    
 Else If Upper(Rtrim(@Groupby)) = 'Subbroker'    
       Select @@Sortby = " Order By C1.Sub_broker, " + @@Sortby    
    
 If Left(@@Sortby, 6) <> ' Order'     
    Select @@Sortby = " Order By " + @@Sortby    
          
   If Upper(Rtrim(@Groupby)) = 'Family'    
   Begin    
      If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
         Begin    
            Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((
Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.V
dt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast, BSEFO.Dbo.Clientmaster Cm "     
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode = A.Cltcode And Accat = '4' And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And L.Vtyp = Vtype And L.Cltcode = Cm.Party_code"    
            Select @@Groupby = " "    
         End    
      Else    
         Begin    
    
            Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((
Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.V
dt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L , Vmast V, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C, BSEFO.Dbo.Clientmaster Cm   "    
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L2.Cltcode >= '" + @Fcode + "' And L2.Cltcode <= '" + @Tcode + "' And L.Vtyp = V.Vtype And A.Cltcode = L2.Cltcode And A.Accat = '4' And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype A
nd L.Vno = L2.Vno And L.Lno = L2.Lno  And Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode = Cm.Party_code "    
            Select @@Groupby = " "     
    
         End      
   End    
   Else If Upper(Rtrim(@Groupby)) = 'Subbroker'    
   Begin    
      If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'              Begin    
            Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((
Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.V
dt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast, " + Rtrim(@Fld1) + ".Dbo.Client1 C1, " + Rtrim(@Fld1) + ".Dbo.Client2 C2 "    
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode = A.Cltcode And Accat = '4' And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And L.Vtyp = Vtype And L.Cltcode = C2.Party_code And C2.Cl_code = C1.Cl_code "
  
    
            Select @@Groupby = " "    
         End    
      Else    
         Begin    
            Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((
Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.V
dt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L , Vmast V, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C,  " + Rtrim(@Fld1) + ".Dbo.Client1 C1, " + Rtrim(@Fld1) + ".Dbo.Client2 C2 "    
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L2.Cltcode >= '" + @Fcode + "' And L2.Cltcode <= '" + @Tcode + "' And L.Vtyp = V.Vtype And A.Cltcode = L2.Cltcode And A.Accat = '4' And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype A
nd L.Vno = L2.Vno And L.Lno = L2.Lno  And Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode And L2.Cltcode = C2.Party_code And C2.Cl_code = C1.Cl_code "    
            Select @@Groupby = " "    
         End      
   End    
   Else    
   Begin    
   If Upper(@Statusid) = 'Broker' Or Upper(@Statusid) = 'Branch'     
   Begin    
      If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
         Begin    
         Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.Vdt,
 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast "    
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L.Cltcode = A.Cltcode And Accat = '4' And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And L.Vtyp = Vtype "    
            Select @@Groupby = " "    
         End    
      Else    
         Begin    
    
            Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((
Select Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), Narration = Replace(Replace(L.Narration, '''', ''), '""', '') , L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.V
dt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname, Ediff=datediff(D, L.Edt, Getdate()) "    
            Select @@Fromtables = " From Ledger L , Vmast V, Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C  "    
            Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And L2.Cltcode >= '" + @Fcode + "' And L2.Cltcode <= '" + @Tcode + "' And L.Vtyp = V.Vtype And A.Cltcode = L2.Cltcode And A.Accat = '4' And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype A
nd L.Vno = L2.Vno And L.Lno = L2.Lno  And Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode "    
            Select @@Groupby = " "    
            Select @@Sortby = " Order By L2.Cltcode, Voudt, L.Vtyp Desc, L.Vno"    
    
    
         End    
   End    
   Else    
   If Upper(@Statusid) = 'Subbroker'    
   Begin    
      Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((Select
  Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), L.Narration, L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname,
 Ediff=datediff(D, L.Edt, Getdate()) "    
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast, BSEFO.Dbo.Client1 C1, BSEFO.Dbo.Client2 C2 "    
      Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And Accat = '4' And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And L.Cltcode = C2.Party_code And C2.Cl_code = C1.Cl_code And Upper(Sub_broker) = Upper(@Statusname) And L.Vty
p = Vtype "    
      Select @@Groupby = " "    
   End    
   Else    
   Begin    
      Select @@Selectqury = "Select L.Booktype, Voudt=l.Vdt, Effdt=l.Edt, Isnull(Shortdesc, '') Shortdesc, Dramt=(Case When Upper(L.Drcr) = 'D' Then Vamt Else 0 End),  Cramt=(Case When Upper(L.Drcr) = 'C' Then Vamt Else 0 End), L.Vno, Ddno= Isnull((Select
 Max(Ddno) From Ledger1 L1 Where L1.Vno=l.Vno And L1.Vtyp=l.Vtyp And L1.Booktype=l.Booktype And L1.Lno = L.Lno), ''), L.Narration, L.Cltcode, A.Longname, Vtyp, L.Booktype, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, L.Acname,
 Ediff=datediff(D, L.Edt, Getdate()) "    
      Select @@Fromtables = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode , Vmast "    
      Select @@Wherepart = @@Datefilter + " And L.Vtyp <> 18 And Accat = '4' And L.Cltcode >= '" + @Fcode + "' And L.Cltcode <= '" + @Tcode + "' And L.Vtyp = Vtype "    
      Select @@Groupby = " "    
   End    
   End    
End    
    
If @Reportname = 'Marginledger'    
Begin    
   If @Selectionby = 'Vdt'    
      Begin    
         Select @@Sortby = " Order By L.Cltcode, Voudt, L.Vtyp Desc, L.Vno"    
      End    
   Else    
      Begin    
         Select @@Sortby = " Order By L.Cltcode, Effdt, L.Vtyp Desc, L.Vno"    
      End    
   If Rtrim(@Branch) = '' Or Rtrim(@Branch) = '%'     
      Begin    
         Select @@Selectqury = "Select M.Booktype, Voudt=m.Vdt, Effdt=l.Edt, L.Acname, Isnull(Shortdesc, '') Shortdesc, Drmargin = (Case When Upper(M.Drcr) = 'D' Then Amount Else 0 End ), Crmargin = (Case When Upper(M.Drcr) = 'C' Then Amount Else 0 End ),
 M.Vno, Ddno= Isnull((Select max(Ddno) From Ledger1 L1 Where L1.Vno=m.Vno And L1.Vtyp=m.Vtyp And L1.Booktype=m.Booktype And L1.Lno = M.Lno), ''), L.Narration, M.Party_code, A.Longname, M.Vtyp, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 
103) Edt "    
         Select @@Fromtables = " From Marginledger M Left Outer Join Ledger L On M.Vtyp = L.Vtyp And M.Booktype = L.Booktype And M.Vno = L.Vno And M.Lno = L.Lno Left Outer Join Acmast A On M.Party_code = A.Cltcode , Vmast V "    
         Select @@Wherepart = @@Datefilter + " And M.Party_code >= '" + @Fcode + "' And M.Party_code <= '" + @Tcode + "' And M.Vtyp <> 18 And Accat = '4' And M.Vtyp = V.Vtype "    
         Select @@Groupby = " "    
         Select @@Sortby = " Order By M.Party_code, Voudt, M.Vtyp Desc, M.Vno"    
      End    
   Else    
      Begin    
    
         Select @@Selectqury = "Select M.Booktype, Voudt=m.Vdt, Effdt=l.Edt, L.Acname, Isnull(Shortdesc, '') Shortdesc, Drmargin = (Case When Upper(M.Drcr) = 'D' Then Amount Else 0 End ), Crmargin = (Case When Upper(M.Drcr) = 'C' Then Amount Else 0 End )
, M.Vno, Ddno= Isnull((Select max(Ddno) From Ledger1 L1 Where L1.Vno=m.Vno And L1.Vtyp=m.Vtyp And L1.Booktype=m.Booktype And L1.Lno = M.Lno), ''), L.Narration, M.Party_code, A.Longname, M.Vtyp, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt,
 103) Edt "    
         Select @@Fromtables = " From Ledger L, Costmast C, Marginledger M Left Outer Join Ledger2 L2 On M.Vtyp = L2.Vtype And M.Booktype = L2.Booktype And M.Vno = L2.Vno And M.Lno = L2.Lno Left Outer Join Acmast A On M.Party_code = A.Cltcode , Vmast  V "
  
         Select @@Wherepart = @@Datefilter + " And M.Party_code >= '" + @Fcode + "' And M.Party_code <= '" + @Tcode + "' And M.Vtyp <> 18 And Accat = '4' And M.Vtyp = V.Vtype And M.Vtyp = L.Vtyp And M.Booktype = L.Booktype And M.Vno = L.Vno And M.Lno = L.
Lno And Costname = Rtrim('" + @Branch + "') And L2.Costcode = C.Costcode "    
         Select @@Groupby = " "    
         Select @@Sortby = " Order By M.Party_code, Voudt, L.Vtyp Desc, L.Vno"    
    
              
      End    
End    
    
Print @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby     
    
    
Exec ('Set Transaction Isolation Level Read Uncommitted ' + @@Selectqury + @@Fromtables + @@Wherepart + @@Groupby + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Acc_valansum
-- --------------------------------------------------




create  Proc Acc_valansum  
@Branchcd As Varchar(10),   
@Opendate As Varchar(11),   
@Closdate As Varchar(11),   
@Vtyp As Varchar(2),   
@Booktype Varchar(2),   
@Vno  Varchar(12),   
@Reportoption Char(1),   
@Baloption Char(1),   
@Sortby Varchar(10)  
As  
  
Declare   
@@Opbaldt As Varchar(11),   
@@Wherepart As Varchar(200),   
@@Frompart  As Varchar(300),   
@@Selectpart As Varchar(1000),   
@@Clbalpart  As Varchar(1000),   
@@Addwhere   As Varchar(100),   
@@Orderbypart As Varchar(100)  
  
Select @@Opbaldt = (Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Ledger L   
                    Where Vtyp = 18 And Vdt <= @Opendate)  
  
If @Reportoption = 'P'  
   Begin  
      Select @@Addwhere = " And A.Accat In ('4', '104')"  
   End  
Else If @Reportoption = 'O'  
   Begin  
      Select @@Addwhere = " And A.Accat Not In ('4', '104')"  
   End  
Else  
   Begin  
      Select @@Addwhere = " "  
   End  
  
If Rtrim(@Branchcd) = '%'   
   Begin  
 Select @@Selectpart = "Select L.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Vamt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Vamt Else 0 End ), 0), Left(Convert(Varchar, Vdt, 103), 10) Vdt, "  
 Select @@Clbalpart = " Clbal = 0"  
 Select @@Frompart = " From Ledger L Left Outer Join Acmast A On L.Cltcode = A.Cltcode "  
 Select @@Wherepart = " Where L.Vtyp = " + @Vtyp + " And L.Booktype = '" + @Booktype + "' And L.Vno = '" + @Vno + "'"  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L.Drcr "  
   End  
Else  
   Begin  
 Select @@Selectpart = " Select L2.Cltcode, A.Acname, Dramt = Isnull((Case When Upper(Drcr) = 'D' Then Camt Else 0 End ), 0), Cramt = Isnull((Case When Upper(Drcr) = 'C' Then Camt Else 0 End ), 0), "  
 Select @@Clbalpart = " Clbal =  0"  
 Select @@Frompart = " From Ledger2 L2 Left Outer Join Acmast A On L2.Cltcode = A.Cltcode, Costmast C "  
 Select @@Wherepart = " Where L2.Vtype = " + @Vtyp + " And L2.Booktype = '" + @Booktype + "' And L2.Vno = '" + @Vno + "'"  
 Select @@Addwhere = @@Addwhere + " And L2.Costcode = C.Costcode And C.Costname = '" + Rtrim(@Branchcd) + "' "  
        If Upper(Rtrim(@Sortby)) = 'Accode'  
       Select @@Orderbypart = " Order By L2.Cltcode "  
        Else If Upper(Rtrim(@Sortby)) = 'Acname'  
        Select @@Orderbypart = " Order By A.Acname "  
             Else If Upper(Rtrim(@Sortby)) = 'Drcr'  
        Select @@Orderbypart = " Order By L2.Drcr "  
   End  
  
Print @@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart  
  
Exec (@@Selectpart + @@Clbalpart + @@Frompart + @@Wherepart + @@Addwhere + @@Orderbypart )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Insert
-- --------------------------------------------------




CREATE Proc Add_Client_Account_Proc_Insert (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As

Update Owner Set Companyname = companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update
-- --------------------------------------------------
  
CREATE Proc Add_Client_Account_Proc_Update (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
      
Delete From AcMast      
Where CltCode In ( Select Party_Code       
                   From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D      
                   Where D.Exchange = @Exchange And D.Segment = @Segment        
     And C.Cl_Code = D.Cl_Code)      
      
Insert into AcMast      
Select ACName = Long_Name, LongName = Long_Name,
ACTyp = (Case When Cl_Type ='SBD' Then 'LIABILITIE' Else 'ASSET' End),       
ACCat = (Case When Cl_Type ='SBD' Then '3' Else '4' End),   
FamilyCd = '', CltCode = Party_Code, AccDtls = '',   
GrpCode = (Case When Cl_Type ='SBD' Then 'L0704000000' Else 'A0307000000' End),      
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,       
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No      
From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
    
  
Insert into MultiBankId  
SELECT '',Party_code,BankID=P.BankID,CltDpId=AC_Num,        
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'         
                        When Ac_Type = 'C' Then 'CURRENT'         
                        Else 'OTHER' End), 'OTHER'),  
Long_Name, DEF=1  
From bsefo.DBO.Client_Details_Tmp C, bsefo.DBO.Client_Brok_Details_Tmp D, bsefo.DBO.POBank P        
Where D.Exchange = @Exchange And D.Segment = @Segment          
And C.Cl_Code = D.Cl_Code        
And Ac_Type <> ''        
And C.Party_Code Not In (Select CltCode From MultiBankId )  
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update_bak_12may2009
-- --------------------------------------------------
CREATE Proc Add_Client_Account_Proc_Update_bak_12may2009 (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
      
Delete From AcMast      
Where CltCode In ( Select Party_Code       
                   From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D      
                   Where D.Exchange = @Exchange And D.Segment = @Segment        
     And C.Cl_Code = D.Cl_Code)      
      
Insert into AcMast      
Select ACName = Long_Name, LongName = Long_Name, ACTyp = 'ASSET',       
ACCat = '4', FamilyCd = '', CltCode = Party_Code, AccDtls = '', GrpCode = 'A0307000000',       
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,       
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No      
From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code    
  
insert into   MultiBankId  
SELECT '',Party_code,BankID=P.BankID,CltDpId=AC_Num,        
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'         
                        When Ac_Type = 'C' Then 'CURRENT'         
                        Else 'OTHER' End), 'OTHER'),  
Long_Name, DEF=1  
From bsefo.DBO.Client_Details_Tmp C, bsefo.DBO.Client_Brok_Details_Tmp D, bsefo.DBO.POBank P        
Where D.Exchange = @Exchange And D.Segment = @Segment          
And C.Cl_Code = D.Cl_Code        
And Ac_Type <> ''        
And C.Party_Code Not In (Select CltCode From MultiBankId )  
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Account_Proc_Update_new
-- --------------------------------------------------
CREATE Proc Add_Client_Account_Proc_Update (  
@Exchange Varchar(3),   
@Segment Varchar(7),   
@Branch_Cd Varchar(10),   
@FromParty Varchar(10),  
@ToParty Varchar(10),  
@MainDate Varchar(30),  
@DetDate Varchar(30)  
) As  
  
Delete From AcMast  
Where CltCode In ( Select Party_Code   
                   From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D  
                   Where D.Exchange = @Exchange And D.Segment = @Segment    
     And C.Cl_Code = D.Cl_Code)  
  
Insert into AcMast  
Select ACName = Long_Name, LongName = Long_Name, ACTyp = 'ASSET',   
ACCat = '4', FamilyCd = '', CltCode = Party_Code, AccDtls = '', GrpCode = 'A0307000000',   
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,   
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No  
From BSEFO.DBO.Client_Details_Tmp C, BSEFO.DBO.Client_Brok_Details_Tmp D  
Where D.Exchange = @Exchange And D.Segment = @Segment    
And C.Cl_Code = D.Cl_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB
-- --------------------------------------------------


--exec Ageingcursor_NEW1_SB '10100000', '10100010', 'Apr  1 2004', 'Nov 19 2004','party','',0, 'A','edt','broker','broker', 6,26,90,160,161,'101', 'VALSAD'    
CREATE Procedure Ageingcursor_NEW1_SB  
@fromparty varchar(10),        
@toparty varchar(10),         
@opendate varchar(11),        
@todate varchar(11),        
@Reporttype varchar(15),        
@family varchar(10),        
@amoutgtthan money,        
@ageoption varchar(1),        
@dttype varchar(3),    
@statusid varchar(10),    
@statusname varchar(25),    
@Days1 Int = 6,    
@Days2 Int = 29,    
@Days3 Int = 90,    
@Days4 Int = 180,    
@Days5 Int = 181,    
@FrSb Varchar(10) = '0',    
@ToSb Varchar(10) = 'ZZZZ'    
    
    
    
as    
    
declare    
@@balcur as cursor,        
@@baldate as varchar(11),        
@@openbaldt as varchar(11),        
@@balamt as money,        
@@ocltcode as varchar(10),        
@@vtyp as smallint,        
@@vno varchar(12),        
@@EVdt as DATETIME,        
@@vamt as money,        
@@closbal as money,        
@@cltcode as varchar(10),        
@@Branchcode as varchar(25),        
@@area as varchar(25),    
@@drcr    as varchar(1),        
@@startdt as datetime    
      
Print 'Strated '       
Print convert(datetime,getdate(),113)      
      
Set nocount on        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
      
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )        
        
        
if upper(@statusid) = 'BROKER'        
begin         
 select @@branchcode = '%'         
 select @@area = '%'         
end        
else if upper(@statusid) = 'BRANCH'        
begin        
 select @@branchcode = rtrim(@statusname)        
 select @@area = '%'         
end     
else if upper(@statusid) = 'AREA'        
begin        
 select @@branchcode = '%'    
 select @@area = rtrim(@statusname)    
end     
        
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from Ledger where 1=2      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from Ledger where 1=2      
    
Select * into #Ledger from Ledger where 1=2    
    
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from Ledger where 1=2    
        
if @dttype='vdt'    
begin    
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger where vtyp = '18' and vdt < = @opendate     
     
 if upper(@Reporttype) = 'PARTY'    
 begin    
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, BSEFO.dbo.client1 c1, BSEFO.dbo.client2 c2 where l.cltcode = c2.party_code    
  and c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode         
      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode         
 end    
    
 else if upper(@Reporttype) = 'FAMILY'    
 begin    
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l,  BSEFO.dbo.client1 c1, BSEFO.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'        
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty        
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by family         
  order by family    
    
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
   closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode         
  order by cltcode    
      
 end    
    
 else if upper(@Reporttype) = 'FAMILYPARTY'    
 begin    
  insert   into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, BSEFO.dbo.client1 c1, BSEFO.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and l.cltcode = c2.party_code and c1.family = @family    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
   
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
   closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode        
      
 end    
    
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)         
 END        
    
 else        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from BSEFO.dbo.client2 c2, BSEFO.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)         
 END        
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode       
   and vdt <= @todate  + ' 23:59:59'         
   --    
   and vtyp <> '18'        
   order by l.cltcode, vdt desc, vtyp, vno    
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and vdt <= @todate  + ' 23:59:59'        
   --    
   and vtyp <> '18'      
   order by l.cltcode, vdt desc, vtyp, vno         
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a    
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and vdt <= @todate  + ' 23:59:59'        
   --    
   and vtyp <> '18'     
   order by l.cltcode, vdt desc, vtyp, vno         
  end    
 end    
     
 else        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, BSEFO.dbo.clientmaster c,  #tempageing a where a.cltcode = family        
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal     
   from #Ledger l, BSEFO.dbo.clientmaster c, #tempageing a where  a.cltcode = family        
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, BSEFO.dbo.clientmaster c, #tempageing a where a.cltcode = family        
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
 end    
    
end    
    
else    
begin    
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger where vtyp = '18' and edt < = @opendate    
    
 if upper(@Reporttype) = 'PARTY'    
 begin    
  insert   into #tempageing1     
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, acmast a, BSEFO.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code    
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'         
  and a.accat = 4    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode    
      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
      
 end    
    
 else if upper(@Reporttype) = 'FAMILY'    
 begin    
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l,  BSEFO.dbo.client1 c --BSEFO.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'        
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty        
  and c.Branch_cd like @@branchcode+'%'     
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by family         
  order by family    
  
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
      
 end    
     
 else if upper(@Reporttype) = 'FAMILYPARTY'    
 begin    
  insert into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, BSEFO.dbo.client1 c--BSEFO.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'    
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c.Branch_cd like @@branchcode+'%'    
  and l.cltcode = c.cl_code and c.family = @family         
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
     
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
     
 end    
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)        
 END    
         
 else        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from BSEFO.dbo.client2 c2, BSEFO.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)    
 END        
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 begin        
  if upper(rtrim(@ageoption)) = 'D'    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode       
   and edt <= @todate  + ' 23:59:59'         
   --    
   and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor         
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledgeredt l, #tempageing a        
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and edt <= @todate  + ' 23:59:59'        
   --    
   and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno      
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and edt <= @todate  + ' 23:59:59'        
   --     
   and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno     
  end    
 end    
     
 else        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, BSEFO.dbo.clientmaster c,  #tempageing a where a.cltcode = family        
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal     
   from #Ledger l, BSEFO.dbo.clientmaster c, #tempageing a where  a.cltcode = family        
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, BSEFO.dbo.clientmaster c, #tempageing a where a.cltcode = family        
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
 end    
end    
        
        
Print 'Filled LedgerCursor'       
Print convert(datetime,getdate(),113)      
      
set @@balcur = cursor for        
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno      
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2        
        
print 'opening cursor'        
        
open @@balcur    
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal         
    
while @@fetch_status = 0       
begin         
 select @@ocltcode = @@cltcode         
  select @@balamt = abs(@@closbal)        
 if @@closbal >= 0         
 begin        
  select @@drcr = 'd'        
 end     
     else        
 begin        
       select @@drcr = 'c'        
 end    
    
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0        
 begin        
  if @@balamt >= @@vamt         
  begin      
   insert into #fintempageing        
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr         
   select @@balamt = @@balamt - @@vamt       
  end        
    
  else        
  begin        
   insert into #fintempageing        
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr         
   select @@balamt = @@balamt - @@vamt         
  end        
    
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal         
 end        
    
 if @@balamt > 0        
 begin      
   insert into #fintempageing        
   select @@ocltcode, @@balamt, 181, @@drcr         
   select @@balamt = @@balamt - @@vamt        
 end        
    
 while @@fetch_status = 0 and @@ocltcode = @@cltcode    
 begin      
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal        
 end        
end    
        
close @@balcur        
deallocate @@balcur        
        
print 'cursor closed'        
Print convert(datetime,getdate(),113)      
        
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist        
from #fintempageing     
where agedays >= 0 and agedays <= @Days1    
group by cltcode, drcr        
order by cltcode, drcr        
        
insert into #ageinglist       
select cltcode, balance=sum(balamt), agedays = @Days2, drcr         
from #fintempageing        
where agedays >= @Days1+1 and agedays <= @Days2    
group by cltcode, drcr         
order by cltcode, drcr        
        
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days3, drcr         
from #fintempageing        
where agedays >= @Days2+1 and agedays <= @Days3    
group by cltcode, drcr         
order by cltcode, drcr         
    
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days4, drcr         
from #fintempageing        
where agedays >= @Days3+1 and agedays <= @Days4    
group by cltcode, drcr         
order by cltcode, drcr         
        
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days5, drcr         
from #fintempageing        
where agedays >= @Days5    
group by cltcode, drcr         
order by cltcode, drcr         
    
print 'done'        
Print convert(datetime,getdate(),113)      
        
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, b.branch, s.name    
from #ageinglist a1, BSEFO.dbo.client1 a2, BSEFO.dbo.subbrokers s, BSEFO.dbo.branch b--BSEFO.dbo.clientmaster a2--account.dbo.acmast  a2         
where balance >= @amoutgtthan and         
a1.cltcode = a2.cl_code    
and a2.branch_cd = b.branch_code    
and a2.sub_broker = s.sub_broker    
order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name    
        
drop table #tempageing        
drop table #Ledger        
drop table #LedgerCursor         
drop table #ageinglist        
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ageingcursor_NEW1_SB_angel
-- --------------------------------------------------
CREATE Procedure Ageingcursor_NEW1_SB_angel  
@fromparty varchar(10),        
@toparty varchar(10),         
@opendate varchar(11),        
@todate varchar(11),        
@Reporttype varchar(15),        
@family varchar(10),        
@amoutgtthan money,        
@ageoption varchar(1),        
@dttype varchar(3),    
@statusid varchar(10) ,    
@statusname varchar(25),    
@Days1 Int = 29,    
@Days2 Int = 60,    
@Days3 Int = 90,    
@Days4 Int = 180,    
@Days5 Int = 360,    
@FrSb Varchar(10) = '0',    
@ToSb Varchar(10) = 'ZZZZ'    
    
    
    
as    
  
------------------------------------------------  
/*  
declare  
@fromparty varchar(10),        
@toparty varchar(10),         
@opendate varchar(11),        
@todate varchar(11),        
@Reporttype varchar(15),        
@family varchar(10),        
@amoutgtthan money,        
@ageoption varchar(1),        
@dttype varchar(3),    
@statusid varchar(10) ,    
@statusname varchar(25),    
@Days1 Int,    
@Days2 Int,    
@Days3 Int,    
@Days4 Int,    
@Days5 Int,    
@FrSb Varchar(10),    
@ToSb Varchar(10)  
  
set @fromparty ='K9550'  
set @toparty ='K9550'  
set @opendate='Apr  1 2006'  
set @todate = 'Mar 31 2007'  
set @Reporttype ='party'  
set @family =''  
set @amoutgtthan =0  
set @ageoption='D'  
set @dttype ='vdt'  
set @statusid= 'broker'  
set @statusname = 'broker'  
set @Days1=29  
set @Days2=60  
set @Days3=90  
set @Days4=180  
set @Days5=360  
set @FrSb ='0'  
set @ToSb  = 'ZZZZ'  
  
*/  
  
    
declare    
@@balcur as cursor,        
@@baldate as varchar(11),        
@@openbaldt as varchar(11),        
@@balamt as money,        
@@ocltcode as varchar(10),        
@@vtyp as smallint,        
@@vno varchar(12),        
@@EVdt as DATETIME,        
@@vamt as money,        
@@closbal as money,        
@@cltcode as varchar(10),        
@@Branchcode as varchar(25),        
@@area as varchar(25),    
@@drcr    as varchar(1),        
@@startdt as datetime    
      
  
--PRINT 'Strated '       
--PRINT convert(datetime,getdate(),113)      
      
Set nocount on        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED       
      
Select @@startdt = ( select left(convert(varchar,dateadd(mm,-12,convert(datetime,@todate)),109),11) )        
        
        
if upper(@statusid) = 'BROKER'        
begin         
 select @@branchcode = '%'         
 select @@area = '%'         
end        
else if upper(@statusid) = 'BRANCH'        
begin        
 select @@branchcode = rtrim(@statusname)        
 select @@area = '%'         
end     
else if upper(@statusid) = 'AREA'        
begin        
 select @@branchcode = '%'    
 select @@area = rtrim(@statusname)    
end     
        
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing  from Ledger where 1=2      
select cltcode,vdt as baldate , vamt closbal, agedays=0   into  #tempageing1  from Ledger where 1=2      
    
Select * into #Ledger from Ledger where 1=2    
    
Select cltcode,vtyp,vno,edt as EVdt,vamt,vamt closbal into #LedgerCursor from Ledger where 1=2    
        
if @dttype='vdt'    
begin    
 select @@openbaldt=left(convert(varchar,isnull(max(vdt),0),109),11) from Ledger where vtyp = '18' and vdt < = @opendate     
     
 if upper(@Reporttype) = 'PARTY'    
 begin    
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where l.cltcode = c2.party_code    
  and c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' --and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode         
/*      
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where l.cltcode = c2.party_code    
  and c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode         
      
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,   
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l, bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where l.cltcode = c2.party_code    
  and c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and c1.branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode         
*/      
      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode         
 end    
    
 else if upper(@Reporttype) = 'FAMILY'    
 begin    
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l,  bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'        
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty        
  and c1.Branch_cd like @@branchcode+'%' --and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by family         
  order by family    
/*      
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'        
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty        
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by family         
  order by family    
      
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l,  bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'        
  and l.cltcode = c2.party_code and c1.family >= @fromparty and c1.family <= @toparty        
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by family         
  order by family    
*/      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
   closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode         
  order by cltcode    
      
 end    
    
 else if upper(@Reporttype) = 'FAMILYPARTY'    
 begin    
  insert   into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c1.Branch_cd like @@branchcode+'%' --and area like @@area+'%'    
  and l.cltcode = c2.party_code and c1.family = @family    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
/*      
  insert   into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c1, bsedb.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and l.cltcode = c2.party_code and c1.family = @family    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
      
  insert   into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l, bsefo.dbo.client1 c1, bsefo.dbo.client2 c2 where c1.cl_code = c2.cl_code    
  and vdt >= @@openbaldt + ' 00:00:00' and vdt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c1.Branch_cd like @@branchcode+'%' and area like @@area+'%'    
  and l.cltcode = c2.party_code and c1.family = @family    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
*/      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
   closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode        
      
 end    
    
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)         
/*      
  insert into #Ledger     
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)         
      
  insert into #Ledger     
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)       */  
 END        
    
 else        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from bsefo.dbo.client2 c2, bsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)         
/*      
  insert into #Ledger     
  select * from Accountbse.dbo.Ledger where vdt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from bsedb.dbo.client2 c2, bsedb.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)    
      
  insert into #Ledger     
  select * from Accountfo.dbo.Ledger where vdt <= @todate  + ' 23:59:59'    
  and cltcode in (select party_code from bsefo.dbo.client2 c2, bsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */  
 END        
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode       
   and vdt <= @todate  + ' 23:59:59'         
   --    
   --and vtyp <> '18'        
   order by l.cltcode, vdt desc, vtyp, vno    
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and vdt <= @todate  + ' 23:59:59'        
   --    
   --and vtyp <> '18'      
   order by l.cltcode, vdt desc, vtyp, vno         
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, #tempageing a    
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and vdt <= @todate  + ' 23:59:59'        
   --    
   --and vtyp <> '18'     
   order by l.cltcode, vdt desc, vtyp, vno         
  end    
 end    
     
 else        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, bsefo.dbo.clientmaster c,  #tempageing a where a.cltcode = family        
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal     
   from #Ledger l, bsefo.dbo.clientmaster c, #tempageing a where  a.cltcode = family        
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, vdt, vamt, closbal        
   from #Ledger l, bsefo.dbo.clientmaster c, #tempageing a where a.cltcode = family        
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and vdt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, vdt desc, vtyp, vno        
  end    
 end    
    
end    
    
else    
begin    
 select @@openbaldt=left(convert(varchar,isnull(max(edt),0),109),11) from Ledger where vtyp = '18' and edt < = @opendate    
    
 if upper(@Reporttype) = 'PARTY'    
 begin    
  insert   into #tempageing1     
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, acmast a, bsefo.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code    
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'         
  and a.accat = 4    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode    
/*         
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l, accountbse.dbo.acmast a, bsedb.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code    
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'         
  and a.accat = 4    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode    
      
  insert   into #tempageing1         
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l, accountfo.dbo.acmast a, bsefo.dbo.client1 c1 where l.cltcode = a.cltcode and l.cltcode = c1.cl_code    
  and edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty and a.branchcode like @@branchcode+'%'         
  and a.accat = 4    
  and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode    
*/      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
      
 end    
    
 else if upper(@Reporttype) = 'FAMILY'    
 begin    
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l,  bsefo.dbo.client1 c --bsefo.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'        
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty        
  and c.Branch_cd like @@branchcode+'%'     
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by family         
  order by family    
/*      
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l,  bsedb.dbo.client1 c--bsedb.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'        
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty        
  and c.Branch_cd like @@branchcode+'%'     
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by family         
  order by family    
      
  insert   into #tempageing1        
  Select Family as cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l,  bsefo.dbo.client1 c--bsefo.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'        
  and l.cltcode = c.cl_code and c.family >= @fromparty and c.family <= @toparty        
  and c.Branch_cd like @@branchcode+'%'     
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by family         
  order by family    
*/      
      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
      
 end    
     
 else if upper(@Reporttype) = 'FAMILYPARTY'    
 begin    
  insert into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Ledger l, bsefo.dbo.client1 c--bsefo.dbo.clientmaster c      
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'    
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c.Branch_cd like @@branchcode+'%'    
  and l.cltcode = c.cl_code and c.family = @family         
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode        
/*      
  insert into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountbse.dbo.Ledger l, bsedb.dbo.client1 c--bsedb.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c.Branch_cd like @@branchcode+'%'    
  and l.cltcode = c.cl_code and c.family = @family         
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode             
      
  insert into #tempageing1    
  select l.cltcode, baldate=@todate,         
  closbal = sum( case when drcr = 'd' then vamt else -vamt end),agedays=0        
  from Accountfo.dbo.Ledger l, bsefo.dbo.client1 c--bsefo.dbo.clientmaster c        
  where edt >= @@openbaldt + ' 00:00:00' and edt <= @todate + ' 23:59:59'         
  and l.cltcode >= @fromparty and l.cltcode <= @toparty     
  and c.Branch_cd like @@branchcode+'%'    
  and l.cltcode = c.cl_code and c.family = @family         
  and c.sub_broker >= @FrSb and c.sub_broker <= @ToSb    
  group by l.cltcode        
  order by l.cltcode    
*/      
  insert   into #tempageing      
  select cltcode, baldate=@todate,         
  closbal = sum(closbal),agedays=0        
  from #tempageing1        
  group by cltcode        
  order by cltcode     
     
 end    
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)        
/*      
  insert into #Ledger     
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)        
      
  insert into #Ledger     
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (Select distinct cltcode from #tempageing)     */  
 END    
         
 else        
 BEGIN        
  insert into #Ledger     
  select * from Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from bsefo.dbo.client2 c2, bsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)    
/*      
  insert into #Ledger     
  select * from Accountbse.dbo.Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from bsefo.dbo.client2 c2, bsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)    
      
  insert into #Ledger     
  select * from Accountfo.dbo.Ledger where edt <= @todate  + ' 23:59:59'     
  and cltcode in (select party_code from bsefo.dbo.client2 c2, bsefo.dbo.client1 c1 where c1.cl_code=c2.cl_code and family >= @fromparty and family <= @toparty and c1.sub_broker >= @FrSb and c1.sub_broker <= @ToSb)  */  
 END        
     
 if upper(@Reporttype) = 'PARTY' or upper(@Reporttype) = 'FAMILYPARTY'        
 begin        
  if upper(rtrim(@ageoption)) = 'D'    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode       
   and edt <= @todate  + ' 23:59:59'         
   --    
   --and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor         
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledgeredt l, #tempageing a        
   where closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and edt <= @todate  + ' 23:59:59'        
   --    
   --and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno      
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select l.cltcode, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, #tempageing a        
   where drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and l.cltcode = a.cltcode        
   and edt <= @todate  + ' 23:59:59'        
   --     
   --and vtyp <> '18'        
   order by l.cltcode, edt desc, vtyp, vno     
  end    
 end    
     
 else        
 begin        
  if upper(rtrim(@ageoption)) = 'D'         
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, bsefo.dbo.clientmaster c,  #tempageing a where a.cltcode = family        
   and closbal >= 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
     
  else if upper(rtrim(@ageoption)) = 'C'    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal     
   from #Ledger l, bsefo.dbo.clientmaster c, #tempageing a where  a.cltcode = family        
   and closbal < 0 and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
     
  else    
  begin    
   insert into #LedgerCursor       
   select cltcode=family, vtyp, vno, edt, vamt, closbal        
   from #Ledger l, bsefo.dbo.clientmaster c, #tempageing a where a.cltcode = family        
   and drcr = ( case when closbal >= 0 then 'd' else 'c' end )         
   and edt <= @todate  + ' 23:59:59'         
   and l.cltcode = c.party_code and family >= @fromparty and family <= @toparty         
   --    
   --and vtyp <> '18'        
   order by cltcode, edt desc, vtyp, vno        
  end    
 end    
end    
        
        
--PRINT 'Filled LedgerCursor'       
--PRINT convert(datetime,getdate(),113)      
      
set @@balcur = cursor for        
select cltcode, vtyp, vno, EVdt, vamt, closbal  from #LedgerCursor order by cltcode, EVdt desc, vtyp, vno      
select cltcode,vamt balamt,0 agedays,drcr into #fintempageing from #Ledger where 1= 2        
        
--PRINT 'opening cursor'        
        
open @@balcur    
fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal         
    
while @@fetch_status = 0       
begin         
 select @@ocltcode = @@cltcode         
  select @@balamt = abs(@@closbal)        
 if @@closbal >= 0         
 begin        
  select @@drcr = 'd'        
 end     
     else        
 begin        
       select @@drcr = 'c'        
 end    
    
 while @@fetch_status = 0 and @@ocltcode = @@cltcode  and @@balamt > 0        
 begin        
  if @@balamt >= @@vamt         
  begin      
   insert into #fintempageing        
   select @@cltcode, @@vamt, datediff(day,@@EVdt,@todate), @@drcr         
   select @@balamt = @@balamt - @@vamt       
  end        
    
  else        
  begin        
   insert into #fintempageing        
   select @@cltcode, @@balamt, datediff(day,@@EVdt,@todate), @@drcr         
   select @@balamt = @@balamt - @@vamt         
  end        
    
  fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal         
 end        
    
 if @@balamt > 0        
 begin      
   insert into #fintempageing        
   select @@ocltcode, @@balamt, 181, @@drcr         
   select @@balamt = @@balamt - @@vamt        
 end        
    
 while @@fetch_status = 0 and @@ocltcode = @@cltcode    
 begin      
     fetch next from @@balcur into  @@cltcode, @@vtyp, @@vno, @@EVdt, @@vamt, @@closbal        
 end        
end    
        
close @@balcur        
deallocate @@balcur        
        
--PRINT 'cursor closed'        
--PRINT convert(datetime,getdate(),113)      
        
  
  
select cltcode, balance=sum(balamt), agedays = @Days1, drcr into #ageinglist        
from #fintempageing     
where agedays >= 0 and agedays <= @Days1    
group by cltcode, drcr        
--order by cltcode, drcr        
        
insert into #ageinglist       
select cltcode, balance=sum(balamt), agedays = @Days2, drcr         
from #fintempageing        
where agedays >= @Days1+1 and agedays <= @Days2    
group by cltcode, drcr         
--order by cltcode, drcr        
        
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days3, drcr         
from #fintempageing        
where agedays >= @Days2+1 and agedays <= @Days3    
group by cltcode, drcr         
--order by cltcode, drcr         
    
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days4, drcr         
from #fintempageing        
where agedays >= @Days3+1 and agedays <= @Days4    
group by cltcode, drcr         
--order by cltcode, drcr         
        
  
insert into #ageinglist        
select cltcode, balance=sum(balamt), agedays = @Days5, drcr         
from #fintempageing        
--where agedays >= @Days5    
where agedays >= @Days4+1 and agedays <= @Days5    
group by cltcode, drcr         
--order by cltcode, drcr         
  
    
--PRINT 'done'        
--PRINT convert(datetime,getdate(),113)      
  
  
Select a1.cltcode, short_name = a2.Short_Name, balance, agedays, drcr, a2.branch_cd, a2.sub_broker, b.branch, s.name    
into #filex  
from #ageinglist a1, bsefo.dbo.client1 a2, bsefo.dbo.subbrokers s, bsefo.dbo.branch b--bsefo.dbo.clientmaster a2--account.dbo.acmast  a2         
where balance >= @amoutgtthan and         
a1.cltcode = a2.cl_code    
and a2.branch_cd = b.branch_code    
and a2.sub_broker = s.sub_broker    
--order by a2.branch_cd, a2.sub_broker, a1.cltcode, a2.Short_Name    
  
--truncate table Angel_Ageing        
--insert into Angel_Ageing        
  
select party_code=a.cltcode,a.baldate,a.closbal,b.* into #AgeFinal   
from (select * from #tempageing where closbal <> 0 )a left outer join #filex b on a.cltcode=b.cltcode       
  
  
select PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal,  
Day_30=sum(case   
when agedays=29 and drcr='d' then balance   
when agedays=29 and drcr='c' then -balance   
else 0 end),  
Day_60=sum(case  
when agedays=60 and drcr='d' then balance   
when agedays=60 and drcr='c' then -balance   
else 0 end),  
Day_90=sum(case  
when agedays=90 and drcr='d' then balance   
when agedays=90 and drcr='c' then -balance   
else 0 end),  
Day_180=sum(case   
when agedays=180 and drcr='d' then balance   
when agedays=180 and drcr='c' then -balance   
else 0 end),  
Day_360=sum(case   
when agedays=360 and drcr='d' then balance   
when agedays=360 and drcr='c' then -balance   
else 0 end)  
into #fINAL  
from #AgeFinal   
group by PARTY_cODE,branch_cd,branch,sub_Broker,name,cltcode,short_name,balDate,ClosBal 


select a.*,last_trade_date=convert(varchar(11),vdt) into #fINAL1 from #fINAL a
left outer join
(select cltcode,vdt=max(vdt) from ledger (nolock) group by cltcode) b
on a.party_code=b.cltcode     
--order by cltcode  
  
if @ageoption='D'  
begin   
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)   
 FROM #fINAL1   
 where closBal > 0  
 order by cltcode  
end  
if @ageoption='C'  
begin   
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)   
 FROM #fINAL1   
 where closBal < 0  
 order by cltcode  
end  
if @ageoption='A'  
begin   
 SELECT *, DAYS_361_PLUS=ClosBal-ISNULL(DAY_30,0)-ISNULL(DAY_60,0)-ISNULL(DAY_90,0)-ISNULL(DAY_180,0)-ISNULL(DAY_360,0)   
 FROM #fINAL1   
 order by cltcode  
end  
  
  
drop table #tempageing        
drop table #tempageing1        
drop table #Ledger        
drop table #LedgerCursor         
drop table #ageinglist        
drop table #fintempageing

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost1
-- --------------------------------------------------
CREATE procedure angel_getledger_cost1(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(11))        
as        
        
set transaction isolation level read uncommitted        
        
set nocount on        
        
/*        
Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'        
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)        
set @cltcode='a108'        
set @fdate='Apr 01 2004'        
set @tdate='Jan 05 2006'        
*/        
        
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')        
into #abl_cost        
from         
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'        
) a left outer join        
(select l2.camt,l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')         
from ledger2 l2         
left outer join costmast cm         
on l2.costcode=cm.costcode) b         
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode        
        
        
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narration],         
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=(case when drcr = 'C' then n.vamt else 0 end),         
balamt=convert(money,0.00),n.camt as [CostAmt],n.CostName,Segment=@segment,n.acname,@cltcode as accountcode,n.lno as [LineNo]  from #abl_cost n left outer join         
vmast v on vtyp=vtype        
order by n.vno,n.lno        
        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2
-- --------------------------------------------------
CREATE procedure angel_getledger_cost2(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))    
as    
    
set transaction isolation level read uncommitted    
    
set nocount on    
    
  
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'    
/*  
drop table #abl_cost_a  
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)    
set @cltcode='70000014 '    
set @fdate='Apr 01 2004'    
set @tdate='Dec 30 2004'    
*/  
  
set transaction isolation level read uncommitted    
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')    
into #abl_cost_a    
from     
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'    
) a left outer join    
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')     
from ledger2 l2 (nolock)    
left outer join costmast cm (nolock)    
on l2.costcode=cm.costcode) b     
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode    
  
set transaction isolation level read uncommitted  
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname  
into #file1  
from ledger (nolock)  
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'    
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%')   
and vno in (select vno from #abl_cost_a) and vtyp<>18  
  
  
  
set transaction isolation level read uncommitted  
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)  
into #abl_cost  
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp   
  
set transaction isolation level read uncommitted   
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],     
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),     
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt  
from #abl_cost n left outer join     
vmast v (nolock) on vtyp=vtype    
order by n.vno,n.lno    
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost3
-- --------------------------------------------------
CREATE procedure angel_getledger_cost3(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))          
as          
          
set transaction isolation level read uncommitted          
          
set nocount on          
          
        
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'          
/*      
drop table #abl_cost_a        
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)          
set @cltcode='26100010'          
set @fdate='Jun 01 2007'          
set @tdate='Jun 30 2007'          
*/      
        
set transaction isolation level read uncommitted          
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')          
into #abl_cost_a          
from           
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'          
) a left outer join          
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')           
from ledger2 l2 (nolock)          
left outer join costmast cm (nolock)          
on l2.costcode=cm.costcode) b           
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode          
        
set transaction isolation level read uncommitted        
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname        
into #file1        
from ledger (nolock)        
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'          
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%' or cltcode like '35%' or cltcode like '31%' or cltcode like '32%' or cltcode like '38%')         
and vno in (select vno from #abl_cost_a) and vtyp<>18        
        
        
        
set transaction isolation level read uncommitted        
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)        
into #abl_cost        
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp         
        
set transaction isolation level read uncommitted         
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],           
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),           
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt        
into #temp1      
from #abl_cost n left outer join           
vmast v (nolock) on vtyp=vtype          
      
delete from #temp1 where credit <= 0      
      
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,      
narration=      
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN      
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))       
ELSE      
NARR      
END      
into #tempa      
from #temp1      
where alt_vamt < 0      
      
      
insert into #tempa      
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,      
narration=      
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN      
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))       
ELSE      
NARR      
END      
from #temp1      
where vno not in (select vno from #tempa)      
      
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'')      
from #tempa a left outer join mis.sb_comp.dbo.SB_State_pan b on a.costname=b.sub_BRoker order by vno      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC
-- --------------------------------------------------







create  PROC AUTORECOUPDATE_HDFC      
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),    
 @USERNAME VARCHAR(20),
 @PWD VARCHAR(20),  
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      
      
CREATE TABLE #HDFCRECO      
 (      
  BOOKDATE VARCHAR(10),      
  [DESCRIPTION] VARCHAR(100),      
  LEDGER_BALANCE VARCHAR(20),      
  CREDIT VARCHAR(20),      
  DEBIT VARCHAR(20),      
  VALUEDATE VARCHAR(10),      
  REFERENCE_NO VARCHAR(20),      
  BRANCH VARCHAR(25)      
 )      
      
      
CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(100),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]      
      
      
SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO '" + @FILENAME + "',  '#HDFCRECO','" + @USERNAME + "','" + @PWD + "'"
EXEC (@@SQL_QUERY)   


  
INSERT INTO #BANKRECOSAVE_TEMP      
SELECT      
 @BANKCODE,      
 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
 [DESCRIPTION],      
 AMOUNT = (CASE WHEN ([DESCRIPTION] = 'Opening balance' OR [DESCRIPTION] = 'Closing balance') THEN LEDGER_BALANCE ELSE (CASE WHEN CREDIT <> '0' THEN CREDIT ELSE DEBIT END) END) ,      
 DRCR = (CASE WHEN CREDIT <> '0' THEN 'C' ELSE 'D' END),      
 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
 REFERENCE_NO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 'UNMATCHED',      
 @@MICRNO,       '',      
 '',      
 ''      
FROM      
 #HDFCRECO   

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 CONVERT(MONEY,AMOUNT),      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(REFERENCENO, 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
  REFERENCENO LIKE '%[A-Z]%'

DELETE FROM #BANKRECOSAVE_TEMP 
WHERE 
  REFERENCENO LIKE '%[A-Z]%'


  
INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 CONVERT(MONEY,AMOUNT),      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP    


/*CREATE TABLE #BANKRECOSAVE_DELETE      
(      
 [DESCRIPTION] VARCHAR(250),      
 AMOUNT MONEY,      
 DRCR CHAR(1),      
 REFERENCENO VARCHAR(25),      
CROSSREFERENCENO INT      
) */     

DECLARE   
@@AMOUNTDIFF MONEY,  
@@STAMOUNTDIFF MONEY,  
@@BOOKDATE_MIN DATETIME,  
@@BOOKDATE_MAX DATETIME  
  
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE   
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE   

CREATE TABLE #RECODUPS   
(  
 BOOKDATE VARCHAR(11),   
 REFERENCENO VARCHAR(25),   
 AMOUNT MONEY,   
 DESCRIPTION VARCHAR(200),   
 STATUS VARCHAR(10),   
 CROSSREFERENCENO INT  
)  
  
SET @@EXIST_COUNT_BEFORE = 0  
SET @@EXIST_COUNT_AFTER = 0  
  
DECLARE   
@CLTCODE VARCHAR(10),   
@BOOKDATE DATETIME,   
@AMOUNT MONEY,   
@DRCR CHAR(1),   
@VALUEDATE DATETIME,   
@REFERENCENO VARCHAR(20),  
@DESCRIPTION VARCHAR(200)  
  
DECLARE CUR_CHECCK CURSOR FOR  
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0  
  
OPEN CUR_CHECCK  
  
FETCH NEXT FROM CUR_CHECCK  
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT @@ERROR_COUNT = 0  
    
  SELECT    
   @@EXIST_COUNT_BEFORE = COUNT(1)  
  FROM   
   BANKRECO  
  WHERE  
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
  
  
    
 /* IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,   
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B  
    WHERE  
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)  
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO  
    
    RETURN  
   END */  
 END  
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
  
   
       
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)  
 FROM #BANKRECOSAVE  
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
   
 DELETE BR FROM #BANKRECOSAVE BR  
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO  
   
   
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT   
   @@EXIST_COUNT_AFTER = COUNT(1)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR   
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
    
    
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER  
   BEGIN  
    INSERT INTO #RECODUPS  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR  
    WHERE  
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
    
   END   
  SET @@EXIST_COUNT_BEFORE = 0  
  SET @@EXIST_COUNT_AFTER = 0  
 END   
 FETCH NEXT FROM CUR_CHECCK  
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
END  
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0      
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS  
  
IF @@ERROR_COUNT > 0  
BEGIN  
 SELECT * FROM #RECODUPS  
 RETURN  
END  
  
  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
DELETE BR FROM    
 BANKRECO B, #BANKRECOSAVE BR    
WHERE     
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))    
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')  
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL  
  
IF @@ERROR_COUNT = 0  
BEGIN   
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'   
 RETURN  
END  
    
SELECT   
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)   
FROM  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE' AND BOOKDATE LIKE CONVERT(VARCHAR(11), @@BOOKDATE_MIN) + '%') BR,  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1  

IF @PROCESS_STATUS = 1  
BEGIN  
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END   
ELSE  
BEGIN   
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END  

IF @@AMOUNTDIFF <> @@STAMOUNTDIFF  
BEGIN  
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'  
 RETURN  
END  
  
 DELETE FROM   
  #BANKRECOSAVE  
 WHERE   
  VALUEDATE IS NULL  
  

  DELETE #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE' 
  DELETE FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE'
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN      
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0      
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'      
BEGIN      
 BEGIN TRAN      
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
 RETURN      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
      
INSERT      
INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FILENAME,      
 @FILENAME,      
 COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'HDFC_RECO UPLOAD'      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 STATUS ='MATCHED'      
FROM      
 LEDGER1      
WHERE      
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)      
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
  
  
  
  
  
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO      
 LEDGER_UPDATES      
SELECT     
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
  
  
  
  
  
  
  
  
  
 AND REFERENCENO  <> '0'      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
SELECT      
 SUM(RELAMT) AS AMOUNT,      
 SLIPNO AS SLIPNO,      
 UPPER(DRCR) AS DRCR,      
 MICRNO      
INTO      
 BANKRECOCOMP      
FROM      
 LEDGER1      
WHERE      
 MICRNO = @@MICRNO      
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )      
 AND SLIPNO <>''      
GROUP BY      
 SLIPNO,      
 DRCR,      
 MICRNO      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'      
FROM      
 BANKRECOCOMP      
WHERE      
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)      
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO      
  AND REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO LEDGER_UPDATES      
SELECT      
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE ,      
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER  (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO      
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VALUEDATE      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND EDT LIKE 'DEC 31 2049%'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VDT      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES      
  
IF @PROCESS_STATUS = 1  
BEGIN  
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)  
END  
      
INSERT INTO      
 BANKRECO      
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'      
FROM      
 #BANKRECOSAVE B      
      
      
UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS
-- --------------------------------------------------



CREATE  PROC AUTORECOUPDATE_HDFC_ALLBANKS
 @FILENAME VARCHAR(100),      
 @UNAME VARCHAR(100),      
 @BANKCODE VARCHAR(10),      
 @STATUSID VARCHAR(10),      
 @STATUSNAME VARCHAR(100),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15),
 @PROCESS_STATUS BIT = 0  
  
      
AS      
      
/*    
EXEC AUTORECOUPDATE_HDFC 'D:\BACKOFFICE\HDFCRECO\0308061.dat', 'TEST', 'HDFC001', 'BROKER','BROKER'      
SELECT * FROM BANKRECO WHERE CLTCODE = 'HDFC001' AND BOOKDATE LIKE 'mAR 30 2006%'      
EXEC AUTORECOUPDATE_HDFC 'D:\BackOffice\HDFCRECO\0308061.dat', 'jaydeep','hdfc001','broker','broker'  
SELECT TOP 1 * FROM BANKRECO  
*/    
DECLARE      
 @@SQL_QUERY AS VARCHAR(1000),      
 @@CROSSREFERENCENO INT,      
 @@TABLE_EXIST VARCHAR(20),      
 @@RECORD_COUNT TINYINT,      
 @@RECO_STATUS CHAR(1),      
 @@FILE_EXIST INT,      
 @@CLTCODE_EXIST INT,      
 @@MICRNO VARCHAR(20)      
      
SET NOCOUNT ON      
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
IF @@CLTCODE_EXIST = 0      
 BEGIN      
  SELECT 'BANK CODE DOSE NOT EXIST.'      
  RETURN      
 END      
      
SELECT @@MICRNO = ISNULL(MICRNO, 0) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2      
      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@ERROR_COUNT SMALLINT,  
 @@EXIST_COUNT_BEFORE SMALLINT,  
 @@EXIST_COUNT_AFTER SMALLINT  
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FILENAME      
   AND U_MODULE = 'HDFC_RECO UPLOAD'      
 ) A      
/*IF @@ERROR_COUNT > 0      
BEGIN      
 SELECT      
  'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.'      
 RETURN      
END       */      
      
SELECT @@CROSSREFERENCENO = ISNULL(MAX(CROSSREFERENCENO), 0) FROM BANKRECO      

CREATE TABLE #HDFCRECO  
(
	BOOKDATE VARCHAR(11)
)

CREATE TABLE #ICICIRECO  
(
	SR_NO INT,
	TXN_ID VARCHAR(25),
	BOOKDATE VARCHAR(11)
)

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"  
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

END

EXEC (@@SQL_QUERY)

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"

	EXEC (@@SQL_QUERY)
END

CREATE TABLE [#BANKRECOSAVE_TEMP]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT VARCHAR(20),      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 VARCHAR(20),      
  CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL      
 )      
ON [PRIMARY]      
      
CREATE TABLE [#BANKRECOSAVE]      
 (      
  CLTCODE VARCHAR(10),      
  BOOKDATE DATETIME,      
  [DESCRIPTION] VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  VALUEDATE DATETIME,      
  REFERENCENO VARCHAR(30),      
  STATUSID VARCHAR(15),      
  STATUSNAME VARCHAR(25),      
  LOGINNAME VARCHAR(25),      
  CROSSREFERENCENO [INT],      
  STATUS VARCHAR(9),      
  MICRNO INT,      
  DUMMY1 VARCHAR(15) ,      
  DUMMY2 VARCHAR(15),      
  AMOUNTLEDGR1 MONEY      
 )      
ON [PRIMARY]     

CREATE TABLE #TESTIMPORT                
(                
	OneRow Varchar(2000),              
	SNO INT IDENTITY(1,1)              
)   

IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
	
END
ELSE IF @BANK_TYPE <> 'CANARARECO'
BEGIN
	SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"
END

--PRINT @@SQL_QUERY
EXEC (@@SQL_QUERY) 




IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "
END
ELSE
BEGIN
	SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"
	SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "
	SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(20) "
END


EXEC (@@SQL_QUERY)

SELECT * INTO HDFCRECO FROM #HDFCRECO


IF @BANK_TYPE = 'CITYRECO'
BEGIN
	UPDATE HDFCRECO SET [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE', VALUEDATE = BOOKDATE
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	UPDATE HDFCRECO SET AMOUNT = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN CREDIT ELSE DEBIT END, DRCR = CASE WHEN (DEBIT IS NULL OR CONVERT(MONEY, DEBIT) = 0) THEN 'C' ELSE 'D' END
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	UPDATE HDFCRECO SET VALUEDATE = BOOKDATE, DRCR = CASE WHEN DRCR = 'DR' THEN 'D' ELSE 'C' END
END

IF @BANK_TYPE = 'CANARARECO' 
BEGIN
	SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"
  	EXEC(@@SQL_QUERY)                

	DELETE FROM #TESTIMPORT WHERE OneRow IS NULL
	DELETE FROM #TESTIMPORT WHERE OneRow LIKE '****%'

	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 [DESCRIPTION] = SUBSTRING(OneRow, 18, 23),      
	 AMOUNT = SUBSTRING(OneRow, 41, 14),      
	 DRCR = SUBSTRING(OneRow, 17, 1),      
	 VALUEDATE = CONVERT(DATETIME, SUBSTRING(SUBSTRING(OneRow, 1, 8), 7, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 5, 2) + '/' + SUBSTRING(SUBSTRING(OneRow, 1, 8), 1, 4), 103),      
	 REFERENCE_NO = SUBSTRING(OneRow, 9, 8),      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 #TESTIMPORT  
END
ELSE IF @BANK_TYPE = 'ICICIRECO'
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME,  (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 101),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE, 2) + '-' + SUBSTRING(VALUEDATE, 4, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  

END
ELSE
BEGIN
	INSERT INTO #BANKRECOSAVE_TEMP      
	SELECT      
	 @BANKCODE,      
	 BOOKDATE = CONVERT(DATETIME, (LEFT(BOOKDATE, 2) + '/' + SUBSTRING(BOOKDATE, 4, 2) + '/' + RIGHT(BOOKDATE,4)), 103),      
	 [DESCRIPTION],      
	 AMOUNT,      
	 DRCR,      
	 VALUEDATE = CONVERT(DATETIME, RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE, 4, 2) + '-' + LEFT(VALUEDATE, 2)),      
	 REFERENCE_NO,      
	 @STATUSID,      
	 @STATUSNAME,      
	 @UNAME,      
	 'UNMATCHED',      
	 @@MICRNO,      
	 '',      
	 '',      
	 ''      
	FROM      
	 HDFCRECO  
END


DROP TABLE HDFCRECO


INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO NOT LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],      
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO,      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO LIKE '%[A-Z]%'

INSERT INTO #BANKRECOSAVE      
SELECT      
 @BANKCODE,      
 BOOKDATE,    
 [DESCRIPTION],     
 AMOUNT = CASE WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT)) ELSE CONVERT(MONEY,AMOUNT) END ,      
 DRCR,      
 VALUEDATE,      
 REFERENCENO = ISNULL(CONVERT(VARCHAR, CONVERT(BIGINT, REFERENCENO)), 0),      
 @STATUSID,      
 @STATUSNAME,      
 @UNAME,      
 CROSSREFERENCNEO = CONVERT(INT, @@CROSSREFERENCENO + CROSSREFERENCENO),      
 'UNMATCHED',      
 @@MICRNO,      
 '',      
 '',      
 0      
FROM      
 #BANKRECOSAVE_TEMP      
WHERE 
 REFERENCENO IS NULL


IF @BANK_TYPE = 'CANARARECO'
BEGIN
	UPDATE #BANKRECOSAVE SET AMOUNT = CONVERT(MONEY, AMOUNT / 100)	
END



/*CREATE TABLE #BANKRECOSAVE_DELETE      
(      
 [DESCRIPTION] VARCHAR(250),      
 AMOUNT MONEY,      
 DRCR CHAR(1),      
 REFERENCENO VARCHAR(25),      
CROSSREFERENCENO INT      
) */     
  
DECLARE   
@@AMOUNTDIFF MONEY,  
@@STAMOUNTDIFF MONEY,  
@@BOOKDATE_MIN DATETIME,  
@@BOOKDATE_MAX DATETIME  
  
SELECT @@BOOKDATE_MIN = MIN(BOOKDATE) FROM #BANKRECOSAVE   
SELECT @@BOOKDATE_MAX = MAX(BOOKDATE) FROM #BANKRECOSAVE   
  
  
CREATE TABLE #RECODUPS   
(  
 BOOKDATE VARCHAR(11),   
 REFERENCENO VARCHAR(25),   
 AMOUNT MONEY,   
 DESCRIPTION VARCHAR(200),   
 STATUS VARCHAR(10),   
 CROSSREFERENCENO INT  
)  
  
SET @@EXIST_COUNT_BEFORE = 0  
SET @@EXIST_COUNT_AFTER = 0  
  
DECLARE   
@CLTCODE VARCHAR(10),   
@BOOKDATE DATETIME,   
@AMOUNT MONEY,   
@DRCR CHAR(1),   
@VALUEDATE DATETIME,   
@REFERENCENO VARCHAR(20),  
@DESCRIPTION VARCHAR(200)  
  
DECLARE CUR_CHECCK CURSOR FOR  
 SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO, [DESCRIPTION] FROM #BANKRECOSAVE WHERE AMOUNT < 0  
  
OPEN CUR_CHECCK  
  
FETCH NEXT FROM CUR_CHECCK  
INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT @@ERROR_COUNT = 0  
    
  SELECT    
   @@EXIST_COUNT_BEFORE = COUNT(1)  
  FROM   
   BANKRECO  
  WHERE  
   CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
   AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
  
  
    
 /* IF @@ERROR_COUNT > 0  
   BEGIN  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR,   
     (SELECT CLTCODE, BOOKDATE, AMOUNT, DRCR, VALUEDATE, REFERENCENO FROM #BANKRECOSAVE WHERE AMOUNT < 0) B  
    WHERE  
     BR.CLTCODE = B.CLTCODE AND BR.BOOKDATE = B.BOOKDATE AND BR.AMOUNT = ABS(B.AMOUNT)  
     AND BR.DRCR = B.DRCR AND BR.VALUEDATE = B.VALUEDATE AND BR.REFERENCENO = B.REFERENCENO  
    
    RETURN  
   END */  
 END  
 /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
  
   
       
 SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)  
 FROM #BANKRECOSAVE  
 WHERE [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
   
 DELETE BR FROM #BANKRECOSAVE BR  
 WHERE BR.CROSSREFERENCENO = @@CROSSREFERENCENO  
   
   
 IF @PROCESS_STATUS = 0   
 BEGIN  
  SELECT   
   @@EXIST_COUNT_AFTER = COUNT(1)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   [DESCRIPTION] = @DESCRIPTION AND AMOUNT =  ABS(@AMOUNT) AND DRCR = @DRCR   
   AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0') AND AMOUNT > 0      
    
    
  IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER  
   BEGIN  
    INSERT INTO #RECODUPS  
    SELECT    
     BOOKDATE = CONVERT(VARCHAR(11), BR.BOOKDATE, 103), BR.REFERENCENO, BR.AMOUNT, BR.[DESCRIPTION], BR.STATUS, BR.CROSSREFERENCENO  
    FROM   
     (SELECT * FROM BANKRECO WHERE BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59' AND CLTCODE = @BANKCODE) BR  
    WHERE  
     CLTCODE = @CLTCODE AND BOOKDATE = @BOOKDATE AND AMOUNT = ABS(@AMOUNT)  
     AND DRCR = @DRCR AND VALUEDATE = @VALUEDATE AND ISNULL(REFERENCENO, '0') = ISNULL(@REFERENCENO, '0')  
    
   END   
  SET @@EXIST_COUNT_BEFORE = 0  
  SET @@EXIST_COUNT_AFTER = 0  
 END   
 FETCH NEXT FROM CUR_CHECCK  
 INTO @CLTCODE, @BOOKDATE, @AMOUNT, @DRCR, @VALUEDATE, @REFERENCENO, @DESCRIPTION  
END  
  
DELETE FROM #BANKRECOSAVE WHERE AMOUNT < 0      
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #RECODUPS  
  
IF @@ERROR_COUNT > 0  
BEGIN  
 SELECT * FROM #RECODUPS  
 RETURN  
END  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
DELETE BR FROM    
 BANKRECO B, #BANKRECOSAVE BR    
WHERE     
 LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE)) AND CONVERT(VARCHAR(11), B.BOOKDATE, 109) = CONVERT(VARCHAR(11), BR.BOOKDATE, 109) AND LTRIM(RTRIM(B.[DESCRIPTION])) = LTRIM(RTRIM(BR.[DESCRIPTION]))    
 AND B.AMOUNT = BR.AMOUNT AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR)) AND CONVERT(VARCHAR(11), B.VALUEDATE, 109) = CONVERT(VARCHAR(11), BR.VALUEDATE, 109) AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)), '') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)), '')  
  
SELECT @@ERROR_COUNT = COUNT(1) FROM #BANKRECOSAVE WHERE VALUEDATE IS NOT NULL  

  
IF @@ERROR_COUNT = 0  
BEGIN   
 SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'   
 RETURN  
END  
    
SELECT   
 @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)   
FROM  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'OPENING BALANCE') BR,  
 (SELECT AMOUNT FROM #BANKRECOSAVE WHERE [DESCRIPTION] = 'CLOSING BALANCE') BR1  
  
  
IF @PROCESS_STATUS = 1  
BEGIN  
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
   AND CROSSREFERENCENO NOT IN(SELECT CROSSNO FROM RECODUPS1)  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END   
ELSE  
BEGIN   
 SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))  
 FROM   
 (  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   BANKRECO  
  WHERE   
   BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX AND CLTCODE = @BANKCODE  
  UNION ALL  
  SELECT   
   AMOUNT = SUM(CASE DRCR WHEN 'D' THEN AMOUNT ELSE -AMOUNT END)  
  FROM   
   #BANKRECOSAVE  
  WHERE   
   VALUEDATE IS NOT NULL  
    
    
 )B  
END  
  
  
IF @@AMOUNTDIFF <> @@STAMOUNTDIFF  
BEGIN  
 SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'  
 RETURN  
END  
  
 DELETE FROM   
  #BANKRECOSAVE  
 WHERE   
  VALUEDATE IS NULL  
  
  
  
/* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */  
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'      
      
IF @@TABLE_EXIST = ''      
BEGIN      
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS      
      
IF @@RECORD_COUNT = 0      
BEGIN      
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS      
      
IF @@RECO_STATUS = 'N'      
BEGIN      
 BEGIN TRAN      
 UPDATE RECOPROCESS SET INPROCESS = 'Y'      
END      
ELSE      
BEGIN      
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'      
 RETURN      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE LEDGER_UPDATES      
END      
      
SET @@TABLE_EXIST = ''      
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'      
IF @@TABLE_EXIST <> ''      
BEGIN      
 DROP TABLE BANKRECOCOMP      
END      
      
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)      
      
INSERT      
INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FILENAME,      
 @FILENAME,      
 COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'HDFC_RECO UPLOAD'      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 STATUS ='MATCHED'      
FROM      
 LEDGER1      
WHERE      
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)      
 AND CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), VDT, 101))     
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO      
 LEDGER_UPDATES      
SELECT     
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), LEDGER.VDT, 101)
 AND   REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' OR LEDGER1.VTYP = '17')      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND DDNO =  REFERENCENO      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR)      
 AND REFERENCENO  <> '0'      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP    
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101)
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
SELECT      
 SUM(RELAMT) AS AMOUNT,      
 SLIPNO AS SLIPNO,      
 UPPER(DRCR) AS DRCR,      
 MICRNO      
INTO      
 BANKRECOCOMP      
FROM      
 LEDGER1      
WHERE      
 MICRNO = @@MICRNO      
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )      
 AND SLIPNO <>''      
GROUP BY      
 SLIPNO,      
 DRCR,      
 MICRNO      
      
      
UPDATE      
 #BANKRECOSAVE      
SET      
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'      
FROM      
 BANKRECOCOMP      
WHERE      
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)      
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)      
  AND #BANKRECOSAVE.MICRNO = @@MICRNO      
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT      
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO      
  AND REFERENCENO  <> '0'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
INSERT INTO LEDGER_UPDATES      
SELECT      
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE      
FROM      
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE      
 AND LEDGER1.VNO = LEDGER.VNO      
 AND LEDGER1.VTYP = LEDGER.VTYP      
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
      
UPDATE      
 LEDGER1      
SET      
 RELDT = VALUEDATE ,      
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO      
FROM      
 #BANKRECOSAVE, LEDGER  (NOLOCK)      
WHERE      
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )      
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)      
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)      
 AND RELDT = ''      
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE      
 AND #BANKRECOSAVE.MICRNO = @@MICRNO      
 AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO, 0)
 AND #BANKRECOSAVE.REFERENCENO  <> '0'      
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)      
 AND LEDGER.VNO = LEDGER1.VNO      
 AND LEDGER.VTYP = LEDGER1.VTYP      
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE      
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VALUEDATE      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND EDT LIKE 'DEC 31 2049%'      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'      
 ROLLBACK TRAN      
 RETURN      
END      
      
UPDATE      
 L      
SET      
 EDT = VDT      
FROM      
 LEDGER L, LEDGER_UPDATES LU      
WHERE      
 LU.VNO=L.VNO      
 AND LU.VTYP=L.VTYP      
 AND LU.BOOKTYPE=L.BOOKTYPE      
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))      
      
IF @@ERROR <> 0      
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'      
 ROLLBACK TRAN      
 RETURN      
END      
      
IF @PROCESS_STATUS = 1  
BEGIN  
 DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND CROSSREFERENCENO IN(SELECT CROSSNO FROM RECODUPS1)  
END  
      
INSERT INTO      
 BANKRECO  
(Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,Status,Micrno,Dummy1,Dummy2)    
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0'      
FROM      
 #BANKRECOSAVE B    

INSERT INTO      
 BANKRECO_LOG      
SELECT      
 B.CLTCODE,B.BOOKDATE, B.DESCRIPTION, B.AMOUNT, B.DRCR, B.VALUEDATE, B.REFERENCENO, B.STATUSID,      
 B.STATUSNAME, B.LOGINNAME, B.CROSSREFERENCENO,B.STATUS,@@MICRNO,'0','0', 0, 'AUTO', GETDATE(), 'MATCHED' 
FROM      
 #BANKRECOSAVE B    
WHERE
 B.STATUS = 'MATCHED'



INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO', GETDATE(), 'MATCHED' 
FROM LEDGER1 L1, LEDGER_UPDATES LU
WHERE L1.VNO = LU.VNO AND L1.VTYP = LU.VTYP AND L1.BOOKTYPE = LU.BOOKTYPE

DROP TABLE BANKRECOCOMP      
DROP TABLE LEDGER_UPDATES    

UPDATE RECOPROCESS SET INPROCESS = 'N'      
      
COMMIT TRAN      
      
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------
CREATE PROCEDURE BR_YEAREND  
 @SDTCUR VARCHAR(11),        
 @LDTCUR VARCHAR(11),        
 @VTYP   SMALLINT,        
 @VNO VARCHAR(12),        
 @BOOKTYPE CHAR(2),        
 @VDT    DATETIME,  
 @PNLCODE VARCHAR(10)        
        
AS        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
        
DECLARE        
 @@MAINCTRLAC AS VARCHAR(10),        
 @@MAINACNAME AS VARCHAR(100),        
 @@MAINCOSTCODE AS INT,        
 @@LNO AS INT,        
 @@COSTCODE AS SMALLINT,        
 @@AMT AS MONEY,        
 @@RCURSOR AS CURSOR  
    
      
        
SELECT         
 @@LNO =         
 (         
 SELECT         
  LNO         
 FROM LEDGER         
 WHERE VTYP = @VTYP         
  AND BOOKTYPE = @BOOKTYPE         
  AND VNO = @VNO         
  AND CLTCODE = @PNLCODE         
 )        
        
SELECT         
 @@MAINCTRLAC =         
 (         
 SELECT         
  MAINCONTROLAC         
 FROM BRANCHACCOUNTS         
 WHERE DEFAULTAC = 1        
 )        
        
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)        
        
SELECT         
 @@MAINACNAME =         
 (         
 SELECT         
  ACNAME         
 FROM ACMAST         
 WHERE CLTCODE = @@MAINCTRLAC         
 )      
  
TRUNCATE TABLE LEDGER_BRANCHBREAKUP  
  
INSERT INTO LEDGER_BRANCHBREAKUP  
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR   
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)   
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'             
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP             
AND L2.BOOKTYPE = L.BOOKTYPE             
 AND L2.VNO = L.VNO             
 AND L2.LNO = L.LNO   )    
        
TRUNCATE TABLE BRANCHWISECLBAL   
  
INSERT INTO BRANCHWISECLBAL  
SELECT     
 L2.CLTCODE,             
 A.ACNAME ,             
 COSTCODE,             
 BALANCE=SUM(             
 CASE             
  WHEN UPPER(L2.DRCR) = 'D'             
  THEN CAMT             
  ELSE -CAMT             
 END            
 )             
FROM LEDGER_BRANCHBREAKUP L2,             
 ACMAST A             
    
WHERE   
L2.CLTCODE = A.CLTCODE  
 AND             
 (            
  A.ACTYP LIKE 'ASS%'             
  OR A.ACTYP LIKE 'LIAB%'            
 )             
            
GROUP BY COSTCODE,             
 L2.CLTCODE,             
 A.ACNAME          
        
/*  
INSERT         
INTO BRANCHWISECLBAL         
SELECT         
 L2.CLTCODE,         
 A.ACNAME ,         
 COSTCODE,         
 BALANCE=SUM(         
 CASE         
  WHEN UPPER(L2.DRCR) = 'D'         
  THEN CAMT         
  ELSE -CAMT         
 END        
 )         
FROM LEDGER2 L2         
LEFT OUTER JOIN         
 ACMAST A         
 ON L2.CLTCODE = A.CLTCODE,         
 LEDGER L         
WHERE L2.VTYPE = L.VTYP         
 AND L2.BOOKTYPE = L.BOOKTYPE         
 AND L2.VNO = L.VNO         
 AND L2.LNO = L.LNO         
 AND L.VDT > = @SDTCUR + ' 00:00:00'         
 AND L.VDT <= @LDTCUR + ' 23:59:59'         
 AND         
 (        
  A.ACTYP LIKE 'ASS%'         
  OR A.ACTYP LIKE 'LIAB%'        
 )         
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)         
GROUP BY COSTCODE,         
 L2.CLTCODE,         
 A.ACNAME  
*/  
INSERT         
  INTO BRANCHWISECLBAL         
 SELECT        
   @@MAINCTRLAC,         
   @@MAINACNAME,         
   COSTCODE,        
   -(SUM(BALANCE))  
  FROM        
   BRANCHWISECLBAL        
  GROUP BY        
   COSTCODE   
  
      
  
/*        
SET @@RCURSOR = CURSOR FOR        
 SELECT        
  COSTCODE,        
  SUM(BALANCE)        
 FROM        
  BRANCHWISECLBAL        
 GROUP BY        
  COSTCODE        
        
OPEN @@RCURSOR        
 FETCH NEXT FROM        
  @@RCURSOR         
 INTO        
  @@COSTCODE,        
  @@AMT        
        
WHILE @@FETCH_STATUS = 0        
 BEGIN        
  INSERT         
  INTO BRANCHWISECLBAL VALUES        
   (         
    @@MAINCTRLAC,         
    @@MAINACNAME,         
    @@COSTCODE,         
    -(@@AMT)         
   )        
        
  FETCH NEXT FROM        
   @@RCURSOR         
  INTO        
   @@COSTCODE,        
   @@AMT        
 END        
        
CLOSE @@RCURSOR        
DEALLOCATE @@RCURSOR       
*/   
        
INSERT         
INTO LEDGER2         
SELECT         
 L.VTYP,         
 L.VNO,         
 L.LNO,         
 (        
 CASE         
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0         
  THEN 'D'         
  ELSE 'C'         
 END        
 ),         
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),         
 COSTCODE,         
 L.BOOKTYPE,         
 B.CLTCODE         
FROM LEDGER L,         
 BRANCHWISECLBAL B         
WHERE L.VTYP = @VTYP         
 AND L.BOOKTYPE = @BOOKTYPE         
 AND L.VNO = @VNO         
 AND L.CLTCODE = B.CLTCODE        
 AND L.CLTCODE NOT IN         
 (         
 SELECT         
  BRCONTROLAC         
 FROM BRANCHACCOUNTS         
 )        
        
INSERT         
INTO LEDGER2         
SELECT         
 @VTYP,         
 @VNO,         
 @@LNO,         
 (        
 CASE         
  WHEN BALANCE >= 0         
  THEN 'D'         
  ELSE 'C'         
 END        
 ),         
 ABS(BALANCE),         
 COSTCODE,         
 @BOOKTYPE,         
 CLTCODE         
FROM BRANCHWISECLBAL B         
WHERE CLTCODE IN         
 (         
 SELECT         
  BRCONTROLAC         
 FROM BRANCHACCOUNTS         
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BrClosingBalance
-- --------------------------------------------------

/**************************************************************************************************************************************************************************************************      
	THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE       
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~      
	Copy of BrOpeningbalance with change in condition.      
	      
	Added two new parameters viz: @flag and @costcode.       
	These are used to display the bank transactions either for all the branches or for a particular branch       
	Depending on the @flag value       
	If @flag = 0  then show bank transaction for all the branches      
	If @flag = 1 then show bank transaction for a selected branch (i.e for the passed costcode )      

	Version modified by Deepak Maharishi ON Apr 3 2007
		1. Removed Cursors and used simple assignments for all values
		2. Made changes to get the Balance in one query instead of seperate queries for Opening Balance
		2. Corrected the Balance Computation to get Opening Balance as on Reconciliation Date - 1


exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 22 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 23 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 28 2007 23:59:59', 0,0,0
exec BrClosingBalance '103','Apr  1 2006 23:59:59','Mar 31 2007 23:59:59', 0,0,0


exec acc_PrintReconcile '103','STATEMENT', 'Mar 23 2007 23:59:59', 'Mar 23 2007 23:59:59'
***************************************************************************************************************************************************************************************************/      
    
  
CREATE  Procedure BrClosingBalance 
(
	@cltcode  varchar(10),      
	@sdtcur  varchar(11),      
	@fromdate varchar(11),      
	@vdtedtflag tinyint,      
	@flag   smallint,      
	@costcode  smallint      
)
     
AS      
      
Declare      
	@@openbaldt   varchar(11),      
	@@openentry   money,      
	@@openingbal   money,      
	@@startdate  datetime,      
	@@enddate  datetime 
  
	select @@startdate = sdtcur, @@enddate = ldtcur from parameter where @fromdate between sdtcur  and ldtcur  
  
	If @vdtedtflag = 0      
	begin      
	/*===============================================================================================================*/
		/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */      
	/*===============================================================================================================*/
		if @flag = 0       
		begin      
			select @@openingbal = 0      

			select 
				@@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0) 
			from 
				ledger 
			where 
				vdt >= @@startdate 
				and vdt <= @fromdate + ' 23:59:59'
				and cltcode = @cltcode      

			Select @@Openingbal       
		end      
		/*===============================================================================================================*/
			/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/      
		/*===============================================================================================================*/
		else if @flag = 1        
		begin       
			select @@openingbal = 0      
				
			select 
				@@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0) 
			from 
				ledger l,
				ledger2 l2      
			where 
				l.vtyp = l2.vtype 
				and l.vno = l2.vno 
				and l.lno = l2.lno 
				and vdt > = @@openbaldt   
				and vdt >= @@startdate 
				and vdt <= @fromdate + ' 23:59:59'
				and l.cltcode = @cltcode 
				and costcode = @costcode      
				
			select @@openingbal      
		end      

	end      
	else if @vdtedtflag = 1      
	begin      
	/*===============================================================================================================*/
		/*If the login is not branch and the user has selected the option 'ALL' as branches, so the user can view the transactions for all branches */      
	/*===============================================================================================================*/
		if @flag = 0       
		begin      
			select @@openingbal = 0      

			select 
				@@openingbal = isnull(sum(case drcr when 'd' then isnull(vamt,0) else isnull(-vamt,0) end),0) 
			from 
				ledger 
			where 
				vdt between @@startdate and @fromdate + ' 23:59:59'
				and edt <= @fromdate + ' 23:59:59'
				and cltcode = @cltcode 
				
			select @@openingbal      
		end       
		/*===============================================================================================================*/
			/*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/      
		/*===============================================================================================================*/
		else if @flag = 1        
		begin       
			select @@openingbal = 0      
				
			select 
				@@openingbal = isnull(sum(case l.drcr when 'd' then isnull(camt,0) else isnull(-camt,0) end),0) 
			from 
				ledger l,
				ledger2 l2      
			where  
				l.vtyp = l2.vtype 
				and l.vno = l2.vno 
				and l.lno = l2.lno 
				and vdt between @@startdate and @fromdate + ' 23:59:59' 
				and edt <= @fromdate + ' 23:59:59'
				and l.cltcode = @cltcode 
				and costcode = @costcode      

			select @@openingbal      
		end       
	end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bryearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 05/10/2004 5:29:30 PM ******/      
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 03/27/2003 11:33:03 AM ******/      
/****** Object:  Stored Procedure dbo.Bryearend    Script Date: 02/18/2003 10:26:56 AM ******/      
CREATE Procedure Bryearend      
@sdtcur varchar(11),      
@ldtcur varchar(11),      
@vtyp   smallint,      
@vno varchar(12),      
@BookType char(2),      
@vdt    datetime      
      
AS      
      
set transaction isolation level read uncommitted      
      
      
declare      
@@mainctrlac as varchar(10),      
@@mainacname as varchar(100),      
@@lno        as int,      
@@costcode   as tinyint,      
@@amt        as money,      
@@rcursor    as cursor      
      
      
select @@lno = ( select lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '99999' )      
select @@mainctrlac = ( select MainControlAc from branchAccounts where defaultac = 1)      
select @@mainacname = ( select acname from acmast where cltcode = @@mainctrlac )      
      
truncate table branchwiseclbal      
      
insert into branchwiseclbal      
select l2.cltcode, a.acname , costcode, balance=sum( case when upper(l2.drcr) = 'D' then camt else -camt end)      
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l      
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno      
and l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'      
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l2.cltcode not in (@@mainctrlac, '99999')      
group by costcode, l2.cltcode, a.acname      
      
set @@rcursor = cursor for      
select costcode, sum(balance)      
from branchwiseclbal      
group by costcode      
      
open @@rcursor      
fetch next from @@rcursor       
into @@costcode, @@amt      
      
while @@fetch_status = 0      
begin      
  insert into branchwiseclbal values( @@mainctrlac, @@mainacname, @@costcode, -(@@amt) )      
      
  fetch next from @@rcursor       
  into @@costcode, @@amt      
end      
      
close @@rcursor      
deallocate @@rcursor      
      
insert into ledger2       
select l.vtyp, l.vno, l.lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, l.booktype, b.cltcode      
from ledger l, branchwiseclbal b      
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and l.cltcode = b.cltcode       
      
insert into ledger2       
select @vtyp, @vno, @@lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, @booktype, cltcode      
from branchwiseclbal b      
where cltcode in ( select brcontrolac from branchAccounts )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------

CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK]
 @FILENAME VARCHAR(200),                
 @TABLE VARCHAR(50),
 @BANK_TYPE VARCHAR(10),
 @STAT_TYPE VARCHAR(10),
 @LOGIN VARCHAR(10),
 @PWD VARCHAR(15)
  
AS                
 DECLARE @@SQL AS VARCHAR(4000)                
 DECLARE @@FNAME AS VARCHAR(200)                
  
 SELECT @@FNAME = 'C:\TESTIMPORT.TXT'                
 CREATE TABLE #TESTIMPORT                
 (                
 OneRow Varchar(2000),              
 SNO INT IDENTITY(1,1)              
 )                
  
SET NOCOUNT ON                
  
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
PRINT @@SQL
EXEC(@@SQL)     

IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	DELETE FROM #TESTIMPORT WHERE SNO <= (SELECT SNO FROM #TESTIMPORT WHERE LEFT(ONEROW, 8) = 'TXN_DATE')
END

DELETE FROM #TESTIMPORT WHERE SNO = 1              
  
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL                
  
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)                
  
SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT                

DROP TABLE #TESTIMPORT                
  
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1  

DROP TABLE #TESTIMPORT1                

SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + "', no_output"
PRINT @@SQL
EXEC (@@SQL)

DROP TABLE TESTIMPORT

IF @BANK_TYPE = 'CITYRECO'
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB'
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
END
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'UTIRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"
END
ELSE IF @BANK_TYPE = 'ICICIRECO' 
BEGIN
	SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"
END
PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculatePL
-- --------------------------------------------------


CREATE  Proc CalculatePL 
@fromdate varchar(11),
@todate varchar(11),
@branchcd varchar(20),
@showZero varchar(1) = 'N'
As
Begin
	set nocount on
	begin transaction
	delete from PLgroup_mstr 
	/*for group details*/
	insert into PLgroup_mstr(Group_Code,Group_Name,Main_group,Amount,Type)	
	select Group_Code=ltrim(rtrim(Grpcode)),Group_Name=ltrim(rtrim(Grpname)),
	Main_group=case when ltrim(rtrim(Grpcode)) = GrpMain then '' else ltrim(rtrim(GrpMain)) end,Amount=0,type='G'
	from grpmast where (GrpMain like 'X%' or GrpMain like 'N%')
	/*for group details*/

	/*for account details*/
	if ltrim(rtrim(@branchcd)) = ''
	begin
		-- For HO
		insert into PLgroup_mstr(Group_Code,Group_Name,Main_group,Amount,type)	
		select Group_Code=ltrim(rtrim(l.Cltcode)),Group_Name=ltrim(rtrim(l.Acname)),Main_group=ltrim(rtrim(grpcode)),
		Amount= sum(case when drcr = 'C' then Vamt * -1 else Vamt end),type='A'
		from ledger l left outer join acmast a on l.Cltcode = a.Cltcode
		where exists(select group_code from PLgroup_mstr m where m.group_code = a.grpcode) 
		and l.vdt >= Convert(datetime,@fromdate + ' 00:00:00')  and l.vdt <= Convert(datetime,@todate + ' 23:59:59')
		group by l.Cltcode,l.Acname,grpcode
	end
	else
	begin
		-- For branches
		insert into PLgroup_mstr(Group_Code,Group_Name,Main_group,Amount,type)	
		select Group_Code=ltrim(rtrim(l.Cltcode)),Group_Name=ltrim(rtrim(a.Acname)),Main_group=ltrim(rtrim(a.grpcode)),
		Amount= sum(case when l.drcr = 'C' then Camt * -1 else Camt end),type='A'
		from ledger2 l 
		left outer join ledger l1 on l1.Vtyp = l.Vtype and l1.Booktype = l.Booktype and l1.Vno = l.Vno and l1.Lno = l.Lno and l1.cltcode = l.Cltcode
		left outer join acmast a on l.Cltcode = a.Cltcode
		left outer join costmast m on l.costcode = m.costcode
		where exists(select group_code from PLgroup_mstr m where m.group_code = a.grpcode) 
		and l1.vdt >= Convert(datetime,@fromdate + ' 00:00:00')  and l1.vdt <= Convert(datetime,@todate + ' 23:59:59')
		and m.costname = @branchcd
		group by l.Cltcode,a.Acname,a.grpcode
	end


	select *,Reclevel = dbo.GetGrouplevels(Group_Code) 
	into #tmppl 
	from PLgroup_mstr
	order by Reclevel,group_code

	Commit transaction
	declare @@Groupcode varchar(20),
	@@Reclevel int

	declare rscursor  cursor for
	select distinct Group_code,Reclevel
	from #tmppl 
	WHERE TYPE = 'G'
	order by Reclevel desc
	open rscursor  
	fetch next from rscursor into @@Groupcode,@@Reclevel 
	while @@fetch_status = 0
	begin
		update #tmppl set amount = isnull((select sum(amount) from #tmppl t1 where  t1.main_group = @@Groupcode),0)
		from #tmppl t where type = 'G' and group_code = @@Groupcode
	fetch next from rscursor into @@Groupcode,@@Reclevel 
	end
	
	close rscursor
	deallocate rscursor

	if @showZero = 'Y'
		begin
			select Group_Code=Group_Code,Group_Name= case when type = 'A' then 'A/C :' + Group_Name else Group_Name end,
			Main_group,Amount,type,Reclevel 
			from #tmppl order by Reclevel asc 
		end
	else
		begin
			select Group_Code=Group_Code,Group_Name= case when type = 'A' then 'A/C :' + Group_Name else Group_Name end,
			Main_group,Amount,type,Reclevel 
			from #tmppl WHERE amount <> 0 order by Reclevel asc 
		end


	drop table #tmppl 


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CheckMarginopbal
-- --------------------------------------------------
 /****** Object:  Stored Procedure dbo.CheckMarginopbal    Script Date: 03/28/2003 4:33:12 PM ******/  
CREATE Procedure CheckMarginopbal  
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime  
  
as  
  
select l.lno, l.cltcode, amt=(case when upper(drcr) = 'D' then vamt else -vamt end), t.bal  
from ledger l left outer join acmast a on l.cltcode = a.cltcode,  
(select mcltcode, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)  
from marginledger where vdt >= @sdtcur + ' 00:00:00' and vdt <= @ldtcur + ' 23:59:59'  
group by mcltcode) t  
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno  
and a.accat = 14 and t.mcltcode = l.cltcode and   
(case when upper(drcr) = 'D' then vamt else -vamt end) <> bal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUND_BALANCE_BSEFO
-- --------------------------------------------------

CREATE PROC [dbo].[CLIENT_FUND_BALANCE_BSEFO]

AS

declare @acyearfrom as datetime,@acyearto as datetime
select @acyearfrom=sdtcur,@acyearto=ldtcur from parameter (nolock) 
where sdtcur <=getdate() and ldtcur >=getdate()




select a.* into
#temp
from
(

select a.cltcode,b.acname, Fund_balance=sum(case when drcr='D' then -vamt else vamt end)  from ledger a (nolock) 
left outer join 
acmast b
on a.cltcode=b.cltcode
where a.vdt >=@acyearfrom and a.vdt<=getdate()
and a.cltcode in 
(select cltcode from acmast where grpcode='A0202000000'
and cltcode not in (select cltcode from intranet.roe.dbo.ff_bank_details where segment='BSEFO' and cltcode <> 0)
) 
group by a.cltcode, b.acname
) a

select * from #temp
union all
select 'TOTAL','' ,sum(fund_balance) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER2_FORMULA_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_GET_ACC_LEDGER2_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@COSTCODE INT = 0,
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT
	@REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE

IF @EXCHANGE = '' BEGIN
SELECT
	@EXCHANGE = EXCHANGE
	,@SEGMENT = SEGMENT
FROM OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10 SELECT
	@FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10 BEGIN
SELECT
	@EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT
	@START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
, @MAX_BILL_DATE VARCHAR(11)

DECLARE @servername varchar(20)='ANAND1.ACCOUNT.DBO'

SELECT
	@MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (SELECT TOP 2
		*
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC) A

CREATE TABLE #REPORT_DATA(CLTCODE VARCHAR(10)
, VDTBAL_OPBAL MONEY
, EDTBAL_OPBAL MONEY
, VDTBAL_DATES MONEY
, EDTBAL_DATES MONEY
, VDTBAL_DATES_CREDIT MONEY
, VDTBAL_DATES_DEBIT MONEY
, EDTBAL_DATES_CREDIT MONEY
, EDTBAL_DATES_DEBIT MONEY
, VDTBAL MONEY
, EDTBAL MONEY
, VDTBAL_RECEIPT MONEY
, T_DAY_BILL MONEY
, T1_DAY_BILL MONEY
, VDTBAL_BILL_DR MONEY
, VDTBAL_BILL_CR MONEY
, VDTBAL_NONBILL MONEY
, EDTBAL_RECEIPT MONEY
, EDTBAL_BILL_DR MONEY
, EDTBAL_BILL_CR MONEY
, EDTBAL_NONBILL MONEY
, FDT_RECEIPT MONEY
, FDT_CREDIT_BILLS MONEY
, FDT_DEBIT_BILLS MONEY
, FDT_CR MONEY
, FDT_DR MONEY
, MARGIN_BAL MONEY)

DECLARE @@SQL VARCHAR(MAX)

INSERT INTO #REPORT_DATA
	SELECT
		CLTCODE
		,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
		,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
		,VDTBAL_DATES = SUM(VDTBAL_DATES)
		,EDTBAL_DATES = SUM(EDTBAL_DATES)
		,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
		,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
		,EDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,VDTBAL = SUM(VDTBAL)
		,EDTBAL = SUM(EDTBAL)
		,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
		,T_DAY_BILL = SUM(T_DAY_BILL)
		,T1_DAY_BILL = SUM(T1_DAY_BILL)
		,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
		,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
		,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
		,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
		,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
		,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
		,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
		,FDT_RECEIPT = SUM(FDT_RECEIPT)
		,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
		,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
		,FDT_CR = SUM(FDT_CR)
		,FDT_DR = SUM(FDT_DR)
		,MARGIN_BAL = 0
	FROM (SELECT
			CLTCODE = L.CLTCODE
			,VDTBAL_OPBAL =
							CASE
								WHEN (VDT >= @START_DATE AND
									VDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_OPBAL =
							CASE
								WHEN (EDT >= @START_DATE AND
									EDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_DATES =
							CASE
								WHEN VDT >= @FR_DATE AND
									VTYP <> 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_DATES =
							CASE
								WHEN EDT >= @FR_DATE AND
									VTYP <> 18 AND
									EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_DATES_CREDIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL_DATES_DEBIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_CREDIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_DEBIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL =
						CASE
							WHEN VDT >= @START_DATE THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END
			,EDTBAL =
						CASE
							WHEN EDT >= @START_DATE AND
								EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_RECEIPT =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END
			,T_DAY_BILL =
							CASE
								WHEN VDT LIKE @MAX_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,T1_DAY_BILL =
							CASE
								WHEN VDT LIKE @MIN_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_BILL_DR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_BILL_CR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_NONBILL =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END
			,EDTBAL_RECEIPT =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 2 THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_DR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'D' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_CR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'C' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_NONBILL =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,FDT_RECEIPT =
							CASE
								WHEN EDT > @EFFDATE + ' 23:59' AND
									VDT <= @EFFDATE + ' 23:59' AND
									VTYP = 2 THEN SUM(VAMT)
								ELSE 0
							END
			,FDT_CREDIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_DEBIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_CR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'C' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
			,FDT_DR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'D' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
		FROM	LEDGER L (NOLOCK)
				,LEDGER2 L2 (NOLOCK)
				,#FORMULA_CLIENT_MASTER A
		WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND L.VNO = L2.VNO
		AND L.VTYP = L2.VTYPE
		AND L.BOOKTYPE = L2.BOOKTYPE
		AND L.LNO = L2.LNO
		AND L.CLTCODE = L2.CLTCODE
		AND COSTCODE = @COSTCODE
		AND (
		VDT >= @START_DATE
		OR EDT >= @START_DATE
		)
		AND VDT <= @EFFDATE + ' 23:59'
		GROUP BY	L.CLTCODE
					,VDT
					,EDT
					,VTYP
					,L.DRCR) A
	GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT
	@ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0 BEGIN
UPDATE RD
SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD
, (SELECT
		PARTY_CODE
		,AMOUNT = SUM(CASE DRCR
			WHEN 'C' THEN AMOUNT
			ELSE -AMOUNT
		END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE
	AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE) ML
WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/


IF @TABLE_NAME <> '' SET @@SQL = "INSERT INTO "+ @servername +'.'+@TABLE_NAME +" SELECT " ELSE SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> '' SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> '' SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING

--END

PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_GLLEDGER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10),
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
	
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)
	
DECLARE @servername as varchar(20) = 'ANAND1.ACCOUNT.DBO'


CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


SET @@COSTCODE = -1

IF @BRANCHCODE <> '' OR @BRANCHCODE <> '%'
BEGIN
	SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCHCODE
END

CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL,VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = ' -AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL, EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = '-AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
SET @@SQL = @@SQL + "WHERE CLTCODE >= '" + @FROM_GL_CODE + "' AND CLTCODE <= '" + @TO_GL_CODE + "'"
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + " AND ACCAT = 3 "
ELSE IF UPPER(@VIEWOPTION) = 'BANK'
	SET @@SQL = @@SQL + " AND ACCAT = 2 "	
ELSE IF UPPER(@VIEWOPTION) = 'CASH'
	SET @@SQL = @@SQL + " AND ACCAT = 1 "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
print'sss'
PRINT @@SQL
EXEC(@@SQL)	
print 'dd'


IF UPPER(@STATUSID) = 'BROKER' AND @@COSTCODE = -1
BEGIN

	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', '',''
END
ELSE
BEGIN
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE','',@@COSTCODE, ''
	
END

DROP TABLE #FORMULA_CLIENT_MASTER


SET @@SQL = "INSERT INTO " + @servername +'.'+@TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_RAZORPAY_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_RAZORPAY_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN
DECLARE @SQL NVARCHAR(800)
SET @SQL = ''
SET @SQL = @SQL + ' SELECT * INTO ##CLSRECONTABLE FROM CLSRECONTABLE_'+@UPLOADID
SET @SQL = @SQL + ' DROP TABLE CLSRECONTABLE_'+@UPLOADID

PRINT @SQL
EXEC(@SQL)

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)

	SELECT
	(SELECT UPLOADID FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'UPLOADID'
	,SEGMENT_NAME AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,REF_NO+'_'+CLIENT_CODE +'_'+ SETTLEMENT_UTR+'_'+SEGMENT_NAME AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,'C' AS 'DRCR'	
	,CAST (RTRIM(LTRIM(AMOUNT)) AS DECIMAL(20,2)) AS 'AMOUNT'
	,CONVERT(DATETIME, RTRIM(LTRIM(SETTLEMENT_INITIATED_ON)), 103) AS 'VALUEDATE'
	, REF_NO AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM ##CLSRECONTABLE
	WHERE ISNULL(AMOUNT , '')<>''
	
	DROP TABLE ##CLSRECONTABLE
	--DELETE FROM #NONCMS_DATA WHERE BANKACCOUNT<>'NSE'
	--SELECT * FROM #NONCMS_DATA WHERE BANKACCOUNT='NSE'
	--return
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delete_Ledger
-- --------------------------------------------------
 CREATE Procedure Delete_Ledger  
@vno varchar(12)  
as  
delete from ledger where vtyp = '18' and booktype = '01' and vno= @vno  
  
delete from ledger2 where vtype = '18' and booktype = '01' and vno= @vno  
  
delete from ledger3 where vtyp = '18' and booktype = '01' and vno= @vno  
  
delete from marginledger where vtyp = '18' and booktype = '01' and vno= @vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.disp_ledger
-- --------------------------------------------------
create proc disp_ledger
(
@cltcode varchar(25)
)
as
declare @acyearfrom as datetime,@acyearto as datetime
select @acyearfrom=sdtcur,@acyearto=ldtcur from parameter (nolock) 
where sdtcur <=getdate() and ldtcur >=getdate()

select * from ledger a (nolock) 
where vdt >=@acyearfrom and vdt<=getdate()
and a.cltcode = @cltcode

return

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------



CREATE PROC [dbo].[DRCRNOTEUPLOAD_BULK]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2)
AS
/*
	DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'
	EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'
	EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'
	BEGIN TRAN
	DELETE FROM V2_UPLOADED_FILES
		WHERE U_FILENAME = 'D:\BackOffice\DrCrNotes\Sample.Csv' AND U_MODULE = 'DRCR NOTE UPLOAD'
	Exec DRCRNOTEUPLOAD_BULK 'D:\BackOffice\DrCrNotes\Sample.Csv', 'B_JAYDEEP', 6, '01' 
	SELECT @@TRANCOUNT
	SELECT * FROM #RECPAY_TABLE
	ROLLBACK
	SP CREATED BY		-	YATIN
	SP CREATED ON		-	JUL, 24 2006
*/
	SET NOCOUNT ON
	SELECT @UNAME = 'B_' + LTRIM(RTRIM(@UNAME))
	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT,
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT,
		@@L2CUR AS CURSOR,
		@@BRANCHFLAG AS SMALLINT,
		@@L2VNO AS VARCHAR(12)
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN TRAN
	IF @VTYP = 8
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'JV UPLOAD') A
		END
	ELSE
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'DRCR NOTE UPLOAD') A
		END

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END


	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		COSTCODE SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]

	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO INT ,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SOME ERROR IN BULK UPLOAD, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	IF @VTYP = 8
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'JV UPLOAD'
		END
	ELSE
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'DRCR NOTE UPLOAD'
		END

	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		DRCR,
		AMOUNT,
		NARRATION)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234)
	FROM #RECPAY_TABLE_TMP

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SYSTEM ERROR, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	UPDATE
		#RECPAY_TABLE
	SET
		VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
		EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2))

	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
		@@BRANCHFLAG = BRANCHFLAG
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = C.COSTCODE
		      FROM ACMAST A, PARAMETER P, COSTMAST C
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = C.COSTNAME
		      AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = 'ALL'
		END
	ELSE
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		END

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE NOT FALLING IN THE RESPECTIVE FINANCIAL YEAR.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/
	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE #RECPAY_TABLE
				SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE COSTCODE IS NULL
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/
	SELECT @@ERROR_COUNT = 0
	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
--			DROP TABLE #RECPAY_TABLE_TMP
--			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL
			SELECT DISTINCT
				CLTCODE
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END



/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/

	SELECT
		@@NOREC = COUNT(DISTINCT SRNO)
	FROM
		#RECPAY_TABLE

	IF @@VNOMETHOD = 0
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, RIGHT(@@STD_DATE, 4) + '00000000') + @@NOREC)
					SELECT @@VNO = RIGHT(@@STD_DATE, 4) + '00000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@STD_DATE, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 1
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + RIGHT('0' + LTRIM(RTRIM(CONVERT(VARCHAR(2), DAY(@@VDT)))), 2) + '0001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND VDT BETWEEN @@VDT AND @@VDT + ' 23:59'
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END
	ELSE IF @@VNOMETHOD = 2
		BEGIN
			SELECT
				@@MAXVNO = CONVERT(VARCHAR(12), ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0))
			FROM
				LASTVNO WITH (TABLOCKX,HOLDLOCK)
			WHERE
				VTYP = @VTYP
				AND BOOKTYPE = @BOOKTYPE
				AND MONTH(VDT) = MONTH(@@VDT)
				AND YEAR(VDT) = YEAR(@@VDT)
			IF @@MAXVNO = '0'
				BEGIN
					SELECT @@MAXVNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000000'
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO) + @@NOREC)
					SELECT @@VNO = RIGHT(@@VDT, 4) + RIGHT('0' + RTRIM(LTRIM(CONVERT(VARCHAR(2), MONTH(@@VDT)))), 2) + '000001', @@RCOUNT = 0
				END
			ELSE
				BEGIN
					SELECT @@VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+1), @@RCOUNT = 1
					SELECT @@MAXVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, @@MAXVNO)+@@NOREC)
				END
			IF @@RCOUNT = 1
				BEGIN
					UPDATE
						LASTVNO
					SET
						LASTVNO = @@MAXVNO
					WHERE
						VTYP = @VTYP
						AND BOOKTYPE = @BOOKTYPE
						AND MONTH(VDT) = MONTH(@@VDT)
						AND YEAR(VDT) = YEAR(@@VDT)
				END
			ELSE
				BEGIN
					INSERT INTO
						LASTVNO
						(VTYP, BOOKTYPE, VDT, LASTVNO)
					VALUES
						(@VTYP, @BOOKTYPE, @@VDT, @@MAXVNO)
				END
		END

	UPDATE
		#RECPAY_TABLE
	SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)


/* '--------------------------AUTO GENERATION OF LNO ------------------------*/

	SET @@LNOCUR = CURSOR FOR
		SELECT DISTINCT SRNO FROM #RECPAY_TABLE
	OPEN @@LNOCUR
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO #RECPAY_TABLE_LNO
				(SNO)
			SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO
			UPDATE RP
				SET LNO = RL.LNO
			FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
			WHERE RP.SNO = RL.SNO
			TRUNCATE TABLE #RECPAY_TABLE_LNO
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
		END
	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR
	DROP TABLE #RECPAY_TABLE_LNO

/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/
/*==============================
      LEDGER RECORD
==============================*/
	INSERT
	INTO LEDGER
	SELECT
		VTYP = @VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMOUNT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMOUNT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE,
		BOOKTYPE = @BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		#RECPAY_TABLE

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			SELECT 'DUE TO SOME ERROR IN LEDGER POSTING, FILE COULD NOT BE UPLOADED.'
			RETURN
		END
/*==============================
	LEDGER3 RECORD
==============================*/
	INSERT
	INTO LEDGER3
	SELECT
		NARATNO = LNO,
		NARRATION,
		REFNO = 0,
		VTYP = @VTYP,
		VNO,
		BOOKTYPE = @BOOKTYPE
      FROM
		#RECPAY_TABLE



	IF @@BRANCHFLAG = 1
		BEGIN
			DELETE FROM TEMPLEDGER2
				WHERE SESSIONID = '9999999999'
			INSERT INTO TEMPLEDGER2
			SELECT
				'BRANCH',
				C.COSTNAME,
				AMOUNT,
				VTYP = @VTYP,
				VNO,
				LNO,
				DRCR,
				'0',
				BOOKTYPE = @BOOKTYPE,
				SESSIONID = '9999999999',
				CLIENT_CODE = CLTCODE,
				'A',
				'0'
			FROM
				#RECPAY_TABLE RP,
				COSTMAST C
			WHERE
				RP.COSTCODE = C.COSTCODE
		
			SET @@L2CUR = CURSOR FOR
				SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO
			OPEN @@L2CUR
			FETCH NEXT FROM @@L2CUR INTO @@L2VNO
			WHILE @@FETCH_STATUS = 0
				BEGIN
					EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'
					IF @@ERROR <> 0
						BEGIN
							ROLLBACK TRAN
							IF @VTYP = 8
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
								END
							ELSE
								BEGIN
									DELETE FROM V2_UPLOADED_FILES
										WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
								END
							SELECT 'DUE TO SOME ERROR IN LEDGER2 POSTING, FILE COULD NOT BE UPLOADED.'
							RETURN
						END
					FETCH NEXT FROM @@L2CUR INTO @@L2VNO
				END
				DELETE FROM TEMPLEDGER2
					WHERE SESSIONID = '9999999999'
				CLOSE @@L2CUR
				DEALLOCATE @@L2CUR
		END
	COMMIT TRAN
	SELECT RESULT = 'Data Uploaded Successfully'
	UNION ALL
	SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE
	DROP TABLE #RECPAY_TABLE_TMP
	DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Edtyearend
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 05/10/2004 5:29:33 PM ******/    
/****** Object:  Stored Procedure dbo.Edtyearend    Script Date: 02/18/2003 10:26:56 AM ******/    
CREATE Procedure  Edtyearend    
@sdtcur varchar(11),    
@ldtcur varchar(11),    
@vtyp   smallint,    
@vno varchar(12),    
@BookType char(2),    
@vdt    datetime,    
@msg1   varchar(234)    
AS    
    
set transaction isolation level read uncommitted    
    
declare    
@@netdiff as money    
    
    
truncate table edtclbal    
    
insert into edtclbal    
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)    
from ledger l left outer join acmast a on l.cltcode = a.cltcode    
where l.edt > = @sdtcur + ' 00:00:00' and l.edt <= @ldtcur + ' 23:59:59'    
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> '99999'    
group by l.cltcode,l.acname    
order by l.cltcode,l.acname    
    
update ledger set balamt = e.balance from edtclbal e    
where ledger.vtyp = @vtyp and ledger.booktype = @booktype and ledger.vno = @vno and ledger.cltcode = e.cltcode    
    
select @@netdiff = ( select sum(balance) from edtclbal )    
    
update ledger set balamt = isnull( case when @@netdiff > = 0 then -(@@netdiff) else abs(@@netdiff) end,0)    
where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '99999'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA
-- --------------------------------------------------





--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
create PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT
-- --------------------------------------------------
 
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT]      
 @EFFDATE VARCHAR(11), 
  @CLTCODE VARCHAR(12),
 @SESSIONID VARCHAR(500),    
 @PROCESS_CODE VARCHAR(10),    
 @REPORT_FORMULA VARCHAR(MAX),  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(50),
 @TABLE_NAME VARCHAR(20) = '' 
AS      
    
DECLARE      
 @START_DATE VARCHAR(11)      
      
IF LEN(@EFFDATE) = 10      
BEGIN      
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)      
END      
      
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)      
FROM PARAMETER      
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR      
    
    
--CREATE TABLE #REPORT_DATA    
--(    
-- CLTCODE VARCHAR(10),    
-- PARTY_NAME VARCHAR(100),       
-- ENTITY_LEVEL VARCHAR(20),    
-- ENTITY_CODE VARCHAR(25),      
-- VDTBAL MONEY,      
-- EDTBAL MONEY,      
-- FDT_RECEIPT MONEY,      
-- FDT_PAYMENTS MONEY,  
-- MARGIN_BAL MONEY    
--)    
    
DECLARE    
 @@SQL VARCHAR(MAX)    
    
SELECT       
 CLTCODE = L.CLTCODE,    
 VDTBAL = SUM(CASE WHEN VDT >= @START_DATE THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),      
 EDTBAL = SUM(CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END       
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN (CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),      
 FDT_RECEIPT = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN (VAMT) ELSE 0 END) ,      
 FDT_PAYMENTS = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN (VAMT) ELSE 0 END ) INTO #LEDGER
FROM       
 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT  CLTCODE,VDT,VTYP,EDT,DRCR,VAMT  FROM LEDGER (NOLOCK) WHERE 
 --(VDT >= @START_DATE OR 
 CLTCODE =@CLTCODE AND
 EDT >= @START_DATE
  AND CDT <= DATEADD(MI, -15, GETDATE())
 --)      
 AND VDT <= @EFFDATE + ' 23:59' --AND CDT <= DATEADD(MI, -15, GETDATE())
 )    L 
 GROUP BY CLTCODE /*    
 LEFT OUTER JOIN (SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1  
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,  */
 
 
 
 --INSERT INTO #REPORT_DATA      
SELECT       
 L.CLTCODE,    
 PARTY_NAME,       
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = SUM(VDTBAL),      
 EDTBAL = SUM(EDTBAL),      
 FDT_RECEIPT = SUM(FDT_RECEIPT),      
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),  
 MARGIN_BAL = 0  INTO #REPORT_DATA      
FROM      
 #LEDGER L (Nolock)  ,
 FORMULA_CLIENT_MASTER A    (Nolock)  
WHERE      
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID    
 GROUP BY       
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE --, L1.RELDT      
      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0 
/*
UPDATE R SET R.FDT_RECEIPT = A.FDT_RECEIPT, R.FDT_PAYMENTS = A.FDT_PAYMENTS
FROM #REPORT_DATA R, (SELECT CLTCODE, FDT_RECEIPT = SUM(CASE WHEN L1.VTYP = 2 THEN VAMT ELSE 0 END),
FDT_PAYMENTS = SUM(CASE WHEN L1.VTYP = 3 THEN VAMT ELSE 0 END) FROM
(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE VDT <= @EFFDATE + ' 23:59')    L,    
(SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '') and CLEAR_MODE <> 'C') L1  
 WHERE L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO
AND L1.VTYP IN(2, 3)  
GROUP BY CLTCODE ) A
WHERE R.CLTCODE = A.CLTCODE
 */ 
/*  
UPDATE RD SET MARGIN_BAL = ML.AMOUNT  
FROM #REPORT_DATA RD, (  
 SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)  
 FROM MARGINLEDGER ML  
 WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'  
 GROUP BY PARTY_CODE  
)ML  
WHERE RD.CLTCODE = PARTY_CODE  
*/  
--IF @TABLE_NAME <> ''
--BEGIN
--	SET @@SQL = " TRUNCATE TABLE " + @TABLE_NAME  
--	EXEC (@@SQL)
--END

--IF @TABLE_NAME <> ''
--   SET @@SQL = " INSERT INTO " + @TABLE_NAME + " SELECT "    
--ELSE
SET @@SQL = " SELECT "   
 
SET @@SQL = @@SQL + " CLTCODE, "    
SET @@SQL = @@SQL + " PARTY_NAME, "    
SET @@SQL = @@SQL + " ENTITY_LEVEL,"    
SET @@SQL = @@SQL + " ENTITY_CODE, "    
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "    
SET @@SQL = @@SQL + " FROM "    
SET @@SQL = @@SQL + " #REPORT_DATA"    

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetBillDataSum
-- --------------------------------------------------



CREATE Proc GetBillDataSum
 @BillDate As Varchar(11), 
 @ShareDb As Varchar(15), 
 @DispOpt As Varchar(7) = 'Summary'
--Exec GetBillDataSum '2004042', 'N', 'MSAJAG', 'Details'
--Exec GetBillDataSum '2004059', 'A ', 'MSAJAG'
As
Declare
@@SQLQry As Varchar(2000)
Set @@SQLQry = "Select Party_Code, M.Acname, Round(Amount,2) As Amount, Sell_Buy, Bill_No From " + @ShareDb
Set @@SQLQry = @@SQLQry + ".Dbo.BFoAccBill a, Acmast m  WITH(NOLOCK)"
Set @@SQLQry = @@SQLQry + " Where BillDate Like '" + @BillDate + "%' "
Set @@SQLQry = @@SQLQry + " And A.party_code = M.Cltcode and branchcd = 'ZZZ' "
--Set @@SQLQry = @@SQLQry + " And Round(Amount,2) <> 0 "
Set @@SQLQry = @@SQLQry + " union all "
If @DispOpt = 'Summary'
 Begin
  Set @@SQLQry = @@SQLQry + " Select 'Party Dr', 'Party Amount Receivables', Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.BFoAccBill a, "
  Set @@SQLQry = @@SQLQry + " Acmast m  where BillDate Like '" + @BillDate + "%' "
  Set @@SQLQry = @@SQLQry + " And A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
  Set @@SQLQry = @@SQLQry + " union all "
 End
Else
 Begin
  Set @@SQLQry = @@SQLQry + " Select Party_Code ,M.AcName, Round(sum(Amount),2) As Amount, Sell_buy, bill_no "
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.BFoAccBill a, "
  Set @@SQLQry = @@SQLQry + " Acmast M  where BillDate Like '" + @BillDate + "%' "
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4  and sell_buy = '1' "
  Set @@SQLQry = @@SQLQry + " group by Party_Code ,M.AcName, bill_no, Sell_Buy "
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
  Set @@SQLQry = @@SQLQry + " union all "
 End
If @DispOpt = 'Summary'
 Begin
  Set @@SQLQry = @@SQLQry + " Select 'Party CR', 'Party Amount Payables', Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.BFoAccBill a, acmast m "
  Set @@SQLQry = @@SQLQry + " where BillDate Like '" + @BillDate + "%' "
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
  Set @@SQLQry = @@SQLQry + " group by bill_no, Sell_Buy "
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
 End
Else
 Begin
  Set @@SQLQry = @@SQLQry + " Select Party_Code, M.AcName, Round(sum(Amount),2) As Amount,Sell_buy, bill_no "
  Set @@SQLQry = @@SQLQry + " from "+ @ShareDb + ".dbo.BFoAccBill a, acmast m "
  Set @@SQLQry = @@SQLQry + " where BillDate Like '" + @BillDate + "%' "
  Set @@SQLQry = @@SQLQry + " and A.party_code = M.cltcode and m.accat = 4   and sell_buy = '2' "
  Set @@SQLQry = @@SQLQry + " group by Party_Code, M.AcName, bill_no, Sell_Buy "
--  Set @@SQLQry = @@SQLQry + " Having Round(sum(Amount),2) <> 0 "
 End
Print @@SQLQry
Exec(@@SQLQry)
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETDATA_EDIT_All
-- --------------------------------------------------
CREATE PROC [dbo].[GETDATA_EDIT_All]        
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */                
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */            
@VTYP INT,        
@BANKCODE VARCHAR(10),    
@VNO_FR VARCHAR(12),        
@VNO_TO VARCHAR(12),        
@VDT VARCHAR(11) = '',        
@VAMT MONEY = 0,          
@BOOKTYPE VARCHAR(3),        
@CLTCODE VARCHAR(10) = '',        
@PageSize varchar(3) = '25'        
AS        
        
CREATE TABLE #GETDATA_EDIT        
(        
 VNO VARCHAR(12),         
 CLTCODE VARCHAR(10),         
 ACNAME VARCHAR(100),         
 VAMT MONEY,         
 NARRATION VARCHAR(250),         
 DDNO VARCHAR(20),         
 RELDT VARCHAR(10),        
 BNKNAME VARCHAR(35),    
 VDT VARCHAR(10),
 LNO INT        
)        
        
DECLARE        
@@SQL VARCHAR(1000)        
        
SET @@SQL = " INSERT INTO #GETDATA_EDIT "        
SET @@SQL = @@SQL + " SELECT TOP " + @PageSize      
SET @@SQL = @@SQL + " L.VNO, CLTCODE, ACNAME, VAMT = CASE L.DRCR WHEN 'D' THEN -VAMT ELSE VAMT END, NARRATION, DDNO, RELDT = CONVERT(VARCHAR(10), RELDT, 103), BNKNAME, CONVERT(VARCHAR(10), VDT, 103), L.LNO "        
SET @@SQL = @@SQL + " FROM "        
SET @@SQL = @@SQL + " LEDGER L, LEDGER1 L1 "        
SET @@SQL = @@SQL + " WHERE "        
SET @@SQL = @@SQL + " L.VNO = L1.VNO "        
SET @@SQL = @@SQL + " AND L.VTYP = L1.VTYP "        
SET @@SQL = @@SQL + " AND L.BOOKTYPE = L1.BOOKTYPE "        
IF @VTYP = 5 
BEGIN
SET @@SQL = @@SQL + " AND L.LNO = L1.LNO "        
END
IF @VTYP <> 5 
BEGIN
	SET @@SQL = @@SQL + " AND L.LNO =1 "        
END
--SET @@SQL = @@SQL + " AND L.VNO = L2.VNO "        
--SET @@SQL = @@SQL + " AND L.VTYP = L2.VTYP "        
--SET @@SQL = @@SQL + " AND L.BOOKTYPE = L2.BOOKTYPE "        
SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @BANKCODE + "'"     
IF @VDT = ''         
 BEGIN         
 SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "    
END    
ELSE    
BEGIN    
 SET @@SQL = @@SQL + " AND VDT LIKE '" + @VDT + "%' "    
END    
SET @@SQL = @@SQL + " AND L.VTYP = " + CONVERT(VARCHAR, @VTYP)        
SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @VNO_FR + "' AND '" + @VNO_TO +"' "        
SET @@SQL = @@SQL + " AND L.BOOKTYPE = '" + @BOOKTYPE + "' "      
      
IF @VAMT <> 0        
 BEGIN        
 SET @@SQL = @@SQL + " AND L.VAMT = " + CONVERT(VARCHAR,@VAMT) + " "        
 END        
        
IF @CLTCODE <> ''        
 BEGIN        
 SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @CLTCODE + "' "        
 END        
        
/*IF @VDT = ''         
 BEGIN         
  SET @@SQL = @@SQL + " AND L.VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "        
 END         
ELSE         
 BEGIN         
  SET @@SQL = @@SQL + " AND L.VDT LIKE '" + @VDT + "%' "        
 END     */    
  SET @@SQL = @@SQL + " ORDER BY L.VNO "        
      
print @@SQL    
EXEC (@@SQL)        
        
/*DELETE FROM #GETDATA_EDIT        
WHERE         
EXISTS         
 (    
  SELECT VNO FROM LEDGER L WHERE L.VNO = #GETDATA_EDIT.VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE        
  GROUP BY VNO, VTYP, BOOKTYPE HAVING COUNT(1) > 2       
 )*/        

IF @VTYP = 5
BEGIN
	UPDATE G SET RELDT = L1.RELDT FROM #GETDATA_EDIT G, LEDGER1 L1
	WHERE L1.VNO = G.VNO AND L1.VTYP = @VTYP AND L1.RELDT <> ''
END
        
SELECT * FROM #GETDATA_EDIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETPARADATE
-- --------------------------------------------------

CREATE PROC GETPARADATE
/*
	EXEC GETPARADATE 'DEC  1 2006', 'DEC 15 2006'
	EXEC GETPARADATE '01/12/2006', '15/12/2006'
Exec GETPARADATE '01/04/2006', '09/05/2006' 
*/
	@@FROMDT AS VARCHAR(11),
	@@TODT AS VARCHAR(11)
AS
DECLARE
	@@DIFF AS INT,
	@@ISBRIT AS TINYINT

SELECT @@ISBRIT = 0
IF LEN(LTRIM(RTRIM(@@FROMDT))) = 10
	BEGIN
		SELECT @@FROMDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@FROMDT, 103),109)
		SELECT @@ISBRIT = 1
	END
IF LEN(LTRIM(RTRIM(@@TODT))) = 10
	BEGIN
		SELECT @@TODT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 103),109)
	END


SELECT @@DIFF = 0
SELECT @@DIFF = ISNULL(REPORTDAYS, 0) FROM PARAMETER WHERE @@TODT BETWEEN SDTCUR AND LDTCUR
IF @@DIFF = 0
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT @@FROMDT
			END
		ELSE
			BEGIN
				SELECT CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103)
			END
	END
ELSE
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 109) 
					ELSE CONVERT(VARCHAR(11), @@FROMDT, 109) 
				END 
				)
			END
		ELSE
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(10), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 103) 
					ELSE CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103) 
				END 
				)
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2
-- --------------------------------------------------







CREATE   PROC InsertToLedger2   
(
      @sessionid varchar(15),  
      @vno varchar(12),  
      @branchflag tinyint,  
      @costcenterflag tinyint,  
      @costenable char(1),  
      @statusid as varchar(30),  
      @statusname as varchar(30)  
) 

As  

set nocount on

declare  
      @@onlyall tinyint,  
      @@onebranch tinyint,  
      @@multibranch tinyint,  
      @@oneBranchAll tinyint,  
      @@MultiBranchall tinyint,  
      @@Allcount smallint,  
      @@Branchcount smallint,  
      @@OldBranch varchar(10),  
      @@vtype varchar(2),  
      @@party2 varchar(10),  
      @@costbreakup tinyint,  
      @@costcode1 int,  
  
/*=======================================================================================
      Fields retrived from templedger2 
=======================================================================================*/
      @@category varchar(20),  
      @@branch varchar(25),  
      @@amt    money,  
      @@vtyp varchar(2),  
      @@vno  varchar(12),  
      @@lno  int,  
      @@drcr char(1),  
      @@costcode smallint,  
      @@booktype varchar(2),  
      @@sessionid varchar(25),  
      @@party_code varchar(10),  
      @@mainbr as varchar(10),     
      @@rcursor as cursor  
  
if @branchflag = 1 and @costcenterflag  = 1  
begin  
/*=======================================================================================
      0 = True   1 = False    
=======================================================================================*/
      select @@onlyall = 0               /* True */  
      select @@onebranch = 1             /* True */  
      select @@multibranch = 1           /* False */  
      select @@onebranchall = 1          /* False */  
      select @@Multibranchall = 1        /* False */  
        
      select @@allcount = 0  
      select @@Branchcount = 0  
      select @@OldBranch = ''  
  
      SELECT @@mainbr = 
                  (
                        SELECT 
                              BranchName 
                        FROM branchaccounts 
                        WHERE DefaultAc = 1
                  ) 
  
      SELECT @@vtype = 
                  (
                        SELECT DISTINCT 
                              vtype 
                        FROM templedger2 
                        WHERE rtrim(sessionid) = rtrim(@sessionid) 
                              AND vno = @vno
                  ) 
     
      SELECT @@costbreakup = 
                  (
                        SELECT 
                              count(*) 
                        FROM templedger2 
                        WHERE rtrim(sessionid) = rtrim(@sessionid) 
                              AND category = 'BRANCH' 
                              AND vno = @vno 
                              AND costflag = 'C'
                  ) 
  
      /*=======================================================================================
            if @@vtype = 8 and @@costbreakup > 0  
      =======================================================================================*/
      if @@costbreakup > 0  
      begin  
            DELETE 
            FROM templedger2 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND upper(rtrim(branch)) = 'ALL' 
                  AND vno = @vno 
                  AND costflag = 'A' 
                  AND party_code in 
                        ( 
                              SELECT DISTINCT 
                                    party_code 
                              FROM templedger2 
                              WHERE costflag = 'C' 
                        ) 
      
            UPDATE 
                  templedger2 
                  SET costflag = 'A' 
      end  
  
	        if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24  
	        begin  
	              UPDATE 

	                    templedger2 
	                    SET branch = 'HO' 
	              WHERE upper(rtrim(branch)) = 'ALL' 
	                    AND costflag = 'A' 
	        end  
      set @@rcursor = cursor for  
            SELECT 
                  category,
                  branch,
                  paidamt,
                  vtype,
                  vno,
                  lno,
                  drcr,
                  costcode,
                  booktype,
                  sessionid,
                  party_code 
            FROM templedger2 
            WHERE category = 'BRANCH' 
                  AND rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno =@vno 
                  AND costflag = 'A' 
      open @@rcursor  
      fetch next from @@rcursor   
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code   
  
      while @@fetch_status = 0  
      begin  
            if rtrim(@@branch) = 'ALL'  
            begin  
                  select @@Allcount = @@Allcount + 1  
            end  
            else   
            if rtrim(@@branch) = @@OldBranch  
            begin  
                  select @@OnlyAll = 1  
            end  
            else  
            if @@OldBranch = ''  
            begin  
                  select @@OnlyAll = 1  
                  select @@OldBranch = rtrim(@@branch)  
                  select @@Branchcount = @@Branchcount + 1  
            end  
            else   
            begin  
                  select @@OnlyAll = 1  
                  select @@Branchcount = @@Branchcount + 1  
                  select @@Multibranch = 0  
                  select @@OneBranch = 1             
            end  
            
            fetch next from @@rcursor   
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code   
      end  
      close @@rcursor  
      deallocate @@rcursor  
  
/*      select "AllCount = " + convert(varchar,@@Allcount)  
      select "BranchCount = " + convert(varchar,@@BranchCount)  */
  
      if @@onlyall = 1  
      begin  
            if @@Allcount = 0  
            begin  
                  if @@branchcount = 1  
                  begin  
                        select @@onebranch = 0  
                        select @@multibranch = 1  
                        select @@oneBranchAll = 1  
                        select @@MultiBranchall = 1  
                  end  
                  else  
                  begin  
                        select @@Multibranch = 0  
                        select @@onebranch = 1  
                        select @@oneBranchAll = 1  
                        select @@MultiBranchall = 1  
                  end  
            end  
            else  
            begin  
                  if @@branchcount = 1  
                  begin  
                        select @@onebranchAll = 0  
                        select @@onebranch = 1  
                        select @@multibranch = 1  
                        select @@MultiBranchall = 1  
                  end  
                  else  
                  begin  
                        select @@MultibranchAll = 0  
                        select @@onebranch = 1  
                        select @@multibranch = 1  
                        select @@onebranchAll = 1  
                  end  
            end  
      end  
  
      if @@Onlyall = 0   
      begin  
            SELECT 
                  @@vtype = 
                        (
                              SELECT DISTINCT 
                                    vtype 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND vno = @vno
                        ) 
                  SELECT 
                  @@party2 = 
                        (
                              SELECT DISTINCT 
                                    party_code 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND upper(rtrim(branch)) = 'ALL' 
                                    AND vno = @vno 
                                    AND costflag = 'A' 
                                    AND lno = 1
                        ) 
            SELECT 
                  @@costbreakup = 
                        (
                              SELECT 
                                    count(*) 
                              FROM templedger2 
                              WHERE rtrim(sessionid) = rtrim(@sessionid) 
                                    AND category = 'BRANCH' 
                                    AND vno = @vno 
                                    AND costflag = 'C'
                        ) 
      
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')   
            begin  
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(branch) = 'ALL' 
                        AND vno = @vno 
                        AND costflag = 'A' 
      
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(drcr) = 'C' 
                        AND vno = @vno 
                        AND costflag = 'C' 
      
                  INSERT 
                  INTO templedger2 
                  SELECT 
                        category, 
                        branch, 
                        paidamt, 
                        vtype, 
                        vno, 
                        1, 
                        ( 
                              CASE 
                                    WHEN drcr = 'D' 
                                    THEN 'C' 
                                    ELSE 'D' 
                              END
                        ), 
                        costcode, 
                        booktype, 
                        sessionid, 
                        @@party2, 
                        costflag, 
                        1 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND vno = @vno 
            end  
            if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )  
            begin  
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(branch) = 'ALL' 
                        AND vno = @vno 
                        AND costflag = 'A' 
      
                  DELETE 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND upper(drcr) = 'D' 
                        AND vno = @vno 
                        AND costflag = 'C' 
      
                  INSERT 
                  INTO templedger2 
                  SELECT 
                        category, 
                        branch, 
                        paidamt, 
                        vtype, 
                        vno, 
                        1, 
                        ( 
                              CASE 
                                    WHEN drcr = 'D' 
                                    THEN 'C' 
                                    ELSE 'D' 
                              END
                        ), 
                        costcode, 
                        booktype, 
                        sessionid, 
                        @@party2, 
                        costflag, 
                        1 
                  FROM templedger2 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND category = 'BRANCH' 
                        AND vno = @vno 
            end  
      end  
  
  
      if @@Onlyall = 0   
      begin   
            if @statusid = 'BRANCH'   
            begin  
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType,
                        upper(party_code) 
                  FROM templedger2 t, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(costname) = rtrim(@statusname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
            else  
            begin  
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType,
                        upper(party_code) 
                  FROM templedger2 t, 
                        Branchaccounts b, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND DefaultAc = 1 
                        AND rtrim(BranchName) = rtrim(costname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
      end  
      else  
      if @@OneBranch = 0  
      begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(party_code ) 
            FROM templedger2 t, 
                  costmast c 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
      end  
      else  
      if @@MultiBranch = 0  
      Begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(party_code) 
            FROM templedger2 t, 
                  costmast c 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
      
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  costcode= 
                        ( 
                              SELECT 
                                    costcode 
                              FROM costmast c, 
                                    branchaccounts b 
                              WHERE DefaultAc = 1 
                                    AND rtrim(branchname) = rtrim(costname)
                        ), 
                  BookType, 
                  upper(BrControlAc) 
            FROM templedger2 t, 
                  branchaccounts b 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(branchname) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
                  AND rtrim(branch) <> rtrim(@@mainbr) 
      
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  vno, 
                  lno, 
                  ( 
                        CASE 
                              WHEN drcr= 'd' 
                              OR drcr = 'D' 
                              THEN 'C' 
                              ELSE 'D' 
                        END
                  ), 
                  paidamt, 
                  c.costcode, 
                  BookType, 
                  upper(MainControlAc) 
            FROM templedger2 t, 
                  costmast c, 
                  branchaccounts b 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND rtrim(branch) = rtrim(costname) 
                  AND rtrim(BranchName) = rtrim(branch) 
                  AND category = 'BRANCH' 
                  AND vno =@vno 
                  AND costflag = 'A' 
                  AND rtrim(branch) <> rtrim(@@mainbr) 
      end  
      else  
      if @@OneBranchAll = 0   
      begin  
      set @@rcursor = cursor for  
            SELECT 
                  branch 
            FROM templedger2 
            WHERE category = 'BRANCH' 
                  AND rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno = @vno 
                  AND branch <> 'ALL' 
                  AND costflag = 'A' 
            ORDER BY branch 
            open @@rcursor  
            fetch next from @@rcursor into @@branch   
            while @@fetch_status = 0  
            begin  
            SELECT @@costcode1 = 
                        ( 
                              SELECT 
                                    costcode 
                              FROM costmast 
                              WHERE rtrim(@@branch) = rtrim(costname)
                        ) 
                  fetch next from @@rcursor into @@branch   
                  end  
                  close @@rcursor  
                  deallocate @@rcursor  
            
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        c.costcode, 
                        BookType, 
                        upper(party_code) 
                  FROM templedger2 t, 
                        costmast c 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(branch) = rtrim(costname) 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            
                  INSERT 
                  INTO ledger2 
                  SELECT 
                        vtype, 
                        vno, 
                        lno, 
                        drcr, 
                        paidamt, 
                        @@costcode1, 
                        BookType, 
                        upper(party_code) 
                  FROM templedger2 t 
                  WHERE rtrim(sessionid) = rtrim(@sessionid) 
                        AND rtrim(branch) = 'ALL' 
                        AND category = 'BRANCH' 
                        AND vno =@vno 
                        AND costflag = 'A' 
            end  
      end  
  
      if @costcenterflag  = 1  
      begin  
            INSERT 
            INTO ledger2 
            SELECT 
                  vtype, 
                  @vno, 
                  lno, 
                  drcr, 
                  paidamt, 
                  costcode, 
                  BookType,
                  upper(party_code ) 
            FROM templedger2 t 
            WHERE rtrim(sessionid) = rtrim(@sessionid) 
                  AND vno = @vno 
                  AND costflag = 'C' 
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Marginyearend
-- --------------------------------------------------
 /****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 05/10/2004 5:29:33 PM ******/  
/****** Object:  Stored Procedure dbo.Marginyearend    Script Date: 03/28/2003 4:34:58 PM ******/  
CREATE Procedure Marginyearend  
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime  
  
as  
set transaction isolation level read uncommitted  
  
declare  
@@cltcode  as varchar(10),  
@@lno      as int,  
@@rcursor  as cursor  
  
insert into marginledger  
select @vtyp, @vno, 0, (case when t.bal >= 0 then 'D' else 'C' end), @vdt, abs(t.bal), t.party_code,  
t.exchange, rtrim(t.segment), 0, '', @booktype, t.mcltcode  
from  
(select mcltcode, exchange, segment, party_code, bal=sum( case when upper(drcr) = 'D' then amount else -amount end)  
from marginledger where vdt >= @sdtcur + ' 00:00:00' and vdt <= @ldtcur + ' 23:59:59'  
group by mcltcode, exchange, segment, party_code) t  
  
  
set @@rcursor = cursor for  
select cltcode, lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno  
order by cltcode  
  
open @@rcursor  
fetch next from @@rcursor   
into @@cltcode, @@lno  
  
while @@fetch_status = 0  
begin  
   update marginledger set lno = @@lno where vtyp = @vtyp and booktype = @booktype and vno = @vno and mcltcode = @@cltcode  
  
   fetch next from @@rcursor   
   into @@cltcode, @@lno  
end  
  
close @@rcursor  
deallocate @@rcursor  
  
/* For effective datewise Margin O/p Balances */  
  
update marginledger set sett_no = t.bal  
from  
(  
select mcltcode, exchange, segment, party_code, bal=sum( case when upper(m.drcr) = 'D' then amount else -amount end)  
from marginledger m, ledger l  
where m.vtyp = l.vtyp and m.booktype = l.booktype and m.vno = l.vno and m.lno = l.lno  
and l.edt >= @sdtcur + ' 00:00:00' and l.edt <= @ldtcur +' 23:59:59'  
group by mcltcode, exchange, segment, party_code) t  
where marginledger.mcltcode = t.mcltcode and marginledger.exchange = t.exchange and marginledger.segment=t.segment  
and marginledger.party_code = t.party_code and marginledger.vtyp = 18

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacmultiinsert
-- --------------------------------------------------


CREATE Procedure Newacmultiinsert      
@Vtyp Smallint,           
@Booktype Char(2),           
@Vno Varchar(12),           
@Lno Int,           
@Vdt Varchar(11),           
@Edt Varchar(11),           
@Cltcode Varchar(10),           
@Drcr Char(1),            
@Vamt Money,           
@Enteredby Varchar(25),           
@Cdt Datetime, /*varchar(30), */          
@Checkedby Varchar(25),           
@Pdt Datetime, /*varchar(30), */          
@Acname Varchar(50),           
@Narration Varchar(234),           
@Chequeinname Varchar(50),           
@Chqprinted Tinyint,           
@Accat Int,           
@Bnkname Varchar(50),           
@Brnname Varchar(30),           
@Dd Char(1),           
@Ddno Varchar(15),           
@Dddt Datetime,           
@Reldt Datetime,           
@Relamt Money,           
@Micrno Int,           
@Sessionid Int,           
@Branchname Char(10),           
@Costflag Varchar(1),           
@Costrowid Int,           
@Clearingmode Char(1),           
@Emode Char(1)          
/*slipno, , Chequeinname, Chqprinted*/          
As          
Declare          
@@Vno1 As Varchar(12),           
@@Refno Char(12),           
@@Nodays Int,           
@@Actnodays Int,           
@@Balamt Money,           
@@Slipno Smallint,           
@@Slipdate Datetime,           
@@Clearingmode Char(2),           
@@Receiptno Int,           
@@Branch As Char(15),           
@@Exchange As Varchar(3),           
@@Segment As Varchar(10),           
@@Sett_no As Varchar(7),           
@@Sett_type As Varchar(3),           
@@Party_code As Varchar(10),           
@@Vdt1 As Datetime,           
@@Edt1 As Datetime,           
@@Dddt1 As Datetime,           
@@Reldt1 As Datetime,           
@@Recordcount As Int          
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))          
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))          
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))          
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */          
Select @@Reldt1 = @Reldt          
Select @@Vno1 = @Vno          
Select @@Refno = ''          
Select @@Nodays = 0          
Select @@Actnodays  = 0          
Select @@Balamt = 0          
Select @@Slipno = 0          
Select @@Slipdate = ''          
/*select @@Clearingmode = ' ' */          
Select @@Receiptno = 0          
Select @@Branch =  'Branch'          
/* Inserting Record In Ledger */          
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,           
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)           
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,           
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Record In Ledger3 */          
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values          
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)          
/* Inserting Common Narration In Ledger3 */          
If @Lno = 2           
Begin          
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values          
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)          
End           
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/          
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20           
Begin          
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)          
      Begin          
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2          
      Begin             
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
     End           
      End           
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)          
        Begin          
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2          
           
   Begin          
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)          
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)          
                  End           
     End          
    Else If @Vtyp = 5          
        Begin          
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)          
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)          
   If @Accat = 2 And @Drcr = 'C'          
   Begin          
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)          
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)          
   End          
        End          
End          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
/* Inserting Records In Matchdetails And Updating Billmatch */          
If @Lno = 2           
Begin          
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)          
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T          
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)           
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype           
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno          
        Insert Into Matchdetails          
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype          
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)           
End          
/* Insertting Records In Margin Ledger */          
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)          
Begin          
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)          
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))          
End          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */          
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'            
Begin          
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)             
 Declare Cur_ledger_insert Cursor For             
        Select Count(Party_code), Party_code From Templedger2 Where             
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And           
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code          
            
        Open Cur_ledger_insert            
            
        Fetch Next From Cur_ledger_insert           
        Into @Recordcounter, @Partycode          
While @@Fetch_status = 0            
Begin           
--if  @Partycode <> @Cltcode          
If @Recordcounter = 1          
 Begin          
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid           
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )            
End          
/* Else          
 Begin          
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid           
 End*/          
Fetch Next From Cur_ledger_insert             
             
End            
            
Close Cur_ledger_insert            
Deallocate Cur_ledger_insert            
End           
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/          
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'          
/*select @@Recordcount = Count(Party_code) From Templedger2 Where           
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt          
If @@Recordcount = 0          
Begin*/          
Begin          
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )          
End          
--end          
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newpartybalances1
-- --------------------------------------------------


--exec Newpartybalances1 '0A141', '0A141', 'Apr 1 2005','Apr 1 2005', 'Feb 28 2006','PARTY', '346969512', '%'  
CREATE Procedure Newpartybalances1    
@Fromparty Varchar(10),     
@Toparty Varchar(10),     
@Opendate Varchar(11),     
@Fromdt Varchar(11),     
@Todate Varchar(11),     
@Reporttype Varchar(30),     
@Sessionid Varchar(30),     
@Branchcode Varchar(10)    
As    
Declare     
@@Balcur As Cursor,     
@@Baldate As Datetime,     
@@Enddatenew As Datetime,     
@@Enddate As Datetime    
Set Nocount On    
Delete From Temppartybalances1 Where Rtrim(Sessionid) = Rtrim(@Sessionid)    
Select @@Baldate = @Fromdt + ' 23:59'    
/*select @@Baldatenew = @Fromdt + ' 00:00:00'*/    
Select @@Enddate = @Todate + ' 23:59'    
Select @@Enddatenew = Dateadd(Day, 1, @@Baldate)     
If Upper(Rtrim(@Reporttype)) = 'party'  
Begin    
Print 'I Am In Party'    
   While @@Baldate < = @@Enddate    
   Begin    
-- Select @@Baldate    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Acmast A Where Edt > = 'Apr  1 2003' + ' 00:00' And Edt < = @@Baldate     
 And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty    
 And A.Branchcode Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
/*    
While @@Baldatenew < = @@Enddate    
   Begin    
 Select @@Baldatenew    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldatenew, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, Acmast A Where Edt > = @Opendate + ' 00:00:00' And Edt < = @@Baldate     
 And L.Cltcode = A.Cltcode And A.Accat = 4 And A.Cltcode > = @Fromparty And A.Cltcode < = @Toparty    
 And A.Branchcode Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
        Select @@Baldatenew = Dateadd(Day, 1, @@Baldatenew)    
   End    
*/    
End    
Else If Upper(Rtrim(@Reporttype)) = 'family'    
Begin    
Print 'I Am In Family'    
   While @@Baldate < = @@Enddate    
   Begin    
 Select @@Baldate    
 Insert Into Temppartybalances1    
 Select C.Family, @@Baldate, Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, BSEFO.Dbo.Clientmaster C Where Edt > = @Opendate + ' 00:00:00' And Edt < = @@Baldate     
 And L.Cltcode = C.Party_code And C.Family > = @Fromparty And C.Family < = @Toparty    
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'    
 Group By C.Family    
 Order By C.Family    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
End    
Else If Upper(Rtrim(@Reporttype)) = 'familyparty'    
Begin    
Print 'I Am In Familyparty'    
   While @@Baldate < = @@Enddate    
   Begin    
 Select @@Baldate    
 Insert Into Temppartybalances1    
 Select L.Cltcode, @@Baldate, Sum( Case When Upper(Drcr)  = 'D' Then Vamt Else -vamt End), @Sessionid    
 From Ledger L, BSEFO.Dbo.Clientmaster C  Where Edt > = @Opendate + ' 00:00' And Edt < = @@Baldate     
 And L.Cltcode = C.Party_code And C.Family > = 'S06786' And C.Family < = @Toparty    
 And C.Branch_cd Like Rtrim(@Branchcode) + '%'    
 Group By L.Cltcode    
 Order By L.Cltcode    
        Select @@Baldate = Dateadd(Day, 1, @@Baldate)    
   End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------


CREATE PROCEDURE NEWPOSTBILL  
(
	@VTYP SMALLINT,  
	@BOOKTYPE VARCHAR(2),  
	@VNO VARCHAR(12),  
	@VDT VARCHAR(11),  
	@EDTDR VARCHAR(11),  
	@EDTCR VARCHAR(11),  
	@CDT VARCHAR(11),  
	@PDT VARCHAR(11),  
	@ENTEREDBY VARCHAR(25),  
	@CHECKEDBY VARCHAR(25),  
	@SETT_NO VARCHAR(7),  
	@SETT_TYPE VARCHAR(3),  
	@UNAME VARCHAR(25),   
	@EXCHANGE VARCHAR(10), 
	@BILLDATE VARCHAR(11), 
	@OVNO VARCHAR(12) = '' 
)

AS  
  
/*=================================================================================================
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
=================================================================================================*/

SET NOCOUNT ON  

DECLARE  
	@@OBJID AS INT,  
	@@EDTDR AS VARCHAR(11),  
	@@EDTCR AS VARCHAR(11),  
	@@LEDCNT AS INT
  
BEGIN TRANSACTION

	SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)

/*=================================================================================================
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE
=================================================================================================*/
	IF @OVNO <> ''
		BEGIN
			SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE
			IF @@LEDCNT > 0 
				BEGIN 
					DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					IF @@OBJID <> 0  
						BEGIN  
							DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
						END  
				END
		END

	TRUNCATE TABLE POSTBILLLEDGER  
	TRUNCATE TABLE POSTBILLLEDGER2


/*=========================================================================================================
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING
=========================================================================================================*/
	INSERT 
	INTO POSTBILLLEDGER 
		( 
			VTYP, 
			VNO, 
			EDT, 
			ACNAME, 
			DRCR, 
			VAMT, 
			VDT, 
			VNO1, 
			REFNO, 
			BALAMT, 
			NODAYS, 
			CDT, 
			CLTCODE, 
			BOOKTYPE, 
			ENTEREDBY, 
			PDT, 
			CHECKEDBY, 
			ACTNODAYS, 
			NARRATION, 
			SETT_NO, 
			SETT_TYPE, 
			BILL_NO, 
			ACCAT, 
			BRANCHCODE
		) 
		SELECT 
			@VTYP, 
			@VNO, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN @EDTDR 
				ELSE @EDTCR 
				END
			), 
			ACNAME, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN 'D' 
				ELSE 'C' 
				END
			), 
			AMOUNT, 
			@VDT, 
			@VNO, 
			'', 
			0, 
			0, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			PARTY_CODE, 
			@BOOKTYPE, 
			@ENTEREDBY, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			@CHECKEDBY, 
			0, 
			'BSEFO' + RTRIM(LTRIM(@BILLDATE)) + '  Bill Posted', 
			@SETT_NO, 
			@SETT_TYPE, 
			BILL_NO, 
			A.ACCAT, 
			A.BRANCHCODE  
		FROM BSEFO.DBO.BFOACCBILL B WITH(NOLOCK), 
			ACMAST A WITH(NOLOCK) 
		WHERE B.PARTY_CODE = A.CLTCODE 
			AND B.BILLDATE LIKE @BILLDATE + '%'
			AND B.AMOUNT <> 0
			AND 
			(
				A.ACCAT = 4 
				OR B.BRANCHCD = 'ZZZ'
			) 
       

	INSERT 
	INTO POSTBILLLEDGER2 
		SELECT 
			(CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), 
			AMOUNT, 
			BRANCHCD, 
			PARTY_CODE
		FROM 
			BSEFO.DBO.BFOACCBILL
		WHERE
			BILLDATE LIKE @BILLDATE + '%'
			AND BRANCHCD <> 'ZZZ'
			AND AMOUNT <> 0
  

/*=================================================================================================
      POST DATA INTO LEDGER
=================================================================================================*/
	INSERT 
	INTO LEDGER 
	(
		VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION
	) 
		SELECT 
			VTYP, 
			VNO, 
			EDT, 
			LNO, 
			ACNAME, 
			DRCR, 
			VAMT, 
			VDT, 
			VNO1, 
			REFNO, 
			BALAMT, 
			NODAYS, 
			CDT, 
			CLTCODE, 
			BOOKTYPE, 
			ENTEREDBY, 
			PDT, 
			CHECKEDBY, 
			ACTNODAYS, 
			NARRATION 
		FROM POSTBILLLEDGER WITH(NOLOCK) 

   
/*=================================================================================================
      POST DATA INTO LEDGER1
=================================================================================================*/
	INSERT 
	INTO LEDGER1 
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE
	) 

		SELECT 
			@EXCHANGE + 'FO' + @BILLDATE, 
			'', 
			'B', 
			'0', 
			'', 
			'', 
			VAMT, 
			'0', 
			'', 
			VTYP, 
			VNO, 
			LNO, 
			DRCR, 
			BOOKTYPE, 
			'0', 
			'', 
			'', 
			'', 
			1, 
			'C' 
		FROM POSTBILLLEDGER WITH(NOLOCK)

  
/*=================================================================================================
      POST DATA INTO LEDGER2
=================================================================================================*/
	INSERT 
	INTO LEDGER2 
	(
		VTYPE, 
		VNO, 
		LNO, 
		DRCR, 
		CAMT, 
		COSTCODE, 
		BOOKTYPE, 
		CLTCODE
	) 
		SELECT 
			B.VTYP, 
			B.VNO, 
			B.LNO, 
			B2.DRCR, 
			B2.AMOUNT, 
			C.COSTCODE, 
			B.BOOKTYPE, 
			B.CLTCODE 
		FROM POSTBILLLEDGER B WITH(NOLOCK), 
			COSTMAST C WITH(NOLOCK),
			POSTBILLLEDGER2 B2 
		WHERE 
			B.CLTCODE = B2.CLTCODE
			AND B2.BRANCHCODE = C.COSTNAME 
  

/*=================================================================================================
      POST DATA INTO LEDGER3
=================================================================================================*/
	INSERT 
	INTO LEDGER3 
	(
		NARATNO,
		NARR,
		REFNO,
		VTYP,
		VNO,
		BOOKTYPE
	) 
		SELECT 
			LNO, 
			NARRATION, 
			'', 
			VTYP, 
			VNO, 
			BOOKTYPE 
		FROM POSTBILLLEDGER 
  

/*=================================================================================================
      POST DATA INTO BILLMATCH
=================================================================================================*/
	INSERT 
	INTO BILLMATCH 
	(
		EXCHANGE, 
		SEGMENT, 
		SETT_TYPE, 
		SETT_NO, 
		BILLNO, 
		DATE, 
		PARTY_CODE, 
		AMOUNT, 
		DRCR, 
		BALAMT, 
		VTYPE, 
		VNO, 
		LNO, 
		BRANCH, 
		BOOKTYPE
	) 
		SELECT 
			LEFT(@EXCHANGE, 3), 
			'FUTURES', 
			SETT_TYPE, 
			SETT_NO, 
			BILL_NO, 
			VDT, 
			CLTCODE, 
			VAMT, 
			DRCR, 
			0, 
			VTYP, 
			VNO, 
			LNO, 
			BRANCHCODE, 
			BOOKTYPE 
		FROM POSTBILLLEDGER WITH(NOLOCK)  
		WHERE ACCAT = '4' 
  
/*=================================================================================================
      POST DATA INTO BFBILLMATCH
=================================================================================================*/
	IF @@OBJID <> 0  
		BEGIN  
			INSERT 
			INTO BFBILLMATCH 
			(
				EXCHANGE, 
				SEGMENT, 
				SETT_TYPE, 
				SETT_NO, 
				BILLNO, 
				DATE, 
				PARTY_CODE, 
				AMOUNT, 
				DRCR, 
				BALAMT, 
				VTYPE, 
				VNO, 
				LNO, 
				BRANCH, 
				BOOKTYPE, 
				BANKPOSTDATE, 
				BANKPOSTAMOUNT, 
				BANKSTATUS, 
				BANKREASON
			) 
				SELECT 
					LEFT(@EXCHANGE, 3), 
					'FUTURES', 
					SETT_TYPE, 
					SETT_NO, 
					BILL_NO, 
					VDT, 
					CLTCODE, 
					VAMT, 
					DRCR, 
					0, 
					VTYP, 
					VNO, 
					LNO, 
					BRANCHCODE, 
					BOOKTYPE, 
					'', 
					0, 
					'', 
					'' 
				FROM POSTBILLLEDGER WITH(NOLOCK) 
				WHERE ACCAT = '4' 
		END  
   
/*=================================================================================================
      POST DATA INTO BILLPOSTED
=================================================================================================*/
	SELECT 
		@@EDTDR = MIN(EDT), 
		@@EDTCR = MAX(EDT) 
	FROM POSTBILLLEDGER 

	INSERT 
	INTO BILLPOSTED 
	(
		VNO, 
		VTYP, 
		BOOKTYPE, 
		VDT, 
		BILLDATE, 
		SETT_NO, 
		SETT_TYPE, 
		NARRATION, 
		USERNAME, 
		POSTDATE, 
		EDTDR, 
		EDTCR
	) 
		SELECT 
			TOP 1 VNO, 
			VTYP, 
			BOOKTYPE, 
			CONVERT(VARCHAR(11), VDT, 109), 
			CONVERT(VARCHAR(11), VDT, 109), 
			SETT_NO, 
			SETT_TYPE, 
			NARRATION, 
			@UNAME, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			@@EDTDR, 
			@@EDTCR 
		FROM POSTBILLLEDGER WITH(NOLOCK) 

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_POST_LEDGER
-- --------------------------------------------------

CREATE PROC [dbo].[OFFLINE_POST_LEDGER]      
(      
           @UNAME     VARCHAR(25),                          
           @USERCAT   INT,                          
           @EXCHANGE  VARCHAR(3),                          
           @SEGMENT   VARCHAR(10),                          
           @RECOFLAG  CHAR(1) = 'N'                         
)      
      
AS      
      
      
      
DECLARE @@LEDVDT VARCHAR(11)      
DECLARE @@VTYP SMALLINT  
  
DECLARE LEDPOST CURSOR FOR      
 --SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
 SELECT DISTINCT LEFT(VDATE,11) AS VDT, VOUCHERTYPE   
 FROM ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES      
 WHERE EXCHANGE = @EXCHANGE      
 AND SEGMENT = @SEGMENT      
 AND ROWSTATE = 0      
 AND VDATE NOT LIKE 'JAN  1 1900%'      
      
OPEN LEDPOST      
      
-- Perform the first fetch.      
FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP       
      
-- Check @@FETCH_STATUS to see if there are any more rows to fetch.      
WHILE @@FETCH_STATUS = 0      
BEGIN      
/* IF @@VTYP = 3   
 BEGIN  
   EXEC V2_OFFLINE_PAYMENTUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG      
 END  */
 IF @@VTYP = 2   
 BEGIN  
   EXEC V2_OFFLINE_RECPAYUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG      
 END  
      
-- This is executed as long as the previous fetch succeeds.      
   FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP       
END      
      
CLOSE LEDPOST      
DEALLOCATE LEDPOST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_POST_LEDGER_BKP01oCT2017
-- --------------------------------------------------

CREATE PROC [dbo].[OFFLINE_POST_LEDGER_BKP01oCT2017]      
(      
           @UNAME     VARCHAR(25),                          
           @USERCAT   INT,                          
           @EXCHANGE  VARCHAR(3),                          
           @SEGMENT   VARCHAR(10),                          
           @RECOFLAG  CHAR(1) = 'N'                         
)      
      
AS      
      
      
      
DECLARE @@LEDVDT VARCHAR(11)      
DECLARE @@VTYP SMALLINT  
  
DECLARE LEDPOST CURSOR FOR      
 --SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
 SELECT DISTINCT LEFT(VDATE,11) AS VDT, VOUCHERTYPE   
 FROM ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES      
 WHERE EXCHANGE = @EXCHANGE      
 AND SEGMENT = @SEGMENT      
 AND ROWSTATE = 0      
 AND VDATE NOT LIKE 'JAN  1 1900%'      
      
OPEN LEDPOST      
      
-- Perform the first fetch.      
FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP       
      
-- Check @@FETCH_STATUS to see if there are any more rows to fetch.      
WHILE @@FETCH_STATUS = 0      
BEGIN      
/* IF @@VTYP = 3   
 BEGIN  
   EXEC V2_OFFLINE_PAYMENTUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG      
 END  */
 IF @@VTYP = 2   
 BEGIN  
   EXEC V2_OFFLINE_RECPAYUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG      
 END  
      
-- This is executed as long as the previous fetch succeeds.      
   FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP       
END      
      
CLOSE LEDPOST      
DEALLOCATE LEDPOST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_acc_GetCompanyName
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.proc_acc_GetCompanyName    Script Date: 5/18/04 1:04:54 PM ******/    
    
CREATE  PROCEDURE proc_acc_GetCompanyName    
 @AccoundDBName VarChar (50)    
AS    
    
SELECT * FROM    
 pradnya.dbo.multicompany    
    
WHERE    
 accountdb = @AccoundDBName AND    
 primaryserver = 1    
    
ORDER BY    
 companyname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK
-- --------------------------------------------------

CREATE PROC [dbo].[RECPAYUPLOAD_BULK]  
 @FNAME VARCHAR(100),  
 @UNAME VARCHAR(25),  
 @USERCAT SMALLINT  
  
AS  
/*  
begin tran  
SP_HELPTRIGGER LEDGER  
LEDGER_TRG_BILL  
LEDGER_TRG  
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388  
SELECT TOP 1 * FROM LEDGER3  
SELECT TOP 1 * FROM LEDGER_TRG  
ROLLBACK  
*/  
SET NOCOUNT ON  
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/  
DECLARE  
 @@STD_DATE VARCHAR(11),  
 @@LST_DATE VARCHAR(11),  
 @@BRANCHFLAG AS TINYINT,  
 @@VNOFLAG AS TINYINT,  
 @@VNOMETHOD INT,  
 @@ACNAME CHAR(100),  
 @@BOOKTYPE CHAR(2),  
 @@MICRNO VARCHAR(10),  
 @@DRCR VARCHAR(1),  
 @@VTYP SMALLINT,  
 @@BANK_CODE VARCHAR(100),  
 @@BACKDAYS INT,  
 @@BACKDATE VARCHAR(11),  
 @@BRNCOUNT   TINYINT,  
 @@MonthlyVdt VARCHAR(11),  
 @@SERIAL_NO INT,  
 @@COSTCODECOUNT TINYINT,  
 @@COSTCODEUPDATES CURSOR,  
 @@NEWVNO AS VARCHAR(12),  
 @@MAXCOUNT AS INT,  
 @@VDT AS VARCHAR(11),  
 @@BANKBRANCH AS VARCHAR(10),  
 @@BANKCOST AS NUMERIC,  
 @@LNOCUR AS CURSOR,  
 @@VNOCUR AS CURSOR,  
 @@LNOVNO AS VARCHAR(12),  
 @@MAXVNO AS INT,  
 @@L2CUR AS CURSOR,  
 @@L2VNO AS VARCHAR(12),  
 @@ERROR_COUNT AS INT,  
 @@FILEEXISTS AS INT,  
 @@SQL AS VARCHAR(2000)  
  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT  
   U_FILENAME  
  FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'  
  RETURN  
 END  
CREATE TABLE #FEXIST  
(  
 F1 SMALLINT,  
 F2 SMALLINT,  
 F3 SMALLINT  
)  
SELECT @@SQL = "INSERT INTO "  
SELECT @@SQL = @@SQL + " #FEXIST "  
SELECT @@SQL = @@SQL + " (F1, F2, F3) "  
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "  
  
EXEC(@@SQL)  
  
SELECT  
 @@FILEEXISTS = F1  
FROM  
 #FEXIST  
  
IF @@FILEEXISTS = 0  
 BEGIN  
  DROP TABLE #FEXIST  
  SELECT  
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'  
  RETURN  
 END  
DROP TABLE #FEXIST  
  
BEGIN TRAN  
CREATE TABLE #RECPAY_TABLE_TMP  
(  
 SERIAL_NO INT,  
 EDATE VARCHAR(20),  
 VOUCHER_DATE VARCHAR(20),  
 CLIENT_CODE VARCHAR(50),  
 AMOUNT MONEY,  
 DRCR VARCHAR(1),  
 NARRATION VARCHAR(234),  
 BANK_CODE VARCHAR(10),  
 BANK_NAME VARCHAR(100),  
 REF_NO VARCHAR(15),  
 BRANCHCODE VARCHAR(20),  
 BRANCH_NAME VARCHAR(50),  
 CHQ_MODE VARCHAR(1),  
 CHQ_DATE VARCHAR(20),  
 CHQ_NAME VARCHAR(100),  
 CL_MODE VARCHAR(1)  
)  
CREATE TABLE [#RECPAY_TABLE]  
 (  
  SERIAL_NO INT,  
  EDATE VARCHAR(20),  
  VOUCHER_DATE VARCHAR(20),  
  CLIENT_CODE VARCHAR(50),  
  AMOUNT MONEY,  
  DRCR VARCHAR(1),  
  NARRATION VARCHAR(234),  
  BANK_CODE VARCHAR(10),  
  BANK_NAME VARCHAR(100),  
  REF_NO VARCHAR(15),  
  BRANCHCODE VARCHAR(20),  
  BRANCH_NAME VARCHAR(50),  
  CHQ_MODE VARCHAR(1),  
  CHQ_DATE VARCHAR(20),  
  CHQ_NAME VARCHAR(100),  
  CL_MODE VARCHAR(1),  
  SNO INT IDENTITY (1, 1) NOT NULL ,  
  VDT DATETIME NULL ,  
  FYSTART DATETIME NULL ,  
  FYEND DATETIME NULL ,  
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),  
  EDT DATETIME NULL ,  
  DDDT DATETIME NULL ,  
  VNO VARCHAR (12) NULL ,  
  VTYP SMALLINT NULL ,  
  ACNAME VARCHAR (100) NULL ,  
  COSTCODE SMALLINT NULL,  
  BANKCOST SMALLINT NULL,  
  LNO SMALLINT NOT NULL DEFAULT(0),  
  BANKNAME VARCHAR(100) NULL,  
  MICRNO INT NULL,  
  BOOKTYPE VARCHAR(2) NULL,  
 ) ON [PRIMARY]  
  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "  
EXEC (@@SQL)  
  
IF @@ERROR <> 0  
 BEGIN  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRANSACTION  
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'  
  RETURN  
 END  
INSERT INTO  
 V2_UPLOADED_FILES  
SELECT  
 @FNAME,  
 @FNAME,  
 CNT = COUNT(1),  
 'B',  
 GETDATE(),  
 @UNAME,  
 'RECEIPT/PAYMENT UPLOAD'  
  
INSERT INTO  
 #RECPAY_TABLE  
 (  
  SERIAL_NO,  
  EDATE,  
  VOUCHER_DATE,  
  CLIENT_CODE,  
  AMOUNT,  
  DRCR,  
  NARRATION,  
  BANK_CODE,  
  BANK_NAME,  
  REF_NO,  
  BRANCHCODE,  
  BRANCH_NAME,  
  CHQ_MODE,  
  CHQ_DATE,  
  CHQ_NAME,  
  CL_MODE  
 )  
SELECT  
 SERIAL_NO,  
 EDATE,  
 VOUCHER_DATE,  
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),  
 AMOUNT,  
 UPPER(LTRIM(RTRIM(DRCR))),  
 NARRATION,  
 UPPER(LTRIM(RTRIM(BANK_CODE))),  
 UPPER(LTRIM(RTRIM(BANK_NAME))),  
 REF_NO,  
 UPPER(LTRIM(RTRIM(BRANCHCODE))),  
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),  
 UPPER(LTRIM(RTRIM(CHQ_MODE))),  
 CHQ_DATE,  
 CHQ_NAME,  
 CL_MODE  
FROM  
 #RECPAY_TABLE_TMP  
  
UPDATE  
 #RECPAY_TABLE  
SET  
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))  
  
  
SELECT  
 @@ERROR_COUNT = COUNT(DISTINCT VDT)  
FROM  
 #RECPAY_TABLE  
  
IF @@ERROR_COUNT > 1  
 BEGIN  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRANSACTION  
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'  
  RETURN  
 END  
  
SELECT TOP 1  
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)  
FROM  
 #RECPAY_TABLE  
  
SELECT  
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),  
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),  
 @@BRANCHFLAG = BRANCHFLAG,  
 @@VNOFLAG = VNOFLAG  
FROM  
 PARAMETER  
WHERE  
 @@VDT BETWEEN SDTCUR AND LDTCUR  
  
IF @@BRANCHFLAG = 1  
 BEGIN  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   BRANCHCODE = A.BRANCHCODE,  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = C.COSTCODE,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = COSTNAME  
    
  UPDATE  
   #RECPAY_TABLE  
  SET  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = 'ALL'  
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'  
  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   BRANCHCODE = 'HO',  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = 'ALL'  
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'  
 END  
ELSE  
 BEGIN  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   FYSTART = @@STD_DATE,  
   FYEND = @@LST_DATE + ' 23:59:59',  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
 END  
  
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */  
  
 SELECT  
  @@ERROR_COUNT = COUNT(DISTINCT VDT)  
 FROM  
  #RECPAY_TABLE  
 IF @@ERROR_COUNT > 1  
  BEGIN  
   SELECT  
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE  
   FROM  
    V2_UPLOADED_FILES  
   WHERE  
    U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END  
 SELECT @@ERROR_COUNT = 0  
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/  
/*  
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)  
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'  
   DROP TABLE #RecPay_Table_Tmp  
   DROP TABLE #RecPay_Table  
   ROLLBACK TRAN  
   DELETE FROM V2_Uploaded_Files  
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END*/  
  
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */  
 SELECT  
  @@ERROR_COUNT = COUNT(1)  
 FROM  
  (  
   SELECT  
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),  
    SERIAL_NO  
   FROM  
    #RECPAY_TABLE  
   GROUP BY  
    SERIAL_NO  
   HAVING  
    COUNT(DISTINCT BANK_CODE) > 1  
  ) A  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT  
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
   UNION ALL  
   SELECT  
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))  
   FROM  
    #RECPAY_TABLE  
   GROUP BY  
    SERIAL_NO  
   HAVING  
    COUNT(DISTINCT BANK_CODE) > 1  
  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE  
   FROM  
    V2_UPLOADED_FILES  
   WHERE  
    U_FILENAME = @FNAME  
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END  
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
 SELECT DISTINCT  
  DRCR  
 FROM  
  #RECPAY_TABLE  
 ) A  
IF @@ERROR_COUNT > 1  
 BEGIN  
  SELECT  
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE  
  FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
ELSE  
 BEGIN  
  SELECT TOP 1  
   @@DRCR = DRCR,  
   @@VTYP =  
    (  
    CASE  
     WHEN DRCR = 'D'  
     THEN 3  
     ELSE 2  
    END  
    )  
  FROM  
   #RECPAY_TABLE  
  UPDATE  
   #RECPAY_TABLE  
  SET VTYP =  
   (  
    CASE  
     WHEN DRCR = 'D'  
     THEN 3  
     ELSE 2  
    END  
   )  
 END  
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/  
 SELECT @@ERROR_COUNT = COUNT(1)  
 FROM #RECPAY_TABLE  
 WHERE VDT > EDT  
            IF @@ERROR_COUNT > 0  
             BEGIN  
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'  
     DROP TABLE #RECPAY_TABLE_TMP  
     DROP TABLE #RECPAY_TABLE  
     ROLLBACK TRAN  
     DELETE FROM  
      V2_UPLOADED_FILES  
     WHERE  
      U_FILENAME = @FNAME  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
     RETURN  
             END  
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/  
 SELECT @@ERROR_COUNT = COUNT(1)  
 FROM #RECPAY_TABLE  
 WHERE AMOUNT <= 0  
 IF @@ERROR_COUNT > 0  
  BEGIN  
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'  
     DROP TABLE #RECPAY_TABLE_TMP  
     DROP TABLE #RECPAY_TABLE  
     ROLLBACK TRAN  
     DELETE FROM  
      V2_UPLOADED_FILES  
     WHERE  
      U_FILENAME = @FNAME  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
     RETURN  
  END  
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT DISTINCT  
   DDNO  = RP.REF_NO  
  FROM  
   #RECPAY_TABLE RP,  
   LEDGER1 L1  
    WITH(NOLOCK)  
  WHERE  
   L1.DDNO = RP.REF_NO  
   AND L1.BNKNAME = RP.BANK_NAME
   AND L1.DD = RP.CHQ_MODE  
   AND L1.DRCR = @@DRCR  
   AND L1.VTYP = @@VTYP  
   AND RP.REF_NO <> 0  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'  
  UNION ALL  
  SELECT DISTINCT  
   RP.REF_NO, 'NA','NA'  
  FROM  
   #RECPAY_TABLE RP,  
   LEDGER1 L1  
    WITH(NOLOCK)  
  WHERE  
   L1.DDNO = RP.REF_NO  
   AND L1.BNKNAME = RP.BANK_NAME
   AND L1.DD = RP.CHQ_MODE  
   AND L1.DRCR = @@DRCR  
   AND L1.VTYP = @@VTYP  
   AND RP.CHQ_MODE <> 'N'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT DISTINCT  
   CLIENT_CODE  
  FROM  
   #RECPAY_TABLE  
  WHERE  
   UPDFLAG = 'N'  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'  
  UNION ALL  
  SELECT DISTINCT  
   CLIENT_CODE, 'NA','NA'  
  FROM  
   #RECPAY_TABLE  
  WHERE  
   UPDFLAG = 'N'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */  
  SET @@VNOCUR = CURSOR FOR  
   SELECT DISTINCT  
    BANK_CODE,  
    BOOKTYPE  
   FROM  
    #RECPAY_TABLE WITH(NOLOCK)  
  OPEN @@VNOCUR  
  FETCH NEXT  
   FROM  
    @@VNOCUR  
   INTO  
    @@BANK_CODE,  
    @@BOOKTYPE  
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/  
    SELECT  
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)  
    FROM  
     USERWRITESTABLE  
    WHERE  
     USERCATEGORY = @USERCAT  
     AND VTYP = @@VTYP  
     AND BOOKTYPE = @@BOOKTYPE  
    SELECT  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS  
    SELECT  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)  
    FROM  
     #RECPAY_TABLE  
    WHERE  
     VDT < @@BACKDATE  

    IF @@ERROR_COUNT > 0  
     BEGIN  
      SELECT  
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'  
      DROP TABLE #RECPAY_TABLE_TMP  
      DROP TABLE #RECPAY_TABLE  
      ROLLBACK TRAN  
      DELETE FROM V2_UPLOADED_FILES  
      WHERE  
       U_FILENAME = @FNAME  
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
      RETURN  
     END
  
    IF @@BRANCHFLAG = 1  
     BEGIN  
      SELECT  
       @@BANKBRANCH = BRANCHCODE,  
       @@BANKCOST = ISNULL(C.COSTCODE, -1)  
      FROM  
       ACMAST A  
        LEFT OUTER JOIN  
        COSTMAST C  
        ON  
         (  
          A.BRANCHCODE = C.COSTNAME  
         )  
      WHERE  
       A.CLTCODE = @@BANK_CODE  
      IF @@BANKBRANCH <> 'ALL'  
       BEGIN  
        UPDATE  
         RP  
          SET COSTCODE = @@BANKCOST  
        FROM  
         #RECPAY_TABLE RP,  
         ACMAST A  
        WHERE  
         A.CLTCODE = RP.CLIENT_CODE  
         AND A.BRANCHCODE = 'ALL'  
        UPDATE  
         #RECPAY_TABLE  
          SET BANKCOST = @@BANKCOST  
        WHERE  
         BANK_CODE = @@BANK_CODE  
       END  
      ELSE  
       BEGIN  
        UPDATE  
         #RECPAY_TABLE  
          SET COSTCODE =  
           (  
            SELECT TOP 1  
             COSTCODE  
            FROM  
             COSTMAST  
            WHERE  
             COSTNAME = 'HO'  
           )  
        WHERE  
         COSTCODE = ''  
         AND BANK_CODE = @@BANK_CODE  
                            SET @@COSTCODEUPDATES = CURSOR FOR  
                                       SELECT  
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)  
                                       FROM  
                                             #RECPAY_TABLE WITH(NOLOCK)  
                                       WHERE  
          BANK_CODE = @@BANK_CODE  
                                       GROUP BY  
                                             SERIAL_NO  
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1  
                            OPEN @@COSTCODEUPDATES  
                            FETCH NEXT  
                             FROM  
                              @@COSTCODEUPDATES  
                             INTO  
                              @@SERIAL_NO,  
                              @@COSTCODECOUNT  
                            WHILE @@FETCH_STATUS = 0  
                             BEGIN  
          UPDATE  
           #RECPAY_TABLE  
            SET BANKCOST =  
             (  
              SELECT TOP 1  
               COSTCODE  
              FROM  
               COSTMAST  
              WHERE  
               COSTNAME = 'HO'  
             )  
          WHERE  
           (BANKCOST = ''   OR BANKCOST IS NULL)  
           AND BANK_CODE = @@BANK_CODE  
                                           AND SERIAL_NO = @@SERIAL_NO  
                              FETCH NEXT  
                               FROM  
                                @@COSTCODEUPDATES  
                               INTO  
                                @@SERIAL_NO,  
                                @@COSTCODECOUNT  
                             END  
                            CLOSE @@COSTCODEUPDATES  
                            DEALLOCATE @@COSTCODEUPDATES  
                  UPDATE  
                   #RECPAY_TABLE  
                    SET BANKCOST = COSTCODE  
                  WHERE  
                   BANK_CODE = @@BANK_CODE  
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)  
       END  
     END  
    CREATE TABLE  
     #BANK_VNO  
     (  
      SRNO INT,  
      NEWSRNO INT IDENTITY (1, 1)  
     )  
    INSERT INTO  
     #BANK_VNO  
    SELECT  
     DISTINCT SERIAL_NO  
    FROM  
     #RECPAY_TABLE  
    WHERE  
     BANK_CODE = @@BANK_CODE  
     AND BOOKTYPE = @@BOOKTYPE  
  
    SELECT  
     @@MAXCOUNT = COUNT(DISTINCT SNO)  
    FROM  
     #RECPAY_TABLE  
  
    SELECT TOP 1  
     @@VDT = VDT  
    FROM  
     #RECPAY_TABLE  
    SELECT  
     LASTVNO  
    INTO #VNO  
    FROM  
     LASTVNO  
    WHERE  
     1 = 2  
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  
    INSERT  
    INTO #VNO  
     EXEC ACC_GENVNO_NEW  
      @@VDT,  
      @@VTYP,  
      @@BOOKTYPE,  
      @@STD_DATE,  
      @@LST_DATE,  
      @@MAXVNO  
    SELECT  
     @@NEWVNO = LASTVNO  
    FROM  
     #VNO  
    UPDATE  
     RP  
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))  
    FROM  
     #RECPAY_TABLE RP,  
     #BANK_VNO BV  
    WHERE  
     RP.SERIAL_NO = BV.SRNO  
   DROP TABLE #VNO  
   DROP TABLE #BANK_VNO  
  FETCH NEXT  
   FROM @@VNOCUR  
   INTO  
    @@BANK_CODE,  
    @@BOOKTYPE  
 END  
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */  
UPDATE  
 #RECPAY_TABLE  
  SET LNO = 2  
WHERE  
 VNO IN  
  (  
   SELECT  
    VNO  
   FROM  
    #RECPAY_TABLE  
     WITH(NOLOCK)  
   GROUP BY  
    VNO  
   HAVING  
    COUNT(*) = 1  
  )  
SET @@LNOCUR = CURSOR FOR  
 SELECT  
  VNO  
 FROM  
  #RECPAY_TABLE  
   WITH(NOLOCK)  
 GROUP BY  
  VNO  
 HAVING  
  COUNT(*) > 1  
OPEN @@LNOCUR  
FETCH NEXT  
 FROM  
  @@LNOCUR  
 INTO  
  @@LNOVNO  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  CREATE TABLE  
   [#LNOGEN]  
    (  
     VNO VARCHAR(12),  
     SNO INT,  
     LNO INT IDENTITY(1,1)  
    )  
  INSERT INTO  
   #LNOGEN  
    SELECT  
     VNO,  
     SNO  
    FROM  
     #RECPAY_TABLE  
      WITH(NOLOCK)  
    WHERE  
     VNO = @@LNOVNO  
    ORDER BY  
     SNO  
  UPDATE  
   #RECPAY_TABLE  
    SET LNO = L.LNO + 1  
  FROM  
   #LNOGEN L  
  WHERE  
   #RECPAY_TABLE.VNO = L.VNO  
   AND #RECPAY_TABLE.SNO = L.SNO  
   AND #RECPAY_TABLE.LNO = 0  
  DROP TABLE #LNOGEN  
  FETCH NEXT  
   FROM  
    @@LNOCUR  
   INTO  
    @@LNOVNO  
 END  
CLOSE @@LNOCUR  
DEALLOCATE @@LNOCUR  
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */  
INSERT INTO  
 LEDGER1  
  (  
   BNKNAME,  
   BRNNAME,  
   DD,  
   DDNO,  
   DDDT,  
   RELDT,  
   RELAMT,  
   REFNO,  
   RECEIPTNO,  
   VTYP,  
   VNO,  
   LNO,  
   DRCR,  
   BOOKTYPE,  
   MICRNO,  
   SLIPNO,  
   SLIPDATE,  
   CHEQUEINNAME,  
   CHQPRINTED,  
   CLEAR_MODE  
  )  
SELECT  
 BNKNAME = MAX(BANK_NAME),  
 BRNNAME = MAX(BRANCH_NAME),  
 DD = MAX(CHQ_MODE),  
 DDNO = MAX(REF_NO),  
 DDDT = MAX(DDDT),  
 RELDT = '',  
 RELAMT = SUM(AMOUNT),  
 REFNO = 0,  
 RECEIPTNO = 0,  
 VTYP,  
 VNO,  
 LNO = 2,  
 DRCR,  
 BOOKTYPE = BOOKTYPE,  
 MICRNO = MAX(MICRNO),  
 SLIPNO = 0,  
 SLIPDATE = '',  
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),  
 CHQPRINTED = 0,  
 CLEAR_MODE = MAX(CL_MODE)  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 DRCR,  
 BOOKTYPE  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
  
/*================================  
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK  
=================================*/  
CREATE TABLE #LEDGER  
(  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 EDT DATETIME,  
 LNO SMALLINT,  
 ACNAME VARCHAR(100),  
 DRCR VARCHAR(1),  
 VAMT MONEY,  
 VDT DATETIME,  
 VNO1 VARCHAR(12),  
 REFNO CHAR(12),  
 BALAMT MONEY,  
 NODAYS INT,  
 CDT DATETIME,  
 CLTCODE VARCHAR(10),  
 BOOKTYPE VARCHAR(2),  
 ENTEREDBY VARCHAR(25),  
 PDT DATETIME,  
 CHECKEDBY VARCHAR(25),  
 ACTNODAYS INT,  
 NARRATION VARCHAR(234)  
)  
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0  
CREATE TABLE #LEDGER3  
(  
 NARATNO INT,  
 NARR VARCHAR(234),  
 REFNO CHAR(12),  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 BOOKTYPE VARCHAR(2)  
)  
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER  
 (  
  VTYP,  
  VNO,  
  EDT,  
  LNO,  
  ACNAME,  
  DRCR,  
  VAMT,  
  VDT,  
  VNO1,  
  REFNO,  
  BALAMT,  
  NODAYS,  
  CDT,  
  CLTCODE,  
  BOOKTYPE,  
  ENTEREDBY,  
  PDT,  
  CHECKEDBY,  
  ACTNODAYS,  
  NARRATION  
 )  
SELECT  
 VTYP,  
 VNO,  
 EDT = EDT,  
 LNO,  
 ACNAME,  
 DRCR,  
 VAMT = AMOUNT,  
 VDT,  
 VNO1 = VNO,  
 REFNO = 0,  
 BALAMT = AMOUNT,  
 NODAYS = 0,  
 CDT = GETDATE(),  
 CLTCODE = CLIENT_CODE,  
 BOOKTYPE = BOOKTYPE,  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),  
 PDT = GETDATE(),  
 CHECKEDBY = @UNAME,  
 ACTNODAYS = 0,  
 NARRATION  
FROM  
 #RECPAY_TABLE  
/*==============================  
BANK SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER  
SELECT  
 VTYP,  
 VNO,  
 EDT = EDT,  
 LNO = 1,  
 BANKNAME,  
 DRCR =  
  (  
   CASE  
    WHEN DRCR = 'D'  
    THEN 'C'  
    ELSE 'D'  
   END  
  ),  
 VAMT = SUM(AMOUNT),  
 VDT,  
 VNO1 = VNO,  
 REFNO = 0,  
 BALAMT = SUM(AMOUNT),  
 NODAYS = 0,  
 CDT = GETDATE(),  
 CLTCODE = BANK_CODE,  
 BOOKTYPE = BOOKTYPE,  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),  
 PDT = GETDATE(),  
 CHECKEDBY = @UNAME,  
 ACTNODAYS = 0,  
 NARRATION = MAX(NARRATION)  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 EDT,  
 DRCR,  
 VDT,  
 BANK_CODE,  
 BOOKTYPE,  
 BANKNAME  
/*==============================  
INSERTING ALL LEDGER RECORDS AT ONE TIME  
==============================*/  
INSERT INTO LEDGER  
SELECT  
 *  
FROM  
 #LEDGER  
ORDER BY  
 BOOKTYPE,  
 VTYP,  
 VNO,  
 LNO  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  DROP TABLE #LEDGER  
  DROP TABLE #LEDGER3  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
DROP TABLE #LEDGER  
/*==============================  
BANK SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER3  
SELECT  
 NARATNO = 1,  
 NARRATION = MAX(NARRATION),  
 REFNO = 0,  
 VTYP,  
 VNO,  
 BOOKTYPE  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 BOOKTYPE  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER3  
SELECT  
 NARATNO = LNO,  
 NARR = NARRATION,  
 REFNO = 0,  
 VTYP,  
 VNO,  
 BOOKTYPE  
FROM  
 #RECPAY_TABLE  
  
  
/*==============================  
INSERTING ALL LEDGER3 RECORDS AT ONE TIME  
==============================*/  
INSERT INTO LEDGER3  
SELECT  
 *  
FROM  
 #LEDGER3  
ORDER BY  
 BOOKTYPE,  
 VTYP,  
 VNO,  
 NARATNO  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  DROP TABLE #LEDGER3  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
DROP TABLE #LEDGER3  
  
  
IF @@BRANCHFLAG = 1  
 BEGIN  
  SET @@L2CUR = CURSOR FOR  
   SELECT DISTINCT  
    VNO  
   FROM  
    #RECPAY_TABLE  
   ORDER BY  
    VNO  
  OPEN @@L2CUR  
   FETCH NEXT  
   FROM  
    @@L2CUR  
   INTO  
    @@L2VNO  
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
    DELETE FROM  
     TEMPLEDGER2  
    WHERE  
     SESSIONID = '9999999999'  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
    INSERT INTO  
     TEMPLEDGER2  
    SELECT  
     'BRANCH',  
     C.COSTNAME,  
     AMOUNT,  
     VTYP,  
     VNO,  
     LNO,  
     DRCR,  
     '0',  
     BOOKTYPE,  
     '9999999999',  
     CLIENT_CODE,  
     'A',  
     '0'  
    FROM  
     #RECPAY_TABLE RP,  
     COSTMAST C  
    WHERE  
     RP.COSTCODE = C.COSTCODE  
     AND VNO = @@L2VNO  
/*==============================  
BANK SIDE RECORD  
==============================*/  
    INSERT INTO  
     TEMPLEDGER2  
    SELECT  
     'BRANCH',  
     C.COSTNAME,  
     SUM(AMOUNT),  
     VTYP,  
     VNO,  
     LNO = 1,  
     DRCR =  
      (  
       CASE  
       WHEN DRCR = 'D'  
       THEN 'C'  
       ELSE 'D'  
       END  
      ),  
     '0',  
     BOOKTYPE,  
     '9999999999',  
     BANK_CODE,  
     'A',  
     '0'  
    FROM  
     #RECPAY_TABLE RP,  
     COSTMAST C  
    WHERE  
     RP.BANKCOST = C.COSTCODE  
     AND VNO = @@L2VNO  
    GROUP BY  
     C.COSTNAME,  
     VTYP,  
     VNO,  
      (  
       CASE  
       WHEN DRCR = 'D'  
       THEN 'C'  
       ELSE 'D'  
       END  
      ),  
     BANK_CODE,  
     BOOKTYPE  
    EXEC INSERTTOLEDGER2  
     '9999999999',  
     @@L2VNO,  
     '1',  
     '1',  
     '1',  
     'BROKER',  
     'BROKER'  
    FETCH NEXT  
     FROM  
      @@L2CUR  
     INTO  
      @@L2VNO  
   END  
  DELETE FROM  
   TEMPLEDGER2  
  WHERE  
   SESSIONID = '9999999999'  
  COMMIT TRAN  
 END  
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL  
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE  
DROP TABLE #RECPAY_TABLE_TMP  
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK_BKup_24072018
-- --------------------------------------------------

CREATE PROC [dbo].[RECPAYUPLOAD_BULK_BKup_24072018]  
 @FNAME VARCHAR(100),  
 @UNAME VARCHAR(25),  
 @USERCAT SMALLINT  
  
AS  
/*  
begin tran  
SP_HELPTRIGGER LEDGER  
LEDGER_TRG_BILL  
LEDGER_TRG  
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388  
SELECT TOP 1 * FROM LEDGER3  
SELECT TOP 1 * FROM LEDGER_TRG  
ROLLBACK  
*/  
SET NOCOUNT ON  
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/  
DECLARE  
 @@STD_DATE VARCHAR(11),  
 @@LST_DATE VARCHAR(11),  
 @@BRANCHFLAG AS TINYINT,  
 @@VNOFLAG AS TINYINT,  
 @@VNOMETHOD INT,  
 @@ACNAME CHAR(100),  
 @@BOOKTYPE CHAR(2),  
 @@MICRNO VARCHAR(10),  
 @@DRCR VARCHAR(1),  
 @@VTYP SMALLINT,  
 @@BANK_CODE VARCHAR(100),  
 @@BACKDAYS INT,  
 @@BACKDATE VARCHAR(11),  
 @@BRNCOUNT   TINYINT,  
 @@MonthlyVdt VARCHAR(11),  
 @@SERIAL_NO INT,  
 @@COSTCODECOUNT TINYINT,  
 @@COSTCODEUPDATES CURSOR,  
 @@NEWVNO AS VARCHAR(12),  
 @@MAXCOUNT AS INT,  
 @@VDT AS VARCHAR(11),  
 @@BANKBRANCH AS VARCHAR(10),  
 @@BANKCOST AS NUMERIC,  
 @@LNOCUR AS CURSOR,  
 @@VNOCUR AS CURSOR,  
 @@LNOVNO AS VARCHAR(12),  
 @@MAXVNO AS INT,  
 @@L2CUR AS CURSOR,  
 @@L2VNO AS VARCHAR(12),  
 @@ERROR_COUNT AS INT,  
 @@FILEEXISTS AS INT,  
 @@SQL AS VARCHAR(2000)  
  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT  
   U_FILENAME  
  FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'  
  RETURN  
 END  
CREATE TABLE #FEXIST  
(  
 F1 SMALLINT,  
 F2 SMALLINT,  
 F3 SMALLINT  
)  
SELECT @@SQL = "INSERT INTO "  
SELECT @@SQL = @@SQL + " #FEXIST "  
SELECT @@SQL = @@SQL + " (F1, F2, F3) "  
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "  
  
EXEC(@@SQL)  
  
SELECT  
 @@FILEEXISTS = F1  
FROM  
 #FEXIST  
  
IF @@FILEEXISTS = 0  
 BEGIN  
  DROP TABLE #FEXIST  
  SELECT  
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'  
  RETURN  
 END  
DROP TABLE #FEXIST  
  
BEGIN TRAN  
CREATE TABLE #RECPAY_TABLE_TMP  
(  
 SERIAL_NO INT,  
 EDATE VARCHAR(20),  
 VOUCHER_DATE VARCHAR(20),  
 CLIENT_CODE VARCHAR(50),  
 AMOUNT MONEY,  
 DRCR VARCHAR(1),  
 NARRATION VARCHAR(234),  
 BANK_CODE VARCHAR(10),  
 BANK_NAME VARCHAR(100),  
 REF_NO VARCHAR(15),  
 BRANCHCODE VARCHAR(20),  
 BRANCH_NAME VARCHAR(50),  
 CHQ_MODE VARCHAR(1),  
 CHQ_DATE VARCHAR(20),  
 CHQ_NAME VARCHAR(100),  
 CL_MODE VARCHAR(1)  
)  
CREATE TABLE [#RECPAY_TABLE]  
 (  
  SERIAL_NO INT,  
  EDATE VARCHAR(20),  
  VOUCHER_DATE VARCHAR(20),  
  CLIENT_CODE VARCHAR(50),  
  AMOUNT MONEY,  
  DRCR VARCHAR(1),  
  NARRATION VARCHAR(234),  
  BANK_CODE VARCHAR(10),  
  BANK_NAME VARCHAR(100),  
  REF_NO VARCHAR(15),  
  BRANCHCODE VARCHAR(20),  
  BRANCH_NAME VARCHAR(50),  
  CHQ_MODE VARCHAR(1),  
  CHQ_DATE VARCHAR(20),  
  CHQ_NAME VARCHAR(100),  
  CL_MODE VARCHAR(1),  
  SNO INT IDENTITY (1, 1) NOT NULL ,  
  VDT DATETIME NULL ,  
  FYSTART DATETIME NULL ,  
  FYEND DATETIME NULL ,  
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),  
  EDT DATETIME NULL ,  
  DDDT DATETIME NULL ,  
  VNO VARCHAR (12) NULL ,  
  VTYP SMALLINT NULL ,  
  ACNAME VARCHAR (100) NULL ,  
  COSTCODE SMALLINT NULL,  
  BANKCOST SMALLINT NULL,  
  LNO SMALLINT NOT NULL DEFAULT(0),  
  BANKNAME VARCHAR(100) NULL,  
  MICRNO INT NULL,  
  BOOKTYPE VARCHAR(2) NULL,  
 ) ON [PRIMARY]  
  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "  
EXEC (@@SQL)  
  
IF @@ERROR <> 0  
 BEGIN  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRANSACTION  
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'  
  RETURN  
 END  
INSERT INTO  
 V2_UPLOADED_FILES  
SELECT  
 @FNAME,  
 @FNAME,  
 CNT = COUNT(1),  
 'B',  
 GETDATE(),  
 @UNAME,  
 'RECEIPT/PAYMENT UPLOAD'  
  
INSERT INTO  
 #RECPAY_TABLE  
 (  
  SERIAL_NO,  
  EDATE,  
  VOUCHER_DATE,  
  CLIENT_CODE,  
  AMOUNT,  
  DRCR,  
  NARRATION,  
  BANK_CODE,  
  BANK_NAME,  
  REF_NO,  
  BRANCHCODE,  
  BRANCH_NAME,  
  CHQ_MODE,  
  CHQ_DATE,  
  CHQ_NAME,  
  CL_MODE  
 )  
SELECT  
 SERIAL_NO,  
 EDATE,  
 VOUCHER_DATE,  
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),  
 AMOUNT,  
 UPPER(LTRIM(RTRIM(DRCR))),  
 NARRATION,  
 UPPER(LTRIM(RTRIM(BANK_CODE))),  
 UPPER(LTRIM(RTRIM(BANK_NAME))),  
 REF_NO,  
 UPPER(LTRIM(RTRIM(BRANCHCODE))),  
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),  
 UPPER(LTRIM(RTRIM(CHQ_MODE))),  
 CHQ_DATE,  
 CHQ_NAME,  
 CL_MODE  
FROM  
 #RECPAY_TABLE_TMP  
  
UPDATE  
 #RECPAY_TABLE  
SET  
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))  
  
  
SELECT  
 @@ERROR_COUNT = COUNT(DISTINCT VDT)  
FROM  
 #RECPAY_TABLE  
  
IF @@ERROR_COUNT > 1  
 BEGIN  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRANSACTION  
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'  
  RETURN  
 END  
  
SELECT TOP 1  
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)  
FROM  
 #RECPAY_TABLE  
  
SELECT  
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),  
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),  
 @@BRANCHFLAG = BRANCHFLAG,  
 @@VNOFLAG = VNOFLAG  
FROM  
 PARAMETER  
WHERE  
 @@VDT BETWEEN SDTCUR AND LDTCUR  
  
IF @@BRANCHFLAG = 1  
 BEGIN  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   BRANCHCODE = A.BRANCHCODE,  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = C.COSTCODE,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = COSTNAME  
    
  UPDATE  
   #RECPAY_TABLE  
  SET  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = 'ALL'  
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'  
  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   BRANCHCODE = 'HO',  
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),  
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),  
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),  
   FYSTART = P.SDTCUR,  
   FYEND = P.LDTCUR,  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND P.CURYEAR = 1  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
   AND A.BRANCHCODE = 'ALL'  
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'  
 END  
ELSE  
 BEGIN  
  UPDATE  
   #RECPAY_TABLE  
  SET  
   FYSTART = @@STD_DATE,  
   FYEND = @@LST_DATE + ' 23:59:59',  
   UPDFLAG = 'Y',  
   ACNAME = A.LONGNAME,  
   BANKNAME = B.LONGNAME,  
   BOOKTYPE = B.BOOKTYPE,  
   MICRNO = ISNULL(B.MICRNO, 0)  
  FROM  
   ACMAST A, ACMAST B  
  WHERE  
   A.CLTCODE = CLIENT_CODE  
   AND B.CLTCODE = BANK_CODE  
   AND A.ACCAT IN ('3','4')  
   AND B.ACCAT = '2'  
 END  
  
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */  
  
 SELECT  
  @@ERROR_COUNT = COUNT(DISTINCT VDT)  
 FROM  
  #RECPAY_TABLE  
 IF @@ERROR_COUNT > 1  
  BEGIN  
   SELECT  
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE  
   FROM  
    V2_UPLOADED_FILES  
   WHERE  
    U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END  
 SELECT @@ERROR_COUNT = 0  
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/  
/*  
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)  
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'  
   DROP TABLE #RecPay_Table_Tmp  
   DROP TABLE #RecPay_Table  
   ROLLBACK TRAN  
   DELETE FROM V2_Uploaded_Files  
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END*/  
  
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */  
 SELECT  
  @@ERROR_COUNT = COUNT(1)  
 FROM  
  (  
   SELECT  
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),  
    SERIAL_NO  
   FROM  
    #RECPAY_TABLE  
   GROUP BY  
    SERIAL_NO  
   HAVING  
    COUNT(DISTINCT BANK_CODE) > 1  
  ) A  
 IF @@ERROR_COUNT > 0  
  BEGIN  
   SELECT  
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'  
   UNION ALL  
   SELECT  
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))  
   FROM  
    #RECPAY_TABLE  
   GROUP BY  
    SERIAL_NO  
   HAVING  
    COUNT(DISTINCT BANK_CODE) > 1  
  
   DROP TABLE #RECPAY_TABLE_TMP  
   DROP TABLE #RECPAY_TABLE  
   ROLLBACK TRAN  
   DELETE  
   FROM  
    V2_UPLOADED_FILES  
   WHERE  
    U_FILENAME = @FNAME  
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
   RETURN  
  END  
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
 SELECT DISTINCT  
  DRCR  
 FROM  
  #RECPAY_TABLE  
 ) A  
IF @@ERROR_COUNT > 1  
 BEGIN  
  SELECT  
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE  
  FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
ELSE  
 BEGIN  
  SELECT TOP 1  
   @@DRCR = DRCR,  
   @@VTYP =  
    (  
    CASE  
     WHEN DRCR = 'D'  
     THEN 3  
     ELSE 2  
    END  
    )  
  FROM  
   #RECPAY_TABLE  
  UPDATE  
   #RECPAY_TABLE  
  SET VTYP =  
   (  
    CASE  
     WHEN DRCR = 'D'  
     THEN 3  
     ELSE 2  
    END  
   )  
 END  
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/  
 SELECT @@ERROR_COUNT = COUNT(1)  
 FROM #RECPAY_TABLE  
 WHERE VDT > EDT  
            IF @@ERROR_COUNT > 0  
             BEGIN  
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'  
     DROP TABLE #RECPAY_TABLE_TMP  
     DROP TABLE #RECPAY_TABLE  
     ROLLBACK TRAN  
     DELETE FROM  
      V2_UPLOADED_FILES  
     WHERE  
      U_FILENAME = @FNAME  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
     RETURN  
             END  
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/  
 SELECT @@ERROR_COUNT = COUNT(1)  
 FROM #RECPAY_TABLE  
 WHERE AMOUNT <= 0  
 IF @@ERROR_COUNT > 0  
  BEGIN  
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'  
     DROP TABLE #RECPAY_TABLE_TMP  
     DROP TABLE #RECPAY_TABLE  
     ROLLBACK TRAN  
     DELETE FROM  
      V2_UPLOADED_FILES  
     WHERE  
      U_FILENAME = @FNAME  
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
     RETURN  
  END  
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT DISTINCT  
   DDNO  = RP.REF_NO  
  FROM  
   #RECPAY_TABLE RP,  
   LEDGER1 L1  
    WITH(NOLOCK)  
  WHERE  
   L1.DDNO = RP.REF_NO  
   AND L1.BNKNAME = RP.BANK_NAME
   AND L1.DD = RP.CHQ_MODE  
   AND L1.DRCR = @@DRCR  
   AND L1.VTYP = @@VTYP  
   AND RP.REF_NO <> 0  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'  
  UNION ALL  
  SELECT DISTINCT  
   RP.REF_NO, 'NA','NA'  
  FROM  
   #RECPAY_TABLE RP,  
   LEDGER1 L1  
    WITH(NOLOCK)  
  WHERE  
   L1.DDNO = RP.REF_NO  
   AND L1.BNKNAME = RP.BANK_NAME
   AND L1.DD = RP.CHQ_MODE  
   AND L1.DRCR = @@DRCR  
   AND L1.VTYP = @@VTYP  
   AND RP.CHQ_MODE <> 'N'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/  
SELECT  
 @@ERROR_COUNT = COUNT(1)  
FROM  
 (  
  SELECT DISTINCT  
   CLIENT_CODE  
  FROM  
   #RECPAY_TABLE  
  WHERE  
   UPDFLAG = 'N'  
 ) A  
IF @@ERROR_COUNT > 0  
 BEGIN  
  SELECT  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'  
  UNION ALL  
  SELECT DISTINCT  
   CLIENT_CODE, 'NA','NA'  
  FROM  
   #RECPAY_TABLE  
  WHERE  
   UPDFLAG = 'N'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM  
   V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */  
  SET @@VNOCUR = CURSOR FOR  
   SELECT DISTINCT  
    BANK_CODE,  
    BOOKTYPE  
   FROM  
    #RECPAY_TABLE WITH(NOLOCK)  
  OPEN @@VNOCUR  
  FETCH NEXT  
   FROM  
    @@VNOCUR  
   INTO  
    @@BANK_CODE,  
    @@BOOKTYPE  
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/  
    SELECT  
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)  
    FROM  
     USERWRITESTABLE  
    WHERE  
     USERCATEGORY = @USERCAT  
     AND VTYP = @@VTYP  
     AND BOOKTYPE = @@BOOKTYPE  
    SELECT  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS  
    SELECT  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)  
    FROM  
     #RECPAY_TABLE  
    WHERE  
     VDT < @@BACKDATE  

    IF @@ERROR_COUNT > 0  
     BEGIN  
      SELECT  
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'  
      DROP TABLE #RECPAY_TABLE_TMP  
      DROP TABLE #RECPAY_TABLE  
      ROLLBACK TRAN  
      DELETE FROM V2_UPLOADED_FILES  
      WHERE  
       U_FILENAME = @FNAME  
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
      RETURN  
     END
  
    IF @@BRANCHFLAG = 1  
     BEGIN  
      SELECT  
       @@BANKBRANCH = BRANCHCODE,  
       @@BANKCOST = ISNULL(C.COSTCODE, -1)  
      FROM  
       ACMAST A  
        LEFT OUTER JOIN  
        COSTMAST C  
        ON  
         (  
          A.BRANCHCODE = C.COSTNAME  
         )  
      WHERE  
       A.CLTCODE = @@BANK_CODE  
      IF @@BANKBRANCH <> 'ALL'  
       BEGIN  
        UPDATE  
         RP  
          SET COSTCODE = @@BANKCOST  
        FROM  
         #RECPAY_TABLE RP,  
         ACMAST A  
        WHERE  
         A.CLTCODE = RP.CLIENT_CODE  
         AND A.BRANCHCODE = 'ALL'  
        UPDATE  
         #RECPAY_TABLE  
          SET BANKCOST = @@BANKCOST  
        WHERE  
         BANK_CODE = @@BANK_CODE  
       END  
      ELSE  
       BEGIN  
        UPDATE  
         #RECPAY_TABLE  
          SET COSTCODE =  
           (  
            SELECT TOP 1  
             COSTCODE  
            FROM  
             COSTMAST  
            WHERE  
             COSTNAME = 'HO'  
           )  
        WHERE  
         COSTCODE = ''  
         AND BANK_CODE = @@BANK_CODE  
                            SET @@COSTCODEUPDATES = CURSOR FOR  
                                       SELECT  
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)  
                                       FROM  
                                             #RECPAY_TABLE WITH(NOLOCK)  
                                       WHERE  
          BANK_CODE = @@BANK_CODE  
                                       GROUP BY  
                                             SERIAL_NO  
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1  
                            OPEN @@COSTCODEUPDATES  
                            FETCH NEXT  
                             FROM  
                              @@COSTCODEUPDATES  
                             INTO  
                              @@SERIAL_NO,  
                              @@COSTCODECOUNT  
                            WHILE @@FETCH_STATUS = 0  
                             BEGIN  
          UPDATE  
           #RECPAY_TABLE  
            SET BANKCOST =  
             (  
              SELECT TOP 1  
               COSTCODE  
              FROM  
               COSTMAST  
              WHERE  
               COSTNAME = 'HO'  
             )  
          WHERE  
           (BANKCOST = ''   OR BANKCOST IS NULL)  
           AND BANK_CODE = @@BANK_CODE  
                                           AND SERIAL_NO = @@SERIAL_NO  
                              FETCH NEXT  
                               FROM  
                                @@COSTCODEUPDATES  
                               INTO  
                                @@SERIAL_NO,  
                                @@COSTCODECOUNT  
                             END  
                            CLOSE @@COSTCODEUPDATES  
                            DEALLOCATE @@COSTCODEUPDATES  
                  UPDATE  
                   #RECPAY_TABLE  
                    SET BANKCOST = COSTCODE  
                  WHERE  
                   BANK_CODE = @@BANK_CODE  
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)  
       END  
     END  
    CREATE TABLE  
     #BANK_VNO  
     (  
      SRNO INT,  
      NEWSRNO INT IDENTITY (1, 1)  
     )  
    INSERT INTO  
     #BANK_VNO  
    SELECT  
     DISTINCT SERIAL_NO  
    FROM  
     #RECPAY_TABLE  
    WHERE  
     BANK_CODE = @@BANK_CODE  
     AND BOOKTYPE = @@BOOKTYPE  
  
    SELECT  
     @@MAXCOUNT = COUNT(DISTINCT SNO)  
    FROM  
     #RECPAY_TABLE  
  
    SELECT TOP 1  
     @@VDT = VDT  
    FROM  
     #RECPAY_TABLE  
    SELECT  
     LASTVNO  
    INTO #VNO  
    FROM  
     LASTVNO  
    WHERE  
     1 = 2  
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  
    INSERT  
    INTO #VNO  
     EXEC ACC_GENVNO_NEW  
      @@VDT,  
      @@VTYP,  
      @@BOOKTYPE,  
      @@STD_DATE,  
      @@LST_DATE,  
      @@MAXVNO  
    SELECT  
     @@NEWVNO = LASTVNO  
    FROM  
     #VNO  
    UPDATE  
     RP  
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))  
    FROM  
     #RECPAY_TABLE RP,  
     #BANK_VNO BV  
    WHERE  
     RP.SERIAL_NO = BV.SRNO  
   DROP TABLE #VNO  
   DROP TABLE #BANK_VNO  
  FETCH NEXT  
   FROM @@VNOCUR  
   INTO  
    @@BANK_CODE,  
    @@BOOKTYPE  
 END  
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */  
UPDATE  
 #RECPAY_TABLE  
  SET LNO = 2  
WHERE  
 VNO IN  
  (  
   SELECT  
    VNO  
   FROM  
    #RECPAY_TABLE  
     WITH(NOLOCK)  
   GROUP BY  
    VNO  
   HAVING  
    COUNT(*) = 1  
  )  
SET @@LNOCUR = CURSOR FOR  
 SELECT  
  VNO  
 FROM  
  #RECPAY_TABLE  
   WITH(NOLOCK)  
 GROUP BY  
  VNO  
 HAVING  
  COUNT(*) > 1  
OPEN @@LNOCUR  
FETCH NEXT  
 FROM  
  @@LNOCUR  
 INTO  
  @@LNOVNO  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  CREATE TABLE  
   [#LNOGEN]  
    (  
     VNO VARCHAR(12),  
     SNO INT,  
     LNO INT IDENTITY(1,1)  
    )  
  INSERT INTO  
   #LNOGEN  
    SELECT  
     VNO,  
     SNO  
    FROM  
     #RECPAY_TABLE  
      WITH(NOLOCK)  
    WHERE  
     VNO = @@LNOVNO  
    ORDER BY  
     SNO  
  UPDATE  
   #RECPAY_TABLE  
    SET LNO = L.LNO + 1  
  FROM  
   #LNOGEN L  
  WHERE  
   #RECPAY_TABLE.VNO = L.VNO  
   AND #RECPAY_TABLE.SNO = L.SNO  
   AND #RECPAY_TABLE.LNO = 0  
  DROP TABLE #LNOGEN  
  FETCH NEXT  
   FROM  
    @@LNOCUR  
   INTO  
    @@LNOVNO  
 END  
CLOSE @@LNOCUR  
DEALLOCATE @@LNOCUR  
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */  
INSERT INTO  
 LEDGER1  
  (  
   BNKNAME,  
   BRNNAME,  
   DD,  
   DDNO,  
   DDDT,  
   RELDT,  
   RELAMT,  
   REFNO,  
   RECEIPTNO,  
   VTYP,  
   VNO,  
   LNO,  
   DRCR,  
   BOOKTYPE,  
   MICRNO,  
   SLIPNO,  
   SLIPDATE,  
   CHEQUEINNAME,  
   CHQPRINTED,  
   CLEAR_MODE  
  )  
SELECT  
 BNKNAME = MAX(BANK_NAME),  
 BRNNAME = MAX(BRANCH_NAME),  
 DD = MAX(CHQ_MODE),  
 DDNO = MAX(REF_NO),  
 DDDT = MAX(DDDT),  
 RELDT = '',  
 RELAMT = SUM(AMOUNT),  
 REFNO = 0,  
 RECEIPTNO = 0,  
 VTYP,  
 VNO,  
 LNO = 2,  
 DRCR,  
 BOOKTYPE = BOOKTYPE,  
 MICRNO = MAX(MICRNO),  
 SLIPNO = 0,  
 SLIPDATE = '',  
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),  
 CHQPRINTED = 0,  
 CLEAR_MODE = MAX(CL_MODE)  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 DRCR,  
 BOOKTYPE  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
  
/*================================  
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK  
=================================*/  
CREATE TABLE #LEDGER  
(  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 EDT DATETIME,  
 LNO SMALLINT,  
 ACNAME VARCHAR(100),  
 DRCR VARCHAR(1),  
 VAMT MONEY,  
 VDT DATETIME,  
 VNO1 VARCHAR(12),  
 REFNO CHAR(12),  
 BALAMT MONEY,  
 NODAYS INT,  
 CDT DATETIME,  
 CLTCODE VARCHAR(10),  
 BOOKTYPE VARCHAR(2),  
 ENTEREDBY VARCHAR(25),  
 PDT DATETIME,  
 CHECKEDBY VARCHAR(25),  
 ACTNODAYS INT,  
 NARRATION VARCHAR(234)  
)  
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0  
CREATE TABLE #LEDGER3  
(  
 NARATNO INT,  
 NARR VARCHAR(234),  
 REFNO CHAR(12),  
 VTYP SMALLINT,  
 VNO VARCHAR(12),  
 BOOKTYPE VARCHAR(2)  
)  
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER  
 (  
  VTYP,  
  VNO,  
  EDT,  
  LNO,  
  ACNAME,  
  DRCR,  
  VAMT,  
  VDT,  
  VNO1,  
  REFNO,  
  BALAMT,  
  NODAYS,  
  CDT,  
  CLTCODE,  
  BOOKTYPE,  
  ENTEREDBY,  
  PDT,  
  CHECKEDBY,  
  ACTNODAYS,  
  NARRATION  
 )  
SELECT  
 VTYP,  
 VNO,  
 EDT = EDT,  
 LNO,  
 ACNAME,  
 DRCR,  
 VAMT = AMOUNT,  
 VDT,  
 VNO1 = VNO,  
 REFNO = 0,  
 BALAMT = AMOUNT,  
 NODAYS = 0,  
 CDT = GETDATE(),  
 CLTCODE = CLIENT_CODE,  
 BOOKTYPE = BOOKTYPE,  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),  
 PDT = GETDATE(),  
 CHECKEDBY = @UNAME,  
 ACTNODAYS = 0,  
 NARRATION  
FROM  
 #RECPAY_TABLE  
/*==============================  
BANK SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER  
SELECT  
 VTYP,  
 VNO,  
 EDT = EDT,  
 LNO = 1,  
 BANKNAME,  
 DRCR =  
  (  
   CASE  
    WHEN DRCR = 'D'  
    THEN 'C'  
    ELSE 'D'  
   END  
  ),  
 VAMT = SUM(AMOUNT),  
 VDT,  
 VNO1 = VNO,  
 REFNO = 0,  
 BALAMT = SUM(AMOUNT),  
 NODAYS = 0,  
 CDT = GETDATE(),  
 CLTCODE = BANK_CODE,  
 BOOKTYPE = BOOKTYPE,  
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),  
 PDT = GETDATE(),  
 CHECKEDBY = @UNAME,  
 ACTNODAYS = 0,  
 NARRATION = MAX(NARRATION)  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 EDT,  
 DRCR,  
 VDT,  
 BANK_CODE,  
 BOOKTYPE,  
 BANKNAME  
/*==============================  
INSERTING ALL LEDGER RECORDS AT ONE TIME  
==============================*/  
INSERT INTO LEDGER  
SELECT  
 *  
FROM  
 #LEDGER  
ORDER BY  
 BOOKTYPE,  
 VTYP,  
 VNO,  
 LNO  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  DROP TABLE #LEDGER  
  DROP TABLE #LEDGER3  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
DROP TABLE #LEDGER  
/*==============================  
BANK SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER3  
SELECT  
 NARATNO = 1,  
 NARRATION = MAX(NARRATION),  
 REFNO = 0,  
 VTYP,  
 VNO,  
 BOOKTYPE  
FROM  
 #RECPAY_TABLE  
GROUP BY  
 VTYP,  
 VNO,  
 BOOKTYPE  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
INSERT INTO  
 #LEDGER3  
SELECT  
 NARATNO = LNO,  
 NARR = NARRATION,  
 REFNO = 0,  
 VTYP,  
 VNO,  
 BOOKTYPE  
FROM  
 #RECPAY_TABLE  
  
  
/*==============================  
INSERTING ALL LEDGER3 RECORDS AT ONE TIME  
==============================*/  
INSERT INTO LEDGER3  
SELECT  
 *  
FROM  
 #LEDGER3  
ORDER BY  
 BOOKTYPE,  
 VTYP,  
 VNO,  
 NARATNO  
  
IF @@ERROR <> 0  
 BEGIN  
  SELECT  
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'  
  DROP TABLE #RECPAY_TABLE_TMP  
  DROP TABLE #RECPAY_TABLE  
  DROP TABLE #LEDGER3  
  ROLLBACK TRAN  
  DELETE FROM V2_UPLOADED_FILES  
  WHERE  
   U_FILENAME = @FNAME  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'  
  RETURN  
 END  
DROP TABLE #LEDGER3  
  
  
IF @@BRANCHFLAG = 1  
 BEGIN  
  SET @@L2CUR = CURSOR FOR  
   SELECT DISTINCT  
    VNO  
   FROM  
    #RECPAY_TABLE  
   ORDER BY  
    VNO  
  OPEN @@L2CUR  
   FETCH NEXT  
   FROM  
    @@L2CUR  
   INTO  
    @@L2VNO  
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
    DELETE FROM  
     TEMPLEDGER2  
    WHERE  
     SESSIONID = '9999999999'  
/*==============================  
CLIENT SIDE RECORD  
==============================*/  
    INSERT INTO  
     TEMPLEDGER2  
    SELECT  
     'BRANCH',  
     C.COSTNAME,  
     AMOUNT,  
     VTYP,  
     VNO,  
     LNO,  
     DRCR,  
     '0',  
     BOOKTYPE,  
     '9999999999',  
     CLIENT_CODE,  
     'A',  
     '0'  
    FROM  
     #RECPAY_TABLE RP,  
     COSTMAST C  
    WHERE  
     RP.COSTCODE = C.COSTCODE  
     AND VNO = @@L2VNO  
/*==============================  
BANK SIDE RECORD  
==============================*/  
    INSERT INTO  
     TEMPLEDGER2  
    SELECT  
     'BRANCH',  
     C.COSTNAME,  
     SUM(AMOUNT),  
     VTYP,  
     VNO,  
     LNO = 1,  
     DRCR =  
      (  
       CASE  
       WHEN DRCR = 'D'  
       THEN 'C'  
       ELSE 'D'  
       END  
      ),  
     '0',  
     BOOKTYPE,  
     '9999999999',  
     BANK_CODE,  
     'A',  
     '0'  
    FROM  
     #RECPAY_TABLE RP,  
     COSTMAST C  
    WHERE  
     RP.BANKCOST = C.COSTCODE  
     AND VNO = @@L2VNO  
    GROUP BY  
     C.COSTNAME,  
     VTYP,  
     VNO,  
      (  
       CASE  
       WHEN DRCR = 'D'  
       THEN 'C'  
       ELSE 'D'  
       END  
      ),  
     BANK_CODE,  
     BOOKTYPE  
    EXEC INSERTTOLEDGER2  
     '9999999999',  
     @@L2VNO,  
     '1',  
     '1',  
     '1',  
     'BROKER',  
     'BROKER'  
    FETCH NEXT  
     FROM  
      @@L2CUR  
     INTO  
      @@L2VNO  
   END  
  DELETE FROM  
   TEMPLEDGER2  
  WHERE  
   SESSIONID = '9999999999'  
  COMMIT TRAN  
 END  
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL  
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE  
DROP TABLE #RECPAY_TABLE_TMP  
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REPROCESS_RECO
-- --------------------------------------------------

CREATE PROC [dbo].[REPROCESS_RECO]      
 @BANKCODE VARCHAR(10),      
 @PROCESS_DATE VARCHAR(10)      
      
AS      
      
DECLARE       
 @@MICRNO VARCHAR(20),      
 @@TABLE_EXIST VARCHAR(20),            
 @@RECORD_COUNT SMALLINT,            
 @@RECO_STATUS CHAR(1),            
 @@CLTCODE_EXIST INT,      
 @@PROC_DATE VARCHAR(11)      
      
      
CREATE TABLE #BANKRECOSAVE      
(      
 Cltcode VARCHAR(10),      
 Bookdate DATETIME,      
 [Description] VARCHAR(200),      
 Amount MONEY,      
 Drcr CHAR(1),      
 Valuedate DATETIME,      
 Referenceno VARCHAR(30),      
 Crossreferenceno BIGINT,      
 STATUS VARCHAR(15),      
 BR_SNo BIGINT,      
 MICRNO VARCHAR(10),      
 AMOUNTLEDGR1 MONEY      
)      
      
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'RECOPROCESS'            
            
IF @@TABLE_EXIST = ''            
BEGIN            
 CREATE TABLE RECOPROCESS (INPROCESS VARCHAR(1))            
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT @@RECORD_COUNT = COUNT(*) FROM RECOPROCESS            
            
IF @@RECORD_COUNT = 0            
BEGIN            
 INSERT INTO RECOPROCESS (INPROCESS) VALUES ('N')            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT TOP 1 @@RECO_STATUS = INPROCESS FROM RECOPROCESS            
            
IF @@RECO_STATUS = 'N'            
BEGIN            
 BEGIN TRAN            
 UPDATE RECOPROCESS SET INPROCESS = 'Y'            
END            
ELSE            
BEGIN            
 SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'            
 RETURN            
END            
            
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'LEDGER_UPDATES'            
IF @@TABLE_EXIST <> ''            
BEGIN            
 DROP TABLE LEDGER_UPDATES            
END            
            
SET @@TABLE_EXIST = ''            
SELECT @@TABLE_EXIST = NAME FROM SYSOBJECTS WHERE NAME = 'BANKRECOCOMP'            
IF @@TABLE_EXIST <> ''            
BEGIN            
 DROP TABLE BANKRECOCOMP            
END            
            
CREATE TABLE LEDGER_UPDATES (VNO VARCHAR(12),VTYP VARCHAR(2),BOOKTYPE VARCHAR(2),VALUEDATE DATETIME)            
      
SELECT @@CLTCODE_EXIST = COUNT(1) FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2            
            
IF @@CLTCODE_EXIST = 0            
 BEGIN            
  SELECT 'BANK CODE DOSE NOT EXIST.'        
  ROLLBACK TRAN        
  RETURN            
 END            
      
SELECT @@MICRNO = MICRNO FROM ACMAST WHERE CLTCODE = @BANKCODE  AND ACCAT = 2            
      
      
SELECT @@PROC_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESS_DATE, 103), 109)      
    
    
SELECT     
 @@RECORD_COUNT = COUNT(1)     
FROM     
 BANKRECO     
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'    
    
IF @@RECORD_COUNT = 0    
BEGIN    
 SELECT 'THE STATEMENT FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS NOT UPLOADED.'    
 ROLLBACK TRAN    
 RETURN    
END    
    
SELECT     
 @@RECORD_COUNT = COUNT(1)     
FROM     
 BANKRECO     
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'    
 AND STATUS = 'UNMATCHED'    
    
IF @@RECORD_COUNT = 0    
BEGIN    
 PRINT 'ALL THE RECORDS FOR SELECTED DATE ' + @@PROC_DATE + ' FOR ' + @BANKCODE + ' IS ALREADY MATCHED.'    
 ROLLBACK TRAN    
 RETURN    
END    
      
INSERT INTO #BANKRECOSAVE      
SELECT      
 Cltcode,      
 Bookdate,      
 [Description],      
 Amount,      
 Drcr,      
 Valuedate,      
 Referenceno,      
 Crossreferenceno,      
 STATUS,      
 BR_SNo,      
 MICRNO,      
 0      
FROM      
 BANKRECO      
WHERE      
 CLTCODE = @BANKCODE      
 AND BOOKDATE LIKE @@PROC_DATE + '%'      
 AND STATUS = 'UNMATCHED'      
      
      
UPDATE            
 #BANKRECOSAVE            
SET            
 STATUS ='MATCHED'            
FROM            
 LEDGER1            
WHERE            
 LEDGER1.VTYP IN ( '2', '3', '5', '19', '20', '17' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND  RTRIM(DDNO)  =  RTRIM(REFERENCENO)            
 AND CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), VDT, 101))        
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND   REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO            
 LEDGER_UPDATES            
SELECT           
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE            
FROM            
 #BANKRECOSAVE, LEDGER1 (NOLOCK), LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17' )            
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE            
 AND LEDGER1.VNO = LEDGER.VNO            
 AND LEDGER1.VTYP = LEDGER.VTYP            
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND DDNO =  REFERENCENO            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1 (NOLOCK), LEDGER L2 (NOLOCK) WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), L2.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101))            
 AND CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101) >= CONVERT(VARCHAR(11), LEDGER.VDT, 101)    
 AND   REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
UPDATE            
 LEDGER1            
SET            
 RELDT = VALUEDATE , REFNO = #BANKRECOSAVE.CROSSREFERENCENO            
FROM            
 #BANKRECOSAVE, LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP ='3' OR LEDGER1.VTYP = '19' OR LEDGER1.VTYP ='20' OR LEDGER1.VTYP = '5' or LEDGER1.VTYP = '17')            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND DDNO =  REFERENCENO            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT) FROM LEDGER1 L1, LEDGER L2 WHERE L2.VNO=L1.VNO AND L2.VTYP=L1.VTYP AND L2.BOOKTYPE=L1.BOOKTYPE AND RELDT = '' AND CLTCODE= @BANKCODE AND #BANKRECOSAVE.REFERENCENO=DDNO AND #BANKRECOSAVE.DRCR = L1.DRCR AND CONVERT(VARCHAR(11), L2.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101))      
 AND REFERENCENO  <> '0'            
 AND LEDGER.VNO = LEDGER1.VNO            
 AND LEDGER.VTYP = LEDGER1.VTYP            
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE            
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE   
 AND CONVERT(VARCHAR(11), LEDGER.VDT, 101) <= CONVERT(VARCHAR(11), #BANKRECOSAVE.VALUEDATE, 101)             
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
SELECT            
 SUM(RELAMT) AS AMOUNT,            
 SLIPNO AS SLIPNO,            
 UPPER(DRCR) AS DRCR,            
 MICRNO            
INTO            
 BANKRECOCOMP            
FROM            
 LEDGER1            
WHERE            
 MICRNO = @@MICRNO            
 AND (VTYP ='2' OR VTYP = '19' OR  VTYP = '5' )            
 AND SLIPNO <>''            
GROUP BY            
 SLIPNO,            
 DRCR,            
 MICRNO            
            
            
UPDATE            
 #BANKRECOSAVE            
SET            
 AMOUNTLEDGR1 =BANKRECOCOMP.AMOUNT, STATUS ='MATCHED'            
FROM            
 BANKRECOCOMP            
WHERE            
  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)            
  AND RTRIM(BANKRECOCOMP.SLIPNO)  =  RTRIM(REFERENCENO)            
  AND #BANKRECOSAVE.MICRNO = @@MICRNO            
  AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT            
  AND #BANKRECOSAVE.MICRNO =BANKRECOCOMP.MICRNO            
  AND REFERENCENO  <> '0'            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
INSERT INTO LEDGER_UPDATES            
SELECT            
 LEDGER1.VNO,LEDGER1.VTYP,LEDGER1.BOOKTYPE,#BANKRECOSAVE.VALUEDATE            
FROM            
 #BANKRECOSAVE (NOLOCK), LEDGER1 (NOLOCK), LEDGER (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = LEDGER.CLTCODE            
 AND LEDGER1.VNO = LEDGER.VNO            
 AND LEDGER1.VTYP = LEDGER.VTYP            
 AND LEDGER1.BOOKTYPE = LEDGER.BOOKTYPE            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 (NOLOCK) WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
            
UPDATE            
 LEDGER1            
SET            
 RELDT = VALUEDATE ,            
 REFNO = #BANKRECOSAVE.CROSSREFERENCENO            
FROM            
 #BANKRECOSAVE, LEDGER  (NOLOCK)            
WHERE            
 (LEDGER1.VTYP ='2' OR LEDGER1.VTYP = '19' OR  LEDGER1.VTYP = '5' )            
 AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)            
 AND RTRIM(LEDGER1.SLIPNO) = RTRIM(#BANKRECOSAVE.REFERENCENO)            
 AND RELDT = ''            
 AND #BANKRECOSAVE.CLTCODE = @BANKCODE            
 AND #BANKRECOSAVE.MICRNO = @@MICRNO            
 AND #BANKRECOSAVE.MICRNO =LEDGER1.MICRNO            
 AND #BANKRECOSAVE.REFERENCENO  <> '0'            
 AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(LEDGER1.RELAMT) FROM LEDGER1 WHERE  REFERENCENO = CONVERT(VARCHAR,SLIPNO) AND UPPER(DRCR) = UPPER(#BANKRECOSAVE.DRCR) AND RELDT='' AND  MICRNO = @@MICRNO)            
 AND LEDGER.VNO = LEDGER1.VNO            
 AND LEDGER.VTYP = LEDGER1.VTYP            
 AND LEDGER.BOOKTYPE = LEDGER1.BOOKTYPE            
 AND LEDGER.CLTCODE = #BANKRECOSAVE.CLTCODE            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
UPDATE            
 L            
SET            
 EDT = VALUEDATE            
FROM            
 LEDGER L, LEDGER_UPDATES LU            
WHERE            
 LU.VNO=L.VNO            
 AND LU.VTYP=L.VTYP            
 AND LU.BOOKTYPE=L.BOOKTYPE            
 AND EDT LIKE 'DEC 31 2049%'            
            
IF @@ERROR <> 0            
BEGIN      
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'            
 ROLLBACK TRAN            
 RETURN            
END            
            
UPDATE            
 L            
SET            
 EDT = VDT            
FROM            
 LEDGER L, LEDGER_UPDATES LU            
WHERE            
 LU.VNO=L.VNO            
 AND LU.VTYP=L.VTYP            
 AND LU.BOOKTYPE=L.BOOKTYPE            
 AND CONVERT(DATETIME, (CONVERT(VARCHAR(11), EDT, 109))) < CONVERT(DATETIME, (CONVERT(VARCHAR(11), VDT, 109)))            
            
IF @@ERROR <> 0            
BEGIN            
 SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'            
 ROLLBACK TRAN            
 RETURN            
END            
            
DROP TABLE BANKRECOCOMP            
DROP TABLE LEDGER_UPDATES            
      
UPDATE BR       
SET STATUS = 'MATCHED'      
FROM BANKRECO BR, #BANKRECOSAVE BR1      
WHERE BR.BR_SNo = BR1.BR_SNo AND BR1.STATUS = 'MATCHED'      
      
        
UPDATE RECOPROCESS SET INPROCESS = 'N'            
            
COMMIT TRAN            
            
SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK
-- --------------------------------------------------

create PROC [DBO].[RETURNCANCEL_BULK]                  
 @VTYPE SMALLINT,    
 @FNAME VARCHAR(100),                
 @UNAME VARCHAR(25),                
 @USERCAT SMALLINT                
                                    
AS                                    
/*                                    
BEGIN TRAN                                    
SP_HELPTRIGGER LEDGER                                    
LEDGER_TRG_BILL                                    
LEDGER_TRG                                    
EXEC RECPAYUPLOAD_BULK 'D:\BACKOFFICE\RECPAYFILES\SAMPLE1.CSV', 'JAYDEEP', 388                                    
SELECT TOP 1 * FROM LEDGER3                                    
SELECT TOP 1 * FROM LEDGER_TRG                                    
ROLLBACK                                    
*/                                    
SET NOCOUNT ON                                    
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE B ASED ON DRCR ------------------------*/                                    
DECLARE                                    
 @@STD_DATE VARCHAR(11),                                    
 @@LST_DATE VARCHAR(11),                                    
 @@BRANCHFLAG AS TINYINT,                                    
 @@VNOFLAG AS TINYINT,                                    
 @@VNOMETHOD INT,                                    
 @@ACNAME CHAR(100),                                    
 @@BOOKTYPE CHAR(2),                                    
 @@MICRNO VARCHAR(10),                                    
 @@DRCR VARCHAR(1),                                    
 @@VTYP SMALLINT,                                    
 @@BANK_CODE VARCHAR(100),                                    
 @@BACKDAYS INT,                                    
 @@BACKDATE VARCHAR(11),                                    
 @@BRNCOUNT   TINYINT,                                    
 @@MONTHLYVDT VARCHAR(11),                                    
 @@SERIAL_NO INT,                                    
 @@COSTCODECOUNT TINYINT,                                    
 @@COSTCODEUPDATES CURSOR,                                    
 @@NEWVNO AS VARCHAR(12),                                    
 @@MAXCOUNT AS INT,                                    
 @@VDT AS VARCHAR(11),                                    
 @@BANKBRANCH AS VARCHAR(10),                                    
 @@BANKCOST AS NUMERIC,                                    
 @@LNOCUR AS CURSOR,                                    
 @@VNOCUR AS CURSOR,                                    
 @@LNOVNO AS VARCHAR(12),                                    
 @@MAXVNO AS INT,                                    
 @@L2CUR AS CURSOR,                                    
 @@L2VNO AS VARCHAR(12),                                    
 @@ERROR_COUNT AS INT,                                    
 @@FILEEXISTS AS INT,                                    
 @@SQL AS VARCHAR(2000)                                    
                                    
                          
CREATE TABLE #FEXIST                                    
(                                    
 F1 SMALLINT,                                    
 F2 SMALLINT,                                    
 F3 SMALLINT                                    
)                                    
SELECT @@SQL = "INSERT INTO "                                    
SELECT @@SQL = @@SQL + " #FEXIST "                                    
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                                    
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                                    
                                    
EXEC(@@SQL)                                    
                                    
SELECT                                    
 @@FILEEXISTS = F1                                    
FROM                                    
 #FEXIST                                    
                                    
IF @@FILEEXISTS = 0                                    
 BEGIN                                    
  DROP TABLE #FEXIST                                    
  SELECT                                    
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                                    
  RETURN                                    
 END                                    
DROP TABLE #FEXIST                                   
                                    
BEGIN TRAN                                    
CREATE TABLE #RECPAY_TABLE_TMP                                    
(                      
 PRODUCT_CO VARCHAR(10),                
 INST_NMBR VARCHAR(15),                
 INST_DATE VARCHAR(10),                
 BENEF_DESCRIPTION  VARCHAR(200),                
 INSTRUMENT_AMNT  VARCHAR(50),                
 LOC_DESCRIPTION VARCHAR(100),                
 I_STAT VARCHAR(10),                
 ENRICH_VALUE VARCHAR(10),                
 NARRATION VARCHAR(250)                
)                       
            
CREATE TABLE [#RECPAY_TABLE]                                    
(                
 SRNO INT IDENTITY(1,1),                
 PRODUCT_CO VARCHAR(10),                
 INST_NMBR VARCHAR(15),                
 INST_DATE DATETIME,                
 BENEF_DESCRIPTION  VARCHAR(200),                
 INSTRUMENT_AMNT  MONEY,                
 LOC_DESCRIPTION VARCHAR(100),                
 I_STAT VARCHAR(10),                
 ENRICH_VALUE VARCHAR(10),                
 NARRATION VARCHAR(250),                
 VNO VARCHAR(12),                
 VTYP INT,                
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),                
 VTYP_REV VARCHAR(12)                
) ON [PRIMARY]                
                                    
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                                    
EXEC (@@SQL)                                    
                                    
IF @@ERROR <> 0                                    
 BEGIN                                    
  DROP TABLE #RECPAY_TABLE_TMP                                    
  DROP TABLE #RECPAY_TABLE                                    
  ROLLBACK TRANSACTION                                    
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                                    
  RETURN                                    
 END                                    
                
IF @VTYPE = 2      
BEGIN                
INSERT INTO #RECPAY_TABLE                
(                
 PRODUCT_CO,                
 INST_NMBR,                
 INST_DATE,                
 BENEF_DESCRIPTION,                
 INSTRUMENT_AMNT,                
 LOC_DESCRIPTION,                
 I_STAT,                
 ENRICH_VALUE,                
 NARRATION,                
 VNO,                
 VTYP,                
 BOOKTYPE                
)                
SELECT                
 PRODUCT_CO,                
 INST_NMBR,                
 CONVERT(DATETIME, INST_DATE, 103),                
 BENEF_DESCRIPTION,                
 CONVERT(MONEY, INSTRUMENT_AMNT),                
 LOC_DESCRIPTION,                
 I_STAT,                
 ENRICH_VALUE,                
 NARRATION,                
 VNO,                
 VTYP,                
 BOOKTYPE                
FROM                
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                
 (                
  SELECT                 
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                
  FROM                 
   LEDGER L,                 
   LEDGER1 L1                
  WHERE                 
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2
  GROUP BY CLTCODE, DDNO, RELAMT                
  HAVING COUNT(1) = 1                
 ) R1                
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT                
      
 UPDATE #RECPAY_TABLE SET VTYP_REV = 17       
END      
ELSE      
BEGIN     
INSERT INTO #RECPAY_TABLE
(                
 PRODUCT_CO,                
 INST_NMBR,                
 INST_DATE,                
 BENEF_DESCRIPTION,                
 INSTRUMENT_AMNT,                
 LOC_DESCRIPTION,                
 I_STAT,                
 ENRICH_VALUE,                
 NARRATION,                
 VNO,                
 VTYP,                
 BOOKTYPE                
)                
SELECT                
 PRODUCT_CO,                
 INST_NMBR,                
 CONVERT(DATETIME, INST_DATE, 103),                
 BENEF_DESCRIPTION,                
 CONVERT(MONEY, INSTRUMENT_AMNT),                
 LOC_DESCRIPTION,                
 I_STAT,                
 ENRICH_VALUE,                
 NARRATION,                
 VNO,                
 VTYP,                
 BOOKTYPE                
FROM             
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                
 (                
  SELECT                 
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                
  FROM                 
   LEDGER L,                 
   LEDGER1 L1                
  WHERE                 
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                
   AND L1.CLEAR_MODE <> 'C' AND L.VTYP = 3 AND L1.RELDT = ''     
  GROUP BY CLTCODE, DDNO, RELAMT                
  HAVING COUNT(1) = 1                
 ) R1                
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT       
      
 UPDATE #RECPAY_TABLE SET VTYP_REV = 16      
END      
                
                
SELECT TOP 1                                    
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),                
 @@VTYP = VTYP_REV,                
 @@BOOKTYPE = BOOKTYPE                                
FROM                                    
 #RECPAY_TABLE                                    
                              
                              
SELECT                                    
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                                    
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                                    
 @@BRANCHFLAG = BRANCHFLAG,                                    
 @@VNOFLAG = VNOFLAG                                    
FROM                                    
 PARAMETER                                    
WHERE                                    
 @@VDT BETWEEN SDTCUR AND LDTCUR                                 
                                    
IF @@VNOFLAG <> 0                               
BEGIN                                   
 SELECT                                    
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                                    
 FROM                                    
  #RECPAY_TABLE                              
                                     
 IF @@ERROR_COUNT > 1                                    
  BEGIN                                    
   DROP TABLE #RECPAY_TABLE_TMP                                    
   DROP TABLE #RECPAY_TABLE                                    
   ROLLBACK TRANSACTION                                    
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTS.'                                    
   RETURN                                    
  END                                  
END                   
                
                
                
SELECT                                    
  @@ERROR_COUNT = COUNT(1)                                    
 FROM                                    
  #RECPAY_TABLE                   
WHERE                 
 VNO IS NULL                
                
IF @@ERROR_COUNT > 0                               
BEGIN                 
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'                
 UNION ALL                
 SELECT 'CLTCODE , DDNO , AMOUNT '                
 UNION ALL                
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT                
 FROM   
  #RECPAY_TABLE                
 WHERE                 
  VNO IS NULL                
                
 DROP TABLE #RECPAY_TABLE_TMP                
 DROP TABLE #RECPAY_TABLE                
 ROLLBACK TRANSACTION                
                 
   RETURN                
END                
                
CREATE TABLE #VNO                
(                
 LASTVNO VARCHAR(12),                
)                
                    
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                                    
                
INSERT                                    
INTO #VNO                       
 EXEC ACC_GENVNO_NEW                                    
  @@VDT,                                    
  @@VTYP,                                    
  @@BOOKTYPE,                                    
  @@STD_DATE,                                    
  @@LST_DATE,                                    
  @@MAXVNO                        
                            
SELECT                                    
 @@NEWVNO = LASTVNO                
FROM                                    
 #VNO                    
             
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1                
                
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)                
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION                 
FROM LEDGER L, #RECPAY_TABLE R                
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE          
                
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)                
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,CASE WHEN @VTYPE = 2 THEN 'JAN 01 1900' ELSE INST_DATE END,RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE       
  
    
         
FROM LEDGER1 L, #RECPAY_TABLE R                
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                
                
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)                
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE                
FROM LEDGER2 L, #RECPAY_TABLE R                
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                
                
                
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)                
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE                
FROM LEDGER3 L, #RECPAY_TABLE R                
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                
                
UPDATE L SET CLEAR_MODE = CASE WHEN @VTYPE = 2 THEN 'R' ELSE 'C' END, RELDT = CASE WHEN @VTYPE = 2 THEN RELDT ELSE INST_DATE END  
FROM LEDGER1 L, #RECPAY_TABLE R                
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                 
                
SELECT 'FILE UPLOADED SUCCESSFULLY'                
UNION ALL                
SELECT 'VNO, VTYP, RECEIPT_VNO'                
UNION ALL                
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT                
FROM                       
 #RECPAY_TABLE                
                
COMMIT              
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW
-- --------------------------------------------------



--SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2

--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'

 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/        
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'           
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                  
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'
CREATE  PROC RPT_ACC_BANKBOOK_NEW
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                  
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                    
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                    
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                    
      @FCODE VARCHAR(10),                    
      @STATUSID VARCHAR(30),                    
      @STATUSNAME VARCHAR(30),                    
      @BRANCH VARCHAR(10),
      @SELECTIONBY VARCHAR(3) = 'VDT'                     
                    
AS                    
                    
DECLARE                    
	@@OPENDATE AS VARCHAR(11),                    
	@@REPDATE AS VARCHAR(8),                    
	@@STARTDATE AS VARCHAR(11), 
	@@COSTCODE AS SMALLINT


                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                    
                  
/*CREATE TABLE [DBO].[#TBL_GLREPORT] (                  
	[SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                  
	[BOOKTYPE] [CHAR] (2) NULL ,                  
	[VOUDT] [VARCHAR] (10) NULL ,                  
	[EFFDT] [VARCHAR] (10) NULL ,                  
	[SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                  
	[DRAMT] [MONEY] NULL ,                  
	[CRAMT] [MONEY] NULL ,                  
	[VNO] [VARCHAR] (12) NULL ,                  
	[NARRATION] [VARCHAR] (500) NULL ,                  
	[DDNO] [VARCHAR] (15) NULL ,                  
	[CLTCODE] [VARCHAR] (10) NOT NULL ,                  
	[LONGNAME] [VARCHAR] (100) NULL ,                  
	[VDT] [DATETIME] NULL ,                  
	[VTYP] [SMALLINT] NOT NULL ,                  
	[ACCAT] [CHAR] (2) NULL ,                  
	[OPBAL] [MONEY] NOT NULL ,                  
	[CROSAC] [VARCHAR] (10) NOT NULL ,                  
	[ACNAME] [VARCHAR] (100) NULL ,                  
	[BRANCHCODE] [VARCHAR] (10) NULL ,                  
	[PROCID] [BIGINT] NULL ,                  
	[REPDATE] [VARCHAR] (8) NULL ,                  
	[MAINCODE] [VARCHAR] (10) NULL ,                  
	[VCHDT] [DATETIME] NULL                  
)        */

SELECT * INTO #TBL_GLREPORT FROM TBL_GL          
                  
                    
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                  
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID

SELECT @@COSTCODE = -1

IF @STATUSID <> 'BROKER'
	BEGIN
		SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME 
	END
ELSE IF @STATUSID = 'BROKER'
	BEGIN
		IF @BRANCH <> '' OR @BRANCH <> '%'
			BEGIN
				SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH 
			END
	END

SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                    

IF @SELECTIONBY = 'VDT' 
BEGIN
	IF @STATUSID = 'BROKER'
		BEGIN                    
			IF @BRANCH = '' OR @BRANCH = '%'
				BEGIN
					PRINT 'CAME HERE - I'
					INSERT INTO TBL_OPPBALANCE                          
					SELECT 
						CLTCODE, 
						SUM(OPBAL) AS OPBAL,
						SPID , 
						CURDATE 
					FROM                    
						(SELECT 
							CLTCODE,
							SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                         
						FROM 
							LEDGER                        
						WHERE 
							CLTCODE = @FCODE 
							AND VTYP = 18 
							AND VDT LIKE @@STARTDATE + '%'
						GROUP BY 
							CLTCODE
						UNION ALL                    
						SELECT 
							CLTCODE,
							SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER                          
						WHERE 
							CLTCODE = @FCODE 
							AND VDT >= @@STARTDATE 
							AND VDT <  @FDATE                    
							AND VTYP <> 18                    
						GROUP BY 
							CLTCODE) A
					GROUP BY 
						CLTCODE, 
						SPID, 
						CURDATE
	
	                    
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A                  
					WHERE 
						L.VNO = L1.VNO                  
						AND L.VTYP = L1.VTYP                  
						AND L.BOOKTYPE = L1.BOOKTYPE                  
						AND L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L.CLTCODE <> @FCODE                  
						AND L.VTYP <> 18                  
				END
			ELSE
				BEGIN
					PRINT 'CAME HERE - II'
					INSERT INTO TBL_OPPBALANCE                          
					SELECT 
						CLTCODE, 
						SUM(OPBAL) AS OPBAL,
						SPID , 
						CURDATE 
					FROM                    
						(SELECT 
							L2.CLTCODE,
							SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE
						FROM 
							LEDGER L, LEDGER2 L2
						WHERE 
							L.VNO = L2.VNO
							AND L.VTYP = L2.VTYPE
							AND L.BOOKTYPE = L2.BOOKTYPE
							AND L.LNO = L2.LNO
							AND L.CLTCODE = L2.CLTCODE
							AND L2.CLTCODE = @FCODE 
							AND L2.COSTCODE = @@COSTCODE
							AND L.VTYP = 18 
							AND L.VDT LIKE @@STARTDATE + '%'
						GROUP BY 
							L2.CLTCODE 
			
						UNION ALL
			
						SELECT 
							L2.CLTCODE,
							SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER L, LEDGER2 L2
						WHERE 
							L.VNO = L2.VNO
							AND L.VTYP = L2.VTYPE
							AND L.BOOKTYPE = L2.BOOKTYPE
							AND L.LNO = L2.LNO
							AND L.CLTCODE = L2.CLTCODE
							AND L2.CLTCODE = @FCODE 
							AND L2.COSTCODE = @@COSTCODE
							AND L.VDT >= @@STARTDATE 
							AND L.VDT <  @FDATE 
							AND L2.VTYPE <> 18                    
						GROUP BY 
							L2.CLTCODE) A
					GROUP BY 
						CLTCODE, 
						SPID, 
						CURDATE
	
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L2.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A, LEDGER2 L2                  
					WHERE 
						L.VNO = L1.VNO                  
						AND L.VTYP = L1.VTYP                  
						AND L.BOOKTYPE = L1.BOOKTYPE                  
						AND L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE 
						AND L.BOOKTYPE = L2.BOOKTYPE
						AND L.LNO = L2.LNO
	--					AND L.DRCR = L2.DRCR
						AND L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L2.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L.CLTCODE <> @FCODE                  
						AND L2.COSTCODE = @@COSTCODE
						AND L.VTYP <> 18  
	
				END
		END
	ELSE
		BEGIN
			INSERT INTO TBL_OPPBALANCE                          
			SELECT 
				CLTCODE, 
				SUM(OPBAL) AS OPBAL,
				SPID , 
				CURDATE 
			FROM                    
				(SELECT 
					L2.CLTCODE,
					SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
					@@SPID AS SPID, 
					CONVERT(VARCHAR,GETDATE(),112) AS CURDATE
				FROM 
					LEDGER L, LEDGER2 L2
				WHERE 
					L.VNO = L2.VNO
					AND L.VTYP = L2.VTYPE
					AND L.BOOKTYPE = L2.BOOKTYPE
					AND L.LNO = L2.LNO
					AND L.CLTCODE = L2.CLTCODE
					AND L2.CLTCODE = @FCODE 
					AND L2.COSTCODE = @@COSTCODE
					AND L.VTYP = 18 
					AND L.VDT LIKE @@STARTDATE + '%'
				GROUP BY 
					L2.CLTCODE 
	
				UNION ALL
	
				SELECT 
					L2.CLTCODE,
					SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
					@@SPID AS SPID, 
					CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
				FROM 
					LEDGER L, LEDGER2 L2
				WHERE 
					L.VNO = L2.VNO
					AND L.VTYP = L2.VTYPE
					AND L.BOOKTYPE = L2.BOOKTYPE
					AND L.LNO = L2.LNO
					AND L.CLTCODE = L2.CLTCODE
					AND L2.CLTCODE = @FCODE 
					AND L2.COSTCODE = @@COSTCODE
					AND L.VDT >= @@STARTDATE 
					AND L.VDT <  @FDATE 
					AND L2.VTYPE <> 18                    
				GROUP BY 
					L2.CLTCODE) A
			GROUP BY 
				CLTCODE, 
				SPID, 
				CURDATE
	
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
	
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A, LEDGER2 L2                  
					WHERE 
						L.VNO = L1.VNO                  
						AND L.VTYP = L1.VTYP                  
						AND L.BOOKTYPE = L1.BOOKTYPE                  
						AND L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE 
						AND L.BOOKTYPE = L2.BOOKTYPE
						AND L.LNO = L2.LNO
	--					AND L.DRCR = L2.DRCR
						AND L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L2.CLTCODE <> @FCODE                  
						AND L2.COSTCODE = @@COSTCODE
						AND L.VTYP <> 18  
		END
END
ELSE
BEGIN
	IF @STATUSID = 'BROKER'
		BEGIN                    
			IF @BRANCH = '' OR @BRANCH = '%'
				BEGIN
					PRINT 'CAME HERE - I'
					INSERT INTO TBL_OPPBALANCE                          
					SELECT 
						CLTCODE, 
						SUM(OPBAL) AS OPBAL,
						SPID , 
						CURDATE 
					FROM                    
						(SELECT 
							CLTCODE,
							SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                         
						FROM 
							LEDGER                        
						WHERE 
							CLTCODE = @FCODE 
							AND VTYP = 18 
							AND EDT LIKE @@STARTDATE + '%'
						GROUP BY 
							CLTCODE
						UNION ALL                    
						SELECT 
							CLTCODE,
							SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER                          
						WHERE 
							CLTCODE = @FCODE 
							AND EDT >= @@STARTDATE 
							AND EDT <  @FDATE                    
							AND VTYP <> 18                    
						GROUP BY 
							CLTCODE
						UNION ALL                    
						SELECT 
							CLTCODE,
							SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER                          
						WHERE 
							CLTCODE = @FCODE 
							AND VDT < @@STARTDATE 
							AND EDT >= @@STARTDATE 
							AND VTYP <> 18                    
						GROUP BY 
							CLTCODE) A
					GROUP BY 
						CLTCODE, 
						SPID, 
						CURDATE
	
	                    
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A                  
					WHERE 
						L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L.CLTCODE <> @FCODE                  
						AND L.VTYP <> 18                  
				END
			ELSE
				BEGIN
					PRINT 'CAME HERE - II'
					INSERT INTO TBL_OPPBALANCE                          
					SELECT 
						CLTCODE, 
						SUM(OPBAL) AS OPBAL,
						SPID , 
						CURDATE 
					FROM                    
						(SELECT 
							L2.CLTCODE,
							SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE
						FROM 
							LEDGER L, LEDGER2 L2
						WHERE 
							L.VNO = L2.VNO
							AND L.VTYP = L2.VTYPE
							AND L.BOOKTYPE = L2.BOOKTYPE
							AND L.LNO = L2.LNO
							AND L.CLTCODE = L2.CLTCODE
							AND L2.CLTCODE = @FCODE 
							AND L2.COSTCODE = @@COSTCODE
							AND L.VTYP = 18 
							AND L.EDT LIKE @@STARTDATE + '%'
						GROUP BY 
							L2.CLTCODE 
			
						UNION ALL
			
						SELECT 
							L2.CLTCODE,
							SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER L, LEDGER2 L2
						WHERE 
							L.VNO = L2.VNO
							AND L.VTYP = L2.VTYPE
							AND L.BOOKTYPE = L2.BOOKTYPE
							AND L.LNO = L2.LNO
							AND L.CLTCODE = L2.CLTCODE
							AND L2.CLTCODE = @FCODE 
							AND L2.COSTCODE = @@COSTCODE
							AND L.EDT >= @@STARTDATE 
							AND L.EDT <  @FDATE 
							AND L2.VTYPE <> 18                    
						GROUP BY 
							L2.CLTCODE

						UNION ALL
			
						SELECT 
							L2.CLTCODE,
							SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
							@@SPID AS SPID, 
							CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
						FROM 
							LEDGER L, LEDGER2 L2
						WHERE 
							L.VNO = L2.VNO
							AND L.VTYP = L2.VTYPE
							AND L.BOOKTYPE = L2.BOOKTYPE
							AND L.LNO = L2.LNO
							AND L.CLTCODE = L2.CLTCODE
							AND L2.CLTCODE = @FCODE 
							AND L2.COSTCODE = @@COSTCODE
							AND L.EDT >= @@STARTDATE 
							AND L.VDT <  @@STARTDATE 
							AND L2.VTYPE <> 18                    
						GROUP BY 
							L2.CLTCODE) A
					GROUP BY 
						CLTCODE, 
						SPID, 
						CURDATE
	
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A, LEDGER2 L2                  
					WHERE 
						L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE 
						AND L.BOOKTYPE = L2.BOOKTYPE
						AND L.LNO = L2.LNO
						AND L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L.CLTCODE <> @FCODE                  
						AND L2.COSTCODE = @@COSTCODE
						AND L.VTYP <> 18  
	
				END
		END
	ELSE
		BEGIN
			INSERT INTO TBL_OPPBALANCE                          
			SELECT 
				CLTCODE, 
				SUM(OPBAL) AS OPBAL,
				SPID , 
				CURDATE 
			FROM                    
				(SELECT 
					L2.CLTCODE,
					SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
					@@SPID AS SPID, 
					CONVERT(VARCHAR,GETDATE(),112) AS CURDATE
				FROM 
					LEDGER L, LEDGER2 L2
				WHERE 
					L.VNO = L2.VNO
					AND L.VTYP = L2.VTYPE
					AND L.BOOKTYPE = L2.BOOKTYPE
					AND L.LNO = L2.LNO
					AND L.CLTCODE = L2.CLTCODE
					AND L2.CLTCODE = @FCODE 
					AND L2.COSTCODE = @@COSTCODE
					AND L.VTYP = 18 
					AND L.EDT LIKE @@STARTDATE + '%'
				GROUP BY 
					L2.CLTCODE 
	
				UNION ALL
	
				SELECT 
					L2.CLTCODE,
					SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
					@@SPID AS SPID, 
					CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
				FROM 
					LEDGER L, LEDGER2 L2
				WHERE 
					L.VNO = L2.VNO
					AND L.VTYP = L2.VTYPE
					AND L.BOOKTYPE = L2.BOOKTYPE
					AND L.LNO = L2.LNO
					AND L.CLTCODE = L2.CLTCODE
					AND L2.CLTCODE = @FCODE 
					AND L2.COSTCODE = @@COSTCODE
					AND L.EDT >= @@STARTDATE 
					AND L.EDT <  @FDATE                    
					AND L2.VTYPE <> 18                    
				GROUP BY 
					L2.CLTCODE
	
				UNION ALL
	
				SELECT 
					L2.CLTCODE,
					SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,
					@@SPID AS SPID, 
					CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                    
				FROM 
					LEDGER L, LEDGER2 L2
				WHERE 
					L.VNO = L2.VNO
					AND L.VTYP = L2.VTYPE
					AND L.BOOKTYPE = L2.BOOKTYPE
					AND L.LNO = L2.LNO
					AND L.CLTCODE = L2.CLTCODE
					AND L2.CLTCODE = @FCODE 
					AND L2.COSTCODE = @@COSTCODE
					AND L.EDT >= @@STARTDATE 
					AND L.VDT <  @@STARTDATE         
					AND L2.VTYPE <> 18                    
				GROUP BY 
					L2.CLTCODE) A
			GROUP BY 
				CLTCODE, 
				SPID, 
				CURDATE
	
					INSERT INTO #TBL_GLREPORT                  
					SELECT 
						L.BOOKTYPE,                     
						VOUDT=CONVERT(VARCHAR,L.VDT,103), 
						EFFDT=CONVERT(VARCHAR,L.EDT,103), 
	
						ISNULL(SHORTDESC,'') SHORTDESC,                                                             
						DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                              
						CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                            
						L.VNO, 
						REPLACE( L.NARRATION,'"','') NARRATION,                                               
						DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                   
						L.CLTCODE ,
						A.LONGNAME,
						VDT, 
						L.VTYP,                                                              
						ACCAT, 
						OPBAL=0,
						CROSAC='',
						A.ACNAME,
						A.BRANCHCODE,
						@@SPID, 
						CONVERT(VARCHAR,GETDATE(),112), '', 
						L.VDT                  
					FROM 
						LEDGER L   
						LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                    
						ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                  
						(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                  
						VMAST V, ACMAST A, LEDGER2 L2                  
					WHERE 
						L.VNO = L2.VNO
						AND L.VTYP = L2.VTYPE 
						AND L.BOOKTYPE = L2.BOOKTYPE
						AND L.LNO = L2.LNO
						AND L.VNO = LL.VNO                  
						AND L.VTYP = LL.VTYP                  
						AND L.BOOKTYPE = LL.BOOKTYPE                  
						AND L.CLTCODE = A.CLTCODE                  
						AND L.VTYP = V.VTYPE                  
						AND L2.CLTCODE <> @FCODE                  
						AND L2.COSTCODE = @@COSTCODE
						AND L.VTYP <> 18  
		END
END

UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                  
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                  
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                  
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                  
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                  
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                  
              
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                  
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                      
          
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0          
                  
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                  
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                  
SELECT 
      BOOKTYPE,
      VOUDT VDT ,
      EFFDT EDT ,
      SHORTDESC,
      DRAMT DEBIT,
      CRAMT CREDIT,
      VNO,
      NARRATION,
      DDNO,
      CLTCODE,

      LONGNAME,
      VTYP,
      ACCAT,
      OPBAL,
      CROSAC,
      ACNAME,
      BRANCHCODE                  
FROM 
      #TBL_GLREPORT  
WHERE 
      PROCID = @@SPID                  
ORDER BY 
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW
-- --------------------------------------------------
/*  
Exec RPT_ACC_CASHBOOK_NEW 'May  1 2007', 'May  2 2007','Apr  1 2007', '02113', 'broker', 'broker', '%'  
Exec RPT_ACC_CASHBOOK_NEW 'May  1 2007', 'May  2 2007','Apr  1 2007', '02113', 'broker', 'broker', 'XS'  
*/  
  
  
/*select * from ledger where cltcode = 'CASH01' and vtyp = 18 and vdt like 'Apr  1 2007%'  
  
SELECT         
      CLTCODE,        
      SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL,        
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
     FROM         
      LEDGER                                
     WHERE         
      CLTCODE = 'CASH01'         
        
      AND VDT >= 'Apr  1 2007' and vdt < 'Jul 21 2007'  
     GROUP BY         
      CLTCODE        
  
  
select * from ledger where vno = '200707200001' and cltcode = 'CASH01'  
  
Exec rpt_Acc_CashBook_New 'Jul 20 2007', 'Jul 30 2007', '01/04/2007', 'CASH01', 'broker', 'broker', '%'*/  
  
CREATE PROC RPT_ACC_CASHBOOK_NEW        
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                          
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @FCODE VARCHAR(10),                            
      @STATUSID VARCHAR(30),                            
      @STATUSNAME VARCHAR(30),                            
      @BRANCH VARCHAR(10)                            
                            
AS                            
                            
DECLARE                            
 @@OPENDATE AS VARCHAR(11),                            
 @@REPDATE AS VARCHAR(8),                            
 @@STARTDATE AS VARCHAR(11),         
 @@COSTCODE AS SMALLINT        
        
        
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                          
CREATE TABLE [DBO].[#TBL_GLREPORT] (                          
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                          
 [BOOKTYPE] [CHAR] (2) NULL ,                          
 [VOUDT] [VARCHAR] (10) NULL ,                          
 [EFFDT] [VARCHAR] (10) NULL ,                          
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                          
 [DRAMT] [MONEY] NULL ,                          
 [CRAMT] [MONEY] NULL ,                          
 [VNO] [VARCHAR] (12) NULL ,                          
 [NARRATION] [VARCHAR] (500) NULL ,                          
 [DDNO] [VARCHAR] (15) NULL ,                          
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                          
 [LONGNAME] [VARCHAR] (100) NULL ,                          
 [VDT] [DATETIME] NULL ,                          
 [VTYP] [SMALLINT] NOT NULL ,                          
 [ACCAT] [CHAR] (2) NULL ,                          
 [OPBAL] [MONEY] NOT NULL ,                          
 [CROSAC] [VARCHAR] (10) NOT NULL ,                          
 [ACNAME] [VARCHAR] (100) NULL ,                          
 [BRANCHCODE] [VARCHAR] (10) NULL ,                          
 [PROCID] [BIGINT] NULL ,                          
 [REPDATE] [VARCHAR] (8) NULL ,                          
 [MAINCODE] [VARCHAR] (10) NULL ,                          
 [VCHDT] [DATETIME] NULL                          
)                          
                          
                            
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                          
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID        
        
SELECT @@COSTCODE = -1        
        
IF @STATUSID <> 'BROKER'        
 BEGIN        
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME         
 END        
ELSE IF @STATUSID = 'BROKER'        
 BEGIN        
  IF @BRANCH <> '' OR @BRANCH <> '%'        
   BEGIN        
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH         
   END        
 END        
      
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                            
        
IF @STATUSID = 'BROKER'        
 BEGIN                            
  IF @BRANCH = '' OR @BRANCH = '%'        
   BEGIN        
    PRINT 'CAME HERE - I'        
    INSERT INTO TBL_OPPBALANCE                                  
    SELECT         
     CLTCODE,         
     SUM(OPBAL) AS OPBAL,        
     SPID ,         
     CURDATE         
    FROM                         
     (SELECT         
      CLTCODE,        
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
     FROM         
      LEDGER                                
     WHERE         
      CLTCODE = @FCODE         
      AND VTYP = 18         
      AND VDT LIKE @@STARTDATE + '%'        
     GROUP BY         
      CLTCODE        
     UNION ALL                            
     SELECT         
      CLTCODE,        
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
  @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
     FROM         
      LEDGER                                  
     WHERE         
      CLTCODE = @FCODE         
      AND VDT >= @@STARTDATE         
      AND VDT <  @FDATE                            
      AND VTYP <> 18                            
     GROUP BY         
      CLTCODE) A        
    GROUP BY         
     CLTCODE,         
     SPID,         
     CURDATE        
        
                            
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),         
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A                          
    WHERE         
     L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L.VTYP <> 18                          
   END        
  ELSE        
   BEGIN        
    PRINT 'CAME HERE - II'        
    INSERT INTO TBL_OPPBALANCE                                  
    SELECT         
     CLTCODE,         
     SUM(OPBAL) AS OPBAL,        
     SPID ,         
     CURDATE         
    FROM                            
     (SELECT         
      L2.CLTCODE,        
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
     FROM         
      LEDGER L, LEDGER2 L2        
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE        
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.DRCR = L2.DRCR        
      AND L.CLTCODE = L2.CLTCODE        
      AND L2.CLTCODE = @FCODE         
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP = 18         
      AND L.VDT LIKE @@STARTDATE + '%'        
     GROUP BY         
      L2.CLTCODE         
          
     UNION ALL        
    
     SELECT         
      L2.CLTCODE,        
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
      @@SPID AS SPID,         
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
     FROM         
      LEDGER L, LEDGER2 L2        
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE        
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.DRCR = L2.DRCR        
      AND L.CLTCODE = L2.CLTCODE        
      AND L2.CLTCODE = @FCODE         
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VDT >= @@STARTDATE         
      AND L.VDT <  @FDATE         
      AND L2.VTYPE <> 18                            
 GROUP BY         
      L2.CLTCODE) A        
    GROUP BY         
     CLTCODE,         
     SPID,         
     CURDATE        
    
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),         
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A, LEDGER2 L2                          
    WHERE         
      L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE         
     AND L.BOOKTYPE = L2.BOOKTYPE        
--     AND L.LNO = L2.LNO        
--     AND L.DRCR = L2.DRCR        
     AND L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L2.CLTCODE <> @FCODE                          
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP <> 18        
        
   END        
 END        
ELSE        
 BEGIN        
  INSERT INTO TBL_OPPBALANCE                                  
  SELECT         
   CLTCODE,         
   SUM(OPBAL) AS OPBAL,        
   SPID ,         
   CURDATE         
  FROM                            
   (SELECT         
 L2.CLTCODE,        
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
    @@SPID AS SPID,         
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
   FROM         
    LEDGER L, LEDGER2 L2        
   WHERE         
    L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
    AND L.BOOKTYPE = L2.BOOKTYPE        
    AND L.DRCR = L2.DRCR        
    AND L.CLTCODE = L2.CLTCODE        
    AND L2.CLTCODE = @FCODE         
    AND L2.COSTCODE = @@COSTCODE        
    AND L.VTYP = 18         
    AND L.VDT LIKE @@STARTDATE + '%'        
   GROUP BY         
    L2.CLTCODE         
        
   UNION ALL        
        
   SELECT         
    L2.CLTCODE,        
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
    @@SPID AS SPID,         
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
   FROM         
    LEDGER L, LEDGER2 L2        
   WHERE         
    L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
    AND L.BOOKTYPE = L2.BOOKTYPE        
    AND L.DRCR = L2.DRCR        
    AND L.CLTCODE = L2.CLTCODE        
    AND L2.CLTCODE = @FCODE         
    AND L2.COSTCODE = @@COSTCODE        
    AND L.VDT >= @@STARTDATE         
    AND L.VDT <  @FDATE                            
    AND L2.VTYPE <> 18                            
   GROUP BY         
    L2.CLTCODE) A        
  GROUP BY         
   CLTCODE,         
   SPID,         
   CURDATE        
        
    INSERT INTO #TBL_GLREPORT                          
    SELECT         
     L.BOOKTYPE,                             
     VOUDT=CONVERT(VARCHAR,L.VDT,103),         
     EFFDT=CONVERT(VARCHAR,L.EDT,103),        ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
     L.VNO,         
     REPLACE( L.NARRATION,'"','') NARRATION,                                                       
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
     L.CLTCODE ,        
     A.LONGNAME,        
     VDT,         
     L.VTYP,                                                                      
     ACCAT,         
     OPBAL=0,        
     CROSAC='',        
     A.ACNAME,        
     A.BRANCHCODE,        
     @@SPID,         
     CONVERT(VARCHAR,GETDATE(),112), '',         
     L.VDT                          
    FROM         
     LEDGER L           
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
     VMAST V, ACMAST A, LEDGER2 L2                          
    WHERE         
     L.VNO = L1.VNO                          
     AND L.VTYP = L1.VTYP                          
     AND L.BOOKTYPE = L1.BOOKTYPE                          
     AND L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE         
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.DRCR = L2.DRCR        
     AND L.VNO = LL.VNO                          
     AND L.VTYP = LL.VTYP                          
     AND L.BOOKTYPE = LL.BOOKTYPE                          
     AND L.CLTCODE = A.CLTCODE                          
     AND L.VTYP = V.VTYPE                          
     AND L.CLTCODE <> @FCODE                          
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP <> 18          
 END        
        
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                          
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                          
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                          
                      
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                          
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                              
                  
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                  
                          
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                          
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                          
SELECT         
      BOOKTYPE,        
      VOUDT VDT ,        
      EFFDT EDT ,        
      SHORTDESC,        
      DRAMT DEBIT,        
      CRAMT CREDIT,        
      VNO,        
      NARRATION,        
      DDNO,        
      CLTCODE,         
      LONGNAME,        
      VTYP,        
      ACCAT,        
      OPBAL,        
    CROSAC,        
      ACNAME,        
      BRANCHCODE                          
FROM         
      #TBL_GLREPORT          
WHERE         
      PROCID = @@SPID                          
ORDER BY         
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW_26072009
-- --------------------------------------------------
    CREATE   PROC RPT_ACC_CASHBOOK_NEW_26072009    
--EXEC RPT_ACC_CASHBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'    
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @SDATE VARCHAR(10),            /* AS MMM DD YYYY */    
 @FCODE VARCHAR(10),    
 @STATUSID VARCHAR(30),    
 @STATUSNAME VARCHAR(30),    
 @BRANCH VARCHAR(10)    
    
AS    
    
DECLARE    
 @@OPENDATE AS VARCHAR(11),    
 @@REPDATE AS VARCHAR(8),    
 @@STARTDATE AS VARCHAR(11)    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
SELECT * INTO #TBL_GLREPORT FROM TBL_GL       
   
/*CREATE TABLE [DBO].[#TBL_GLREPORT]    
 (    
  [SRNO] [INT] IDENTITY (1, 1) NOT NULL,    
  [BOOKTYPE] [CHAR] (2) NULL,    
  [VOUDT] [VARCHAR] (10) NULL,    
  [EFFDT] [VARCHAR] (10) NULL,    
  [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' '),    
  [DRAMT] [MONEY] NULL,    
  [CRAMT] [MONEY] NULL,    
  [VNO] [VARCHAR] (12) NULL,    
  [NARRATION] [VARCHAR] (234) NULL,    
  [DDNO] [VARCHAR] (15) NULL,    
  [CLTCODE] [VARCHAR] (10) NOT NULL,    
  [LONGNAME] [VARCHAR] (100) NULL,    
  [VDT] [DATETIME] NULL,    
  [VTYP] [SMALLINT] NOT NULL,    
  [ACCAT] [CHAR] (2) NULL,    
  [OPBAL] [MONEY] NOT NULL,    
  [CROSAC] [VARCHAR] (10) NOT NULL,    
  [ACNAME] [VARCHAR] (100) NULL,    
  [BRANCHCODE] [VARCHAR] (10) NULL,    
  [PROCID] [BIGINT] NULL,    
  [REPDATE] [VARCHAR] (8) NULL,    
  [MAINCODE] [VARCHAR] (10) NULL,    
  [VCHDT] [DATETIME] NULL    
)   
  */  
  
          
DELETE     
 TBL_OPPBALANCE     
WHERE PROCID = @@SPID    
            
SELECT     
 @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, '01/04/2005',103), 109), 11)    
            
INSERT     
INTO TBL_OPPBALANCE     
SELECT     
 CLTCODE,    
 SUM(    
 CASE DRCR     
  WHEN 'C'     
  THEN VAMT     
  ELSE -VAMT     
 END    
 ) AS OPBAL,    
 @@SPID,     
 CONVERT(VARCHAR,GETDATE(),112)     
FROM LEDGER     
WHERE CLTCODE = @FCODE     
 AND VDT >= @@STARTDATE     
 AND VDT < @FDATE     
GROUP BY CLTCODE     
            
            
INSERT     
INTO #TBL_GLREPORT     
SELECT     
 L.BOOKTYPE,     
 VOUDT=CONVERT(VARCHAR,L.VDT,103),     
 EFFDT=CONVERT(VARCHAR,L.EDT,103),     
 ISNULL(SHORTDESC,'') SHORTDESC,     
 DRAMT=(    
 CASE     
  WHEN UPPER(L.DRCR) = 'C'     
  THEN VAMT     
  ELSE 0     
 END    
 ),     
 CRAMT=(    
 CASE     
  WHEN UPPER(L.DRCR) = 'D'     
  THEN VAMT     
  ELSE 0     
 END    
 ),     
 L.VNO,     
 REPLACE( L.NARRATION,'"','') NARRATION,     
 DDNO = (    
 CASE     
  WHEN ISNULL(L1.DDNO,'')='0'     
  THEN ''     
  ELSE ISNULL(L1.DDNO,'')     
 END    
 ),     
 L.CLTCODE ,     
 A.LONGNAME,    
 VDT,     
 L.VTYP,     
 ACCAT,     
 OPBAL=0,    
 CROSAC='',    
 A.ACNAME,    
 A.BRANCHCODE,    
 @@SPID,     
 CONVERT(VARCHAR,GETDATE(),112),     
 '',     
 VDT     
FROM LEDGER L     
LEFT JOIN     
 (    
 SELECT     
  VTYP,     
  BOOKTYPE,     
  VNO,     
  DDNO= MAX(DDNO)     
 FROM LEDGER1     
 GROUP BY VTYP,     
  BOOKTYPE,     
  VNO    
 )     
 L1     
 ON     
 (    
  L1.VTYP=L.VTYP     
  AND L1.BOOKTYPE = L.BOOKTYPE     
  AND L1.VNO = L.VNO    
 )    
 ,     
 (    
 SELECT     
  VNO,     
  VTYP,     
  BOOKTYPE     
 FROM LEDGER     
 WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'     
  AND CLTCODE = @FCODE    
 )     
 LL,     
 VMAST V,     
 ACMAST A     
WHERE L.VNO = LL.VNO     
 AND L.VTYP = LL.VTYP     
 AND L.BOOKTYPE = LL.BOOKTYPE     
 AND L.CLTCODE = A.CLTCODE     
 AND L.VTYP = V.VTYPE     
 AND L.CLTCODE <> @FCODE     
 AND L.VTYP <> 18     
    
UPDATE     
 #TBL_GLREPORT     
 SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION)     
WHERE PROCID = @@SPID     
    
UPDATE     
 #TBL_GLREPORT     
 SET OPBAL = TBL_OPPBALANCE.OPPBAL,    
 CROSAC=''     
FROM TBL_OPPBALANCE     
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE     
 AND TBL_OPPBALANCE.PROCID = @@SPID     
 AND TBL_OPPBALANCE.PROCID =#TBL_GLREPORT.PROCID     
    
UPDATE     
 #TBL_GLREPORT     
 SET CROSAC = CLTCODE     
WHERE PROCID = @@SPID     
    
UPDATE     
 #TBL_GLREPORT     
 SET CLTCODE = @FCODE     
WHERE PROCID = @@SPID     
    
UPDATE     
 #TBL_GLREPORT     
 SET ACNAME = A.ACNAME     
FROM ACMAST A     
WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE     
 AND #TBL_GLREPORT.PROCID = @@SPID     
    
SELECT     
 BOOKTYPE,    
 VOUDT VDT ,    
 EFFDT EDT ,    
 SHORTDESC,    
 DRAMT DEBIT,    
 CRAMT CREDIT,    
 VNO,    
 NARRATION,    
 DDNO,    
 CLTCODE,    
 LONGNAME,    
 VTYP,    
 ACCAT,    
 OPBAL,    
 CROSAC,    
 ACNAME,    
 BRANCHCODE     
FROM #TBL_GLREPORT     
WHERE PROCID = @@SPID     
ORDER BY CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)),     
 CONVERT(NUMERIC, VTYP),     
 VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport
-- --------------------------------------------------
--Exec rpt_Acc_GlReport '01/04/2006', '31/03/2007', 'Apr  1 2006', 'Mar 31 2007', '26000012', '26000014', 'broker', 'broker', '%','vdt', 'Account', 'VDT', 'GL','' 

        --Exec acc_reports 'Apr  1 2004', 'Mar 31 2005', 'Apr  1 2004', 'Mar 31 2005', 'HOCA01', 'HOCA01', 'branch', '146', '146','vdt', 'Account', 'VoucherType, VoucherDate', 'GL', '', '', '', ''    
    
    
--Exec rpt_Acc_GlReport'Apr 1 2004', 'Mar 31 2005', 'Mar  1 2005', 'Mar 29 2005', 'HOCA01', 'HOCA01', 'broker', 'broker', '%','vdt', 'Account', 'VDT', 'GL',''         
      
      
      
       
CREATE Proc rpt_Acc_GlReport         
@sdate varchar(11),            /* As mmm dd yyyy */        
@edate varchar(11),            /* As mmm dd yyyy */        
@fdate varchar(11),            /* As mmm dd yyyy */        
@tdate varchar(11),            /* As mmm dd yyyy */        
@fcode varchar(10),        
@tcode varchar(10),        
@statusId varchar(30),        
@statusname varchar(30),        
@branch varchar(10),        
@selectionby varchar(3),        
@GroupBy varchar(10),        
@Sortby varchar(50),        
@reportname varchar(30),        
@reportopt varchar(10)        
        
AS        
        
declare         
@@opendate as varchar(11)        
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18' and vdt <= @fdate
if len(@sdate) = 10  
 set @sdate = convert(varchar(11), convert(datetime, @sdate, 103), 109)  
  
if len(@edate) = 10  
 set @edate = convert(varchar(11), convert(datetime, @edate, 103), 109)  
    
        
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2        
        
 Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,        
  dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,         
  Replace( l.narration,'"','') narration,        
  ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and        
  booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,        
  accat,Vamt as opbal,crosac=l.cltcode,        
  isnull(a.acname,'') acname,isnull(a.branchcode,'') branchcode    
 into #temptable_gl        
From Ledger l , Acmast a ,Vmast v  where 1 = 2    
        
      
if @selectionby = 'vdt'        
 BEGIN        
  if rtrim(@branch) = '' or rtrim(@branch) = '%'         
   BEGIN            
    if @@opendate = @fdate  
     begin  
      Insert into #opbal    
      Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger         
      where cltcode between @fcode and @tcode and vdt like @@opendate + '%' and vtyp = 18  
      Group by cltcode         
      Order by cltcode         
      Insert into #temptable_gl        
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,        
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,        
      ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and        
      booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,        
      accat,opbal=0,crosac='',   a.acname,a.branchcode        
      from Ledger l,  Acmast a ,Vmast v      
        
      Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and    
      l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and         
      (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')        
      and l.vtyp <> 18  
      Order by l.cltcode, voudt, l.vtyp desc, l.vno            
     end  
    else  
     begin  
      Insert into #opbal    
      Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger         
      where cltcode between @fcode and @tcode and vdt >= @@opendate and vdt < @fdate       
      Group by cltcode         
      Order by cltcode         
      Insert into #temptable_gl        
      Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,        
      dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
      cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,        
      ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and        
      booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,        
      accat,opbal=0,crosac='',   a.acname,a.branchcode        
      from Ledger l,  Acmast a ,Vmast v      
        
      Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and    
      l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and         
      (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')        
        
      Order by l.cltcode, voudt, l.vtyp desc, l.vno            
     end  
  
   END        
  ELSE        
   BEGIN        
    if @@opendate = @fdate  
     begin  
      insert into #opbal    
      Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l        
      where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno        
      and vdt like @@opendate + '%' and l2.vtype = 18  
      Group by l2.cltcode        
      Order by l2.cltcode    
        
      insert into #temptable_gl        
      Select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc,         
      dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),          
      cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),         
      l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp         
      and vno = l.vno and booktype = l.booktype         
      and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,        
      accat,  opbal=0,crosac='',a.acname,a.branchcode         
      from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c           
        
      Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and    
      l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and     
      l2.cltcode between @fcode and  @tcode  and a.accat <> '4'         
      and costname = rtrim(@branch)         
      and l2.costcode = c.costcode  and  l2.vtype <> 18    
      order by l2.cltcode, voudt, l.vtyp desc, l.vno        
     end  
    else  
     begin  
      insert into #opbal    
      Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l        
      where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno        
      and vdt >= @@opendate and vdt < @fdate        
      Group by l2.cltcode        
      Order by l2.cltcode    
        
      insert into #temptable_gl        
      Select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc,         
      dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),          
      cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),         
      l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp         
      and vno = l.vno and booktype = l.booktype         
      and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,        
      accat,  opbal=0,crosac='',a.acname,a.branchcode         
      from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c           
        
      Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and    
      l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and     
      l2.cltcode between @fcode and  @tcode  and a.accat <> '4'         
      and costname = rtrim(@branch)         
      and l2.costcode = c.costcode  and  l2.vtype <> 18    
      order by l2.cltcode, voudt, l.vtyp desc, l.vno        
     end  
   END        
 END        
ELSE        
 BEGIN        
  if rtrim(@branch) = '' or rtrim(@branch) = '%'         
   BEGIN            
    insert into #opbal     
    Select cltcode, sum(opbal) opbal  from        
    (    
    Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger         
    where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate        
    Group by Cltcode        
      
    union        
      
    Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger         
    Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate        
    Group by cltcode) t      
    Group by cltcode        
    Order by cltcode                  
      
    insert into #temptable_gl        
    Select l.booktype, voudt=convert(varchar,l.vdt,103), effdt=convert(varchar,l.edt,103), isnull(shortdesc,'') shortdesc,        
    dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),          
    cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,         
    Replace( l.narration,'"','') narration,        
    ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and        
    booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,        
    accat,opbal=0,crosac='',  a.acname,a.branchcode        
    from Ledger l , acmast a ,vmast v      
    Where vtyp = vtype  and a.cltcode = l.cltcode and l.cltcode between @fcode and @tcode     
    and  l.edt between @fdate and @tdate + ' 23:59:59' and    l.vtyp <> 18 and     
    (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')        
    order by l.cltcode, voudt, l.vtyp desc, l.vno        
   END        
  ELSE        
   BEGIN            
    insert into #opbal     
    Select cltcode, sum(opbal) opbal  from        
    (    
    Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l        
    where vdt  between @@opendate and @fdate  and   l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype    
    and l.lno=l2.lno   and  l2.cltcode between @fcode   and @tcode    
    Group by l2.cltcode        
      
    union        
      
    Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal from ledger2 l2, ledger l        
    where  l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.lno=l2.lno        
    and  vdt < @@opendate and edt >= @@opendate and   l2.cltcode between @fcode and @tcode     
    Group by l2.cltcode) t        
    Group by cltcode    
    Order by cltcode    
      
    insert into #temptable_gl        
    Select l.booktype, voudt=l.vdt, effdt=l.edt, isnull(shortdesc,'') shortdesc,         
    dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),          
    cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),         
    l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype         
    and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,          
    accat,   opbal=0,crosac='',a.acname,a.branchcode         
    from ledger l ,vmast v, ledger2 l2 ,acmast a, costmast c      
    Where  l.vno = l2.vno and l.vtyp = l2.vtype and    
    l.booktype = l2.booktype  and l.lno = l2.lno and a.cltcode = l2.cltcode     
    and l2.cltcode between @fcode and  @tcode And l.vtyp = v.vtype and a.accat <> '4' and l2.cltcode=a.cltcode         
    and costname = rtrim(@branch)  and l2.vtype <> 18    
    and l2.costcode = c.costcode           
    and  l.edt between @fdate and @tdate + ' 23:59:59'      
    order by l2.cltcode, voudt, l.vtyp desc, l.vno        
   END        
 END        
    
Update #temptable_gl set opbal = l.opbal  from #opbal l  where #temptable_gl.cltcode = l.cltcode        
        
Update #temptable_gl set crosac = l.cltcode  from ledger l         
where l.vtyp not in('15','21') and #temptable_gl.vtyp = l.vtyp and #temptable_gl.booktype = l.booktype and #temptable_gl.vno = l.vno        
and #temptable_gl.cltcode <> l.cltcode           
      
Select *  from #temptable_gl    Order By CltCode, CONVERT(DATETIME, VOUDT, 103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient
-- --------------------------------------------------




create  Procedure Rpt_acc_listclient
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)  -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
Set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections 
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode Like '" + @Statusname + "' Or Branchcode = 'All') And (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')" 
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End

 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Trader = S.Short_name  And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Whattolookfor + "' "
-- To Get A Value Greater/lesser Than Another.
-- Useful While Taking From-to Type Selections
 If @Whichway = ">"
 Begin
  Set @Strsql = @Strsql + " And "
  Set @Strsql = @Strsql + " Cltcode > = '" + @Comparetowhat + "' "
 End
 Else
 Begin
  If @Whichway = "<"
  Begin
   Set @Strsql = @Strsql + " And "
   Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
  End
 End
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_listclient_report
-- --------------------------------------------------




Create Procedure Rpt_acc_listclient_report
 @Statusid Varchar(15), 
 @Statusname Varchar(25), 
 @Whattolookfor Varchar(25), -- Partial/complete/null String - Forms The Basis For The Search
 @Whichway Varchar(1),  -- > Or <, Depending On How The Above String Is To Be Compared To The Below One.
 @Comparetowhat Varchar(25), -- Partial/complete/null String To Indicate The Upper/lower Limit Of The Search.
 @Accat Varchar(3)   -- Account Category
As
Declare
@Strsql Varchar(2500), 
@@Inaccat Varchar(3)
Select @@Inaccat = Rtrim(Convert(Varchar, Convert(Int, @Accat)+100, 3))
--set Default Values
--set @Whattolookfor = @Whattolookfor + "%"
/* Set @Booktype = @Booktype + "%" */
--broker Login
If  @Statusid = "broker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 If @Accat = 3  
  Set @Strsql = @Strsql + " (Accat In (3, 14, 18) )"  
 Else
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"  
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--branch Login
If @Statusid = "branch"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Acname, "
 Set @Strsql = @Strsql + " Branchcode "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " (Branchcode = '" + @Statusname + "' Or Branchcode = 'All') And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' And "
 If @Accat = 3  
  Set @Strsql = @Strsql + " (Accat In (3, 14) )"  
 Else
  Set @Strsql = @Strsql + " (Accat Like '" + @Accat  + "%' Or Accat Like '" + @@Inaccat + "%')"  
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " Cltcode, "
 Set @Strsql = @Strsql + " Branchcode "
End
--sub-broker Login
If @Statusid = "subbroker"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Subbrokers S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Sub_broker = S.Sub_broker And "
 Set @Strsql = @Strsql + " C1.Sub_broker Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Sub_broker "
End
--trader Login
If @Statusid = "trader"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Trader "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Branches S "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Trader = S.Branch_cd And "
 Set @Strsql = @Strsql + " C1.Trader Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Trader "
End
--family Login
If @Statusid = "family"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname, "
 Set @Strsql = @Strsql + " C1.Family "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " C1.Family Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " C1.Family "
End
If @Statusid = "client"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Cltcode Like '" + @Statusname + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "region"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
If @Statusid = "area"
Begin
 Set @Strsql = "select "
 Set @Strsql = @Strsql + "distinct "
 Set @Strsql = @Strsql + " A.Cltcode, "
 Set @Strsql = @Strsql + " A.Acname "
 Set @Strsql = @Strsql + "from "
 Set @Strsql = @Strsql + " Acmast A, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client1 C1, "
 Set @Strsql = @Strsql + " BSEFO.Dbo.Client2 C2 "
 Set @Strsql = @Strsql + "where "
 Set @Strsql = @Strsql + " C1.Cl_code = C2.Cl_code And "
 Set @Strsql = @Strsql + " A.Cltcode = C2.Party_code And "
 Set @Strsql = @Strsql + " Region Like '" + @Statusname + "' And "
 Set @Strsql = @Strsql + " Cltcode > = '" + @Whattolookfor + "' And "
 Set @Strsql = @Strsql + " Cltcode < = '" + @Comparetowhat + "' "
 Set @Strsql = @Strsql + "order By "
 Set @Strsql = @Strsql + " A.Cltcode "
End
 Set @Strsql = @Strsql + " Option  (Fast 10)"
Print @Strsql
Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_ListClient_Report_AcType_New
-- --------------------------------------------------





CREATE ProcEDURE rpt_Acc_ListClient_Report_AcType_New  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.  
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.  
 @ACCAT VARCHAR(3),   -- Account Category  
 @AcType varchar(8)  
AS  
  
DECLARE  
@strSQL VarChar(2500),  
@@Inaccat varchar(3)  
  
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))  
--select distinct cltcode into #LedgerTemp from Ledger  
  
--SET DEFAULT VALUES  
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"  
/* SET @BOOKTYPE = @BOOKTYPE + "%" */  


Set @strSQL = "SELECT "  
Set @strSQL = @strSQL + "DISTINCT "  
Set @strSQL = @strSQL + " a.cltcode, "  
Set @strSQL = @strSQL + " acname, "  
Set @strSQL = @strSQL + " branchcode,c1.family,c1.sub_broker,c1.trader ,l_address1,l_address2,l_address3,l_city,l_zip,Phone=isnull(Res_Phone1,0), pan=isnull(pan_gir_no,'')"  
Set @strSQL = @strSQL + "FROM "  
Set @strSQL = @strSQL + " acmast a"
Set @strSQL = @strSQL + ",BSEFO.dbo.client1 c1"
Set @strSQL = @strSQL + " WHERE " 
Set @strSQL = @strSQL + " a.cltcode=c1.cl_code and "  
Set @strSQL = @strSQL + " a.cltcode in (select distinct cltcode from Ledger) and "  
if Upper(@AcType)='FAMILY'  
 begin    
  Set @strSQL = @strSQL + " family >= '" + @WHATTOLOOKFOR + "' AND "  
  Set @strSQL = @strSQL + " family <= '" + @COMPARETOWHAT + "' AND "  
end  
else  
begin  
  Set @strSQL = @strSQL + " a.cltcode >= '" + @WHATTOLOOKFOR + "' AND "  
  Set @strSQL = @strSQL + " a.cltcode <= '" + @COMPARETOWHAT + "' AND "  
end  
IF Upper(@STATUSID)='BRANCH'
begin
	Set @strSQL = @strSQL + " (branchcode = '" + @STATUSNAME + "' OR branchcode = 'ALL') AND "
end
else
IF Upper(@STATUSID)='SUBBROKER'
begin
	Set @strSQL = @strSQL + " c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
end
else
If Upper(@STATUSID)='TRADER'
begin
	Set @strSQL = @strSQL + " c1.trader LIKE '" + @STATUSNAME + "' AND "
end
else
If Upper(@STATUSID)='FAMILY'
begin
	Set @strSQL = @strSQL + " c1.family LIKE '" + @STATUSNAME + "' AND "
end
else
If Upper(@STATUSID)='CLIENT'
begin
	Set @strSQL = @strSQL + " cltcode LIKE '" + @STATUSNAME + "' "
end 
Set @strSQL = @strSQL + " (accat LIKE '" + @ACCAT  + "%' "  
if @ACCAT = '3'  
begin  
  Set @strSQL = @strSQL + " or accat like '14%' "  
end  
Set @strSQL = @strSQL + " or accat LIKE '" + @@Inaccat + "%')  "    
Set @strSQL = @strSQL + "ORDER BY "  
Set @strSQL = @strSQL + " a.cltcode, "  
If  Upper(@STATUSID)='BROKER'
begin
	Set @strSQL = @strSQL + " branchcode "  
end
else
IF Upper(@STATUSID)='BRANCH'
begin
	Set @strSQL = @strSQL + " branchcode "
end
else
IF Upper(@STATUSID)='SUBBROKER'
begin
	Set @strSQL = @strSQL + " c1.sub_broker "
end
else
If Upper(@STATUSID)='TRADER'
begin
	Set @strSQL = @strSQL + " c1.trader "
end
else
If Upper(@STATUSID)='FAMILY'
begin
	Set @strSQL = @strSQL + " c1.family "
end
Set @strSQL = @strSQL + " OPTION  (FAST 10)"  
  
Print @strSQL  
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger
-- --------------------------------------------------
CREATE Procedure Rpt_acc_partyledger      
(
	@Fdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Tdate Varchar(11),            /* As Mmm Dd Yyyy */      
	@Fcode Varchar(10),      
	@Tcode Varchar(10),      
	@Strorder Varchar(6),      
	@Selectby Varchar(3),      
	@Statusid Varchar(15),      
	@Statusname Varchar(15),      
	@Strbranch Varchar(10)      
)

As      
      
/*========================================================================
      Exec rpt_acc_partyledger_all 
            'Nov  1 2005',
            'Dec 31 2005',
            'a',
            'zzz',
            'ACCODE',
            'vdt',
            'broker',
            'undefined',
            ''
========================================================================*/

Declare 
	@@Opendate   As Varchar(11)      
      
Set Transaction Isolation Level Read Uncommitted      
      
      
/*getting Last Opening Date */      
      If Upper(@Selectby) = 'Vdt'      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Vdt < = @Fdate 
                  ) 
      End      
      Else      
      Begin      
            SELECT 
                  @@Opendate = 
                  ( 
                        SELECT 
                              Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) 
                        FROM Ledger WITH(NoLock) 
                        WHERE Vtyp = 18 
                              AND Edt < = @Fdate 
                  ) 
      End      
            
      
      /*creating Blank Table For Opening Balance*/      
            SELECT 
                  Cltcode, 
                  Oppbal = Vamt 
            INTO #oppbalance 
            FROM Ledger WITH(NoLock) 
            WHERE 1 = 2 
            
      
      /*getting Opening Balance*/      
      If @Selectby = 'Vdt'      
      Begin      
            If @@Opendate = @Fdate       
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt Like @Fdate + '%' 
                        AND Vtyp = 18 
                  GROUP BY Cltcode 
            End      
            Else      
            Begin      
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Oppbal = Isnull(Sum( 
                        CASE 
                              WHEN Upper(B.Drcr) = 'D' 
                              THEN B.Vamt 
                              ELSE -b.Vamt 
                        END
                        ), 0) 
                  FROM Ledger B WITH(NoLock) 
                  WHERE B.Cltcode > = @Fcode 
                        AND B.Cltcode < = @Tcode 
                        AND B.Vdt > = @@Opendate + ' 00:00:00' 
                        AND Vdt < @Fdate 
                  GROUP BY Cltcode 
            End      
      End       
      Else      
      Begin       
            If @@Opendate = @Fdate       
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
   Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
                                          ELSE -b.Vamt 
                                    END
                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
            Else    
            Begin    
                  INSERT 
                  INTO #oppbalance 
                  SELECT 
                        Cltcode, 
                        Opbal = Sum(Opbal) 
                  FROM 
                        ( 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ), 0) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt Like @@Opendate + '%' 
                                    AND Vtyp = 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Opbal = Sum( 
                                    CASE 
                                          WHEN Upper(Drcr) = 'D' 
                                          THEN Vamt 
                                          ELSE -vamt 
                                    END
                                    ) 
                              FROM Ledger WITH(NoLock) 
                              WHERE Cltcode = @Fcode 
                                    AND Edt > = @@Opendate + ' 00:00:00' 
                                    AND Edt < @Fdate 
                                    AND Vtyp <> 18 
                              GROUP BY Cltcode 
                              UNION ALL 
                              SELECT 
                                    Cltcode, 
                                    Oppbal = Isnull(Sum( 
                                    CASE 
                                          WHEN Upper(B.Drcr) = 'C' 
                                          THEN B.Vamt 
      ELSE -b.Vamt 
END

                                    ), 0) 
                              FROM Ledger B WITH(NoLock) 
                              WHERE B.Cltcode > = @Fcode 
                                    AND B.Cltcode < = @Tcode 
                                    AND B.Vdt < @@Opendate 
                                    AND Edt >= @@Opendate 
                              GROUP BY Cltcode 
                        ) 
                        T 
                  GROUP BY Cltcode 
            End    
      End      
            
      
      /*generating Blank Structure For Filtered Ledger */      
            SELECT 
                  L.*, 
                  Shortdesc = Space(35) 
            INTO #ledgerdata 
            FROM Ledger L WITH(NoLock) 
            WHERE 1 = 2 
            
      
      
      /*getting Fiiltered Ledger*/      
      If @Selectby = 'Vdt'      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Vdt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Vdt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End       
      Else      
      Begin      
            INSERT 
            INTO #ledgerdata 
            SELECT 
                  L.*, 
                  Isnull(V.Shortdesc, '') Shortdesc 
            FROM Ledger L WITH(NoLock), 
                  Vmast V WITH(NoLock) 
            WHERE Edt > = @Fdate + ' 00:00:00' 
                  AND L.Vtyp = V.Vtype 
                  AND Edt < = @Tdate +' 23:59:59' 
                  AND Cltcode > = @Fcode 
                  AND Cltcode < = @Tcode 
      End      
      


/*getting Client List*/      
      SELECT 
            C2.Party_code, 
            Bank_name = Isnull(C4.Bankid, ''), 
            L_address1, 
            L_address2, 
            L_address3, 
            L_city, 
            L_zip, 
            Res_phone1, 
            C1.Branch_cd, 
            Family, 
            C1.Sub_broker, 
            Trader, 
            Cl_type, 
            Cltdpid = Isnull(Cltdpid, '') 
      INTO #ledgerclients 
      FROM bsefo.Dbo.Client1 C1 WITH(NoLock), 
            bsefo.Dbo.Client2 C2 WITH(NoLock) 
      LEFT OUTER JOIN 
            bsefo.Dbo.Client4 C4 WITH(NoLock) 
            ON 
            (
                  C2.Party_code = C4.Party_code 
                  AND Depository Not In ('Nsdl', 'Cdsl') 
                  AND Defdp = 1
            ) 
      WHERE C1.Cl_code = C2.Cl_code 
            AND C1.Branch_cd Like (
            CASE 
                  WHEN @Statusid = 'Branch' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Sub_broker Like (
            CASE 
                  WHEN @Statusid = 'Sub_broker' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
	    AND Sub_broker Like (
            CASE 
                  WHEN @Statusid = 'Subbroker' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND Trader Like (
            CASE 
                  WHEN @Statusid = 'Trader' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Family Like (
            CASE 
                  WHEN @Statusid = 'Family' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C2.Party_code Like (
            CASE 
                  WHEN @Statusid = 'Client' 
                  THEN @Statusname 
                  ELSE '%' 
            END
            ) 
            AND C1.Branch_cd Like @Strbranch +'%' 
            AND C2.Party_code > = @Fcode 
            AND C2.Party_code < = @Tcode 


/*      CREATE TABLE [#tmpledger] (
      	[Booktype] [char] (2)  NULL ,
      	[Voudt] [datetime] NULL ,
      	[Effdt] [datetime] NULL ,
      	[Shortdesc] [varchar] (35)  NULL ,
      	[Dramt] [money] NULL ,
      	[Cramt] [money] NULL ,
      	[Vno] [varchar] (12)  NULL ,
      	[Ddno] [varchar] (15)  NULL ,
      	[Narration] [varchar] (234)  NULL ,
      	[Cltcode] [varchar] (10)  NOT NULL ,
      	[Vtyp] [smallint] NULL ,
      	[Vdt] [varchar] (30)  NULL ,
      	[Edt] [varchar] (30)  NULL ,
      	[Acname] [varchar] (100)  NULL ,
      	[Opbal] [money] NULL ,
      	[L_address1] [varchar] (40)  NOT NULL ,
      	[L_address2] [varchar] (40)  NULL ,
      	[L_address3] [varchar] (40)  NULL ,
      	[L_city] [varchar] (40)  NULL ,
      	[L_zip] [varchar] (10)  NULL ,
      	[Res_phone1] [varchar] (15)  NULL ,
      	[Branch_cd] [varchar] (10)  NOT NULL ,
      	[Crosac] [varchar] (10)  NULL ,
      	[Ediff] [int] NULL ,
      	[Family] [varchar] (10)  NOT NULL ,
      	[Sub_broker] [varchar] (10)  NOT NULL ,
      	[Trader] [varchar] (20)  NOT NULL ,
      	[Cl_type] [varchar] (3)  NOT NULL ,
      	[Bank_name] [varchar] (16)  NOT NULL ,
      	[Cltdpid] [varchar] (16)  NOT NULL ,
      	[Lno] [int] NULL 
      ) ON [PRIMARY]*/

select * into #tmpledger from tmpledger_test where 1 = 2

      
/*getting Lddger Entries*/      
      INSERT 
            INTO #tmpledger 
      SELECT 
            L.Booktype, 
            Voudt = L.Vdt, 
            Effdt = L.Edt, 
            L.Shortdesc, 
            Dramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'D' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            Cramt = (
            CASE 
                  WHEN Upper(L.Drcr) = 'C' 
                  THEN L.Vamt 
                  ELSE 0 
            END
            ), 
            L.Vno, 
            Ddno = Space(15), 
            L.Narration, 
            C.Party_code Cltcode, 
            L.Vtyp, 
            Convert(Varchar, L.Vdt, 103) Vdt, 
            Convert(Varchar, L.Edt, 103) Edt, 
            L.Acname , 
            Opbal = Vamt, 
            C.L_address1, 
            C.L_address2, 
            C.L_address3, 
            C.L_city, 
            C.L_zip, 
            C.Res_phone1, 
            C.Branch_cd, 
            L.Cltcode Crosac , 
            Ediff = Datediff(D, L.Edt, Getdate()), 
            C.Family, 
            C.Sub_broker, 
            C.Trader, 
            C.Cl_type, 
            C.Bank_name, 
            C.Cltdpid, 
            L.Lno 
      FROM #ledgerdata L WITH(NoLock) 
      RIGHT OUTER JOIN 
            #ledgerclients C WITH(NoLock) 
            ON 
            (
                  L.Cltcode = C.Party_code
            ) 


      
/*updating Opening Blanace*/      
      UPDATE 
            #tmpledger 
            SET Opbal = 0 

      UPDATE 
            #tmpledger 
            SET Opbal = T.Oppbal 
      FROM #tmpledger L WITH(NoLock), 
            #oppbalance T WITH(NoLock) 
      WHERE L.Cltcode = T.Cltcode 
      


/*updating Cheque Number*/      
      UPDATE 
            #tmpledger 
            SET Ddno = L1.Ddno 
      FROM Ledger1 L1 WITH(NoLock) 
      WHERE L1.Vno = #tmpledger.Vno 
            AND L1.Vtyp = #tmpledger.Vtyp 
            AND L1.Booktype = #tmpledger.Booktype 
            AND L1.Lno = #tmpledger.Lno 
      


/*updating Cross Account Code*/      
      UPDATE 
            #tmpledger 
            SET #tmpledger.Crosac = B.Cltcode 
      FROM Ledger B WITH(NoLock), 
            Acmast V WITH(NoLock) 
      WHERE B.Cltcode = V.Cltcode 
            AND V.Accat = 2 
            AND #tmpledger.Booktype = B.Booktype 
            AND #tmpledger.Vno = B.Vno 
            AND #tmpledger.Vtyp = B.Vtyp 
            AND Ltrim(Rtrim(#tmpledger.Vtyp)) In ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23') 
      


/*updating Bank Name*/                     
      UPDATE 
            #tmpledger 
            SET #tmpledger.Bank_name = B.Bank_name 
      FROM bsefo.Dbo.Pobank B WITH(NoLock) 
      WHERE Ltrim(Rtrim(Cast(B.Bankid AS Char))) = Ltrim(Rtrim(#tmpledger.Bank_name)) 

      
      If @Strorder = 'Accode'      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
				AND (cramt <> 0 or dramt <> 0 or opbal <> 0)
                  ORDER BY L.Cltcode, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Cltcode, 
                        Effdt 
            End      
      End      
      Else      
      Begin      
            If @Selectby = 'Vdt'      
            Begin       
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Voudt 
            End      
            Else      
            Begin      
                  SELECT 
                        L.* 
                  FROM #tmpledger L WITH(NoLock), 
                        Acmast A WITH(NoLock) 
                  WHERE L.Cltcode = A.Cltcode 
                        AND Accat In ('4', '104') 
                  ORDER BY L.Acname, 
                        Effdt 
            End      
      End      
      
/*  ------------------------------   End Of The Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------


CREATE PROCEDURE RPT_ACC_TRIALBALANCE      
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        IF @STDATE = @CURRYRSTDATE  
        BEGIN  
         INSERT INTO #TEMPLEDGER      
         SELECT L.CLTCODE ,      
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
         OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
         FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
         GROUP BY L.CLTCODE      
        END  
        ELSE  
        BEGIN  
         INSERT INTO #TEMPLEDGER      
         SELECT L.CLTCODE ,      
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
         OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
         FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
         GROUP BY L.CLTCODE      
        END  
       END      
      ELSE      
       BEGIN      
        IF @STDATE = @CURRYRSTDATE  
        BEGIN  
         INSERT INTO #TEMPLEDGER      
         SELECT L.CLTCODE ,      
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
         OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
         FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
         GROUP BY L.CLTCODE      
       END  
       ELSE  
       BEGIN  
         INSERT INTO #TEMPLEDGER      
         SELECT L.CLTCODE ,      
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
         OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
         FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
         GROUP BY L.CLTCODE      
       END  
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
       END      
      ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accallpartyledvoucherdisp
-- --------------------------------------------------

/*	REPORT : ALLPARTYLEDGER
	FILENAME :  VOUCHERDISP.ASP
*/
/* DISPLAYS DETAILS OF A VOUCHER FOR A PARTY FOR A DATE */
--EXEC RPT_ACCALLPARTYLEDVOUCHERDISP '3', '200400001901', 'MAY  5 2004', '41', '', '10100063'
CREATE  PROCEDURE RPT_ACCALLPARTYLEDVOUCHERDISP
@VTYP SMALLINT ,
@VNO VARCHAR (12),
@VDT VARCHAR(12) ,
@BOOKTYPE VARCHAR(2),
@BRANCH VARCHAR(10),
@CLTCODE VARCHAR(10)

AS
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'
	BEGIN
		IF @VTYP = 5
			BEGIN
				SELECT  VAMT , L.VTYP , L.VNO , L.VDT , L.DRCR , CLTCODE, ACNAME,  L.LNO , DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,
				NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,
				DDDT  =  CONVERT(VARCHAR, DDDT, 103)
				FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO
				AND L.LNO = L1.LNO
				WHERE L.VTYP = @VTYP
				AND L.VNO = @VNO
				AND L.VDT LIKE  LTRIM(VDT) + '%'
				AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE
				ORDER BY L.DRCR DESC , L.LNO
			END
		ELSE
			BEGIN
				SELECT  VAMT , L.VTYP , L.VNO , L.VDT , L.DRCR , CLTCODE, ACNAME,  L.LNO , DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,
				NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,
				DDDT  =  CONVERT(VARCHAR, DDDT, 103)
				FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO
				--AND L.LNO = L1.LNO
				WHERE L.VTYP = @VTYP
				AND L.VNO = @VNO
				AND L.VDT LIKE  LTRIM(VDT) + '%'
				AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE
				ORDER BY L.DRCR DESC , L.LNO
			END

	END
ELSE
	BEGIN
		IF @VTYP = 5
			BEGIN
				SELECT  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,
				DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),
				NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,
				DDDT  =  CONVERT(VARCHAR, DDDT, 103)
				FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO
				AND L.LNO = L1.LNO,
				ACCOUNTBFO.DBO.LEDGER2 L2 LEFT OUTER JOIN ACCOUNTBFO.DBO.ACMAST A ON L2.CLTCODE = A.CLTCODE
				WHERE L.VTYP = @VTYP
				AND L.VNO = @VNO
				AND L.VDT LIKE  LTRIM(VDT) + '%'
				AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE
				AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO
				AND COSTCODE = (SELECT COSTCODE FROM ACCOUNTBFO.DBO.COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))
				ORDER BY L2.DRCR DESC , L2.LNO
			END
		ELSE
			BEGIN
				SELECT  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,
				DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),
				NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,
				DDDT  =  CONVERT(VARCHAR, DDDT, 103)
				FROM ACCOUNTBFO.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTBFO.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO,
				--AND L.LNO = L1.LNO,
				ACCOUNTBFO.DBO.LEDGER2 L2 LEFT OUTER JOIN ACCOUNTBFO.DBO.ACMAST A ON L2.CLTCODE = A.CLTCODE
				WHERE L.VTYP = @VTYP
				AND L.VNO = @VNO
				AND L.VDT LIKE  LTRIM(VDT) + '%'
				AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE
				AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO
				AND COSTCODE = (SELECT COSTCODE FROM ACCOUNTBFO.DBO.COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))
				ORDER BY L2.DRCR DESC , L2.LNO
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acccompanyname
-- --------------------------------------------------


Create Proc Rpt_acccompanyname  
@Sharedb Varchar(15)  
As  
Select Companyname From Multicompany Where Sharedb = @Sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_AccodeList
-- --------------------------------------------------






/****** Object:  Stored Procedure dbo.rpt_AccodeList    Script Date: 12/16/2003 12:59:37 PM ******/


/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 04/13/2003 12:09:05 PM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------

CREATE PROCEDURE rpt_AccodeList
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT varchar(3),		--	Account Category
	@LOOKFORNAME VARCHAR(25)	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
AS

DECLARE
@strSQL VarChar(2500),
@@Inaccat varchar(3)

select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))

--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */

--BROKER LOGIN
If  @STATUSID="BROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT cltcode, acname, branchcode "
	Set @strSQL = @strSQL + "FROM acmast "
	Set @strSQL = @strSQL + "WHERE "
        if len(rtrim(@WHATTOLOOKFOR)) <> 0 and len(rtrim(@LOOKFORNAME)) <> 0 
           begin
	  	Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' and acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
	   end
        else
           if len(rtrim(@LOOKFORNAME)) <> 0 
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @LOOKFORNAME + "%') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
           else
               begin
                  Set @strSQL = @strSQL + " ( cltcode LIKE '" + @WHATTOLOOKFOR + "' or acname LIKE '" + @WHATTOLOOKFOR + "') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
               end
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS	
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + " AND "
		Set @strSQL = @strSQL + " cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + " AND "
			Set @strSQL = @strSQL + " cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End

	Set @strSQL = @strSQL + "ORDER BY cltcode, branchcode "
End

--BRANCH LOGIN
IF @STATUSID="BRANCH"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	acname, "
	Set @strSQL = @strSQL + "	branchcode "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' AND "
	Set @strSQL = @strSQL + "	(branchcode LIKE '" + @STATUSNAME + "' OR branchcode = 'ALL') and (accat LIKE '" + @ACCAT  + "%' or accat like '" + @@inaccat + "%' " 
        if rtrim(@accat) = '3'
           begin
		select @strSQL = @strSQL + " or accat in ( '14','18','114','118'))" 
           end
        else
           begin
		select @strSQL = @strSQL + " )" 
           end

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	cltcode, "
	Set @strSQL = @strSQL + "	branchcode "
End

--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2, "
	Set @strSQL = @strSQL + "	msajag.dbo.subbrokers s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.sub_broker = s.sub_broker AND "
	Set @strSQL = @strSQL + "	c1.sub_broker LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.sub_broker "
End

--TRADER LOGIN
If @STATUSID="TRADER"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.trader "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2, "
	Set @strSQL = @strSQL + "	msajag.dbo.branches s "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	/*Set @strSQL = @strSQL + "	c1.trader = s.branch_cd AND "*/
             Set @strSQL = @strSQL + "	c1.Branch_cd = s.branch_cd AND "
	Set @strSQL = @strSQL + "	c1.trader LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.trader "
End

--FAMILY LOGIN
If @STATUSID="FAMILY"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname, "
	Set @strSQL = @strSQL + "	c1.family "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	c1.family LIKE '" + @STATUSNAME + "' AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	If @WHICHWAY = ">"
	Begin
		Set @strSQL = @strSQL + "	AND "
		Set @strSQL = @strSQL + "	cltcode >= '" + @COMPARETOWHAT + "' "
	End
	Else
	Begin
		If @WHICHWAY = "<"
		Begin
			Set @strSQL = @strSQL + "	AND "
			Set @strSQL = @strSQL + "	cltcode <= '" + @COMPARETOWHAT + "' "
		End
	End
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	c1.family "
End

If @STATUSID="CLIENT"
Begin
	Set @strSQL = "SELECT "
	Set @strSQL = @strSQL + "DISTINCT "
	Set @strSQL = @strSQL + "	a.cltcode, "
	Set @strSQL = @strSQL + "	a.acname "
	Set @strSQL = @strSQL + "FROM "
	Set @strSQL = @strSQL + "	acmast a, "
	Set @strSQL = @strSQL + "	msajag.dbo.client1 c1, "
	Set @strSQL = @strSQL + "	msajag.dbo.client2 c2 "
	Set @strSQL = @strSQL + "WHERE "
	Set @strSQL = @strSQL + "	c1.cl_code = c2.cl_code AND "
	Set @strSQL = @strSQL + "	a.cltcode = c2.party_code AND "
	Set @strSQL = @strSQL + "	cltcode LIKE '" + @STATUSNAME + "' "
	Set @strSQL = @strSQL + "ORDER BY "
	Set @strSQL = @strSQL + "	a.cltcode "
End

	Set @strSQL = @strSQL + "	OPTION  (FAST 10)"

Print @strSQL
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------



/*this Procedure Gives Us The Discription For Supplied Vtype*/
create Procedure 
Rpt_accvdesc 
@Vtype Smallint
As
Select Vdesc From Vmast Where 
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_conpath
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[rpt_conpath]  
  
@exch varchar(3),  
@segment varchar(20)  
  
AS  
  
select conpath from account_ab.dbo.owner where exchange=@exch and segment like ltrim(@segment)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_currentopentry
-- --------------------------------------------------


/*
This Gives Us The Open Entry Date For Supplied Yr
*/
CREATE Procedure Rpt_currentopentry
@Sdtcur Datetime , 
@Ldtcur Datetime
As
/*
Select Distinct Isnull(Convert(Varchar, Vdt, 109), '')  From AccountBFo.Dbo.Ledger Where Vtyp = '18' And
Vdt > = Ltrim(@Sdtcur) And Vdt < = Ltrim(@Ldtcur) + ' 23:59:59'  
*/
Select Distinct Isnull(Left(Convert(Varchar, Vdt, 109), 11), '')  From Ledger Where Vtyp = '18' And
Vdt > = @Sdtcur And Vdt < = @Ldtcur  + ' 23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_finyearlist
-- --------------------------------------------------


Create Procedure  Rpt_finyearlist  
As  
Select Distinct  Smonth = Datename(Month, Sdtcur), Syear = Datename(Year, Sdtcur), Emonth = Datename(Month, Ldtcur),   
 Lyear = Datename(Year, Ldtcur) , Sdt = Convert(Varchar, Sdtcur, 103),   
Ldt = Convert(Varchar, Ldtcur, 103), Curyear From Parameter  
Order By Curyear Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_lastopentry
-- --------------------------------------------------



/*
This Query Is Used If Opening Entry For Current Yr Is Not Found
This Query Gives Us The Latest Opeing Entry Date
*/
Create Procedure Rpt_lastopentry
@Sdtcur Datetime
As
Select   Isnull(Left((Convert(Varchar, Max(Vdt), 109)), 11), '') From Ledger Where Vtyp = '18' And
Vdt < @Sdtcur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS
-- --------------------------------------------------


Create PROC RPT_RETURNFIELDS      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_todaydate
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 06/24/2004 8:32:39 PM ******/    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 05/10/2004 5:29:46 PM ******/    
    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/14/2002 20:39:23 ******/    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 01/04/1980 1:40:42 AM ******/    
    
    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 11/28/2001 12:23:51 PM ******/    
    
    
    
    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 2/17/01 5:19:55 PM ******/    
    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 3/21/01 12:50:24 PM ******/    
    
/****** Object:  Stored Procedure dbo.rpt_todaydate    Script Date: 20-Mar-01 11:39:03 PM ******/    
    
    
    
CREATE PROCEDURE rpt_todaydate    
AS    
select convert(varchar,getdate(),103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_todaydate1
-- --------------------------------------------------



Create Procedure Rpt_todaydate1  
As  
Select Convert(varchar(11),getdate(),109)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_voucherprinting
-- --------------------------------------------------
CREATE Proc Rpt_voucherprinting
@Vtyp    Varchar(2), 
@Booktype    Varchar(2), 
@Fromdate   Varchar(11), 
@Todate   Varchar(11), 
@Vnofrom   Varchar(12), 
@Vnoto   Varchar(12)
As
Declare
 @@Selectqury   As Varchar(8000), 
 @@Fromtables   As Varchar(2000), 
 @@Wherepart    As Varchar(8000), 
 @@Sortby       As Varchar(200)
   If @Vnofrom <> '' And @Vnoto <> '' 
    Begin 
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  
      And L.Vno > = '" + @Vnofrom + "'  And L.Vno < = '" + @Vnoto + "'  
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
      
    End
   Else
    Begin
      -- Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "'  And L.Booktype = '" + @Booktype + "'
     Select @@Wherepart = " Where L.Vtyp = '" + @Vtyp + "' 
       And  L.Vdt > = '" + @Fromdate + " 00:00:00' And L.Vdt < = '" + @Todate +" 23:59:59' "
    End       
   If @Vtyp = '2'  Or @Vtyp = '3' Or @Vtyp = '5'  Or @Vtyp = '16'  Or @Vtyp = '17'  Or @Vtyp =  '20'  Or @Vtyp = '19' Or  @Vtyp = '1' Or  @Vtyp = '4' Or  @Vtyp = '22' Or  @Vtyp = '23'  
   Begin
    Select @@Wherepart = @@Wherepart + "  And   Cltcode <> '" + @Booktype + "'" 
   End
   Else
   Begin
    Select @@Wherepart = @@Wherepart + "  And L.Booktype = '" + @Booktype + "'"
   End 
   Select @@Selectqury = " Select Distinct L.Vno, Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Vamt = Isnull(L.Vamt, 0), L.Drcr, 
   Cltcode,  Acname , 
   Isnull(L.Vamt, 0) Vamt,  L.Drcr,  L.Vtyp, L.Vno, L.Lno , L.Booktype, Convert(Varchar, L.Vdt, 103) Vdt, Convert(Varchar, L.Edt, 103) Edt, 
     Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno, Dddt  =  Convert(Varchar, Dddt, 103)  , 
     L.Narration, Cltcode2 = Cltcode, Acname2 = Acname "
   Select @@Fromtables = " From Ledger L Left Outer Join Ledger1 L1 On  L.Vtyp = L1.Vtyp And L.Booktype = L1.Booktype And L.Vno = L1.Vno And L.Lno = L1.Lno "
   Select @@Sortby = " Order By L.Vdt, L.Vtyp, L.Booktype, L.Vno, L.Drcr Desc, L.Lno Desc "
    
 Print  (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )
Exec (@@Selectqury + @@Fromtables + @@Wherepart + @@Sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTION_QUERIES_PROC
-- --------------------------------------------------


--EXEC SELECTION_QUERIES_PROC 'BROKER','%','REGION','%'
CREATE PROC SELECTION_QUERIES_PROC
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(10),
@SELECTON VARCHAR(15),
@SEARCH VARCHAR(10),
@FROMAC VARCHAR(10) = '0000000000',
@TOAC VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE
@@SELECTIONQUERY AS VARCHAR(500),
@@FINALQUERY AS VARCHAR(500)

DECLARE CUR_SELECTION_PARAMETER CURSOR FOR
	SELECT 
		SELECTIONQUERY
	FROM
		SELECTION_QUERIES_TABLE
	WHERE
		STATUSID = @STATUSID
		AND SELECTON = @SELECTON		
        
        OPEN CUR_SELECTION_PARAMETER
        
        FETCH NEXT FROM CUR_SELECTION_PARAMETER
        INTO @@SELECTIONQUERY

WHILE @@FETCH_STATUS = 0        
BEGIN
	SELECT @@FINALQUERY = REPLACE(@@SELECTIONQUERY, 'STATUSNAME', '''' + @STATUSNAME + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'FROMAC', '''' + @FROMAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'TOAC', '''' + @TOAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'SEARCH', '''' + @SEARCH + '''')

	FETCH NEXT FROM CUR_SELECTION_PARAMETER
	INTO @@SELECTIONQUERY
END

CLOSE CUR_SELECTION_PARAMETER
DEALLOCATE CUR_SELECTION_PARAMETER

PRINT @@FINALQUERY
EXEC (@@FINALQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SelectVoucherDetails
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 18/04/2006 13:14:48 ******/


/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 12/16/2003 12:59:31 PM ******/

/****** Object:  Stored Procedure dbo.SelectVoucherDetails    Script Date: 04/07/2003 12:28:25 PM ******/
CREATE Proc SelectVoucherDetails

@Vtyp 		varchar(2),
@BookType 	varchar(2),
@FromDate 	varchar(12),
@Todate 	varchar(12),
@VnoFrom 	varchar(12),
@VnoTo 		varchar(12),
@BankCode 	varchar(12) 

as

Declare
@@selectqury 	as varchar(8000),
@@fromtables 	as varchar(2000),
@@wherepart  	as varchar(8000),
@@sortby     	as varchar(200)

 
if @VnoFrom <> '' and @VnoTo <> '' 
   begin 
 	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and l.vno >= '" + @VnoFrom + "'  and l.vno <= '" + @VnoTo + "' and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end
else
   begin
	 select @@wherepart = " where  l.Vtyp = '" + @Vtyp + "' and  l.vdt >= '" + @FromDate + " 00:00:00' and l.vdt <= '" + @ToDate +" 23:59:59' "
   end							

if @Vtyp = '2'  or @Vtyp = '3' or @Vtyp = '5'  or @Vtyp = '16'  or @Vtyp = '17'  or @Vtyp =  '20'  or @Vtyp = '19' or  @Vtyp = '1' or  @Vtyp = '4' or  @Vtyp = '22' or  @Vtyp = '23'  
   begin
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno, ( select distinct vtyp, booktype, vno from ledger where  cltcode = '" + @BankCode + "' 	and vtyp = '" + @vtyp + "' and vdt >= '" + @Fromdate + " 00:00:00' and vdt <= '" + @Todate + " 23:59:59' ) t "
	select @@wherepart = @@wherepart + " and l.vtyp = t.vtyp and l.booktype = t.booktype and l.vno = t.vno and  cltcode <> '" + @BankCode + "'" 
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
   end
else
   begin
	select @@wherepart = @@wherepart + "  and l.booktype = '" + @Booktype + "'"
	select @@fromtables = " from Ledger l left outer join  ledger1 l1  on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno "
   end 

select @@wherepart = @@wherepart 

select @@selectqury = " select distinct l.vno,isnull(dd,'') dd  ,isnull(ddno,'') ddno,Vamt = isnull(l.vamt,0), l.drcr,cltcode = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select party_code from marginledger m where vtyp = l.vtyp and m.vno = l.vno 
and lno = l.lno and booktype = l.booktype ) else l.cltcode end) ,0), acname = isnull((case when l.vtyp = 19 or l.vtyp = 20 then (select acname from marginledger m where vtyp = l.vtyp and m.vno = l.vno and lno = l.lno and booktype = l.booktype and party_code = cltcode) else l.acname end ),0), ChequeInName = isnull(chequeinname,''), l.narration ,PrintedFlag = isnull(Chqprinted,0) , micrno ,l.booktype"

select @@sortby = " order by l.vno "
				
print  (@@selectqury + @@fromtables + @@wherepart + @@sortby ) 
exec (@@selectqury + @@fromtables + @@wherepart + @@sortby )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Addbranch_Execute
-- --------------------------------------------------


/****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 01/15/2005 4:39:22 Pm ******/  
  
  
/****** Object:  Stored Procedure Dbo.Sp_Addbranch_Execute    Script Date: 12/16/2003 2:21:39 Pm ******/  
  
  
Create Proc Sp_Addbranch_Execute  
@Strsql Varchar(8000)  
As  
 Print @Strsql  
 Exec (@Strsql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getclosebal
-- --------------------------------------------------
CREATE   procedure sp_getclosebal
@cltcode 	varchar(10),
@fromdate	datetime

as

Declare
@@openbaldt 	 varchar(11),
@@openentry 	 money,
@@openingbal 	 money,
@@dramt 	 money,
@@cramt 	 money,
@@partycode	 varchar(20),
@@opendt 	  cursor,
@@openbalcursor cursor

		set @@opendt = cursor for
		select left(convert(varchar,isnull(max(vdt),0),109),11) from  ledger l
		where vtyp = 18 and cltcode like @cltcode
		and vdt < = @fromdate  
		open @@opendt
 		fetch next from @@opendt into  @@openbaldt
	
		while @@fetch_status = 0
		begin	
	
			/*Find the amount of the opening entry for the client if present else set to 0 */
			select @@dramt = 0
			select @@cramt = 0
			select @@openentry =0

			set @@openbalcursor = cursor  for 
			select cltcode,dramt = isnull((case when drcr = 'd' then sum(vamt) else 0 end),0),
			cramt = isnull((case when drcr = 'c' then sum(vamt) else 0 end),0)
			from  ledger where vtyp = 18 and vdt like @@openbaldt + '%'
    			and cltcode like @cltcode
			group by drcr,cltcode
    			open @@openbalcursor

 			fetch next from @@openbalcursor into @@partycode,@@dramt,@@cramt
  
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openentry = 0 - @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openentry = @@cramt
				end			
				fetch next from @@openbalcursor into @@partycode,@@dramt,@@cramt	
			end
			
			close @@openbalcursor
			deallocate @@openbalcursor

			select @@dramt = 0
			select @@cramt = 0
			select @@openingbal = 0
			
			set @@openbalcursor = cursor for 
			select cltcode,drtotal=isnull((case drcr when 'd' then sum(vamt) end),0), 
			crtotal=isnull((case drcr when 'c' then sum(vamt) end),0) 
			from  ledger where vdt > = @@openbaldt 
    			and vdt <= @fromdate + ' 23:59:59' and vtyp <> 18 and cltcode like @cltcode
    			group by drcr,cltcode 
			open @@openbalcursor
 			fetch next from @@openbalcursor into @@partycode,@@dramt,@@cramt
			
			while @@fetch_status = 0
			begin
				if @@dramt <> 0  
				begin
					select @@openingbal = @@openingbal - @@dramt
				end
				if @@cramt <> 0 
				begin
					select @@openingbal = @@openingbal + @@cramt
				end
			
				fetch next from @@openbalcursor into @@partycode,@@dramt,@@cramt					
			end
			
			select @@openingbal = @@openingbal + @@openentry

			close @@openbalcursor
			deallocate @@openbalcursor

			select @fromdate,@cltcode,@@openingbal as amount
			fetch next from @@opendt into  @@openbaldt
		end	

		close @@opendt
		deallocate @@opendt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_voucherreport
-- --------------------------------------------------



CREATE    Procedure Sp_voucherreport
 ( @Reptype Varchar(2), @Fromdate Varchar(11), @Todate Varchar(11), @Frombankcode Varchar(10), 
  @Tobankcode Varchar(10), @Fromclientid Varchar(10), @Toclientid Varchar(10), @Statusid Varchar(12), @Statusname Varchar(12) )
As
Declare @Strsql As Varchar(1000)
If  @Statusid <> 'Branch'
Begin
-- **** Other Than Branch Login.
 If @Reptype = '1'
  Begin
--  ****  Cheque Is Cancelled.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " + 
   " A.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A" + 
   " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' " 
   If  @Frombankcode <> '' 
    Begin
     Set @Strsql = @Strsql + " And (Cltcode > = ' " + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"
    End
   
  Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   " Where A.Vno <> '' And A.Vtyp = 16 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + "' And A.Vdt < = '" + @Todate + " 23:59:59'" --test
   If @Fromclientid <> ''
    Begin
     Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
    End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc "
  End 
 Else If @Reptype = '2' 
  Begin
--  ****  Cheque Is Returned.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +
   " A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +
   " Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' " 
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End 
  Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   " Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   " Where A.Vno <> '' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00'" +
   " And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +
    "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '4' 
  Begin
--  **** Margin Bank Received.
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +
   "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00'" +
   " And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"     
   End
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"
  End
 Else If @Reptype = '7' 
  Begin
--  **** Journal Voucher.
  Set @Strsql = "select  A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +
   "a.Vamt, A.Narration From Ledger A Where A.Vno <> '' And A.Vtyp = 8  " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
  
   /*if(@Frombankcode <> "") 
    --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"     
   End If
  
   If(Trim(Strfromclientid) <> "") 
    'Strsql = Strsql + " And (A.Cltcode > = '" & Trim(Strfromclientid) & "' And A.Cltcode < = '" & Trim(Strtoclientid) & "') " 
   End If */
  Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
   "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '9' 
  Begin
--  **** Debit Note.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 6  " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')" 
   End
  
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
  End
 Else If @Reptype = '10' 
  Begin
--  **** Credit Note.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 7  " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"
   End
  
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
  End
 Else If @Reptype = '11' 
  Begin
--  **** Contra Entry.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vtyp = 5 " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')" 
   End
  
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
 
  End
 Else If @Reptype = '13' 
  Begin
--  **** Margin Bank Repayment.
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +
   "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +
   "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +
   "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 20 "
   If @Frombankcode <> '' 
  Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')"     
   End
   If @Fromclientid <> ''
   Begin 
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, 
   C.Ddno,  C.Dddt, Ledger.Narration"
  End
 Else If @Reptype = '14'  
  Begin
--  **** Margin Cash Received.  
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +
   "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 22 "
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')" 
   End
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"
  End
 Else If @Reptype = '15' 
  Begin
--  **** Margin Cash Repayment.
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +
   "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where A.Vtyp = 23 "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')" 
   End
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"
  End
 Else If @Reptype = '16'    
  Begin
--  **** Margin Journal Entries.(Vtyp = 24)
  
  Set @Strsql = "select A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, " +
   " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +
   "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode " +
   "where A.Vno <> ''  And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' " 
   /*if(Trim(Strbankcode) <> "") 
    'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"     
   End If */
  
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '19' 
--  **** Payment Bank.
  Begin
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +
   "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"     
   End
 
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Inner Join " +
   "ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' " +
   "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, 
     C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '20' 
  Begin
--  **** Payment Cash.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "
   If @Frombankcode <> '' 
   Begin 
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' And A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' " 
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype =  '21' 
  Begin
--  **** Receipt Bank.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +
   "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A Inner Join " +
   "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"     
   End
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   "where A.Vno <> '' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +
   "and A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '22' 
  Begin
--  **** Receipt Cash.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype Where A.Vno <> '' " +
   "and A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
   "order By A.Vno, A.Vdt, A.Drcr Desc "
 
 --else Raiserror ('50001 : No Voucher Type Found', 0, 13)
  End
End
Else
Begin
-- **** Branch Login.
 If @Reptype = '1' 
  Begin
--  **** When Cheque Is Cancelled.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, " +
   "a.Drcr, A.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +
   "inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 16 And Drcr = 'D' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"
   End
  
  Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   "inner Join Acmast B On A.Cltcode = B.Cltcode " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 16 And A.Drcr = 'C' " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration  " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '2' 
  Begin
--  **** When Cheque Is Returned.(Vtyp = 17)
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +
   ".Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A " +
   "nner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 17 And Drcr = 'C' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End
  Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype  " +
   "inner Join Acmast B On A.Cltcode = B.Cltcode " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype  " +
   "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 17 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +
   "and A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '4' 
  Begin
--  **** Margin Bank Received.(Vtyp = 19)
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt " +
   "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype  " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 19 And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')" 
   End
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, C.Ddno, C.Dddt, Ledger.Narration"
  
  End
 Else If @Reptype = '7' 
  Begin
--  **** Journal Voucher.(Vtyp = 8)
  Set @Strsql = "select  A.Vtyp,  A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " + 
   "a.Vamt, A.Narration From Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' " +
   "and B.Branchcode = '" + @Statusname + "' And A.Vtyp = 8  " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
  
   /*if(@Frombankcode <> "") 
    --@Strsql = @Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"     
   End If
  
   If(Trim(Strfromclientid) <> "") 
    'Strsql = Strsql + " And (A.Cltcode > = '" & Trim(Strfromclientid) & "' And A.Cltcode < = '" & Trim(Strtoclientid) & "') " 
   End If */
  Set @Strsql = @Strsql + " Group By  A.Vtyp,  A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
   "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '9' 
  Begin
--  **** Debit Note.(Vtyp = 6)
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 6  " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')"     
   End
  
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid +"' ) " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
  End
 Else If @Reptype = '10'
  Begin 
--  **** Credit Note.(Vtyp = 7)
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 7   " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> ''
   Begin 
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')" 
   End 
  
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
  End
 Else If @Reptype = '11' 
  Begin
--  **** Contra Entry. (Vtyp = 5)
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), A.Cdt, 109) Cdt, B.Pobankname, B.Pobankcode, A.Narration " +
   "from Ledger A Inner Join Acmast B On A.Cltcode = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 5 " +
   "and A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Frombankcode + "' And A.Cltcode < = '" + @Tobankcode + "')" 
   End
  
   If @Fromclientid <> '' 
   Begin 
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End
  Set @Strsql = @Strsql + " Order By A.Vno, A.Vdt, A.Drcr Desc"
 
  End
 Else If @Reptype = '13' 
  Begin
--  **** Margin Bank Repayment. (Vtyp = 20)
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr, C.Ddno, Convert(Varchar(11), C.Dddt, 109) Cdt  " +
   "from Ledger Inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And " +
   "ledger.Booktype = A.Booktype Inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And " +
   "a.Booktype = C.Booktype Inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 20 "
   If (@Frombankcode <> "") 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "' )"
   End
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, " +
   "c.Ddno,  C.Dddt, Ledger.Narration"
  End
 Else If @Reptype = '14' 
  Begin
--  **** Margin Cash Received.(Vtyp = 22)  
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode,  " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +
   "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 22 "
   If @Frombankcode <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')" 
   End
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"
  
  End  
 Else If @Reptype = '15' 
  Begin
--  **** Margin Cash Repayment.
  Set @Strsql = "select Ledger.Narration, A.Booktype, A.Vtyp, A.Vno, A.Party_code Cltcode, " +
   "convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Amount Vamt, A.Drcr  From Ledger " +
   "inner Join Marginledger A On Ledger.Vno = A.Vno And Ledger.Vtyp = A.Vtyp And Ledger.Booktype = A.Booktype " +
   "inner Join Acmast B On A.Party_code = B.Cltcode Where B.Branchcode = '" + @Statusname + "' A.Vtyp = 23 "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Frombankcode + "' And A.Party_code < = '" + @Tobankcode + "')" 
   End
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Party_code > = '" + @Fromclientid + "' And A.Party_code < = '" + @Toclientid + "')"
   End
 
  Set @Strsql = @Strsql + " Group By A.Booktype, A.Vtyp, A.Vno,  A.Party_code, A.Vdt, B.Acname, A.Amount, A.Drcr, Ledger.Narration"
  End
 Else If @Reptype = '16'    
  Begin
--  **** Margin Journal Entries.(Vtyp = 24)
  
  Set @Strsql = "select A.Vtyp, A.Party_code  Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, B.Acname, A.Drcr, "+
   " A.Amount Vamt, C.Narration From Marginledger A Inner Join Ledger C On A.Vno = C.Vno And A.Vtyp = C.Vtyp " +
   "and A.Booktype = C.Booktype Inner Join Acmast B On  A.Party_code = B.Cltcode And A.Booktype = B.Booktype " +
   "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' " 
   /*if(Trim(Strbankcode) <> "") 
    'Strsql = Strsql + " And (Cltcode > = '" & Trim(Strbankcode) & "' And Cltcode < = '" & Trim(Strtobankcode) & "')"     
   End If */
  
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "') " 
   End 
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Party_code, A.Vno, A.Vdt, B.Acname, A.Drcr, A.Amount, C.Narration  " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '19' 
  Begin
--  **** Payment Bank.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt, " +
   "convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, " +
   "booktype From Ledger Where Vtyp = 3 And Drcr = 'C' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End
 
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   "inner Join Acmast B On A.Cltcode = B.Cltcode Inner Join Ledger1 C On A.Vno = C.Vno " +
   "and A.Vtyp = C.Vtyp And A.Booktype = C.Booktype Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +
   "and A.Vtyp = 3 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "' )" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, " +
     "c.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '20' 
  Begin
--  **** Payment Cash.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
   "from Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 4 And Drcr = 'C' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')" 
   End 
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   "inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +
   "and A.Vtyp = 4 And A.Drcr = 'D' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' " 
   If @Fromclientid <> ''  
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End 
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
     "order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '21' 
  Begin
--  **** Receipt Bank.
  Set @Strsql = "select C.Ddno, A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, " +
   "a.Vamt, Convert(Varchar(11), C.Dddt, 109) Cdt, A.Narration From Ledger A Inner Join " +
   "(Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 2 And Drcr = 'D' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "' )"
   End
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   "inner Join Acmast B On A.Cltcode = B.Cltcode " +
   "inner Join Ledger1 C On A.Vno = C.Vno And A.Vtyp = C.Vtyp And A.Booktype = C.Booktype " +
   "where A.Vno <> '' And B.Branchcode = '" + @Statusname + "' And A.Vtyp = 2 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' " +
   "and A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> '' 
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By C.Ddno, A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt, C.Dddt, A.Narration Order By A.Vno, A.Vdt, A.Drcr Desc "
  End
 Else If @Reptype = '22' 
  Begin
--  **** Receipt Cash.
  Set @Strsql = "select  A.Vtyp, A.Cltcode, A.Vno, Convert(Varchar(11), A.Vdt, 109) Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration From Ledger A Inner Join (Select Vno, Cltcode, Acname, Vtyp, Booktype From Ledger Where Vtyp = 1 And Drcr = 'D' "
   If @Frombankcode <> '' 
   Begin
    Set @Strsql = @Strsql + " And (Cltcode > = '" + @Frombankcode + "' And Cltcode < = '" + @Tobankcode + "')"     
   End
   Set @Strsql = @Strsql + " ) D On A.Vno = D.Vno And A.Vtyp = D.Vtyp And A.Booktype = D.Booktype " +
   " Inner Join Acmast B On A.Cltcode = B.Cltcode Where A.Vno <> '' And B.Branchcode = '" + @Statusname + "'" +
   " And A.Vtyp = 1 And A.Drcr = 'C' And A.Vdt > = '" + @Fromdate + " 00:00:00' And A.Vdt < = '" + @Todate + " 23:59:59' "
   If @Fromclientid <> ''
   Begin
    Set @Strsql = @Strsql + " And (A.Cltcode > = '" + @Fromclientid + "' And A.Cltcode < = '" + @Toclientid + "')" 
   End
  Set @Strsql = @Strsql + " Group By  A.Vtyp, A.Cltcode, A.Vno, A.Vdt, A.Acname, A.Drcr, A.Vamt,  A.Narration " +
   "order By A.Vno, A.Vdt, A.Drcr Desc "
 --else Raiserror ('50001 : No Voucher Type Found For Branch.', 0, 13)
 End
End
Print @Strsql
Execute ( @Strsql )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Spa_InsVouchertemp
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 06/24/2004 8:32:35 PM ******/    
    
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 05/10/2004 5:29:35 PM ******/    
    
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 02/18/2003 10:25:07 AM ******/    
/****** Object:  Stored Procedure dbo.Spa_InsVouchertemp    Script Date: 01/27/2003 9:57:08 PM ******/    
CREATE PROCEDURE Spa_InsVouchertemp    
 @vno varchar(20),    
 @vtype varchar(2),    
 @booktype varchar(2),    
 @billflag char(1),    
 @costflag char(1),    
 @sid varchar(20)    
 AS    
declare @@tmpcat varchar(50),    
@@tmplno varchar(3),    
@@tmpcost varchar(50),    
@@tmpcostname varchar(50),    
@@tmpexists integer,    
@@tmpcltcode varchar(16),    
@@CNo Cursor    
    
if @billflag=1    
begin    
insert into tempbilldetails     
/*    
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,    
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno     
 from matchdetails m left outer join billmatch b on m.vno=b.vno and m.vtype=b.vtype and m.booktype= b.booktype and     
 m.lno=b.lno and b.vtype=15 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype      
 and m.description not like 'Advances%' */    
    
    
 select distinct Exchange,m.Party_code,Sett_no,Sett_type,m.drcr,b.amount,balamt,payamout= m.amount,sessionid=@sid,m.llno,m.lno,    
 b.date,m.description,billbooktype=b.booktype,billvtype=b.vtype,m.lbooktype,m.lvtype,b.vno     
 from billmatch b left outer join matchdetails m on b.vno=m.vno and b.vtype=m.vtype and b.booktype= m.booktype and     
 b.lno=m.lno and b.party_code = m.party_code and b.vtype=15    
 where m.lvno = @vno and m.lvtype = @vtype and m.lBookType = @booktype  and m.description not like 'Advances%'    
end    
    
    
If @costflag=1    
begin    
 insert into templedger2 (vtype,vno,lno,drcr,paidamt,costcode,BookType,sessionid,party_code)    
 select distinct vtype,vno,lno,drcr,camt,costcode,BookType,sessionid=@sid,cltcode    
 from ledger2  where vno= @vno and vtype=@vtype and booktype= @booktype    
    
    
 Set @@Cno = Cursor For     
 select distinct lno,costcode,cltcode    
 from ledger2  where vno= @vno  and vtype=@vtype and booktype= @booktype    
 Open @@CNo     
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode    
 While @@Fetch_Status = 0     
 Begin    
  select @@tmpexists = (select count(*) as cnt from branchAccounts where BrControlAc =  @@tmpcltcode)    
  if @@tmpexists = 0    
  begin    
   select @@tmpcat = (select distinct top 1 c.category from category c, costmast m     
   where c.catcode = m.catcode and m.costcode=@@tmpcost)    
   update templedger2   set category= @@tmpcat where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and  party_code =@@tmpcltcode    
  end     
  else     
  begin    
   select @@tmpcat = 'BRANCH'    
   update templedger2   set category= 'BRANCH' where costcode = @@tmpcost and sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code =@@tmpcltcode    
  end    
 print @@tmpcost     
 select @@tmpcostname = (select distinct top 1 m.COSTNAME from category c, costmast m where c.catcode = m.catcode and m.costcode= @@tmpcost)    
 update templedger2 set branch = @@tmpcostname  where sessionid = @sid and vtype=@vtype and booktype =@booktype and lno = @@tmplno and party_code = @@tmpcltcode and costcode=@@tmpcost    
 select @@tmpcat= ''    
 select @@tmpcostname =''    
 select @@tmpcltcode = ''    
 select @@tmpcost=''    
 Fetch Next from @@CNo into @@tmplno,@@tmpcost,@@tmpcltcode    
 end    
 Close @@CNo    
 DeAllocate @@CNo    
    
 delete from templedger2 where party_code in ( select BrControlAc from branchAccounts)    
 update templedger2 set costflag = 'A', rowid = lno    
        where upper(category) = 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno    
 update templedger2 set costflag = 'A', rowid = lno    
        where upper(category) <> 'BRANCH' and sessionid = @sid and vtype=@vtype and booktype =@booktype and vno= @vno    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------


CREATE PROC UPDATEACMAST
	@EXCHANGE VARCHAR(20),
	@SEGMENT VARCHAR(20),
	@COMPANY VARCHAR(100)
AS
DECLARE
	@@SHAREDB AS VARCHAR(50),
	@@GRPCODE AS VARCHAR(50),
	@@SQL AS VARCHAR(2000)
/*
	EXEC UPDATEACMAST 'NSE', 'CAPITAL', 'MOTILAL OSWAL SECURITIES LTD'
*/
SELECT @@SHAREDB = ''
SELECT TOP 1
	@@SHAREDB = SHAREDB
FROM
	PRADNYA.DBO.MULTICOMPANY
WHERE
	EXCHANGE = @EXCHANGE
	AND SEGMENT = @SEGMENT
	AND COMPANYNAME = @COMPANY
	AND PRIMARYSERVER = 1

SELECT @@GRPCODE = ''
SELECT
	@@GRPCODE = ISNULL(GRPCODE, '')
FROM
	OWNER O,
	GRPMAST G
WHERE
	O.CLIENTGROUP = G.GRPNAME
IF @@SHAREDB = ''
	BEGIN
		SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'
		RETURN
	END
BEGIN TRANSACTION
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , (CASE WHEN CL_TYPE = 'REM' THEN 'LIABILITY' ELSE 'ASSET' END), (CASE WHEN CL_TYPE = 'REM' THEN '3' ELSE '4' END), '', PARTY_CODE , '', "
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "
SELECT @@SQL = @@SQL + "AND PARTY_CODE NOT IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT IN(3, 4)) "
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "
SELECT @@SQL = @@SQL + "AND ISNULL(LEDGER.ACNAME, '') <> A.LONGNAME "

--PRINT @@SQL
EXEC (@@SQL)
COMMIT TRANSACTION
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'

SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH_Ledger1
-- --------------------------------------------------
CREATE Proc USP_FETCH_Ledger1(@fdate as varchar(11),@tdate as varchar(11),@segment as varchar(25),@Code as varchar(20))                                    
as        
        
/*declare @segment as varchar(25)                                    
declare @fdate as varchar(25)                                    
declare @tdate as varchar(25)          
declare @Code as varchar(10)          
*/       
declare @str as varchar(5000)                    
declare @condition as varchar(1000)                                                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))           
        
/*        
set @fdate = 'May 01 2009'                                    
set @tdate = 'May 31 2009'                                    
set @segment = 'NSE'          
set @Code = 'ALL'         
*/        
If @Code = 'ALL'          
Begin          
 SET @condition =                      
 CASE                       
 WHEN @segment = 'AFAPL' THEN 'left(cltcode,3) in (''310'',''380'',''270'')'                      
 WHEN @segment = 'NBFC' THEN 'left(cltcode,3) in (''310'',''380'',''270'')' ELSE 'left(cltcode,3) = ''270'''  END           
End           
Else          
Begin          
 SET @condition = 'left(cltcode,3) = '''+@Code+''''          
End           
        
create table #Temp          
(          
 SrNo int identity(1,1) not null,          
 VNo varchar(20)          
)        
        
set @str = 'insert into #Temp select distinct vno from ledger x (nolock)  where vdt > = '''+@fdate+'''   
and vdt < = '''+@tdate+'''+'' 23:59:59''                    
and  vtyp = ''8'' and exists                     
(Select vno from ledger b where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' )'          
exec(@str)          
        
delete from  mis.upload.dbo.Ledger_txt      
  
insert into mis.upload.dbo.Ledger_txt                              
select 'SrNo'+'|'+'vtyp'+'|'+'vno'+'|'+'vdt'+'|'+'cltcode'+'|'+'LONGNAME'+'|'+'drcr'+'|'+'vamt'+'|'+'narration'+'|'+'Branch Code'     
        
set @str = 'insert into mis.upload.dbo.Ledger_txt select ltrim(rtrim(Convert(Varchar,b.srno)))+''|''+  
ltrim(rtrim(Convert(Varchar,vtyp)))+''|''+ltrim(rtrim(Convert(Varchar,x.vno)))+''|''+  
ltrim(rtrim(Convert(Varchar(12),vdt,107)))+''|''+ltrim(rtrim(X.cltcode))+''|''+  
ltrim(rtrim(LONGNAME))+''|''+ltrim(rtrim(x.drcr))+''|''+ltrim(rtrim(convert(varchar,vamt)))+''|''+  
ltrim(rtrim(narration))+''|''+ltrim(rtrim(isnull(costname,'''')))  from            
(Select * from ledger x (nolock)  where vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59''         and  vtyp = ''8'' and exists                     
(Select vno from ledger b (nolock) where x.vno = b.vno and '+@condition+'                     
and vtyp = ''8'' and vdt > = '''+@fdate+''' and vdt < = '''+@tdate+'''+'' 23:59:59'' ))x                    
left outer join                    
(select * from ACMAST (nolock))y                    
on x.cltcode=y.CLTCODE                    
left outer join                    
(select * from ledger2  (nolock))z                    
on x.vno = z.vno and x.lno = z.lno and x.cltcode = z.cltcode and x.vtyp = z.vtype                    
left outer join (select * from costmast (nolock))a on z.costcode = a.costcode          
left outer join (select * from #Temp)b on x.vno = b.vno'        
--print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_APPLICATION_LOG
-- --------------------------------------------------

CREATE proc V2_APPLICATION_LOG  
(  
          @FromDate VARCHAR(11),              
          @ToDate VARCHAR(11),              
          @LoginName  VARCHAR(10),  
          @ReportType varchar(10)  
)              
  
AS              
              
/*              
  SET @FromDate = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@FromDate,'/',''),'-',''),112),11)              
  SET @ToDate = LEFT(CONVERT(DATETIME,REPLACE(REPLACE(@ToDate,'/',''),'-',''),112),11)              
*/  
  SET @FromDate = LEFT(CONVERT(DATETIME,@FromDate,105),11)              
  SET @ToDate = LEFT(CONVERT(DATETIME,@ToDate,105),11)              
  
  
if @ReportType = 'LOGIN LOG'  
begin  
 if @LoginName = ''  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   [Action],   
   AddDt as [Activity Time]  
  FROM  
   V2_LOGIN_LOG (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
  Order by AddDt  
 end  
 else  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   [Action],   
   AddDt as [Activity Time]  
  FROM  
   V2_LOGIN_LOG (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
   AND USERNAME LIKE @LoginName + '%'  
  Order by AddDt  
 end  
end  
  
if @ReportType = 'ACCESS LOG'  
begin  
 if @LoginName = ''  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   RepPath [Report Path],   
   AddDt as [Activity Time]  
  FROM  
   V2_Report_Access_Log (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
  Order by AddDt  
 end  
 else  
 begin  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  SELECT  
   UserName [User Name],   
   StatusName [Status Name],   
   StatusID [Status ID],   
   IpAdd [IP Address],   
   RepPath [Report Path],   
   AddDt as [Activity Time]  
  FROM  
   V2_Report_Access_Log (NOLOCK)  
  WHERE  
   ADDDT >= @FROMDATE  
   AND ADDDT <= @TODATE + ' 23:59:59'  
   AND USERNAME LIKE @LoginName + '%'  
  Order by AddDt  
 end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BANKPOFILEGEN
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BANKPOFILEGEN]
(
	@VTYP VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12),	
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@FILETYPE VARCHAR(4),
	@PRINTFLAG CHAR(2)
)

AS
	
	IF @PRINTFLAG = 'FP'
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1, 
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED = 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT
		ORDER BY 
			L.VNO 
	END
	
	ELSE
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1,  
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED > 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT			
		ORDER BY 
			L.VNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_ALL
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BULKPAYOUTPOSTING_ALL]
(
	@SESSIONID VARCHAR(50),
	@UNAME VARCHAR(50),
	@S_SESSIONID VARCHAR(50),
	@GENFLAG VARCHAR(1),
	@SEGMENT VARCHAR(6),
	@CLIENT VARCHAR(10) = ''
)

AS

	-- EXEC ACCOUNT.DBO.V2_BULKPAYOUTPOSTING_ALL '84449309411212008', 'DEMO', '844493094', 'A', 'NSECM' 

	SET NOCOUNT ON

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@MAXCOUNT AS INT,
		@@VDT AS VARCHAR(11),
		@@BANKBRANCH AS VARCHAR(10),
		@@BANKCOST AS NUMERIC,
		@@VNOCUR AS CURSOR,
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS VARCHAR(12),
		@@ERROR_COUNT INT,
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@BOOKTYPE CHAR(2),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@VTYP SMALLINT,
		@@BNKCODE VARCHAR(100),
		@@MAXVNO INT,
		@@SQL VARCHAR(2500),
		@@EXCH CHAR(3),
		@@SEG CHAR(7)

	IF @SEGMENT = 'NSECM'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'BSECM'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'NSEFUT'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'BSEFUT'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'NSXFUT'
	BEGIN
		SET @@EXCH = 'NSX'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'MCDFUT'
	BEGIN
		SET @@EXCH = 'MCD'
		SET @@SEG = 'FUTURES'
	END
	-------------------------- UPDATE BANK CODE DETAILS ------------------------
	UPDATE
		P
	SET 
		BNKNAME = A.ACNAME,
		BRANCHCODE = A.BRANCHCODE,
		MICRNO = A.MICRNO,
		BOOKTYPE = A.BOOKTYPE,
		ACCDTLS = A.ACCDTLS,
		UPDFLAG = 'Y'
	FROM 
		V2_PAYOUT_TEMP P,
		ACMAST A
	WHERE 
		P.BNKCODE = A.CLTCODE
		AND ACCAT = 2
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		COSTCODE = C.COSTCODE,
		ACNAME = A.LONGNAME
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = ACCODE
		AND ACCAT IN ('4')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		BANKCOST = C.COSTCODE
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = BNKCODE
		AND ACCAT IN ('2')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		V2_PAYOUT_TEMP
	SET 
		BANKCOST = COSTCODE
	WHERE 
		BANKCOST = ''
		AND SESSIONID = @SESSIONID

	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
	) A

	IF @@ERROR_COUNT > 0
	BEGIN
		SELECT 
			'FOLLOWING CLIENTS DO NOT EXIST<BR>'
		UNION ALL
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
		DELETE FROM 
			V2_PAYOUT_TEMP 
		WHERE 
			SESSIONID = @SESSIONID
		RETURN
	END

	--------------------------AUTO GENERATION OF VNO ------------------------
	SELECT
		@@STD_DATE = LEFT(SDTCUR, 11),
		@@LST_DATE = LEFT(LDTCUR, 11),
		@@VNOMETHOD = VNOFLAG
	FROM 
		PARAMETER
	WHERE 
		CURYEAR = 1     

	SET @@VNOCUR = CURSOR FOR
	SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	OPEN @@VNOCUR
	FETCH NEXT
	FROM
		@@VNOCUR
	INTO
		@@BNKCODE,
		@@BOOKTYPE,
		@@VTYP
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE
		#BANK_VNO
		(
			SRNO INT,
			NEWSRNO INT IDENTITY (1, 1)
		)

	INSERT INTO
		#BANK_VNO
	SELECT DISTINCT 
		SRNO
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		BNKCODE = @@BNKCODE
		AND BOOKTYPE = @@BOOKTYPE
		AND SESSIONID = @SESSIONID

	SELECT
		@@MAXCOUNT = COUNT(DISTINCT SRNO)
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT TOP 1
		@@VDT = VDT
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT  
		LASTVNO  
	INTO 
		#VNO  
	FROM  
		LASTVNO  
	WHERE  
		1 = 2

	SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

	INSERT INTO 
		#VNO
	EXEC 
		ACC_GENVNO_NEW
		@@VDT,
		@@VTYP,
		@@BOOKTYPE,
		@@STD_DATE,
		@@LST_DATE,  
		@@MAXVNO  

	SELECT  
		@@NEWVNO = LASTVNO  
	FROM  
		#VNO

	UPDATE
		P
	SET 
		VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
	FROM
		V2_PAYOUT_TEMP P WITH(NOLOCK),
		#BANK_VNO BV
	WHERE
		P.SRNO = BV.SRNO 
		AND SESSIONID = @SESSIONID

	DROP TABLE #VNO  
	DROP TABLE #BANK_VNO

	FETCH NEXT  
	FROM @@VNOCUR  
	INTO  
		@@BNKCODE,  
		@@BOOKTYPE,
		@@VTYP  
	END  

	DEALLOCATE @@VNOCUR

	--------------------------AUTO GENERATION OF LNO ------------------------
	UPDATE
		V2_PAYOUT_TEMP
	SET 
		LNO = 2
	WHERE 
		VNO IN
	(
		SELECT
			VNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			SESSIONID = @SESSIONID
		GROUP BY 
			VNO
		HAVING 
			COUNT(*) = 1
	)

	SET @@LNOCUR = CURSOR FOR
	SELECT
		VNO
	FROM 
		V2_PAYOUT_TEMP WITH(NOLOCK) 
	WHERE 
		SESSIONID = @SESSIONID
	GROUP BY 
		VNO
	HAVING 
		COUNT(*) > 1

	OPEN @@LNOCUR
	FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE [#LNOGEN] 
		(
			VNO VARCHAR(12),
			SNO INT,
			LNO INT IDENTITY(1,1)
		)

		INSERT INTO 
			#LNOGEN
		SELECT
			VNO,
			SRNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			VNO = @@LNOVNO 
			AND SESSIONID = @SESSIONID
		ORDER BY 
			SRNO

		UPDATE
			V2_PAYOUT_TEMP
		SET 
			LNO = L.LNO + 1
		FROM 
			#LNOGEN L
		WHERE 
			V2_PAYOUT_TEMP.VNO = L.VNO
			AND V2_PAYOUT_TEMP.SRNO = L.SNO
			AND V2_PAYOUT_TEMP.LNO = 0 
			AND SESSIONID = @SESSIONID

		DROP TABLE #LNOGEN
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	END

	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR

	BEGIN TRANSACTION

	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	INSERT INTO 
		LEDGER1
	SELECT
		BNKNAME,
		BRNNAME = BRCODE,
		DD = LEFT(PAYMODE, 1),
		DDNO,
		DDDT = VDT,
		RELDT = '',
		RELAMT = AMT,
		REFNO = 0,
		RECEIPTNO = 0,
		VTYP,
		VNO,
		LNO = 2,
		DRCR,
		BOOKTYPE,
		MICRNO,
		SLIPNO = 0,
		SLIPDATE = '',
		CHEQUEINNAME = ISNULL(ACNAME,''),
		CHQPRINTED = 0,
		CLEAR_MODE = ''
	FROM
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = ACCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO,
		DRCR,
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = ACCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO = 1,
		BNKNAME,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = BNKCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO = 1,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = BNKCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	UPDATE 
		V2_PAYOUT_TEMP 
	SET 
		LEDGER2_UPD = 'Y' 
	WHERE 
		SESSIONID = @SESSIONID 
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = 1,
		NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = LNO,
		NARR = NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	DECLARE @@L2CUR AS CURSOR,
	@@L2VNO AS VARCHAR(12)

	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		DELETE FROM 
			TEMPLEDGER2
		WHERE 
			SESSIONID =  @S_SESSIONID

		/*==============================
		CLIENT SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			C.COSTNAME,
			AMT,
			VTYP,
			VNO,
			LNO,
			DRCR,
			'0',
			BOOKTYPE,
			@S_SESSIONID ,
			ACCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP RP,
			COSTMAST C
		WHERE
			RP.COSTCODE = C.COSTCODE
			AND VNO = @@L2VNO
			AND SESSIONID = @SESSIONID

		/*==============================
		BANK SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			BRANCHCODE,
			SUM(AMT),
			VTYP,
			VNO,
			LNO = 1,
			DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
			'0',
			BOOKTYPE,
			@S_SESSIONID,
			BNKCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP
		WHERE
			VNO = @@L2VNO
			AND SESSIONID = @SESSIONID
		GROUP BY 
			BRANCHCODE, 
			VTYP, 
			VNO, 
			(CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE

		EXEC INSERTTOLEDGER2 
				@S_SESSIONID, 
				@@L2VNO, 
				'1', 
				'1', 
				'1', 
				'BROKER', 
				'BROKER'

		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END

	DELETE FROM 
		TEMPLEDGER2
	WHERE 
		SESSIONID =  @S_SESSIONID

	SELECT @@SQL = ""
	SELECT @@SQL = @@SQL + "UPDATE S "
	SELECT @@SQL = @@SQL + "SET "
	SELECT @@SQL = @@SQL + "	STATUS = 'A', "
	SELECT @@SQL = @@SQL + "	APPROVEDDT = GETDATE(), "
	SELECT @@SQL = @@SQL + "	HOPAYMODE = P.PAYMODE, "
	SELECT @@SQL = @@SQL + "	BANKCODE = P.BNKCODE, "
	SELECT @@SQL = @@SQL + "	VNO = P.VNO, "
	SELECT @@SQL = @@SQL + "	VDT = P.VDT, "
	SELECT @@SQL = @@SQL + "	EDT = P.EDT, "
	SELECT @@SQL = @@SQL + "	AMOUNTTOBEPAID = P.AMT, "
	SELECT @@SQL = @@SQL + "	REMARK = P.REMARK "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_SETTPAYOUT_ALL S, "
	SELECT @@SQL = @@SQL + "	V2_PAYOUT_TEMP P "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE = ACCODE "
	SELECT @@SQL = @@SQL + "	AND S.BRANCHCODE = BRCODE "
	SELECT @@SQL = @@SQL + "	AND GENFLAG = '" + @GENFLAG + "' "
	SELECT @@SQL = @@SQL + "	AND STATUS IN ('P', 'I') "
	SELECT @@SQL = @@SQL + "	AND P.SESSIONID = '" + @SESSIONID + "' "
	SELECT @@SQL = @@SQL + "	AND S.EXCHANGE = '" + @@EXCH + "' "
	SELECT @@SQL = @@SQL + "	AND S.SEGMENT = '" + @@SEG + "' "
	SELECT @@SQL = @@SQL + "	AND S.CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "INSERT INTO ACCOUNT.DBO.V2_PAYOUTCLIENT "
	SELECT @@SQL = @@SQL + "SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = '" + @SESSIONID + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_ALL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTYCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_NET "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTY_CODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_FOLEDBAL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "

	SELECT @@SQL = @@SQL + "DELETE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT "

	EXEC (@@SQL)

	SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
	UNION ALL
	SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	UNION ALL
	SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT '<HR>'
	UNION ALL
	SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '<BR><BR>~'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

	DELETE FROM 
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_PAYMENTUPLOAD
-- --------------------------------------------------

--v2_OFFLINE_PAYMENTUPLOAD 'OFFLINE',61,'NSE','CAPITAL','SEP  4 2008','N'

       
CREATE PROC [dbo].[V2_OFFLINE_PAYMENTUPLOAD](                            
                            
           @UNAME     VARCHAR(25),                            
           @USERCAT   INT,                            
           @EXCHANGE  VARCHAR(3),                            
           @SEGMENT   VARCHAR(10),                            
     @IP_VDATE varchar(11),          
           @RECOFLAG  CHAR(1) = 'N')                            
                            
AS                            
    
SET XACT_ABORT ON                            
/*                          
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                         
*/                          
                          
                          
  SET NOCOUNT ON                            
                              
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                            
  DECLARE  @@STD_DATE        VARCHAR(11),                            
           @@LST_DATE        VARCHAR(11),                            
           @@BRANCHFLAG       AS TINYINT,                            
           @@VNOFLAG          AS TINYINT,                            
           @@VNOMETHOD       INT,                            
           @@ACNAME          CHAR(100),                            
           @@BOOKTYPE        CHAR(2),                            
           @@MICRNO          VARCHAR(10),                            
           @@DRCR            VARCHAR(1),                            
           @@VTYP            SMALLINT,                            
           @@BANK_CODE       VARCHAR(100),                            
           @@BACKDAYS        INT,                            
           @@BACKDATE        VARCHAR(11),                            
           @@BRNCOUNT        TINYINT,                            
           @@MonthlyVdt      VARCHAR(11),                            
           @@SERIAL_NO       INT,                            
           @@COSTCODECOUNT   TINYINT,                            
           @@COSTCODEUPDATES CURSOR,                            
           @@NEWVNO           AS VARCHAR(12),                            
           @@MAXCOUNT         AS INT,                            
           @@VDT              AS VARCHAR(11),                            
           @@BANKBRANCH       AS VARCHAR(10),                            
           @@BANKCOST         AS NUMERIC,                            
           @@LNOCUR           AS CURSOR,                            
           @@VNOCUR           AS CURSOR,                            
           @@LNOVNO           AS VARCHAR(12),                            
           @@MAXVNO           AS INT,                            
           @@L2CUR            AS CURSOR,                            
           @@L2VNO            AS VARCHAR(12),                            
           @@ERROR_COUNT      AS BIGINT,                            
           @@FILEEXISTS       AS INT,                            
           @@SQL              AS VARCHAR(2000),                            
           @ERRORCODE         AS INT,                            
           @MESSAGE           AS VARCHAR(200) ,                    
   @@RECPAYTBLCOUNT BIGINT                    
                                                 
                            
 SET @@VTYP = 3                          
                          
       BEGIN TRAN                            
                            
  CREATE TABLE [#RECPAY_TABLE] (                            
    SNO    INT   IDENTITY ( 1,1 ),                            
    EDATE        VARCHAR(20),                            
    VOUCHER_DATE VARCHAR(20),                            
    CLIENT_CODE  VARCHAR(50),                            
    AMOUNT       MONEY,                            
    DRCR         VARCHAR(1),                            
    NARRATION    VARCHAR(234),                            
    BANK_CODE    VARCHAR(10),                            
  BANK_NAME    VARCHAR(100),                            
    REF_NO       VARCHAR(15),                            
    BRANCHCODE   VARCHAR(20),                            
    BRANCH_NAME  VARCHAR(50),                            
    CHQ_MODE     VARCHAR(1),                            
    CHQ_DATE     VARCHAR(20),                       
    CHQ_NAME     VARCHAR(100),                            
    CL_MODE      VARCHAR(1),                            
    FLD_AUTO     BIGINT,                     
    ENTEREDBY    VARCHAR(25),                            
    VDT          DATETIME   NULL,                            
    FYSTART      DATETIME   NULL,                      
    FYEND        DATETIME   NULL,                            
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                            
    EDT          DATETIME   NULL,                            
    DDDT         DATETIME   NULL,                            
    VNO          VARCHAR(12)   NULL,                            
    VTYP         SMALLINT   NULL,                            
    ACNAME       VARCHAR(100)   NULL,                            
    COSTCODE     SMALLINT   NULL,                            
    BANKCOST     SMALLINT   NULL,                            
    LNO          SMALLINT   NOT NULL DEFAULT (0),                            
    BANKNAME     VARCHAR(100)   NULL,                            
    MICRNO       INT   NULL,                            
    BOOKTYPE     VARCHAR(2)   NULL,                            
    ACC_NO       VARCHAR(16))                            
  ON [PRIMARY]                            
                              
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                            
  INSERT INTO #RECPAY_TABLE                            
             (EDATE,                            
              VOUCHER_DATE,                            
              CLIENT_CODE,                            
              AMOUNT,                            
              DRCR,                            
              NARRATION,                            
              BANK_CODE,                            
              BANK_NAME,                            
              REF_NO,                            
              BRANCHCODE,                            
              BRANCH_NAME,                            
              CHQ_MODE,                            
              CHQ_DATE,                            
              CHQ_NAME,                            
              CL_MODE,                            
              FLD_AUTO,                            
              ENTEREDBY,                            
              VDT,                             
              EDT,                             
              DDDT,                            
              ACC_NO,VTYP)                            
  SELECT CONVERT(VARCHAR,EDATE,103),                            
         CONVERT(VARCHAR,VDATE,103),                            
         CLTCODE,                            
         DEBITAMT,                            
         'C',                            
         NARRATION,                            
         OPPCODE,                            
         BANKNAME,                            
         DDNO,                            
         'ALL',                            
         BRANCHNAME,                            
         CHEQUEMODE,                            
         CONVERT(VARCHAR,CHEQUEDATE,103),                            
         CHEQUENAME,                            
         CLEAR_MODE,                            
         FLDAUTO,                            
         ADDBY,                             
         VDATE,                             
         EDATE,                             
         CHEQUEDATE,                             
         TPAccountNumber, VOUCHERTYPE                            
  FROM   ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                 
  WHERE  VOUCHERTYPE = 3                            
         AND EXCHANGE = @EXCHANGE                            
         AND SEGMENT = @SEGMENT                            
         AND ISNULL(ROWSTATE,0) = 0       
   AND ISNULL(APPROVALFLAG,0) = 1                      
   AND VDATE LIKE @IP_VDATE + '%'           
                            
                        
                      
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                    
                    
 IF @@RECPAYTBLCOUNT = 0                    
 BEGIN                    
  COMMIT                    
  RETURN                    
 END                    
             
              
              
--TRUNCATE table #RECPAY_TABLE              
--return                    
              
                 
  UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK)                             
  SET    ROWSTATE = 9                            
  FROM   #RECPAY_TABLE                            
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                  
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                            
  FROM   #RECPAY_TABLE                            
                                     
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                            
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                            
         @@BRANCHFLAG = BRANCHFLAG,                            
         @@VNOFLAG = VNOFLAG                            
  FROM   PARAMETER WITH(NOLOCK)                             
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                            
                                                              
  IF @@VNOFLAG <> 0                            
    BEGIN                            
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                            
      FROM   #RECPAY_TABLE                            
                                         
      IF @@ERROR_COUNT > 1                            
        BEGIN                            
     DROP TABLE #RECPAY_TABLE                                        
     ROLLBACK TRANSACTION                            
     SET @ERRORCODE = 1                                      
     SET @MESSAGE = 'PAYMENT FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                            
     EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                     
     RETURN                            
        END                            
    END                            
                            
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    BRANCHCODE = A.BRANCHCODE,                            
             FYSTART = P.SDTCUR,                            
           FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = C.COSTCODE,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
            COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = COSTNAME        
                                                            
      UPDATE #RECPAY_TABLE                            
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                  
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                            
                                                                         
      UPDATE #RECPAY_TABLE             
      SET    BRANCHCODE = 'HO',                            
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
             WHERE  COSTNAME = 'HO'),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
       PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                            
    END                            
  ELSE                       
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    FYSTART = @@STD_DATE,                            
             FYEND = @@LST_DATE + ' 23:59:59',                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                        
             AND B.CLTCODE = BANK_CODE                            
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
    END                            
                                
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                            
  SELECT @@ERROR_COUNT = COUNT(SNO)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                            
                            
  IF @@ERROR_COUNT > 0                      
    BEGIN                         
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                         
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                            
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
                                
  SET @@ERROR_COUNT = 0                            
                              
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT > EDT                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                          
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                     
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                   
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  AMOUNT <= 0                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                             
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                   
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                            
                          CLTCODE = RP.CLIENT_CODE                            
   FROM   #RECPAY_TABLE RP,    
                 LEDGER L WITH(NOLOCK),                            
                 LEDGER1 L1 WITH(NOLOCK)                            
          WHERE  L1.DDNO = RP.REF_NO                            
                 AND L1.DD = RP.CHQ_MODE                            
                 AND L1.DRCR = @@DRCR                  
                 AND L1.VTYP = @@VTYP                            
                 AND RP.REF_NO <> 0                            
                 AND L.VTYP = @@VTYP                            
                 AND L.VNO = L1.VNO                            
                 AND L.BOOKTYPE = L1.BOOKTYPE                            
                 AND L.DRCR = @@DRCR                            
                 AND L.CLTCODE = RP.CLIENT_CODE) A                            
                              
  IF @@ERROR_COUNT > 0        
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                  
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT CLIENT_CODE                            
          FROM   #RECPAY_TABLE                            
          WHERE  UPDFLAG = 'N') A                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                   
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                       
    END                            
                        
  /*    ----------AUTO GENERATION OF VNO -------- */                            
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                            
         BOOKTYPE                            
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                            
                              
  OPEN @@VNOCUR                            
                              
  FETCH NEXT FROM @@VNOCUR                            
  INTO @@BANK_CODE,                            
       @@BOOKTYPE                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      IF @@BRANCHFLAG = 1                            
        BEGIN                            
          SELECT @@BANKBRANCH = BRANCHCODE,                            
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                            
          FROM   ACMAST A WITH(NOLOCK)                            
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                            
                   ON (A.BRANCHCODE = C.COSTNAME)                            
          WHERE  A.CLTCODE = @@BANK_CODE                            
                                      
          IF @@BANKBRANCH <> 'ALL'                            
            BEGIN                            
              UPDATE RP                            
              SET    COSTCODE = @@BANKCOST                            
              FROM   #RECPAY_TABLE RP,                            
                     ACMAST A WITH(NOLOCK)                            
              WHERE  A.CLTCODE = RP.CLIENT_CODE                            
                     AND A.BRANCHCODE = 'ALL'                            
                                          
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = @@BANKCOST                            
              WHERE  BANK_CODE = @@BANK_CODE                            
            END                            
          ELSE                            
            BEGIN                            
              UPDATE #RECPAY_TABLE                            
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                            
                                 FROM   COSTMAST WITH(NOLOCK)                            
                                 WHERE  COSTNAME = 'HO')                            
              WHERE  COSTCODE = ''                            
                     AND BANK_CODE = @@BANK_CODE                            
                                          
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                        
                                                          COUNT(DISTINCT COSTCODE)                            
                                                 FROM     #RECPAY_TABLE                             
                                                 WHERE    BANK_CODE = @@BANK_CODE                            
                                                 GROUP BY SNO                            
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                            
                                          
              OPEN @@COSTCODEUPDATES                            
                                          
              FETCH NEXT FROM @@COSTCODEUPDATES                            
              INTO @@SERIAL_NO,                            
                   @@COSTCODECOUNT                            
                            
              WHILE @@FETCH_STATUS = 0                            
                BEGIN                            
                  UPDATE #RECPAY_TABLE                            
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                            
                                  FROM   COSTMAST WITH(NOLOCK)                            
                                     WHERE  COSTNAME = 'HO')                            
                  WHERE  (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                            
                         AND BANK_CODE = @@BANK_CODE                            
                         AND SNO = @@SERIAL_NO                            
                                              
                  FETCH NEXT FROM @@COSTCODEUPDATES                            
                  INTO @@SERIAL_NO,                            
         @@COSTCODECOUNT                            
                END                            
                                          
              CLOSE @@COSTCODEUPDATES                            
                                          
              DEALLOCATE @@COSTCODEUPDATES                            
                                          
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = COSTCODE                            
              WHERE  BANK_CODE = @@BANK_CODE                            
                     AND (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                           
END                            
        END                            
                                  
      CREATE TABLE #BANK_VNO (                            
        SRNO    INT,                            
        NEWSRNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #BANK_VNO                            
      SELECT DISTINCT SNO                            
      FROM   #RECPAY_TABLE       
      WHERE  BANK_CODE = @@BANK_CODE                            
             AND BOOKTYPE = @@BOOKTYPE                            
                                                        
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                            
      FROM   #RECPAY_TABLE                            
                                         
      SELECT TOP 1 @@VDT = VDT                            
      FROM   #RECPAY_TABLE                            
                                  
      SELECT LASTVNO                            
      INTO   #VNO                            
      FROM   LASTVNO WITH(NOLOCK)                            
      WHERE  1 = 2                            
                                  
      SELECT @@MAXVNO = MAX(NEWSRNO)                            
      FROM   #BANK_VNO                            
                           
                          
              
              
      INSERT INTO #VNO                            
      EXEC ACC_GENVNO_NEW                            
        @@VDT ,                            
    @@VTYP ,                            
 @@BOOKTYPE ,                            
       @@STD_DATE ,                            
        @@LST_DATE ,                            
        @@MAXVNO                            
                                  
      SELECT @@NEWVNO = LASTVNO                            
      FROM   #VNO                            
                                  
      UPDATE RP                            
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                            
      FROM   #RECPAY_TABLE RP,                            
             #BANK_VNO BV                            
      WHERE  RP.SNO = BV.SRNO                            
                                  
               
              
      DROP TABLE #VNO                            
                                  
      DROP TABLE #BANK_VNO                            
                                  
      FETCH NEXT FROM @@VNOCUR                            
      INTO @@BANK_CODE,                            
           @@BOOKTYPE                            
    END                       
                              
  /*   ----------AUTO GENERATION OF LNO -------- */                            
  UPDATE #RECPAY_TABLE                            
 SET    LNO = 2                            
  WHERE  VNO IN (SELECT   VNO                            
                 FROM     #RECPAY_TABLE                             
                 GROUP BY VNO                            
                 HAVING   COUNT(*) = 1)                            
                
              
              
                            
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                            
                            FROM     #RECPAY_TABLE                             
                            GROUP BY VNO                            
                            HAVING   COUNT(*) > 1                            
                              
  OPEN @@LNOCUR                            
                              
  FETCH NEXT FROM @@LNOCUR                            
  INTO @@LNOVNO                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      CREATE TABLE [#LNOGEN] (                            
        VNO VARCHAR(12),                            
        SNO INT,                            
        LNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #LNOGEN                            
      SELECT   VNO, SNO                            
      FROM     #RECPAY_TABLE WITH (NOLOCK)                            
      WHERE    VNO = @@LNOVNO                            
      ORDER BY SNO                            
                                  
      UPDATE #RECPAY_TABLE                            
      SET    LNO = L.LNO + 1                        
      FROM   #LNOGEN L                            
      WHERE  #RECPAY_TABLE.VNO = L.VNO                            
             AND #RECPAY_TABLE.SNO = L.SNO                            
             AND #RECPAY_TABLE.LNO = 0                            
                                  
      DROP TABLE #LNOGEN                            
                                  
      FETCH NEXT FROM @@LNOCUR                            
      INTO @@LNOVNO                            
    END                            
                              
  CLOSE @@LNOCUR                            
                              
  DEALLOCATE @@LNOCUR                            
                              
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                            
  INSERT INTO LEDGER1                            
             (BNKNAME,                            
              BRNNAME,                            
              DD,                            
     DDNO,                            
              DDDT,                            
              RELDT,                            
              RELAMT,                            
              REFNO,                            
              RECEIPTNO,                            
   VTYP,                            
              VNO,                            
              LNO,                            
     DRCR,                            
              BOOKTYPE,                            
              MICRNO,                            
              SLIPNO,                            
              SLIPDATE,                            
              CHEQUEINNAME,                            
              CHQPRINTED,                            
              CLEAR_MODE)                            
  SELECT   BNKNAME = MAX(BANK_NAME),                            
           BRNNAME = MAX(BRANCH_NAME),                            
           DD = MAX(CHQ_MODE),                            
           DDNO = MAX(REF_NO),                            
           DDDT = MAX(DDDT),                          
           RELDT = '',                            
           RELAMT = SUM(AMOUNT),                            
           REFNO = 0,                            
           RECEIPTNO = 0,                            
           VTYP,                            
           VNO,                            
           LNO = 2,                            
           DRCR,                            
           BOOKTYPE = BOOKTYPE,                           
           MICRNO = MICRNO,                            
           SLIPNO = 0,                            
           SLIPDATE = '',                            
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                            
           CHQPRINTED = 0,                            
           CLEAR_MODE = MAX(CL_MODE)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                            
           MICRNO                            
                               
  IF @@ERROR <> 0                            
    BEGIN                              
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                    
    END                            
                                
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                            
  CREATE TABLE #LEDGER (                            
    VTYP      SMALLINT,                            
    VNO       VARCHAR(12),                            
    EDT       DATETIME,                            
    LNO       SMALLINT,                          
    ACNAME    VARCHAR(100),                            
    DRCR      VARCHAR(1),                            
    VAMT      MONEY,                            
    VDT       DATETIME,                            
    VNO1      VARCHAR(12),                            
    REFNO     CHAR(12),                            
    BALAMT    MONEY,                            
    NODAYS    INT,                            
    CDT       DATETIME,                            
    CLTCODE   VARCHAR(10),                            
    BOOKTYPE  VARCHAR(2),                            
    ENTEREDBY VARCHAR(25),                            
    PDT       DATETIME,                            
    CHECKEDBY VARCHAR(25),                            
    ACTNODAYS INT,                            
    NARRATION VARCHAR(234))                                
                              
  CREATE TABLE #LEDGER3 (                            
    NARATNO  INT,                            
    NARR     VARCHAR(234),                            
    REFNO    CHAR(12),                            
    VTYP     SMALLINT,                            
    VNO      VARCHAR(12),                            
    BOOKTYPE VARCHAR(2))                            
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER                      
             (VTYP,                            
              VNO,                           
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                           
      VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                            
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT VTYP,                            
         VNO,                            
         EDT = (CASE                             
                  WHEN VTYP = 3                            
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
                  ELSE EDT                            
                END),                        
         LNO,                            
         ACNAME,                            
         DRCR,                            
         VAMT = AMOUNT,                            
         VDT,                            
         VNO1 = VNO,                            
         REFNO = 0,                            
         BALAMT = AMOUNT,                            
         NODAYS = 0,                            
         CDT = GETDATE(),                            
         CLTCODE = CLIENT_CODE,                            
         BOOKTYPE = BOOKTYPE,                            
         ENTEREDBY = ENTEREDBY,                            
         PDT = GETDATE(),                            
         CHECKEDBY = @UNAME,                            
         ACTNODAYS = 0,                            
         NARRATION                            
  FROM   #RECPAY_TABLE                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER                            
  SELECT   VTYP,                            
           VNO,                            
           EDT = (CASE                             
                    WHEN VTYP = 3                            
                         AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
                    ELSE EDT                            
                  END),                            
           LNO = 1,                            
           BANKNAME,                            
           DRCR = (CASE                             
                     WHEN DRCR = 'D' THEN 'C'                            
                     ELSE 'D'                
                   END),                            
           VAMT = SUM(AMOUNT),                            
           VDT,                            
           VNO1 = VNO,                            
           REFNO = 0,                            
           BALAMT = SUM(AMOUNT),                            
           NODAYS = 0,                            
CDT = GETDATE(),                            
           CLTCODE = BANK_CODE,                            
           BOOKTYPE = BOOKTYPE,                            
           ENTEREDBY = ENTEREDBY,                            
           PDT = GETDATE(),                            
           CHECKEDBY = @UNAME,                            
           ACTNODAYS = 0,                            
           NARRATION = MAX(NARRATION)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,EDT,DRCR,                            
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                            
           ENTEREDBY                            
                              
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER                            
             (VTYP,                            
              VNO,                            
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                            
              VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                           
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT   VTYP,                            
           VNO,                            
       EDT,                            
           LNO,                            
           ACNAME,                            
           DRCR,                            
           VAMT,                            
           VDT,                            
           VNO1,                            
           REFNO,                            
           BALAMT,                            
           NODAYS,                            
           CDT,                            
           CLTCODE,           
           BOOKTYPE,                            
           ENTEREDBY,                            
           PDT,                            
           CHECKEDBY,                            
           ACTNODAYS,                            
           NARRATION                            
  FROM     #LEDGER                            
  ORDER BY BOOKTYPE,                            
           VTYP,                            
           VNO,                            
           LNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                  
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  DROP TABLE #LEDGER                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT   NARATNO = 1,                            
           NARRATION = MAX(NARRATION),                            
           REFNO = 0,                            
           VTYP,                            
           VNO,                            
           BOOKTYPE                            
  FROM     #RECPAY_TABLE              
  GROUP BY VTYP,VNO,BOOKTYPE                     
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT NARATNO = LNO,                            
         NARR = NARRATION,                            
         REFNO = 0,                            
         VTYP,                            
         VNO,                            
         BOOKTYPE                            
  FROM   #RECPAY_TABLE                            
                                     
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER3                            
  SELECT   *                            
  FROM     #LEDGER3                            
  ORDER BY BOOKTYPE,                            
    VTYP,                            
           VNO,                            
           NARATNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  DROP TABLE #LEDGER3                            
                              
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                            
              FROM     #RECPAY_TABLE                            
                               ORDER BY VNO                            
                                  
      OPEN @@L2CUR                            
                                  
      FETCH NEXT FROM @@L2CUR                            
      INTO @@L2VNO                            
                                  
      WHILE @@FETCH_STATUS = 0                            
        BEGIN                            
          DELETE FROM TEMPLEDGER2                            
          WHERE       SESSIONID = '9999999999'                            
                                      
/*======CLIENT SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT 'BRANCH',                            
                 C.COSTNAME,                            
                 AMOUNT,                            
                 VTYP,                            
                 VNO,                            
                 LNO,                            
                 DRCR,                            
                 '0',                            
    BOOKTYPE,                            
                 '9999999999',                            
                 CLIENT_CODE,                            
'A',                            
                 '0'                            
          FROM   #RECPAY_TABLE RP,                            
                 COSTMAST C WITH(NOLOCK)                             
          WHERE  RP.COSTCODE = C.COSTCODE                            
                 AND VNO = @@L2VNO                            
                                      
/*======BANK SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT   'BRANCH',                            
                   C.COSTNAME,                            
                   SUM(AMOUNT),                            
                   VTYP,                            
                   VNO,                        
                   LNO = 1,                            
                   DRCR = (CASE                             
                             WHEN DRCR = 'D' THEN 'C'                            
                             ELSE 'D'                            
                           END),                            
                   '0',                            
                   BOOKTYPE,                            
                   '9999999999',                            
                   BANK_CODE,                            
                   'A',                            
                   '0'                            
          FROM     #RECPAY_TABLE RP,                            
                   COSTMAST C WITH(NOLOCK)                            
          WHERE    RP.BANKCOST = C.COSTCODE                            
                   AND VNO = @@L2VNO                            
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                             
                   WHEN DRCR = 'D' THEN 'C'                            
                      ELSE 'D'                            
                    END),                            
                   BANK_CODE,BOOKTYPE                            
                                      
          EXEC INSERTTOLEDGER2                            
            '9999999999' ,                            
            @@L2VNO ,                            
            '1' ,                            
            '1' ,                            
            '1' ,                            
            'BROKER' ,                            
            'BROKER'                            
                                      
 FETCH NEXT FROM @@L2CUR                            
          INTO @@L2VNO                            
        END                            
                                  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                            
      WHERE       SESSIONID = '9999999999'                            
                            
      IF EXISTS (SELECT *                            
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                             
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                            
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                             
         AND @@VTYP = 3                            
        BEGIN                            
          INSERT INTO THIRDPARTY_COLLECTION                            
(VNO,                            
                      VTYP,                            
                      BOOKTYPE,                            
                      CLTCODE,                            
                      AMOUNT,                            
                      VDT,                            
                      DDNO,                            
 ACCOUNT_NO,                            
                      TPR_FLAG)                            
          SELECT   VNO,                            
                   VTYP,                   
                   BOOKTYPE,                            
                   CLIENT_CODE,                            
                   AMOUNT,                            
                   VDT,                            
                   MAX(REF_NO),                            
                   ACC_NO,                            
                   TPR_FLAG = 'S'                            
          FROM     #RECPAY_TABLE                            
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                            
                   AMOUNT,VDT,ACC_NO                            
                                               
          UPDATE T                            
          SET    TPR_FLAG = 'C'                            
          FROM                     
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                            
                 MULTIBANKID M WITH(NOLOCK),                            
                 #RECPAY_TABLE R                            
          WHERE  T.CLTCODE = M.CLTCODE                            
                 AND M.ACCNO = T.ACCOUNT_NO                            
                 AND T.VNO = R.VNO                            
                 AND T.VTYP = R.VTYP                            
                 AND T.BOOKTYPE = R.BOOKTYPE                            
        END                            
                              
   COMMIT TRAN                            
 END                            
                                
UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK)                             
SET                      
 ROWSTATE = 1,                          
 APPROVALFLAG = 1,                          
 APPROVALDATE = GETDATE(),                          
 APPROVEDBY = 'SYSTEM',                          
 LEDGERVNO = VNO,
 UPLOADDT = GETDATE()                        
FROM   #RECPAY_TABLE            
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                            
                                  
                              
DROP TABLE #RECPAY_TABLE       
SET @ERRORCODE = 0                                     
SET @MESSAGE = 'PAYMENT POSTED SUCCESSFULLY'                    
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME     
    
    
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_PAYMENTUPLOAD_bkp)1Oct2017
-- --------------------------------------------------

--v2_OFFLINE_PAYMENTUPLOAD 'OFFLINE',61,'NSE','CAPITAL','SEP  4 2008','N'

       
CREATE PROC [dbo].[V2_OFFLINE_PAYMENTUPLOAD_bkp)1Oct2017](                            
                            
           @UNAME     VARCHAR(25),                            
           @USERCAT   INT,                            
           @EXCHANGE  VARCHAR(3),                            
           @SEGMENT   VARCHAR(10),                            
     @IP_VDATE varchar(11),          
           @RECOFLAG  CHAR(1) = 'N')                            
                            
AS                            
    
SET XACT_ABORT ON                            
/*                          
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                         
*/                          
                          
                          
  SET NOCOUNT ON                            
                              
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                            
  DECLARE  @@STD_DATE        VARCHAR(11),                            
           @@LST_DATE        VARCHAR(11),                            
           @@BRANCHFLAG       AS TINYINT,                            
           @@VNOFLAG          AS TINYINT,                            
           @@VNOMETHOD       INT,                            
           @@ACNAME          CHAR(100),                            
           @@BOOKTYPE        CHAR(2),                            
           @@MICRNO          VARCHAR(10),                            
           @@DRCR            VARCHAR(1),                            
           @@VTYP            SMALLINT,                            
           @@BANK_CODE       VARCHAR(100),                            
           @@BACKDAYS        INT,                            
           @@BACKDATE        VARCHAR(11),                            
           @@BRNCOUNT        TINYINT,                            
           @@MonthlyVdt      VARCHAR(11),                            
           @@SERIAL_NO       INT,                            
           @@COSTCODECOUNT   TINYINT,                            
           @@COSTCODEUPDATES CURSOR,                            
           @@NEWVNO           AS VARCHAR(12),                            
           @@MAXCOUNT         AS INT,                            
           @@VDT              AS VARCHAR(11),                            
           @@BANKBRANCH       AS VARCHAR(10),                            
           @@BANKCOST         AS NUMERIC,                            
           @@LNOCUR           AS CURSOR,                            
           @@VNOCUR           AS CURSOR,                            
           @@LNOVNO           AS VARCHAR(12),                            
           @@MAXVNO           AS INT,                            
           @@L2CUR            AS CURSOR,                            
           @@L2VNO            AS VARCHAR(12),                            
           @@ERROR_COUNT      AS BIGINT,                            
           @@FILEEXISTS       AS INT,                            
           @@SQL              AS VARCHAR(2000),                            
           @ERRORCODE         AS INT,                            
           @MESSAGE           AS VARCHAR(200) ,                    
   @@RECPAYTBLCOUNT BIGINT                    
                                                 
                            
 SET @@VTYP = 3                          
                          
       BEGIN TRAN                            
                            
  CREATE TABLE [#RECPAY_TABLE] (                            
    SNO    INT   IDENTITY ( 1,1 ),                            
    EDATE        VARCHAR(20),                            
    VOUCHER_DATE VARCHAR(20),                            
    CLIENT_CODE  VARCHAR(50),                            
    AMOUNT       MONEY,                            
    DRCR         VARCHAR(1),                            
    NARRATION    VARCHAR(234),                            
    BANK_CODE    VARCHAR(10),                            
  BANK_NAME    VARCHAR(100),                            
    REF_NO       VARCHAR(15),                            
    BRANCHCODE   VARCHAR(20),                            
    BRANCH_NAME  VARCHAR(50),                            
    CHQ_MODE     VARCHAR(1),                            
    CHQ_DATE     VARCHAR(20),                       
    CHQ_NAME     VARCHAR(100),                            
    CL_MODE      VARCHAR(1),                            
    FLD_AUTO     BIGINT,                     
    ENTEREDBY    VARCHAR(25),                            
    VDT          DATETIME   NULL,                            
    FYSTART      DATETIME   NULL,                      
    FYEND        DATETIME   NULL,                            
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                            
    EDT          DATETIME   NULL,                            
    DDDT         DATETIME   NULL,                            
    VNO          VARCHAR(12)   NULL,                            
    VTYP         SMALLINT   NULL,                            
    ACNAME       VARCHAR(100)   NULL,                            
    COSTCODE     SMALLINT   NULL,                            
    BANKCOST     SMALLINT   NULL,                            
    LNO          SMALLINT   NOT NULL DEFAULT (0),                            
    BANKNAME     VARCHAR(100)   NULL,                            
    MICRNO       INT   NULL,                            
    BOOKTYPE     VARCHAR(2)   NULL,                            
    ACC_NO       VARCHAR(16))                            
  ON [PRIMARY]                            
                              
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                            
  INSERT INTO #RECPAY_TABLE                            
             (EDATE,                            
              VOUCHER_DATE,                            
              CLIENT_CODE,                            
              AMOUNT,                            
              DRCR,                            
              NARRATION,                            
              BANK_CODE,                            
              BANK_NAME,                            
              REF_NO,                            
              BRANCHCODE,                            
              BRANCH_NAME,                            
              CHQ_MODE,                            
              CHQ_DATE,                            
              CHQ_NAME,                            
              CL_MODE,                            
              FLD_AUTO,                            
              ENTEREDBY,                            
              VDT,                             
              EDT,                             
              DDDT,                            
              ACC_NO,VTYP)                            
  SELECT CONVERT(VARCHAR,EDATE,103),                            
         CONVERT(VARCHAR,VDATE,103),                            
         CLTCODE,                            
         DEBITAMT,                            
         'C',                            
         NARRATION,                            
         OPPCODE,                            
         BANKNAME,                            
         DDNO,                            
         'ALL',                            
         BRANCHNAME,                            
         CHEQUEMODE,                            
         CONVERT(VARCHAR,CHEQUEDATE,103),                            
         CHEQUENAME,                            
         CLEAR_MODE,                            
         FLDAUTO,                            
         ADDBY,                             
         VDATE,                             
         EDATE,                             
         CHEQUEDATE,                             
         TPAccountNumber, VOUCHERTYPE                            
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                 
  WHERE  VOUCHERTYPE = 3                            
         AND EXCHANGE = @EXCHANGE                            
         AND SEGMENT = @SEGMENT                            
         AND ISNULL(ROWSTATE,0) = 0       
   AND ISNULL(APPROVALFLAG,0) = 1                      
   AND VDATE LIKE @IP_VDATE + '%'           
                            
                        
                      
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                    
                    
 IF @@RECPAYTBLCOUNT = 0                    
 BEGIN                    
  COMMIT                    
  RETURN                    
 END                    
             
              
              
--TRUNCATE table #RECPAY_TABLE              
--return                    
              
                 
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK)                             
  SET    ROWSTATE = 9                            
  FROM   #RECPAY_TABLE                            
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                  
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                            
  FROM   #RECPAY_TABLE                            
                                     
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                            
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                            
         @@BRANCHFLAG = BRANCHFLAG,                            
         @@VNOFLAG = VNOFLAG                            
  FROM   PARAMETER WITH(NOLOCK)                             
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                            
                                                              
  IF @@VNOFLAG <> 0                            
    BEGIN                            
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                            
      FROM   #RECPAY_TABLE                            
                                         
      IF @@ERROR_COUNT > 1                            
        BEGIN                            
     DROP TABLE #RECPAY_TABLE                                        
     ROLLBACK TRANSACTION                            
     SET @ERRORCODE = 1                                      
     SET @MESSAGE = 'PAYMENT FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                            
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                     
     RETURN                            
        END                            
    END                            
                            
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    BRANCHCODE = A.BRANCHCODE,                            
             FYSTART = P.SDTCUR,                            
           FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = C.COSTCODE,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
            COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = COSTNAME        
                                                            
      UPDATE #RECPAY_TABLE                            
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                  
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                            
                                                                         
      UPDATE #RECPAY_TABLE             
      SET    BRANCHCODE = 'HO',                            
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
             WHERE  COSTNAME = 'HO'),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
       PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                            
    END                            
  ELSE                       
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    FYSTART = @@STD_DATE,                            
             FYEND = @@LST_DATE + ' 23:59:59',                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                        
             AND B.CLTCODE = BANK_CODE                            
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
    END                            
                                
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                            
  SELECT @@ERROR_COUNT = COUNT(SNO)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                            
                            
  IF @@ERROR_COUNT > 0                      
    BEGIN                         
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                         
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
                                
  SET @@ERROR_COUNT = 0                            
                              
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT > EDT                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                          
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                     
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  AMOUNT <= 0                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                             
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                            
                          CLTCODE = RP.CLIENT_CODE                            
   FROM   #RECPAY_TABLE RP,    
                 LEDGER L WITH(NOLOCK),                            
                 LEDGER1 L1 WITH(NOLOCK)                            
          WHERE  L1.DDNO = RP.REF_NO                            
                 AND L1.DD = RP.CHQ_MODE                            
                 AND L1.DRCR = @@DRCR                  
                 AND L1.VTYP = @@VTYP                            
                 AND RP.REF_NO <> 0                            
                 AND L.VTYP = @@VTYP                            
                 AND L.VNO = L1.VNO                            
                 AND L.BOOKTYPE = L1.BOOKTYPE                            
                 AND L.DRCR = @@DRCR                            
                 AND L.CLTCODE = RP.CLIENT_CODE) A                            
                              
  IF @@ERROR_COUNT > 0        
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                  
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT CLIENT_CODE                            
          FROM   #RECPAY_TABLE                            
          WHERE  UPDFLAG = 'N') A                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                       
    END                            
                        
  /*    ----------AUTO GENERATION OF VNO -------- */                            
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                            
         BOOKTYPE                            
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                            
                              
  OPEN @@VNOCUR                            
                              
  FETCH NEXT FROM @@VNOCUR                            
  INTO @@BANK_CODE,                            
       @@BOOKTYPE                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      IF @@BRANCHFLAG = 1                            
        BEGIN                            
          SELECT @@BANKBRANCH = BRANCHCODE,                            
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                            
          FROM   ACMAST A WITH(NOLOCK)                            
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                            
                   ON (A.BRANCHCODE = C.COSTNAME)                            
          WHERE  A.CLTCODE = @@BANK_CODE                            
                                      
          IF @@BANKBRANCH <> 'ALL'                            
            BEGIN                            
              UPDATE RP                            
              SET    COSTCODE = @@BANKCOST                            
              FROM   #RECPAY_TABLE RP,                            
                     ACMAST A WITH(NOLOCK)                            
              WHERE  A.CLTCODE = RP.CLIENT_CODE                            
                     AND A.BRANCHCODE = 'ALL'                            
                                          
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = @@BANKCOST                            
              WHERE  BANK_CODE = @@BANK_CODE                            
            END                            
          ELSE                            
            BEGIN                            
              UPDATE #RECPAY_TABLE                            
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                            
                                 FROM   COSTMAST WITH(NOLOCK)                            
                                 WHERE  COSTNAME = 'HO')                            
              WHERE  COSTCODE = ''                            
                     AND BANK_CODE = @@BANK_CODE                            
                                          
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                        
                                                          COUNT(DISTINCT COSTCODE)                            
                                                 FROM     #RECPAY_TABLE                             
                                                 WHERE    BANK_CODE = @@BANK_CODE                            
                                                 GROUP BY SNO                            
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                            
                                          
              OPEN @@COSTCODEUPDATES                            
                                          
              FETCH NEXT FROM @@COSTCODEUPDATES                            
              INTO @@SERIAL_NO,                            
                   @@COSTCODECOUNT                            
                            
              WHILE @@FETCH_STATUS = 0                            
                BEGIN                            
                  UPDATE #RECPAY_TABLE                            
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                            
                                  FROM   COSTMAST WITH(NOLOCK)                            
                                     WHERE  COSTNAME = 'HO')                            
                  WHERE  (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                            
                         AND BANK_CODE = @@BANK_CODE                            
                         AND SNO = @@SERIAL_NO                            
                                              
                  FETCH NEXT FROM @@COSTCODEUPDATES                            
                  INTO @@SERIAL_NO,                            
         @@COSTCODECOUNT                            
                END                            
                                          
              CLOSE @@COSTCODEUPDATES                            
                                          
              DEALLOCATE @@COSTCODEUPDATES                            
                                          
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = COSTCODE                            
              WHERE  BANK_CODE = @@BANK_CODE                            
                     AND (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                           
END                            
        END                            
                                  
      CREATE TABLE #BANK_VNO (                            
        SRNO    INT,                            
        NEWSRNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #BANK_VNO                            
      SELECT DISTINCT SNO                            
      FROM   #RECPAY_TABLE       
      WHERE  BANK_CODE = @@BANK_CODE                            
             AND BOOKTYPE = @@BOOKTYPE                            
                                                        
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                            
      FROM   #RECPAY_TABLE                            
                                         
      SELECT TOP 1 @@VDT = VDT                            
      FROM   #RECPAY_TABLE                            
                                  
      SELECT LASTVNO                            
      INTO   #VNO                            
      FROM   LASTVNO WITH(NOLOCK)                            
      WHERE  1 = 2                            
                                  
      SELECT @@MAXVNO = MAX(NEWSRNO)                            
      FROM   #BANK_VNO                            
                           
                          
              
              
      INSERT INTO #VNO                            
      EXEC ACC_GENVNO_NEW                            
        @@VDT ,                            
    @@VTYP ,                            
 @@BOOKTYPE ,                            
       @@STD_DATE ,                            
        @@LST_DATE ,                            
        @@MAXVNO                            
                                  
      SELECT @@NEWVNO = LASTVNO                            
      FROM   #VNO                            
                                  
      UPDATE RP                            
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                            
      FROM   #RECPAY_TABLE RP,                            
             #BANK_VNO BV                            
      WHERE  RP.SNO = BV.SRNO                            
                                  
               
              
      DROP TABLE #VNO                            
                                  
      DROP TABLE #BANK_VNO                            
                                  
      FETCH NEXT FROM @@VNOCUR                            
      INTO @@BANK_CODE,                            
           @@BOOKTYPE                            
    END                       
                              
  /*   ----------AUTO GENERATION OF LNO -------- */                            
  UPDATE #RECPAY_TABLE                            
 SET    LNO = 2                            
  WHERE  VNO IN (SELECT   VNO                            
                 FROM     #RECPAY_TABLE                             
                 GROUP BY VNO                            
                 HAVING   COUNT(*) = 1)                            
                
              
              
                            
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                            
                            FROM     #RECPAY_TABLE                             
                            GROUP BY VNO                            
                            HAVING   COUNT(*) > 1                            
                              
  OPEN @@LNOCUR                            
                              
  FETCH NEXT FROM @@LNOCUR                            
  INTO @@LNOVNO                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      CREATE TABLE [#LNOGEN] (                            
        VNO VARCHAR(12),                            
        SNO INT,                            
        LNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #LNOGEN                            
      SELECT   VNO, SNO                            
      FROM     #RECPAY_TABLE WITH (NOLOCK)                            
      WHERE    VNO = @@LNOVNO                            
      ORDER BY SNO                            
                                  
      UPDATE #RECPAY_TABLE                            
      SET    LNO = L.LNO + 1                        
      FROM   #LNOGEN L                            
      WHERE  #RECPAY_TABLE.VNO = L.VNO                            
             AND #RECPAY_TABLE.SNO = L.SNO                            
             AND #RECPAY_TABLE.LNO = 0                            
                                  
      DROP TABLE #LNOGEN                            
                                  
      FETCH NEXT FROM @@LNOCUR                            
      INTO @@LNOVNO                            
    END                            
                              
  CLOSE @@LNOCUR                            
                              
  DEALLOCATE @@LNOCUR                            
                              
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                            
  INSERT INTO LEDGER1                            
             (BNKNAME,                            
              BRNNAME,                            
              DD,                            
     DDNO,                            
              DDDT,                            
              RELDT,                            
              RELAMT,                            
              REFNO,                            
              RECEIPTNO,                            
   VTYP,                            
              VNO,                            
              LNO,                            
     DRCR,                            
              BOOKTYPE,                            
              MICRNO,                            
              SLIPNO,                            
              SLIPDATE,                            
              CHEQUEINNAME,                            
              CHQPRINTED,                            
              CLEAR_MODE)                            
  SELECT   BNKNAME = MAX(BANK_NAME),                            
           BRNNAME = MAX(BRANCH_NAME),                            
           DD = MAX(CHQ_MODE),                            
           DDNO = MAX(REF_NO),                            
           DDDT = MAX(DDDT),                          
           RELDT = '',                            
           RELAMT = SUM(AMOUNT),                            
           REFNO = 0,                            
           RECEIPTNO = 0,                            
           VTYP,                            
           VNO,                            
           LNO = 2,                            
           DRCR,                            
           BOOKTYPE = BOOKTYPE,                           
           MICRNO = MICRNO,                            
           SLIPNO = 0,                            
           SLIPDATE = '',                            
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                            
           CHQPRINTED = 0,                            
           CLEAR_MODE = MAX(CL_MODE)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                            
           MICRNO                            
                               
  IF @@ERROR <> 0                            
    BEGIN                              
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                    
    END                            
                                
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                            
  CREATE TABLE #LEDGER (                            
    VTYP      SMALLINT,                            
    VNO       VARCHAR(12),                            
    EDT       DATETIME,                            
    LNO       SMALLINT,                          
    ACNAME    VARCHAR(100),                            
    DRCR      VARCHAR(1),                            
    VAMT      MONEY,                            
    VDT       DATETIME,                            
    VNO1      VARCHAR(12),                            
    REFNO     CHAR(12),                            
    BALAMT    MONEY,                            
    NODAYS    INT,                            
    CDT       DATETIME,                            
    CLTCODE   VARCHAR(10),                            
    BOOKTYPE  VARCHAR(2),                            
    ENTEREDBY VARCHAR(25),                            
    PDT       DATETIME,                            
    CHECKEDBY VARCHAR(25),                            
    ACTNODAYS INT,                            
    NARRATION VARCHAR(234))                                
                              
  CREATE TABLE #LEDGER3 (                            
    NARATNO  INT,                            
    NARR     VARCHAR(234),                            
    REFNO    CHAR(12),                            
    VTYP     SMALLINT,                            
    VNO      VARCHAR(12),                            
    BOOKTYPE VARCHAR(2))                            
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER                      
             (VTYP,                            
              VNO,                           
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                           
      VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                            
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT VTYP,                            
         VNO,                            
         EDT = (CASE                             
                  WHEN VTYP = 3                            
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
                  ELSE EDT                            
                END),                        
         LNO,                            
         ACNAME,                            
         DRCR,                            
         VAMT = AMOUNT,                            
         VDT,                            
         VNO1 = VNO,                            
         REFNO = 0,                            
         BALAMT = AMOUNT,                            
         NODAYS = 0,                            
         CDT = GETDATE(),                            
         CLTCODE = CLIENT_CODE,                            
         BOOKTYPE = BOOKTYPE,                            
         ENTEREDBY = ENTEREDBY,                            
         PDT = GETDATE(),                            
         CHECKEDBY = @UNAME,                            
         ACTNODAYS = 0,                            
         NARRATION                            
  FROM   #RECPAY_TABLE                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER                            
  SELECT   VTYP,                            
           VNO,                            
           EDT = (CASE                             
                    WHEN VTYP = 3                            
                         AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
                    ELSE EDT                            
                  END),                            
           LNO = 1,                            
           BANKNAME,                            
           DRCR = (CASE                             
                     WHEN DRCR = 'D' THEN 'C'                            
                     ELSE 'D'                
                   END),                            
           VAMT = SUM(AMOUNT),                            
           VDT,                            
           VNO1 = VNO,                            
           REFNO = 0,                            
           BALAMT = SUM(AMOUNT),                            
           NODAYS = 0,                            
CDT = GETDATE(),                            
           CLTCODE = BANK_CODE,                            
           BOOKTYPE = BOOKTYPE,                            
           ENTEREDBY = ENTEREDBY,                            
           PDT = GETDATE(),                            
           CHECKEDBY = @UNAME,                            
           ACTNODAYS = 0,                            
           NARRATION = MAX(NARRATION)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,EDT,DRCR,                            
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                            
           ENTEREDBY                            
                              
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER                            
             (VTYP,                            
              VNO,                            
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                            
              VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                           
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT   VTYP,                            
           VNO,                            
       EDT,                            
           LNO,                            
           ACNAME,                            
           DRCR,                            
           VAMT,                            
           VDT,                            
           VNO1,                            
           REFNO,                            
           BALAMT,                            
           NODAYS,                            
           CDT,                            
           CLTCODE,           
           BOOKTYPE,                            
           ENTEREDBY,                            
           PDT,                            
           CHECKEDBY,                            
           ACTNODAYS,                            
           NARRATION                            
  FROM     #LEDGER                            
  ORDER BY BOOKTYPE,                            
           VTYP,                            
           VNO,                            
           LNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                  
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  DROP TABLE #LEDGER                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT   NARATNO = 1,                            
           NARRATION = MAX(NARRATION),                            
           REFNO = 0,                            
           VTYP,                            
           VNO,                            
           BOOKTYPE                            
  FROM     #RECPAY_TABLE              
  GROUP BY VTYP,VNO,BOOKTYPE                     
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT NARATNO = LNO,                            
         NARR = NARRATION,                            
         REFNO = 0,                            
         VTYP,                            
         VNO,                            
         BOOKTYPE                            
  FROM   #RECPAY_TABLE                            
                                     
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER3                            
  SELECT   *                            
  FROM     #LEDGER3                            
  ORDER BY BOOKTYPE,                            
    VTYP,                            
           VNO,                            
           NARATNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  DROP TABLE #LEDGER3                            
                              
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                            
              FROM     #RECPAY_TABLE                            
                               ORDER BY VNO                            
                                  
      OPEN @@L2CUR                            
                                  
      FETCH NEXT FROM @@L2CUR                            
      INTO @@L2VNO                            
                                  
      WHILE @@FETCH_STATUS = 0                            
        BEGIN                            
          DELETE FROM TEMPLEDGER2                            
          WHERE       SESSIONID = '9999999999'                            
                                      
/*======CLIENT SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT 'BRANCH',                            
                 C.COSTNAME,                            
                 AMOUNT,                            
                 VTYP,                            
                 VNO,                            
                 LNO,                            
                 DRCR,                            
                 '0',                            
    BOOKTYPE,                            
                 '9999999999',                            
                 CLIENT_CODE,                            
'A',                            
                 '0'                            
          FROM   #RECPAY_TABLE RP,                            
                 COSTMAST C WITH(NOLOCK)                             
          WHERE  RP.COSTCODE = C.COSTCODE                            
                 AND VNO = @@L2VNO                            
                                      
/*======BANK SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT   'BRANCH',                            
                   C.COSTNAME,                            
                   SUM(AMOUNT),                            
                   VTYP,                            
                   VNO,                        
                   LNO = 1,                            
                   DRCR = (CASE                             
                             WHEN DRCR = 'D' THEN 'C'                            
                             ELSE 'D'                            
                           END),                            
                   '0',                            
                   BOOKTYPE,                            
                   '9999999999',                            
                   BANK_CODE,                            
                   'A',                            
                   '0'                            
          FROM     #RECPAY_TABLE RP,                            
                   COSTMAST C WITH(NOLOCK)                            
          WHERE    RP.BANKCOST = C.COSTCODE                            
                   AND VNO = @@L2VNO                            
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                             
                   WHEN DRCR = 'D' THEN 'C'                            
                      ELSE 'D'                            
                    END),                            
                   BANK_CODE,BOOKTYPE                            
                                      
          EXEC INSERTTOLEDGER2                            
            '9999999999' ,                            
            @@L2VNO ,                            
            '1' ,                            
            '1' ,                            
            '1' ,                            
            'BROKER' ,                            
            'BROKER'                            
                                      
 FETCH NEXT FROM @@L2CUR                            
          INTO @@L2VNO                            
        END                            
                                  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                            
      WHERE       SESSIONID = '9999999999'                            
                            
      IF EXISTS (SELECT *                            
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                             
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                            
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                             
         AND @@VTYP = 3                            
        BEGIN                            
          INSERT INTO THIRDPARTY_COLLECTION                            
(VNO,                            
                      VTYP,                            
                      BOOKTYPE,                            
                      CLTCODE,                            
                      AMOUNT,                            
                      VDT,                            
                      DDNO,                            
 ACCOUNT_NO,                            
                      TPR_FLAG)                            
          SELECT   VNO,                            
                   VTYP,                   
                   BOOKTYPE,                            
                   CLIENT_CODE,                            
                   AMOUNT,                            
                   VDT,                            
                   MAX(REF_NO),                            
                   ACC_NO,                            
                   TPR_FLAG = 'S'                            
          FROM     #RECPAY_TABLE                            
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                            
                   AMOUNT,VDT,ACC_NO                            
                                               
          UPDATE T                            
          SET    TPR_FLAG = 'C'                            
          FROM                     
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                            
                 MULTIBANKID M WITH(NOLOCK),                            
                 #RECPAY_TABLE R                            
          WHERE  T.CLTCODE = M.CLTCODE                            
                 AND M.ACCNO = T.ACCOUNT_NO                            
                 AND T.VNO = R.VNO                            
                 AND T.VTYP = R.VTYP                            
                 AND T.BOOKTYPE = R.BOOKTYPE                            
        END                            
                              
   COMMIT TRAN                            
 END                            
                                
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK)                             
SET                      
 ROWSTATE = 1,                          
 APPROVALFLAG = 1,                          
 APPROVALDATE = GETDATE(),                          
 APPROVEDBY = 'SYSTEM',                          
 LEDGERVNO = VNO,
 UPLOADDT = GETDATE()                        
FROM   #RECPAY_TABLE            
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                            
                                  
                              
DROP TABLE #RECPAY_TABLE       
SET @ERRORCODE = 0                                     
SET @MESSAGE = 'PAYMENT POSTED SUCCESSFULLY'                    
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME     
    
    
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD
-- --------------------------------------------------

          
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD](                                                
                                                
           @UNAME     VARCHAR(25),                                                
           @USERCAT   INT,                                                
           @EXCHANGE  VARCHAR(3),                                                
           @SEGMENT   VARCHAR(10),                                                
     @IP_VDATE varchar(11),                              
           @RECOFLAG  CHAR(1) = 'N')                                                
                                                
AS                                                
                        
SET XACT_ABORT ON                                                
/*                                              
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                             
*/                                              
                                              
                                              
  SET NOCOUNT ON                                                
                                                  
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                
  DECLARE  @@STD_DATE        VARCHAR(11),                                                
           @@LST_DATE        VARCHAR(11),                                                
           @@BRANCHFLAG       AS TINYINT,                                                
           @@VNOFLAG          AS TINYINT,                                                
           @@VNOMETHOD       INT,                                                
           @@ACNAME          CHAR(100),                                                
           @@BOOKTYPE        CHAR(2),                                                
           @@MICRNO          VARCHAR(10),                                                
           @@DRCR            VARCHAR(1),                                                
           @@VTYP            SMALLINT,                                                
           @@BANK_CODE       VARCHAR(100),                                                
           @@BACKDAYS        INT,                                                
           @@BACKDATE        VARCHAR(11),                                                
           @@BRNCOUNT        TINYINT,                                                
           @@MonthlyVdt      VARCHAR(11),                                                
           @@SERIAL_NO       INT,                                                
           @@COSTCODECOUNT   TINYINT,                                                
           @@COSTCODEUPDATES CURSOR,                                                
           @@NEWVNO           AS VARCHAR(12),                                                
           @@MAXCOUNT         AS INT,                                                
           @@VDT              AS VARCHAR(11),                                                
           @@BANKBRANCH       AS VARCHAR(10),                                                
           @@BANKCOST         AS NUMERIC,                                                
           @@LNOCUR           AS CURSOR,                                                
           @@VNOCUR           AS CURSOR,                                                
           @@LNOVNO           AS VARCHAR(12),                                                
           @@MAXVNO           AS INT,                                                
           @@L2CUR            AS CURSOR,                                                
           @@L2VNO            AS VARCHAR(12),                                                
           @@ERROR_COUNT      AS BIGINT,                                                
           @@FILEEXISTS       AS INT,                                     
           @@SQL              AS VARCHAR(2000),                            
           @ERRORCODE         AS INT,                                                
           @MESSAGE           AS VARCHAR(200) ,                                        
   @@RECPAYTBLCOUNT BIGINT                                        
                                                                     
                              
 SET @@VTYP = 2                                              
                                              
BEGIN TRAN                                                
                                                
  CREATE TABLE [#RECPAY_TABLE] (                                             
    SNO    INT   IDENTITY ( 1,1 ),                                                
    EDATE        VARCHAR(20),                                                
    VOUCHER_DATE VARCHAR(20),                                                
    CLIENT_CODE  VARCHAR(50),                                                
    AMOUNT       MONEY,                                                
    DRCR         VARCHAR(1),                               
    NARRATION    VARCHAR(234),                                                
    BANK_CODE    VARCHAR(10),                                                
  BANK_NAME    VARCHAR(100),                                                
    REF_NO       VARCHAR(15),                                                
    BRANCHCODE   VARCHAR(20),                                                
    BRANCH_NAME  VARCHAR(50),                                                
    CHQ_MODE     VARCHAR(1),                                                
    CHQ_DATE     VARCHAR(20),                                           
    CHQ_NAME     VARCHAR(100),                                                
    CL_MODE      VARCHAR(1),                                                
    FLD_AUTO     BIGINT,                                         
    ENTEREDBY    VARCHAR(25),                                                
    VDT          DATETIME   NULL,                                                
    FYSTART      DATETIME   NULL,                                          
    FYEND        DATETIME   NULL,                                                
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                
    EDT          DATETIME   NULL,                                                
    DDDT         DATETIME   NULL,                                                
    VNO          VARCHAR(12)   NULL,                                                
    VTYP         SMALLINT   NULL,                                                
    ACNAME       VARCHAR(100)   NULL,                                                
    COSTCODE     SMALLINT   NULL,                                                
    BANKCOST     SMALLINT   NULL,                                                
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                
    BANKNAME     VARCHAR(100)   NULL,                                                
    MICRNO       INT   NULL,                                                
    BOOKTYPE     VARCHAR(2)   NULL,                                                
    ACC_NO       VARCHAR(16))                                                
  ON [PRIMARY]                                                
                                                  
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                
  INSERT INTO #RECPAY_TABLE                                                
             (EDATE,                                                
              VOUCHER_DATE,                                                
              CLIENT_CODE,                                                
              AMOUNT,                                        
              DRCR,                                                
              NARRATION,                                                
              BANK_CODE,                                                
              BANK_NAME,                                                
              REF_NO,                                                
              BRANCHCODE,                                             
              BRANCH_NAME,                                                
              CHQ_MODE,                                                
              CHQ_DATE,                       
              CHQ_NAME,                                                
              CL_MODE,                                                
              FLD_AUTO,                                                
        ENTEREDBY,                                                
              VDT,                                                 
              EDT,                                                 
              DDDT,                                                
              ACC_NO,VTYP)                                                
  SELECT CONVERT(VARCHAR,EDATE,103),                                                
         CONVERT(VARCHAR,VDATE,103),                                                
         CLTCODE,                                   
         CREDITAMT,                                                
         'C',                                                
         NARRATION,                                                
         OPPCODE,                                                
         BANKNAME,                                             
         DDNO,                                                
         'ALL',                                                
         BRANCHNAME,                                                
         CHEQUEMODE,                                                
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                
         CHEQUENAME,                                                
         CLEAR_MODE,                                                
         FLDAUTO,                                                
         ADDBY,                                                 
         VDATE,                                                 
         EDATE,                                                 
         CHEQUEDATE,                                                 
         TPAccountNumber, VOUCHERTYPE                                                
  FROM   ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                     
  WHERE  VOUCHERTYPE = 2                                                
         AND EXCHANGE = @EXCHANGE                                                
         AND SEGMENT = @SEGMENT                                                
         AND ISNULL(ROWSTATE,0) = 0                           
   AND ISNULL(APPROVALFLAG,0) = 1                                          
   AND VDATE LIKE @IP_VDATE + '%'                               
                                                
                                            
                                          
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                        
                                        
 IF @@RECPAYTBLCOUNT = 0                                        
 BEGIN                                        
  COMMIT                                        
  RETURN                                        
 END                                        
                                 
                                  
                                  
--TRUNCATE table #RECPAY_TABLE                                  
--return                                        
                                  
                                     
  UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES  --WITH (ROWLOCK)                                                 
  SET    ROWSTATE = 9                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                       
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                
  FROM   #RECPAY_TABLE                                                
                                                         
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                
         @@BRANCHFLAG = BRANCHFLAG,                                                
         @@VNOFLAG = VNOFLAG                                                
  FROM   PARAMETER WITH(NOLOCK)          
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                
                                                                                  
  IF @@VNOFLAG <> 0                                                
    BEGIN                                                
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                            
      FROM   #RECPAY_TABLE                                                
                                                             
      IF @@ERROR_COUNT > 1                                                
        BEGIN                                                
     DROP TABLE #RECPAY_TABLE                                                            
     ROLLBACK TRANSACTION                                       
     SET @ERRORCODE = 1                                                          
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                
     EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                         
     RETURN                                 
        END                                                
    END                                                
                                                
  IF @@BRANCHFLAG = 1                                                
    BEGIN                                                
      UPDATE #RECPAY_TABLE                                                
      SET    BRANCHCODE = A.BRANCHCODE,                                                
             FYSTART = P.SDTCUR,                                                
           FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = C.COSTCODE,                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
             PARAMETER P WITH(NOLOCK),                                                
            COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                                                
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                               
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                 
             AND A.BRANCHCODE = COSTNAME                            
                                                                                
      UPDATE #RECPAY_TABLE                                                
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                
             FYSTART = P.SDTCUR,                                                
             FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = (SELECT TOP 1 COSTCODE                                                
                         FROM   COSTMAST                                                
                       WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
       PARAMETER P WITH(NOLOCK),                                                
             COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                                      
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                           
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
             AND A.BRANCHCODE = 'ALL'                                                
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                
                                                                                             
      UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = 'HO',                                                
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                    
             FYSTART = P.SDTCUR,                                                
             FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = (SELECT TOP 1 COSTCODE                                                
                         FROM   COSTMAST                                                
             WHERE  COSTNAME = 'HO'),                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                 
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
       PARAMETER P WITH(NOLOCK),                                                
             COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                               
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
             AND A.BRANCHCODE = 'ALL'                                                
         AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                
    END                                                
  ELSE                                           
    BEGIN                                                
      UPDATE #RECPAY_TABLE                                                
      SET    FYSTART = @@STD_DATE,                                                
             FYEND = @@LST_DATE + ' 23:59:59',                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE A.CLTCODE = CLIENT_CODE                                            
             AND B.CLTCODE = BANK_CODE                                                
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
    END                                                
                                                    
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                
                                                
  IF @@ERROR_COUNT > 0                                          
    BEGIN                                             
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                             
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                                
    END                                                
                                                    
  SET @@ERROR_COUNT = 0                                                
                                                  
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                    
  FROM   #RECPAY_TABLE                                  
  WHERE  VDT > EDT                                                
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                              
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                         
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                       
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                       
    END                                                
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  AMOUNT <= 0                 
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                                 
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                       
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                       
    RETURN                                       
    END                                                
                                                  
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                
                          CLTCODE = RP.CLIENT_CODE                                                
   FROM   #RECPAY_TABLE RP,                        
                 LEDGER L WITH(NOLOCK),                                                
     LEDGER1 L1 WITH(NOLOCK)                                                
          WHERE  L1.DDNO = RP.REF_NO                                                
                 AND L1.DD = RP.CHQ_MODE                                                
                 AND L1.DRCR = @@DRCR                                      
                 AND L1.VTYP = @@VTYP                                                
                 AND RP.REF_NO <> 0                                                
                 AND L.VTYP = @@VTYP                                                
                 AND L.VNO = L1.VNO                                                
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                
    AND L.DRCR = @@DRCR                                                
                 AND L.CLTCODE = RP.CLIENT_CODE) A                                                
                                                  
  IF @@ERROR_COUNT > 0                            
    BEGIN                                                
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                      
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   (SELECT DISTINCT CLIENT_CODE                                                
          FROM   #RECPAY_TABLE                                                
          WHERE  UPDFLAG = 'N') A                                                
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                                
    DROP TABLE #RECPAY_TABLE                     
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                       
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                           
    END                                                
                
  /*    ----------AUTO GENERATION OF VNO -------- */                                                
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                
         BOOKTYPE                                                
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                
                                                  
  OPEN @@VNOCUR                                                
                                                  
  FETCH NEXT FROM @@VNOCUR                                                
  INTO @@BANK_CODE,                                                
       @@BOOKTYPE                        
                                                  
  WHILE @@FETCH_STATUS = 0                                                
    BEGIN                                                
      IF @@BRANCHFLAG = 1                                                
        BEGIN                                                
          SELECT @@BANKBRANCH = BRANCHCODE,                                                
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                                                
          FROM   ACMAST A WITH(NOLOCK)                         
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                                
                   ON (A.BRANCHCODE = C.COSTNAME)                                                
          WHERE  A.CLTCODE = @@BANK_CODE                                                
                                                          
          IF @@BANKBRANCH <> 'ALL'                                                
            BEGIN                                                
              UPDATE RP                                                
              SET    COSTCODE = @@BANKCOST                                                
              FROM   #RECPAY_TABLE RP,                                                
                     ACMAST A WITH(NOLOCK)                                                
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                
                     AND A.BRANCHCODE = 'ALL'                                                
                                                              
              UPDATE #RECPAY_TABLE                                                
              SET    BANKCOST = @@BANKCOST                                                
              WHERE  BANK_CODE = @@BANK_CODE                   
            END                                                
          ELSE                                                
            BEGIN                                                
              UPDATE #RECPAY_TABLE                                                
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                
                                 FROM   COSTMAST WITH(NOLOCK)                                                
                                 WHERE  COSTNAME = 'HO')                                                
              WHERE  COSTCODE = ''                                                
                    AND BANK_CODE = @@BANK_CODE                                                
                                                       
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                            
                                                          COUNT(DISTINCT COSTCODE)                                                
                                                 FROM     #RECPAY_TABLE                                                 
                                                 WHERE    BANK_CODE = @@BANK_CODE                                                
                                                 GROUP BY SNO                                                
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                                                                   
              OPEN @@COSTCODEUPDATES                                                
                                                              
              FETCH NEXT FROM @@COSTCODEUPDATES                                                
              INTO @@SERIAL_NO,                                                
                   @@COSTCODECOUNT                                                
                                                
              WHILE @@FETCH_STATUS = 0                                                
                BEGIN                                                
                  UPDATE #RECPAY_TABLE                                                
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                     
                                  FROM   COSTMAST WITH(NOLOCK)                                                
                                     WHERE  COSTNAME = 'HO')                      
                  WHERE  (BANKCOST = ''                                                
                           OR BANKCOST IS NULL)                                                
                         AND BANK_CODE = @@BANK_CODE                                                
                         AND SNO = @@SERIAL_NO                                                
                                                                  
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                
                  INTO @@SERIAL_NO,                                                
         @@COSTCODECOUNT                                                
           END                                                
                                                              
              CLOSE @@COSTCODEUPDATES                                                
                                                              
              DEALLOCATE @@COSTCODEUPDATES                                                                                            
              UPDATE #RECPAY_TABLE                                                
              SET    BANKCOST = COSTCODE                                                
              WHERE  BANK_CODE = @@BANK_CODE                                                
                     AND (BANKCOST = ''             
                           OR BANKCOST IS NULL)                                               
END                                                
        END                                                
             
      CREATE TABLE #BANK_VNO (                                                
        SRNO    INT,                                                
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                
                                                      
      INSERT INTO #BANK_VNO                                                
      SELECT DISTINCT SNO                                                
      FROM   #RECPAY_TABLE                           
      WHERE  BANK_CODE = @@BANK_CODE                                                
             AND BOOKTYPE = @@BOOKTYPE          
                                                                            
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                
      FROM   #RECPAY_TABLE                                                
                                                             
      SELECT TOP 1 @@VDT = VDT                                                
FROM   #RECPAY_TABLE                                                
                                                      
      SELECT LASTVNO                                                
      INTO   #VNO                                                
      FROM   LASTVNO WITH(NOLOCK)                                                
      WHERE  1 = 2                                                
                                                      
      SELECT @@MAXVNO = MAX(NEWSRNO)                              
      FROM   #BANK_VNO                                                
                                               
                                              
                                  
                                  
      INSERT INTO #VNO                                                
      EXEC ACC_GENVNO_NEW                                                
        @@VDT ,                                                
    @@VTYP ,                                                
 @@BOOKTYPE ,                                                
       @@STD_DATE ,                             
        @@LST_DATE ,                                                
        @@MAXVNO                                                
                                                      
      SELECT @@NEWVNO = LASTVNO                                                
      FROM   #VNO                              
                                                      
      UPDATE RP                                                
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                
      FROM   #RECPAY_TABLE RP,                                                
             #BANK_VNO BV                                                
      WHERE  RP.SNO = BV.SRNO                                                
                                                      
                                   
                                  
      DROP TABLE #VNO                                                
                                                      
      DROP TABLE #BANK_VNO                                                
                                                      
      FETCH NEXT FROM @@VNOCUR                                  
      INTO @@BANK_CODE,                                                
           @@BOOKTYPE            
    END                                           
                                                  
  /*   ----------AUTO GENERATION OF LNO -------- */                                                
  UPDATE #RECPAY_TABLE                                                
 SET    LNO = 2                    
  WHERE  VNO IN (SELECT   VNO                                                
                 FROM     #RECPAY_TABLE                                                 
                 GROUP BY VNO                                                
                 HAVING   COUNT(*) = 1)                                                
                                    
                                  
                                  
                                                
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                
                            FROM     #RECPAY_TABLE                                                 
                            GROUP BY VNO                                                
                            HAVING   COUNT(*) > 1                                         
                                                  
  OPEN @@LNOCUR           
                                                  
  FETCH NEXT FROM @@LNOCUR                                                
  INTO @@LNOVNO                                                
                                                  
  WHILE @@FETCH_STATUS = 0                                                
    BEGIN                                                
      CREATE TABLE [#LNOGEN] (                                                
        VNO VARCHAR(12),                                                
        SNO INT,                                                
        LNO INT   IDENTITY ( 1,1 ))                                                
                                                      
      INSERT INTO #LNOGEN                                                
      SELECT   VNO, SNO                                                
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                                
      WHERE    VNO = @@LNOVNO                     
      ORDER BY SNO                            
                                                      
      UPDATE #RECPAY_TABLE                                                
      SET    LNO = L.LNO + 1                                            
      FROM   #LNOGEN L                                                
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                
             AND #RECPAY_TABLE.SNO = L.SNO                                                
             AND #RECPAY_TABLE.LNO = 0                                                
                                                      
      DROP TABLE #LNOGEN                                                
                                                      
      FETCH NEXT FROM @@LNOCUR                                                
      INTO @@LNOVNO                                                
    END                                                
                                                  
  CLOSE @@LNOCUR                                           
                                                  
  DEALLOCATE @@LNOCUR                                                
                                                  
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                
  INSERT INTO LEDGER1                                                
             (BNKNAME,                                                
              BRNNAME,                                                
              DD,                                                
     DDNO,                                                
              DDDT,                                                
              RELDT,                                                
              RELAMT,                                                
              REFNO,                                                
              RECEIPTNO,                                                
   VTYP,                       
              VNO,                                                
              LNO,            
     DRCR,                                                
              BOOKTYPE,                                                
              MICRNO,                                                
              SLIPNO,                                                
              SLIPDATE,                                                
              CHEQUEINNAME,                                                
              CHQPRINTED,                                                
              CLEAR_MODE)                                                
  SELECT   BNKNAME = MAX(BANK_NAME),                                                
           BRNNAME = MAX(BRANCH_NAME),                                                
           DD = MAX(CHQ_MODE),                                                
           DDNO = MAX(REF_NO),                                                
           DDDT = MAX(DDDT),                         
           RELDT = '',                                                
           RELAMT = SUM(AMOUNT),                                                
           REFNO = 0,                                                
           RECEIPTNO = 0,                                                
           VTYP,                                           
           VNO,                                                
           LNO = 2,                                                
           DRCR,                                                
           BOOKTYPE = BOOKTYPE,                                               
           MICRNO = MICRNO,                                                
           SLIPNO = 0,                                                
           SLIPDATE = '',                                                
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                
           CHQPRINTED = 0,                                                
   CLEAR_MODE = MAX(CL_MODE)                                                
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                
           MICRNO                                                
                                                   
  IF @@ERROR <> 0                                                
    BEGIN                                                  
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                             
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                       
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                        
    END                                                
                                                    
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                
  CREATE TABLE #LEDGER (                             
    VTYP      SMALLINT,                                                
    VNO       VARCHAR(12),                                                
    EDT       DATETIME,                                                
    LNO       SMALLINT,                                              
    ACNAME    VARCHAR(100),                                                
    DRCR      VARCHAR(1),                                                
    VAMT      MONEY,                                                
    VDT       DATETIME,                                                
    VNO1      VARCHAR(12),                                                
    REFNO     CHAR(12),                                         
    BALAMT    MONEY,                            
    NODAYS    INT,                                                
    CDT       DATETIME,                                                
    CLTCODE   VARCHAR(10),                                                
    BOOKTYPE  VARCHAR(2),                                                
    ENTEREDBY VARCHAR(25),                                                
    PDT       DATETIME,                                                
    CHECKEDBY VARCHAR(25),                             
    ACTNODAYS INT,                                                
    NARRATION VARCHAR(234))                                                    
                                                  
  CREATE TABLE #LEDGER3 (                                                
    NARATNO  INT,                                                
    NARR     VARCHAR(234),                                                
    REFNO    CHAR(12),                                                
    VTYP     SMALLINT,                                                
    VNO      VARCHAR(12),                                             
    BOOKTYPE VARCHAR(2))                                                
                                                  
/*======CLIENT SIDE RECORD======*/                                                
  INSERT INTO #LEDGER                                          
             (VTYP,                                                
              VNO,                                               
              EDT,                             
              LNO,                                                
              ACNAME,                                                
              DRCR,                                               
      VAMT,                                                
              VDT,                                                
              VNO1,                                             
              REFNO,                                                
              BALAMT,                                                
              NODAYS,                                                
              CDT,                                                
              CLTCODE,                                                
              BOOKTYPE,                                               
              ENTEREDBY,                                                
              PDT,                                                
              CHECKEDBY,                                                
              ACTNODAYS,                                                
              NARRATION)                                                
  SELECT VTYP,                                                
         VNO,                                                
         EDT = (CASE                                                 
                  WHEN VTYP = 2                                                
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                
                  ELSE EDT                                                
                END),                             
         LNO,                                                
         ACNAME,                                                
         DRCR,                        
         VAMT = AMOUNT,                                                
         VDT,                                                
         VNO1 = VNO,                                                
         REFNO = 0,                                                
         BALAMT = AMOUNT,                                                
         NODAYS = 0,                                                
         CDT = GETDATE(),                                                
         CLTCODE = CLIENT_CODE,                           
         BOOKTYPE = BOOKTYPE,                                                
         ENTEREDBY = ENTEREDBY,                                                
         PDT = GETDATE(),                                                
         CHECKEDBY = @UNAME,                                                
         ACTNODAYS = 0,                                                
         NARRATION                                                
  FROM   #RECPAY_TABLE                                                
                                                  
/*======BANK SIDE RECORD======*/                                                
  INSERT INTO #LEDGER                                                
  SELECT   VTYP,                                                
           VNO,                                                
           EDT = (CASE                                                 
                    WHEN VTYP = 2                                                
        AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                
                    ELSE EDT                                                
                  END),                                                
           LNO = 1,                                                
           BANKNAME,                                                
           DRCR = (CASE                                                 
                     WHEN DRCR = 'D' THEN 'C'                                                
                     ELSE 'D'                                    
                   END),                                                
           VAMT = SUM(AMOUNT),                                                
           VDT,                                                
           VNO1 = VNO,                                                
           REFNO = 0,                                                
           BALAMT = SUM(AMOUNT),                                                
           NODAYS = 0,                                                
CDT = GETDATE(),                                                
           CLTCODE = BANK_CODE,                                                
           BOOKTYPE = BOOKTYPE,                                                
           ENTEREDBY = ENTEREDBY,                                                
           PDT = GETDATE(),                                                
           CHECKEDBY = @UNAME,                                                
           ACTNODAYS = 0,                   
           NARRATION = MAX(NARRATION)                                 
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,EDT,DRCR,                                                
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                
           ENTEREDBY                                                
                                                  
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                
  INSERT INTO LEDGER                                                
             (VTYP,                                                
              VNO,                                                
              EDT,                                                
              LNO,                                                
              ACNAME,                                                
              DRCR,                                                
              VAMT,                                                
              VDT,                                                
              VNO1,                                                
              REFNO,                                               
              BALAMT,                                                
              NODAYS,                         CDT,                                                
              CLTCODE,                                                
              BOOKTYPE,                            
              ENTEREDBY,                                                
              PDT,                                                
              CHECKEDBY,                                                
              ACTNODAYS,                                                
 NARRATION)                                                
  SELECT   VTYP,                                                
           VNO,                                                
       EDT,                                                
           LNO,                                                
           ACNAME,                                                
           DRCR,                                                
           VAMT,                                                
           VDT,                                                
           VNO1,                                                
           REFNO,                                                
           BALAMT,                                                
           NODAYS,                                                
           CDT,                                                
           CLTCODE,                         
           BOOKTYPE,                                                
           ENTEREDBY,                                                
           PDT,                                                
           CHECKEDBY,                                                
           ACTNODAYS,                                                
           NARRATION                                                
  FROM     #LEDGER                                                
  ORDER BY BOOKTYPE,                          
           VTYP,                                                
           VNO,                                                
           LNO                                                
                                                           
  IF @@ERROR <> 0                                                
    BEGIN                                                
    DROP TABLE #LEDGER                                                
    DROP TABLE #LEDGER3                                                    
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                      
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  DROP TABLE #LEDGER                                                
                                                  
/*======BANK SIDE RECORD======*/                          
  INSERT INTO #LEDGER3                                                
  SELECT   NARATNO = 1,                                                
           NARRATION = MAX(NARRATION),                                                
           REFNO = 0,                                                
           VTYP,                                                
           VNO,                                                
           BOOKTYPE                                                
  FROM     #RECPAY_TABLE                     
  GROUP BY VTYP,VNO,BOOKTYPE                                         
                                                  
/*======CLIENT SIDE RECORD======*/                                                
  INSERT INTO #LEDGER3                                                
  SELECT NARATNO = LNO,                                                
         NARR = NARRATION,                                                
         REFNO = 0,                                                
         VTYP,                                                
         VNO,            
         BOOKTYPE                                                
  FROM   #RECPAY_TABLE                                                
                                                         
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                
  INSERT INTO LEDGER3                                                
  SELECT   *                                                
  FROM     #LEDGER3                                                
  ORDER BY BOOKTYPE,                                                
    VTYP,                                               VNO,                                                
           NARATNO                                                
                                                           
  IF @@ERROR <> 0                                                
    BEGIN                                                
    DROP TABLE #LEDGER3                                                    
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                       
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  DROP TABLE #LEDGER3                                           
                                                  
  IF @@BRANCHFLAG = 1                                                
    BEGIN                                                
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                
              FROM     #RECPAY_TABLE                                                
                               ORDER BY VNO                                                
                                                      
      OPEN @@L2CUR                                                
                                                      
      FETCH NEXT FROM @@L2CUR                                                
      INTO @@L2VNO                                                
                                              
      WHILE @@FETCH_STATUS = 0                                                
        BEGIN                                                
          DELETE FROM TEMPLEDGER2                                                
          WHERE  SESSIONID = '9999999999'                                                
                                                          
/*======CLIENT SIDE RECORD======*/                                                
          INSERT INTO TEMPLEDGER2                                                
          SELECT 'BRANCH',                                                
                 C.COSTNAME,                                                
                 AMOUNT,                                                
                 VTYP,                                                
                 VNO,                                                
                 LNO,                                                
    DRCR,                                                
                 '0',                                                
    BOOKTYPE,               
                 '9999999999',                                                
                 CLIENT_CODE,                                                
'A',                                                
                 '0'                                                
          FROM   #RECPAY_TABLE RP,                                                
                 COSTMAST C WITH(NOLOCK)                                                 
          WHERE  RP.COSTCODE = C.COSTCODE                                                
                 AND VNO = @@L2VNO                                                
                                                          
/*======BANK SIDE RECORD======*/                                                
          INSERT INTO TEMPLEDGER2                                                
     SELECT   'BRANCH',                                                
                   C.COSTNAME,                                                
                   SUM(AMOUNT),                                                
                   VTYP,                                                
                   VNO,                                            
                   LNO = 1,                                                
                   DRCR = (CASE                                                 
                             WHEN DRCR = 'D' THEN 'C'                                                
                             ELSE 'D'                                                
                           END),                            
                   '0',                                                
          BOOKTYPE,                                                
                   '9999999999',                                                
                   BANK_CODE,                                                
                   'A',                                                
                   '0'                                                
          FROM     #RECPAY_TABLE RP,                                                
                   COSTMAST C WITH(NOLOCK)                                                
          WHERE    RP.BANKCOST = C.COSTCODE                                                
                   AND VNO = @@L2VNO                                                
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                               
                   WHEN DRCR = 'D' THEN 'C'                                                
                      ELSE 'D'                                                
                    END),                                                
                   BANK_CODE,BOOKTYPE                                                
                                                          
          EXEC INSERTTOLEDGER2                                                
            '9999999999' ,                                                
            @@L2VNO ,                                                
            '1' ,                                                
            '1' ,                                                
            '1' ,                                                
            'BROKER' ,                                           
            'BROKER'                                                
                                                          
 FETCH NEXT FROM @@L2CUR                                                
          INTO @@L2VNO                                                
        END                                                
                                                  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                
      WHERE       SESSIONID = '9999999999'                                                
                                                
      IF EXISTS (SELECT *                        
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                 
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                 
         AND @@VTYP = 2                      
        BEGIN                                                
          INSERT INTO THIRDPARTY_COLLECTION                                                
(VNO,                                                
                      VTYP,                                                
                      BOOKTYPE,                                                
                      CLTCODE,                                                
                      AMOUNT,                                                
                      VDT,                                                
                      DDNO,                      
 ACCOUNT_NO,                                                
                      TPR_FLAG)                                                
          SELECT   VNO,                                                
                   VTYP,                                       
                   BOOKTYPE,                                                
                   CLIENT_CODE,                                                
                   AMOUNT,                                                
                   VDT,                                                
                   MAX(REF_NO),                                                
                   ACC_NO,                                        
                   TPR_FLAG = 'S'                          
          FROM     #RECPAY_TABLE                                                
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                                                
                   AMOUNT,VDT,ACC_NO                                                
                                                                   
          UPDATE T                                                
          SET    TPR_FLAG = 'C'                                                
          FROM                                         
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                
                 MULTIBANKID M WITH(NOLOCK),                                                
                 #RECPAY_TABLE R                                                
          WHERE  T.CLTCODE = M.CLTCODE                                                
                 AND M.ACCNO = T.ACCOUNT_NO                                                
                 AND T.VNO = R.VNO                                                
                 AND T.VTYP = R.VTYP                                      
                 AND T.BOOKTYPE = R.BOOKTYPE                                                
        END                                                
                                                  
   COMMIT TRAN                                                
 END                                                
                                                    
UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES -- WITH(ROWLOCK)                                                 
SET                                          
 ROWSTATE = 1,                                              
 APPROVALFLAG = 1,                                             
 APPROVALDATE = GETDATE(),                                              
 APPROVEDBY = 'SYSTEM',                                              
 LEDGERVNO = VNO                                                
FROM   #RECPAY_TABLE                                
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                
                                                      
                  
DROP TABLE #RECPAY_TABLE                           
SET @ERRORCODE = 0                                                         
SET @MESSAGE = 'POSTED SUCCESSFULLY'                                        
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                         
                        
                        
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_bkp01Oct2017
-- --------------------------------------------------

          
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_bkp01Oct2017](                                                
                                                
           @UNAME     VARCHAR(25),                                                
           @USERCAT   INT,                                                
           @EXCHANGE  VARCHAR(3),                                                
           @SEGMENT   VARCHAR(10),                                                
     @IP_VDATE varchar(11),                              
           @RECOFLAG  CHAR(1) = 'N')                                                
                                                
AS                                                
                        
SET XACT_ABORT ON                                                
/*                                              
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                             
*/                                              
                                              
                                              
  SET NOCOUNT ON                                                
                                                  
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                
  DECLARE  @@STD_DATE        VARCHAR(11),                                                
           @@LST_DATE        VARCHAR(11),                                                
           @@BRANCHFLAG       AS TINYINT,                                                
           @@VNOFLAG          AS TINYINT,                                                
           @@VNOMETHOD       INT,                                                
           @@ACNAME          CHAR(100),                                                
           @@BOOKTYPE        CHAR(2),                                                
           @@MICRNO          VARCHAR(10),                                                
           @@DRCR            VARCHAR(1),                                                
           @@VTYP            SMALLINT,                                                
           @@BANK_CODE       VARCHAR(100),                                                
           @@BACKDAYS        INT,                                                
           @@BACKDATE        VARCHAR(11),                                                
           @@BRNCOUNT        TINYINT,                                                
           @@MonthlyVdt      VARCHAR(11),                                                
           @@SERIAL_NO       INT,                                                
           @@COSTCODECOUNT   TINYINT,                                                
           @@COSTCODEUPDATES CURSOR,                                                
           @@NEWVNO           AS VARCHAR(12),                                                
           @@MAXCOUNT         AS INT,                                                
           @@VDT              AS VARCHAR(11),                                                
           @@BANKBRANCH       AS VARCHAR(10),                                                
           @@BANKCOST         AS NUMERIC,                                                
           @@LNOCUR           AS CURSOR,                                                
           @@VNOCUR           AS CURSOR,                                                
           @@LNOVNO           AS VARCHAR(12),                                                
           @@MAXVNO           AS INT,                                                
           @@L2CUR            AS CURSOR,                                                
           @@L2VNO            AS VARCHAR(12),                                                
           @@ERROR_COUNT      AS BIGINT,                                                
           @@FILEEXISTS       AS INT,                                     
           @@SQL              AS VARCHAR(2000),                            
           @ERRORCODE         AS INT,                                                
           @MESSAGE           AS VARCHAR(200) ,                                        
   @@RECPAYTBLCOUNT BIGINT                                        
                                                                     
                              
 SET @@VTYP = 2                                              
                                              
BEGIN TRAN                                                
                                                
  CREATE TABLE [#RECPAY_TABLE] (                                             
    SNO    INT   IDENTITY ( 1,1 ),                                                
    EDATE        VARCHAR(20),                                                
    VOUCHER_DATE VARCHAR(20),                                                
    CLIENT_CODE  VARCHAR(50),                                                
    AMOUNT       MONEY,                                                
    DRCR         VARCHAR(1),                               
    NARRATION    VARCHAR(234),                                                
    BANK_CODE    VARCHAR(10),                                                
  BANK_NAME    VARCHAR(100),                                                
    REF_NO       VARCHAR(15),                                                
    BRANCHCODE   VARCHAR(20),                                                
    BRANCH_NAME  VARCHAR(50),                                                
    CHQ_MODE     VARCHAR(1),                                                
    CHQ_DATE     VARCHAR(20),                                           
    CHQ_NAME     VARCHAR(100),                                                
    CL_MODE      VARCHAR(1),                                                
    FLD_AUTO     BIGINT,                                         
    ENTEREDBY    VARCHAR(25),                                                
    VDT          DATETIME   NULL,                                                
    FYSTART      DATETIME   NULL,                                          
    FYEND        DATETIME   NULL,                                                
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                
    EDT          DATETIME   NULL,                                                
    DDDT         DATETIME   NULL,                                                
    VNO          VARCHAR(12)   NULL,                                                
    VTYP         SMALLINT   NULL,                                                
    ACNAME       VARCHAR(100)   NULL,                                                
    COSTCODE     SMALLINT   NULL,                                                
    BANKCOST     SMALLINT   NULL,                                                
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                
    BANKNAME     VARCHAR(100)   NULL,                                                
    MICRNO       INT   NULL,                                                
    BOOKTYPE     VARCHAR(2)   NULL,                                                
    ACC_NO       VARCHAR(16))                                                
  ON [PRIMARY]                                                
                                                  
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                
  INSERT INTO #RECPAY_TABLE                                                
             (EDATE,                                                
              VOUCHER_DATE,                                                
              CLIENT_CODE,                                                
              AMOUNT,                                        
              DRCR,                                                
              NARRATION,                                                
              BANK_CODE,                                                
              BANK_NAME,                                                
              REF_NO,                                                
              BRANCHCODE,                                             
              BRANCH_NAME,                                                
              CHQ_MODE,                                                
              CHQ_DATE,                       
              CHQ_NAME,                                                
              CL_MODE,                                                
              FLD_AUTO,                                                
        ENTEREDBY,                                                
              VDT,                                                 
              EDT,                                                 
              DDDT,                                                
              ACC_NO,VTYP)                                                
  SELECT CONVERT(VARCHAR,EDATE,103),                                                
         CONVERT(VARCHAR,VDATE,103),                                                
         CLTCODE,                                   
         CREDITAMT,                                                
         'C',                                                
         NARRATION,                                                
         OPPCODE,                                                
         BANKNAME,                                             
         DDNO,                                                
         'ALL',                                                
         BRANCHNAME,                                                
         CHEQUEMODE,                                                
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                
         CHEQUENAME,                                                
         CLEAR_MODE,                                                
         FLDAUTO,                                                
         ADDBY,                                                 
         VDATE,                                                 
         EDATE,                                                 
         CHEQUEDATE,                                                 
         TPAccountNumber, VOUCHERTYPE                                                
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                     
  WHERE  VOUCHERTYPE = 2                                                
         AND EXCHANGE = @EXCHANGE                                                
         AND SEGMENT = @SEGMENT                                                
         AND ISNULL(ROWSTATE,0) = 0                           
   AND ISNULL(APPROVALFLAG,0) = 1                                          
   AND VDATE LIKE @IP_VDATE + '%'                               
                                                
                                            
                                          
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                        
                                        
 IF @@RECPAYTBLCOUNT = 0                                        
 BEGIN                                        
  COMMIT                                        
  RETURN                                        
 END                                        
                                 
                                  
                                  
--TRUNCATE table #RECPAY_TABLE                                  
--return                                        
                                  
                                     
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES  --WITH (ROWLOCK)                                                 
  SET    ROWSTATE = 9                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                       
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                
  FROM   #RECPAY_TABLE                                                
                                                         
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                
         @@BRANCHFLAG = BRANCHFLAG,                                                
         @@VNOFLAG = VNOFLAG                                                
  FROM   PARAMETER WITH(NOLOCK)          
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                
                                                                                  
  IF @@VNOFLAG <> 0                                                
    BEGIN                                                
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                            
      FROM   #RECPAY_TABLE                                                
                                                             
      IF @@ERROR_COUNT > 1                                                
        BEGIN                                                
     DROP TABLE #RECPAY_TABLE                                                            
     ROLLBACK TRANSACTION                                       
     SET @ERRORCODE = 1                                                          
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                         
     RETURN                                 
        END                                                
    END                                                
                                                
  IF @@BRANCHFLAG = 1                                                
    BEGIN                                                
      UPDATE #RECPAY_TABLE                                                
      SET    BRANCHCODE = A.BRANCHCODE,                                                
             FYSTART = P.SDTCUR,                                                
           FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = C.COSTCODE,                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
             PARAMETER P WITH(NOLOCK),                                                
            COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                                                
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                               
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                 
             AND A.BRANCHCODE = COSTNAME                            
                                                                                
      UPDATE #RECPAY_TABLE                                                
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                
             FYSTART = P.SDTCUR,                                                
             FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = (SELECT TOP 1 COSTCODE                                                
                         FROM   COSTMAST                                                
                       WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
       PARAMETER P WITH(NOLOCK),                                                
             COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                                      
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                           
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
             AND A.BRANCHCODE = 'ALL'                                                
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                
                                                                                             
      UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = 'HO',                                                
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                    
             FYSTART = P.SDTCUR,                                                
             FYEND = P.LDTCUR,                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             COSTCODE = (SELECT TOP 1 COSTCODE                                                
                         FROM   COSTMAST                                                
             WHERE  COSTNAME = 'HO'),                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                 
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
       PARAMETER P WITH(NOLOCK),                                                
             COSTMAST C WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                                                
             --AND P.CURYEAR = 1                       
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                               
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
             AND A.BRANCHCODE = 'ALL'                                                
         AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                
    END                                                
  ELSE                                           
    BEGIN                                                
      UPDATE #RECPAY_TABLE                                                
      SET    FYSTART = @@STD_DATE,                                                
             FYEND = @@LST_DATE + ' 23:59:59',                                                
             UPDFLAG = 'Y',                                                
             ACNAME = A.LONGNAME,                                                
             BANKNAME = B.LONGNAME,                                                
             BOOKTYPE = B.BOOKTYPE,                                                
             MICRNO = ISNULL(B.MICRNO,0)                                                
      FROM   ACMAST A WITH(NOLOCK),                                                
             ACMAST B WITH(NOLOCK)                                                
      WHERE A.CLTCODE = CLIENT_CODE                                            
             AND B.CLTCODE = BANK_CODE                                                
             AND A.ACCAT IN ('3','4','18')                                                
             AND B.ACCAT = '2'                                                
    END                                                
                                                    
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                
                                                
  IF @@ERROR_COUNT > 0                                          
    BEGIN                                             
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                             
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                     
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                                
    END                                                
                                                    
  SET @@ERROR_COUNT = 0                                                
                                                  
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                    
  FROM   #RECPAY_TABLE                                  
  WHERE  VDT > EDT                                                
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                              
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                         
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                       
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                       
    END                                                
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   #RECPAY_TABLE                                                
  WHERE  AMOUNT <= 0                 
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                                 
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                       
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                       
    RETURN                                       
    END                                                
                                                  
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                
                          CLTCODE = RP.CLIENT_CODE                                                
   FROM   #RECPAY_TABLE RP,                        
                 LEDGER L WITH(NOLOCK),                                                
     LEDGER1 L1 WITH(NOLOCK)                                                
          WHERE  L1.DDNO = RP.REF_NO                                                
                 AND L1.DD = RP.CHQ_MODE                                                
                 AND L1.DRCR = @@DRCR                                      
                 AND L1.VTYP = @@VTYP                                                
                 AND RP.REF_NO <> 0                                                
                 AND L.VTYP = @@VTYP                                                
                 AND L.VNO = L1.VNO                                                
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                
    AND L.DRCR = @@DRCR                                                
                 AND L.CLTCODE = RP.CLIENT_CODE) A                                                
                                                  
  IF @@ERROR_COUNT > 0                            
    BEGIN                                                
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                      
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                
  SELECT @@ERROR_COUNT = COUNT(1)                                                
  FROM   (SELECT DISTINCT CLIENT_CODE                                                
          FROM   #RECPAY_TABLE                                                
          WHERE  UPDFLAG = 'N') A                                                
                                                  
  IF @@ERROR_COUNT > 0                                                
    BEGIN                                                
    DROP TABLE #RECPAY_TABLE                     
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                       
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                           
    END                                                
                
  /*    ----------AUTO GENERATION OF VNO -------- */                                                
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                
         BOOKTYPE                                                
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                
                                                  
  OPEN @@VNOCUR                                                
                                                  
  FETCH NEXT FROM @@VNOCUR                                                
  INTO @@BANK_CODE,                                                
       @@BOOKTYPE                        
                                                  
  WHILE @@FETCH_STATUS = 0                                                
    BEGIN                                                
      IF @@BRANCHFLAG = 1                                                
        BEGIN                                                
          SELECT @@BANKBRANCH = BRANCHCODE,                                                
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                                                
          FROM   ACMAST A WITH(NOLOCK)                         
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                                
                   ON (A.BRANCHCODE = C.COSTNAME)                                                
          WHERE  A.CLTCODE = @@BANK_CODE                                                
                                                          
          IF @@BANKBRANCH <> 'ALL'                                                
            BEGIN                                                
              UPDATE RP                                                
              SET    COSTCODE = @@BANKCOST                                                
              FROM   #RECPAY_TABLE RP,                                                
                     ACMAST A WITH(NOLOCK)                                                
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                
                     AND A.BRANCHCODE = 'ALL'                                                
                                                              
              UPDATE #RECPAY_TABLE                                                
              SET    BANKCOST = @@BANKCOST                                                
              WHERE  BANK_CODE = @@BANK_CODE                   
            END                                                
          ELSE                                                
            BEGIN                                                
              UPDATE #RECPAY_TABLE                                                
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                
                                 FROM   COSTMAST WITH(NOLOCK)                                                
                                 WHERE  COSTNAME = 'HO')                                                
              WHERE  COSTCODE = ''                                                
                    AND BANK_CODE = @@BANK_CODE                                                
                                                       
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                            
                                                          COUNT(DISTINCT COSTCODE)                                                
                                                 FROM     #RECPAY_TABLE                                                 
                                                 WHERE    BANK_CODE = @@BANK_CODE                                                
                                                 GROUP BY SNO                                                
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                                                                   
              OPEN @@COSTCODEUPDATES                                                
                                                              
              FETCH NEXT FROM @@COSTCODEUPDATES                                                
              INTO @@SERIAL_NO,                                                
                   @@COSTCODECOUNT                                                
                                                
              WHILE @@FETCH_STATUS = 0                                                
                BEGIN                                                
                  UPDATE #RECPAY_TABLE                                                
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                     
                                  FROM   COSTMAST WITH(NOLOCK)                                                
                                     WHERE  COSTNAME = 'HO')                      
                  WHERE  (BANKCOST = ''                                                
                           OR BANKCOST IS NULL)                                                
                         AND BANK_CODE = @@BANK_CODE                                                
                         AND SNO = @@SERIAL_NO                                                
                                                                  
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                
                  INTO @@SERIAL_NO,                                                
         @@COSTCODECOUNT                                                
           END                                                
                                                              
              CLOSE @@COSTCODEUPDATES                                                
                                                              
              DEALLOCATE @@COSTCODEUPDATES                                                                                            
              UPDATE #RECPAY_TABLE                                                
              SET    BANKCOST = COSTCODE                                                
              WHERE  BANK_CODE = @@BANK_CODE                                                
                     AND (BANKCOST = ''             
                           OR BANKCOST IS NULL)                                               
END                                                
        END                                                
             
      CREATE TABLE #BANK_VNO (                                                
        SRNO    INT,                                                
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                
                                                      
      INSERT INTO #BANK_VNO                                                
      SELECT DISTINCT SNO                                                
      FROM   #RECPAY_TABLE                           
      WHERE  BANK_CODE = @@BANK_CODE                                                
             AND BOOKTYPE = @@BOOKTYPE          
                                                                            
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                
      FROM   #RECPAY_TABLE                                                
                                                             
      SELECT TOP 1 @@VDT = VDT                                                
FROM   #RECPAY_TABLE                                                
                                                      
      SELECT LASTVNO                                                
      INTO   #VNO                                                
      FROM   LASTVNO WITH(NOLOCK)                                                
      WHERE  1 = 2                                                
                                                      
      SELECT @@MAXVNO = MAX(NEWSRNO)                              
      FROM   #BANK_VNO                                                
                                               
                                              
                                  
                                  
      INSERT INTO #VNO                                                
      EXEC ACC_GENVNO_NEW                                                
        @@VDT ,                                                
    @@VTYP ,                                                
 @@BOOKTYPE ,                                                
       @@STD_DATE ,                             
        @@LST_DATE ,                                                
        @@MAXVNO                                                
                                                      
      SELECT @@NEWVNO = LASTVNO                                                
      FROM   #VNO                              
                                                      
      UPDATE RP                                                
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                
      FROM   #RECPAY_TABLE RP,                                                
             #BANK_VNO BV                                                
      WHERE  RP.SNO = BV.SRNO                                                
                                                      
                                   
                                  
      DROP TABLE #VNO                                                
                                                      
      DROP TABLE #BANK_VNO                                                
                                                      
      FETCH NEXT FROM @@VNOCUR                                  
      INTO @@BANK_CODE,                                                
           @@BOOKTYPE            
    END                                           
                                                  
  /*   ----------AUTO GENERATION OF LNO -------- */                                                
  UPDATE #RECPAY_TABLE                                                
 SET    LNO = 2                    
  WHERE  VNO IN (SELECT   VNO                                                
                 FROM     #RECPAY_TABLE                                                 
                 GROUP BY VNO                                                
                 HAVING   COUNT(*) = 1)                                                
                                    
                                  
                                  
                                                
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                
                            FROM     #RECPAY_TABLE                                                 
                            GROUP BY VNO                                                
                            HAVING   COUNT(*) > 1                                         
                                                  
  OPEN @@LNOCUR           
                                                  
  FETCH NEXT FROM @@LNOCUR                                                
  INTO @@LNOVNO                                                
                                                  
  WHILE @@FETCH_STATUS = 0                                                
    BEGIN                                                
      CREATE TABLE [#LNOGEN] (                                                
        VNO VARCHAR(12),                                                
        SNO INT,                                                
        LNO INT   IDENTITY ( 1,1 ))                                                
                                                      
      INSERT INTO #LNOGEN                                                
      SELECT   VNO, SNO                                                
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                                
      WHERE    VNO = @@LNOVNO                     
      ORDER BY SNO                            
                                                      
      UPDATE #RECPAY_TABLE                                                
      SET    LNO = L.LNO + 1                                            
      FROM   #LNOGEN L                                                
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                
             AND #RECPAY_TABLE.SNO = L.SNO                                                
             AND #RECPAY_TABLE.LNO = 0                                                
                                                      
      DROP TABLE #LNOGEN                                                
                                                      
      FETCH NEXT FROM @@LNOCUR                                                
      INTO @@LNOVNO                                                
    END                                                
                                                  
  CLOSE @@LNOCUR                                           
                                                  
  DEALLOCATE @@LNOCUR                                                
                                                  
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                
  INSERT INTO LEDGER1                                                
             (BNKNAME,                                                
              BRNNAME,                                                
              DD,                                                
     DDNO,                                                
              DDDT,                                                
              RELDT,                                                
              RELAMT,                                                
              REFNO,                                                
              RECEIPTNO,                                                
   VTYP,                       
              VNO,                                                
              LNO,            
     DRCR,                                                
              BOOKTYPE,                                                
              MICRNO,                                                
              SLIPNO,                                                
              SLIPDATE,                                                
              CHEQUEINNAME,                                                
              CHQPRINTED,                                                
              CLEAR_MODE)                                                
  SELECT   BNKNAME = MAX(BANK_NAME),                                                
           BRNNAME = MAX(BRANCH_NAME),                                                
           DD = MAX(CHQ_MODE),                                                
           DDNO = MAX(REF_NO),                                                
           DDDT = MAX(DDDT),                         
           RELDT = '',                                                
           RELAMT = SUM(AMOUNT),                                                
           REFNO = 0,                                                
           RECEIPTNO = 0,                                                
           VTYP,                                           
           VNO,                                                
           LNO = 2,                                                
           DRCR,                                                
           BOOKTYPE = BOOKTYPE,                                               
           MICRNO = MICRNO,                                                
           SLIPNO = 0,                                                
           SLIPDATE = '',                                                
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                
           CHQPRINTED = 0,                                                
   CLEAR_MODE = MAX(CL_MODE)                                                
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                
           MICRNO                                                
                                                   
  IF @@ERROR <> 0                                                
    BEGIN                                                  
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                             
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                       
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                        
    END                                                
                                                    
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                
  CREATE TABLE #LEDGER (                             
    VTYP      SMALLINT,                                                
    VNO       VARCHAR(12),                                                
    EDT       DATETIME,                                                
    LNO       SMALLINT,                                              
    ACNAME    VARCHAR(100),                                                
    DRCR      VARCHAR(1),                                                
    VAMT      MONEY,                                                
    VDT       DATETIME,                                                
    VNO1      VARCHAR(12),                                                
    REFNO     CHAR(12),                                         
    BALAMT    MONEY,                            
    NODAYS    INT,                                                
    CDT       DATETIME,                                                
    CLTCODE   VARCHAR(10),                                                
    BOOKTYPE  VARCHAR(2),                                                
    ENTEREDBY VARCHAR(25),                                                
    PDT       DATETIME,                                                
    CHECKEDBY VARCHAR(25),                             
    ACTNODAYS INT,                                                
    NARRATION VARCHAR(234))                                                    
                                                  
  CREATE TABLE #LEDGER3 (                                                
    NARATNO  INT,                                                
    NARR     VARCHAR(234),                                                
    REFNO    CHAR(12),                                                
    VTYP     SMALLINT,                                                
    VNO      VARCHAR(12),                                             
    BOOKTYPE VARCHAR(2))                                                
                                                  
/*======CLIENT SIDE RECORD======*/                                                
  INSERT INTO #LEDGER                                          
             (VTYP,                                                
              VNO,                                               
              EDT,                             
              LNO,                                                
              ACNAME,                                                
              DRCR,                                               
      VAMT,                                                
              VDT,                                                
              VNO1,                                             
              REFNO,                                                
              BALAMT,                                                
              NODAYS,                                                
              CDT,                                                
              CLTCODE,                                                
              BOOKTYPE,                                               
              ENTEREDBY,                                                
              PDT,                                                
              CHECKEDBY,                                                
              ACTNODAYS,                                                
              NARRATION)                                                
  SELECT VTYP,                                                
         VNO,                                                
         EDT = (CASE                                                 
                  WHEN VTYP = 2                                                
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                
                  ELSE EDT                                                
                END),                             
         LNO,                                                
         ACNAME,                                                
         DRCR,                        
         VAMT = AMOUNT,                                                
         VDT,                                                
         VNO1 = VNO,                                                
         REFNO = 0,                                                
         BALAMT = AMOUNT,                                                
         NODAYS = 0,                                                
         CDT = GETDATE(),                                                
         CLTCODE = CLIENT_CODE,                           
         BOOKTYPE = BOOKTYPE,                                                
         ENTEREDBY = ENTEREDBY,                                                
         PDT = GETDATE(),                                                
         CHECKEDBY = @UNAME,                                                
         ACTNODAYS = 0,                                                
         NARRATION                                                
  FROM   #RECPAY_TABLE                                                
                                                  
/*======BANK SIDE RECORD======*/                                                
  INSERT INTO #LEDGER                                                
  SELECT   VTYP,                                                
           VNO,                                                
           EDT = (CASE                                                 
                    WHEN VTYP = 2                                                
        AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                
                    ELSE EDT                                                
                  END),                                                
           LNO = 1,                                                
           BANKNAME,                                                
           DRCR = (CASE                                                 
                     WHEN DRCR = 'D' THEN 'C'                                                
                     ELSE 'D'                                    
                   END),                                                
           VAMT = SUM(AMOUNT),                                                
           VDT,                                                
           VNO1 = VNO,                                                
           REFNO = 0,                                                
           BALAMT = SUM(AMOUNT),                                                
           NODAYS = 0,                                                
CDT = GETDATE(),                                                
           CLTCODE = BANK_CODE,                                                
           BOOKTYPE = BOOKTYPE,                                                
           ENTEREDBY = ENTEREDBY,                                                
           PDT = GETDATE(),                                                
           CHECKEDBY = @UNAME,                                                
           ACTNODAYS = 0,                   
           NARRATION = MAX(NARRATION)                                 
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,EDT,DRCR,                                                
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                
           ENTEREDBY                                                
                                                  
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                
  INSERT INTO LEDGER                                                
             (VTYP,                                                
              VNO,                                                
              EDT,                                                
              LNO,                                                
              ACNAME,                                                
              DRCR,                                                
              VAMT,                                                
              VDT,                                                
              VNO1,                                                
              REFNO,                                               
              BALAMT,                                                
              NODAYS,                         CDT,                                                
              CLTCODE,                                                
              BOOKTYPE,                            
              ENTEREDBY,                                                
              PDT,                                                
              CHECKEDBY,                                                
              ACTNODAYS,                                                
 NARRATION)                                                
  SELECT   VTYP,                                                
           VNO,                                                
       EDT,                                                
           LNO,                                                
           ACNAME,                                                
           DRCR,                                                
           VAMT,                                                
           VDT,                                                
           VNO1,                                                
           REFNO,                                                
           BALAMT,                                                
           NODAYS,                                                
           CDT,                                                
           CLTCODE,                         
           BOOKTYPE,                                                
           ENTEREDBY,                                                
           PDT,                                                
           CHECKEDBY,                                                
           ACTNODAYS,                                                
           NARRATION                                                
  FROM     #LEDGER                                                
  ORDER BY BOOKTYPE,                          
           VTYP,                                                
           VNO,                                                
           LNO                                                
                                                           
  IF @@ERROR <> 0                                                
    BEGIN                                                
    DROP TABLE #LEDGER                                                
    DROP TABLE #LEDGER3                                                    
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                      
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  DROP TABLE #LEDGER                                                
                                                  
/*======BANK SIDE RECORD======*/                          
  INSERT INTO #LEDGER3                                                
  SELECT   NARATNO = 1,                                                
           NARRATION = MAX(NARRATION),                                                
           REFNO = 0,                                                
           VTYP,                                                
           VNO,                                                
           BOOKTYPE                                                
  FROM     #RECPAY_TABLE                     
  GROUP BY VTYP,VNO,BOOKTYPE                                         
                                                  
/*======CLIENT SIDE RECORD======*/                                                
  INSERT INTO #LEDGER3                                                
  SELECT NARATNO = LNO,                                                
         NARR = NARRATION,                                                
         REFNO = 0,                                                
         VTYP,                                                
         VNO,            
         BOOKTYPE                                                
  FROM   #RECPAY_TABLE                                                
                                                         
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                
  INSERT INTO LEDGER3                                                
  SELECT   *                                                
  FROM     #LEDGER3                                                
  ORDER BY BOOKTYPE,                                                
    VTYP,                                               VNO,                                                
           NARATNO                                                
                                                           
  IF @@ERROR <> 0                                                
    BEGIN                                                
    DROP TABLE #LEDGER3                                                    
    DROP TABLE #RECPAY_TABLE                                                
    ROLLBACK TRAN                                        
    SET @ERRORCODE = 1                                                         
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                       
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                            
    RETURN                                       
    END                                                
                                                  
  DROP TABLE #LEDGER3                                           
                                                  
  IF @@BRANCHFLAG = 1                                                
    BEGIN                                                
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                
              FROM     #RECPAY_TABLE                                                
                               ORDER BY VNO                                                
                                                      
      OPEN @@L2CUR                                                
                                                      
      FETCH NEXT FROM @@L2CUR                                                
      INTO @@L2VNO                                                
                                              
      WHILE @@FETCH_STATUS = 0                                                
        BEGIN                                                
          DELETE FROM TEMPLEDGER2                                                
          WHERE  SESSIONID = '9999999999'                                                
                                                          
/*======CLIENT SIDE RECORD======*/                                                
          INSERT INTO TEMPLEDGER2                                                
          SELECT 'BRANCH',                                                
                 C.COSTNAME,                                                
                 AMOUNT,                                                
                 VTYP,                                                
                 VNO,                                                
                 LNO,                                                
    DRCR,                                                
                 '0',                                                
    BOOKTYPE,               
                 '9999999999',                                                
                 CLIENT_CODE,                                                
'A',                                                
                 '0'                                                
          FROM   #RECPAY_TABLE RP,                                                
                 COSTMAST C WITH(NOLOCK)                                                 
          WHERE  RP.COSTCODE = C.COSTCODE                                                
                 AND VNO = @@L2VNO                                                
                                                          
/*======BANK SIDE RECORD======*/                                                
          INSERT INTO TEMPLEDGER2                                                
     SELECT   'BRANCH',                                                
                   C.COSTNAME,                                                
                   SUM(AMOUNT),                                                
                   VTYP,                                                
                   VNO,                                            
                   LNO = 1,                                                
                   DRCR = (CASE                                                 
                             WHEN DRCR = 'D' THEN 'C'                                                
                             ELSE 'D'                                                
                           END),                            
                   '0',                                                
          BOOKTYPE,                                                
                   '9999999999',                                                
                   BANK_CODE,                                                
                   'A',                                                
                   '0'                                                
          FROM     #RECPAY_TABLE RP,                                                
                   COSTMAST C WITH(NOLOCK)                                                
          WHERE    RP.BANKCOST = C.COSTCODE                                                
                   AND VNO = @@L2VNO                                                
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                               
                   WHEN DRCR = 'D' THEN 'C'                                                
                      ELSE 'D'                                                
                    END),                                                
                   BANK_CODE,BOOKTYPE                                                
                                                          
          EXEC INSERTTOLEDGER2                                                
            '9999999999' ,                                                
            @@L2VNO ,                                                
            '1' ,                                                
            '1' ,                                                
            '1' ,                                                
            'BROKER' ,                                           
            'BROKER'                                                
                                                          
 FETCH NEXT FROM @@L2CUR                                                
          INTO @@L2VNO                                                
        END                                                
                                                  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                
      WHERE       SESSIONID = '9999999999'                                                
                                                
      IF EXISTS (SELECT *                        
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                 
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                 
         AND @@VTYP = 2                      
        BEGIN                                                
          INSERT INTO THIRDPARTY_COLLECTION                                                
(VNO,                                                
                      VTYP,                                                
                      BOOKTYPE,                                                
                      CLTCODE,                                                
                      AMOUNT,                                                
                      VDT,                                                
                      DDNO,                      
 ACCOUNT_NO,                                                
                      TPR_FLAG)                                                
          SELECT   VNO,                                                
                   VTYP,                                       
                   BOOKTYPE,                                                
                   CLIENT_CODE,                                                
                   AMOUNT,                                                
                   VDT,                                                
                   MAX(REF_NO),                                                
                   ACC_NO,                                        
                   TPR_FLAG = 'S'                          
          FROM     #RECPAY_TABLE                                                
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                                                
                   AMOUNT,VDT,ACC_NO                                                
                                                                   
          UPDATE T                                                
          SET    TPR_FLAG = 'C'                                                
          FROM                                         
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                
                 MULTIBANKID M WITH(NOLOCK),                                                
                 #RECPAY_TABLE R                                                
          WHERE  T.CLTCODE = M.CLTCODE                                                
                 AND M.ACCNO = T.ACCOUNT_NO                                                
                 AND T.VNO = R.VNO                                                
                 AND T.VTYP = R.VTYP                                      
                 AND T.BOOKTYPE = R.BOOKTYPE                                                
        END                                                
                                                  
   COMMIT TRAN                                                
 END                                                
                                                    
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES -- WITH(ROWLOCK)                                                 
SET                                          
 ROWSTATE = 1,                                              
 APPROVALFLAG = 1,                                             
 APPROVALDATE = GETDATE(),                                              
 APPROVEDBY = 'SYSTEM',                                              
 LEDGERVNO = VNO                                                
FROM   #RECPAY_TABLE                                
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                
                                                      
                  
DROP TABLE #RECPAY_TABLE                           
SET @ERRORCODE = 0                                                         
SET @MESSAGE = 'POSTED SUCCESSFULLY'                                        
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                         
                        
                        
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK]              
 @FNAME VARCHAR(100),              
 @UNAME VARCHAR(25),              
 @USERCAT SMALLINT,          
 @EXCHANGE VARCHAR(3),            
 @SEGMENT  VARCHAR(10),            
 @STATUSID VARCHAR(15),            
 @STATUSNAME VARCHAR(15)              
              
AS              
/*              
begin tran              
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'         
ROLLBACK              
*/              
set xact_abort on    
    
    
SET NOCOUNT ON              
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
DECLARE              
 @@STD_DATE VARCHAR(11),              
 @@LST_DATE VARCHAR(11),              
 @@BRANCHFLAG AS TINYINT,              
 @@VNOFLAG AS TINYINT,              
 @@VNOMETHOD INT,              
 @@ACNAME CHAR(100),              
 @@BOOKTYPE CHAR(2),              
 @@MICRNO VARCHAR(10),              
 @@DRCR VARCHAR(1),              
 @@VTYP SMALLINT,              
 @@BANK_CODE VARCHAR(100),              
 @@BACKDAYS INT,              
 @@BACKDATE VARCHAR(11),              
 @@BRNCOUNT   TINYINT,              
 @@MonthlyVdt VARCHAR(11),              
 @@SERIAL_NO INT,              
 @@COSTCODECOUNT TINYINT,              
 @@COSTCODEUPDATES CURSOR,              
 @@NEWVNO AS VARCHAR(12),              
 @@MAXCOUNT AS INT,              
 @@VDT AS VARCHAR(11),              
 @@BANKBRANCH AS VARCHAR(10),              
 @@BANKCOST AS NUMERIC,              
 @@LNOCUR AS CURSOR,              
 @@VNOCUR AS CURSOR,              
 @@LNOVNO AS VARCHAR(12),              
 @@MAXVNO AS INT,              
 @@L2CUR AS CURSOR,              
 @@L2VNO AS VARCHAR(12),              
 @@ERROR_COUNT AS INT,              
 @@FILEEXISTS AS INT,              
 @@SQL AS VARCHAR(2000),          
 @@MyTempVno AS VARCHAR(12)                
              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT              
   U_FILENAME              
  FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'              
  RETURN              
 END              
CREATE TABLE #FEXIST              
(              
 F1 SMALLINT,              
 F2 SMALLINT,              
 F3 SMALLINT              
)              
SELECT @@SQL = "INSERT INTO "              
SELECT @@SQL = @@SQL + " #FEXIST "              
SELECT @@SQL = @@SQL + " (F1, F2, F3) "              
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "              
              
EXEC(@@SQL)              
              
SELECT              
 @@FILEEXISTS = F1              
FROM              
 #FEXIST              
              
IF @@FILEEXISTS = 0              
 BEGIN              
  DROP TABLE #FEXIST              
  SELECT              
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'              
  RETURN              
 END              
DROP TABLE #FEXIST              
              
BEGIN TRAN              
CREATE TABLE #RECPAY_TABLE_TMP              
(              
 SERIAL_NO INT,              
 EDATE VARCHAR(20),              
 VOUCHER_DATE VARCHAR(20),              
 CLIENT_CODE VARCHAR(50),              
 AMOUNT MONEY,              
 DRCR VARCHAR(1),              
 NARRATION VARCHAR(234),              
 BANK_CODE VARCHAR(10),              
 BANK_NAME VARCHAR(100),          
 REF_NO VARCHAR(15),              
 BRANCHCODE VARCHAR(20),              
 BRANCH_NAME VARCHAR(50),              
 CHQ_MODE VARCHAR(1),              
 CHQ_DATE VARCHAR(20),              
 CHQ_NAME VARCHAR(100),              
 CL_MODE VARCHAR(1),                  
 ACCOUNTNO VARCHAR(25)          
)      
            
CREATE TABLE [#RECPAY_TABLE]              
 (              
  SERIAL_NO INT,              
  EDATE VARCHAR(20),              
  VOUCHER_DATE VARCHAR(20),              
  CLIENT_CODE VARCHAR(50),              
  AMOUNT MONEY,              
  DRCR VARCHAR(1),              
  NARRATION VARCHAR(234),              
  BANK_CODE VARCHAR(10),              
  BANK_NAME VARCHAR(100),              
  REF_NO VARCHAR(15),              
  BRANCHCODE VARCHAR(20),              
  BRANCH_NAME VARCHAR(50),              
  CHQ_MODE VARCHAR(1),              
  CHQ_DATE VARCHAR(20),              
  CHQ_NAME VARCHAR(100),              
  CL_MODE VARCHAR(1),              
  SNO INT IDENTITY (1, 1) NOT NULL ,              
  VDT DATETIME NULL ,              
  FYSTART DATETIME NULL ,              
  FYEND DATETIME NULL ,              
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),              
  EDT DATETIME NULL ,              
  DDDT DATETIME NULL ,              
  VNO VARCHAR (12) NULL ,              
  VTYP SMALLINT NULL ,              
  ACNAME VARCHAR (100) NULL ,              
  COSTCODE SMALLINT NULL,              
  BANKCOST SMALLINT NULL,              
  LNO SMALLINT NOT NULL DEFAULT(0),              
  BANKNAME VARCHAR(100) NULL,            
  MICRNO INT NULL,              
  BOOKTYPE VARCHAR(2) NULL,           
  ACCOUNTNO VARCHAR(25),        
  TPFLAG INT           
 ) ON [PRIMARY]            
          
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "              
EXEC (@@SQL)              
              
IF @@ERROR <> 0              
 BEGIN              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRANSACTION              
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'              
  RETURN              
 END              
INSERT INTO              
 V2_UPLOADED_FILES              
SELECT              
 @FNAME,              
 @FNAME,              
 CNT = COUNT(1),              
 'B',              
 GETDATE(),              
 @UNAME,              
 'RECEIPT/PAYMENT UPLOAD'              
              
INSERT INTO              
 #RECPAY_TABLE              
 (              
  SERIAL_NO,              
  EDATE,              
  VOUCHER_DATE,              
  CLIENT_CODE,              
  AMOUNT,              
  DRCR,              
  NARRATION,              
  BANK_CODE,              
  BANK_NAME,              
  REF_NO,              
  BRANCHCODE,              
  BRANCH_NAME,              
  CHQ_MODE,              
  CHQ_DATE,              
  CHQ_NAME,              
  CL_MODE,          
  ACCOUNTNO,        
  TPFLAG              
 )              
SELECT              
 SERIAL_NO,              
 EDATE,              
 VOUCHER_DATE,              
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),              
 AMOUNT,              
 UPPER(LTRIM(RTRIM(DRCR))),              
 NARRATION,              
 UPPER(LTRIM(RTRIM(BANK_CODE))),              
 UPPER(LTRIM(RTRIM(BANK_NAME))),              
 REF_NO,              
 UPPER(LTRIM(RTRIM(BRANCHCODE))),              
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),              
 UPPER(LTRIM(RTRIM(CHQ_MODE))),              
 CHQ_DATE,              
 CHQ_NAME,              
 CL_MODE,          
 ACCOUNTNO,        
 TPFLAG = 1          
FROM              
 #RECPAY_TABLE_TMP, MULTIBANKID M
--ADDED FOR THIRD PARTY CHQ RESRICTION
--WHERE 
--	ACCOUNTNO = M.ACCNO              
--	AND CLIENT_CODE = M.CLTCODE

UPDATE              
 #RECPAY_TABLE              
SET              
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))              
              
             
SELECT              
 @@ERROR_COUNT = COUNT(DISTINCT VDT)              
FROM              
 #RECPAY_TABLE              
              
IF @@ERROR_COUNT > 1              
 BEGIN              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRANSACTION              
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'              
  RETURN              
 END              
              
SELECT TOP 1              
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
FROM              
 #RECPAY_TABLE              
              
SELECT              
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),              
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG              
FROM              
 PARAMETER              
WHERE              
 @@VDT BETWEEN SDTCUR AND LDTCUR              
          
              
IF @@BRANCHFLAG = 1              
 BEGIN             
  UPDATE              
   #RECPAY_TABLE              
  SET              
   BRANCHCODE = A.BRANCHCODE,              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = C.COSTCODE,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = COSTNAME              
                
  UPDATE              
   #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = 'ALL'              
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'              
              
  UPDATE              
   #RECPAY_TABLE              
  SET              
   BRANCHCODE = 'HO',              
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = 'ALL'              
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'              
 END              
ELSE              
 BEGIN              
  UPDATE              
   #RECPAY_TABLE              
  SET              
   FYSTART = @@STD_DATE,              
   FYEND = @@LST_DATE + ' 23:59:59',              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
 END              
              
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */              
              
 SELECT              
  @@ERROR_COUNT = COUNT(DISTINCT VDT)              
 FROM              
  #RECPAY_TABLE              
 IF @@ERROR_COUNT > 1              
  BEGIN              
   SELECT              
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE              
   FROM              
    V2_UPLOADED_FILES              
   WHERE              
    U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
  END              
          
          
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/              
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE           
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1          
 IF @@ERROR_COUNT > 1              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'              
   DROP TABLE #RecPay_Table_Tmp              
   DROP TABLE #RecPay_Table              
   ROLLBACK TRAN              
   DELETE FROM V2_Uploaded_Files              
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
  END        */  
              
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */              
 SELECT              
  @@ERROR_COUNT = COUNT(1)              
 FROM              
  (              
   SELECT              
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),              
    SERIAL_NO              
   FROM              
    #RECPAY_TABLE              
   GROUP BY            
    SERIAL_NO              
   HAVING              
    COUNT(DISTINCT BANK_CODE) > 1              
  ) A              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT              
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'              
   UNION ALL              
   SELECT              
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))              
   FROM              
    #RECPAY_TABLE              
   GROUP BY              
    SERIAL_NO              
   HAVING              
    COUNT(DISTINCT BANK_CODE) > 1              
              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE              
   FROM              
    V2_UPLOADED_FILES              
   WHERE              
    U_FILENAME = @FNAME              
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
 END              
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
 SELECT DISTINCT              
  DRCR              
 FROM              
  #RECPAY_TABLE              
 ) A              
IF @@ERROR_COUNT > 1              
 BEGIN              
  SELECT              
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE              
  FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
ELSE              
 BEGIN              
  SELECT TOP 1              
   @@DRCR = DRCR,              
   @@VTYP =              
    (              
    CASE              
     WHEN DRCR = 'D'              
     THEN 3              
     ELSE 2              
    END              
    )              
  FROM              
   #RECPAY_TABLE              
  UPDATE              
   #RECPAY_TABLE              
  SET VTYP =              
   (              
   CASE              
     WHEN DRCR = 'D'              
     THEN 3              
     ELSE 2              
    END         
   )              
 END              
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/              
 SELECT @@ERROR_COUNT = COUNT(1)              
 FROM #RECPAY_TABLE              
 WHERE VDT > EDT              
            IF @@ERROR_COUNT > 0              
             BEGIN              
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'              
     DROP TABLE #RECPAY_TABLE_TMP              
     DROP TABLE #RECPAY_TABLE              
     ROLLBACK TRAN              
     DELETE FROM              
      V2_UPLOADED_FILES              
     WHERE              
      U_FILENAME = @FNAME              
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
     RETURN              
             END              
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/              
 SELECT @@ERROR_COUNT = COUNT(1)              
 FROM #RECPAY_TABLE              
 WHERE AMOUNT <= 0              
 IF @@ERROR_COUNT > 0              
  BEGIN              
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'              
     DROP TABLE #RECPAY_TABLE_TMP              
     DROP TABLE #RECPAY_TABLE              
     ROLLBACK TRAN              
     DELETE FROM              
      V2_UPLOADED_FILES              
     WHERE              
      U_FILENAME = @FNAME              
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
     RETURN              
  END              
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */                  
/*SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
  SELECT DISTINCT                  
   DDNO  = RP.REF_NO                  
  FROM                  
   #RECPAY_TABLE RP,                  
   LEDGER1 L1                  
    WITH(NOLOCK)                  
  WHERE                  
   L1.DDNO = RP.REF_NO                  
  AND L1.BNKNAME = RP.BANK_NAME                  
  AND L1.DD = RP.CHQ_MODE                  
  AND L1.DRCR = @@DRCR                  
  AND L1.VTYP = @@VTYP                  
  AND RP.REF_NO <> '0'                  
  AND ISNUMERIC(RP.REF_NO) = 1                 
 ) A                  
IF @@ERROR_COUNT > 0                  
 BEGIN                  
  SELECT                  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                  
  UNION ALL                  
  SELECT DISTINCT                  
   RP.REF_NO, 'NA','NA'                  
  FROM                  
   #RECPAY_TABLE RP,                  
   LEDGER1 L1                  
    WITH(NOLOCK)                  
  WHERE                  
   L1.DDNO = RP.REF_NO                  
   AND L1.DD = RP.CHQ_MODE                  
   AND L1.DRCR = @@DRCR                  
   AND L1.VTYP = @@VTYP                  
   AND RP.CHQ_MODE <> 'N'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN               
  DELETE FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END         
*/             
          
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */              
/*SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT DISTINCT              
   RP.ACCOUNTNO            
  FROM              
   #RECPAY_TABLE RP,              
   MULTIBANKID M              
    WITH(NOLOCK)              
  WHERE              
   M.ACCNO = RP.ACCOUNTNO              
 ) A              
IF @@ERROR_COUNT <= 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   RP.ACCOUNTNO, 'NA','NA'              
  FROM              
   #RECPAY_TABLE RP,              
   MULTIBANKID M              
    WITH(NOLOCK)              
  WHERE              
   M.ACCNO <> RP.ACCOUNTNO           
              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
*/          
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT DISTINCT              
   CLIENT_CODE              
  FROM              
   #RECPAY_TABLE              
  WHERE              
   UPDFLAG = 'N'              
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   CLIENT_CODE, 'NA','NA'              
  FROM              
   #RECPAY_TABLE              
  WHERE              
   UPDFLAG = 'N'              
  DROP TABLE #RECPAY_TABLE_TMP              
DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
         
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)             
        
         
UPDATE              
 R        
SET         
TPFLAG = 0        
FROM        
 #RECPAY_TABLE R,        
 MULTIBANKID M        
WHERE         
 R.CLIENT_CODE = M.CLTCODE        
 AND M.ACCNO = R.ACCOUNTNO        
         
        
INSERT INTO ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES              
   (VOUCHERTYPE,              
   BOOKTYPE,              
   SNO,              
   VDATE,              
   EDATE,              
   CLTCODE,              
   CREDITAMT,              
   DEBITAMT,              
   NARRATION,            
   OPPCODE,            
   BANKNAME,            
   DDNO,            
   BRANCHCODE,            
   BRANCHNAME,            
   CHEQUEMODE,            
   CHEQUEDATE,            
   CHEQUENAME,            
   CLEAR_MODE,            
   EXCHANGE,              
   SEGMENT,              
   TPFLAG,              
   ADDDT,              
   ADDBY,              
   STATUSID,              
   STATUSNAME,              
   ROWSTATE,              
   APPROVALFLAG,              
   APPROVALDATE,              
   APPROVEDBY,              
   VOUCHERNO,              
   UPLOADDT,              
   CLIENTNAME,        
   TPACCOUNTNUMBER)              
             
 SELECT               
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,               
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,            
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                 
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,              
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO              
 FROM               
  #RECPAY_TABLE              
            
COMMIT TRAN            
              
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                
            
DROP TABLE #RECPAY_TABLE_TMP                
DROP TABLE #RECPAY_TABLE     
    
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK_backup01Oct2017
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK_backup01Oct2017]              
 @FNAME VARCHAR(100),              
 @UNAME VARCHAR(25),              
 @USERCAT SMALLINT,          
 @EXCHANGE VARCHAR(3),            
 @SEGMENT  VARCHAR(10),            
 @STATUSID VARCHAR(15),            
 @STATUSNAME VARCHAR(15)              
              
AS              
/*              
begin tran              
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'         
ROLLBACK              
*/              
set xact_abort on    
    
    
SET NOCOUNT ON              
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
DECLARE              
 @@STD_DATE VARCHAR(11),              
 @@LST_DATE VARCHAR(11),              
 @@BRANCHFLAG AS TINYINT,              
 @@VNOFLAG AS TINYINT,              
 @@VNOMETHOD INT,              
 @@ACNAME CHAR(100),              
 @@BOOKTYPE CHAR(2),              
 @@MICRNO VARCHAR(10),              
 @@DRCR VARCHAR(1),              
 @@VTYP SMALLINT,              
 @@BANK_CODE VARCHAR(100),              
 @@BACKDAYS INT,              
 @@BACKDATE VARCHAR(11),              
 @@BRNCOUNT   TINYINT,              
 @@MonthlyVdt VARCHAR(11),              
 @@SERIAL_NO INT,              
 @@COSTCODECOUNT TINYINT,              
 @@COSTCODEUPDATES CURSOR,              
 @@NEWVNO AS VARCHAR(12),              
 @@MAXCOUNT AS INT,              
 @@VDT AS VARCHAR(11),              
 @@BANKBRANCH AS VARCHAR(10),              
 @@BANKCOST AS NUMERIC,              
 @@LNOCUR AS CURSOR,              
 @@VNOCUR AS CURSOR,              
 @@LNOVNO AS VARCHAR(12),              
 @@MAXVNO AS INT,              
 @@L2CUR AS CURSOR,              
 @@L2VNO AS VARCHAR(12),              
 @@ERROR_COUNT AS INT,              
 @@FILEEXISTS AS INT,              
 @@SQL AS VARCHAR(2000),          
 @@MyTempVno AS VARCHAR(12)                
              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT              
   U_FILENAME              
  FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'              
  RETURN              
 END              
CREATE TABLE #FEXIST              
(              
 F1 SMALLINT,              
 F2 SMALLINT,              
 F3 SMALLINT              
)              
SELECT @@SQL = "INSERT INTO "              
SELECT @@SQL = @@SQL + " #FEXIST "              
SELECT @@SQL = @@SQL + " (F1, F2, F3) "              
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "              
              
EXEC(@@SQL)              
              
SELECT              
 @@FILEEXISTS = F1              
FROM              
 #FEXIST              
              
IF @@FILEEXISTS = 0              
 BEGIN              
  DROP TABLE #FEXIST              
  SELECT              
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'              
  RETURN              
 END              
DROP TABLE #FEXIST              
              
BEGIN TRAN              
CREATE TABLE #RECPAY_TABLE_TMP              
(              
 SERIAL_NO INT,              
 EDATE VARCHAR(20),              
 VOUCHER_DATE VARCHAR(20),              
 CLIENT_CODE VARCHAR(50),              
 AMOUNT MONEY,              
 DRCR VARCHAR(1),              
 NARRATION VARCHAR(234),              
 BANK_CODE VARCHAR(10),              
 BANK_NAME VARCHAR(100),          
 REF_NO VARCHAR(15),              
 BRANCHCODE VARCHAR(20),              
 BRANCH_NAME VARCHAR(50),              
 CHQ_MODE VARCHAR(1),              
 CHQ_DATE VARCHAR(20),              
 CHQ_NAME VARCHAR(100),              
 CL_MODE VARCHAR(1),                  
 ACCOUNTNO VARCHAR(25)          
)      
            
CREATE TABLE [#RECPAY_TABLE]              
 (              
  SERIAL_NO INT,              
  EDATE VARCHAR(20),              
  VOUCHER_DATE VARCHAR(20),              
  CLIENT_CODE VARCHAR(50),              
  AMOUNT MONEY,              
  DRCR VARCHAR(1),              
  NARRATION VARCHAR(234),              
  BANK_CODE VARCHAR(10),              
  BANK_NAME VARCHAR(100),              
  REF_NO VARCHAR(15),              
  BRANCHCODE VARCHAR(20),              
  BRANCH_NAME VARCHAR(50),              
  CHQ_MODE VARCHAR(1),              
  CHQ_DATE VARCHAR(20),              
  CHQ_NAME VARCHAR(100),              
  CL_MODE VARCHAR(1),              
  SNO INT IDENTITY (1, 1) NOT NULL ,              
  VDT DATETIME NULL ,              
  FYSTART DATETIME NULL ,              
  FYEND DATETIME NULL ,              
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),              
  EDT DATETIME NULL ,              
  DDDT DATETIME NULL ,              
  VNO VARCHAR (12) NULL ,              
  VTYP SMALLINT NULL ,              
  ACNAME VARCHAR (100) NULL ,              
  COSTCODE SMALLINT NULL,              
  BANKCOST SMALLINT NULL,              
  LNO SMALLINT NOT NULL DEFAULT(0),              
  BANKNAME VARCHAR(100) NULL,            
  MICRNO INT NULL,              
  BOOKTYPE VARCHAR(2) NULL,           
  ACCOUNTNO VARCHAR(25),        
  TPFLAG INT           
 ) ON [PRIMARY]            
          
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "              
EXEC (@@SQL)              
              
IF @@ERROR <> 0              
 BEGIN              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRANSACTION              
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'              
  RETURN              
 END              
INSERT INTO              
 V2_UPLOADED_FILES              
SELECT              
 @FNAME,              
 @FNAME,              
 CNT = COUNT(1),              
 'B',              
 GETDATE(),              
 @UNAME,              
 'RECEIPT/PAYMENT UPLOAD'              
              
INSERT INTO              
 #RECPAY_TABLE              
 (              
  SERIAL_NO,              
  EDATE,              
  VOUCHER_DATE,              
  CLIENT_CODE,              
  AMOUNT,              
  DRCR,              
  NARRATION,              
  BANK_CODE,              
  BANK_NAME,              
  REF_NO,              
  BRANCHCODE,              
  BRANCH_NAME,              
  CHQ_MODE,              
  CHQ_DATE,              
  CHQ_NAME,              
  CL_MODE,          
  ACCOUNTNO,        
  TPFLAG              
 )              
SELECT              
 SERIAL_NO,              
 EDATE,              
 VOUCHER_DATE,              
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),              
 AMOUNT,              
 UPPER(LTRIM(RTRIM(DRCR))),              
 NARRATION,              
 UPPER(LTRIM(RTRIM(BANK_CODE))),              
 UPPER(LTRIM(RTRIM(BANK_NAME))),              
 REF_NO,              
 UPPER(LTRIM(RTRIM(BRANCHCODE))),              
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),              
 UPPER(LTRIM(RTRIM(CHQ_MODE))),              
 CHQ_DATE,              
 CHQ_NAME,              
 CL_MODE,          
 ACCOUNTNO,        
 TPFLAG = 1          
FROM              
 #RECPAY_TABLE_TMP, MULTIBANKID M
--ADDED FOR THIRD PARTY CHQ RESRICTION
--WHERE 
--	ACCOUNTNO = M.ACCNO              
--	AND CLIENT_CODE = M.CLTCODE

UPDATE              
 #RECPAY_TABLE              
SET              
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))              
              
             
SELECT              
 @@ERROR_COUNT = COUNT(DISTINCT VDT)              
FROM              
 #RECPAY_TABLE              
              
IF @@ERROR_COUNT > 1              
 BEGIN              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRANSACTION              
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'              
  RETURN              
 END              
              
SELECT TOP 1              
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
FROM              
 #RECPAY_TABLE              
              
SELECT              
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),              
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG              
FROM              
 PARAMETER              
WHERE              
 @@VDT BETWEEN SDTCUR AND LDTCUR              
          
              
IF @@BRANCHFLAG = 1              
 BEGIN             
  UPDATE              
   #RECPAY_TABLE              
  SET              
   BRANCHCODE = A.BRANCHCODE,              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = C.COSTCODE,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = COSTNAME              
                
  UPDATE              
   #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = 'ALL'              
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'              
              
  UPDATE              
   #RECPAY_TABLE              
  SET              
   BRANCHCODE = 'HO',              
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),              
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND P.CURYEAR = 1              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
   AND A.BRANCHCODE = 'ALL'              
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'              
 END              
ELSE              
 BEGIN              
  UPDATE              
   #RECPAY_TABLE              
  SET              
   FYSTART = @@STD_DATE,              
   FYEND = @@LST_DATE + ' 23:59:59',              
   UPDFLAG = 'Y',              
   ACNAME = A.LONGNAME,              
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,              
   MICRNO = ISNULL(B.MICRNO, 0)              
  FROM              
   ACMAST A, ACMAST B              
  WHERE              
   A.CLTCODE = CLIENT_CODE              
   AND B.CLTCODE = BANK_CODE              
   AND A.ACCAT IN ('3','4','18')              
   AND B.ACCAT = '2'              
 END              
              
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */              
              
 SELECT              
  @@ERROR_COUNT = COUNT(DISTINCT VDT)              
 FROM              
  #RECPAY_TABLE              
 IF @@ERROR_COUNT > 1              
  BEGIN              
   SELECT              
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE              
   FROM              
    V2_UPLOADED_FILES              
   WHERE              
    U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
  END              
          
          
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/              
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE           
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1          
 IF @@ERROR_COUNT > 1              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'              
   DROP TABLE #RecPay_Table_Tmp              
   DROP TABLE #RecPay_Table              
   ROLLBACK TRAN              
   DELETE FROM V2_Uploaded_Files              
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
  END        */  
              
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */              
 SELECT              
  @@ERROR_COUNT = COUNT(1)              
 FROM              
  (              
   SELECT              
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),              
    SERIAL_NO              
   FROM              
    #RECPAY_TABLE              
   GROUP BY            
    SERIAL_NO              
   HAVING              
    COUNT(DISTINCT BANK_CODE) > 1              
  ) A              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT              
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'              
   UNION ALL              
   SELECT              
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))              
   FROM              
    #RECPAY_TABLE              
   GROUP BY              
    SERIAL_NO              
   HAVING              
    COUNT(DISTINCT BANK_CODE) > 1              
              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE              
   FROM              
    V2_UPLOADED_FILES              
   WHERE              
    U_FILENAME = @FNAME              
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
   RETURN              
 END              
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
 SELECT DISTINCT              
  DRCR              
 FROM              
  #RECPAY_TABLE              
 ) A              
IF @@ERROR_COUNT > 1              
 BEGIN              
  SELECT              
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE              
  FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
ELSE              
 BEGIN              
  SELECT TOP 1              
   @@DRCR = DRCR,              
   @@VTYP =              
    (              
    CASE              
     WHEN DRCR = 'D'              
     THEN 3              
     ELSE 2              
    END              
    )              
  FROM              
   #RECPAY_TABLE              
  UPDATE              
   #RECPAY_TABLE              
  SET VTYP =              
   (              
   CASE              
     WHEN DRCR = 'D'              
     THEN 3              
     ELSE 2              
    END         
   )              
 END              
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/              
 SELECT @@ERROR_COUNT = COUNT(1)              
 FROM #RECPAY_TABLE              
 WHERE VDT > EDT              
            IF @@ERROR_COUNT > 0              
             BEGIN              
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'              
     DROP TABLE #RECPAY_TABLE_TMP              
     DROP TABLE #RECPAY_TABLE              
     ROLLBACK TRAN              
     DELETE FROM              
      V2_UPLOADED_FILES              
     WHERE              
      U_FILENAME = @FNAME              
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
     RETURN              
             END              
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/              
 SELECT @@ERROR_COUNT = COUNT(1)              
 FROM #RECPAY_TABLE              
 WHERE AMOUNT <= 0              
 IF @@ERROR_COUNT > 0              
  BEGIN              
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'              
     DROP TABLE #RECPAY_TABLE_TMP              
     DROP TABLE #RECPAY_TABLE              
     ROLLBACK TRAN              
     DELETE FROM              
      V2_UPLOADED_FILES              
     WHERE              
      U_FILENAME = @FNAME              
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
     RETURN              
  END              
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */                  
/*SELECT                  
 @@ERROR_COUNT = COUNT(1)                  
FROM                  
 (                  
  SELECT DISTINCT                  
   DDNO  = RP.REF_NO                  
  FROM                  
   #RECPAY_TABLE RP,                  
   LEDGER1 L1                  
    WITH(NOLOCK)                  
  WHERE                  
   L1.DDNO = RP.REF_NO                  
  AND L1.BNKNAME = RP.BANK_NAME                  
  AND L1.DD = RP.CHQ_MODE                  
  AND L1.DRCR = @@DRCR                  
  AND L1.VTYP = @@VTYP                  
  AND RP.REF_NO <> '0'                  
  AND ISNUMERIC(RP.REF_NO) = 1                 
 ) A                  
IF @@ERROR_COUNT > 0                  
 BEGIN                  
  SELECT                  
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                  
  UNION ALL                  
  SELECT DISTINCT                  
   RP.REF_NO, 'NA','NA'                  
  FROM                  
   #RECPAY_TABLE RP,                  
   LEDGER1 L1                  
    WITH(NOLOCK)                  
  WHERE                  
   L1.DDNO = RP.REF_NO                  
   AND L1.DD = RP.CHQ_MODE                  
   AND L1.DRCR = @@DRCR                  
   AND L1.VTYP = @@VTYP                  
   AND RP.CHQ_MODE <> 'N'                  
  DROP TABLE #RECPAY_TABLE_TMP                  
  DROP TABLE #RECPAY_TABLE                  
  ROLLBACK TRAN               
  DELETE FROM                  
   V2_UPLOADED_FILES                  
  WHERE                  
   U_FILENAME = @FNAME                  
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                  
  RETURN                  
 END         
*/             
          
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */              
/*SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT DISTINCT              
   RP.ACCOUNTNO            
  FROM              
   #RECPAY_TABLE RP,              
   MULTIBANKID M              
    WITH(NOLOCK)              
  WHERE              
   M.ACCNO = RP.ACCOUNTNO              
 ) A              
IF @@ERROR_COUNT <= 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   RP.ACCOUNTNO, 'NA','NA'              
  FROM              
   #RECPAY_TABLE RP,              
   MULTIBANKID M              
    WITH(NOLOCK)              
  WHERE              
   M.ACCNO <> RP.ACCOUNTNO           
              
  DROP TABLE #RECPAY_TABLE_TMP              
  DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
*/          
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
SELECT              
 @@ERROR_COUNT = COUNT(1)              
FROM              
 (              
  SELECT DISTINCT              
   CLIENT_CODE              
  FROM              
   #RECPAY_TABLE              
  WHERE              
   UPDFLAG = 'N'              
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   CLIENT_CODE, 'NA','NA'              
  FROM              
   #RECPAY_TABLE              
  WHERE              
   UPDFLAG = 'N'              
  DROP TABLE #RECPAY_TABLE_TMP              
DROP TABLE #RECPAY_TABLE              
  ROLLBACK TRAN              
  DELETE FROM              
   V2_UPLOADED_FILES              
  WHERE              
   U_FILENAME = @FNAME              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'              
  RETURN              
 END              
         
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)             
        
         
UPDATE              
 R        
SET         
TPFLAG = 0        
FROM        
 #RECPAY_TABLE R,        
 MULTIBANKID M        
WHERE         
 R.CLIENT_CODE = M.CLTCODE        
 AND M.ACCNO = R.ACCOUNTNO        
         
        
INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES              
   (VOUCHERTYPE,              
   BOOKTYPE,              
   SNO,              
   VDATE,              
   EDATE,              
   CLTCODE,              
   CREDITAMT,              
   DEBITAMT,              
   NARRATION,            
   OPPCODE,            
   BANKNAME,            
   DDNO,            
   BRANCHCODE,            
   BRANCHNAME,            
   CHEQUEMODE,            
   CHEQUEDATE,            
   CHEQUENAME,            
   CLEAR_MODE,            
   EXCHANGE,              
   SEGMENT,              
   TPFLAG,              
   ADDDT,              
   ADDBY,              
   STATUSID,              
   STATUSNAME,              
   ROWSTATE,              
   APPROVALFLAG,              
   APPROVALDATE,              
   APPROVEDBY,              
   VOUCHERNO,              
   UPLOADDT,              
   CLIENTNAME,        
   TPACCOUNTNUMBER)              
             
 SELECT               
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,               
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,            
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                 
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,              
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO              
 FROM               
  #RECPAY_TABLE              
            
COMMIT TRAN            
              
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                
            
DROP TABLE #RECPAY_TABLE_TMP                
DROP TABLE #RECPAY_TABLE     
    
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vdtyearend
-- --------------------------------------------------
--select * from ledger where cltcode = '99999' and vdt >= 'Apr  1 2006'


CREATE Procedure Vdtyearend        
@sdtcur varchar(11),        
@ldtcur varchar(11),        
@vtyp   smallint,        
@vno varchar(12),        
@BookType char(2),        
@vdt    datetime,        
@msg1   varchar(234)        
AS        
declare        
@@cltcode as varchar(10),        
@@acname  as varchar(100),        
@@vdtbal  as money,        
@@lno     as int,        
@@cdt     as datetime,        
@@netdiff as money,        
@@plcount as int,        
@@plbal   as money,        
@@rcursor as cursor,      
@@FixCode Varchar(10)       
      
Select @@FixCode = '99999'      
      
select @@cdt = ( select getdate() )        
        
set @@rcursor = cursor for        
select l.cltcode,l.acname , balance=isnull(sum( case when upper(drcr) = 'D' then vamt else -vamt end),0)        
from ledger l left outer join acmast a on l.cltcode = a.cltcode        
where l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'        
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%') and l.cltcode <> @@FixCode        
group by l.cltcode,l.acname        
order by l.cltcode,l.acname        
        
open @@rcursor        
fetch next from @@rcursor         
into @@cltcode, @@acname, @@vdtbal        
        
select @@lno = 0        
select @@netdiff = 0        
while @@fetch_status = 0        
begin        
   select @@lno = @@lno + 1        
   select @@netdiff = @@netdiff + @@vdtbal        
        
   Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,        
                      EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)         
               values (@vtyp,@vno,(case when @@vdtbal >= 0 then 'D' else 'C' end),isnull(abs(@@vdtbal),0),@vdt,'',upper(@@cltcode),        
                       'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)        
        
        
   Insert into ledger3(naratno,narr,refno,vtyp,vno,BookType)         
                values(@@lno,@msg1,'',@vtyp,@vno,@BookType)        
        
   fetch next from @@rcursor         
   into @@cltcode, @@acname, @@vdtbal        
end        
        
close @@rcursor        
deallocate @@rcursor        
        
select @@lno = @@lno + 1        
select @@acname = ( select acname from acmast where cltcode = @@FixCode)        
Insert into ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,        
                   EnteredBy,lno,balamt,Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)         
            values (@vtyp,@vno,(case when @@netdiff >= 0 then 'C' else 'D' end),abs(@@netdiff),@vdt,'',@@FixCode,        
                    'System',@@lno,0,@Vno,@booktype,@vdt,@@cdt,@@cdt,0,0,'System',@@acname,@msg1)        
        
        
Insert into ledger3        
select lno, narration, refno, vtyp, vno, BookType        
from ledger        
where vtyp = @vtyp and booktype = @booktype and vno = @vno and  cltcode=@@FixCode        
        
Insert into ledger3        
select 0, narration, refno, vtyp, vno, BookType        
from ledger        
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VoucherPrintingSp
-- --------------------------------------------------


--exec VoucherPrintingSp '7','01','01','','','200504070007','200504070007',1,1           
          
--exec VoucherPrintingSp '4','01','01','','','200504020001','200504020001',1,1              
            
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 06/24/2004 8:32:35 PM ******/                
                
/****** Object:  Stored Procedure dbo.VoucherPrintingSp    Script Date: 05/10/2004 5:29:36 PM ******/                
/* comm. narr replaced line narration  by amit requirment in mosl on 18/10/2002*/                
                
CREATE Proc VoucherPrintingSp                 
@Vtyp varchar(2),                
@BookTypeFrom varchar(2),                
@BookTypeTo varchar(2),                
@StartDate Varchar(11),                
@EndDate Varchar(11),                
@VnoFrom Varchar(12),                
@VnoTo Varchar(12),                
@VnoVdtFlag int,                
@Flag int                
as                
                
If @Flag = 0                
Begin                
   if @startdate = ''                 
      begin                
/* Conditions of VNO only */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
     cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno      
      end                
   else                
   if @Vnofrom = ''                 
      begin                
         /* Conditions on Vdt only */                
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                  
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                 
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
    narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = cltcode, acname2 = acname            
    from ledger l ,LEDGER1 L1                
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
      end                
   else                
      begin                
         /* Conditions on Vdt and VNo */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype                  
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno -- desc                
      end                
end              
                
Else If @Flag = 1                
Begin                
  if @startdate = ''                 
     begin                
  /* Conditions of VNO only */                
  select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
     from ledger l                 
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo              
   --and l.drcr in (case when @Vtyp='6' then 'C' else case when @Vtyp='7' then 'D' else 'C''D' end end)              
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
     end                
 else                
 if @Vnofrom = ''                 
     begin                
                /* Conditions on Vdt only */                
                  
   select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                      ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                         ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
 /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') , */                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l                 
    where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno                
     End                
   Else                 
          /* Conditions on Vdt and VNo */                
      Begin                 
    select   CltCode = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24                 
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
   isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
     from ledger l                 
    where  l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'       
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      End                  
End                
              
Else If @flag = 2                
Begin                
 if @startdate = ''                 
  Begin                
  /* Conditions of VNO only */                
  select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
          ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
          ELSE L.acname END ),0),                
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
     narr = isnull(l.narration,'') ,                
     /* cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
                        cnar = isnull(l.narration,'') ,                
   cltcode2 = l.cltcode, acname2 = l.acname                
    from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
  End                 
    else                
 if @Vnofrom = ''                 
     begin                
                /* Conditions on Vdt only */                  
    select   CltCode = ISNULL((CASE WHEN a.accat = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
           ELSE L.acname END ),0),                
    l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
    narr = isnull(l.narration,'') ,                
    /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = l.cltcode, acname2 = l.acname                
    from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                 
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
                    
  End                 
  Else                 
          /* Conditions on Vdt and VNo */                
  Begin                
    select   CltCode = ISNULL((CASE WHEN a.accat = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
          ELSE L.CLTCODE END ),0),                
     acname = ISNULL((CASE WHEN a.accat = 14   THEN (SELECT acmast.acname FROM MARGINLEDGER m ,acmast WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND m.BOOKTYPE = L.BOOKTYPE and m.party_code = acmast.cltcode)                 
          ELSE L.acname END ),0),                
     l.vamt,l.drcr,l.vtyp,l.vno,l.lno,l.booktype,vdt = convert(varchar,l.vdt,103),edt = convert(varchar,l.edt,103),                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = l.cltcode, acname2 = l.acname           
    from ledger l, acmast a                
    where l.cltcode = a.cltcode and l.vtyp = 24  and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno                
  End                 
                
End                
else if @flag = 3                
Begin                
   if @startdate = ''                 
      begin                
/* Conditions of VNO only */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
     isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype and l.lno = l1.lno                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
  order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      end                
   else                
   if @Vnofrom = ''                 
      begin                
         /* Conditions on Vdt only */                
  select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                  
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                    ELSE L.CLTCODE END ),0),                 
    acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                       ELSE L.acname END ),0),                  
    isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
    bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
    narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),''), */                
  cnar = isnull(l.narration,'') ,                
  cltcode2 = cltcode, acname2 = acname                
    from ledger l ,LEDGER1 L1               
   where   l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo and vdt >= @StartDate + ' 00:00:00'                
   and l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype  and l.lno = l1.lno                
    and vdt <=@EndDate + ' 23:59:59'                
    order by l.vdt, l.vtyp, l.booktype, l.vno, l.lno                
                
      end                
   else                
      begin                
         /* Conditions on Vdt and VNo */                
   select   CltCode = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24                 
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER m WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)                 
                     ELSE L.CLTCODE END ),0),                 
     acname= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                 
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND m.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)                 
                        ELSE L.acname END ),0),                  
 isnull(l.Vamt,0) Vamt, l.drcr, l.vtyp,l.vno, l.lno , l.booktype, convert(varchar,l.vdt,103) vdt, convert(varchar,l.edt,103) edt,                
     bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno, dddt  =  convert(varchar,dddt,103)  ,                
     narr = isnull(l.narration,'') ,                
     /*cnar = isnull((select narr from ledger3 l3 where l3.vtyp = l.vtyp and l3.vno = l.vno and l3.naratno = 0 and l3.booktype = l.booktype),'') ,*/                
   cnar = isnull(l.narration,'') ,                
   cltcode2 = cltcode, acname2 = acname                
  from ledger l ,LEDGER1 L1                
    where l1.vtyp = l.vtyp and l1.vno = l.vno and l1.booktype = l.booktype   and l.lno = l1.lno                
    and l.vtyp = @Vtyp and l.booktype >= @BookTypeFrom and l.booktype <= @BookTypeTo                 
    and l.vno >= @VnoFrom  and l.vno <= @VnoTo                 
/* Foll condition added by Kalpana on 19/09/2002 */                
  and vdt >= (case when @StartDate <> ''  then @StartDate  + ' 00:00:00'                
    else 'Jan  1 1900' + ' 00:00:00'                
    end)                 
  and vdt <= (case when @EndDate <> ''  then @EndDate + ' 23:59:59'                
    else getdate()                
    end)                 
    order by l.vdt, l.vtyp, l.booktype, l.vno, /*l.drcr desc, */l.lno --desc                
      end               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------
  
  
    
 /*        
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18        
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'      
*/        
CREATE PROC YEAREND        
 @SDTCUR VARCHAR(11),        
 @LDTCUR VARCHAR(11),        
 @VTYP SMALLINT,        
 @VNO VARCHAR(12),        
 @BOOKTYPE VARCHAR(2),        
 @VDT VARCHAR(11),        
 @MSG1 VARCHAR(234),      
 @PNL_CODE VARCHAR(10) = '99999'      
AS        
/*        
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'        
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'        
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'        
         
*/        
      
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
        
 CREATE TABLE #VDT        
 (        
  CLTCODE VARCHAR(10),        
  ACNAME VARCHAR(100),        
  DRCR VARCHAR(1),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #VDT        
  (CLTCODE, ACNAME, DRCR, BALANCE)        
 SELECT        
  A.CLTCODE,        
  ACNAME = ISNULL(A.LONGNAME, ''),        
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,        
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE,        
  A.LONGNAME        
        
        
 CREATE TABLE #EDT        
 (        
  CLTCODE VARCHAR(10),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #EDT        
  (CLTCODE, BALANCE)        
 SELECT        
  A.CLTCODE,        
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE        
        
        
 CREATE TABLE #LEDGER        
 (        
  VTYP SMALLINT,        
  VNO VARCHAR(12),        
  EDT DATETIME,        
  LNO INT IDENTITY(1,1),        
  ACNAME VARCHAR(100),        
  DRCR CHAR(1),        
  VAMT MONEY,        
  VDT DATETIME,        
  VNO1 VARCHAR(12),        
  REFNO CHAR(12),        
  BALAMT MONEY,        
  NODAYS INT,        
  CDT DATETIME,        
  CLTCODE VARCHAR(10),        
  BOOKTYPE VARCHAR(2),        
  ENTEREDBY VARCHAR(25),        
  PDT DATETIME,        
  CHECKEDBY VARCHAR(25),        
  ACTNODAYS INT,        
  NARRATION VARCHAR(234)        
 )        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = V.ACNAME,        
 DRCR = V.DRCR,        
 VAMT = V.BALANCE,        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = ISNULL(E.BALANCE, 0),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 V.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE        
        
        
CREATE TABLE #PANDL        
(        
 VDTBAL MONEY,        
 EDTBAL MONEY        
)        
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),        
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,        
 VAMT = ABS(VDTBAL),        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = EDTBAL,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 A.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #PANDL,        
 ACMAST A        
WHERE        
 A.CLTCODE = @PNL_CODE        
        
        
        
DROP TABLE #VDT        
DROP TABLE #EDT        
DROP TABLE #PANDL        
        
CREATE TABLE #MVDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 DRCR VARCHAR(1),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MVDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)        
SELECT        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT,        
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,        
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)        
FROM        
 MARGINLEDGER        
WHERE        
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT        
        
CREATE TABLE #MEDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MEDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)        
SELECT        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT,        
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)        
FROM        
 MARGINLEDGER M,        
 LEDGER L        
WHERE        
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO        
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT        
        
CREATE TABLE #MARGINLEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 LNO INT,        
 DRCR VARCHAR(1),        
 VDT DATETIME,        
 AMOUNT MONEY,        
 PARTY_CODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 SETT_NO MONEY,        
 SETT_TYPE VARCHAR(3),        
 BOOKTYPE VARCHAR(2),        
 MCLTCODE VARCHAR(10)        
)        
        
INSERT INTO #MARGINLEDGER        
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 DRCR = V.DRCR,        
 VDT = @VDT,        
 AMOUNT = ABS(V.AMOUNT),        
 PARTY_CODE = V.PARTY_CODE,        
 EXCHANGE = V.EXCHANGE,        
 SEGMENT = V.SEGMENT,        
 SETT_NO = ISNULL(E.AMOUNT, 0),        
 SETT_TYPE = '',        
 BOOKTYPE = @BOOKTYPE,        
 MCLTCODE = V.MCLTCODE        
FROM        
 #MVDT V LEFT OUTER JOIN #MEDT E ON        
  V.PARTY_CODE = E.PARTY_CODE        
  AND V.MCLTCODE = E.MCLTCODE        
  AND V.EXCHANGE = E.EXCHANGE        
  AND V.SEGMENT = E.SEGMENT        
        
UPDATE        
 H        
SET        
 LNO = L.LNO        
FROM        
 #MARGINLEDGER H,        
 #LEDGER L        
WHERE        
 H.MCLTCODE = L.CLTCODE        
        
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE        
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M        
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE        
DECLARE @ISDIFF INT        
SET @ISDIFF = 0        
SELECT        
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L        
WHERE        
 M.MCLTCODE = L.CLTCODE        
 AND M.BALANCE <> L.BALANCE        
        
/*IF @ISDIFF <> 0        
 BEGIN        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'        
 END        
ELSE        
 BEGIN  */      
  INSERT INTO LEDGER SELECT * FROM #LEDGER        
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER        
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER        
  EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'        
-- END

GO

-- --------------------------------------------------
-- TABLE dbo.abillmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[abillmatch]
(
    [Exchange] NVARCHAR(3) NULL,
    [Segment] NVARCHAR(20) NULL,
    [Sett_type] NVARCHAR(3) NULL,
    [Sett_No] NVARCHAR(7) NULL,
    [BillNo] NVARCHAR(10) NULL,
    [Date] SMALLDATETIME NULL,
    [Party_Code] NVARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [DrCr] NVARCHAR(1) NULL,
    [balamt] MONEY NULL,
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] NVARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acccategory
-- --------------------------------------------------
CREATE TABLE [dbo].[acccategory]
(
    [Categoryid] VARCHAR(10) NULL,
    [Categoryname] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accountscategory
-- --------------------------------------------------
CREATE TABLE [dbo].[accountscategory]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Intrestdr] VARCHAR(100) NULL,
    [Intrestcr] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(100) NULL,
    [Dummy2] VARCHAR(100) NULL,
    [Dummy3] VARCHAR(100) NULL,
    [Dummy4] VARCHAR(100) NULL,
    [Dummy5] VARCHAR(100) NULL,
    [Dummy6] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Acmast]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmastnew
-- --------------------------------------------------
CREATE TABLE [dbo].[acmastnew]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.aledger
-- --------------------------------------------------
CREATE TABLE [dbo].[aledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [edt] SMALLDATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] NVARCHAR(35) NULL,
    [drcr] NVARCHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] SMALLDATETIME NULL,
    [vno1] DECIMAL(18, 0) NULL,
    [refno] NVARCHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] SMALLDATETIME NULL,
    [cltcode] NVARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.aledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[aledger1]
(
    [bnkname] NVARCHAR(35) NULL,
    [brnname] NVARCHAR(20) NULL,
    [dd] NVARCHAR(1) NULL,
    [ddno] NVARCHAR(15) NULL,
    [dddt] SMALLDATETIME NULL,
    [reldt] SMALLDATETIME NULL,
    [relamt] MONEY NULL,
    [refno] NVARCHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] NVARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BalConfirm_Print_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[BalConfirm_Print_Setting]
(
    [Code] VARCHAR(50) NOT NULL,
    [Description] VARCHAR(1000) NOT NULL,
    [PrintFlag] VARCHAR(1) NOT NULL,
    [OrderNo] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Banklocat
-- --------------------------------------------------
CREATE TABLE [dbo].[Banklocat]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco_Log]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Billmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Billmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_no] VARCHAR(12) NULL,
    [Billno] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [Drcr] CHAR(1) NULL,
    [Balamt] MONEY NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Branch] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.billmatchlog
-- --------------------------------------------------
CREATE TABLE [dbo].[billmatchlog]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AmountMatched] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Branch] CHAR(6) NULL,
    [lvtype] SMALLINT NULL,
    [lvno] DECIMAL(12, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Booktype
-- --------------------------------------------------
CREATE TABLE [dbo].[Booktype]
(
    [Vtyp] INT NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.booktype_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[booktype_temp]
(
    [Vtyp] INT NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchAccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchAccounts]
(
    [BranchName] VARCHAR(10) NOT NULL,
    [BrControlAc] VARCHAR(10) NOT NULL,
    [MainControlAc] VARCHAR(10) NOT NULL,
    [DefaultAc] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Costcode] TINYINT NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCHWISECLBAL_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCHWISECLBAL_IISL]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(35) NULL,
    [Costcode] TINYINT NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Category
-- --------------------------------------------------
CREATE TABLE [dbo].[Category]
(
    [CATEGORY] CHAR(35) NOT NULL,
    [CATCODE] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.catmast
-- --------------------------------------------------
CREATE TABLE [dbo].[catmast]
(
    [Accat] CHAR(10) NOT NULL,
    [Catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ccmast
-- --------------------------------------------------
CREATE TABLE [dbo].[ccmast]
(
    [ccname] CHAR(35) NOT NULL,
    [cccode] CHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.chequeformats
-- --------------------------------------------------
CREATE TABLE [dbo].[chequeformats]
(
    [Bankstyle] VARCHAR(50) NOT NULL,
    [Formatcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLOSNSE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLOSNSE]
(
    [Acname] NVARCHAR(255) NULL,
    [Code] NVARCHAR(255) NULL,
    [Debit] FLOAT NULL,
    [Credit] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.company
-- --------------------------------------------------
CREATE TABLE [dbo].[company]
(
    [co_code] NVARCHAR(6) NOT NULL,
    [short_name] NVARCHAR(20) NOT NULL,
    [long_name] NVARCHAR(50) NULL,
    [address1] NVARCHAR(40) NULL,
    [address2] NVARCHAR(40) NULL,
    [address3] NVARCHAR(40) NULL,
    [address4] NVARCHAR(40) NULL,
    [city] NVARCHAR(20) NULL,
    [state] NVARCHAR(15) NULL,
    [nation] NVARCHAR(15) NULL,
    [zip] NVARCHAR(15) NULL,
    [phone1] NVARCHAR(15) NULL,
    [phone2] NVARCHAR(15) NULL,
    [fax] NVARCHAR(15) NULL,
    [email] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.comtekmst
-- --------------------------------------------------
CREATE TABLE [dbo].[comtekmst]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costcenterledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[costcenterledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] DECIMAL(12, 0) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [costdate] DATETIME NULL,
    [sess_id] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast]
(
    [COSTNAME] CHAR(35) NOT NULL,
    [COSTCODE] SMALLINT NOT NULL,
    [CATCODE] SMALLINT NOT NULL,
    [GrpCode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.creditors
-- --------------------------------------------------
CREATE TABLE [dbo].[creditors]
(
    [Cltcode] NVARCHAR(10) NOT NULL,
    [L_address1] NVARCHAR(40) NULL,
    [L_address2] NVARCHAR(40) NULL,
    [L_address3] NVARCHAR(40) NULL,
    [L_city] NVARCHAR(20) NULL,
    [L_state] NVARCHAR(15) NULL,
    [L_nation] NVARCHAR(15) NULL,
    [L_zip] NVARCHAR(10) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Off_phone1] NVARCHAR(15) NULL,
    [Off_phone2] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL,
    [Mobile_pager] NVARCHAR(40) NULL,
    [Regsupplier] TINYINT NULL,
    [Cstno] NVARCHAR(40) NULL,
    [Sstno] NVARCHAR(40) NULL,
    [Omsflag] TINYINT NULL,
    [Crlimit] MONEY NULL,
    [Crdays] TINYINT NULL,
    [Pan_no] VARCHAR(50) NULL,
    [Servicetax_no] VARCHAR(50) NULL,
    [Tds_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.defaacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[defaacmast]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.edtclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[edtclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EDTCLBAL_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[EDTCLBAL_IISL]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(35) NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Eqttype
-- --------------------------------------------------
CREATE TABLE [dbo].[Eqttype]
(
    [Eqt_Type] NVARCHAR(3) NOT NULL,
    [Description] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Errvouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[Errvouchers]
(
    [Cdt] DATETIME NULL,
    [Errstr] VARCHAR(300) NULL,
    [Statusid] VARCHAR(30) NULL,
    [Statusname] VARCHAR(30) NULL,
    [Username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_after_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_after_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_before_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_before_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[grpmast]
(
    [Grpname] VARCHAR(60) NULL,
    [Grpmain] VARCHAR(13) NULL,
    [Grpcode] VARCHAR(13) NULL,
    [Vtyp] FLOAT NULL,
    [Dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grptemp
-- --------------------------------------------------
CREATE TABLE [dbo].[grptemp]
(
    [grpname] VARCHAR(60) NULL,
    [grpmain] VARCHAR(13) NULL,
    [grpcode] VARCHAR(13) NULL,
    [vtyp] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastchequeno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastchequeno]
(
    [Bankcode] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastvno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastvno]
(
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_BRANCHBREAKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_BRANCHBREAKUP]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] CHAR(2) NULL,
    [LNO] INT NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CAMT] MONEY NULL,
    [COSTCODE] SMALLINT NULL,
    [DRCR] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_IISL]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [optcode] CHAR(1) NULL,
    [Editdate] DATETIME NULL,
    [EditName] VARCHAR(15) NULL,
    [Status] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Report]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [SNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Temp_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Temp_New]
(
    [Vno] INT NOT NULL,
    [CltCode] VARCHAR(10) NOT NULL,
    [Vdt] DATETIME NULL,
    [Edt] DATETIME NULL,
    [VTyp] SMALLINT NOT NULL,
    [Vamt] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(15) NOT NULL,
    [acname] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TEMP_NEW_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TEMP_NEW_PARTYLEDGER]
(
    [CLTCODE] VARCHAR(10) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [VDT] VARCHAR(11) NULL,
    [EDT] VARCHAR(11) NULL,
    [VAMT] MONEY NULL,
    [MAMT] MONEY NULL,
    [DRCR] CHAR(2) NULL,
    [AREA] VARCHAR(10) NULL,
    [AREA_NAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(10) NULL,
    [REGION_NAME] VARCHAR(100) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [BRANCH_NAME] VARCHAR(100) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [SUBBROKER_NAME] VARCHAR(100) NULL,
    [TRADER] VARCHAR(10) NULL,
    [TRADER_NAME] VARCHAR(100) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILY_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_txt
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_txt]
(
    [Txt] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger1]
(
    [Bnkname] VARCHAR(50) NULL,
    [Brnname] VARCHAR(50) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_IISL]
(
    [Bnkname] VARCHAR(35) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_log]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_MANUALRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_MANUALRECO_LOG]
(
    [Bnkname] VARCHAR(50) NULL,
    [Brnname] VARCHAR(50) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER2_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER2_IISL]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2_log]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(234) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER3_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER3_IISL]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(234) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3_log]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgerbalances
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgerbalances]
(
    [Familycode] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [Nsebalance] MONEY NULL,
    [Bsebalance] MONEY NULL,
    [Nsefobalance] MONEY NULL,
    [Nseestimated1] MONEY NULL,
    [Nseestimated2] MONEY NULL,
    [Bseestimated1] MONEY NULL,
    [Bseestimated2] MONEY NULL,
    [Faactual] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LedgerLog
-- --------------------------------------------------
CREATE TABLE [dbo].[LedgerLog]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] DECIMAL(12, 0) NOT NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [edt] DATETIME NULL,
    [vdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(50) NULL,
    [vamt] MONEY NULL,
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(30) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [receiptno] INT NULL,
    [narato] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [ModifiedDate] DATETIME NULL,
    [markedflag] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgertemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgertemp]
(
    [vtype] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [vno1] DECIMAL(12, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERTRANSFER_SEGMENTWISE
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERTRANSFER_SEGMENTWISE]
(
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [ACNAME] CHAR(100) NOT NULL,
    [LEDGERBALANCE] MONEY NULL,
    [AMOUNT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledgervtyp18
-- --------------------------------------------------
CREATE TABLE [dbo].[ledgervtyp18]
(
    [vtyp] SMALLINT NULL,
    [vno] INT NULL,
    [edt] SMALLDATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] NVARCHAR(35) NULL,
    [drcr] NVARCHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] SMALLDATETIME NULL,
    [vno1] INT NULL,
    [refno] NVARCHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] SMALLDATETIME NULL,
    [cltcode] NVARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledtemp
-- --------------------------------------------------
CREATE TABLE [dbo].[ledtemp]
(
    [bnkname] VARCHAR(35) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marginledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Marginledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Mcltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MARGINLEDGER_IISL
-- --------------------------------------------------
CREATE TABLE [dbo].[MARGINLEDGER_IISL]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Mcltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Matchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Matchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Lvtype] SMALLINT NULL,
    [Lvno] VARCHAR(12) NULL,
    [Llno] DECIMAL(4, 0) NULL,
    [Lbooktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.matchdetails_log
-- --------------------------------------------------
CREATE TABLE [dbo].[matchdetails_log]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Missingac
-- --------------------------------------------------
CREATE TABLE [dbo].[Missingac]
(
    [acname] NVARCHAR(255) NULL,
    [CLTCODE] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid]
(
    [Srno] INT NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nd
-- --------------------------------------------------
CREATE TABLE [dbo].[nd]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newgrpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[newgrpmast]
(
    [grpname] NVARCHAR(60) NULL,
    [grpmain] NVARCHAR(13) NULL,
    [grpcode] NVARCHAR(13) NULL,
    [vtyp] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newnseled
-- --------------------------------------------------
CREATE TABLE [dbo].[newnseled]
(
    [TYPE] NVARCHAR(5) NULL,
    [DOC] NVARCHAR(11) NULL,
    [TDT] NVARCHAR(12) NULL,
    [X] NVARCHAR(3) NULL,
    [NARRATION] NVARCHAR(50) NULL,
    [DR] MONEY NULL,
    [XX] NVARCHAR(1) NULL,
    [CR] MONEY NULL,
    [XXX] NVARCHAR(1) NULL,
    [CODE] NVARCHAR(10) NULL,
    [NAME] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(40) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [VAMT] MONEY NOT NULL,
    [MAMT] MONEY NOT NULL,
    [UNREALISED] MONEY NOT NULL,
    [SPID] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Nsefa
-- --------------------------------------------------
CREATE TABLE [dbo].[Nsefa]
(
    [CODE] NVARCHAR(9) NULL,
    [NAME] NVARCHAR(40) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.oldledger
-- --------------------------------------------------
CREATE TABLE [dbo].[oldledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [edt] SMALLDATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] NVARCHAR(35) NULL,
    [drcr] NVARCHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] SMALLDATETIME NULL,
    [vno1] INT NULL,
    [refno] NVARCHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] SMALLDATETIME NULL,
    [cltcode] NVARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.oldnseled
-- --------------------------------------------------
CREATE TABLE [dbo].[oldnseled]
(
    [TYPE] NVARCHAR(5) NULL,
    [DOC] NVARCHAR(11) NULL,
    [TDT] NVARCHAR(12) NULL,
    [X] NVARCHAR(3) NULL,
    [NARRATION] NVARCHAR(50) NULL,
    [DR] MONEY NULL,
    [XX] NVARCHAR(1) NULL,
    [CR] MONEY NULL,
    [XXX] NVARCHAR(1) NULL,
    [CODE] NVARCHAR(10) NULL,
    [NAME] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.opencltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[opencltcode]
(
    [Acname] VARCHAR(100) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Branch] VARCHAR(35) NULL,
    [Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.orgacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[orgacmast]
(
    [acname] CHAR(35) NOT NULL,
    [longname] CHAR(60) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner]
(
    [Companyname] VARCHAR(80) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(12) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [RecoFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter]
(
    [sdtcur] DATETIME NULL,
    [ldtcur] DATETIME NULL,
    [ldtprv] DATETIME NULL,
    [sdtnxt] DATETIME NULL,
    [curyear] TINYINT NULL,
    [vnoflag] SMALLINT NULL,
    [Match_BtoB] SMALLINT NULL,
    [Match_CtoC] SMALLINT NULL,
    [maker_checker] SMALLINT NULL,
    [VoucherPrintFlag] SMALLINT NULL,
    [BranchFlag] SMALLINT NULL,
    [ReportDays] SMALLINT NOT NULL DEFAULT 0,
    [FldAuto] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.pay1
-- --------------------------------------------------
CREATE TABLE [dbo].[pay1]
(
    [cltcode] NVARCHAR(10) NULL,
    [acname] NVARCHAR(35) NULL,
    [vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [ChequeNo] NVARCHAR(15) NULL,
    [ChequeInName] NVARCHAR(50) NULL,
    [Narration] NVARCHAR(150) NULL,
    [PrintedFlag] TINYINT NULL,
    [actamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Payadv
-- --------------------------------------------------
CREATE TABLE [dbo].[Payadv]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] CHAR(100) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [Chequeno] VARCHAR(15) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Narration] VARCHAR(234) NULL,
    [Printedflag] TINYINT NULL,
    [Actamt] MONEY NULL,
    [Shortage] MONEY NULL,
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Paymentmarking
-- --------------------------------------------------
CREATE TABLE [dbo].[Paymentmarking]
(
    [Paymentdate] DATETIME NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Defbtobpayment] CHAR(1) NULL,
    [Defpaymode] CHAR(1) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [Amounttobepaid] MONEY NULL,
    [Actualamoutpaid] MONEY NULL,
    [Instrumentno] INT NULL,
    [Paymarkflag] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Vno] VARCHAR(12) NULL,
    [Remark] VARCHAR(50) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Vtyp] VARCHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Approvedby] VARCHAR(15) NULL,
    [Hoapproval] INT NULL,
    [Approvedon] DATETIME NULL,
    [Chequeno] VARCHAR(12) NULL,
    [Chequeprinted] INT NULL,
    [SNO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayOut_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[PayOut_Details]
(
    [Pd_Key] INT IDENTITY(1,1) NOT NULL,
    [Pd_SrNo] INT NULL,
    [Pd_VType] SMALLINT NULL,
    [Pd_BookType] VARCHAR(2) NULL,
    [Pd_VNo] VARCHAR(12) NULL,
    [Pd_LedgerBal] MONEY NULL,
    [Pd_BillAmt] MONEY NULL,
    [Pd_AmtPaid] MONEY NULL,
    [Pd_PayMode] VARCHAR(20) NULL,
    [Pd_Status] CHAR(1) NULL,
    [Pd_CreatedBy] VARCHAR(20) NULL,
    [Pd_CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayOut_GlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[PayOut_GlobalParams]
(
    [ReqTime] INT NOT NULL,
    [AppTime] INT NOT NULL,
    [MinPayout] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayOut_SrNo
-- --------------------------------------------------
CREATE TABLE [dbo].[PayOut_SrNo]
(
    [Po_Year] SMALLINT NULL,
    [Po_SrNo] INT NULL,
    [Po_User_Flag] DECIMAL(18, 0) NULL,
    [Po_User_Id] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PLgroup_mstr
-- --------------------------------------------------
CREATE TABLE [dbo].[PLgroup_mstr]
(
    [Group_Code] VARCHAR(13) NULL,
    [Group_Name] VARCHAR(60) NULL,
    [Main_group] VARCHAR(13) NULL,
    [Amount] NUMERIC(18, 4) NULL,
    [type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PostBillLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[PostBillLedger]
(
    [VTYP] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [EDT] DATETIME NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] VARCHAR(1) NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SNO] BIGINT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BILL_NO] INT NULL,
    [ACCAT] CHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[POSTBILLLEDGER2]
(
    [DRCR] CHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ReconcileCheck
-- --------------------------------------------------
CREATE TABLE [dbo].[ReconcileCheck]
(
    [chequeno] VARCHAR(50) NULL,
    [bankdate] SMALLDATETIME NULL,
    [amount] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [narration] VARCHAR(50) NOT NULL,
    [slipno] INT NULL,
    [sdate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rms_expense_head
-- --------------------------------------------------
CREATE TABLE [dbo].[Rms_expense_head]
(
    [Exp_code] VARCHAR(8) NOT NULL,
    [Exp_main_head] VARCHAR(100) NOT NULL,
    [Exp_clt_code] VARCHAR(10) NOT NULL,
    [Exp_ac_category_name] VARCHAR(100) NULL,
    [Exp_ac_type] CHAR(10) NOT NULL,
    [Exp_ac_ctgry] CHAR(10) NOT NULL,
    [Exp_branch_code] VARCHAR(10) NOT NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_id] VARCHAR(20) NOT NULL,
    [Entry_dt] DATETIME NOT NULL,
    [Effective_datefrom] DATETIME NOT NULL,
    [Effective_dateto] DATETIME NOT NULL,
    [Modify_id] VARCHAR(20) NULL,
    [Modify_dt] DATETIME NULL,
    [Delete_id] VARCHAR(20) NULL,
    [Delete_dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip1]
(
    [co_code] NVARCHAR(6) NOT NULL,
    [sc_code] NVARCHAR(2) NOT NULL,
    [short_name] NVARCHAR(20) NOT NULL,
    [long_name] NVARCHAR(50) NULL,
    [market_lot] DECIMAL(9, 0) NULL,
    [face_val] DECIMAL(10, 0) NULL,
    [book_cl_dt] SMALLDATETIME NULL,
    [ex_div_dt] SMALLDATETIME NULL,
    [ex_bon_dt] SMALLDATETIME NULL,
    [ex_rit_dt] SMALLDATETIME NULL,
    [eqt_type] NVARCHAR(3) NULL,
    [sub_type] NVARCHAR(3) NULL,
    [agent_cd] NVARCHAR(6) NULL,
    [demat_flag] DECIMAL(1, 0) NULL,
    [demat_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Selection_Levels_PartyLedger]
(
    [Level_No] SMALLINT NULL,
    [Level_Name] VARCHAR(20) NULL,
    [Enable_Flg] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SELECTION_QUERIES_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[SELECTION_QUERIES_TABLE]
(
    [SRNO] SMALLINT NOT NULL,
    [STATUSID] VARCHAR(15) NOT NULL,
    [SELECTON] VARCHAR(15) NOT NULL,
    [SELECTIONQUERY] VARCHAR(500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SettPayout
-- --------------------------------------------------
CREATE TABLE [dbo].[SettPayout]
(
    [SrNo] INT NOT NULL,
    [BranchCode] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [BankCode] VARCHAR(10) NULL,
    [BillAmt] MONEY NULL,
    [LedgerBalNSE] MONEY NULL,
    [LedgerBalBSE] MONEY NULL,
    [LedgerBalFNO] MONEY NULL,
    [DueAmt] MONEY NULL,
    [RequestedAmt] MONEY NULL,
    [Amounttobepaid] MONEY NULL,
    [Narration] VARCHAR(234) NULL,
    [SettType] VARCHAR(3) NULL,
    [SettNo] VARCHAR(7) NULL,
    [RequestDt] DATETIME NULL,
    [UserId] VARCHAR(50) NULL,
    [Status] CHAR(1) NULL,
    [SessionId] VARCHAR(50) NULL,
    [Remark] VARCHAR(234) NULL,
    [ApprovedDt] DATETIME NULL,
    [HOPaymode] VARCHAR(25) NULL,
    [Vno] VARCHAR(12) NULL,
    [ChequeNo] VARCHAR(15) NULL,
    [edt] DATETIME NULL,
    [vdt] DATETIME NULL,
    [GenFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.slipreceipt
-- --------------------------------------------------
CREATE TABLE [dbo].[slipreceipt]
(
    [Amt] MONEY NULL,
    [SlipNo] INT NOT NULL,
    [refno] VARCHAR(12) NULL,
    [Sdate] SMALLDATETIME NULL,
    [Location] CHAR(1) NULL,
    [vtyp] SMALLINT NULL,
    [vno] DECIMAL(12, 0) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SPLIT_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[SPLIT_LEDGER]
(
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [BOOKTYPE] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stracacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[stracacmast]
(
    [CODE] NVARCHAR(9) NULL,
    [NAME] NVARCHAR(35) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subaccd
-- --------------------------------------------------
CREATE TABLE [dbo].[subaccd]
(
    [subac] CHAR(35) NOT NULL,
    [achead] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbal04
-- --------------------------------------------------
CREATE TABLE [dbo].[tbal04]
(
    [CLTCODE] NVARCHAR(10) NOT NULL,
    [clcode] NVARCHAR(10) NULL,
    [acname] NVARCHAR(35) NULL,
    [amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [BOOKTYPE] CHAR(2) NULL,
    [VOUDT] VARCHAR(10) NULL,
    [EFFDT] VARCHAR(10) NULL,
    [SHORTDESC] CHAR(6) NOT NULL DEFAULT ' ',
    [DRAMT] MONEY NULL,
    [CRAMT] MONEY NULL,
    [VNO] VARCHAR(12) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [DDNO] VARCHAR(15) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [VDT] DATETIME NULL,
    [VTYP] SMALLINT NOT NULL,
    [ACCAT] CHAR(2) NULL,
    [OPBAL] MONEY NOT NULL,
    [CROSAC] VARCHAR(10) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [PROCID] BIGINT NULL,
    [REPDATE] VARCHAR(8) NULL,
    [MAINCODE] VARCHAR(10) NULL,
    [VCHDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport]
(
    [SrNo] INT NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport_New]
(
    [SrNo] INT NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL,
    [MainCode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER]
(
    [SrNo] INT NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_OppBalance]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [cltCode] VARCHAR(10) NULL,
    [OppBal] MONEY NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_NONCMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_NONCMS_DATA]
(
    [SRNONCMS] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(150) NULL,
    [LEDGERBALANCE] NVARCHAR(50) NULL,
    [DRCR] NVARCHAR(50) NULL,
    [AMT] DECIMAL(20, 2) NULL,
    [VALUEDATE] NVARCHAR(50) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(150) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(200) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL,
    [CLOSINGBALANCE] DECIMAL(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [cltcode] NVARCHAR(10) NOT NULL,
    [vtyp] SMALLINT NULL,
    [vno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[tempacmast]
(
    [MSDIVCOD] NVARCHAR(2) NULL,
    [MSACCODE] NVARCHAR(6) NULL,
    [MSACNAME] NVARCHAR(30) NULL,
    [MSPLACE] NVARCHAR(15) NULL,
    [MSGLCODE] NVARCHAR(6) NULL,
    [MSSTPCNT] FLOAT NULL,
    [MSOTHCOD] NVARCHAR(6) NULL,
    [MSADJST] NVARCHAR(1) NULL,
    [MSREFSW] NVARCHAR(20) NULL,
    [MSPCHLMT] FLOAT NULL,
    [MSSALLMT] FLOAT NULL,
    [MSACLMT] FLOAT NULL,
    [MSCRDAYS] FLOAT NULL,
    [MSINTRT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempbilldetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempbilldetails]
(
    [Exchange] CHAR(10) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Sett_no] VARCHAR(25) NULL,
    [Sett_type] CHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Billamount] MONEY NULL,
    [Balamt] MONEY NULL,
    [Payamount] MONEY NULL,
    [Sessionid] VARCHAR(50) NULL,
    [Rowid] DECIMAL(4, 0) NULL,
    [Billlno] DECIMAL(4, 0) NULL,
    [Date] DATETIME NULL,
    [Description] VARCHAR(20) NULL,
    [Billbooktype] CHAR(2) NULL,
    [Billvtype] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Vtype] VARCHAR(50) NULL,
    [Billvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Templedger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Templedger2]
(
    [Category] VARCHAR(20) NULL,
    [Branch] VARCHAR(25) NULL,
    [Paidamt] MONEY NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(25) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Costcode] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Sessionid] VARCHAR(15) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Costflag] CHAR(1) NULL,
    [Rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temppartybalances1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temppartybalances1]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [Sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temppartybalances2
-- --------------------------------------------------
CREATE TABLE [dbo].[temppartybalances2]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [Exchange] VARCHAR(10) NULL,
    [Segment] VARCHAR(15) NULL,
    [Intrest] MONEY NULL,
    [Credit] MONEY NULL,
    [Accountserver] VARCHAR(25) NULL,
    [Accountdb] VARCHAR(25) NULL,
    [Company] VARCHAR(50) NULL,
    [Short_name] VARCHAR(50) NULL,
    [Shareserver] VARCHAR(15) NULL,
    [Sharedb] VARCHAR(15) NULL,
    [Margin_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempquery
-- --------------------------------------------------
CREATE TABLE [dbo].[tempquery]
(
    [tdate] NVARCHAR(30) NULL,
    [cltcode] NVARCHAR(10) NOT NULL,
    [acname] NVARCHAR(35) NULL,
    [vno] INT NULL,
    [drcr] NVARCHAR(1) NULL,
    [ddno] NVARCHAR(15) NULL,
    [refno] NVARCHAR(12) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempsh
-- --------------------------------------------------
CREATE TABLE [dbo].[tempsh]
(
    [vtyp] SMALLINT NULL,
    [vno] INT NULL,
    [vno1] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_lg
-- --------------------------------------------------
CREATE TABLE [dbo].[test_lg]
(
    [fld1] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmpledger_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tmpledger_test]
(
    [Booktype] CHAR(2) NULL,
    [Voudt] DATETIME NULL,
    [Effdt] DATETIME NULL,
    [Shortdesc] VARCHAR(35) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [Vno] VARCHAR(12) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Narration] VARCHAR(234) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Vtyp] SMALLINT NULL,
    [Vdt] VARCHAR(30) NULL,
    [Edt] VARCHAR(30) NULL,
    [Acname] VARCHAR(100) NULL,
    [Opbal] MONEY NULL,
    [L_address1] VARCHAR(40) NOT NULL,
    [L_address2] VARCHAR(40) NULL,
    [L_address3] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_zip] VARCHAR(10) NULL,
    [Res_phone1] VARCHAR(15) NULL,
    [Branch_cd] VARCHAR(10) NOT NULL,
    [Crosac] VARCHAR(10) NULL,
    [Ediff] INT NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Sub_broker] VARCHAR(10) NOT NULL,
    [Trader] VARCHAR(20) NOT NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Bank_name] VARCHAR(16) NOT NULL,
    [Cltdpid] VARCHAR(16) NOT NULL,
    [Lno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TRIAL04
-- --------------------------------------------------
CREATE TABLE [dbo].[TRIAL04]
(
    [CODE] NVARCHAR(10) NULL,
    [NAME] NVARCHAR(25) NULL,
    [CLDR] MONEY NULL,
    [CLCR] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Userwritestable
-- --------------------------------------------------
CREATE TABLE [dbo].[Userwritestable]
(
    [Usercategory] VARCHAR(50) NULL,
    [Userstatusid] VARCHAR(25) NULL,
    [Vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Nodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LastVno
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LastVno]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL,
    [VnoFlag] TINYINT NULL,
    [FinYear] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LedgerBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LedgerBalance]
(
    [PartyCode] VARCHAR(10) NULL,
    [PartyName] VARCHAR(100) NULL,
    [ChequeName] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [accat] VARCHAR(10) NULL,
    [BtoBPayment] INT NULL,
    [TOTLedBal] MONEY NULL,
    [NSELedBal] MONEY NULL,
    [BSELedBal] MONEY NULL,
    [FNOLedBal] MONEY NULL,
    [Sett_No] VARCHAR(7) NULL,
    [NormalBillAmt] MONEY NULL,
    [T2TBillAmt] MONEY NULL,
    [BillAmt] MONEY NULL,
    [futurepayout] MONEY NULL,
    [shortage] MONEY NULL,
    [Amounttobepaid] MONEY NULL,
    [Paymode] VARCHAR(1) NULL,
    [Bankcode] VARCHAR(10) NULL,
    [GenFlag] VARCHAR(1) NULL,
    [RunDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OPENING_BALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OPENING_BALANCE]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_payout_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_payout_temp]
(
    [vdt] DATETIME NULL,
    [edt] DATETIME NULL,
    [acCode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [bnkcode] VARCHAR(10) NULL,
    [bnkname] VARCHAR(50) NULL,
    [ddno] VARCHAR(15) NULL,
    [brcode] VARCHAR(25) NULL,
    [narration] VARCHAR(500) NULL,
    [Paymode] CHAR(3) NULL,
    [srno] INT NULL,
    [branchcode] VARCHAR(25) NULL,
    [micrno] INT NULL,
    [BookType] CHAR(4) NULL,
    [accdtls] CHAR(35) NULL,
    [lno] SMALLINT NOT NULL,
    [costcode] SMALLINT NULL,
    [bankcost] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [updflag] VARCHAR(1) NOT NULL,
    [SessionId] VARCHAR(50) NULL,
    [Ledger2_Upd] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[vacmast]
(
    [acname] NVARCHAR(35) NOT NULL,
    [longname] NVARCHAR(60) NULL,
    [actyp] NVARCHAR(10) NULL,
    [accat] NVARCHAR(10) NULL,
    [familycd] NVARCHAR(10) NULL,
    [cltcode] NVARCHAR(10) NULL,
    [accdtls] NVARCHAR(35) NULL,
    [grpcode] NVARCHAR(13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmain_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[vmain_temp]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmast_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[vmast_temp]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmast1
-- --------------------------------------------------
CREATE TABLE [dbo].[vmast1]
(
    [todt] DATETIME NOT NULL,
    [vtype] SMALLINT NOT NULL,
    [lvno] DECIMAL(12, 0) NOT NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_DEL
-- --------------------------------------------------


CREATE TRIGGER [dbo].[LEDGER_DEL] ON [dbo].[Ledger] 
FOR DELETE 
AS
INSERT INTO LEDGER_TRIG
SELECT *, COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'DELETED'
FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.LEDGER_MOD
-- --------------------------------------------------


CREATE TRIGGER [dbo].[LEDGER_MOD] ON [dbo].[Ledger] 
FOR UPDATE
AS

INSERT INTO LEDGER_TRIG
SELECT *, COMP_NAME = HOST_NAME(), UPDDATE=GETDATE(), DBACTION = 'MODIFIED'
FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_DETAILS
-- --------------------------------------------------


CREATE VIEW CLIENT_DETAILS
AS

SELECT * FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS

GO

-- --------------------------------------------------
-- VIEW dbo.Fragmentaion_details
-- --------------------------------------------------
create view Fragmentaion_details
as 

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0

GO

-- --------------------------------------------------
-- VIEW dbo.LedgerDrCr
-- --------------------------------------------------
CREATE VIEW dbo.LedgerDrCr  
AS  
  
SELECT SUM(vamt) AS totalamount, drcr  
FROM ledger (NOLOCK)  
GROUP BY drcr

GO

-- --------------------------------------------------
-- VIEW dbo.ledgermismatch
-- --------------------------------------------------
CREATE view ledgermismatch  
as  
/*   
select vtyp, vno, debit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D'),  
credit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C'),  
balance = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D')  
          - ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')  
from ledger l1  
group by vtyp, vno  
having ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D') <> ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')  
*/  
select vtyp, booktype, vno, diff=sum(case when drcr = 'd' then vamt else -vamt end)  
from ledger  
group by vtyp, booktype, vno  
having sum(case when drcr = 'd' then vamt else -vamt end) <> 0

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist
-- --------------------------------------------------

/****** Object:  View dbo.rpt_chequelist    Script Date: 10/6/2001 11:56:32 AM ******/

CREATE view rpt_chequelist as

select l.acname,l.cltcode,l.drcr,l1.ddno,l.vamt,vdt= left(convert(varchar,l.vdt,109),11),edt=left(convert(varchar,l.edt,109),11),
reldt= Case When  (Reldt = '1900-01-01 00:00:00.000'   or   reldt > GetDate() ) Then 'Unrealized' else left(convert(varchar,RelDt,109),11) end,
l1.bnkname,l1.brnname,
nar = (case when (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno) is not null
            then (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno)
	    else (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno)
            end),l.vno,l.vtyp	
 from ledger l,ledger1 l1 where l.vtyp=l1.vtyp and l.vno=l1.vno and l.lno = l1.lno

GO

